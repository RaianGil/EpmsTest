using System;
using System.Collections;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Web;
using System.Web.SessionState;
using System.Web.UI;
using System.Xml;
using System.Web.UI.WebControls;
using System.Web.UI.HtmlControls;
using EPolicy;
using EPolicy.Customer;
using EPolicy.TaskControl;
using Baldrich.DBRequest;
using OPPReport;
using System.Text.RegularExpressions;
using Microsoft.VisualBasic;
using EPolicy.Quotes;
using EPolicy.XmlCooker;
using System.Collections.Generic;
using System.Web.Security;
using System.Web.UI.WebControls.WebParts;
using System.Text;
using Microsoft.Reporting.WebForms;
using System.IO;
using System.Web.Services;
using System.Configuration;
using System.Xml.Schema;
using System.Data.SqlClient;
using System.Globalization;
using System.Linq;
using System.Diagnostics;
using System.Net.Mail;
using System.Net;

namespace EPolicy
{
    public partial class DoubleInterest : System.Web.UI.Page
    {
        #region Private Variables
        private string PolicyNumber = "", InsuredName = "", InsuredAddress1 = "", InsuredAddress2 = "";
        private string InsuredCity = "", InsuredState = "", InsuredZip = "", InsuredPlate = "", InsuredVin = "";
        private string InsuredWorkPhone = "", InsuredCellular = "", PolicyPrefix = "", ReinsAsl = "";
        private string ClientID = "", NAMECONVENTION = "";
        private int VehicleMake = 0, VehicleModel = 0;
        private string EffDate = "", ExpDate = "", RenewalNo = "", RenewalPremium = "", Current_XML = "", ClientIDPPS = "";
        private bool RenewalDriverAdded = false;
        #endregion Private Variables

        #region Web Form Designer Generated Code

        override protected void OnInit(EventArgs e)
        {
            //
            // CODEGEN: This call is required by the ASP.NET Web Form Designer.
            //
            InitializeComponent();
            base.OnInit(e);

        }

        //protected void Page_Unload(object sender, EventArgs e)
        //{
        //    Session.Abandon();
        //}

        private void InitializeComponent()
        {

        }

        #endregion Web Form Designer Generated Code

        protected void Page_Load(object sender, EventArgs e)
        {
            Control Banner = new Control();
            Banner = LoadControl(@"TopBannerNew.ascx");
            this.phTopBanner.Controls.Add(Banner);

            ScriptManager.RegisterStartupScript(this.Page, this.Page.GetType(), Guid.NewGuid().ToString(), "SetWaitCursor();", true);

            EPolicy.Login.Login cp = HttpContext.Current.User as EPolicy.Login.Login;
            //btnPrintAppForms.Attributes.Add("onclick", "document.body.style.cursor = 'wait';");
            //btnPrintAppForms.Attributes.Add("onunload", "document.body.style.cursor = 'default';"); 

            //ValidateRefresh();
            VehicleBreakDownDiv.Visible = false;

            if (cp == null)
            {
                Response.Redirect("Default.aspx?001");
            }
            else
            {
                if (!cp.IsInRole("AUTOS") && !cp.IsInRole("ADMINISTRATOR")) // Cambiar
                {
                    Response.Redirect("Default.aspx?001");
                }
            }

            if (Page.IsPostBack)
            {
                if (Session["TaskControl"] == null)
                {
                    Response.Redirect("Default.aspx?007");
                }
            }

            try
            {
                //It was added for when the birthdate textbox comes directly from the database
                if (TxtBirthDate.Text != "0" && TxtBirthDate.Text != "")
                {
                    TimeSpan ts = DateTime.Parse(DateTime.Now.ToShortDateString()) - DateTime.Parse(this.TxtBirthDate.Text);

                    // Difference in days.
                    double totdays = double.Parse(ts.Days.ToString());
                    double tot = 0;

                    if (totdays < 0)
                    {
                        totdays = 0;
                    }
                    else
                    {
                        tot = Math.Floor(totdays / 365);
                        TxtAge.Text = tot.ToString().Trim();
                    }
                }
            }
            catch (Exception)
            {
                lblRecHeader.Text = "The date of birth is not correct.";
                mpeSeleccion.Show();
            }


            //When the primarydriver age is changed this updates the grid
            if (rdbAnyDriverYes.Checked == true)
            {
                AddPrimaryDriver();
            }

            if (!IsPostBack)
            {
                if (Session["LookUpTables"] == null)
                {
                    FillLookupTables();
                }
            }

            if (Session["AutoPostBack"] == null)
            {
                if (!IsPostBack)
                {
                    if (Session["TaskControl"] != null)
                    {
                        EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                        AccordionClient.SelectedIndex = 0;
                        AccordionAppPolicy.SelectedIndex = -1;
                        AccordionDrivers.SelectedIndex = -1;
                        AccordionLimitDed.SelectedIndex = -1;
                        AccordionAddCoverage.SelectedIndex = -1;
                        AccordionVehicle.SelectedIndex = -1;
                        AccordionBreakDown.SelectedIndex = -1;
                        txtValidator.Text = "";

                        switch (taskControl.Mode)
                        {
                            case 1: //ADD
                                if (Session["Customer"] != null)
                                {
                                    taskControl.Customer = (EPolicy.Customer.Customer)Session["Customer"];
                                }
                                if (Session["RenewalPremium"] != null)
                                {
                                    txtGrandTotal.Text = Session["RenewalPremium"].ToString();
                                }

                                EnableControls();
                                FillTextControl();
                                //QuoteHideControls();
                                //IsBusinessCheckedChanged();
                                DefaultLimitValues();
                                CalculatePremium();
                                GetTotalPremium();
                                PremiumInfoTotalsHideControls(false);
                                HideDriverSection("false");//("hidden");
                                break;

                            case 2: //UPDATE
                                EnableControls();
                                FillTextControl();
                                CalculatePremium();
                                GetTotalPremium();
                                //if (Session["RenewalXML"] != null)
                                //{
                                //    if (Session["RenewalXML"] != "true")
                                //    {
                                IsBusinessCheckedChanged();
                                //}
                                //}
                                break;

                            default:
                                DisableControls();
                                FillTextControl();
                                //QuoteHideControls();
                                CalculatePremium();
                                GetTotalPremium();
                                IsBusinessCheckedChanged();
                                PremiumInfoTotalsHideControls(false);

                                break;
                        }
                    }
                }
                else
                {
                    if (Session["TaskControl"] != null)
                    {
                        EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                        if (taskControl.Mode == 4)
                        {

                            DisableControls();
                            //FillTextControl();.
                            VehicleReadOnlyModify();
                            CalculatePremium();
                            GetTotalPremium();
                        }
                    }
                }
            }
            else
            {
                EnableControls();
                FillTextControl();
                CalculatePremium();
                GetTotalPremium();
                Session.Remove("AutoPostBack");
            }

            //ShowPremiumOnTheFly(true);
            ScriptManager.RegisterStartupScript(this.Page, this.Page.GetType(), Guid.NewGuid().ToString(), "SetDefaultCursor();", true);
            this.MaintainScrollPositionOnPostBack = true;

            try
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                if (taskControl.TaskControlID != 0 && taskControl.TaskControlID.ToString() != "")
                {
                    if (taskControl.SupplierID.ToString() == "999" || Session["SupplierID"] == "999")
                    {
                        BtnPrintPolicy.Enabled = false;
                        BtnPrintInvoice.Enabled = false;
                        BtnRePrintApp.Enabled = false;
                        ddlPrintOption.Enabled = false;
                        ddlPrintOption2.Enabled = false;
                        BtnPrintPolicy2.Enabled = false;
                        BtnPrintInvoice2.Enabled = false;
                        BtnRePrintApp2.Enabled = false;
                        btnCancellation.Enabled = false;
                        btnCancellation2.Enabled = false;
                        BtnRenew.Enabled = false;
                        BtnRenew2.Enabled = false;
                        TxtBinderNo.Text = "";
                        throw new Exception("ERROR: Policy Transfer to PPS was not completed.  Please call Technical Support at (787)520-6175.");
                    }
                }
            }
            catch (Exception exp)
            {
                lblRecHeader.Text = exp.Message.ToString();
                mpeSeleccion.Show();
            }

            if (!Page.IsPostBack && (Request.QueryString["XML"] != "" && Request.QueryString["XML"] != null))
            {
                try
                {
                    try
                    {
                        GetPolicyFromPPS(Request.QueryString["XML"]);
                    }
                    catch (Exception exp)
                    {
                        LogError(exp);
                        lblRecHeader.Text = exp.ToString() + exp.Message.ToString();
                        mpeSeleccion.Show();
                    }
                    LoadRenewalXML();
                    DisableControls();
                    FillTextControl();
                    PremiumInfoTotalsHideControls(false);
                    btnQuote_Click(String.Empty, EventArgs.Empty);
                    EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
                    EnableDisableBusinessAuto();

                }
                catch (Exception exp)
                {
                    LogError(exp);
                    lblRecHeader.Text = exp.ToString() + exp.Message.ToString();
                    mpeSeleccion.Show();
                }
            }
        }

        protected void FillLookupTables()
        {
            DataTable dtLocation = EPolicy.LookupTables.LookupTables.GetTable("Location");
            DataTable dtAgency = EPolicy.LookupTables.LookupTables.GetTable("Agency");
            DataTable dtAgent = EPolicy.LookupTables.LookupTables.GetTable("AgentVI");
            DataTable dtInsuranceCompany = EPolicy.LookupTables.LookupTables.GetTable("InsuranceCompany");
            DataTable dtVehicleModel = EPolicy.LookupTables.LookupTables.GetTable("VehicleModel");
            DataTable dtVehicleYear = EPolicy.LookupTables.LookupTables.GetTable("VehicleYear");
            DataTable dtVehicleMake = EPolicy.LookupTables.LookupTables.GetTable("VehicleMake");
            DataTable dtVehicleMakeMotorcycle = EPolicy.LookupTables.LookupTables.GetTable("VehicleMakeMotorcycle");
            DataTable dtVehicleUse = EPolicy.LookupTables.LookupTables.GetTable("VI_VehicleUseNoCommercial");
            DataTable dtVehicleTerritory = EPolicy.LookupTables.LookupTables.GetTable("VI_VehicleTerritory");
            DataTable dtGender = EPolicy.LookupTables.LookupTables.GetTable("Gender");
            DataTable dtMaritalStatus = EPolicy.LookupTables.LookupTables.GetTable("MaritalStatus");
            DataTable dtOccupations = EPolicy.LookupTables.LookupTables.GetTable("Occupations");
            DataTable dtBankList = EPolicy.LookupTables.LookupTables.GetTable("Bank_VI");
            DataTable dtCompanyDealer = EPolicy.LookupTables.LookupTables.GetTable("CompanyDealer");
            DataTable dtTerms = EPolicy.LookupTables.LookupTables.GetTable("Terms");



            //Location
            ddlOriginatedAt.DataSource = dtLocation;
            ddlOriginatedAt.DataTextField = "locationDesc";
            ddlOriginatedAt.DataValueField = "locationID";
            ddlOriginatedAt.DataBind();
            ddlOriginatedAt.SelectedIndex = -1;
            ddlOriginatedAt.Items.Insert(0, "");

            //Agency
            ddlAgency.DataSource = dtAgency;
            ddlAgency.DataTextField = "AgencyDesc";
            ddlAgency.DataValueField = "AgencyID";
            ddlAgency.DataBind();
            ddlAgency.SelectedIndex = -1;
            ddlAgency.Items.Insert(0, "");

            //Agent
            ddlAgent.DataSource = dtAgent;
            ddlAgent.DataTextField = "AgentDesc";
            ddlAgent.DataValueField = "AgentID";
            ddlAgent.DataBind();
            ddlAgent.SelectedIndex = -1;
            ddlAgent.Items.Insert(0, "");

            //InsuranceCompany
            ddlInsuranceCompany.DataSource = dtInsuranceCompany;
            ddlInsuranceCompany.DataTextField = "InsuranceCompanyDesc";
            ddlInsuranceCompany.DataValueField = "InsuranceCompanyID";
            ddlInsuranceCompany.DataBind();
            ddlInsuranceCompany.SelectedIndex = -1;
            ddlInsuranceCompany.Items.Insert(0, "");

            //VehicleYear
            ddlVehicleYear.DataSource = dtVehicleYear;
            ddlVehicleYear.DataTextField = "VehicleYearDesc";
            ddlVehicleYear.DataValueField = "VehicleYearID";
            ddlVehicleYear.DataBind();
            ddlVehicleYear.SelectedIndex = -1;
            ddlVehicleYear.Items.Insert(0, "");

            //VehicleModel
            ddlVehicleModel.DataSource = dtVehicleModel;
            ddlVehicleModel.DataTextField = "VehicleModelDesc";
            ddlVehicleModel.DataValueField = "VehicleModelID";
            ddlVehicleModel.DataBind();
            ddlVehicleModel.SelectedIndex = -1;
            ddlVehicleModel.Items.Insert(0, "");

            //VehicleMake
            ddlVehicleMake.DataSource = dtVehicleMake;
            ddlVehicleMake.DataTextField = "vehicleMakeDesc";
            ddlVehicleMake.DataValueField = "vehicleMakeID";
            ddlVehicleMake.DataBind();
            ddlVehicleMake.SelectedIndex = -1;
            ddlVehicleMake.Items.Insert(0, "");

            //VehicleUse
            ddlVehicleUse.DataSource = dtVehicleUse;
            ddlVehicleUse.DataTextField = "VehicleUseDesc";
            ddlVehicleUse.DataValueField = "Code";
            ddlVehicleUse.DataBind();
            ddlVehicleUse.SelectedIndex = -1;
            ddlVehicleUse.Items.Insert(0, "");

            //VehicleTerritory
            ddlIsland.DataSource = dtVehicleTerritory;
            ddlIsland.DataTextField = "VehicleTerritoryDesc";
            ddlIsland.DataValueField = "VehicleTerritoryID";
            ddlIsland.DataBind();
            ddlIsland.SelectedIndex = -1;
            ddlIsland.Items.Insert(0, "");

            //Company Dealer
            ddlCompanyDealer.DataSource = dtCompanyDealer;
            ddlCompanyDealer.DataTextField = "CompanyDealerDesc";
            ddlCompanyDealer.DataValueField = "CompanyDealerID";
            ddlCompanyDealer.DataBind();
            ddlCompanyDealer.SelectedIndex = -1;
            ddlCompanyDealer.Items.Insert(0, "");

            //Company Dealer
            ddlTerms.DataSource = dtTerms;
            ddlTerms.DataTextField = "Terms";
            ddlTerms.DataValueField = "TermID";
            ddlTerms.DataBind();
            ddlTerms.SelectedIndex = -1;
            ddlTerms.Items.Insert(0, "");
            //ddlTerms.Items.RemoveAt(1);

            //Occupations
            ddlOccupation.DataSource = dtOccupations;
            ddlOccupation.DataTextField = "OccupationsDesc";
            ddlOccupation.DataValueField = "OccupationsID";
            ddlOccupation.DataBind();
            ddlOccupation.SelectedIndex = -1;
            ddlOccupation.Items.Insert(0, "");

            //Gender
            ddlGender.DataSource = dtGender;
            ddlGender.DataTextField = "GenderDesc";
            ddlGender.DataValueField = "GenderID";
            ddlGender.DataBind();
            ddlGender.SelectedIndex = -1;
            ddlGender.Items.Insert(0, "");

            //DriverGender
            ddlDriverGender.DataSource = dtGender;
            ddlDriverGender.DataTextField = "GenderDesc";
            ddlDriverGender.DataValueField = "GenderID";
            ddlDriverGender.DataBind();
            ddlDriverGender.SelectedIndex = -1;
            ddlDriverGender.Items.Insert(0, "");
            ddlDriverGender.Items.RemoveAt(3);

            //MaritalStatus
            ddlMaritalStatus.DataSource = dtMaritalStatus;
            ddlMaritalStatus.DataTextField = "MaritalStatusDesc";
            ddlMaritalStatus.DataValueField = "MaritalStatusID";
            ddlMaritalStatus.DataBind();
            ddlMaritalStatus.SelectedIndex = -1;
            ddlMaritalStatus.Items.Insert(0, "");

            //MaritalStatus2
            ddlMaritalStatus2.DataSource = dtMaritalStatus;
            ddlMaritalStatus2.DataTextField = "MaritalStatusDesc";
            ddlMaritalStatus2.DataValueField = "MaritalStatusID";
            ddlMaritalStatus2.DataBind();
            ddlMaritalStatus2.SelectedIndex = -1;
            ddlMaritalStatus2.Items.Insert(0, "");

            //DriverMaritalStatus
            ddlDriverMaritalStatus.DataSource = dtMaritalStatus;
            ddlDriverMaritalStatus.DataTextField = "MaritalStatusDesc";
            ddlDriverMaritalStatus.DataValueField = "MaritalStatusID";
            ddlDriverMaritalStatus.DataBind();
            ddlDriverMaritalStatus.SelectedIndex = -1;
            ddlDriverMaritalStatus.Items.Insert(0, "");
            ddlDriverMaritalStatus.Items.RemoveAt(3);


            //BANK_VI
            dtBankList.DefaultView.RowFilter = " BankDesc Like '%" + "FirstBank" + "%' OR BankDesc Like '%" + "First Bank" + "%'";
            var NewDataView = dtBankList.DefaultView.ToTable();
            ddlBankList.DataSource = NewDataView;
            ddlBankList.DataTextField = "BankDesc";
            ddlBankList.DataValueField = "PPSID";
            ddlBankList.DataBind();
            //Solo quieren FIRST BANK POR EL MOMENTO
            //string BankValue = ddlBankList.Items.FindByText("FIRST BANK").Value;
            //ddlBankList.Items.Clear();
            ddlBankList.SelectedIndex = -1;
            ddlBankList.Items.Insert(0, "");
            //ddlBankList.Items.Insert(1, new ListItem("FIRST BANK", BankValue));

            Session.Add("LookUpTables", "In");
        }

        protected void LoadRenewalXML()
        {
            try
            {
                Session["RenewalXML"] = "";
                TaskControl.DoubleInterest taskControl = new TaskControl.DoubleInterest(true);
                taskControl.Mode = 1;
                taskControl.isQuote = true;
                taskControl.TaskControlTypeID = int.Parse(LookupTables.LookupTables.GetID("TaskControlType", "Double Interest Policy Quote"));
                Session.Add("TaskControl", taskControl);

                XmlDocument XmlDoc = new XmlDocument();
                XmlDoc.LoadXml(Current_XML);//(Request.QueryString["XML"]);

                string CanDate = "";
                bool FilledName = false, FilledName2 = false, FilledAddress = false, FilledAsl = false;
                string TotPrem = "0.00";

                //throw new Exception("This is a Test");

                #region Xml

                XmlNodeList XmlBase = XmlDoc.GetElementsByTagName("Policy");

                foreach (XmlNode XmlPolicyBase in XmlBase)
                {
                    Session["RenewalXML"] = "true";
                    DataTable dt = new DataTable();

                    taskControl.PolicyNo = XmlPolicyBase["PolicyID"].InnerText.Replace("PAP", "").Replace("BAP", "");

                    taskControl.RenewalNo = XmlPolicyBase["PolicyID"].InnerText;

                    taskControl.CustomerCollection = XmlPolicyBase["PolicyID"].InnerText != "" ? "1" : "0";

                    taskControl.Customer.Description = XmlPolicyBase["Client"].InnerText;

                    ClientIDPPS = XmlPolicyBase["Client"].InnerText;

                    taskControl.EffectiveDate = DateTime.Parse(XmlPolicyBase["Incept"].InnerText).ToShortDateString();
                    taskControl.ExpirationDate = DateTime.Parse(XmlPolicyBase["Expire"].InnerText).ToShortDateString();

                    if (XmlPolicyBase["BrokerID"] != null)
                    {
                        dt = GetAgentByCarsID(int.Parse(XmlPolicyBase["BrokerID"].InnerText));

                        if (dt.Rows.Count > 0)
                        {
                            taskControl.Agent = dt.Rows[0]["AgentID"].ToString();

                            dt = new DataTable();
                        }
                    }

                    if (XmlPolicyBase["Premium"] != null)
                    {
                        RenewalPremium = XmlPolicyBase["Premium"].InnerText;
                    }

                    PolicyNumber = XmlPolicyBase["PolicyID"].InnerText;
                    TxtBinderNo.Text = PolicyNumber;
                    PolicyPrefix = PolicyNumber.Substring(0, 3);
                    taskControl.PolicyType = PolicyNumber.Substring(0, 3);
                    EffDate = DateTime.Parse(XmlPolicyBase["Incept"].InnerText).ToShortDateString();
                    ExpDate = DateTime.Parse(XmlPolicyBase["Expire"].InnerText).ToShortDateString();

                    TotPrem = XmlPolicyBase["Premium"].InnerText;

                    txtGrandTotal.Text = XmlPolicyBase["Premium"].InnerText;

                    taskControl.TotalPremium = double.Parse(XmlPolicyBase["Premium"].InnerText.ToString().Trim());

                    txtTotalPremiumVehicle.Text = XmlPolicyBase["Premium"].InnerText;


                    if (XmlPolicyBase["PolSubType"].InnerText != "")
                    {
                        if (XmlPolicyBase["PolicyID"].InnerText.Trim().Contains("BAP"))//if (XmlPolicyBase["PolSubType"].InnerText == "Cml")
                        {
                            if (XmlPolicyBase["PolicyID"].InnerText.Trim().Contains("BAP"))
                            {
                                chkIsBusinessAutoQuote.Checked = true;
                                taskControl.isBusinessPolicy = true;
                            }

                            LblBirthDate.ForeColor = Color.Black;
                            lblMarital.ForeColor = Color.Black;
                            lblLicense.ForeColor = Color.Black;
                            LblGender.ForeColor = Color.Black;
                            LblFirstName.ForeColor = Color.Black;
                            LblLastName.ForeColor = Color.Black;

                            chkNamedInsured.Enabled = true;
                            radMotorcycle.Enabled = true;

                            if (chkNamedInsured.Checked)
                                chkNamedInsured.Checked = false;

                        }
                        else
                        {
                            LblBirthDate.ForeColor = Color.Red;
                            lblMarital.ForeColor = Color.Red;
                            lblLicense.ForeColor = Color.Red;
                            LblGender.ForeColor = Color.Red;
                            LblFirstName.ForeColor = Color.Red;
                            LblLastName.ForeColor = Color.Red;

                            chkNamedInsured.Enabled = false;
                            TxtLastName2.Enabled = false;
                            radMotorcycle.Enabled = false;

                            if (radMotorcycle.SelectedItem.Text == "Yes")
                            {
                                radMotorcycle.SelectedIndex = 1;
                            }

                            if (TxtLastName2.Text.ToString() != "")
                                TxtLastName2.Text = "";

                            if (chkNamedInsured.Checked)
                                chkNamedInsured.Checked = false;



                            if (radTaxiDriverloss.SelectedIndex == 0)
                                radTaxiDriverloss.SelectedIndex = 1;

                            lblTaxiDriverloss.Visible = false;
                            radTaxiDriverloss.Visible = false;

                            LblPassengersNo.Visible = false;
                            TxtPassengerNo.Visible = false;

                            if (TxtPassengerNo.Text != "0")
                                TxtPassengerNo.Text = "0";
                        }
                    }



                    if (XmlPolicyBase["CanDate"].InnerText != "")
                        taskControl.CancellationDate = DateTime.Parse(XmlPolicyBase["CanDate"].InnerText).ToShortDateString();

                    if (XmlPolicyBase.HasChildNodes)
                    {
                        //XmlNode Child = XmlPolicyBase.FirstChild;
                        foreach (XmlNode Childs in XmlPolicyBase.ChildNodes)
                        {
                            if (Childs.Name == "PolRelTable")
                            {
                                foreach (XmlElement ChildsElement in Childs)
                                {
                                    if (ChildsElement.HasChildNodes)
                                    {
                                        foreach (XmlElement GrandChildElements in ChildsElement)
                                        {
                                            if (GrandChildElements.Name == "EntNamesTable")
                                            {
                                                foreach (XmlElement GreatGrandElements in GrandChildElements)
                                                {
                                                    if (ChildsElement["Polrelat"].InnerText == "NI" && !RenewalDriverAdded)
                                                    {
                                                        if (!(FilledName))  //Solo leerá los campos una vez, tomando los primeros que lea
                                                        {
                                                            if (XmlPolicyBase["PolicyID"].InnerText.Trim().Contains("BAP") && GreatGrandElements["FirstName"].InnerText == "")
                                                            {
                                                                chkIsBusinessAutoQuote.Checked = true;
                                                                chkNamedInsured.Checked = true;
                                                                taskControl.isBusinessPolicy = true;
                                                                taskControl.UseCompanyAsNamedInsured = true;
                                                                taskControl.Customer.FirstName = GreatGrandElements["FirstName"].InnerText;
                                                                taskControl.Customer.Initial = GreatGrandElements["Middle"].InnerText == "" ? "" : GreatGrandElements["Middle"].InnerText;
                                                                taskControl.Customer.LastName1 = "";
                                                                taskControl.Customer.LastName2 = GreatGrandElements["LastName"].InnerText;
                                                            }
                                                            else
                                                            {
                                                                taskControl.Customer.FirstName = GreatGrandElements["FirstName"].InnerText;
                                                                taskControl.Customer.Initial = GreatGrandElements["Middle"].InnerText == "" ? "" : GreatGrandElements["Middle"].InnerText;
                                                                taskControl.Customer.LastName1 = GreatGrandElements["LastName"].InnerText;
                                                            }

                                                            if (DateTime.Parse(GreatGrandElements["Dob"].InnerText).Year < 1900)
                                                                taskControl.Customer.Birthday = "01/01/1900";
                                                            else
                                                                taskControl.Customer.Birthday = DateTime.Parse(GreatGrandElements["Dob"].InnerText).ToString("MM/dd/yyyy");

                                                            try
                                                            {
                                                                //It was added for when the birthdate textbox comes directly from the database
                                                                if (taskControl.Customer.Birthday.ToString() != "0" && taskControl.Customer.Birthday.ToString() != "")
                                                                {
                                                                    TimeSpan ts = DateTime.Parse(DateTime.Now.ToShortDateString()) - DateTime.Parse(taskControl.Customer.Birthday.ToString());

                                                                    // Difference in days.
                                                                    double totdays = double.Parse(ts.Days.ToString());
                                                                    double tot = 0;

                                                                    if (totdays < 0)
                                                                    {
                                                                        totdays = 0;
                                                                    }
                                                                    else
                                                                    {
                                                                        tot = Math.Floor(totdays / 365);
                                                                        TxtAge.Text = tot.ToString().Trim();
                                                                    }
                                                                }
                                                            }
                                                            catch (Exception)
                                                            {
                                                                lblRecHeader.Text = "The date of birth is not correct.";
                                                                mpeSeleccion.Show();
                                                            }

                                                            if (GreatGrandElements["Sex"] != null)
                                                            {
                                                                taskControl.Customer.Sex = GreatGrandElements["Sex"].InnerText == null ? "" : GreatGrandElements["Sex"].InnerText;
                                                            }

                                                            if (GreatGrandElements["Marital"] != null)
                                                            {
                                                                taskControl.Customer.MaritalStatus = GreatGrandElements["Marital"].InnerText == "S" ? 1 : 2;
                                                            }
                                                            if (GreatGrandElements["License"] != null)
                                                            {
                                                                if (GreatGrandElements["License"].InnerText != "")
                                                                {
                                                                    if (GreatGrandElements["License"].InnerText.Length > 15)//10
                                                                    {
                                                                        taskControl.Customer.Licence = GreatGrandElements["License"].InnerText.Substring(0, 15);//10
                                                                    }
                                                                    else
                                                                    {
                                                                        taskControl.Customer.Licence = GreatGrandElements["License"].InnerText;
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    taskControl.Customer.Licence = "0000000000";
                                                                }
                                                            }

                                                            InsuredName = taskControl.Customer.FirstName;
                                                            InsuredState = taskControl.Customer.State;

                                                            FilledName = true;
                                                            RenewalDriverAdded = true;
                                                        }
                                                    }
                                                    else if (ChildsElement["Polrelat"].InnerText == "AD" || ChildsElement["Polrelat"].InnerText == "NI" && RenewalDriverAdded)
                                                    {

                                                        rdbAnyDriverYes.Checked = true;
                                                        taskControl.AnyDriverUnder26 = true;
                                                        rdbAnyDriverNo.Checked = false;
                                                        if (!FilledName2)
                                                        {
                                                            rdbAnyDriverYes_CheckedChanged(String.Empty, EventArgs.Empty);
                                                        }

                                                        TxtDriverName.Text = GreatGrandElements["FirstName"].InnerText;
                                                        TxtDriverLastName.Text = GreatGrandElements["LastName"].InnerText;

                                                        TxtDriverBirthDate.Text = DateTime.Parse(GreatGrandElements["Dob"].InnerText).ToString("MM/dd/yyyy");
                                                        TxtDriverBirthDate_TextChanged(String.Empty, EventArgs.Empty);

                                                        if (GreatGrandElements["Sex"] != null)
                                                        {
                                                            ddlDriverGender.SelectedIndex = GreatGrandElements["Sex"].InnerText == "M" ? 1 : 2;
                                                        }

                                                        if (GreatGrandElements["Marital"] != null)
                                                        {
                                                            ddlDriverMaritalStatus.SelectedIndex = GreatGrandElements["Marital"].InnerText == "S" ? 1 : 2;
                                                        }

                                                        AddRenewalDriver_Click();

                                                        FilledName2 = true;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            else if (Childs.Name == "VehicleTable")
                            {
                                int CountVehicles = 0;
                                foreach (XmlElement ChildsElement in Childs)
                                {
                                    CountVehicles++;
                                    string BI = "0.00";
                                    string PD = "0.00";
                                    string MP = "0.00";
                                    string Coll = "0.00";
                                    string Comp = "0.00";
                                    string Mot = "0.00";
                                    string Add = "0.00";
                                    string RentReim = "0.00";
                                    string TaxiLoss = "0.00";

                                    string BILimit = "0", PDLimit = "0", CollLimit = "0", CompLimit = "0", MPLimit = "0";

                                    TxtVINNo.Text = ChildsElement["Vin"].InnerText;

                                    DataTable dtVehicleUseC = EPolicy.LookupTables.LookupTables.GetTable("VI_VehicleUseCommercial");
                                    DataTable dtVehicleUseP = EPolicy.LookupTables.LookupTables.GetTable("VI_VehicleUseNoCommercial");
                                    DataTable dtVehicleMakeMotorcycle = EPolicy.LookupTables.LookupTables.GetTable("VehicleMakeMotorcycle");
                                    DataTable dtVehicleModel = EPolicy.LookupTables.LookupTables.GetTable("VehicleModel");
                                    DataTable dtVehicleMake = EPolicy.LookupTables.LookupTables.GetTable("VehicleMake");

                                    if (ChildsElement["UseClass"].InnerText == "CML" && radMotorcycle.SelectedIndex != 0)
                                    {
                                        //VehicleUse
                                        ddlVehicleUse.DataSource = dtVehicleUseC;
                                        ddlVehicleUse.DataTextField = "VehicleUseDesc";
                                        ddlVehicleUse.DataValueField = "Code";
                                        ddlVehicleUse.DataBind();
                                        ddlVehicleUse.SelectedIndex = -1;
                                        ddlVehicleUse.Items.Insert(0, "");
                                    }
                                    else if (ChildsElement["UseClass"].InnerText == "CML" && radMotorcycle.SelectedIndex == 0)
                                    {
                                        //VehicleUse
                                        ddlVehicleUse.DataSource = dtVehicleUseC;
                                        ddlVehicleUse.DataTextField = "VehicleUseDesc";
                                        ddlVehicleUse.DataValueField = "Code";
                                        ddlVehicleUse.DataBind();
                                        ddlVehicleUse.SelectedIndex = -1;
                                        ddlVehicleUse.Items.Insert(0, "");
                                        ddlVehicleUse.Items.RemoveAt(1);
                                        ddlVehicleUse.Items.RemoveAt(2);
                                        ddlVehicleUse.Items.Insert(2, "Private");
                                        ddlVehicleUse.Items.FindByValue("Private").Value = "P";

                                        //VehicleMake
                                        ddlVehicleMake.DataSource = dtVehicleMakeMotorcycle;
                                        ddlVehicleMake.DataTextField = "vehicleMakeDesc";
                                        ddlVehicleMake.DataValueField = "vehicleMakeID";
                                        ddlVehicleMake.DataBind();
                                        ddlVehicleMake.SelectedIndex = -1;
                                        ddlVehicleMake.Items.Insert(0, "");

                                        //VehicleModel
                                        ddlVehicleModel.DataSource = dtVehicleModel;
                                        ddlVehicleModel.DataTextField = "VehicleModelDesc";
                                        ddlVehicleModel.DataValueField = "VehicleModelID";
                                        ddlVehicleModel.DataBind();
                                        ddlVehicleModel.SelectedIndex = -1;
                                        ddlVehicleModel.Items.Insert(0, "");

                                        radGenTons.Visible = false;
                                        Label23.Visible = false;
                                        radHeavyTruck.Visible = false;
                                        lblHeavyTruck.Visible = false;
                                        TxtVehicleValue.Enabled = false;
                                    }
                                    else if ((ChildsElement["UseClass"].InnerText == "TAXI" || ChildsElement["UseClass"].InnerText == "RNTL") && radMotorcycle.SelectedIndex != 0)
                                    {
                                        //VehicleUse
                                        ddlVehicleUse.DataSource = dtVehicleUseC;
                                        ddlVehicleUse.DataTextField = "VehicleUseDesc";
                                        ddlVehicleUse.DataValueField = "Code";
                                        ddlVehicleUse.DataBind();
                                        ddlVehicleUse.SelectedIndex = -1;
                                        ddlVehicleUse.Items.Insert(0, "");
                                    }
                                    else
                                    {
                                        //VehicleUse
                                        ddlVehicleUse.DataSource = dtVehicleUseP;
                                        ddlVehicleUse.DataTextField = "VehicleUseDesc";
                                        ddlVehicleUse.DataValueField = "Code";
                                        ddlVehicleUse.DataBind();
                                        ddlVehicleUse.SelectedIndex = -1;
                                        ddlVehicleUse.Items.Insert(0, "");
                                        ddlVehicleUse.SelectedItem.Value = "Private";
                                    }

                                    ddlVehicleUse.SelectedIndex = 1;

                                    if (ChildsElement["UseClass"] != null)
                                    {
                                        if (ChildsElement["End22"].InnerText != "0")
                                        {
                                            radRentalReimCov.SelectedIndex = 0;
                                        }
                                        else
                                        {
                                            radRentalReimCov.SelectedIndex = 1;
                                        }

                                        if (ChildsElement["End23"].InnerText != "0")
                                        {
                                            radTaxiDriverloss.SelectedIndex = 0;
                                        }
                                        else
                                        {
                                            radTaxiDriverloss.SelectedIndex = 1;
                                        }
                                    }

                                    TxtLicensePlateNo.Text = ChildsElement["LicPlate"].InnerText;

                                    double Depreciation = 0;


                                    //Si es el Primer año la depreciación es 7.5%
                                    if (1 == 1)
                                    {
                                        //==============================================//
                                        //(0.975) = depreciación de 2.5% FULLCOVER ONLY //
                                        //==============================================//
                                        Depreciation = 0.975;
                                    }

                                    if (ChildsElement["InsVal"] != null)
                                    {
                                        if (ChildsElement["InsVal"].InnerText != "")
                                        {

                                            TxtVehicleValue.Text = (Math.Round(float.Parse(ChildsElement["InsVal"].InnerText.ToString().Trim()) * Depreciation, 0)).ToString();
                                        }
                                        else
                                        {
                                            TxtVehicleValue.Text = "0";
                                        }
                                    }
                                    else
                                    {
                                        TxtVehicleValue.Text = "0";
                                    }
                                    TxtVehicleValue.Text = String.Format("{0:c0}", int.Parse(TxtVehicleValue.Text.ToString().Trim(), System.Globalization.NumberStyles.Currency));

                                    ddlBankList.SelectedIndex = ddlBankList.Items.IndexOf(ddlVehicleMake.Items.FindByText((ChildsElement["Payee"].InnerText)));

                                    if (ChildsElement["Island"].InnerText == "2")
                                        ddlIsland.SelectedIndex = 1;//"St. Croix";

                                    if (ChildsElement["Island"].InnerText == "3")
                                        ddlIsland.SelectedIndex = 2;//"St. John";

                                    if (ChildsElement["Island"].InnerText == "1")
                                        ddlIsland.SelectedIndex = 3;//"St. Thomas";

                                    InsuredVin = "";//txtVINVerification.Text;
                                    InsuredPlate = "";//txtPlateVerification.Text;

                                    bool isMotorcycle = false;
                                    string Passengers = "";

                                    if (ChildsElement.HasChildNodes)
                                    {
                                        foreach (XmlElement GrandChilds in ChildsElement)
                                        {
                                            if (GrandChilds.Name == "PhysVehicleTable")
                                            {
                                                foreach (XmlElement GrandChildsElements in GrandChilds)
                                                {
                                                    Passengers = GrandChildsElements["Passengers"].InnerText.Trim().ToString();
                                                    if (Passengers != "0")
                                                        TxtPassengerNo.Visible = true;
                                                    TxtPassengerNo.Text = Passengers;

                                                    if (GrandChildsElements["BodyType"] != null)
                                                    {

                                                        if (GrandChildsElements["BodyType"].InnerText.ToString().Trim().ToUpper() == "MC" || GrandChildsElements["BodyType"].InnerText.ToString().Trim().ToUpper() == "MS" || GrandChildsElements["BodyType"].InnerText.ToString().Trim().ToUpper() == "MNS")
                                                        {
                                                            isMotorcycle = true;
                                                            //VehicleUse
                                                            ddlVehicleUse.DataSource = dtVehicleUseC;
                                                            ddlVehicleUse.DataTextField = "VehicleUseDesc";
                                                            ddlVehicleUse.DataValueField = "Code";
                                                            ddlVehicleUse.DataBind();
                                                            ddlVehicleUse.SelectedIndex = -1;
                                                            ddlVehicleUse.Items.Insert(0, "");
                                                            ddlVehicleUse.Items.RemoveAt(1);
                                                            ddlVehicleUse.Items.RemoveAt(2);
                                                            ddlVehicleUse.Items.Insert(2, "Private");
                                                            ddlVehicleUse.Items.FindByValue("Private").Value = "P";

                                                            //VehicleMake
                                                            ddlVehicleMake.DataSource = dtVehicleMakeMotorcycle;
                                                            ddlVehicleMake.DataTextField = "vehicleMakeDesc";
                                                            ddlVehicleMake.DataValueField = "vehicleMakeID";
                                                            ddlVehicleMake.DataBind();
                                                            ddlVehicleMake.SelectedIndex = -1;
                                                            ddlVehicleMake.Items.Insert(0, "");

                                                            //VehicleModel
                                                            ddlVehicleModel.DataSource = dtVehicleModel;
                                                            ddlVehicleModel.DataTextField = "VehicleModelDesc";
                                                            ddlVehicleModel.DataValueField = "VehicleModelID";
                                                            ddlVehicleModel.DataBind();
                                                            ddlVehicleModel.SelectedIndex = -1;
                                                            ddlVehicleModel.Items.Insert(0, "");

                                                            radGenTons.Visible = false;
                                                            Label23.Visible = false;
                                                            radHeavyTruck.Visible = false;
                                                            lblHeavyTruck.Visible = false;

                                                            TxtVehicleValue.Text = "";
                                                            lblRentalReim.Visible = false;
                                                            radRentalReimCov.Visible = false;
                                                            if (radRentalReimCov.SelectedItem.Value.ToString() == "Y")
                                                                radRentalReimCov.SelectedIndex = 1;

                                                            radMotorcycle.SelectedIndex = 0;
                                                            ddlVehicleUse.SelectedIndex = 1;
                                                        }
                                                        else if (ChildsElement["UseClass"].InnerText == "TAXI" && radMotorcycle.SelectedIndex != 0)
                                                        {
                                                            ddlVehicleUse.SelectedIndex = ddlVehicleUse.Items.IndexOf(ddlVehicleUse.Items.FindByText("Taxi"));
                                                        }
                                                        else if (ChildsElement["UseClass"].InnerText == "RNTL" && radMotorcycle.SelectedIndex != 0)
                                                        {
                                                            ddlVehicleUse.SelectedIndex = ddlVehicleUse.Items.IndexOf(ddlVehicleUse.Items.FindByText("Rental"));
                                                        }

                                                        dt = new DataTable();

                                                        ddlVehicleMake.SelectedIndex = ddlVehicleMake.Items.IndexOf(ddlVehicleMake.Items.FindByText((GrandChildsElements["Make"].InnerText.Trim()).ToString()));
                                                        ddlVehicleMake_SelectedIndexChanged(String.Empty, EventArgs.Empty);

                                                        if (ddlVehicleMake.SelectedItem.Value != "")
                                                        {
                                                            if (int.Parse(ddlVehicleMake.SelectedItem.Value) > 0)
                                                            {
                                                                dt = GetVehicleModelByVehicleMakeIDFromPPS(int.Parse(ddlVehicleMake.SelectedItem.Value), GrandChildsElements["Model"].InnerText.Trim
        ());
                                                                if (dt.Rows.Count > 0)
                                                                {
                                                                    ddlVehicleModel.SelectedIndex = ddlVehicleModel.Items.IndexOf(ddlVehicleModel.Items.FindByText((dt.Rows[0]["VehicleModelDesc"].ToString().Trim()).ToString()));
                                                                }
                                                                else
                                                                {
                                                                    dt = new DataTable();
                                                                    AddVehicleModelFromPPS(ddlVehicleMake.SelectedItem.Value, GrandChildsElements["Model"].InnerText.Trim
        ().ToString());
                                                                    if (isMotorcycle)
                                                                    {
                                                                        #region
                                                                        if (GrandChildsElements["BodyType"].InnerText.ToString().Trim().ToUpper() == "MC" || GrandChildsElements["BodyType"].InnerText.ToString().Trim().ToUpper() == "MS" || GrandChildsElements["BodyType"].InnerText.ToString().Trim().ToUpper() == "MNS")
                                                                        {
                                                                            isMotorcycle = true;
                                                                            //VehicleUse
                                                                            ddlVehicleUse.DataSource = dtVehicleUseC;
                                                                            ddlVehicleUse.DataTextField = "VehicleUseDesc";
                                                                            ddlVehicleUse.DataValueField = "Code";
                                                                            ddlVehicleUse.DataBind();
                                                                            ddlVehicleUse.SelectedIndex = -1;
                                                                            ddlVehicleUse.Items.Insert(0, "");
                                                                            ddlVehicleUse.Items.RemoveAt(1);
                                                                            ddlVehicleUse.Items.RemoveAt(2);
                                                                            ddlVehicleUse.Items.Insert(2, "Private");
                                                                            ddlVehicleUse.Items.FindByValue("Private").Value = "P";

                                                                            //VehicleMake
                                                                            ddlVehicleMake.DataSource = dtVehicleMakeMotorcycle;
                                                                            ddlVehicleMake.DataTextField = "vehicleMakeDesc";
                                                                            ddlVehicleMake.DataValueField = "vehicleMakeID";
                                                                            ddlVehicleMake.DataBind();
                                                                            ddlVehicleMake.SelectedIndex = -1;
                                                                            ddlVehicleMake.Items.Insert(0, "");

                                                                            //VehicleModel
                                                                            ddlVehicleModel.DataSource = dtVehicleModel;
                                                                            ddlVehicleModel.DataTextField = "VehicleModelDesc";
                                                                            ddlVehicleModel.DataValueField = "VehicleModelID";
                                                                            ddlVehicleModel.DataBind();
                                                                            ddlVehicleModel.SelectedIndex = -1;
                                                                            ddlVehicleModel.Items.Insert(0, "");

                                                                            radGenTons.Visible = false;
                                                                            Label23.Visible = false;
                                                                            radHeavyTruck.Visible = false;
                                                                            lblHeavyTruck.Visible = false;

                                                                            //if (!TxtVehicleValue.Enabled)
                                                                            TxtVehicleValue.Text = "";
                                                                            lblRentalReim.Visible = false;
                                                                            radRentalReimCov.Visible = false;
                                                                            if (radRentalReimCov.SelectedItem.Value.ToString() == "Y")
                                                                                radRentalReimCov.SelectedIndex = 1;

                                                                            radMotorcycle.SelectedIndex = 0;
                                                                            ddlVehicleUse.SelectedIndex = 1;
                                                                        }
                                                                        else
                                                                        {
                                                                        }
                                                                        #endregion
                                                                    }
                                                                    else
                                                                    {
                                                                        #region
                                                                        dtVehicleUseC = EPolicy.LookupTables.LookupTables.GetTable("VI_VehicleUseCommercial");
                                                                        dtVehicleUseP = EPolicy.LookupTables.LookupTables.GetTable("VI_VehicleUseNoCommercial");
                                                                        dtVehicleMakeMotorcycle = EPolicy.LookupTables.LookupTables.GetTable("VehicleMakeMotorcycle");
                                                                        dtVehicleModel = EPolicy.LookupTables.LookupTables.GetTable("VehicleModel");
                                                                        dtVehicleMake = EPolicy.LookupTables.LookupTables.GetTable("VehicleMake");

                                                                        if (ChildsElement["UseClass"].InnerText == "CML" && radMotorcycle.SelectedIndex != 0)
                                                                        {
                                                                            //VehicleUse
                                                                            ddlVehicleUse.DataSource = dtVehicleUseC;
                                                                            ddlVehicleUse.DataTextField = "VehicleUseDesc";
                                                                            ddlVehicleUse.DataValueField = "Code";
                                                                            ddlVehicleUse.DataBind();
                                                                            ddlVehicleUse.SelectedIndex = -1;
                                                                            ddlVehicleUse.Items.Insert(0, "");

                                                                            //VehicleModel
                                                                            ddlVehicleModel.DataSource = dtVehicleModel;
                                                                            ddlVehicleModel.DataTextField = "VehicleModelDesc";
                                                                            ddlVehicleModel.DataValueField = "VehicleModelID";
                                                                            ddlVehicleModel.DataBind();
                                                                            ddlVehicleModel.SelectedIndex = -1;
                                                                            ddlVehicleModel.Items.Insert(0, "");

                                                                            //VehicleMake
                                                                            ddlVehicleMake.DataSource = dtVehicleMake;
                                                                            ddlVehicleMake.DataTextField = "vehicleMakeDesc";
                                                                            ddlVehicleMake.DataValueField = "vehicleMakeID";
                                                                            ddlVehicleMake.DataBind();
                                                                            ddlVehicleMake.SelectedIndex = -1;
                                                                            ddlVehicleMake.Items.Insert(0, "");
                                                                        }
                                                                        else if (ChildsElement["UseClass"].InnerText == "CML" && radMotorcycle.SelectedIndex == 0)
                                                                        {
                                                                            //VehicleUse
                                                                            ddlVehicleUse.DataSource = dtVehicleUseC;
                                                                            ddlVehicleUse.DataTextField = "VehicleUseDesc";
                                                                            ddlVehicleUse.DataValueField = "Code";
                                                                            ddlVehicleUse.DataBind();
                                                                            ddlVehicleUse.SelectedIndex = -1;
                                                                            ddlVehicleUse.Items.Insert(0, "");
                                                                            ddlVehicleUse.Items.RemoveAt(1);
                                                                            ddlVehicleUse.Items.RemoveAt(2);
                                                                            ddlVehicleUse.Items.Insert(2, "Private");
                                                                            ddlVehicleUse.Items.FindByValue("Private").Value = "P";

                                                                            //VehicleMake
                                                                            ddlVehicleMake.DataSource = dtVehicleMakeMotorcycle;
                                                                            ddlVehicleMake.DataTextField = "vehicleMakeDesc";
                                                                            ddlVehicleMake.DataValueField = "vehicleMakeID";
                                                                            ddlVehicleMake.DataBind();
                                                                            ddlVehicleMake.SelectedIndex = -1;
                                                                            ddlVehicleMake.Items.Insert(0, "");

                                                                            //VehicleModel
                                                                            ddlVehicleModel.DataSource = dtVehicleModel;
                                                                            ddlVehicleModel.DataTextField = "VehicleModelDesc";
                                                                            ddlVehicleModel.DataValueField = "VehicleModelID";
                                                                            ddlVehicleModel.DataBind();
                                                                            ddlVehicleModel.SelectedIndex = -1;
                                                                            ddlVehicleModel.Items.Insert(0, "");

                                                                            radGenTons.Visible = false;
                                                                            Label23.Visible = false;
                                                                            radHeavyTruck.Visible = false;
                                                                            lblHeavyTruck.Visible = false;

                                                                            //if (!TxtVehicleValue.Enabled)
                                                                            TxtVehicleValue.Enabled = false;
                                                                        }
                                                                        else
                                                                        {
                                                                            //VehicleUse
                                                                            ddlVehicleUse.DataSource = dtVehicleUseP;
                                                                            ddlVehicleUse.DataTextField = "VehicleUseDesc";
                                                                            ddlVehicleUse.DataValueField = "Code";
                                                                            ddlVehicleUse.DataBind();
                                                                            ddlVehicleUse.SelectedIndex = -1;
                                                                            ddlVehicleUse.Items.Insert(0, "");
                                                                            ddlVehicleUse.SelectedItem.Value = "Private";

                                                                            //VehicleModel
                                                                            ddlVehicleModel.DataSource = dtVehicleModel;
                                                                            ddlVehicleModel.DataTextField = "VehicleModelDesc";
                                                                            ddlVehicleModel.DataValueField = "VehicleModelID";
                                                                            ddlVehicleModel.DataBind();
                                                                            ddlVehicleModel.SelectedIndex = -1;
                                                                            ddlVehicleModel.Items.Insert(0, "");

                                                                            //VehicleMake
                                                                            ddlVehicleMake.DataSource = dtVehicleMake;
                                                                            ddlVehicleMake.DataTextField = "vehicleMakeDesc";
                                                                            ddlVehicleMake.DataValueField = "vehicleMakeID";
                                                                            ddlVehicleMake.DataBind();
                                                                            ddlVehicleMake.SelectedIndex = -1;
                                                                            ddlVehicleMake.Items.Insert(0, "");
                                                                        }

                                                                        ddlVehicleUse.SelectedIndex = 1;
                                                                        #endregion
                                                                    }

                                                                    ddlVehicleMake.SelectedIndex = ddlVehicleMake.Items.IndexOf(ddlVehicleMake.Items.FindByText((GrandChildsElements["Make"].InnerText.Trim()).ToString()));
                                                                    ddlVehicleMake_SelectedIndexChanged(String.Empty, EventArgs.Empty);


                                                                    dt = GetVehicleModelByVehicleMakeIDFromPPS(int.Parse(ddlVehicleMake.SelectedItem.Value), GrandChildsElements["Model"].InnerText.Trim
        ());
                                                                    if (dt.Rows.Count > 0)
                                                                    {
                                                                        ddlVehicleModel.SelectedIndex = ddlVehicleModel.Items.IndexOf(ddlVehicleModel.Items.FindByText((dt.Rows[0]["VehicleModelDesc"].ToString().Trim()).ToString()));
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        else
                                                        {

                                                            dt = new DataTable();

                                                            dt = GetVehicleMakeFromPPS(GrandChildsElements["Make"].InnerText.Trim
        (), isMotorcycle);
                                                            if (dt.Rows.Count > 0)
                                                            {
                                                                ddlVehicleMake.SelectedIndex = ddlVehicleMake.Items.IndexOf(ddlVehicleMake.Items.FindByText((dt.Rows[0]["VehicleMakeDesc"].ToString().Trim()).ToString()));
                                                                ddlVehicleMake_SelectedIndexChanged(String.Empty, EventArgs.Empty);

                                                                if (ddlVehicleMake.SelectedItem.Value != "")
                                                                {
                                                                    if (int.Parse(ddlVehicleMake.SelectedItem.Value) > 0)
                                                                    {
                                                                        dt = GetVehicleModelByVehicleMakeIDFromPPS(int.Parse(ddlVehicleMake.SelectedItem.Value), GrandChildsElements["Model"].InnerText.Trim
                ());
                                                                        if (dt.Rows.Count > 0)
                                                                        {
                                                                            ddlVehicleModel.SelectedIndex = ddlVehicleModel.Items.IndexOf(ddlVehicleModel.Items.FindByText((dt.Rows[0]["VehicleModelDesc"].ToString().Trim()).ToString()));
                                                                        }
                                                                        else
                                                                        {
                                                                            dt = new DataTable();
                                                                            AddVehicleModelFromPPS(ddlVehicleMake.SelectedItem.Value, GrandChildsElements["Model"].InnerText.Trim
                ().ToString());
                                                                            if (isMotorcycle)
                                                                            {
                                                                                #region
                                                                                if (GrandChildsElements["BodyType"].InnerText.ToString().Trim().ToUpper() == "MC" || GrandChildsElements["BodyType"].InnerText.ToString().Trim().ToUpper() == "MS" || GrandChildsElements["BodyType"].InnerText.ToString().Trim().ToUpper() == "MNS")
                                                                                {
                                                                                    isMotorcycle = true;
                                                                                    //VehicleUse
                                                                                    ddlVehicleUse.DataSource = dtVehicleUseC;
                                                                                    ddlVehicleUse.DataTextField = "VehicleUseDesc";
                                                                                    ddlVehicleUse.DataValueField = "Code";
                                                                                    ddlVehicleUse.DataBind();
                                                                                    ddlVehicleUse.SelectedIndex = -1;
                                                                                    ddlVehicleUse.Items.Insert(0, "");
                                                                                    ddlVehicleUse.Items.RemoveAt(1);
                                                                                    ddlVehicleUse.Items.RemoveAt(2);
                                                                                    ddlVehicleUse.Items.Insert(2, "Private");
                                                                                    ddlVehicleUse.Items.FindByValue("Private").Value = "P";

                                                                                    //VehicleMake
                                                                                    ddlVehicleMake.DataSource = dtVehicleMakeMotorcycle;
                                                                                    ddlVehicleMake.DataTextField = "vehicleMakeDesc";
                                                                                    ddlVehicleMake.DataValueField = "vehicleMakeID";
                                                                                    ddlVehicleMake.DataBind();
                                                                                    ddlVehicleMake.SelectedIndex = -1;
                                                                                    ddlVehicleMake.Items.Insert(0, "");

                                                                                    //VehicleModel
                                                                                    ddlVehicleModel.DataSource = dtVehicleModel;
                                                                                    ddlVehicleModel.DataTextField = "VehicleModelDesc";
                                                                                    ddlVehicleModel.DataValueField = "VehicleModelID";
                                                                                    ddlVehicleModel.DataBind();
                                                                                    ddlVehicleModel.SelectedIndex = -1;
                                                                                    ddlVehicleModel.Items.Insert(0, "");

                                                                                    radGenTons.Visible = false;
                                                                                    Label23.Visible = false;
                                                                                    radHeavyTruck.Visible = false;
                                                                                    lblHeavyTruck.Visible = false;

                                                                                    //if (!TxtVehicleValue.Enabled)
                                                                                    TxtVehicleValue.Text = "";
                                                                                    lblRentalReim.Visible = false;
                                                                                    radRentalReimCov.Visible = false;
                                                                                    if (radRentalReimCov.SelectedItem.Value.ToString() == "Y")
                                                                                        radRentalReimCov.SelectedIndex = 1;

                                                                                    radMotorcycle.SelectedIndex = 0;
                                                                                    ddlVehicleUse.SelectedIndex = 1;
                                                                                }
                                                                                else
                                                                                {

                                                                                }
                                                                                #endregion
                                                                            }
                                                                            else
                                                                            {
                                                                                #region
                                                                                dtVehicleUseC = EPolicy.LookupTables.LookupTables.GetTable("VI_VehicleUseCommercial");
                                                                                dtVehicleUseP = EPolicy.LookupTables.LookupTables.GetTable("VI_VehicleUseNoCommercial");
                                                                                dtVehicleMakeMotorcycle = EPolicy.LookupTables.LookupTables.GetTable("VehicleMakeMotorcycle");
                                                                                dtVehicleModel = EPolicy.LookupTables.LookupTables.GetTable("VehicleModel");
                                                                                dtVehicleMake = EPolicy.LookupTables.LookupTables.GetTable("VehicleMake");

                                                                                if (ChildsElement["UseClass"].InnerText == "CML" && radMotorcycle.SelectedIndex != 0)
                                                                                {
                                                                                    //VehicleUse
                                                                                    ddlVehicleUse.DataSource = dtVehicleUseC;
                                                                                    ddlVehicleUse.DataTextField = "VehicleUseDesc";
                                                                                    ddlVehicleUse.DataValueField = "Code";
                                                                                    ddlVehicleUse.DataBind();
                                                                                    ddlVehicleUse.SelectedIndex = -1;
                                                                                    ddlVehicleUse.Items.Insert(0, "");

                                                                                    //VehicleModel
                                                                                    ddlVehicleModel.DataSource = dtVehicleModel;
                                                                                    ddlVehicleModel.DataTextField = "VehicleModelDesc";
                                                                                    ddlVehicleModel.DataValueField = "VehicleModelID";
                                                                                    ddlVehicleModel.DataBind();
                                                                                    ddlVehicleModel.SelectedIndex = -1;
                                                                                    ddlVehicleModel.Items.Insert(0, "");

                                                                                    //VehicleMake
                                                                                    ddlVehicleMake.DataSource = dtVehicleMake;
                                                                                    ddlVehicleMake.DataTextField = "vehicleMakeDesc";
                                                                                    ddlVehicleMake.DataValueField = "vehicleMakeID";
                                                                                    ddlVehicleMake.DataBind();
                                                                                    ddlVehicleMake.SelectedIndex = -1;
                                                                                    ddlVehicleMake.Items.Insert(0, "");
                                                                                }
                                                                                else if (ChildsElement["UseClass"].InnerText == "CML" && radMotorcycle.SelectedIndex == 0)
                                                                                {
                                                                                    //VehicleUse
                                                                                    ddlVehicleUse.DataSource = dtVehicleUseC;
                                                                                    ddlVehicleUse.DataTextField = "VehicleUseDesc";
                                                                                    ddlVehicleUse.DataValueField = "Code";
                                                                                    ddlVehicleUse.DataBind();
                                                                                    ddlVehicleUse.SelectedIndex = -1;
                                                                                    ddlVehicleUse.Items.Insert(0, "");
                                                                                    ddlVehicleUse.Items.RemoveAt(1);
                                                                                    ddlVehicleUse.Items.RemoveAt(2);
                                                                                    ddlVehicleUse.Items.Insert(2, "Private");
                                                                                    ddlVehicleUse.Items.FindByValue("Private").Value = "P";

                                                                                    //VehicleMake
                                                                                    ddlVehicleMake.DataSource = dtVehicleMakeMotorcycle;
                                                                                    ddlVehicleMake.DataTextField = "vehicleMakeDesc";
                                                                                    ddlVehicleMake.DataValueField = "vehicleMakeID";
                                                                                    ddlVehicleMake.DataBind();
                                                                                    ddlVehicleMake.SelectedIndex = -1;
                                                                                    ddlVehicleMake.Items.Insert(0, "");

                                                                                    //VehicleModel
                                                                                    ddlVehicleModel.DataSource = dtVehicleModel;
                                                                                    ddlVehicleModel.DataTextField = "VehicleModelDesc";
                                                                                    ddlVehicleModel.DataValueField = "VehicleModelID";
                                                                                    ddlVehicleModel.DataBind();
                                                                                    ddlVehicleModel.SelectedIndex = -1;
                                                                                    ddlVehicleModel.Items.Insert(0, "");

                                                                                    radGenTons.Visible = false;
                                                                                    Label23.Visible = false;
                                                                                    radHeavyTruck.Visible = false;
                                                                                    lblHeavyTruck.Visible = false;

                                                                                    //if (!TxtVehicleValue.Enabled)
                                                                                    TxtVehicleValue.Enabled = false;
                                                                                }
                                                                                else
                                                                                {
                                                                                    //VehicleUse
                                                                                    ddlVehicleUse.DataSource = dtVehicleUseP;
                                                                                    ddlVehicleUse.DataTextField = "VehicleUseDesc";
                                                                                    ddlVehicleUse.DataValueField = "Code";
                                                                                    ddlVehicleUse.DataBind();
                                                                                    ddlVehicleUse.SelectedIndex = -1;
                                                                                    ddlVehicleUse.Items.Insert(0, "");
                                                                                    ddlVehicleUse.SelectedItem.Value = "Private";

                                                                                    //VehicleModel
                                                                                    ddlVehicleModel.DataSource = dtVehicleModel;
                                                                                    ddlVehicleModel.DataTextField = "VehicleModelDesc";
                                                                                    ddlVehicleModel.DataValueField = "VehicleModelID";
                                                                                    ddlVehicleModel.DataBind();
                                                                                    ddlVehicleModel.SelectedIndex = -1;
                                                                                    ddlVehicleModel.Items.Insert(0, "");

                                                                                    //VehicleMake
                                                                                    ddlVehicleMake.DataSource = dtVehicleMake;
                                                                                    ddlVehicleMake.DataTextField = "vehicleMakeDesc";
                                                                                    ddlVehicleMake.DataValueField = "vehicleMakeID";
                                                                                    ddlVehicleMake.DataBind();
                                                                                    ddlVehicleMake.SelectedIndex = -1;
                                                                                    ddlVehicleMake.Items.Insert(0, "");
                                                                                }

                                                                                ddlVehicleUse.SelectedIndex = 1;
                                                                                #endregion
                                                                            }

                                                                            ddlVehicleMake.SelectedIndex = ddlVehicleMake.Items.IndexOf(ddlVehicleMake.Items.FindByText((GrandChildsElements["Make"].InnerText.Trim()).ToString()));
                                                                            ddlVehicleMake_SelectedIndexChanged(String.Empty, EventArgs.Empty);


                                                                            dt = GetVehicleModelByVehicleMakeIDFromPPS(int.Parse(ddlVehicleMake.SelectedItem.Value), GrandChildsElements["Model"].InnerText.Trim
                ());
                                                                            if (dt.Rows.Count > 0)
                                                                            {
                                                                                ddlVehicleModel.SelectedIndex = ddlVehicleModel.Items.IndexOf(ddlVehicleModel.Items.FindByText((dt.Rows[0]["VehicleModelDesc"].ToString().Trim()).ToString()));
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                            else
                                                            {

                                                                dt = new DataTable();

                                                                dt = AddVehicleMakeFromPPS(GrandChildsElements["Make"].InnerText.Trim(), isMotorcycle);

                                                                if (isMotorcycle)
                                                                {
                                                                    #region
                                                                    if (GrandChildsElements["BodyType"].InnerText.ToString().Trim().ToUpper() == "MC" || GrandChildsElements["BodyType"].InnerText.ToString().Trim().ToUpper() == "MS" || GrandChildsElements["BodyType"].InnerText.ToString().Trim().ToUpper() == "MNS")
                                                                    {
                                                                        isMotorcycle = true;
                                                                        //VehicleUse
                                                                        ddlVehicleUse.DataSource = dtVehicleUseC;
                                                                        ddlVehicleUse.DataTextField = "VehicleUseDesc";
                                                                        ddlVehicleUse.DataValueField = "Code";
                                                                        ddlVehicleUse.DataBind();
                                                                        ddlVehicleUse.SelectedIndex = -1;
                                                                        ddlVehicleUse.Items.Insert(0, "");
                                                                        ddlVehicleUse.Items.RemoveAt(1);
                                                                        ddlVehicleUse.Items.RemoveAt(2);
                                                                        ddlVehicleUse.Items.Insert(2, "Private");
                                                                        ddlVehicleUse.Items.FindByValue("Private").Value = "P";

                                                                        //VehicleMake
                                                                        ddlVehicleMake.DataSource = dtVehicleMakeMotorcycle;
                                                                        ddlVehicleMake.DataTextField = "vehicleMakeDesc";
                                                                        ddlVehicleMake.DataValueField = "vehicleMakeID";
                                                                        ddlVehicleMake.DataBind();
                                                                        ddlVehicleMake.SelectedIndex = -1;
                                                                        ddlVehicleMake.Items.Insert(0, "");

                                                                        //VehicleModel
                                                                        ddlVehicleModel.DataSource = dtVehicleModel;
                                                                        ddlVehicleModel.DataTextField = "VehicleModelDesc";
                                                                        ddlVehicleModel.DataValueField = "VehicleModelID";
                                                                        ddlVehicleModel.DataBind();
                                                                        ddlVehicleModel.SelectedIndex = -1;
                                                                        ddlVehicleModel.Items.Insert(0, "");

                                                                        radGenTons.Visible = false;
                                                                        Label23.Visible = false;
                                                                        radHeavyTruck.Visible = false;
                                                                        lblHeavyTruck.Visible = false;

                                                                        //if (!TxtVehicleValue.Enabled)
                                                                        TxtVehicleValue.Text = "";
                                                                        lblRentalReim.Visible = false;
                                                                        radRentalReimCov.Visible = false;
                                                                        if (radRentalReimCov.SelectedItem.Value.ToString() == "Y")
                                                                            radRentalReimCov.SelectedIndex = 1;

                                                                        radMotorcycle.SelectedIndex = 0;
                                                                        ddlVehicleUse.SelectedIndex = 1;
                                                                    }
                                                                    else
                                                                    {

                                                                    }
                                                                    #endregion
                                                                }
                                                                else
                                                                {
                                                                    #region
                                                                    dtVehicleUseC = EPolicy.LookupTables.LookupTables.GetTable("VI_VehicleUseCommercial");
                                                                    dtVehicleUseP = EPolicy.LookupTables.LookupTables.GetTable("VI_VehicleUseNoCommercial");
                                                                    dtVehicleMakeMotorcycle = EPolicy.LookupTables.LookupTables.GetTable("VehicleMakeMotorcycle");
                                                                    dtVehicleModel = EPolicy.LookupTables.LookupTables.GetTable("VehicleModel");
                                                                    dtVehicleMake = EPolicy.LookupTables.LookupTables.GetTable("VehicleMake");

                                                                    if (ChildsElement["UseClass"].InnerText == "CML" && radMotorcycle.SelectedIndex != 0)
                                                                    {
                                                                        //VehicleUse
                                                                        ddlVehicleUse.DataSource = dtVehicleUseC;
                                                                        ddlVehicleUse.DataTextField = "VehicleUseDesc";
                                                                        ddlVehicleUse.DataValueField = "Code";
                                                                        ddlVehicleUse.DataBind();
                                                                        ddlVehicleUse.SelectedIndex = -1;
                                                                        ddlVehicleUse.Items.Insert(0, "");

                                                                        //VehicleModel
                                                                        ddlVehicleModel.DataSource = dtVehicleModel;
                                                                        ddlVehicleModel.DataTextField = "VehicleModelDesc";
                                                                        ddlVehicleModel.DataValueField = "VehicleModelID";
                                                                        ddlVehicleModel.DataBind();
                                                                        ddlVehicleModel.SelectedIndex = -1;
                                                                        ddlVehicleModel.Items.Insert(0, "");

                                                                        //VehicleMake
                                                                        ddlVehicleMake.DataSource = dtVehicleMake;
                                                                        ddlVehicleMake.DataTextField = "vehicleMakeDesc";
                                                                        ddlVehicleMake.DataValueField = "vehicleMakeID";
                                                                        ddlVehicleMake.DataBind();
                                                                        ddlVehicleMake.SelectedIndex = -1;
                                                                        ddlVehicleMake.Items.Insert(0, "");
                                                                    }
                                                                    else if (ChildsElement["UseClass"].InnerText == "CML" && radMotorcycle.SelectedIndex == 0)
                                                                    {
                                                                        //VehicleUse
                                                                        ddlVehicleUse.DataSource = dtVehicleUseC;
                                                                        ddlVehicleUse.DataTextField = "VehicleUseDesc";
                                                                        ddlVehicleUse.DataValueField = "Code";
                                                                        ddlVehicleUse.DataBind();
                                                                        ddlVehicleUse.SelectedIndex = -1;
                                                                        ddlVehicleUse.Items.Insert(0, "");
                                                                        ddlVehicleUse.Items.RemoveAt(1);
                                                                        ddlVehicleUse.Items.RemoveAt(2);
                                                                        ddlVehicleUse.Items.Insert(2, "Private");
                                                                        ddlVehicleUse.Items.FindByValue("Private").Value = "P";

                                                                        //VehicleMake
                                                                        ddlVehicleMake.DataSource = dtVehicleMakeMotorcycle;
                                                                        ddlVehicleMake.DataTextField = "vehicleMakeDesc";
                                                                        ddlVehicleMake.DataValueField = "vehicleMakeID";
                                                                        ddlVehicleMake.DataBind();
                                                                        ddlVehicleMake.SelectedIndex = -1;
                                                                        ddlVehicleMake.Items.Insert(0, "");

                                                                        //VehicleModel
                                                                        ddlVehicleModel.DataSource = dtVehicleModel;
                                                                        ddlVehicleModel.DataTextField = "VehicleModelDesc";
                                                                        ddlVehicleModel.DataValueField = "VehicleModelID";
                                                                        ddlVehicleModel.DataBind();
                                                                        ddlVehicleModel.SelectedIndex = -1;
                                                                        ddlVehicleModel.Items.Insert(0, "");

                                                                        radGenTons.Visible = false;
                                                                        Label23.Visible = false;
                                                                        radHeavyTruck.Visible = false;
                                                                        lblHeavyTruck.Visible = false;

                                                                        //if (!TxtVehicleValue.Enabled)
                                                                        TxtVehicleValue.Enabled = false;
                                                                    }
                                                                    else
                                                                    {
                                                                        //VehicleUse
                                                                        ddlVehicleUse.DataSource = dtVehicleUseP;
                                                                        ddlVehicleUse.DataTextField = "VehicleUseDesc";
                                                                        ddlVehicleUse.DataValueField = "Code";
                                                                        ddlVehicleUse.DataBind();
                                                                        ddlVehicleUse.SelectedIndex = -1;
                                                                        ddlVehicleUse.Items.Insert(0, "");
                                                                        ddlVehicleUse.SelectedItem.Value = "Private";

                                                                        //VehicleModel
                                                                        ddlVehicleModel.DataSource = dtVehicleModel;
                                                                        ddlVehicleModel.DataTextField = "VehicleModelDesc";
                                                                        ddlVehicleModel.DataValueField = "VehicleModelID";
                                                                        ddlVehicleModel.DataBind();
                                                                        ddlVehicleModel.SelectedIndex = -1;
                                                                        ddlVehicleModel.Items.Insert(0, "");

                                                                        //VehicleMake
                                                                        ddlVehicleMake.DataSource = dtVehicleMake;
                                                                        ddlVehicleMake.DataTextField = "vehicleMakeDesc";
                                                                        ddlVehicleMake.DataValueField = "vehicleMakeID";
                                                                        ddlVehicleMake.DataBind();
                                                                        ddlVehicleMake.SelectedIndex = -1;
                                                                        ddlVehicleMake.Items.Insert(0, "");
                                                                    }

                                                                    ddlVehicleUse.SelectedIndex = 1;
                                                                    #endregion
                                                                }

                                                                if (dt.Rows.Count > 0)
                                                                {
                                                                    ddlVehicleMake.SelectedIndex = ddlVehicleMake.Items.IndexOf(ddlVehicleMake.Items.FindByValue((dt.Rows[0]["column1"].ToString().Trim()).ToString()));
                                                                    ddlVehicleMake_SelectedIndexChanged(String.Empty, EventArgs.Empty);

                                                                    if (ddlVehicleMake.SelectedItem.Value != "")
                                                                    {
                                                                        if (int.Parse(ddlVehicleMake.SelectedItem.Value) > 0)
                                                                        {
                                                                            dt = GetVehicleModelByVehicleMakeIDFromPPS(int.Parse(ddlVehicleMake.SelectedItem.Value), GrandChildsElements["Model"].InnerText.Trim
                    ());
                                                                            if (dt.Rows.Count > 0)
                                                                            {
                                                                                ddlVehicleModel.SelectedIndex = ddlVehicleModel.Items.IndexOf(ddlVehicleModel.Items.FindByText((dt.Rows[0]["VehicleModelDesc"].ToString().Trim()).ToString()));
                                                                            }
                                                                            else
                                                                            {
                                                                                dt = new DataTable();
                                                                                AddVehicleModelFromPPS(ddlVehicleMake.SelectedItem.Value, GrandChildsElements["Model"].InnerText.Trim
                    ().ToString());
                                                                                if (isMotorcycle)
                                                                                {
                                                                                    #region
                                                                                    if (GrandChildsElements["BodyType"].InnerText.ToString().Trim().ToUpper() == "MC" || GrandChildsElements["BodyType"].InnerText.ToString().Trim().ToUpper() == "MS" || GrandChildsElements["BodyType"].InnerText.ToString().Trim().ToUpper() == "MNS")
                                                                                    {
                                                                                        isMotorcycle = true;
                                                                                        //VehicleUse
                                                                                        ddlVehicleUse.DataSource = dtVehicleUseC;
                                                                                        ddlVehicleUse.DataTextField = "VehicleUseDesc";
                                                                                        ddlVehicleUse.DataValueField = "Code";
                                                                                        ddlVehicleUse.DataBind();
                                                                                        ddlVehicleUse.SelectedIndex = -1;
                                                                                        ddlVehicleUse.Items.Insert(0, "");
                                                                                        ddlVehicleUse.Items.RemoveAt(1);
                                                                                        ddlVehicleUse.Items.RemoveAt(2);
                                                                                        ddlVehicleUse.Items.Insert(2, "Private");
                                                                                        ddlVehicleUse.Items.FindByValue("Private").Value = "P";

                                                                                        //VehicleMake
                                                                                        ddlVehicleMake.DataSource = dtVehicleMakeMotorcycle;
                                                                                        ddlVehicleMake.DataTextField = "vehicleMakeDesc";
                                                                                        ddlVehicleMake.DataValueField = "vehicleMakeID";
                                                                                        ddlVehicleMake.DataBind();
                                                                                        ddlVehicleMake.SelectedIndex = -1;
                                                                                        ddlVehicleMake.Items.Insert(0, "");

                                                                                        //VehicleModel
                                                                                        ddlVehicleModel.DataSource = dtVehicleModel;
                                                                                        ddlVehicleModel.DataTextField = "VehicleModelDesc";
                                                                                        ddlVehicleModel.DataValueField = "VehicleModelID";
                                                                                        ddlVehicleModel.DataBind();
                                                                                        ddlVehicleModel.SelectedIndex = -1;
                                                                                        ddlVehicleModel.Items.Insert(0, "");

                                                                                        radGenTons.Visible = false;
                                                                                        Label23.Visible = false;
                                                                                        radHeavyTruck.Visible = false;
                                                                                        lblHeavyTruck.Visible = false;

                                                                                        //if (!TxtVehicleValue.Enabled)
                                                                                        TxtVehicleValue.Text = "";
                                                                                        lblRentalReim.Visible = false;
                                                                                        radRentalReimCov.Visible = false;
                                                                                        if (radRentalReimCov.SelectedItem.Value.ToString() == "Y")
                                                                                            radRentalReimCov.SelectedIndex = 1;

                                                                                        radMotorcycle.SelectedIndex = 0;
                                                                                        ddlVehicleUse.SelectedIndex = 1;
                                                                                    }
                                                                                    else
                                                                                    {

                                                                                    }
                                                                                    #endregion
                                                                                }
                                                                                else
                                                                                {
                                                                                    #region
                                                                                    dtVehicleUseC = EPolicy.LookupTables.LookupTables.GetTable("VI_VehicleUseCommercial");
                                                                                    dtVehicleUseP = EPolicy.LookupTables.LookupTables.GetTable("VI_VehicleUseNoCommercial");
                                                                                    dtVehicleMakeMotorcycle = EPolicy.LookupTables.LookupTables.GetTable("VehicleMakeMotorcycle");
                                                                                    dtVehicleModel = EPolicy.LookupTables.LookupTables.GetTable("VehicleModel");
                                                                                    dtVehicleMake = EPolicy.LookupTables.LookupTables.GetTable("VehicleMake");

                                                                                    if (ChildsElement["UseClass"].InnerText == "CML" && radMotorcycle.SelectedIndex != 0)
                                                                                    {
                                                                                        //VehicleUse
                                                                                        ddlVehicleUse.DataSource = dtVehicleUseC;
                                                                                        ddlVehicleUse.DataTextField = "VehicleUseDesc";
                                                                                        ddlVehicleUse.DataValueField = "Code";
                                                                                        ddlVehicleUse.DataBind();
                                                                                        ddlVehicleUse.SelectedIndex = -1;
                                                                                        ddlVehicleUse.Items.Insert(0, "");

                                                                                        //VehicleModel
                                                                                        ddlVehicleModel.DataSource = dtVehicleModel;
                                                                                        ddlVehicleModel.DataTextField = "VehicleModelDesc";
                                                                                        ddlVehicleModel.DataValueField = "VehicleModelID";
                                                                                        ddlVehicleModel.DataBind();
                                                                                        ddlVehicleModel.SelectedIndex = -1;
                                                                                        ddlVehicleModel.Items.Insert(0, "");

                                                                                        //VehicleMake
                                                                                        ddlVehicleMake.DataSource = dtVehicleMake;
                                                                                        ddlVehicleMake.DataTextField = "vehicleMakeDesc";
                                                                                        ddlVehicleMake.DataValueField = "vehicleMakeID";
                                                                                        ddlVehicleMake.DataBind();
                                                                                        ddlVehicleMake.SelectedIndex = -1;
                                                                                        ddlVehicleMake.Items.Insert(0, "");
                                                                                    }
                                                                                    else if (ChildsElement["UseClass"].InnerText == "CML" && radMotorcycle.SelectedIndex == 0)
                                                                                    {
                                                                                        //VehicleUse
                                                                                        ddlVehicleUse.DataSource = dtVehicleUseC;
                                                                                        ddlVehicleUse.DataTextField = "VehicleUseDesc";
                                                                                        ddlVehicleUse.DataValueField = "Code";
                                                                                        ddlVehicleUse.DataBind();
                                                                                        ddlVehicleUse.SelectedIndex = -1;
                                                                                        ddlVehicleUse.Items.Insert(0, "");
                                                                                        ddlVehicleUse.Items.RemoveAt(1);
                                                                                        ddlVehicleUse.Items.RemoveAt(2);
                                                                                        ddlVehicleUse.Items.Insert(2, "Private");
                                                                                        ddlVehicleUse.Items.FindByValue("Private").Value = "P";

                                                                                        //VehicleMake
                                                                                        ddlVehicleMake.DataSource = dtVehicleMakeMotorcycle;
                                                                                        ddlVehicleMake.DataTextField = "vehicleMakeDesc";
                                                                                        ddlVehicleMake.DataValueField = "vehicleMakeID";
                                                                                        ddlVehicleMake.DataBind();
                                                                                        ddlVehicleMake.SelectedIndex = -1;
                                                                                        ddlVehicleMake.Items.Insert(0, "");

                                                                                        //VehicleModel
                                                                                        ddlVehicleModel.DataSource = dtVehicleModel;
                                                                                        ddlVehicleModel.DataTextField = "VehicleModelDesc";
                                                                                        ddlVehicleModel.DataValueField = "VehicleModelID";
                                                                                        ddlVehicleModel.DataBind();
                                                                                        ddlVehicleModel.SelectedIndex = -1;
                                                                                        ddlVehicleModel.Items.Insert(0, "");

                                                                                        radGenTons.Visible = false;
                                                                                        Label23.Visible = false;
                                                                                        radHeavyTruck.Visible = false;
                                                                                        lblHeavyTruck.Visible = false;

                                                                                        //if (!TxtVehicleValue.Enabled)
                                                                                        TxtVehicleValue.Enabled = false;
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        //VehicleUse
                                                                                        ddlVehicleUse.DataSource = dtVehicleUseP;
                                                                                        ddlVehicleUse.DataTextField = "VehicleUseDesc";
                                                                                        ddlVehicleUse.DataValueField = "Code";
                                                                                        ddlVehicleUse.DataBind();
                                                                                        ddlVehicleUse.SelectedIndex = -1;
                                                                                        ddlVehicleUse.Items.Insert(0, "");
                                                                                        ddlVehicleUse.SelectedItem.Value = "Private";

                                                                                        //VehicleModel
                                                                                        ddlVehicleModel.DataSource = dtVehicleModel;
                                                                                        ddlVehicleModel.DataTextField = "VehicleModelDesc";
                                                                                        ddlVehicleModel.DataValueField = "VehicleModelID";
                                                                                        ddlVehicleModel.DataBind();
                                                                                        ddlVehicleModel.SelectedIndex = -1;
                                                                                        ddlVehicleModel.Items.Insert(0, "");

                                                                                        //VehicleMake
                                                                                        ddlVehicleMake.DataSource = dtVehicleMake;
                                                                                        ddlVehicleMake.DataTextField = "vehicleMakeDesc";
                                                                                        ddlVehicleMake.DataValueField = "vehicleMakeID";
                                                                                        ddlVehicleMake.DataBind();
                                                                                        ddlVehicleMake.SelectedIndex = -1;
                                                                                        ddlVehicleMake.Items.Insert(0, "");
                                                                                    }

                                                                                    ddlVehicleUse.SelectedIndex = 1;
                                                                                    #endregion
                                                                                }

                                                                                ddlVehicleMake.SelectedIndex = ddlVehicleMake.Items.IndexOf(ddlVehicleMake.Items.FindByText((GrandChildsElements["Make"].InnerText.Trim()).ToString()));
                                                                                ddlVehicleMake_SelectedIndexChanged(String.Empty, EventArgs.Empty);


                                                                                dt = GetVehicleModelByVehicleMakeIDFromPPS(int.Parse(ddlVehicleMake.SelectedItem.Value), GrandChildsElements["Model"].InnerText.Trim
                    ());
                                                                                if (dt.Rows.Count > 0)
                                                                                {
                                                                                    ddlVehicleModel.SelectedIndex = ddlVehicleModel.Items.IndexOf(ddlVehicleModel.Items.FindByText((dt.Rows[0]["VehicleModelDesc"].ToString().Trim()).ToString()));
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }

                                                            }

                                                        }
                                                        ddlVehicleYear.SelectedIndex = ddlVehicleYear.Items.IndexOf(ddlVehicleYear.Items.FindByText((GrandChildsElements["MYear"].InnerText.Trim()).ToString()));
                                                        DateTime CarDate = new DateTime(int.Parse(GrandChildsElements["MYear"].InnerText.ToString().Trim()) - 1, 9, 1);

                                                        int dateMonths = 0;
                                                        dateMonths = ((DateTime.Parse(XmlPolicyBase["Incept"].InnerText.ToString()).Year - CarDate.Year) * 12) + DateTime.Parse(XmlPolicyBase["Incept"].InnerText.ToString()).Month - CarDate.Month;


                                                        //Si es el Primer año la depreciación es 7.5%
                                                        if (dateMonths >= 12)
                                                        {
                                                            //==============================================//
                                                            //(0.975) = depreciación de 2.5% FULLCOVER ONLY //
                                                            //==============================================//
                                                            Depreciation = 0.975;
                                                        }
                                                        else
                                                        {
                                                            //==============================================//
                                                            //(0.925) = depreciación de 7.5% FULLCOVER ONLY //
                                                            //==============================================//
                                                            Depreciation = 0.925;
                                                        }

                                                        if (ChildsElement["InsVal"] != null)
                                                        {
                                                            if (ChildsElement["InsVal"].InnerText != "")
                                                            {

                                                                TxtVehicleValue.Text = (Math.Round(float.Parse(ChildsElement["InsVal"].InnerText.ToString().Trim()) * Depreciation, 0)).ToString();
                                                            }
                                                            else
                                                            {
                                                                TxtVehicleValue.Text = "0";
                                                            }
                                                        }
                                                        else
                                                        {
                                                            TxtVehicleValue.Text = "0";
                                                        }
                                                    }
                                                }
                                            }
                                            else if (GrandChilds.Name == "VehicleCvrgTable")
                                            {
                                                float CompPremium = 0;

                                                foreach (XmlElement GrandChildsElements in GrandChilds)
                                                {

                                                    //=================//
                                                    //  Cml == "BAP"   //
                                                    //=================//
                                                    if (XmlPolicyBase["PolSubType"].InnerText == "Cml")//BAP
                                                    {
                                                        if (GrandChildsElements["ReinsAsl"] != null)
                                                        {
                                                            if (GrandChildsElements["ReinsAsl"].InnerText == "12212" || GrandChildsElements["ReinsAsl"].InnerText == "90212")
                                                            {
                                                                CompPremium += float.Parse(GrandChildsElements["Premium"].InnerText.ToString());
                                                            }
                                                            else if (GrandChildsElements["ReinsAsl"].InnerText == "11212" || GrandChildsElements["ReinsAsl"].InnerText == "89212")
                                                            {
                                                                CompPremium += float.Parse(GrandChildsElements["Premium"].InnerText.ToString());
                                                            }

                                                            ReinsAsl = GrandChildsElements["ReinsAsl"].InnerText.ToString();
                                                        }
                                                    }
                                                    else
                                                    {
                                                        if (GrandChildsElements["ReinsAsl"] != null)
                                                        {
                                                            if (GrandChildsElements["ReinsAsl"].InnerText == "05211" || GrandChildsElements["ReinsAsl"].InnerText == "87211")
                                                            {
                                                                CompPremium += float.Parse(GrandChildsElements["Premium"].InnerText.ToString());
                                                            }
                                                            else if (GrandChildsElements["ReinsAsl"].InnerText == "04211" || GrandChildsElements["ReinsAsl"].InnerText == "86211")
                                                            {
                                                                CompPremium += float.Parse(GrandChildsElements["Premium"].InnerText.ToString());
                                                            }

                                                            ReinsAsl = GrandChildsElements["ReinsAsl"].InnerText.ToString();
                                                        }
                                                    }


                                                    switch (ReinsAsl)
                                                    {
                                                        case "05211"://PAP 35% Comprensivo
                                                            Comp = CompPremium.ToString();
                                                            CompLimit = RenewalLimits(GrandChildsElements["Lim1"].InnerText.ToString(), GrandChildsElements["Lim2"].InnerText.ToString());
                                                            break;

                                                        case "04211"://PAP 65% Comprensivo
                                                            Comp = CompPremium.ToString();
                                                            CompLimit = RenewalLimits(GrandChildsElements["Lim1"].InnerText.ToString(), GrandChildsElements["Lim2"].InnerText.ToString());
                                                            break;

                                                        case "12212"://BAP 35% Comprensivo
                                                            Comp = CompPremium.ToString();
                                                            CompLimit = RenewalLimits(GrandChildsElements["Lim1"].InnerText.ToString(), GrandChildsElements["Lim2"].InnerText.ToString());
                                                            break;

                                                        case "11212"://BAP 65% Comprensivo
                                                            Comp = CompPremium.ToString();
                                                            CompLimit = RenewalLimits(GrandChildsElements["Lim1"].InnerText.ToString(), GrandChildsElements["Lim2"].InnerText.ToString());
                                                            break;

                                                        case "87211"://PAP 35% Comprensivo
                                                            Comp = CompPremium.ToString();
                                                            CompLimit = RenewalLimits(GrandChildsElements["Lim1"].InnerText.ToString(), GrandChildsElements["Lim2"].InnerText.ToString());
                                                            break;

                                                        case "86211"://PAP 65% Comprensivo
                                                            Comp = CompPremium.ToString();
                                                            CompLimit = RenewalLimits(GrandChildsElements["Lim1"].InnerText.ToString(), GrandChildsElements["Lim2"].InnerText.ToString());
                                                            break;

                                                        case "90212"://BAP 35% Comprensivo
                                                            Comp = CompPremium.ToString();
                                                            CompLimit = RenewalLimits(GrandChildsElements["Lim1"].InnerText.ToString(), GrandChildsElements["Lim2"].InnerText.ToString());
                                                            break;

                                                        case "89212"://BAP 65% Comprensivo
                                                            Comp = CompPremium.ToString();
                                                            CompLimit = RenewalLimits(GrandChildsElements["Lim1"].InnerText.ToString(), GrandChildsElements["Lim2"].InnerText.ToString());
                                                            break;

                                                        case "06211"://PAP Collision
                                                            Coll = GrandChildsElements["Premium"].InnerText.ToString();
                                                            CollLimit = RenewalLimits(GrandChildsElements["Lim1"].InnerText.ToString(), GrandChildsElements["Lim2"].InnerText.ToString());
                                                            break;

                                                        case "13212"://BAP Collision
                                                            Coll = GrandChildsElements["Premium"].InnerText.ToString();
                                                            CollLimit = RenewalLimits(GrandChildsElements["Lim1"].InnerText.ToString(), GrandChildsElements["Lim2"].InnerText.ToString());
                                                            break;

                                                        case "88211"://PAP Collision
                                                            Coll = GrandChildsElements["Premium"].InnerText.ToString();
                                                            CollLimit = RenewalLimits(GrandChildsElements["Lim1"].InnerText.ToString(), GrandChildsElements["Lim2"].InnerText.ToString());
                                                            break;

                                                        case "91212"://BAP Collision
                                                            Coll = GrandChildsElements["Premium"].InnerText.ToString();
                                                            CollLimit = RenewalLimits(GrandChildsElements["Lim1"].InnerText.ToString(), GrandChildsElements["Lim2"].InnerText.ToString());
                                                            break;

                                                        case "01192"://PAP BI
                                                            BI = GrandChildsElements["Premium"].InnerText.ToString();
                                                            BILimit = RenewalLimits(GrandChildsElements["Lim1"].InnerText.ToString(), GrandChildsElements["Lim2"].InnerText.ToString());
                                                            break;

                                                        case "08194": //BAP BI
                                                            BI = GrandChildsElements["Premium"].InnerText.ToString();
                                                            BILimit = RenewalLimits(GrandChildsElements["Lim1"].InnerText.ToString(), GrandChildsElements["Lim2"].InnerText.ToString());
                                                            break;

                                                        case "02192"://PAP Property Damage
                                                            PD = GrandChildsElements["Premium"].InnerText.ToString();
                                                            PDLimit = RenewalLimits(GrandChildsElements["Lim1"].InnerText.ToString(), GrandChildsElements["Lim2"].InnerText.ToString());
                                                            break;

                                                        case "09194": //BAP Property Damage
                                                            PD = GrandChildsElements["Premium"].InnerText.ToString();
                                                            PDLimit = RenewalLimits(GrandChildsElements["Lim1"].InnerText.ToString(), GrandChildsElements["Lim2"].InnerText.ToString());
                                                            break;

                                                        case "03192"://PAP Medical
                                                            MP = GrandChildsElements["Premium"].InnerText.ToString();
                                                            MPLimit = RenewalLimits(GrandChildsElements["Lim1"].InnerText.ToString(), GrandChildsElements["Lim2"].InnerText.ToString());
                                                            break;

                                                        case "10194": //BAP Medical
                                                            MP = GrandChildsElements["Premium"].InnerText.ToString();
                                                            MPLimit = RenewalLimits(GrandChildsElements["Lim1"].InnerText.ToString(), GrandChildsElements["Lim2"].InnerText.ToString());
                                                            break;

                                                        case "78192"://PAP Motorist
                                                            Mot = GrandChildsElements["Premium"].InnerText.ToString();
                                                            if (Mot != "0.0000")
                                                                radGenMotoristCoverage.SelectedValue = "Y";
                                                            else
                                                                radGenMotoristCoverage.SelectedValue = "N";
                                                            break;

                                                        case "81194": //BAP Motorist
                                                            Mot = GrandChildsElements["Premium"].InnerText.ToString();
                                                            if (Mot != "0.0000")
                                                                radGenMotoristCoverage.SelectedValue = "Y";
                                                            else
                                                                radGenMotoristCoverage.SelectedValue = "N";
                                                            break;

                                                    }
                                                }
                                            }
                                        }
                                    }

                                    if (ddlVehicleUse.SelectedItem.Value.ToString() == "P")
                                    {
                                        if (TxtBILimitpp.SelectedItem.Value != "$10,000/$20,000")
                                        {
                                            if (TxtBILimitpp.Items.IndexOf(TxtBILimitpp.Items.FindByText("$10,000/$20,000")).ToString() == "-1")
                                            {
                                                TxtBILimitpp.Items.Add(new ListItem("$10,000/$20,000", "$10,000/$20,000"));
                                                TxtBILimitpp.SelectedIndex = TxtBILimitpp.Items.IndexOf(TxtBILimitpp.Items.FindByText("$10,000/$20,000"));
                                            }
                                            else
                                            {
                                                TxtBILimitpp.SelectedIndex = TxtBILimitpp.Items.IndexOf(TxtBILimitpp.Items.FindByText("$10,000/$20,000"));
                                            }
                                            //TxtBILimitpp.SelectedIndex = 2;
                                            //rtValue = false;
                                            //lblRecHeader.Text = "Invalid BI Limit selected for the selected criteria ($10,000/$20,000).";
                                            //mpeSeleccion.Show();
                                        }
                                    }

                                    if (ddlVehicleUse.SelectedItem.Value.ToString() == "T")
                                    {
                                        if (ddlIsland.SelectedItem.Value.ToString() == "1" || ddlIsland.SelectedItem.Value.ToString() == "2")
                                        {
                                            if (int.Parse(TxtPassengerNo.Text.ToString()) >= 5 && int.Parse(TxtPassengerNo.Text.ToString()) <= 10)
                                            {
                                                if (TxtBILimitpp.SelectedItem.Value != "$10,000/$25,000")
                                                {
                                                    //rtValue = false;
                                                    TxtBILimitpp.SelectedIndex = 2;
                                                    lblRecHeader.Text = "BI Limit " + TxtBILimitpp.SelectedItem.Value.ToString() + "  is not available with the selected criteria.";
                                                    mpeSeleccion.Show();
                                                }
                                            }
                                            else if (int.Parse(TxtPassengerNo.Text.ToString()) >= 11 && int.Parse(TxtPassengerNo.Text.ToString()) <= 30)
                                            {
                                                if (TxtBILimitpp.SelectedItem.Value != "$10,000/$50,000")
                                                {
                                                    //rtValue = false;
                                                    TxtBILimitpp.SelectedIndex = TxtBILimitpp.Items.IndexOf(TxtBILimitpp.Items.FindByText("$10,000/$50,000"));
                                                    //lblRecHeader.Text = "BI Limit " + TxtBILimitpp.SelectedItem.Value.ToString() + "  is not available with the selected criteria.";
                                                    //mpeSeleccion.Show();
                                                }
                                            }
                                        }
                                    }


                                    // LIABILITY ONLY 15%
                                    if (Comp == "0.00" && Coll == "0.00")
                                    {
                                        //C	Commercial
                                        //O	Private Passenger
                                        //P	Private
                                        //R	Rental
                                        //T	Taxi
                                        string UseClass = ChildsElement["UseClass"].InnerText == "CML" ? "C" : ChildsElement["UseClass"].InnerText == "TAXI" ? "T" : "P";
                                        string Island = ChildsElement["Island"].InnerText;//ChildsElement["Island"].InnerText == "1" ? "3" : ChildsElement["Island"].InnerText == "2" ? "1" : ChildsElement["Island"].InnerText == "3" ? "2" : "";
                                        string Motorcycle = isMotorcycle == true ? "Y" : "N";
                                        String[] Rates = new String[3];
                                        Rates = CompareRenewalLiabRates(BI, PD, MP, UseClass, Island, "N", Motorcycle, Passengers, "N");
                                        BI = Rates[0];
                                        PD = Rates[1];
                                        MP = Rates[2];
                                    }
                                    else
                                    {
                                        string UseCode = ChildsElement["UseClass"].InnerText == "CML" ? "C" : ChildsElement["UseClass"].InnerText == "TAXI" ? "T" : "P";
                                        string Island = ChildsElement["Island"].InnerText;

                                        int MostMinor = 0;

                                        for (int M = 0; M < taskControl.DriversCollection.Rows.Count; M++)
                                        {
                                            MostMinor = int.Parse(taskControl.DriversCollection.Rows[0]["DriverAge"].ToString().Trim());
                                            if (MostMinor > int.Parse(taskControl.DriversCollection.Rows[M]["DriverAge"].ToString().Trim()))
                                            {
                                                MostMinor = int.Parse(taskControl.DriversCollection.Rows[M]["DriverAge"].ToString().Trim());
                                            }
                                            else
                                            {
                                                MostMinor = int.Parse(taskControl.DriversCollection.Rows[0]["DriverAge"].ToString().Trim());
                                            }
                                        }

                                        //FillPhysDam(UseCode, Island, int.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency), "N", int.Parse(ddlVehicleYear.SelectedItem.Text.Trim()), MostMinor, int.Parse(Passengers));
                                        ddlCompCollDed.Items.Add(new ListItem(CompLimit + "/" + CollLimit, CompLimit + "/" + CollLimit));
                                        ddlCompCollDed.SelectedIndex = 0;
                                        SetCompCollDeductible();
                                    }

                                    AddRenewalVehicle_Click(BI, PD, MP, Coll, Comp, Mot, Add, TotPrem, RentReim, TaxiLoss, BILimit, PDLimit, CollLimit, CompLimit, MPLimit);

                                    CompareTotalPremiumPPS(CountVehicles == Childs.ChildNodes.Count ? true : false);

                                }
                            }

                            else if (Childs.Name == "ClientTable")
                            {
                                foreach (XmlElement ChildsElement in Childs)
                                {
                                    if (!(FilledAddress))   //Solo leerá los campos una vez, tomando los primeros que lea
                                    {
                                        taskControl.Customer.Address1 = ChildsElement["Maddr1"].InnerText;
                                        taskControl.Customer.Address2 = ChildsElement["Maddr2"].InnerText;

                                        taskControl.Customer.City = ChildsElement["Mcity"].InnerText; //txtInsuredCity.Text =
                                        taskControl.Customer.State = ChildsElement["Mstate"].InnerText;
                                        taskControl.Customer.ZipCode = ChildsElement["Mzip"].InnerText;

                                        taskControl.Customer.AddressPhysical1 = ChildsElement["Raddr1"].InnerText;
                                        taskControl.Customer.AddressPhysical2 = ChildsElement["Raddr2"].InnerText;

                                        taskControl.Customer.CityPhysical = ChildsElement["Rcity"].InnerText; //txtInsuredCity.Text =
                                        taskControl.Customer.StatePhysical = ChildsElement["Rstate"].InnerText;
                                        taskControl.Customer.ZipPhysical = ChildsElement["Rzip"].InnerText;

                                        taskControl.Customer.HomePhone = ChildsElement["Rphone"].InnerText.Trim().Replace("-", "");
                                        taskControl.Customer.JobPhone = ChildsElement["Wphone"].InnerText.Trim().Replace("-", "") == "" ? "0000000000" : ChildsElement["Wphone"].InnerText.Trim().Replace("-", "");
                                        taskControl.Customer.Cellular = ChildsElement["Cphone"].InnerText.Trim().Replace("-", "");

                                        if (ChildsElement["Eaddr"] != null)
                                        {
                                            taskControl.Customer.Email = ChildsElement["Eaddr"].InnerText.Trim() != "" ? ChildsElement["Eaddr"].InnerText.Trim() : "guardianinsurance@email.com";
                                        }
                                        else
                                        {
                                            taskControl.Customer.Email = "guardianinsurance@email.com";
                                        }

                                        InsuredAddress1 = "";// txtInsuredAddrs1.Text;
                                        InsuredAddress2 = "";// txtAddrs2.Text;
                                        InsuredZip = "";// txtZipCode.Text;
                                        InsuredWorkPhone = "";//txtWorkPhone.Text;
                                        InsuredCellular = "";// txtCellular.Text;

                                        FilledAddress = true;
                                    }
                                }
                            }
                        }
                    }
                    ///Todas las variables Insured mencionadas existen así para la ocasión en que llame el reclamante
                    ///La información del asegurado no se pierda, si no que siga hacia adelante en el proceso. 
                    ///throw new Exception("Policy loaded successfully");
                }
                #endregion
            }
            catch (Exception exp)
            {
                LogError(exp);
                string Querystring = exp.ToString().Contains("non") ? exp.Message : exp.ToString().Replace(System.Environment.NewLine, "");
                Response.Redirect("RenewalSearch.aspx" + "?Error=" + Querystring + "&RenewalNo=" + RenewalNo, false);
                lblRecHeader.Text = exp.ToString() + "///" + exp.Message;
                mpeSeleccion.Show();
            }

        }

        private string RenewalLimits(string Lim1, string Lim2)
        {
            if (Lim1 == "0.0000" && Lim2 == "0.0000")
            {
                return "$0";
            }
            else if (Lim1 == "0.0000" && Lim2 == "100000.0000" || Lim2 == "0.0000" && Lim1 == "100000.0000")
            {
                throw new Exception("This is a non standard limit policy.");
            }
            else
            {
                if (Lim1 == "0.0000")
                {
                    return String.Format("{0:C}", Decimal.Parse(Lim2.Replace(".0000", ""))).Replace(".00", "");
                }
                else if (Lim2 == "0.0000")
                {
                    return String.Format("{0:C}", Decimal.Parse(Lim1.Replace(".0000", ""))).Replace(".00", "");
                }
                else
                {
                    return String.Format("{0:C}", Decimal.Parse(Lim1.Replace(".0000", ""))).Replace(".00", "") + "/" + String.Format("{0:C}", Decimal.Parse(Lim2.Replace(".0000", ""))).Replace(".00", "");
                }
            }
        }

        private void GetPolicyFromPPS(string txtPolicyNo)
        {
            NAMECONVENTION = DateTime.Now.ToString("MM.dd.yyyy_hhmmss");

            Session.Clear();
            //Customer.Customer customer = (Customer.Customer)Session["Customer"];
            TaskControl.DoubleInterest taskControl = new TaskControl.DoubleInterest(true);

            XmlDocument XmlDoc = new XmlDocument();

            if (!(HttpContext.Current.Request.Url.ToString().Contains("localhost")))
            {
                System.Data.SqlClient.SqlConnection cn = new System.Data.SqlClient.SqlConnection();

                cn.ConnectionString = @"Data Source=gic-msql\ppssqlserver;Initial Catalog=GICPPSDATA;User ID=urclaims;password=3G@TD@t!1";
                cn.Open();

                SqlCommand cmd = new SqlCommand();
                cmd.Connection = cn;
                cmd.CommandType = CommandType.Text;
                cmd.CommandText = "exec sproc_GetPPSPolicyXML " +
                    "@LossDate= '" + String.Empty + "', " +
                    "@Plate='" + String.Empty + "', " +
                    "@VIN='" + String.Empty + "'," +
                    "@PolicyID= '" + txtPolicyNo.ToString().Trim() + "', @xmldata=@xmldata output";
                cmd.CommandTimeout = 0;
                cmd.Parameters.Clear();
                cmd.Parameters.Add("@xmldata", SqlDbType.Xml).Direction = ParameterDirection.Output;

                int c = cmd.ExecuteNonQuery();
                string f = cmd.Parameters[0].Value.ToString();

                if (f.Trim() == "")
                {
                    cn.Close();
                    throw new Exception("Policy not found in PPS");
                }

                XmlDoc.LoadXml(f);

                XmlDoc.Save(System.Configuration.ConfigurationManager.AppSettings["XMLPathName"] + "RenewalXml\\" + NAMECONVENTION + "RenewalPPS" + ".xml");
                Current_XML = f;
                cn.Close();

            }
            else
            {
                XmlDoc.Load("C:\\inetpub\\wwwroot\\12.07.2017_043840RenewalPPS.xml"); ////C:\\inetpub\\wwwroot\\ClaimNextPR\\Reports\\Xml2.xml");
                Current_XML = System.IO.File.ReadAllText("C:\\inetpub\\wwwroot\\12.07.2017_043840RenewalPPS.xml");
            }

            string CanDate = "";
            bool FilledName = false, FilledAddress = false, FilledAsl = false;

            #region Xml

            //XmlNodeList XmlBase = XmlDoc.GetElementsByTagName("Policy");

            //foreach (XmlNode XmlPolicyBase in XmlBase)
            //{
            //    taskControl.Mode = 1; //ADD
            //    taskControl.isQuote = true;

            //    taskControl.PolicyNo = XmlPolicyBase["PolicyID"].InnerText.Replace("PAP", "").Replace("BAP", "");



            //    taskControl.EffectiveDate = DateTime.Parse(XmlPolicyBase["Incept"].InnerText).ToShortDateString();
            //    taskControl.ExpirationDate = DateTime.Parse(XmlPolicyBase["Expire"].InnerText).ToShortDateString();

            //    PolicyNumber = XmlPolicyBase["PolicyID"].InnerText;
            //    txtPolicyNo = PolicyNumber;
            //    PolicyPrefix = PolicyNumber.Substring(0, 3);
            //    taskControl.PolicyType = PolicyNumber.Substring(0, 3);
            //    EffDate = DateTime.Parse(XmlPolicyBase["Incept"].InnerText).ToShortDateString();
            //    ExpDate = DateTime.Parse(XmlPolicyBase["Expire"].InnerText).ToShortDateString();

            //    if (XmlPolicyBase["CanDate"].InnerText != "")
            //        taskControl.CancellationDate = DateTime.Parse(XmlPolicyBase["CanDate"].InnerText).ToShortDateString();

            //    if (XmlPolicyBase.HasChildNodes)
            //    {
            //        //XmlNode Child = XmlPolicyBase.FirstChild;
            //        foreach (XmlNode Childs in XmlPolicyBase.ChildNodes)
            //        {
            //            if (Childs.Name == "PolRelTable")
            //            {
            //                foreach (XmlElement ChildsElement in Childs)
            //                {
            //                    if (ChildsElement.HasChildNodes)
            //                    {
            //                        foreach (XmlElement GrandChildElements in ChildsElement)
            //                        {
            //                            if (GrandChildElements.Name == "EntNamesTable")
            //                            {
            //                                foreach (XmlElement GreatGrandElements in GrandChildElements)
            //                                {
            //                                    if (!(FilledName))  //Solo leerá los campos una vez, tomando los primeros que lea
            //                                    {
            //                                        taskControl.Customer.FirstName = GreatGrandElements["FirstName"].InnerText;
            //                                        taskControl.Customer.Initial = GreatGrandElements["Middle"].InnerText == "" ? "" : GreatGrandElements["Middle"].InnerText;
            //                                        taskControl.Customer.LastName1 = GreatGrandElements["LastName"].InnerText;
            //                                        //+
            //                                        //((GreatGrandElements["Middle"].InnerText != "") ? " " + GreatGrandElements["Middle"].InnerText : "") + " " +
            //                                        //GreatGrandElements["LastName"].InnerText

            //                                        taskControl.Customer.Birthday = DateTime.Parse(GreatGrandElements["Dob"].InnerText).ToShortDateString();

            //                                        if (GrandChildElements["Sex"] != null)
            //                                        {
            //                                            taskControl.Customer.Sex = GrandChildElements["Sex"].InnerText == null ? "" : GrandChildElements["Sex"].InnerText;
            //                                        }

            //                                        if (GrandChildElements["Marital"] != null)
            //                                        {
            //                                            taskControl.Customer.MaritalStatus = GrandChildElements["Marital"].InnerText == "S" ? 1 : 2;
            //                                        }
            //                                        if (GrandChildElements["License"] != null)
            //                                        {
            //                                            taskControl.Customer.Licence = GreatGrandElements["License"].InnerText;
            //                                        }
            //                                        //taskControl.Customer.State = GreatGrandElements["State"].InnerText;

            //                                        InsuredName = taskControl.Customer.FirstName;
            //                                        InsuredState = taskControl.Customer.State;
            //                                        FilledName = true;
            //                                    }
            //                                }
            //                            }
            //                        }
            //                    }
            //                }
            //            }
            //            else if (Childs.Name == "VehicleTable")
            //            {
            //                foreach (XmlElement ChildsElement in Childs)
            //                {
            //                    //if ((ChildsElement["LicPlate"].InnerText == txtPlateVerification.Text.Trim().ToUpper()) ||
            //                    //    (ChildsElement["Vin"].InnerText == txtVINVerification.Text.Trim().ToUpper()))
            //                    //{
            //                    //txtVINVerification.Text 
            //                    InsuredVin = ChildsElement["Vin"].InnerText;
            //                    //txtPlateVerification.Text 
            //                    InsuredPlate = ChildsElement["LicPlate"].InnerText;

            //                    //txtVIN.Text = txtVINVerification.Text.Trim();
            //                    //txtPlate.Text = txtPlateVerification.Text.Trim().ToUpper();

            //                    InsuredVin = "";//txtVINVerification.Text;
            //                    InsuredPlate = "";//txtPlateVerification.Text;

            //                    if (ChildsElement.HasChildNodes)
            //                    {
            //                        foreach (XmlElement GrandChilds in ChildsElement)
            //                        {
            //                            if (GrandChilds.Name == "PhysVehicleTable")
            //                            {
            //                                foreach (XmlElement GrandChildsElements in GrandChilds)
            //                                {
            //                                    //ddlVehicleMake.SelectedIndex = ddlVehicleMake.Items.IndexOf(ddlVehicleMake.Items.FindByText((GrandChildsElements["Make"].InnerText.Trim()).ToString()));

            //                                    //if (ddlVehicleMake.SelectedItem.Value != "")
            //                                    //{
            //                                    //if (int.Parse(ddlVehicleMake.SelectedItem.Value) > 0)
            //                                    //FillModelDDListByPPS(ddlVehicleMake.SelectedItem.Value.ToString());
            //                                    //}

            //                                    //ddlVehicleModel.SelectedIndex = ddlVehicleModel.Items.IndexOf(ddlVehicleModel.Items.FindByText((GrandChildsElements["Model"].InnerText.TrimEnd()).ToString()));
            //                                    //ddlVehicleYear.SelectedIndex = ddlVehicleYear.Items.IndexOf(ddlVehicleYear.Items.FindByText((GrandChildsElements["MYear"].InnerText.TrimEnd()).ToString())); 
            //                                    ///ddlBroker.Items.IndexOf(ddlBroker.Items.FindByValue(int.Parse(XmlPolicyBase["BrokerID"].InnerText).ToString()));                                                                
            //                                }
            //                            }
            //                            else if (GrandChilds.Name == "VehicleCvrgTable")
            //                            {
            //                                foreach (XmlElement GrandChildsElements in GrandChilds)
            //                                {
            //                                    if (!(FilledAsl))  //Solo leerá los campos una vez, tomando los primeros que lea
            //                                    {
            //                                        ReinsAsl = GrandChildsElements["ReinsAsl"].InnerText.ToString();

            //                                        //GetCoverage();

            //                                        FilledAsl = true;
            //                                    }
            //                                }
            //                            }
            //                        }
            //                    }
            //                    // }
            //                }
            //            }

            //            else if (Childs.Name == "ClientTable")
            //            {
            //                foreach (XmlElement ChildsElement in Childs)
            //                {
            //                    if (!(FilledAddress))   //Solo leerá los campos una vez, tomando los primeros que lea
            //                    {
            //                        taskControl.Customer.Address1 = ChildsElement["Maddr1"].InnerText;
            //                        taskControl.Customer.Address2 = ChildsElement["Maddr2"].InnerText;

            //                        taskControl.Customer.City = ChildsElement["Mcity"].InnerText; //txtInsuredCity.Text =
            //                        taskControl.Customer.State = ChildsElement["Mstate"].InnerText;
            //                        taskControl.Customer.ZipCode = ChildsElement["Mzip"].InnerText;

            //                        taskControl.Customer.AddressPhysical1 = ChildsElement["Raddr1"].InnerText;
            //                        taskControl.Customer.AddressPhysical2 = ChildsElement["Raddr2"].InnerText;

            //                        taskControl.Customer.CityPhysical = ChildsElement["Rcity"].InnerText; //txtInsuredCity.Text =
            //                        taskControl.Customer.StatePhysical = ChildsElement["Rstate"].InnerText;
            //                        taskControl.Customer.ZipPhysical = ChildsElement["Rzip"].InnerText;

            //                        taskControl.Customer.JobPhone = ChildsElement["Wphone"].InnerText;
            //                        taskControl.Customer.Cellular = ChildsElement["Cphone"].InnerText;

            //                        InsuredAddress1 = "";// txtInsuredAddrs1.Text;
            //                        InsuredAddress2 = "";// txtAddrs2.Text;
            //                        InsuredZip = "";// txtZipCode.Text;
            //                        InsuredWorkPhone = "";//txtWorkPhone.Text;
            //                        InsuredCellular = "";// txtCellular.Text;

            //                        FilledAddress = true;
            //                    }
            //                }
            //            }
            //        }
            //    }
            //    ///Todas las variables Insured mencionadas existen así para la ocasión en que llame el reclamante
            //    ///La información del asegurado no se pierda, si no que siga hacia adelante en el proceso. 
            //    lblRecHeader.Text = "Policy loaded successfully";
            //    mpeSeleccion.Show();
            //}
            #endregion

        }

        protected void btnAceptar_Click(object sender, EventArgs e)
        {
            if (lblRecHeader.Text == "This user does not have a default Agent.")
            {
                Response.Redirect("Search.aspx");
            }

        }

        protected void FillTextControl()
        {
            try
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                LblControlNo.Text = taskControl.TaskControlID.ToString().Trim();

                if (taskControl.RenewalNo != "")
                {
                    RenewalNo = taskControl.RenewalNo;

                    TxtRenewalNo.Text = RenewalNo;
                    if (taskControl.CustomerCollection == "1")
                    {
                        txtTotalPremiumVehicle.Text = taskControl.TotalPremium.ToString().Trim();
                    }
                }



                //if (txtdumybox.Text != "")
                // FillProperties();

                TxtBILimitpp.Items.Clear();
                ddlCompCollDed.Items.Clear();

                //Default Limits
                if (chkIsBusinessAutoQuote.Checked)
                {
                    TxtBILimitpp.Items.Add(new ListItem("$10,000/$25,000", "$10,000/$25,000"));
                    ddlCompCollDed.Items.Add(new ListItem("$250/$500", "$250/$500"));
                    radGenTons.Visible = false;
                    Label23.Visible = false;
                    radHeavyTruck.Visible = false;
                    lblHeavyTruck.Visible = false;

                    if (Session["RenewalXML"] != null)
                    {
                        if (Session["RenewalXML"] != "true")
                        {
                            chkIsBusinessAutoQuote_CheckedChanged(String.Empty, EventArgs.Empty);
                        }
                    }
                }
                else
                {
                    TxtBILimitpp.Items.Add(new ListItem("$10,000/$20,000", "$10,000/$20,000"));
                    ddlCompCollDed.Items.Add(new ListItem("$250/$500", "$250/$500"));
                    radGenTons.Visible = false;
                    Label23.Visible = false;
                    radHeavyTruck.Visible = false;
                    lblHeavyTruck.Visible = false;

                    if (Session["RenewalXML"] != null)
                    {
                        if (Session["RenewalXML"] != "true")
                        {
                            chkIsBusinessAutoQuote_CheckedChanged(String.Empty, EventArgs.Empty);
                        }
                    }
                }


                EPolicy.Login.Login cp = HttpContext.Current.User as EPolicy.Login.Login;
                int userID = int.Parse(cp.Identity.Name.Split("|".ToCharArray())[1]);
                Login.Login login = new Login.Login();


                taskControl.OriginatedAt = EPolicy.Login.Login.GetLocationByUserID(userID);

                if (taskControl.OriginatedAt != 0)
                    ddlOriginatedAt.SelectedIndex = ddlOriginatedAt.Items.IndexOf(
                        ddlOriginatedAt.Items.FindByValue(taskControl.OriginatedAt.ToString()));

                if (taskControl.InsuranceCompany != "0")
                    ddlInsuranceCompany.SelectedIndex = ddlInsuranceCompany.Items.IndexOf(
                        ddlInsuranceCompany.Items.FindByValue(taskControl.InsuranceCompany.ToString()));

                if (cp.IsInRole("ADMINISTRATOR") || cp.IsInRole("AUTO VI ADMINISTRATOR"))
                {
                    if (taskControl.Agent.Trim() != "000" && taskControl.Agent.Trim() != "")
                    {
                        ddlAgent.SelectedIndex = ddlAgent.Items.IndexOf(
                            ddlAgent.Items.FindByValue(taskControl.Agent.Trim()));

                        ddlCompanyDealer.SelectedIndex = ddlCompanyDealer.Items.IndexOf(
                           ddlCompanyDealer.Items.FindByValue(taskControl.CompanyDealer.Trim()));

                        ddlTerms.SelectedIndex = ddlTerms.Items.IndexOf(
                        ddlTerms.Items.FindByValue(taskControl.Terms.Trim()));
                    }
                    else
                    {
                        ddlAgent.SelectedIndex = ddlAgent.Items.IndexOf(
                            ddlAgent.Items.FindByValue("000"));

                        ddlCompanyDealer.SelectedIndex = ddlCompanyDealer.Items.IndexOf(ddlCompanyDealer.Items.FindByValue("000"));

                        ddlTerms.SelectedIndex = ddlTerms.Items.IndexOf(
                 ddlTerms.Items.FindByValue("1"));
                    }

                }
                else if (cp.IsInRole("AUTO VI AGENCY"))
                {
                    DataTable dtAgent = null;

                    DataTable DtAgentVI = null;

                    DtAgentVI = Login.Login.GetGroupAgentVIByUserID(cp.UserID);

                    //string Agent = "000";



                    if (DtAgentVI.Rows.Count > 0)
                    {
                        //ddlAgent.Items.Clear();
                        //Agent
                        ddlAgent.DataSource = DtAgentVI;
                        ddlAgent.DataTextField = "AgentDesc";
                        ddlAgent.DataValueField = "AgentID";
                        ddlAgent.DataBind();
                        ddlAgent.SelectedIndex = -1;
                        ddlAgent.Items.Insert(0, "");

                        if (taskControl.Agent.Trim() != "000" && taskControl.Agent.Trim() != "")
                        {
                            //ddlAgent.Items.FindByValue(taskControl.Agent.Trim()).Selected = true;

                            ddlAgent.SelectedIndex = ddlAgent.Items.IndexOf(
                                ddlAgent.Items.FindByValue(taskControl.Agent.Trim()));

                            ddlCompanyDealer.SelectedIndex = ddlCompanyDealer.Items.IndexOf(
                        ddlCompanyDealer.Items.FindByValue(taskControl.CompanyDealer.Trim()));

                            ddlTerms.SelectedIndex = ddlTerms.Items.IndexOf(
                   ddlTerms.Items.FindByValue(taskControl.Terms.Trim()));
                        }
                        //else if (taskControl.Agent.Trim() == "000" && taskControl.Mode == 1)//|| taskControl.Agent.Trim() == "")
                        //{
                        //    ddlAgent.SelectedIndex = 1;
                        //    ddlAgent.SelectedIndex = ddlAgent.Items.IndexOf(
                        //        ddlAgent.Items.FindByValue(ddlAgent.SelectedItem.Value));
                        //}
                        else
                        {
                            ddlAgent.SelectedIndex = ddlAgent.Items.IndexOf(
                                ddlAgent.Items.FindByValue("000"));

                            ddlCompanyDealer.SelectedIndex = ddlCompanyDealer.Items.IndexOf(
                           ddlCompanyDealer.Items.FindByValue("000"));


                            ddlTerms.SelectedIndex = ddlTerms.Items.IndexOf(
                            ddlTerms.Items.FindByValue("1"));
                        }

                        //Agent = DtAgentVI.Rows[0]["AgentID"].ToString();

                        //taskControl.Agent = Agent.Trim();
                    }
                    else
                    {
                        //Agent
                        if (ddlAgent.SelectedIndex > 0 && ddlAgent.SelectedItem != null)
                            taskControl.Agent = ddlAgent.SelectedItem.Value;
                        else
                            taskControl.Agent = "000";

                        if (ddlCompanyDealer.SelectedIndex > 0 && ddlCompanyDealer.SelectedItem != null)
                            taskControl.CompanyDealer = ddlCompanyDealer.SelectedItem.Value;
                        else
                            taskControl.CompanyDealer = "000";

                        if (ddlTerms.SelectedIndex > 0 && ddlTerms.SelectedItem != null)
                            taskControl.Terms = ddlTerms.SelectedItem.Value;
                        else
                            taskControl.Terms = "000";
                    }


                }
                else
                {
                    DataTable dtAgentByUserID = GetAgentByUserID(cp.UserID.ToString());
                    string Agent = "000";

                    if (dtAgentByUserID.Rows.Count > 0)
                    {
                        Agent = dtAgentByUserID.Rows[0]["Agent"].ToString();
                    }

                    if (taskControl.Agent.Trim() != "000" && taskControl.Agent.Trim() != "")
                    {
                        ddlAgent.SelectedIndex = ddlAgent.Items.IndexOf(
                            ddlAgent.Items.FindByValue(taskControl.Agent.Trim()));
                    }
                    else
                    {
                        ddlAgent.SelectedIndex = ddlAgent.Items.IndexOf(
                            ddlAgent.Items.FindByValue(Agent.Trim()));
                    }
                }

                if (ddlAgent.SelectedItem.Text.Trim().Length > 40)//"BEACON INSURANCE AGENCY LLC ".Length)
                {
                    ddlAgent.Width = 500;
                }
                else if (ddlAgent.SelectedItem.Text.Trim().Length >= 30 && ddlAgent.SelectedItem.Text.Trim().Length < 50)
                {
                    ddlAgent.Width = 400;
                }
                else
                {
                    ddlAgent.Width = 300;
                }

                if (taskControl.Agency != "000")
                    ddlAgency.SelectedIndex = ddlAgency.Items.IndexOf(
                        ddlAgency.Items.FindByValue(taskControl.Agency));

                if (taskControl.Bank != "000")
                    ddlBankList.SelectedIndex = ddlBankList.Items.IndexOf(
                        ddlBankList.Items.FindByValue(taskControl.Bank));

                txtGrossTax.Text = taskControl.GrossTax.ToString();

                //Client Information

                TxtFirstName.Text = taskControl.Customer.FirstName;
                TxtLastName.Text = taskControl.Customer.LastName1;
                TxtLastName2.Text = taskControl.Customer.LastName2;
                chkNamedInsured.Checked = taskControl.UseCompanyAsNamedInsured;
                TxtInitial.Text = taskControl.Customer.Initial;

                string Sex = "";

                if (taskControl.Customer.Sex == "F" || taskControl.Customer.Sex == "Female")
                {
                    Sex = "Female";
                }
                else if (taskControl.Customer.Sex == "M" || taskControl.Customer.Sex == "Male" || taskControl.Customer.Sex == "")
                {
                    Sex = "Male";
                }
                else
                {
                    Sex = "UNDEFINED (BUSINESS ONLY)";
                }

                //if(!chkIsBusinessAutoQuote.Checked)
                ddlGender.SelectedIndex = int.Parse(ddlGender.Items.IndexOf(ddlGender.Items.FindByText(Sex)).ToString().Trim());
                // else
                //    ddlGender.SelectedIndex = int.Parse(ddlGender.Items.IndexOf(ddlGender.Items.FindByText(Sex)).ToString().Trim());

                TxtAddress.Text = taskControl.Customer.Address1;
                TxtAddress2.Text = taskControl.Customer.Address2;
                TxtCity.Text = taskControl.Customer.City;
                TxtState.Text = taskControl.Customer.State;
                TxtZIPCode.Text = taskControl.Customer.ZipCode;

                txtPhyAddress.Text = taskControl.Customer.AddressPhysical1;
                txtPhyAddress2.Text = taskControl.Customer.AddressPhysical2;
                txtPhyCity.Text = taskControl.Customer.CityPhysical;
                txtPhyState.Text = taskControl.Customer.StatePhysical;
                txtPhyZipCode.Text = taskControl.Customer.ZipPhysical;

                TxtLicenseNumber.Text = taskControl.Customer.Licence;
                ddlMaritalStatus.SelectedIndex = int.Parse(ddlMaritalStatus.Items.IndexOf(ddlMaritalStatus.Items.FindByValue(taskControl.Customer.MaritalStatus.ToString())).ToString());
                TxtBirthDate.Text = taskControl.Customer.Birthday;
                TxtAge.Text = taskControl.Customer.Age;
                if (TxtAge.Text == "16" || TxtAge.Text == "17")
                {
                    TxtBirthDate_TextChanged(String.Empty, EventArgs.Empty);
                }
                else
                {
                    TxtBirthDate_TextChanged(String.Empty, EventArgs.Empty);
                }

                TxtWorkPhone.Text = taskControl.Customer.JobPhone;
                TxtCellPhone.Text = taskControl.Customer.Cellular;
                TxtHomePhone.Text = taskControl.Customer.HomePhone;
                txtEmailAddress.Text = taskControl.Customer.Email;

                if (taskControl.Customer.Description.ToString().Trim() != "")
                {
                    ClientIDPPS = taskControl.Customer.Description.ToString().Trim();
                }

                ddlOccupation.SelectedIndex = int.Parse(ddlOccupation.Items.IndexOf(ddlOccupation.Items.FindByValue(taskControl.Customer.OccupationID.ToString())).ToString());
                TxtOtherOccupation.Text = taskControl.Customer.Occupation.ToString().Trim();

                TxtEmployerName.Text = taskControl.Customer.EmplName;
                ddlDiscounts.SelectedIndex = int.Parse(ddlDiscounts.Items.IndexOf(ddlDiscounts.Items.FindByValue(taskControl.TotalDiscountsPct.ToString() + "%")).ToString());

                chkSameMailing.Checked = bool.Parse(taskControl.Customer.SamesAsMail.ToString());

                //Policy Information
                if (taskControl.PolicyNo.ToString().Trim().Contains("-"))
                    TxtBinderNo.Text = taskControl.PolicyNo.ToString().Trim().Substring(0, taskControl.PolicyNo.ToString().Trim().IndexOf("-")).Replace("-", "");
                else
                    TxtBinderNo.Text = taskControl.PolicyNo.ToString().Trim();
                string BinderRenewal = taskControl.RenewalNo.ToString().Trim().Replace("BAP", "").Replace("PAP", "");
                string SuffixRenewal = "";
                if (BinderRenewal.Contains("-"))
                    BinderRenewal = BinderRenewal.Substring(0, BinderRenewal.IndexOf("-")).Replace("-", "");

                //if (taskControl.PolicyNo.ToString().Trim().Contains("-"))
                //{
                //    if (taskControl.PolicyNo.ToString().Trim().Substring(0, taskControl.PolicyNo.ToString().Trim().IndexOf("-")).ToString() == BinderRenewal.ToString())
                //    {
                //        SuffixRenewal = taskControl.PolicyNo.ToString().Trim().Substring(taskControl.PolicyNo.ToString().Trim().IndexOf("-")).Replace("-","");
                //    }
                //}
                TxtBinderNoRewnewal.Text = BinderRenewal;
                //txtPolicyType.Text = taskControl.PolicyType.ToString().Trim();

                chkIsBusinessAutoQuote.Checked = taskControl.isBusinessPolicy;

                if (TxtAge.Text.ToString().Trim() == "16" || TxtAge.Text.ToString().Trim() == "17")
                {
                    if (taskControl.DriversCollection.Rows.Count > 0)
                    {
                        txtPrimGrade.Text = taskControl.DriversCollection.Rows[0]["GradePointAvg"].ToString();
                    }
                }

                if (chkIsBusinessAutoQuote.Checked)
                {
                    txtPolicyType.Text = "BAP";
                    txtRenewalType.Text = "BAP";
                }
                else
                {
                    txtPolicyType.Text = "PAP";
                    txtRenewalType.Text = "PAP";
                }

                if (taskControl.RenewalNo.ToString() != "")
                {
                    txtSuffix.Text = DateTime.Parse(taskControl.EffectiveDate).Year.ToString().Substring(2);
                }
                else
                {
                    txtSuffix.Text = taskControl.Suffix.ToString().Trim();
                }

                if (taskControl.Suffix.ToString().Trim() != "00" && taskControl.RenewalNo.ToString() != "")
                {
                    SuffixRenewal = (int.Parse(DateTime.Parse(taskControl.EffectiveDate).Year.ToString().Substring(2)) - 1).ToString();//(int.Parse(taskControl.Suffix.ToString().Trim()) - 1).ToString();
                }
                if (SuffixRenewal.ToString() != "")
                    TxtSuffixRenewal.Text = SuffixRenewal;
                else
                    TxtSuffixRenewal.Text = taskControl.Suffix.ToString().Trim();

                if (taskControl.RenewalNo != "")
                {
                    lblQuoteType.Text = "RENEWAL";
                }
                else
                {
                    lblQuoteType.Text = "NEW BUSINESS";
                }

                if (taskControl.PolicyClaim.ToString().Trim() == "Yes")
                {
                    radGenPolicyClaimYes.Checked = true;
                    radGenPolicyClaimNo.Checked = false;
                    //chkAnyAccident.Checked = true; //radGenPolicyClaim.SelectedValue = "0";
                }
                else
                {
                    radGenPolicyClaimYes.Checked = false;
                    radGenPolicyClaimNo.Checked = true;
                    // chkAnyAccident.Checked = false; //radGenPolicyClaim.SelectedValue = "1";
                }

                TxtRenewalNo.Text = taskControl.RenewalNo;
                TxtEffBinderDate.Text = String.Format("{0:MM/dd/yyyy}", DateTime.Parse(taskControl.EffectiveDate));
                TxtExpBinderDate.Text = String.Format("{0:MM/dd/yyyy}", DateTime.Parse(taskControl.EffectiveDate).AddYears(int.Parse(taskControl.Terms == "" ? "1" : taskControl.Terms)));
                TxtCustomerCollection.Text = taskControl.CustomerCollection;
                txtDiscountPct.Text = taskControl.TotalDiscountsPct.ToString();
                txtTotalDiscount.Text = taskControl.TotalDiscounts.ToString();

                txtAffinityDiscountPct.Text = taskControl.AffinityDiscountPct.ToString();
                txtAffinityDiscount.Text = taskControl.AffinityDiscount.ToString();

                if (taskControl.AffinityDiscountPct.ToString() != "0")
                {
                    radAffinityDiscountYes.Checked = true;
                    radAffinityDiscountNo.Checked = false;
                }
                else
                {
                    radAffinityDiscountYes.Checked = false;
                    radAffinityDiscountNo.Checked = true;
                }

                if (taskControl.AnyAccidentsOrLosses)
                {
                    rdbAnyAccidentsYes.Checked = true;
                    rdbAnyAccidentsNo.Checked = false;
                }
                else
                {
                    rdbAnyAccidentsYes.Checked = false;
                    rdbAnyAccidentsNo.Checked = true;

                    //JNF VISIBLE TRUE THIS ONLY********

                    //lblHowManyYears.Visible = true;
                    //rdb1Year.Visible = true;
                    //rdb2Year.Visible = true;
                    //rdb3Year.Visible = true;
                }

                if (taskControl.IsNewCustomer)
                {
                    rdbNewCustomerYes.Checked = true;
                    rdbNewCustomerNo.Checked = false;
                }
                else
                {
                    rdbNewCustomerYes.Checked = false;
                    rdbNewCustomerNo.Checked = true;
                }

                if (taskControl.YearsWithNoClaims.ToString() == "1")
                {
                    rdb1Year.Checked = true;
                    rdb2Year.Checked = false;
                    rdb3Year.Checked = false;

                    if (taskControl.AnyAccidentsOrLosses)
                    {
                        ddlDiscounts.SelectedItem.Text = "N/A";
                        ddlDiscounts.SelectedItem.Value = "N/A";
                    }
                    else
                    {
                        ddlDiscounts.SelectedItem.Text = "10%";
                        ddlDiscounts.SelectedItem.Value = "10%";
                    }

                    //Yes
                    if (taskControl.IsNewCustomer)
                    {
                        //ddlDiscounts.SelectedItem.Text = "N/A";
                        //ddlDiscounts.SelectedItem.Value = "N/A";
                    }
                    else
                    {
                        //ddlDiscounts.SelectedItem.Text = "30%";
                        //ddlDiscounts.SelectedItem.Value = "30%";
                    }

                    CalculatePremium();
                }
                else if (taskControl.YearsWithNoClaims.ToString() == "2")
                {
                    rdb1Year.Checked = false;
                    rdb2Year.Checked = true;
                    rdb3Year.Checked = false;

                    if (taskControl.AnyAccidentsOrLosses)
                    {
                        ddlDiscounts.SelectedItem.Text = "N/A";
                        ddlDiscounts.SelectedItem.Value = "N/A";
                    }
                    else
                    {
                        ddlDiscounts.SelectedItem.Text = "20%";
                        ddlDiscounts.SelectedItem.Value = "20%";
                    }

                    //Yes
                    if (taskControl.IsNewCustomer)
                    {
                        //ddlDiscounts.SelectedItem.Text = "N/A";
                        //ddlDiscounts.SelectedItem.Value = "N/A";
                    }
                    else
                    {
                        //ddlDiscounts.SelectedItem.Text = "30%";
                        //ddlDiscounts.SelectedItem.Value = "30%";
                    }

                    CalculatePremium();
                }
                else
                {
                    rdb1Year.Checked = false;
                    rdb2Year.Checked = false;
                    rdb3Year.Checked = true;

                    if (taskControl.AnyAccidentsOrLosses)
                    {
                        ddlDiscounts.SelectedItem.Text = "N/A";
                        ddlDiscounts.SelectedItem.Value = "N/A";
                    }
                    else
                    {
                        ddlDiscounts.SelectedItem.Text = "30%";
                        ddlDiscounts.SelectedItem.Value = "30%";
                    }

                    //Yes
                    if (taskControl.IsNewCustomer)
                    {
                        //ddlDiscounts.SelectedItem.Text = "N/A";
                        //ddlDiscounts.SelectedItem.Value = "N/A";
                    }
                    else
                    {
                        //ddlDiscounts.SelectedItem.Text = "30%";
                        //ddlDiscounts.SelectedItem.Value = "30%";
                    }

                    CalculatePremium();
                }

                if (taskControl.AnyDriverUnder26)
                {
                    HideDriverSection("true");
                    rdbAnyDriverYes.Checked = true;
                    rdbAnyDriverNo.Checked = false;
                }
                else
                {
                    HideDriverSection("false");
                    rdbAnyDriverYes.Checked = false;
                    rdbAnyDriverNo.Checked = true;
                }

                if (taskControl.Q1)
                {
                    rdbQ1Yes.Checked = true;
                    rdbQ1No.Checked = false;
                }
                else
                {
                    rdbQ1Yes.Checked = false;
                    rdbQ1No.Checked = true;
                }

                if (taskControl.Q2)
                {
                    rdbQ2Yes.Checked = true;
                    rdbQ2No.Checked = false;
                }
                else
                {
                    rdbQ2Yes.Checked = false;
                    rdbQ2No.Checked = true;
                }

                if (taskControl.Q3)
                {
                    rdbQ3Yes.Checked = true;
                    rdbQ3No.Checked = false;
                }
                else
                {
                    rdbQ3Yes.Checked = false;
                    rdbQ3No.Checked = true;
                }

                FillDriverDetailGrid();
                FillVehicleDetailGrid();
                FillGridBreakDown();

                if (TxtState.Text.Trim() == "")// || TxtState.Text.Trim() == "PR")
                    TxtState.Text = "VI";

                if (TxtCity.Text.Trim() == "")
                    TxtCity.Text = "St. Thomas";

                if (TxtZIPCode.Text.Trim() == "")
                    TxtZIPCode.Text = "";

                if (txtPhyState.Text.Trim() == "" || txtPhyState.Text.Trim() == "PR")
                    txtPhyState.Text = "VI";

                if (txtPhyCity.Text.Trim() == "")
                    txtPhyCity.Text = "St. Thomas";

                if (txtPhyZipCode.Text.Trim() == "")
                    txtPhyZipCode.Text = "";

                EnableDisableBusinessAuto();

                //BUTTONS VI
                DataTable dtMode_VI = GetPolicyMode_VI(taskControl.TaskControlID);
                string Mode_VI = "0";

                if (dtMode_VI.Rows.Count > 0)
                {
                    Mode_VI = dtMode_VI.Rows[0]["Optional1"].ToString();

                }

                switch (Mode_VI)
                {
                    case "1": // QUOTE
                        btnAcceptQuote.Visible = true;
                        btnAcceptQuote2.Visible = true;
                        btnSaveApp.Visible = false;
                        btnSaveApp2.Visible = false;
                        btnQuote.Visible = true;
                        btnQuote2.Visible = true;
                        btnIssuePolicy.Visible = false;
                        btnIssuePolicy2.Visible = false;
                        btnSavePolicy.Visible = false;
                        btnSavePolicy2.Visible = false;
                        btnPrintAppForms.Visible = false;
                        btnPrintAppForms2.Visible = false;
                        btnQA.Visible = false;
                        btnQA2.Visible = false;
                        QuoteHideControls(false, "1");
                        lblStatus.Text = "Quote";
                        BtnPrintPolicy.Visible = true;
                        BtnPrintPolicy2.Visible = true;
                        BtnPrintInvoice.Visible = false;
                        BtnPrintInvoice2.Visible = false;
                        BtnEdit.Text = "MODIFY QUOTE";
                        BtnEdit2.Text = "MODIFY QUOTE";

                        if (BtnEdit.Visible)
                        {
                            btnAcceptQuote.Visible = true;
                            btnAcceptQuote2.Visible = true;
                            BtnPrintPolicy.Visible = true;
                            BtnPrintPolicy2.Visible = true;
                            BtnPrintInvoice.Visible = false;
                            BtnPrintInvoice2.Visible = false;
                        }
                        else
                        {
                            btnAcceptQuote.Visible = true;
                            btnAcceptQuote2.Visible = true;
                            BtnPrintPolicy.Visible = false;
                            BtnPrintPolicy2.Visible = false;
                            BtnPrintInvoice.Visible = false;
                            BtnPrintInvoice2.Visible = false;
                        }

                        break;

                    case "2": // APPLICATION
                        btnAcceptQuote.Visible = false;
                        btnAcceptQuote2.Visible = false;
                        btnSaveApp.Visible = true;
                        btnSaveApp2.Visible = true;
                        btnQuote.Visible = false;
                        btnQuote2.Visible = false;
                        //btnIssuePolicy.Visible = true;
                        btnSavePolicy.Visible = false;
                        btnSavePolicy2.Visible = false;
                        btnPrintAppForms.Visible = true;
                        btnPrintAppForms2.Visible = true;
                        btnQA.Visible = false;
                        btnQA2.Visible = false;
                        QuoteHideControls(true, "2");
                        lblStatus.Text = "Application";
                        BtnPrintPolicy.Visible = false;
                        BtnPrintPolicy2.Visible = false;
                        BtnPrintInvoice.Visible = false;
                        BtnPrintInvoice2.Visible = false;
                        BtnEdit.Text = "MODIFY APPLICATION";
                        BtnEdit2.Text = "MODIFY APPLICATION";

                        if (taskControl.RenewalNo != "")
                        {
                            btnIssuePolicy.Text = "ISSUE RENEWAL";
                            btnIssuePolicy2.Text = "ISSUE RENEWAL";
                        }
                        else
                        {
                            btnIssuePolicy.Text = "ISSUE POLICY";
                            btnIssuePolicy2.Text = "ISSUE POLICY";
                        }

                        if (BtnEdit.Visible)
                        {
                            btnSaveApp.Visible = false;
                            btnSaveApp2.Visible = false;
                            btnPrintAppForms.Visible = true;
                            btnPrintAppForms2.Visible = true;
                            btnQA.Visible = false;
                            btnQA2.Visible = false;
                        }
                        else
                        {
                            btnSaveApp.Visible = true;
                            btnSaveApp2.Visible = true;
                            btnPrintAppForms.Visible = true;
                            btnPrintAppForms2.Visible = true;
                            btnQA.Visible = false;
                            btnQA2.Visible = false;
                        }

                        TxtEffBinderDate.Text = taskControl.EffectiveDateApp;
                        TxtExpBinderDate.Text = taskControl.ExpirationDateApp;

                        break;

                    case "3": // POLICY

                        btnAcceptQuote.Visible = false;
                        btnAcceptQuote2.Visible = false;
                        btnSaveApp.Visible = false;
                        btnSaveApp2.Visible = false;
                        btnQuote.Visible = false;
                        btnQuote2.Visible = false;
                        btnIssuePolicy.Visible = false;
                        btnIssuePolicy2.Visible = false;
                        btnPrintAppForms.Visible = false;
                        btnPrintAppForms2.Visible = false;
                        btnQA.Visible = false;
                        btnQA2.Visible = false;

                        btnSendPolicy.Visible = true;
                        btnSendPolicy2.Visible = true;
                        btnSavePolicy.Visible = true;
                        btnSavePolicy2.Visible = true;
                        QuoteHideControls(true, "3");
                        lblStatus.Text = "Policy";
                        BtnPrintPolicy.Visible = true;
                        BtnPrintPolicy2.Visible = true;
                        BtnPrintInvoice.Visible = true;
                        BtnPrintInvoice2.Visible = true;
                        BtnRePrintApp.Visible = true;
                        BtnRePrintApp2.Visible = true;
                        ddlPrintOption.Visible = true;
                        ddlPrintOption2.Visible = true;
                        //BtnPrintIDCards.Visible = true;
                        //BtnPrintIDCards2.Visible = true;

                        if (!taskControl.Status.ToString().Trim().Contains("Cancelled"))
                        {
                            btnCancellation.Visible = true;
                            btnCancellation2.Visible = true;

                            if (taskControl.ExpirationDate != null)
                            {
                                TimeSpan difference = DateTime.Parse(taskControl.ExpirationDate.ToString()) - DateTime.Today;//dateTime1 - dateTime2;
                                var days = difference.TotalDays;
                                if (difference.TotalDays <= 90)
                                {
                                    BtnRenew.Visible = true;
                                    BtnRenew2.Visible = true;
                                }
                            }
                        }
                        else
                        {
                            btnCancellation.Visible = false;
                            btnCancellation2.Visible = false;

                            BtnRenew.Visible = false;
                            BtnRenew2.Visible = false;
                        }

                        if (taskControl.CancellationDate != "")
                        {
                            //if (!taskControl.Status.ToString().Trim().Contains("Cancelled"))
                            //{
                            btnReinstallation.Visible = true;
                            btnReinstallation2.Visible = true;
                            //}
                            //else
                            //{
                            //    btnReinstallation.Visible = false;
                            //    btnReinstallation2.Visible = false;
                            //}
                        }

                        BtnEdit.Text = "MODIFY POLICY";
                        BtnEdit2.Text = "MODIFY POLICY";
                        VehicleReadOnlyModify();

                        //if (BtnEdit.Visible)
                        //{
                        //    BtnPrintPolicy.Visible = true;
                        //}
                        //else
                        //{
                        //    BtnPrintPolicy.Visible = false;
                        //}

                        break;

                    default:
                        btnAcceptQuote.Visible = false;
                        btnAcceptQuote2.Visible = false;
                        btnSaveApp.Visible = false;
                        btnSaveApp2.Visible = false;
                        btnQuote.Visible = true;
                        btnQuote2.Visible = true;
                        btnIssuePolicy.Visible = false;
                        btnIssuePolicy2.Visible = false;
                        btnSavePolicy.Visible = false;
                        btnSavePolicy2.Visible = false;
                        btnPrintAppForms.Visible = false;
                        btnPrintAppForms2.Visible = false;
                        btnQA.Visible = false;
                        btnQA2.Visible = false;
                        QuoteHideControls(false, "1");
                        BtnPrintPolicy.Visible = false;
                        BtnPrintPolicy2.Visible = false;
                        BtnPrintInvoice.Visible = false;
                        BtnPrintInvoice2.Visible = false;
                        lblStatus.Text = "Quote";
                        btnPrintAppForms.Visible = false;
                        btnPrintAppForms2.Visible = false;

                        break;

                }
            }
            catch (Exception exp)
            {
                throw new Exception("Could not fill Text Controls.", exp);
            }
        }

        protected void FillProperties()
        {
            try
            {
                //EPolicy.TaskControl.Dwelling taskControl = (EPolicy.TaskControl.Dwelling)Session["TaskControl"];
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                EPolicy.Login.Login cp = HttpContext.Current.User as EPolicy.Login.Login;
                int userID = int.Parse(cp.Identity.Name.Split("|".ToCharArray())[1]);

                taskControl.TaskControlID = int.Parse(LblControlNo.Text.Trim());

                if (cp.IsInRole("ADMINISTRATOR") || cp.IsInRole("AUTO VI ADMINISTRATOR") || cp.IsInRole("AUTO VI AGENCY"))
                {
                    if (ddlAgent.SelectedIndex > 0 && ddlAgent.SelectedItem != null)
                        taskControl.Agent = ddlAgent.SelectedItem.Value;
                    else
                        taskControl.Agent = "000";

                    if (ddlCompanyDealer.SelectedIndex > 0 && ddlCompanyDealer.SelectedItem != null)
                        taskControl.CompanyDealer = ddlCompanyDealer.SelectedItem.Value;
                    else
                        taskControl.CompanyDealer = "000";

                    if (ddlTerms.SelectedIndex > 0 && ddlTerms.SelectedItem != null)
                        taskControl.Terms = ddlTerms.SelectedItem.Value;
                    else
                        taskControl.Terms = "1";
                }
                else
                {

                    DataTable dtAgentByUserID = GetAgentByUserID(cp.UserID.ToString());
                    string Agent = "000";

                    if (dtAgentByUserID.Rows.Count > 0)
                    {
                        Agent = dtAgentByUserID.Rows[0]["Agent"].ToString();

                        taskControl.Agent = Agent.Trim();
                    }
                    else
                    {
                        //Agent
                        if (ddlAgent.SelectedIndex > 0 && ddlAgent.SelectedItem != null)
                            taskControl.Agent = ddlAgent.SelectedItem.Value;
                        else
                            taskControl.Agent = "000";
                    }
                }


                //Agency
                if (ddlAgency.SelectedIndex > 0 && ddlAgency.SelectedItem != null)
                    taskControl.Agency = ddlAgency.SelectedItem.Value;
                else
                    taskControl.Agency = "000";

                //Bank
                if (ddlBankList.SelectedIndex > 0 && ddlBankList.SelectedItem != null)
                    taskControl.Bank = ddlBankList.SelectedItem.Value;
                else
                    taskControl.Bank = "000";

                //InsuranceCompany
                if (ddlInsuranceCompany.SelectedIndex > 0 && ddlInsuranceCompany.SelectedItem != null)
                    taskControl.InsuranceCompany = ddlInsuranceCompany.SelectedItem.Value;
                else
                    taskControl.InsuranceCompany = "000";

                //Originated At
                if (ddlOriginatedAt.SelectedIndex > 0 && ddlOriginatedAt.SelectedItem != null)
                {
                    taskControl.OriginatedAt = int.Parse(ddlOriginatedAt.SelectedItem.Value.ToString());
                }

                taskControl.GrossTax = txtGrossTax.Text.Trim() == "" ? 0 : double.Parse(txtGrossTax.Text.ToString().Trim(), System.Globalization.NumberStyles.Currency);

                //Client Information
                taskControl.Customer.FirstName = TxtFirstName.Text.ToString().Trim().ToUpper();
                taskControl.Customer.LastName1 = TxtLastName.Text.ToString().Trim().ToUpper();
                taskControl.Customer.LastName2 = TxtLastName2.Text.ToString().Trim().ToUpper();
                taskControl.UseCompanyAsNamedInsured = chkNamedInsured.Checked;
                taskControl.Customer.Initial = TxtInitial.Text.ToString().Trim().ToUpper();
                taskControl.Customer.Sex = ddlGender.SelectedItem.Text.ToString().Trim();
                taskControl.Customer.Address1 = TxtAddress.Text.ToString().Trim().ToUpper();
                taskControl.Customer.Address2 = TxtAddress2.Text.ToString().Trim().ToUpper();
                taskControl.Customer.City = TxtCity.Text.ToString().Trim().ToUpper();
                taskControl.Customer.State = TxtState.Text.ToString().Trim().ToUpper();
                taskControl.Customer.ZipCode = TxtZIPCode.Text.ToString().Trim().ToUpper();

                taskControl.Customer.AddressPhysical1 = txtPhyAddress.Text.ToString().Trim().ToUpper();
                taskControl.Customer.AddressPhysical2 = txtPhyAddress2.Text.ToString().Trim().ToUpper();
                taskControl.Customer.CityPhysical = txtPhyCity.Text.ToString().Trim().ToUpper();
                taskControl.Customer.StatePhysical = txtPhyState.Text.ToString().Trim().ToUpper();
                taskControl.Customer.ZipPhysical = txtPhyZipCode.Text.ToString().Trim().ToUpper();

                taskControl.Customer.JobPhone = TxtWorkPhone.Text.ToString().Trim();
                taskControl.Customer.Cellular = TxtCellPhone.Text.ToString().Trim();
                taskControl.Customer.HomePhone = TxtHomePhone.Text.ToString().Trim();
                taskControl.Customer.Birthday = TxtBirthDate.Text.ToString().Trim();
                taskControl.Customer.Age = TxtAge.Text.ToString().Trim();
                taskControl.Customer.MaritalStatus = ddlMaritalStatus.SelectedIndex;
                taskControl.Customer.Licence = TxtLicenseNumber.Text.ToString().Trim().ToUpper();
                taskControl.Customer.OccupationID = ddlOccupation.SelectedIndex;
                taskControl.Customer.Occupation = TxtOtherOccupation.Text.ToString().Trim().ToUpper();
                taskControl.Customer.EmplName = TxtEmployerName.Text.ToString().Trim().ToUpper();
                taskControl.Customer.Email = txtEmailAddress.Text.ToString().Trim().ToUpper();

                taskControl.Customer.SamesAsMail = chkSameMailing.Checked;
                taskControl.Customer.LocationID = EPolicy.Login.Login.GetLocationByUserID(userID);

                if (ClientIDPPS != "")
                {
                    taskControl.Customer.Description = ClientIDPPS;
                }

                //taskControl.EffectiveDate = TxtEffBinderDate.Text.ToString();
                //taskControl.ExpirationDate = TxtExpBinderDate.Text.ToString();

                taskControl.Prospect.FirstName = TxtFirstName.Text.ToString().Trim().ToUpper();
                taskControl.Prospect.LastName1 = TxtLastName.Text.ToString().Trim().ToUpper();
                taskControl.Prospect.LastName2 = TxtLastName2.Text.ToString().Trim().ToUpper();
                taskControl.Prospect.HomePhone = TxtHomePhone.Text.ToString().Trim().ToUpper();
                taskControl.Prospect.WorkPhone = TxtWorkPhone.Text.ToString().Trim().ToUpper();
                taskControl.Prospect.Cellular = TxtCellPhone.Text.ToString().Trim().ToUpper();
                taskControl.Prospect.Email = txtEmailAddress.Text.ToString().Trim().ToUpper();

                //Policy Information
                taskControl.PolicyNo = TxtBinderNo.Text.ToString().Trim();

                if (radGenPolicyClaimYes.Checked)
                    taskControl.PolicyClaim = "Yes";
                else
                    taskControl.PolicyClaim = "No";

                //if(chkAnyAccident.Checked)
                //{
                //    taskControl.PolicyClaim = "Yes"; //radGenPolicyClaim.SelectedItem.Text;
                //}
                //else
                //{
                //    taskControl.PolicyClaim = "No"; //radGenPolicyClaim.SelectedItem.Text;
                //}

                taskControl.RenewalNo = TxtRenewalNo.Text.ToString().Trim();
                taskControl.CustomerCollection = TxtCustomerCollection.Text.ToString().Trim();
                taskControl.EffectiveDate = TxtEffBinderDate.Text.ToString().Trim();
                taskControl.ExpirationDate = TxtExpBinderDate.Text.ToString().Trim();
                taskControl.EffectiveDateApp = TxtEffBinderDate.Text.ToString().Trim();
                taskControl.ExpirationDateApp = TxtExpBinderDate.Text.ToString().Trim();
                taskControl.CustomerCollection = TxtCustomerCollection.Text.ToString().Trim();

                if (rdbAnyAccidentsYes.Checked)
                {
                    taskControl.AnyAccidentsOrLosses = true;
                }
                else
                {
                    taskControl.AnyAccidentsOrLosses = false;
                }

                if (rdbNewCustomerYes.Checked)
                {
                    taskControl.IsNewCustomer = true;
                }
                else
                {
                    taskControl.IsNewCustomer = false;
                }

                if (rdb1Year.Checked)
                {
                    taskControl.YearsWithNoClaims = "1";
                }
                else if (rdb2Year.Checked)
                {
                    taskControl.YearsWithNoClaims = "2";
                }
                else
                {
                    taskControl.YearsWithNoClaims = "3";
                }

                if (rdbAnyDriverYes.Checked)
                {
                    taskControl.AnyDriverUnder26 = true;
                }
                else
                {
                    taskControl.AnyDriverUnder26 = false;
                }

                if (rdbQ1Yes.Checked)
                {
                    taskControl.Q1 = true;
                }
                else
                {
                    taskControl.Q1 = false;
                }

                if (rdbQ2Yes.Checked)
                {
                    taskControl.Q2 = true;
                }
                else
                {
                    taskControl.Q2 = false;
                }

                if (rdbQ3Yes.Checked)
                {
                    taskControl.Q3 = true;
                }
                else
                {
                    taskControl.Q3 = false;
                }

                DateTime.Now.Month.ToString("00").Trim();
                //taskControl.TrafficViolationPoints = int.Parse(txtViolationPoints.Text.ToString().Trim());
                //taskControl.TrafficViolationSurcharge = double.Parse(txtViolationSurchargePct.Text.ToString().Trim());
                //taskControl.UnderageSurcharge = double.Parse(txtUnderageChargesPct.Text.ToString().Trim());
                taskControl.EnteredBy = cp.Identity.Name.Split("|".ToCharArray())[0].ToString();
                taskControl.isBusinessPolicy = chkIsBusinessAutoQuote.Checked;
                //taskControl.PolicyType = txtPolicyType.Text.ToString().Trim();

                if (chkIsBusinessAutoQuote.Checked)
                {
                    taskControl.PolicyType = "BAP";
                }
                else
                {
                    taskControl.PolicyType = "PAP";
                }

                taskControl.Suffix = txtSuffix.Text.ToString().Trim();

                //test purpose only
                taskControl.TotalPremium = double.Parse(txtTotalPremiumVehicle.Text.ToString().Trim().Replace("$", ""));
                taskControl.Charge = double.Parse(txtTotalCharges.Text.ToString().Trim());
                //taskControl.Terms = 


                //No va utilizar descuento hasta nuevo aviso
                if (!radGenPolicyClaimNo.Checked)//if(1 == 1)//if (ddlDiscounts.SelectedItem.Text == "N/A")
                {
                    taskControl.TotalDiscountsPct = 0.0;  //double.Parse(txtDiscountPct.Text.ToString().Replace("%", ""));
                }
                else
                {
                    taskControl.TotalDiscountsPct = double.Parse(txtDiscountPct.Text.ToString());  //double.Parse(txtDiscountPct.Text.ToString().Replace("%", ""));
                }
                taskControl.TotalDiscounts = double.Parse(txtTotalDiscount.Text.ToString());

                //Affinity Discount
                if (radAffinityDiscountYes.Checked)
                    taskControl.AffinityDiscountPct = double.Parse(txtAffinityDiscountPct.Text.ToString());
                else
                    taskControl.AffinityDiscountPct = 0.0;

                taskControl.AffinityDiscountPct = double.Parse(txtAffinityDiscountPct.Text.ToString());
                taskControl.AffinityDiscount = double.Parse(txtAffinityDiscount.Text.ToString());

                if (RenewalNo != "" && taskControl.TaskControlID != 0)
                {
                    if (RenewalPremium != "")
                    {
                        taskControl.TotalPremium = double.Parse(RenewalPremium);
                    }
                }
            }
            catch (Exception exp)
            {
                throw new Exception("Could not fill properties.", exp);
            }
        }

        private void PremiumInfoTotalsHideControls(bool visible)
        {
            Label78.Visible = visible;
            Label79.Visible = visible;
            Label67.Visible = visible;
            Label63.Visible = visible;
            Label64.Visible = visible;
            Label65.Visible = visible;
            Label68.Visible = visible;
            Label69.Visible = visible;
            Label83.Visible = visible;
            Label70.Visible = visible;
            Label88.Visible = visible;
            Label98.Visible = visible;
            Label89.Visible = visible;
            Label113.Visible = visible;

            txtComp.Visible = visible;
            txtCollision.Visible = visible;
            txtBIRate.Visible = visible;
            txtPDRate.Visible = visible;
            txtMPRate.Visible = visible;
            txtMotorist.Visible = visible;
            txtADD.Visible = visible;
            txtRentalReimbursment.Visible = visible;
            txtTaxiLossIncome.Visible = visible;
            txtTotalPremiumVehicle.Visible = visible;
            txtTotalCharges.Visible = visible;
            txtTotalDiscount.Visible = visible;
            txtGrandTotal.Visible = visible;

        }

        private void QuoteHideControls(bool hide, string Mode_VI)
        {
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
            EPolicy.Login.Login cp = HttpContext.Current.User as EPolicy.Login.Login;

            //TxtLicenseNumber.Visible = false;
            Label8.Visible = false;
            TxtHomePhone.Visible = false;
            Label11.Visible = false;
            ddlOccupation.Visible = false;
            Label9.Visible = false;
            TxtOtherOccupation.Visible = false;
            TxtEmployerName.Visible = false;
            Label10.Visible = false;

            //Policy Information
            lblPolicyNumber.Visible = false;
            TxtBinderNo.Visible = false;

            //Label33.Visible = false;
            //radGenPolicyClaim.Visible = false;
            Label33.Visible = true;
            radGenPolicyClaimYes.Visible = true;
            radGenPolicyClaimNo.Visible = true;

            Label32.Visible = false;
            TxtRenewalNo.Visible = false;
            Label43.Visible = false;
            Label59.Visible = false;
            ddlInsuranceCompany.Visible = false;
            Label58.Visible = false;
            ddlOriginatedAt.Visible = false;
            Label56.Visible = false;
            ddlAgency.Visible = false;

            //DriverSectionDiv.Visible = false;
            //DriverLine1.Attributes["class"] = "hidden";
            //DriverLine2.Attributes["class"] = "hidden";
            //DriverLine3.Attributes["class"] = "hidden";
            //DriverLine4.Attributes["class"] = "hidden";
            //DriverLine5.Attributes["class"] = "hidden";
            //DriverLine6.Attributes["class"] = "hidden";
            //DriverLine7.Attributes["class"] = "hidden";


            switch (Mode_VI)
            {
                case "1":
                    lblPolicyInformation.Text = "AGENT & COMPANY DEALER INFORMATION";
                    lblPolicyNumber.Visible = hide;
                    TxtBinderNo.Visible = hide;
                    txtPolicyType.Visible = hide;
                    txtSuffix.Visible = hide;
                    //Label99.Visible = hide;
                    //Label100.Visible = hide;

                    // Mailing Address & Physical Address
                    LblAddress.Visible = hide;
                    LblAddress0.Visible = hide;
                    LblAddress1.Visible = hide;
                    LblAddress2.Visible = hide;
                    LblAddress3.Visible = hide;
                    LblAddress4.Visible = hide;
                    Label14.Visible = hide;
                    Label55.Visible = hide;
                    Label15.Visible = hide;
                    Label85.Visible = hide;
                    Label87.Visible = hide;
                    Label86.Visible = hide;

                    TxtAddress.Visible = hide;
                    TxtAddress2.Visible = hide;
                    TxtCity.Visible = hide;
                    TxtState.Visible = hide;
                    TxtZIPCode.Visible = hide;
                    txtPhyAddress.Visible = hide;
                    txtPhyAddress2.Visible = hide;
                    txtPhyCity.Visible = hide;
                    txtPhyState.Visible = hide;
                    txtPhyZipCode.Visible = hide;

                    //ddlBankList.Visible = !hide;
                    //Label101.Visible = !hide;

                    Label90.Visible = hide;
                    Label91.Visible = hide;
                    Label93.Visible = hide;
                    txtViolationPoints.Visible = hide;
                    txtViolationSurchargePct.Visible = hide;
                    txtUnderageChargesPct.Visible = hide;

                    //if (cp.IsInRole("ADMINISTRATOR") || cp.IsInRole("AUTO VI ADMINISTRATOR"))
                    //{
                    DivAgentMiddle.Visible = false;
                    DivAgentMiddle2.Visible = true;
                    PolicySectionDiv.Visible = true;
                    lblEffDate.Visible = false;
                    TxtEffBinderDate.Visible = false;
                    lblExpDate.Visible = false;
                    imgEffDate.Visible = false;
                    TxtExpBinderDate.Visible = false;
                    txtPolicyType.Visible = false;
                    TxtBinderNo.Visible = false;
                    txtSuffix.Visible = false;
                    if (BtnEdit.Visible == true)
                    {
                        ddlAgent.Enabled = false;
                        ddlCompanyDealer.Enabled = false;
                    }
                    else
                    {
                        ddlAgent.Enabled = true;
                        ddlCompanyDealer.Enabled = true;
                    }


                    //}
                    //else
                    //{
                    //   // PolicySectionDiv.Visible = false;
                    //}

                    if (cp.IsInRole("AUTO VI AGENCY"))
                    {
                        if (BtnEdit.Visible == true)
                        {
                            ddlAgent.Enabled = false;
                            ddlCompanyDealer.Enabled = false;
                        }
                        else
                        {
                            ddlAgent.Enabled = true;
                            ddlCompanyDealer.Enabled = true;
                        }
                    }
                    //row1.Attributes["class"] = "hidden";
                    ////row2.Attributes["class"] = "hidden";
                    //row3.Attributes["class"] = "hidden";
                    //row4.Attributes["class"] = "hidden";
                    //row5.Attributes["class"] = "hidden";
                    //row6.Attributes["class"] = "hidden";
                    //row7.Attributes["class"] = "hidden";
                    ////Test.Attributes.Add("class", Test.Attributes["class"].ToString().Replace("spacerDiv", ""));

                    AddressSectionDiv.Visible = false;
                    //row8.Attributes["class"] = "hidden";
                    //row9.Attributes["class"] = "hidden";
                    //row10.Attributes["class"] = "hidden";
                    //row11.Attributes["class"] = "hidden";
                    //row12.Attributes["class"] = "hidden";
                    //row13.Attributes["class"] = "hidden";
                    //row14.Attributes["class"] = "hidden";

                    QuickQuoteControls();// JOSHUA DEALERS
                    break;

                case "2":
                    lblPolicyInformation.Text = "APPLICATION INFORMATION";
                    lblPolicyNumber.Visible = hide;
                    TxtBinderNo.Visible = hide;
                    txtPolicyType.Visible = hide;
                    txtSuffix.Visible = hide;

                    if (taskControl.RenewalNo != "")
                    {
                        lblRenewalNumber.Visible = hide;
                        TxtBinderNoRewnewal.Visible = hide;
                        txtRenewalType.Visible = hide;
                        TxtSuffixRenewal.Visible = hide;
                    }
                    //Label99.Visible = hide;
                    //Label100.Visible = hide;

                    // Mailing Address & Physical Address
                    LblAddress.Visible = hide;
                    LblAddress0.Visible = hide;
                    LblAddress1.Visible = hide;
                    LblAddress2.Visible = hide;
                    LblAddress3.Visible = hide;
                    LblAddress4.Visible = hide;
                    Label14.Visible = hide;
                    Label55.Visible = hide;
                    Label15.Visible = hide;
                    Label85.Visible = hide;
                    Label87.Visible = hide;
                    Label86.Visible = hide;

                    TxtAddress.Visible = hide;
                    TxtAddress2.Visible = hide;
                    TxtCity.Visible = hide;
                    TxtState.Visible = hide;
                    TxtZIPCode.Visible = hide;
                    txtPhyAddress.Visible = hide;
                    txtPhyAddress2.Visible = hide;
                    txtPhyCity.Visible = hide;
                    txtPhyState.Visible = hide;
                    txtPhyZipCode.Visible = hide;

                    //ddlBankList.Visible = hide;
                    //Label101.Visible = hide;

                    Label90.Visible = !hide;
                    Label91.Visible = !hide;
                    Label93.Visible = !hide;
                    txtViolationPoints.Visible = !hide;
                    txtViolationSurchargePct.Visible = !hide;
                    txtUnderageChargesPct.Visible = !hide;


                    if (cp.IsInRole("ADMINISTRATOR") || cp.IsInRole("AUTO VI ADMINISTRATOR"))
                    {
                        DivAgentMiddle.Visible = true;
                        DivAgentMiddle2.Visible = false;
                        PolicySectionDiv.Visible = true;
                        lblEffDate.Visible = true;
                        TxtEffBinderDate.Visible = true;
                        lblExpDate.Visible = true;
                        imgEffDate.Visible = true;
                        TxtExpBinderDate.Visible = true;
                        txtPolicyType.Visible = true;
                        TxtBinderNo.Visible = true;
                        txtSuffix.Visible = true;
                        if (btnSaveApp.Visible == true && btnIssuePolicy.Visible == false)
                        {
                            ddlAgent.Enabled = true;
                            ddlCompanyDealer.Enabled = true;
                        }
                        else
                        {
                            ddlAgent.Enabled = false;
                            ddlCompanyDealer.Enabled = false;
                        }
                    }
                    else
                    {
                        PolicySectionDiv.Visible = true;
                    }

                    if (cp.IsInRole("AUTO VI AGENCY"))
                    {
                        if (btnSaveApp.Visible == true && btnIssuePolicy.Visible == false)
                        {
                            ddlAgent.Enabled = true;
                            ddlCompanyDealer.Enabled = true;
                        }
                        else
                        {
                            ddlAgent.Enabled = false;
                            ddlCompanyDealer.Enabled = false;
                        }
                    }
                    //row1.Attributes["class"] = "";
                    ////row2.Attributes["class"] = "hidden";
                    //row3.Attributes["class"] = "hidden";
                    //row4.Attributes["class"] = "";
                    //row5.Attributes["class"] = "";
                    //row6.Attributes["class"] = "hidden";
                    //row7.Attributes["class"] = "hidden";

                    AddressSectionDiv.Visible = true;
                    //row8.Attributes["class"] = "lines1";
                    //row9.Attributes["class"] = "";
                    //row10.Attributes["class"] = "lines1";
                    //row11.Attributes["class"] = "";
                    //row12.Attributes["class"] = "lines1";
                    //row13.Attributes["class"] = "";
                    //row14.Attributes["class"] = "lines1";
                    break;

                case "3":
                    lblPolicyInformation.Text = "POLICY INFORMATION";

                    lblPolicyNumber.Visible = hide;
                    TxtBinderNo.Visible = hide;
                    txtPolicyType.Visible = hide;
                    txtSuffix.Visible = hide;

                    if (taskControl.RenewalNo != "")
                    {
                        lblRenewalNumber.Visible = hide;
                        TxtBinderNoRewnewal.Visible = hide;
                        txtRenewalType.Visible = hide;
                        TxtSuffixRenewal.Visible = hide;
                    }
                    //Label99.Visible = hide;
                    //Label100.Visible = hide;

                    // Mailing Address & Physical Address
                    LblAddress.Visible = hide;
                    LblAddress0.Visible = hide;
                    LblAddress1.Visible = hide;
                    LblAddress2.Visible = hide;
                    LblAddress3.Visible = hide;
                    LblAddress4.Visible = hide;
                    Label14.Visible = hide;
                    Label55.Visible = hide;
                    Label15.Visible = hide;
                    Label85.Visible = hide;
                    Label87.Visible = hide;
                    Label86.Visible = hide;

                    TxtAddress.Visible = hide;
                    TxtAddress2.Visible = hide;
                    TxtCity.Visible = hide;
                    TxtState.Visible = hide;
                    TxtZIPCode.Visible = hide;
                    txtPhyAddress.Visible = hide;
                    txtPhyAddress2.Visible = hide;
                    txtPhyCity.Visible = hide;
                    txtPhyState.Visible = hide;
                    txtPhyZipCode.Visible = hide;

                    //ddlBankList.Visible = hide;
                    //Label101.Visible = hide;

                    Label90.Visible = !hide;
                    Label91.Visible = !hide;
                    Label93.Visible = !hide;
                    txtViolationPoints.Visible = !hide;
                    txtViolationSurchargePct.Visible = !hide;
                    txtUnderageChargesPct.Visible = !hide;

                    if (cp.IsInRole("ADMINISTRATOR") || cp.IsInRole("AUTO VI ADMINISTRATOR"))
                    {
                        DivAgentMiddle.Visible = true;
                        DivAgentMiddle2.Visible = false;
                        PolicySectionDiv.Visible = true;
                        lblEffDate.Visible = true;
                        TxtEffBinderDate.Visible = true;
                        lblExpDate.Visible = true;
                        TxtExpBinderDate.Visible = true;
                        txtPolicyType.Visible = true;
                        TxtBinderNo.Visible = true;
                        txtSuffix.Visible = true;
                        ddlAgent.Enabled = false;
                        ddlCompanyDealer.Enabled = false;
                    }
                    else
                    {
                        //PolicySectionDiv.Visible = true;
                    }

                    if (cp.IsInRole("AUTO VI AGENCY"))
                    {
                        ddlAgent.Enabled = false;
                        ddlCompanyDealer.Enabled = false;
                    }

                    lblGrossTax.Visible = false;
                    lblGrossTaxCurrency.Visible = false;
                    txtGrossTax.Visible = false;

                    break;

            }


            if (taskControl.isQuote)
            {


            }
            else
            {

            }
        }

        private void EnableControls()
        {
            EPolicy.TaskControl.DoubleInterest taskControlQuote = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            BtnEdit.Visible = false;
            BtnEdit2.Visible = false;
            //btnPrintAppForms.Visible = false;
            btnQA.Visible = false;
            btnQA2.Visible = false;
            btnSaveApp.Visible = true;
            btnSaveApp2.Visible = true;
            //BtnPrintPolicy.Visible = true;
            btnAcceptQuote.Visible = true;
            btnAcceptQuote2.Visible = true;

            btnIssuePolicy.Enabled = false;
            btnIssuePolicy2.Enabled = false;
            btnIssuePolicy.Visible = false;
            btnIssuePolicy2.Visible = false;
            btnQuote.Enabled = true;
            btnQuote2.Enabled = true;
            btnSavePolicy.Enabled = true;
            btnSavePolicy2.Enabled = true;

            //BtnSave.Visible = true;
            BtnExit.Visible = false;
            BtnExit2.Visible = false;
            BtnCancel.Visible = false;
            BtnCancel2.Visible = false;
            //BtnAdd2.Visible = false;
            //BtnConvert.Visible = false;
            //BtnRenew.Visible = false;
            BtnDelete.Visible = false;
            BtnDelete2.Visible = false;
            //BtnPrintPolicy.Visible = false;

            //Client Information
            TxtFirstName.Enabled = true;
            TxtInitial.Enabled = true;
            TxtLastName.Enabled = true;
            //TxtLastName2.Enabled = true;
            //chkNamedInsured.Enabled = true;TxtLicensePlateNo
            ddlGender.Enabled = true;
            TxtAddress.Enabled = true;
            TxtAddress2.Enabled = true;
            TxtCity.Enabled = true;
            TxtState.Enabled = true;
            TxtZIPCode.Enabled = true;
            TxtLicenseNumber.Enabled = true;

            chkSameMailing.Enabled = true;
            txtPhyAddress.Enabled = true;
            txtPhyAddress2.Enabled = true;
            txtPhyCity.Enabled = true;
            txtPhyState.Enabled = true;
            txtPhyZipCode.Enabled = true;



            TxtLicenseNumber.Enabled = true;
            ddlMaritalStatus.Enabled = true;
            TxtBirthDate.Enabled = true;
            ImgCalendar.Enabled = true;
            ImgCalendar.Visible = false;
            TxtAge.Enabled = false;
            txtEmailAddress.Enabled = true;
            TxtWorkPhone.Enabled = true;
            TxtCellPhone.Enabled = true;
            TxtHomePhone.Enabled = true;
            ddlOccupation.Enabled = true;
            TxtOtherOccupation.Enabled = true;

            //chkAnyAccident.Enabled = true;
            //ddlDiscounts.Enabled = true;
            btnQuote.Enabled = true;
            btnQuote2.Enabled = true;

            ddlAgency.Enabled = true;
            //ddlAgent.Enabled = true;
            ddlOriginatedAt.Enabled = true;
            ddlInsuranceCompany.Enabled = true;

            rdbNewCustomerYes.Enabled = true;
            rdbNewCustomerNo.Enabled = true;
            rdbAnyAccidentsYes.Enabled = true;
            rdbAnyAccidentsNo.Enabled = true;
            rdb1Year.Enabled = true;
            rdb2Year.Enabled = true;
            rdb3Year.Enabled = true;
            rdbAnyDriverYes.Enabled = true;
            rdbAnyDriverNo.Enabled = true;
            rdbQ3Yes.Enabled = true;
            rdbQ3No.Enabled = true;
            rdbQ1Yes.Enabled = true;
            rdbQ1No.Enabled = true;
            rdbQ2Yes.Enabled = true;
            rdbQ2No.Enabled = true;
            ddlCompCollDed.Enabled = true;


            if (TxtOtherOccupation.Text != "")
            {
                TxtOtherOccupation.Enabled = true;
            }
            else
            {
                TxtOtherOccupation.Enabled = false;
            }

            TxtEmployerName.Enabled = true;

            //Drivers
            TxtDriverName.Enabled = true;
            TxtDriverLastName.Enabled = true;
            TxtDriverBirthDate.Enabled = true;
            ImgDriverCalendar.Enabled = true;
            ImgDriverCalendar.Visible = false;
            ddlDriverGender.Enabled = true;
            ddlDriverMaritalStatus.Enabled = true;
            TxtDriverAge.Enabled = false;

            BtnAddDriver.Enabled = true;
            BtnCancelDriver.Enabled = true;
            GridDrivers.Enabled = true;

            //Policy Information
            TxtBinderNo.Enabled = false;
            txtPolicyType.Enabled = false;
            txtSuffix.Enabled = false;

            radGenPolicyClaimYes.Enabled = true;
            radGenPolicyClaimNo.Enabled = true;

            radAffinityDiscountYes.Enabled = true;
            radAffinityDiscountNo.Enabled = true;

            TxtRenewalNo.Enabled = true;
            TxtEffBinderDate.Enabled = false;
            TxtExpBinderDate.Enabled = false;
            imgEffDate.Enabled = true;
            imgExpDate.Enabled = true;
            TxtCustomerCollection.Enabled = true;
            txtDiscountPct.Enabled = true;
            //txtTotalPremium.Enabled = true;
            // txtTotalPremiumPolicy.Enabled = true;
            txtTotalPremiumVehicle.Enabled = false;
            //txtCharges.Enabled = true;

            //Vehicle Information
            btnBankList.Enabled = true;
            ddlVehicleYear.Enabled = true;
            ddlVehicleMake.Enabled = true;
            ddlVehicleModel.Enabled = true;
            ddlIsland.Enabled = true;
            ddlCompanyDealer.Enabled = true;
            ddlBankList.Enabled = true;
            ddlStatus.Enabled = true;
            TxtVINNo.Enabled = true;
            TxtLicensePlateNo.Enabled = true;
            TxtVehicleValue.Enabled = true;
            ddlVehicleUse.Enabled = true;
            TxtPassengerNo.Enabled = true;
            TxtPassengerNo.Visible = false;
            LblPassengersNo.Visible = false;
            radGenTons.Enabled = true;
            radHeavyTruck.Enabled = true;
            radGenMedicalPayment.Enabled = true;
            radGenMotoristCoverage.Enabled = true;
            radRentalReimCov.Enabled = true;

            if (!chkIsBusinessAutoQuote.Checked)
                radMotorcycle.Enabled = false;

            //radGenDeathCoverage.Enabled = true;
            radADD.Enabled = true;
            txtViolationPoints.Enabled = true;
            txtViolationSurchargePct.Enabled = true;
            txtUnderageChargesPct.Enabled = true;
            //TxtPDLimit.Enabled = true;
            //TxtDeductibleComprehensive.Enabled = true;
            //TxtDeductibleCollision.Enabled = true;
            TxtBILimitpp.Enabled = true;
            TxtBILimitpo.Enabled = true;

            BtnAddVehicle.Enabled = true;
            BtnCancelVehicle.Enabled = true;
            GridVehicle.Enabled = true;


            if (taskControlQuote.Customer.Age.ToString().Trim() == "16" || taskControlQuote.Customer.Age.ToString().Trim() == "17")
            {
                lblPrimGrade.Visible = true;
                txtPrimGrade.Visible = true;
                txtPrimGrade.Enabled = true;
            }
            else
            {
                lblPrimGrade.Visible = false;
                txtPrimGrade.Visible = false;
                txtPrimGrade.Enabled = false;
            }
        }

        private void DisableControls()
        {
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            BtnEdit.Visible = true;
            BtnEdit2.Visible = true;

            btnQA.Visible = false;
            btnQA2.Visible = false;
            btnSaveApp.Visible = false;
            btnSaveApp2.Visible = false;

            DataTable dtMode_VI = GetPolicyMode_VI(taskControl.TaskControlID);
            string Mode_VI = "0";

            if (dtMode_VI.Rows.Count > 0)
            {
                Mode_VI = dtMode_VI.Rows[0]["Optional1"].ToString();
            }

            if (Mode_VI == "2")
            {
                btnIssuePolicy.Enabled = true;
                btnIssuePolicy2.Enabled = true;
                btnIssuePolicy.Visible = true;
                btnIssuePolicy2.Visible = true;
                btnPrintAppForms.Visible = true;
                btnPrintAppForms2.Visible = true;
            }
            else if (Mode_VI == "3")
            {
                BtnEdit.Visible = false;
                BtnEdit2.Visible = false;
            }
            else
            {
                btnIssuePolicy.Enabled = false;
                btnIssuePolicy2.Enabled = false;
                btnIssuePolicy.Visible = false;
                btnIssuePolicy2.Visible = false;
                btnPrintAppForms.Visible = false;
                btnPrintAppForms2.Visible = false;
            }


            btnQuote.Enabled = false;
            btnQuote2.Enabled = false;

            btnSavePolicy.Enabled = false;
            btnSavePolicy2.Enabled = false;
            btnSavePolicy.Visible = false;
            btnSavePolicy2.Visible = false;

            ////BtnSave.Visible = false;
            BtnExit.Visible = true;
            BtnExit2.Visible = true;
            BtnCancel.Visible = false;
            BtnCancel2.Visible = false;
            //BtnAdd2.Visible = false;

            ddlAgency.Enabled = false;
            ddlAgent.Enabled = false;
            ddlCompanyDealer.Enabled = false;
            ddlOriginatedAt.Enabled = false;
            ddlInsuranceCompany.Enabled = false;

            //Client Information
            TxtFirstName.Enabled = false;
            TxtInitial.Enabled = false;
            TxtLastName.Enabled = false;
            TxtLastName2.Enabled = false;
            chkNamedInsured.Enabled = false;
            ddlGender.Enabled = false;
            TxtAddress.Enabled = false;
            TxtAddress2.Enabled = false;
            TxtCity.Enabled = false;
            TxtState.Enabled = false;
            TxtZIPCode.Enabled = false;
            TxtLicenseNumber.Enabled = false;

            rdbNewCustomerYes.Enabled = false;
            rdbNewCustomerNo.Enabled = false;
            rdbAnyAccidentsYes.Enabled = false;
            rdbAnyAccidentsNo.Enabled = false;
            rdb1Year.Enabled = false;
            rdb2Year.Enabled = false;
            rdb3Year.Enabled = false;
            rdbAnyDriverYes.Enabled = false;
            rdbAnyDriverNo.Enabled = false;
            rdbQ3Yes.Enabled = false;
            rdbQ3No.Enabled = false;
            rdbQ1Yes.Enabled = false;
            rdbQ1No.Enabled = false;
            rdbQ2Yes.Enabled = false;
            rdbQ2No.Enabled = false;
            ddlCompCollDed.Enabled = false;

            // chkAnyAccident.Enabled = false;
            ddlDiscounts.Enabled = false;

            //btnQuote.Enabled = false;

            chkSameMailing.Enabled = false;
            txtPhyAddress.Enabled = false;
            txtPhyAddress2.Enabled = false;
            txtPhyCity.Enabled = false;
            txtPhyState.Enabled = false;
            txtPhyZipCode.Enabled = false;

            TxtLicenseNumber.Enabled = false;
            ddlMaritalStatus.Enabled = false;
            TxtBirthDate.Enabled = false;
            ImgCalendar.Enabled = false;
            ImgCalendar.Visible = false;
            TxtAge.Enabled = false;
            txtEmailAddress.Enabled = false;
            TxtWorkPhone.Enabled = false;
            TxtCellPhone.Enabled = false;
            TxtHomePhone.Enabled = false;
            ddlOccupation.Enabled = false;
            //TxtOtherOccupation.Enabled = false;
            TxtEmployerName.Enabled = false;

            //Drivers
            TxtDriverName.Enabled = false;
            TxtDriverLastName.Enabled = false;
            TxtDriverBirthDate.Enabled = false;
            ImgDriverCalendar.Enabled = false;
            ImgDriverCalendar.Visible = false;
            ddlDriverGender.Enabled = false;
            ddlDriverMaritalStatus.Enabled = false;
            TxtDriverAge.Enabled = false;

            BtnAddDriver.Enabled = false;
            BtnCancelDriver.Enabled = false;
            GridDrivers.Enabled = false;

            //Policy Information
            TxtBinderNo.Enabled = false;
            txtPolicyType.Enabled = false;
            txtSuffix.Enabled = false;

            radGenPolicyClaimYes.Enabled = false;
            radGenPolicyClaimNo.Enabled = false;

            radAffinityDiscountYes.Enabled = false;
            radAffinityDiscountNo.Enabled = false;

            TxtRenewalNo.Enabled = false;
            TxtEffBinderDate.Enabled = false;
            TxtExpBinderDate.Enabled = false;
            imgEffDate.Enabled = false;
            imgExpDate.Enabled = false;
            TxtCustomerCollection.Enabled = false;
            txtDiscountPct.Enabled = false;
            //txtTotalPremium.Enabled = false;
            //txtTotalPremiumPolicy.Enabled = false;
            txtTotalPremiumVehicle.Enabled = false;
            txtTotalPremiumVehicle.Enabled = false;
            //txtCharges.Enabled = false;

            //Vehicle Information
            btnBankList.Enabled = false;
            ddlVehicleYear.Enabled = false;
            ddlVehicleMake.Enabled = false;
            ddlVehicleModel.Enabled = false;
            ddlIsland.Enabled = false;
            ddlCompanyDealer.Enabled = false;
            ddlBankList.Enabled = false;
            ddlStatus.Enabled = false;
            TxtVINNo.Enabled = false;
            TxtLicensePlateNo.Enabled = false;
            TxtVehicleValue.Enabled = false;
            ddlVehicleUse.Enabled = false;
            TxtPassengerNo.Enabled = false;
            //TxtPassengerNo.Visible = false;
            radGenTons.Enabled = false;
            radHeavyTruck.Enabled = false;
            radGenMedicalPayment.Enabled = false;
            radGenMotoristCoverage.Enabled = false;
            radRentalReimCov.Enabled = false;

            //radMotorcycle.Enabled = false;

            //radGenDeathCoverage.Enabled = false;
            radADD.Enabled = false;
            txtViolationPoints.Enabled = false;
            txtViolationSurchargePct.Enabled = false;
            txtUnderageChargesPct.Enabled = false;
            TxtPDLimit.Enabled = false;
            //TxtDeductibleComprehensive.Enabled = false;
            //TxtDeductibleCollision.Enabled = false;
            txtComp.Enabled = false;
            txtRentalReimbursment.Enabled = false;
            txtTaxiLossIncome.Enabled = false;
            txtCollision.Enabled = false;
            TxtBILimitpp.Enabled = false;
            TxtBILimitpo.Enabled = false;

            BtnAddVehicle.Enabled = false;
            BtnCancelVehicle.Enabled = false;
            GridVehicle.Enabled = false;

            if (taskControl.Customer.Age.ToString().Trim() == "16" || taskControl.Customer.Age.ToString().Trim() == "17")
            {
                lblPrimGrade.Visible = true;
                txtPrimGrade.Visible = true;
                txtPrimGrade.Enabled = false;
            }
            else
            {
                lblPrimGrade.Visible = false;
                txtPrimGrade.Visible = false;
                txtPrimGrade.Enabled = false;
            }
        }

        #region Validate

        private void ValidateFields()
        {
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            ArrayList errorMessages = new ArrayList();

            //add validation ifs

            if (errorMessages.Count > 0)
            {
                string popUpString = "";

                foreach (string message in errorMessages)
                {
                    popUpString += "\r\n" + message + " ";
                }

                throw new Exception(popUpString);
            }
        }

        protected bool ValidateBI()
        {
            //C = Commercial, O = Other(Private Passenger), P = Private, R = Rental, T = Taxi
            bool rtValue = true;
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
            if (TxtBILimitpp.Items.Count != 0)
            {

                if (ddlVehicleUse.SelectedItem.Value.ToString() == "C")
                {
                    if (TxtBILimitpp.SelectedItem.Value == "$10,000/$50,000")
                    {
                        rtValue = false;
                        //throw new Exception("BI Limit 10/50 is not available with selected vehicle use.");
                        lblRecHeader.Text = "Invalid BI Limit selected for the selected criteria ($10,000/$50,000).";
                        mpeSeleccion.Show();
                    }
                }

                if (ddlVehicleUse.SelectedItem.Value.ToString() == "O")
                {
                    if (TxtBILimitpp.SelectedItem.Value != "$10,000/$20,000")
                    {
                        rtValue = false;
                        //throw new Exception("BI Limit " + TxtBILimitpp.SelectedItem.Value.ToString() + "  is not available with selected vehicle use.");
                        lblRecHeader.Text = "Invalid BI Limit selected for the selected criteria ($10,000/$20,000).";
                        mpeSeleccion.Show();
                    }
                }

                if (ddlVehicleUse.SelectedItem.Value.ToString() == "P")
                {
                    if (TxtBILimitpp.SelectedItem.Value != "$10,000/$20,000")
                    {
                        rtValue = false;
                        lblRecHeader.Text = "Invalid BI Limit selected for the selected criteria ($10,000/$20,000).";
                        mpeSeleccion.Show();
                    }
                }

                if (ddlVehicleUse.SelectedItem.Value.ToString() == "R" && radMotorcycle.SelectedItem.Value == "N")
                {
                    if (TxtBILimitpp.SelectedItem.Value != "$10,000/$25,000")
                    {
                        rtValue = false;
                        lblRecHeader.Text = "BI Limit " + TxtBILimitpp.SelectedItem.Value.ToString() + "  is not available with selected vehicle use and motorist.";
                        mpeSeleccion.Show();
                    }
                }

                if (ddlVehicleUse.SelectedItem.Value.ToString() == "R" && radMotorcycle.SelectedItem.Value == "Y")
                {
                    if (TxtBILimitpp.SelectedItem.Value != "$10,000/$25,000")
                    {
                        rtValue = false;
                        lblRecHeader.Text = "BI Limit " + TxtBILimitpp.SelectedItem.Value.ToString() + "  is not available with selected vehicle use and motorist.";
                        mpeSeleccion.Show();
                    }
                }

                if (ddlVehicleUse.SelectedItem.Value.ToString() == "T")
                {
                    if (ddlIsland.SelectedItem.Value.ToString() == "1" || ddlIsland.SelectedItem.Value.ToString() == "2")
                    {
                        if (int.Parse(TxtPassengerNo.Text.ToString()) >= 5 && int.Parse(TxtPassengerNo.Text.ToString()) <= 10)
                        {
                            if (TxtBILimitpp.SelectedItem.Value != "$10,000/$25,000")
                            {
                                rtValue = false;
                                lblRecHeader.Text = "BI Limit " + TxtBILimitpp.SelectedItem.Value.ToString() + "  is not available with the selected criteria.";
                                mpeSeleccion.Show();
                            }
                        }
                        else if (int.Parse(TxtPassengerNo.Text.ToString()) >= 11 && int.Parse(TxtPassengerNo.Text.ToString()) <= 30)
                        {
                            if (TxtBILimitpp.SelectedItem.Value != "$10,000/$50,000")
                            {
                                rtValue = false;
                                lblRecHeader.Text = "BI Limit " + TxtBILimitpp.SelectedItem.Value.ToString() + "  is not available with the selected criteria.";
                                mpeSeleccion.Show();
                            }
                        }
                    }
                    else if (ddlIsland.SelectedItem.Value.ToString() == "3")
                    {
                        if (TxtBILimitpp.SelectedItem.Value == "$10,000/$20,000")
                        {
                            rtValue = false;
                            lblRecHeader.Text = "BI Limit " + TxtBILimitpp.SelectedItem.Value.ToString() + "  is not available with the selected criteria.";
                            mpeSeleccion.Show();
                        }

                        if (int.Parse(TxtPassengerNo.Text.ToString()) < 9 && taskControl.Mode != 1)
                        {

                            rtValue = false;
                            lblRecHeader.Text = "For this criteria, the number of passanger must be 9 or more.";
                            mpeSeleccion.Show();
                        }

                    }
                }
            }
            else
            {
                rtValue = false;
            }

            return rtValue;
        }

        protected bool ValidateRates()
        {
            if (TxtVehicleValue.Text.ToString().Trim() == "")
            {
                TxtVehicleValue.Text = "0";
            }

            if (double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) <= 5000)
            {
                if (ddlVehicleUse.SelectedItem.Value.ToString() == "T" && double.Parse(TxtPassengerNo.Text.Trim()) >= 10)
                {
                    return true;
                }

                return false;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString() == "C" && (ddlDedComp.SelectedItem.Value.ToString() == "$500" && ddlDedColl.SelectedItem.Value.ToString() == "$1,000") && double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) <= 26000)
            {
                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString() == "C" && (ddlDedComp.SelectedItem.Value.ToString() == "$1,000" && ddlDedColl.SelectedItem.Value.ToString() == "$2,500"))
            {
                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString() == "C" &&
                ((ddlDedComp.SelectedItem.Value.ToString() == "$250" && ddlDedColl.SelectedItem.Value.ToString() == "$500") ||
                ddlDedComp.SelectedItem.Value.ToString() == "$500" && ddlDedColl.SelectedItem.Value.ToString() == "$500") && System.DateTime.Today.Year - double.Parse(ddlVehicleYear.SelectedItem.Text.ToString()) < 5)
            {
                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString() == "C" && (ddlDedComp.SelectedItem.Value.ToString() == "$2,500" && ddlDedColl.SelectedItem.Value.ToString() == "$5,000") && double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) >= 26001)
            {
                return true;
            }

            //========================
            // OTHER PRIVATE PASSENGER
            //========================
            if (ddlVehicleUse.SelectedItem.Value.ToString() == "O" && (ddlDedComp.SelectedItem.Value.ToString() == "$500" && ddlDedColl.SelectedItem.Value.ToString() == "$1,000") && double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) <= 35000)
            {
                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString() == "O" && (ddlDedComp.SelectedItem.Value.ToString() == "$1,000" && ddlDedColl.SelectedItem.Value.ToString() == "$1,000") && double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) <= 35000)
            {
                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString() == "O" && (ddlDedComp.SelectedItem.Value.ToString() == "$1,000" && ddlDedColl.SelectedItem.Value.ToString() == "$1,500") && double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) >= 35001)
            {
                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString() == "O" &&
                ((ddlDedComp.SelectedItem.Value.ToString() == "$250" && ddlDedColl.SelectedItem.Value.ToString() == "$500") ||
                ddlDedComp.SelectedItem.Value.ToString() == "$500" && ddlDedColl.SelectedItem.Value.ToString() == "$500") && System.DateTime.Today.Year - double.Parse(ddlVehicleYear.SelectedItem.Text.ToString()) < 5 &&
                double.Parse(TxtAge.Text.Trim()) >= 29 && double.Parse(TxtAge.Text.Trim()) <= 69 &&
                double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) > 5000 && double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) <= 50000)
            {
                return true;
            }

            //=========
            // PRIVATE
            //=========
            if (ddlVehicleUse.SelectedItem.Value.ToString() == "P" && (ddlDedComp.SelectedItem.Value.ToString() == "$500" && ddlDedColl.SelectedItem.Value.ToString() == "$1,000") && double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) <= 35000)
            {
                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString() == "P" && (ddlDedComp.SelectedItem.Value.ToString() == "$1,000" && ddlDedColl.SelectedItem.Value.ToString() == "$1,000") && double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) <= 35000)
            {
                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString() == "P" && (ddlDedComp.SelectedItem.Value.ToString() == "$1,000" && ddlDedColl.SelectedItem.Value.ToString() == "$1,500") && double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) >= 35001)
            {
                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString() == "P" &&
                ((ddlDedComp.SelectedItem.Value.ToString() == "$250" && ddlDedColl.SelectedItem.Value.ToString() == "$500") ||
                ddlDedComp.SelectedItem.Value.ToString() == "$500" && ddlDedColl.SelectedItem.Value.ToString() == "$500") && System.DateTime.Today.Year - double.Parse(ddlVehicleYear.SelectedItem.Text.ToString()) < 5 &&
                double.Parse(TxtAge.Text.Trim()) >= 29 && double.Parse(TxtAge.Text.Trim()) <= 69 &&
                double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) > 5000 && double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) <= 50000)
            {
                return true;
            }

            //========
            // RENTAL
            //========
            if (ddlVehicleUse.SelectedItem.Value.ToString() == "R" && (ddlDedComp.SelectedItem.Value.ToString() == "$1,500" && ddlDedColl.SelectedItem.Value.ToString() == "$2,500"))
            {
                return true;
            }

            //=================
            // TAXI - ST THOMAS
            //=================
            if (ddlVehicleUse.SelectedItem.Value.ToString() == "T" && ddlIsland.SelectedItem.Value.ToString() == "1" && (ddlDedComp.SelectedItem.Value.ToString() == "$500" && ddlDedColl.SelectedItem.Value.ToString() == "$1,000"))
            {
                return true;
            }

            //================
            // TAXI - ST CROIX
            //================
            if (ddlVehicleUse.SelectedItem.Value.ToString() == "T" && ddlIsland.SelectedItem.Value.ToString() == "2" && (ddlDedComp.SelectedItem.Value.ToString() == "$500" && ddlDedColl.SelectedItem.Value.ToString() == "$1,000") && double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) <= 20000)
            {
                return true;
            }
            //===============
            // TAXI - ST JOHN
            //===============
            if (ddlVehicleUse.SelectedItem.Value.ToString() == "T" && ddlIsland.SelectedItem.Value.ToString() == "3" && (ddlDedComp.SelectedItem.Value.ToString() == "$500" && ddlDedColl.SelectedItem.Value.ToString() == "$1,000") && double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) <= 20000)
            {
                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString() == "T" && ddlIsland.SelectedItem.Value.ToString() == "3" &&
                (ddlDedComp.SelectedItem.Value.ToString() == "$1,000" && ddlDedColl.SelectedItem.Value.ToString() == "$1,000") &&
                double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) >= 20001)
            {
                return true;
            }

            return false;
        }

        protected bool ValidarCamposDisponiblesPhysDam()
        {

            ddlCompCollDed.Items.Clear();

            if (ddlVehicleYear.SelectedItem.Value.ToString().Trim() != "")
            {
                if (DateTime.Now.Year - int.Parse(ddlVehicleYear.SelectedItem.Text.ToString().Trim()) > 10)
                {
                    //Rental no lleva RentalReimbursement si tiene mas de 10 años -Peticion de SUSANA
                    lblRentalReim.Visible = false;
                    radRentalReimCov.Visible = false;
                    if (radRentalReimCov.SelectedItem.Value.ToString() == "Y")
                        radRentalReimCov.SelectedIndex = 1;

                    //return false;
                }
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "")
            {
                return false;
            }

            if (ddlVehicleYear.SelectedItem.Text.ToString() == "")
            {
                return false;
            }

            // aqui
            //if (TxtVehicleValue.Text.Trim() == "")
            //{
            //    return false;
            //}

            if (TxtAge.Text.Trim() == "")
            {
                return false;
            }

            if (TxtPassengerNo.Text.Trim() == "")
            {
                return false;
            }

            if (TxtVehicleValue.Text.ToString().Trim() == "")
            {
                TxtVehicleValue.Text = "0";
            }

            //===========
            // COMMERCIAL
            //===========
            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "C")
            {
                Label23.Visible = true;
                radGenTons.Visible = true;
                //lblHeavyTruck.Visible = true;
                //radHeavyTruck.Visible = true;
            }
            else
            {
                Label23.Visible = false;
                radGenTons.Visible = false;
                lblHeavyTruck.Visible = false;
                radHeavyTruck.Visible = false;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "C" &&
                System.DateTime.Today.Year - double.Parse(ddlVehicleYear.SelectedItem.Text.ToString()) < 5 &&
                double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) > 5001 && double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) <= 26000)
            {
                //ddlCompCollDed.Items.Add(new ListItem("$250/$500", "$250/$500"));
                if (!ValidarDriverIsUnder26())
                {
                    ddlCompCollDed.Items.Add(new ListItem("$500/$500", "$500/$500"));
                    ddlCompCollDed.Items.Add(new ListItem("$250/$500", "$250/$500"));
                }
                ddlCompCollDed.Items.Add(new ListItem("$500/$1,000", "$500/$1,000"));
                ddlCompCollDed.Items.Add(new ListItem("$1,000/$2,500", "$1,000/$2,500"));

                return true;
            }


            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "C" &&
                System.DateTime.Today.Year - double.Parse(ddlVehicleYear.SelectedItem.Text.ToString()) >= 5 &&
                double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) > 5001 && double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) <= 26000)
            {
                ddlCompCollDed.Items.Add(new ListItem("$500/$1,000", "$500/$1,000"));
                ddlCompCollDed.Items.Add(new ListItem("$1,000/$2,500", "$1,000/$2,500"));

                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "C" &&
                double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) >= 26001)
            {
                ddlCompCollDed.Items.Add(new ListItem("$1,000/$2,500", "$1,000/$2,500"));
                ddlCompCollDed.Items.Add(new ListItem("$2,500/$5,000", "$2,500/$5,000"));

                return true;
            }

            //==========================
            // OTHER - PRIVATE PASSENGER
            //==========================
            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "O" &&
                System.DateTime.Today.Year - double.Parse(ddlVehicleYear.SelectedItem.Text.ToString()) < 5 &&
                double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) >= 5001 && double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) <= 50000 &&
                double.Parse(TxtAge.Text.Trim()) >= 26 && double.Parse(TxtAge.Text.Trim()) <= 69)
            {
                //ddlCompCollDed.Items.Add(new ListItem("$250/$500", "$250/$500"));
                if (!ValidarDriverIsUnder26())
                {
                    ddlCompCollDed.Items.Add(new ListItem("$500/$500", "$500/$500"));
                    ddlCompCollDed.Items.Add(new ListItem("$250/$500", "$250/$500"));
                }
                ddlCompCollDed.Items.Add(new ListItem("$500/$1,000", "$500/$1,000"));
                ddlCompCollDed.Items.Add(new ListItem("$1,000/$1,000", "$1,000/$1,000"));

                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "O" &&
                double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) >= 5001 && double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) <= 35000)
            {

                ddlCompCollDed.Items.Add(new ListItem("$500/$1,000", "$500/$1,000"));
                ddlCompCollDed.Items.Add(new ListItem("$1,000/$1,000", "$1,000/$1,000"));

                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "O" &&
                double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) >= 35001)
            {

                ddlCompCollDed.Items.Add(new ListItem("$1,000/$1,500", "$1,000/$1,500"));

                return true;
            }

            //=========
            // Private
            //=========
            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "P" &&
                System.DateTime.Today.Year - double.Parse(ddlVehicleYear.SelectedItem.Text.ToString()) < 5 &&
                double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) >= 5001 && double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) <= 50000 &&
                double.Parse(TxtAge.Text.Trim()) >= 26 && double.Parse(TxtAge.Text.Trim()) <= 69)
            {
                //ddlCompCollDed.Items.Add(new ListItem("$250/$500", "$250/$500"));
                if (!ValidarDriverIsUnder26())
                {
                    ddlCompCollDed.Items.Add(new ListItem("$500/$500", "$500/$500"));
                    ddlCompCollDed.Items.Add(new ListItem("$250/$500", "$250/$500"));
                }
                ddlCompCollDed.Items.Add(new ListItem("$500/$1,000", "$500/$1,000"));
                ddlCompCollDed.Items.Add(new ListItem("$1,000/$1,000", "$1,000/$1,000"));

                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "P" &&
                double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) >= 5001 && double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) <= 35000)
            {
                ddlCompCollDed.Items.Add(new ListItem("$500/$1,000", "$500/$1,000"));
                ddlCompCollDed.Items.Add(new ListItem("$1,000/$1,000", "$1,000/$1,000"));

                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "P" &&
                double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) >= 35001)
            {
                ddlCompCollDed.Items.Add(new ListItem("$500/$1,000", "$500/$1,000"));
                ddlCompCollDed.Items.Add(new ListItem("$1,000/$1,000", "$1,000/$1,000"));
                ddlCompCollDed.Items.Add(new ListItem("$1,000/$1,500", "$1,000/$1,500"));

                return true;
            }

            //========
            // Rental
            //========
            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "R" &&
                double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) >= 5001)
            {
                ddlCompCollDed.Items.Add(new ListItem("$1,500/$2,500", "$1,500/$2,500"));

                return true;
            }

            //=================
            // TAXI - ST THOMAS
            //=================
            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "T" &&
                ddlIsland.SelectedItem.Value.ToString() == "1" &&
                double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) >= 5001)
            {
                ddlCompCollDed.Items.Add(new ListItem("$500/$1,000", "$500/$1,000"));

                return true;
            }

            //================
            // TAXI - ST CROIX
            //================
            if (ddlVehicleUse.SelectedItem.Value.ToString() == "T" &&
                ddlIsland.SelectedItem.Value.ToString() == "2" &&
                double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) >= 5001)
            {

                ddlCompCollDed.Items.Add(new ListItem("$500/$1,000", "$500/$1,000"));

                return true;
            }

            //===============
            // TAXI - ST JOHN
            //===============
            if (ddlVehicleUse.SelectedItem.Value.ToString() == "T" &&
                ddlIsland.SelectedItem.Value.ToString() == "3" &&
                double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) >= 5001 && double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) <= 20000)
            {

                ddlCompCollDed.Items.Add(new ListItem("$500/$1,000", "$500/$1,000"));

                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString() == "T" &&
                ddlIsland.SelectedItem.Value.ToString() == "3" &&
                double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) >= 20001 &&
                double.Parse(TxtPassengerNo.Text.Trim()) >= 0 && double.Parse(TxtPassengerNo.Text.Trim()) <= 9)
            {

                ddlCompCollDed.Items.Add(new ListItem("$1,000/$1,000", "$1,000/$1,000"));

                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString() == "T" &&
                ddlIsland.SelectedItem.Value.ToString() == "3" &&
                double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) > 0 && double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) <= 26000)
            {

                ddlCompCollDed.Items.Add(new ListItem("$500/$1,000", "$500/$1,000"));

                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString() == "T" &&
                ddlIsland.SelectedItem.Value.ToString() == "3" &&
                double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) >= 50001 &&
                double.Parse(TxtPassengerNo.Text.Trim()) >= 0 && double.Parse(TxtPassengerNo.Text.Trim()) <= 9)
            {

                ddlCompCollDed.Items.Add(new ListItem("$1,000/$1,000", "$1,000/$1,000"));

                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString() == "T" &&
                ddlIsland.SelectedItem.Value.ToString() == "3" &&
                double.Parse(TxtVehicleValue.Text.Trim(), System.Globalization.NumberStyles.Currency) >= 50001 &&
                double.Parse(TxtPassengerNo.Text.Trim()) >= 10)
            {

                ddlCompCollDed.Items.Add(new ListItem("$1,000/$1,000", "$1,000/$1,000"));

                return true;
            }




            return false;
        }


        protected bool FillPhysDam(string UseCode, string Territory, int ACV, string HighPerf, int VehicleYear, int DriverAge, int Passengers)
        {

            ddlCompCollDed.Items.Clear();

            if (UseCode == "C" &&
                System.DateTime.Today.Year - double.Parse(VehicleYear.ToString()) < 5 &&
                double.Parse(ACV.ToString()) > 5001 && double.Parse(ACV.ToString()) <= 26000)
            {
                //ddlCompCollDed.Items.Add(new ListItem("$250/$500", "$250/$500"));
                if (!ValidarDriverIsUnder26())
                {
                    ddlCompCollDed.Items.Add(new ListItem("$500/$500", "$500/$500"));
                    ddlCompCollDed.Items.Add(new ListItem("$250/$500", "$250/$500"));
                }
                ddlCompCollDed.Items.Add(new ListItem("$500/$1,000", "$500/$1,000"));
                ddlCompCollDed.Items.Add(new ListItem("$1,000/$2,500", "$1,000/$2,500"));

                return true;
            }


            if (UseCode == "C" &&
                System.DateTime.Today.Year - double.Parse(VehicleYear.ToString()) >= 5 &&
                double.Parse(ACV.ToString()) > 5001 && double.Parse(ACV.ToString()) <= 26000)
            {
                ddlCompCollDed.Items.Add(new ListItem("$500/$1,000", "$500/$1,000"));
                ddlCompCollDed.Items.Add(new ListItem("$1,000/$2,500", "$1,000/$2,500"));

                return true;
            }

            if (UseCode == "C" &&
                double.Parse(ACV.ToString()) >= 26001)
            {
                ddlCompCollDed.Items.Add(new ListItem("$1,000/$2,500", "$1,000/$2,500"));
                ddlCompCollDed.Items.Add(new ListItem("$2,500/$5,000", "$2,500/$5,000"));

                return true;
            }

            //==========================
            // OTHER - PRIVATE PASSENGER
            //==========================
            if (UseCode == "O" &&
                System.DateTime.Today.Year - double.Parse(VehicleYear.ToString()) < 5 &&
                double.Parse(ACV.ToString()) >= 5001 && double.Parse(ACV.ToString()) <= 50000 &&
                double.Parse(DriverAge.ToString()) >= 26 && double.Parse(DriverAge.ToString()) <= 69)
            {
                //ddlCompCollDed.Items.Add(new ListItem("$250/$500", "$250/$500"));
                if (!ValidarDriverIsUnder26())
                {
                    ddlCompCollDed.Items.Add(new ListItem("$500/$500", "$500/$500"));
                    ddlCompCollDed.Items.Add(new ListItem("$250/$500", "$250/$500"));
                }
                ddlCompCollDed.Items.Add(new ListItem("$500/$1,000", "$500/$1,000"));
                ddlCompCollDed.Items.Add(new ListItem("$1,000/$1,000", "$1,000/$1,000"));

                return true;
            }

            if (UseCode == "O" &&
                double.Parse(ACV.ToString()) >= 5001 && double.Parse(ACV.ToString()) <= 35000)
            {

                ddlCompCollDed.Items.Add(new ListItem("$500/$1,000", "$500/$1,000"));
                ddlCompCollDed.Items.Add(new ListItem("$1,000/$1,000", "$1,000/$1,000"));

                return true;
            }

            if (UseCode == "O" &&
                double.Parse(ACV.ToString()) >= 35001)
            {

                ddlCompCollDed.Items.Add(new ListItem("$1,000/$1,500", "$1,000/$1,500"));

                return true;
            }

            //=========
            // Private
            //=========
            if (UseCode == "P" &&
                System.DateTime.Today.Year - double.Parse(VehicleYear.ToString()) < 5 &&
                double.Parse(ACV.ToString()) >= 5001 && double.Parse(ACV.ToString()) <= 50000 &&
                double.Parse(DriverAge.ToString()) >= 26 && double.Parse(DriverAge.ToString()) <= 69)
            {
                //ddlCompCollDed.Items.Add(new ListItem("$250/$500", "$250/$500"));
                if (!ValidarDriverIsUnder26())
                {
                    ddlCompCollDed.Items.Add(new ListItem("$500/$500", "$500/$500"));
                    ddlCompCollDed.Items.Add(new ListItem("$250/$500", "$250/$500"));
                }
                ddlCompCollDed.Items.Add(new ListItem("$500/$1,000", "$500/$1,000"));
                ddlCompCollDed.Items.Add(new ListItem("$1,000/$1,000", "$1,000/$1,000"));

                return true;
            }

            if (UseCode == "P" &&
                double.Parse(ACV.ToString()) >= 5001 && double.Parse(ACV.ToString()) <= 35000)
            {
                ddlCompCollDed.Items.Add(new ListItem("$500/$1,000", "$500/$1,000"));
                ddlCompCollDed.Items.Add(new ListItem("$1,000/$1,000", "$1,000/$1,000"));

                return true;
            }

            if (UseCode == "P" &&
                double.Parse(ACV.ToString()) >= 35001)
            {

                ddlCompCollDed.Items.Add(new ListItem("$1,000/$1,500", "$1,000/$1,500"));

                return true;
            }

            //========
            // Rental
            //========
            if (UseCode == "R" &&
                double.Parse(ACV.ToString()) >= 5001)
            {
                ddlCompCollDed.Items.Add(new ListItem("$1,500/$2,500", "$1,500/$2,500"));

                return true;
            }

            //=================
            // TAXI - ST THOMAS
            //=================
            if (UseCode == "T" &&
                Territory.ToString() == "1" &&
                double.Parse(ACV.ToString()) >= 5001)
            {
                ddlCompCollDed.Items.Add(new ListItem("$500/$1,000", "$500/$1,000"));

                return true;
            }

            //================
            // TAXI - ST CROIX
            //================
            if (UseCode == "T" &&
                Territory.ToString() == "2" &&
                double.Parse(ACV.ToString()) >= 5001)
            {

                ddlCompCollDed.Items.Add(new ListItem("$500/$1,000", "$500/$1,000"));

                return true;
            }

            //===============
            // TAXI - ST JOHN
            //===============
            if (UseCode == "T" &&
                Territory.ToString() == "3" &&
                double.Parse(ACV.ToString()) >= 5001 && double.Parse(ACV.ToString()) <= 20000)
            {

                ddlCompCollDed.Items.Add(new ListItem("$500/$1,000", "$500/$1,000"));

                return true;
            }

            if (UseCode == "T" &&
                Territory.ToString() == "3" &&
                double.Parse(ACV.ToString()) >= 20001 &&
                double.Parse(Passengers.ToString()) >= 0 && double.Parse(Passengers.ToString()) <= 9)
            {

                ddlCompCollDed.Items.Add(new ListItem("$1,000/$1,000", "$1,000/$1,000"));

                return true;
            }

            if (UseCode == "T" &&
                Territory.ToString() == "3" &&
                double.Parse(ACV.ToString()) > 0 && double.Parse(ACV.ToString()) <= 26000)
            {

                ddlCompCollDed.Items.Add(new ListItem("$500/$1,000", "$500/$1,000"));

                return true;
            }

            if (UseCode == "T" &&
                Territory.ToString() == "3" &&
                double.Parse(ACV.ToString()) >= 50001 &&
                double.Parse(Passengers.ToString()) >= 0 && double.Parse(Passengers.ToString()) <= 9)
            {

                ddlCompCollDed.Items.Add(new ListItem("$1,000/$1,000", "$1,000/$1,000"));

                return true;
            }

            if (UseCode == "T" &&
                Territory.ToString() == "3" &&
                double.Parse(ACV.ToString()) >= 50001 &&
                double.Parse(Passengers.ToString()) >= 10)
            {

                ddlCompCollDed.Items.Add(new ListItem("$1,000/$1,000", "$1,000/$1,000"));

                return true;
            }

            return false;
        }

        protected bool ValidarDriverIsUnder26()
        {
            EPolicy.TaskControl.DoubleInterest taskcontrol = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            try
            {
                if (taskcontrol.EntryDate != null)
                {
                    if (taskcontrol.EntryDate > DateTime.Parse("11/15/2017"))
                    {
                        if (taskcontrol.DriversCollection != null)
                        {
                            DataTable dt = taskcontrol.DriversCollection;
                            for (int i = 0; i < dt.Rows.Count; i++)
                            {
                                if (dt.Rows[i]["DriverAge"].ToString() != "")
                                    if (int.Parse(dt.Rows[i]["DriverAge"].ToString().Trim()) < 26 && dt.Rows[i]["DriverAge"].ToString().Trim() != "0")
                                    {
                                        return true;
                                    }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            { }

            return false;
        }

        protected void ValidarMedicalPaymentsLiab()
        {

            if (radMotorcycle.SelectedIndex == 0)
            {
                txtMPLimit.Text = "";
                radGenMedicalPayment.SelectedIndex = 1;
            }
            else
            {
                //txtMPLimit.Text = "$1,000/$5,000";
                //radGenMedicalPayment.SelectedIndex = 0;
            }


        }

        protected bool ValidarCamposDisponiblesLiab()
        {

            TxtBILimitpp.Items.Clear();

            // COMMERCIAL
            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "C" &&
                radMotorcycle.SelectedItem.Value.ToString() == "Y")
            {
                TxtBILimitpp.Items.Add(new ListItem("$10,000/$20,000", "$10,000/$20,000"));

                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "C" &&
                radGenTons.SelectedItem.Value.ToString() == "Y")
            {
                TxtBILimitpp.Items.Add(new ListItem("$10,000/$25,000", "$10,000/$25,000"));

                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "C" &&
                radGenTons.SelectedItem.Value.ToString() == "N" && radMotorcycle.SelectedItem.Value.ToString() == "N")
            {
                TxtBILimitpp.Items.Add(new ListItem("$10,000/$25,000", "$10,000/$25,000"));

                return true;
            }

            // OTHER
            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "O" || ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "P")
            {
                TxtBILimitpp.Items.Add(new ListItem("$10,000/$20,000", "$10,000/$20,000"));

                return true;
            }


            // RENTAL
            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "R" &&
                radMotorcycle.SelectedItem.Value.ToString() == "N")
            {
                TxtBILimitpp.Items.Add(new ListItem("$10,000/$25,000", "$10,000/$25,000"));

                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "R" &&
                radMotorcycle.SelectedItem.Value.ToString() == "Y")
            {
                TxtBILimitpp.Items.Add(new ListItem("$10,000/$25,000", "$10,000/$25,000"));

                return true;
            }


            // TAXI
            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "T" &&
                (ddlIsland.SelectedItem.Value.ToString() == "1" || ddlIsland.SelectedItem.Value.ToString() == "2") &&
                double.Parse(TxtPassengerNo.Text.Trim()) >= 5 && double.Parse(TxtPassengerNo.Text.Trim()) <= 10)
            {
                TxtBILimitpp.Items.Add(new ListItem("$10,000/$25,000", "$10,000/$25,000"));

                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "T" &&
                (ddlIsland.SelectedItem.Value.ToString() == "1" || ddlIsland.SelectedItem.Value.ToString() == "2") &&
                double.Parse(TxtPassengerNo.Text.Trim()) >= 11 && double.Parse(TxtPassengerNo.Text.Trim()) <= 30)
            {
                TxtBILimitpp.Items.Add(new ListItem("$10,000/$50,000", "$10,000/$50,000"));

                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "T" &&
                ddlIsland.SelectedItem.Value.ToString() == "3" &&
                double.Parse(TxtPassengerNo.Text.Trim()) >= 0 && double.Parse(TxtPassengerNo.Text.Trim()) <= 9)
            {
                TxtBILimitpp.Items.Add(new ListItem("$10,000/$25,000", "$10,000/$25,000"));

                return true;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "T" &&
                ddlIsland.SelectedItem.Value.ToString() == "3" &&
                double.Parse(TxtPassengerNo.Text.Trim()) >= 10)
            {
                TxtBILimitpp.Items.Add(new ListItem("$10,000/$50,000", "$10,000/$50,000"));

                return true;
            }

            return true;
        }

        protected bool ValidateFieldsBeforeSave()
        {
            lblRecHeader.Text = "";

            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            DataTable dtMode_VI = GetPolicyMode_VI(taskControl.TaskControlID);
            string Mode_VI = "0";

            if (dtMode_VI.Rows.Count > 0)
            {
                Mode_VI = dtMode_VI.Rows[0]["Optional1"].ToString();
            }

            if (!chkIsBusinessAutoQuote.Checked)
            {
                if (TxtFirstName.Text.Trim() == "")
                {
                    lblRecHeader.Text = "Please enter First Name.";
                    mpeSeleccion.Show();
                    //TxtFirstName.Focus();
                    return false;
                }

                if (TxtLastName.Text.Trim() == "")
                {
                    lblRecHeader.Text = "Please enter Last Name.";
                    mpeSeleccion.Show();
                    //TxtLastName.Focus();
                    return false;
                }

                if (ddlMaritalStatus.SelectedItem.Text.Trim() == "")
                {
                    lblRecHeader.Text = "Please enter Marital Status.";
                    mpeSeleccion.Show();
                    //ddlMaritalStatus.Focus();
                    return false;
                }

                if (TxtBirthDate.Text.Trim() == "")
                {
                    lblRecHeader.Text = "Please enter Date of Birth.";
                    mpeSeleccion.Show();
                    //TxtDriverBirthDate.Focus();
                    return false;
                }

            }
            else
            {
                if (!chkNamedInsured.Checked)
                {
                    if (TxtFirstName.Text.Trim() == "" && TxtLastName.Text.Trim() == "")
                    {
                        lblRecHeader.Text = "Please enter First Name and Last Name.";
                        mpeSeleccion.Show();
                        //TxtFirstName.Focus();
                        return false;
                    }
                }
                else
                {
                    if (TxtLastName2.Text.Trim() == "")
                    {
                        lblRecHeader.Text = "Please enter Company Name.";
                        mpeSeleccion.Show();
                        //TxtFirstName.Focus();
                        return false;
                    }
                }
            }




            if (txtEmailAddress.Text.Trim() == "" || !txtEmailAddress.Text.Trim().Contains("@"))
            {
                lblRecHeader.Text = "Please enter valid Email Address.";
                mpeSeleccion.Show();
                //txtEmailAddress.Focus();
                return false;
            }

            if ((this.TxtWorkPhone.Text == "" || this.TxtWorkPhone.Text == "(") && (this.TxtCellPhone.Text == "" || this.TxtCellPhone.Text == "("))
            {
                lblRecHeader.Text = ("Home/Mobile Phone is missing." + "\r\n");
                mpeSeleccion.Show();
                return false;
            }

            if (lblModifyDriver.Visible == true)
            {
                lblRecHeader.Text = "Please save the additional driver first.";
                mpeSeleccion.Show();
                return false;
            }

            if (ddlTerms.SelectedIndex == 0)
            {
                lblRecHeader.Text = "Please choose a term.";
                mpeSeleccion.Show();
                return false;
            }

            if (lblModifyVehicle.Visible == true)
            {
                lblRecHeader.Text = "Please save the additional vehicle first.";
                mpeSeleccion.Show();
                return false;
            }

            if (lblPrimGrade.Visible == true && (txtPrimGrade.Text == "0.0" || txtPrimGrade.Text == ""))
            {
                lblRecHeader.Text = "Please primary driver's Grade Point Average.";
                mpeSeleccion.Show();
                return false;
            }

            if (!(rdbNewCustomerYes.Checked || rdbNewCustomerNo.Checked))
            {
                lblRecHeader.Text = "Please specify if this is a New Customer.";
                mpeSeleccion.Show();
                return false;
            }



            if (Mode_VI == "2") //APPLICATION
            {
                if (TxtAddress.Text.Trim() == "")
                {
                    lblRecHeader.Text = "Please enter Mailing Address #1.";
                    mpeSeleccion.Show();
                    return false;
                }

                if (TxtCity.Text.Trim() == "")
                {
                    lblRecHeader.Text = "Please enter Mailing City.";
                    mpeSeleccion.Show();
                    return false;
                }

                if (TxtState.Text.Trim() == "")
                {
                    lblRecHeader.Text = "Please enter Mailing State.";
                    mpeSeleccion.Show();
                    return false;
                }

                if (TxtZIPCode.Text.Trim() == "")
                {
                    lblRecHeader.Text = "Please enter Mailing Zip Code.";
                    mpeSeleccion.Show();
                    return false;
                }

                if (txtPhyAddress.Text.Trim() == "")
                {
                    lblRecHeader.Text = "Please enter Physical Address #1.";
                    mpeSeleccion.Show();
                    return false;
                }

                //if (txtPhyAddress2.Text.Trim() == "")
                //{
                //    lblRecHeader.Text = "Please enter Physical City.";
                //    mpeSeleccion.Show();
                //    return false;
                //}

                if (txtPhyState.Text.Trim() == "")
                {
                    lblRecHeader.Text = "Please enter Physical State.";
                    mpeSeleccion.Show();
                    return false;
                }

                if (txtPhyZipCode.Text.Trim() == "")
                {
                    lblRecHeader.Text = "Please enter Physical Zip Code.";
                    mpeSeleccion.Show();
                    return false;
                }

                if (taskControl.Mode == 1)
                {
                    lblRecHeader.Text = "Quote accepted succesfully!";
                }

                lblRecHeader.Text = "Application saved succesfully!";

            }


            return true;
        }

        protected bool ValidateAutoFieldsBeforeAdd()
        {
            if (ddlVehicleYear.SelectedItem.Text.ToString() == "")
            {
                lblRecHeader.Text = "Please select Vehicle Year.";
                mpeSeleccion.Show();
                //ddlVehicleYear.Focus();
                return false;
            }

            if (ddlVehicleMake.SelectedItem.Text.ToString() == "")
            {
                lblRecHeader.Text = "Please select Vehicle Make.";
                mpeSeleccion.Show();
                //ddlVehicleMake.Focus();
                return false;
            }

            if (ddlVehicleModel.SelectedItem.Text.ToString() == "")
            {
                lblRecHeader.Text = "Please select Vehicle Make.";
                mpeSeleccion.Show();
                //ddlVehicleModel.Focus();
                return false;
            }

            if (TxtVINNo.Text.Trim() == "" && lblQuoteType.Text != "QUICK QUOTE")
            {
                lblRecHeader.Text = "Please enter a VIN number.";
                mpeSeleccion.Show();
                //ddlVehicleModel.Focus();
                return false;
            }

            //if (TxtLicensePlateNo.Text.Trim() == "")
            //{
            //    lblRecHeader.Text = "Please enter a License Plate.";
            //    mpeSeleccion.Show();
            //    //ddlVehicleModel.Focus();
            //    return false;
            //}

            if (ddlIsland.SelectedItem.Text.ToString() == "")
            {
                lblRecHeader.Text = "Please select Island.";
                mpeSeleccion.Show();
                //ddlIsland.Focus();
                return false;
            }

            if (ddlVehicleUse.SelectedItem.Text.ToString() == "")
            {
                lblRecHeader.Text = "Please select Vehicle Use.";
                mpeSeleccion.Show();
                //ddlVehicleUse.Focus();
                return false;
            }

            if (TxtVehicleValue.Text.Trim().Replace("$", "") != "0")
            {
                if (int.Parse(TxtVehicleValue.Text.Trim().Replace("$", "").Replace(",", "")) <= 5000)
                {
                    lblRecHeader.Text = "Fullcover does not apply to vehicles of $5,000 and under.";
                    mpeSeleccion.Show();
                    TxtVehicleValue.Focus();
                    return false;
                }

                if (ddlVehicleYear.SelectedItem.Text.ToString() != "")
                {
                    if (DateTime.Now.Year - int.Parse(ddlVehicleYear.SelectedItem.Text.ToString().Trim()) >= 15)
                    {
                        lblRecHeader.Text = "Fullcover does not apply to vehicles of 15 years or older.";
                        mpeSeleccion.Show();
                        //ddlVehicleYear.Focus();
                        return false;
                    }
                }
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString().Trim() == "T")
            {

                if (TxtPassengerNo.Text.Trim() == "" || TxtPassengerNo.Text.Trim() == "0")
                {
                    lblRecHeader.Text = "Please enter number or passengers.";
                    mpeSeleccion.Show();
                    //TxtPassengerNo.Focus();
                    return false;
                }

                if (TxtVehicleValue.Text.Trim().Replace("$", "") == "0" && radTaxiDriverloss.SelectedIndex == 0)
                {
                    lblRecHeader.Text = "Additional Coverage \"Taxi Drivers Loss of Income\" does not apply to liability Only vehicles.";
                    mpeSeleccion.Show();
                    AccordionAddCoverage.SelectedIndex = 0;
                    //radTaxiDriverloss.Focus();
                    return false;
                }

            }

            if (ddlBankList.SelectedItem.Text.ToString() == "" && lblQuoteType.Text != "QUICK QUOTE")
            {
                lblRecHeader.Text = "Please select Loss Payee.";
                mpeSeleccion.Show();
                //ddlVehicleModel.Focus();
                return false;
            }

            if (TxtBirthDate.Text.Trim() == "" && lblQuoteType.Text != "QUICK QUOTE")
            {
                lblRecHeader.Text = "Please enter Date of Birth.";
                mpeSeleccion.Show();
                //ddlVehicleUse.Focus();
                return false;
            }


            return true;
        }

        #endregion Validate

        private void RemoveSessionLookUp()
        {
            Session.Remove("LookUpTables");
        }

        //Controls
        #region Buttons

        protected void SaveClick()
        {
            EPolicy.Login.Login cp = HttpContext.Current.User as EPolicy.Login.Login;

            int userID = 0;

            try
            {
                userID = int.Parse(cp.Identity.Name.Split("|".ToCharArray())[1]);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not parse user id from cp.Identity.Name.", ex);
            }

            try
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                ValidateFields();

                if (!ValidateFieldsBeforeSave())
                    return;

                if (ValidarDriverIsUnder26() && 1 == 0)
                {
                    if (taskControl.RenewalNo == "")
                    {
                        DataTable dtV = new DataTable();
                        if (taskControl.VehicleCollection != null)
                        {
                            dtV = taskControl.VehicleCollection;
                            for (int i = 0; i < dtV.Rows.Count; i++)
                            {
                                bool IsMotorcycle = false;

                                //if(dtV.Rows[i]["Comp"])
                                IsMotorcycle = bool.Parse(dtV.Rows[i]["IsMotorcycleScooter"].ToString()) == true ? true : false;

                                if ((dtV.Rows[i]["ComprehensiveDedu"].ToString().Trim().Replace("$", "") == "250" && dtV.Rows[i]["CollisionDedu"].ToString().Trim().Replace("$", "") == "500")
                                    || (dtV.Rows[i]["ComprehensiveDedu"].ToString().Trim().Replace("$", "") == "500" && dtV.Rows[i]["CollisionDedu"].ToString().Trim().Replace("$", "") == "500"))
                                {
                                    taskControl.VehicleCollection.Rows[i]["ComprehensiveDedu"] = "$500";
                                    taskControl.VehicleCollection.Rows[i]["CollisionDedu"] = "$1,000";
                                    taskControl.VehicleCollection.AcceptChanges();
                                    Calculate_Comp_Coll_MINOR(i);
                                    FillVehicleDetailGrid();
                                    //DataView dv = taskControl.VehicleCollection.DefaultView;
                                    //dv.Sort = "VehicleRowNumber";
                                    //taskControl.VehicleCollection = dv.ToTable();
                                    //taskControl.VehicleCollection.AcceptChanges();

                                    //dt = taskControl.VehicleCollection;

                                    if (taskControl.isQuote)
                                    {
                                        if (taskControl.TaskControlID != null)
                                            if (taskControl.TaskControlID != 0)// && (taskControl.RenewalNo.ToString() == "" && taskControl.CustomerCollection.ToString() == "0" ))
                                            {
                                                UpdateComp_Coll_VI(taskControl.TaskControlID, taskControl.isQuote, "$500", "$1,000", int.Parse(dtV.Rows[i]["VehicleDetailID"].ToString().Trim()));
                                                UpdateNetPremiumQuote_VI(taskControl.TaskControlID, IsMotorcycle, taskControl.RenewalNo, taskControl.CustomerCollection);
                                            }
                                    }
                                    else if (!taskControl.isQuote)
                                    {
                                        if (taskControl.TaskControlID != null)
                                            if (taskControl.TaskControlID != 0)// && (taskControl.RenewalNo.ToString() == "" && taskControl.CustomerCollection.ToString() == "0"))
                                            {
                                                UpdateComp_Coll_VI(taskControl.TaskControlID, taskControl.isQuote, "$500", "$1,000", int.Parse(dtV.Rows[i]["VehicleDetailID"].ToString().Trim()));
                                                UpdateNetPremiumPoliza_VI(taskControl.TaskControlID, IsMotorcycle, taskControl.RenewalNo, taskControl.CustomerCollection);
                                            }
                                    }
                                }
                                else
                                {
                                    Calculate_Comp_Coll_MINOR(i);
                                }

                                #region OLDCODE
                                //if (dtV.Rows[i]["ComprehensiveDedu"].ToString().Trim().Replace("$", "") == "500" && dtV.Rows[i]["CollisionDedu"].ToString().Trim().Replace("$", "") == "500")
                                //{
                                //    taskControl.VehicleCollection.Rows[i]["ComprehensiveDedu"] = "$500";
                                //    taskControl.VehicleCollection.Rows[i]["CollisionDedu"] = "$1,000";
                                //    taskControl.VehicleCollection.AcceptChanges();
                                //    Calculate_Comp_Coll_MINOR(i);
                                //    FillVehicleDetailGrid();
                                //    //DataView dv = taskControl.VehicleCollection.DefaultView;
                                //    //dv.Sort = "VehicleRowNumber";
                                //    //taskControl.VehicleCollection = dv.ToTable();
                                //    //taskControl.VehicleCollection.AcceptChanges();

                                //    //dt = taskControl.VehicleCollection;

                                //    if (taskControl.isQuote)
                                //    {
                                //        if (taskControl.TaskControlID != null)
                                //            if (taskControl.TaskControlID != 0)
                                //            {
                                //                UpdateComp_Coll_VI(taskControl.TaskControlID, taskControl.isQuote, "$500", "$1,000", int.Parse(dtV.Rows[i]["VehicleDetailID"].ToString().Trim()));
                                //                UpdateNetPremiumQuote_VI(taskControl.TaskControlID, IsMotorcycle, taskControl.RenewalNo, taskControl.CustomerCollection);
                                //            }
                                //    }
                                //    else
                                //    {
                                //        if (taskControl.TaskControlID != null)
                                //            if (taskControl.TaskControlID != 0)
                                //            {
                                //                UpdateComp_Coll_VI(taskControl.TaskControlID, taskControl.isQuote, "$500", "$1,000", int.Parse(dtV.Rows[i]["VehicleDetailID"].ToString().Trim()));
                                //                UpdateNetPremiumPoliza_VI(taskControl.TaskControlID, IsMotorcycle, taskControl.RenewalNo, taskControl.CustomerCollection);
                                //            }
                                //    }
                                //}

                                //if (dtV.Rows[i]["ComprehensiveDedu"].ToString().Trim().Replace("$", "") == "250" && dtV.Rows[i]["CollisionDedu"].ToString().Trim().Replace("$", "") == "500")
                                //{
                                //    taskControl.VehicleCollection.Rows[i]["ComprehensiveDedu"] = "$500";
                                //    taskControl.VehicleCollection.Rows[i]["CollisionDedu"] = "$1,000";
                                //    taskControl.VehicleCollection.AcceptChanges();
                                //    Calculate_Comp_Coll_MINOR(i);
                                //    FillVehicleDetailGrid();
                                //    //DataView dv = taskControl.VehicleCollection.DefaultView;
                                //    //dv.Sort = "VehicleRowNumber";
                                //    //taskControl.VehicleCollection = dv.ToTable();
                                //    //taskControl.VehicleCollection.AcceptChanges();

                                //    //dt = taskControl.VehicleCollection;

                                //    if (taskControl.isQuote)
                                //    {
                                //        if (taskControl.TaskControlID != null)
                                //            if (taskControl.TaskControlID != 0)
                                //            {
                                //                UpdateComp_Coll_VI(taskControl.TaskControlID, taskControl.isQuote, "$500", "$1,000", int.Parse(dtV.Rows[i]["VehicleDetailID"].ToString().Trim()));
                                //                UpdateNetPremiumQuote_VI(taskControl.TaskControlID, IsMotorcycle, taskControl.RenewalNo, taskControl.CustomerCollection);
                                //            }
                                //    }
                                //    else
                                //    {
                                //        if (taskControl.TaskControlID != null)
                                //            if (taskControl.TaskControlID != 0)
                                //            {
                                //                UpdateComp_Coll_VI(taskControl.TaskControlID, taskControl.isQuote, "$500", "$1,000", int.Parse(dtV.Rows[i]["VehicleDetailID"].ToString().Trim()));
                                //                UpdateNetPremiumPoliza_VI(taskControl.TaskControlID, IsMotorcycle, taskControl.RenewalNo, taskControl.CustomerCollection);
                                //            }
                                //    }
                                //}
                                #endregion OLDCODE
                            }
                        }
                    }
                }

                FillProperties();

                taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                taskControl.SaveAutos(userID);  //(userID);

                TaskControl.TaskControl taskControl2 = TaskControl.TaskControl.GetTaskControlByTaskControlID(taskControl.TaskControlID, userID);

                Session["TaskControl"] = taskControl2;

                DisableControls();
                FillTextControl();


            }
            catch (Exception exp)
            {
                lblRecHeader.Text = exp.Message + "";
                mpeSeleccion.Show();
            }
        }

        protected void btnSave_Click(object sender, EventArgs e)
        {
            SaveClick();
        }

        protected void btnEdit_Click(object sender, EventArgs e)
        {
            EPolicy.Login.Login cp = HttpContext.Current.User as EPolicy.Login.Login;
            try
            {
                if (!cp.IsInRole("ADMINISTRATOR"))
                {
                    VerifyPolicyExist();
                }
                ModifyClick();
            }
            catch (Exception exp)
            {
                lblRecHeader.Text = exp.Message + "";
                mpeSeleccion.Show();
            }
        }

        protected void VerifyPolicyExist()
        {
            try
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                DataTable dt = null;
                dt = GetVerifyPolicyExist_VI(taskControl.TaskControlID);

                if (dt != null)
                {
                    if (dt.Rows.Count > 0)
                    {
                        throw new Exception("This application has already been converted to Policy.");
                    }
                }
            }
            catch (Exception exp)
            {
                throw new Exception("This application has already been converted to Policy.");
            }
        }

        protected void ModifyClick()
        {
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
            taskControl.Mode = (int)EPolicy.TaskControl.TaskControl.TaskControlMode.UPDATE;

            Session.Add("TaskControl", taskControl);

            EnableControls();
            FillTextControl();
        }

        protected void btnCancel_Click(object sender, EventArgs e)
        {
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            EPolicy.Login.Login cp = HttpContext.Current.User as EPolicy.Login.Login;
            int userID = 0;

            try
            {
                userID = int.Parse(cp.Identity.Name.Split("|".ToCharArray())[1]);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not parse user id from cp.Identity.Name.", ex);
            }

            if (taskControl.Mode == 1) //ADD
            {
                Session.Clear();
                Response.Redirect("Search.aspx");
            }
            else
            {
                RemoveSessionLookUp();
                EPolicy.TaskControl.DoubleInterest optimaPersonalPackage = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
                //taskControl = (EPolicy.TaskControl.Autos)EPolicy.TaskControl.TaskControl.GetTaskControlByTaskControlID(taskControl.TaskControlID, userID);
                taskControl.Mode = (int)EPolicy.TaskControl.TaskControl.TaskControlMode.CLEAR;
                Session["TaskControl"] = taskControl;

                DisableControls();
                FillTextControl();

            }
        }

        protected void BtnExit_Click(object sender, EventArgs e)
        {
            RemoveSessionLookUp();
            Session.Clear();
            Response.Redirect("Search.aspx");
        }

        protected void btnConvert_Click(object sender, EventArgs e)
        {

            //No se usa
            EPolicy.TaskControl.DoubleInterest taskControlQuote = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            Session.Clear();
            EPolicy.TaskControl.DoubleInterest taskControl = new EPolicy.TaskControl.DoubleInterest(false);

            //taskControl = taskControlQuote;

            taskControl.Mode = 1; //ADD
            taskControl.isQuote = false;
            taskControl.TaskControlTypeID = int.Parse(EPolicy.LookupTables.LookupTables.GetID("TaskControlType", "Double Interest Policy"));
            taskControl.InsuranceCompany = taskControl.InsuranceCompany;
            taskControl.Agency = taskControl.Agency;
            taskControl.Agent = taskControl.Agent;
            taskControl.OriginatedAt = taskControl.OriginatedAt;
            taskControl.DepartmentID = 1;

            taskControl.Customer.FirstName = taskControlQuote.Customer.FirstName;
            taskControl.Customer.LastName1 = taskControlQuote.Customer.LastName1;
            taskControl.Customer.LastName2 = taskControlQuote.Customer.LastName2;
            taskControl.Customer.Initial = taskControlQuote.Customer.Initial;
            taskControl.Customer.Sex = taskControlQuote.Customer.Sex;
            taskControl.Customer.Address1 = taskControlQuote.Customer.Address1;
            taskControl.Customer.City = taskControlQuote.Customer.City;
            taskControl.Customer.State = taskControlQuote.Customer.State;
            taskControl.Customer.ZipCode = taskControlQuote.Customer.ZipCode;
            taskControl.Customer.Licence = taskControlQuote.Customer.Licence;
            taskControl.Customer.MaritalStatus = taskControlQuote.Customer.MaritalStatus;
            taskControl.Customer.Birthday = taskControlQuote.Customer.Birthday;
            taskControl.Customer.Age = taskControlQuote.Customer.Age;
            taskControl.Customer.JobPhone = taskControlQuote.Customer.JobPhone;
            taskControl.Customer.HomePhone = taskControlQuote.Customer.HomePhone;
            taskControl.Customer.OccupationID = taskControlQuote.Customer.OccupationID;
            taskControl.Customer.Occupation = taskControlQuote.Customer.Occupation;
            taskControl.Customer.EmplName = taskControlQuote.Customer.EmplName;
            taskControl.Customer.Address1 = taskControlQuote.Customer.Address1;
            taskControl.Customer.Address2 = taskControlQuote.Customer.Address2;
            taskControl.Customer.City = taskControlQuote.Customer.City;
            taskControl.Customer.State = taskControlQuote.Customer.State;
            taskControl.Customer.ZipCode = taskControlQuote.Customer.ZipCode;
            taskControl.Customer.AddressPhysical1 = taskControlQuote.Customer.AddressPhysical1;
            taskControl.Customer.AddressPhysical2 = taskControlQuote.Customer.AddressPhysical2;
            taskControl.Customer.CityPhysical = taskControlQuote.Customer.CityPhysical;
            taskControl.Customer.StatePhysical = taskControlQuote.Customer.StatePhysical;
            taskControl.Customer.ZipPhysical = taskControlQuote.Customer.ZipPhysical;


            taskControl.CompanyDealer = taskControlQuote.CompanyDealer;
            taskControl.InsuranceCompany = taskControlQuote.InsuranceCompany;
            taskControl.OriginatedAt = taskControlQuote.OriginatedAt;
            taskControl.Agent = taskControlQuote.Agent;
            taskControl.Agency = taskControlQuote.Agency;

            taskControl.CancellationDate = taskControlQuote.CancellationDate;
            taskControl.CancellationEntryDate = "";
            taskControl.CancellationUnearnedPercent = taskControlQuote.CancellationUnearnedPercent;
            taskControl.CancellationMethod = taskControlQuote.CancellationMethod;
            taskControl.CancellationReason = taskControlQuote.CancellationReason;
            taskControl.PaidAmount = taskControlQuote.PaidAmount;
            taskControl.PaidDate = "";
            taskControl.Ren_Rei = taskControlQuote.Ren_Rei;
            taskControl.CommissionAgency = taskControlQuote.CommissionAgency; // taskControl.ReturnCommissionAgency;
            taskControl.CommissionAgent = taskControlQuote.CommissionAgent; // taskControl.ReturnCommissionAgent;
            taskControl.CommissionAgencyPercent = taskControlQuote.CommissionAgencyPercent; // taskControl.CommissionAgencyPercent.Trim();
            taskControl.CommissionAgentPercent = taskControlQuote.CommissionAgentPercent;  //taskControl.CommissionAgentPercent.Trim();
            taskControl.TaskControlID = taskControlQuote.TaskControlID;
            taskControl.Status = taskControlQuote.Status;
            taskControl.ReturnCharge = taskControlQuote.ReturnCharge;
            taskControl.ReturnPremium = taskControlQuote.ReturnPremium;
            taskControl.CancellationAmount = taskControlQuote.CancellationAmount;
            taskControl.ReturnCommissionAgency = taskControlQuote.ReturnCommissionAgency;
            taskControl.ReturnCommissionAgent = taskControlQuote.ReturnCommissionAgent;

            taskControl.CustomerCollection = taskControlQuote.CustomerCollection;
            taskControl.TotalDiscounts = taskControlQuote.TotalDiscounts;
            taskControl.TotalDiscountsPct = taskControlQuote.TotalDiscountsPct;

            taskControl.AnyAccidentsOrLosses = taskControlQuote.AnyAccidentsOrLosses;
            taskControl.IsNewCustomer = taskControlQuote.IsNewCustomer;
            taskControl.YearsWithNoClaims = taskControlQuote.YearsWithNoClaims;
            taskControl.AnyDriverUnder26 = taskControlQuote.AnyDriverUnder26;

            taskControl.Q1 = taskControlQuote.Q1;
            taskControl.Q2 = taskControlQuote.Q2;
            taskControl.Q3 = taskControlQuote.Q3;



            taskControl.EntryDate = DateTime.Now;
            taskControl.Term = taskControl.Term;

            taskControl.DriversCollection = taskControlQuote.DriversCollection;
            taskControl.VehicleCollection = taskControlQuote.VehicleCollection;

            taskControl.TotalPremium = taskControlQuote.TotalPremium;
            taskControl.Charge = taskControlQuote.Charge;
            taskControl.Terms = taskControlQuote.Terms;

            taskControl.isBusinessPolicy = chkIsBusinessAutoQuote.Checked;


            //FillVehicleDetailGridToConvert(taskControlQuote);
            //FillDriverDetailGridToConvert(taskControlQuote);


            #region comment
            //taskControl.Agent = taskControlQuote.Agent;
            //taskControl.AgentList = taskControlQuote.AgentList;
            //taskControl.AgentSelectedTable = taskControlQuote.AgentSelectedTable;
            //taskControl.Aging = taskControlQuote.Aging;
            //taskControl.AutoAssignPolicy = taskControlQuote.AutoAssignPolicy;
            //taskControl.AutoType = taskControlQuote.AutoType;
            //taskControl.Bank = taskControlQuote.Bank;
            //taskControl.Certificate = taskControlQuote.Certificate;
            //taskControl.Charge = taskControlQuote.Charge;
            //taskControl.CommissionAgency = taskControlQuote.CommissionAgency;
            //taskControl.CommissionAgencyPercent = taskControlQuote.CommissionAgencyPercent;
            //taskControl.CommissionAgent = taskControlQuote.CommissionAgent;
            //taskControl.CommissionAgentPercent = taskControlQuote.CommissionAgentPercent;
            //taskControl.CommissionDate = taskControlQuote.CommissionDate;
            //taskControl.CompanyDealer = taskControlQuote.CompanyDealer;
            //taskControl.CompanyDealerObject = taskControlQuote.CompanyDealerObject;
            //taskControl.EffectiveDate = taskControlQuote.EffectiveDate;
            //taskControl.ExpirationDate = taskControlQuote.ExpirationDate;
            //taskControl.LbxAgentSelected = taskControlQuote.LbxAgentSelected;
            //taskControl.LbxSupplierSelected = taskControlQuote.LbxSupplierSelected;
            //taskControl.OriginatedAt = taskControlQuote.OriginatedAt;
            //taskControl.PolicyClassID = taskControlQuote.PolicyClassID;
            //taskControl.SupplierID = taskControlQuote.SupplierID;
            //taskControl.SupplierList = taskControlQuote.SupplierList;
            //taskControl.SupplierSelectedTable = taskControlQuote.SupplierSelectedTable;
            //taskControl.Term = taskControlQuote.Term;
            //taskControl.TotalPremium = taskControlQuote.TotalPremium;
            //taskControl.Customer.ProspectID = taskControlQuote.Prospect.ProspectID;
            //taskControl.Customer.FirstName = taskControlQuote.Prospect.FirstName;
            //taskControl.Customer.LastName1 = taskControlQuote.Prospect.LastName1;
            //taskControl.Customer.LastName2 = taskControlQuote.Prospect.LastName2;
            //taskControl.Customer.HomePhone = taskControlQuote.Prospect.HomePhone;
            //taskControl.Customer.JobPhone = taskControlQuote.Prospect.WorkPhone;
            //taskControl.Customer.Cellular = taskControlQuote.Prospect.Cellular;
            //taskControl.Customer.Email = taskControlQuote.Prospect.Email;
            #endregion

            Session.Add("TaskControl", taskControl);

            Response.Redirect("DoubleInterest.aspx");
        }

        protected void UnHideControls()
        {



        }

        protected void btnRenew_Click(object sender, EventArgs e)
        {
            EPolicy.Login.Login cp = HttpContext.Current.User as EPolicy.Login.Login;
            int userID = 0;
            userID = int.Parse(cp.Identity.Name.Split("|".ToCharArray())[1]);
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            //Session.Clear();
            EPolicy.TaskControl.DoubleInterest taskControlQuote = new EPolicy.TaskControl.DoubleInterest(true);

            int tcID = taskControl.TaskControlID;
            taskControlQuote = taskControl;

            taskControlQuote.Mode = 1; //ADD
            taskControlQuote.TaskControlID = 0;
            //taskControlQuote.Umbrella = taskControl.Umbrella;
            //taskControlQuote.Umbrella.TaskControlID = 0;
            taskControlQuote.isQuote = true;//false;
            taskControlQuote.IsEndorsement = false;
            taskControlQuote.TaskControlTypeID = int.Parse(EPolicy.LookupTables.LookupTables.GetID("TaskControlType", "Double Interest Policy Quote"));

            taskControlQuote.Endoso = 0;

            taskControlQuote.Agency = taskControl.Agency;
            taskControlQuote.Agent = taskControl.Agent;
            taskControlQuote.Bank = taskControl.Bank;

            taskControlQuote.Customer.FirstName = taskControl.Customer.FirstName;
            taskControlQuote.Customer.LastName1 = taskControl.Customer.LastName1;
            taskControlQuote.Customer.LastName2 = taskControl.Customer.LastName2;
            taskControlQuote.Customer.Initial = taskControl.Customer.Initial;
            taskControlQuote.Customer.Sex = taskControl.Customer.Sex;
            taskControlQuote.Customer.Address1 = taskControl.Customer.Address1;
            taskControlQuote.Customer.City = taskControl.Customer.City;
            taskControlQuote.Customer.State = taskControl.Customer.State;
            taskControlQuote.Customer.ZipCode = taskControl.Customer.ZipCode;
            taskControlQuote.Customer.Licence = taskControl.Customer.Licence;
            taskControlQuote.Customer.MaritalStatus = taskControl.Customer.MaritalStatus;
            taskControlQuote.Customer.Birthday = taskControl.Customer.Birthday;
            taskControlQuote.Customer.Age = taskControl.Customer.Age;
            taskControlQuote.Customer.JobPhone = taskControl.Customer.JobPhone;
            taskControlQuote.Customer.HomePhone = taskControl.Customer.HomePhone;
            taskControlQuote.Customer.OccupationID = taskControl.Customer.OccupationID;
            taskControlQuote.Customer.Occupation = taskControl.Customer.Occupation;
            taskControlQuote.Customer.EmplName = taskControl.Customer.EmplName;

            //taskControlQuote.AdditionalCoveragesLiabilityCollection = taskControl.AdditionalCoveragesLiabilityCollection;

            taskControlQuote.CompanyDealer = taskControl.CompanyDealer;
            taskControlQuote.InsuranceCompany = taskControl.InsuranceCompany;
            taskControlQuote.OriginatedAt = taskControl.OriginatedAt;

            taskControlQuote.EntryDate = DateTime.Now;
            taskControlQuote.Term = taskControl.Term;
            taskControlQuote.EffectiveDate = (DateTime.Parse(taskControl.EffectiveDate).AddMonths(12)).ToShortDateString();
            taskControlQuote.ExpirationDate = DateTime.Parse(taskControl.ExpirationDate).AddMonths(12).ToShortDateString();

            taskControlQuote.CancellationDate = "";
            taskControlQuote.CancellationEntryDate = "";
            taskControlQuote.CancellationUnearnedPercent = 0.00;
            taskControlQuote.CancellationMethod = 0;
            taskControlQuote.CancellationReason = 0;
            taskControlQuote.PaidAmount = taskControl.PaidAmount;
            taskControlQuote.PaidDate = "";
            taskControlQuote.Ren_Rei = "RN";
            taskControlQuote.CommissionAgency = 0.00; // taskControl.ReturnCommissionAgency;
            taskControlQuote.CommissionAgent = 0.00; // taskControl.ReturnCommissionAgent;
            taskControlQuote.CommissionAgencyPercent = ""; // taskControl.CommissionAgencyPercent.Trim();
            taskControlQuote.CommissionAgentPercent = "";  //taskControl.CommissionAgentPercent.Trim();
            taskControlQuote.TaskControlID = 0;
            taskControlQuote.Status = "Inforce";
            taskControlQuote.ReturnCharge = 0.00;
            taskControlQuote.ReturnPremium = 0.00;
            taskControlQuote.CancellationAmount = 0.00;
            taskControlQuote.ReturnCommissionAgency = 0.00;
            taskControlQuote.ReturnCommissionAgent = 0.00;

            int msufijo;
            int sufijo = int.Parse(taskControl.Suffix);
            msufijo = sufijo + 1;
            taskControlQuote.Suffix = DateTime.Parse(taskControl.EffectiveDate.ToString()).Year.ToString().Substring(2, 2); //"0".ToString() + msufijo.ToString();
            taskControlQuote.AutoAssignPolicy = false;

            taskControlQuote.RenewalNo = taskControl.PolicyType.ToString().Trim() + int.Parse(taskControl.PolicyNo.ToString().Trim()).ToString() + "-" + (int.Parse(taskControlQuote.Suffix.ToString().Trim()) - 1).ToString();

            taskControlQuote.CustomerCollection = "0";// Puede recalcular la prima

            taskControlQuote.PolicyCicleEnd = 1; //Para que en la pantalla de auto no entre de modo new.
            taskControlQuote.PMT1 = 0;
            taskControlQuote.Agent = taskControl.Agent;
            taskControlQuote.Agency = taskControl.Agency;
            taskControlQuote.InsuranceCompany = "001";  //INS.
            taskControlQuote.Terms = taskControl.Terms;

            taskControlQuote.LbxAgentSelected = taskControl.LbxAgentSelected;
            taskControlQuote.LbxAgentSelected = taskControl.LbxAgentSelected;

            taskControlQuote.TotalDiscounts = taskControl.TotalDiscounts;
            taskControlQuote.TotalDiscountsPct = taskControl.TotalDiscountsPct;

            taskControlQuote.DriversCollection = taskControl.DriversCollection.Copy();
            taskControlQuote.VehicleCollection = taskControl.VehicleCollection.Copy();

            if (taskControlQuote.VehicleCollection.Rows.Count > 0)
            {
                int CountVehicles = 0;
                for (int i = 0; taskControlQuote.VehicleCollection.Rows.Count > i; i++)
                {
                    CountVehicles++;

                    string Island = taskControlQuote.VehicleCollection.Rows[i]["Island"].ToString().Trim() == "St. Thomas" ? "1" : taskControlQuote.VehicleCollection.Rows[i]["Island"].ToString().Trim() == "St. Croix" ? "2" : "3";
                    string UseCode = taskControlQuote.VehicleCollection.Rows[i]["VehicleUse"].ToString().Trim() == "Commercial" ? "C" : taskControlQuote.VehicleCollection.Rows[i]["VehicleUse"].ToString().Trim() == "Private Passenger" ? "O" : taskControlQuote.VehicleCollection.Rows[i]["VehicleUse"].ToString().Trim() == "Private" ? "P" : taskControlQuote.VehicleCollection.Rows[i]["VehicleUse"].ToString().Trim() == "Rental" ? "R" : "T";

                    int MostMinor = 0;
                    double Depreciation = 0;

                    for (int M = 0; M < taskControl.DriversCollection.Rows.Count; M++)
                    {
                        MostMinor = int.Parse(taskControl.DriversCollection.Rows[0]["DriverAge"].ToString().Trim());
                        if (MostMinor > int.Parse(taskControl.DriversCollection.Rows[M]["DriverAge"].ToString().Trim()))
                        {
                            MostMinor = int.Parse(taskControl.DriversCollection.Rows[M]["DriverAge"].ToString().Trim());
                        }
                        else
                        {
                            MostMinor = int.Parse(taskControl.DriversCollection.Rows[0]["DriverAge"].ToString().Trim());
                        }
                    }

                    //TODO TERMINAR COMPARACION DE EFFDATE y VEHICLEYEAR ENTRE MESES SEPTIEMBRE LLEGAN AUTOS DEL PROX. ANO SEP 2018 salen 2019
                    //Si es el Primer año la depreciación es 7.5% (0.925)

                    DateTime CarDate = new DateTime(int.Parse(taskControlQuote.VehicleCollection.Rows[i]["VehicleYear"].ToString().Trim()) - 1, 9, 1);

                    int dateMonths = 0;
                    dateMonths = ((DateTime.Parse(taskControl.EffectiveDate.ToString()).Year - CarDate.Year) * 12) + DateTime.Parse(taskControl.EffectiveDate.ToString()).Month - CarDate.Month;

                    //Si es el Primer año la depreciación es 7.5%
                    if (dateMonths >= 12)
                    {
                        //==============================================//
                        //(0.975) = depreciación de 2.5% FULLCOVER ONLY //
                        //==============================================//
                        Depreciation = 0.975;
                    }
                    else
                    {
                        //==============================================//
                        //(0.925) = depreciación de 7.5% FULLCOVER ONLY //
                        //==============================================//
                        Depreciation = 0.925;
                    }

                    if (taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"] != null)
                    {
                        if (taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim() != "" && taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim() != "0")
                        {
                            taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"] = (Math.Round(float.Parse(taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim()) * Depreciation, 0)).ToString();
                            DataTable dtPhsDam = GetPhysicalDamageRates(UseCode, Island, int.Parse(taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), "N", int.Parse(taskControlQuote.VehicleCollection.Rows[i]["VehicleYear"].ToString().Trim()), MostMinor, int.Parse(taskControlQuote.VehicleCollection.Rows[i]["PassengersNo"].ToString().Trim()));

                            #region Ya no se va a retarifar el comp y coll de la renovacion

                            //FillPhysDam(UseCode, Island, int.Parse(taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), "N", int.Parse(taskControlQuote.VehicleCollection.Rows[i]["VehicleYear"].ToString().Trim()), MostMinor, int.Parse(taskControlQuote.VehicleCollection.Rows[i]["PassengersNo"].ToString().Trim()));
                            //ddlCompCollDed.SelectedIndex = 0;
                            //SetCompCollDeductible();

                            //taskControlQuote.VehicleCollection.Rows[i]["ComprehensiveDedu"] = ddlDedComp.SelectedItem.Value.ToString();
                            //taskControlQuote.VehicleCollection.Rows[i]["CollisionDedu"] = ddlDedColl.SelectedItem.Value.ToString();

                            //if (ddlDedComp.SelectedItem.Value.ToString() == "$250" && ddlDedColl.SelectedItem.Value.ToString() == "$500")
                            //{
                            //    if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                            //    {
                            //        taskControlQuote.VehicleCollection.Rows[i]["CompPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Comp250_500"].ToString()) * float.Parse(taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();

                            //        taskControlQuote.VehicleCollection.Rows[i]["CollPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Coll250_500"].ToString()) * float.Parse(taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();
                            //    }
                            //    else
                            //    {
                            //        taskControlQuote.VehicleCollection.Rows[i]["CompPremium"] = dtPhsDam.Rows[0]["Comp250_500"].ToString();
                            //        taskControlQuote.VehicleCollection.Rows[i]["CollPremium"] = dtPhsDam.Rows[0]["Coll250_500"].ToString();
                            //    }
                            //}
                            //else if (ddlDedComp.SelectedItem.Value.ToString() == "$500" && ddlDedColl.SelectedItem.Value.ToString() == "$500")
                            //{
                            //    if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                            //    {
                            //        taskControlQuote.VehicleCollection.Rows[i]["CompPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Comp500_500"].ToString()) * float.Parse(taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();

                            //        taskControlQuote.VehicleCollection.Rows[i]["CollPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Coll500_500"].ToString()) * float.Parse(taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();
                            //    }
                            //    else
                            //    {
                            //        taskControlQuote.VehicleCollection.Rows[i]["CompPremium"] = dtPhsDam.Rows[0]["Comp500_500"].ToString();
                            //        taskControlQuote.VehicleCollection.Rows[i]["CollPremium"] = dtPhsDam.Rows[0]["Coll500_500"].ToString();
                            //    }
                            //}
                            //else if (ddlDedComp.SelectedItem.Value.ToString() == "$500" && ddlDedColl.SelectedItem.Value.ToString() == "$1,000")
                            //{
                            //    if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                            //    {
                            //        taskControlQuote.VehicleCollection.Rows[i]["CompPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Comp500_1000"].ToString()) * float.Parse(taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();

                            //        taskControlQuote.VehicleCollection.Rows[i]["CollPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Coll500_1000"].ToString()) * float.Parse(taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();
                            //    }
                            //    else
                            //    {
                            //        taskControlQuote.VehicleCollection.Rows[i]["CompPremium"] = dtPhsDam.Rows[0]["Comp500_1000"].ToString();
                            //        taskControlQuote.VehicleCollection.Rows[i]["CollPremium"] = dtPhsDam.Rows[0]["Coll500_1000"].ToString();
                            //    }
                            //}
                            //else if (ddlDedComp.SelectedItem.Value.ToString() == "$1,000" && ddlDedColl.SelectedItem.Value.ToString() == "$1,000")
                            //{
                            //    if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                            //    {
                            //        taskControlQuote.VehicleCollection.Rows[i]["CompPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Comp1000_1000"].ToString()) * float.Parse(taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();

                            //        taskControlQuote.VehicleCollection.Rows[i]["CollPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Coll1000_1000"].ToString()) * float.Parse(taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();
                            //    }
                            //    else
                            //    {
                            //        taskControlQuote.VehicleCollection.Rows[i]["CompPremium"] = dtPhsDam.Rows[0]["Comp1000_1000"].ToString();
                            //        taskControlQuote.VehicleCollection.Rows[i]["CollPremium"] = dtPhsDam.Rows[0]["Coll1000_1000"].ToString();
                            //    }
                            //}
                            //else if (ddlDedComp.SelectedItem.Value.ToString() == "$1,000" && ddlDedColl.SelectedItem.Value.ToString() == "$1,500")
                            //{
                            //    if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                            //    {
                            //        taskControlQuote.VehicleCollection.Rows[i]["CompPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Comp1000_1500"].ToString()) * float.Parse(taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();

                            //        taskControlQuote.VehicleCollection.Rows[i]["CollPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Coll1000_1500"].ToString()) * float.Parse(taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();
                            //    }
                            //    else
                            //    {
                            //        taskControlQuote.VehicleCollection.Rows[i]["CompPremium"] = dtPhsDam.Rows[0]["Comp1000_1500"].ToString();
                            //        taskControlQuote.VehicleCollection.Rows[i]["CollPremium"] = dtPhsDam.Rows[0]["Coll1000_1500"].ToString();
                            //    }
                            //}
                            //else if (ddlDedComp.SelectedItem.Value.ToString() == "$1,000" && ddlDedColl.SelectedItem.Value.ToString() == "$2,500")
                            //{
                            //    if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                            //    {
                            //        taskControlQuote.VehicleCollection.Rows[i]["CompPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Comp1000_2500"].ToString()) * float.Parse(taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();

                            //        taskControlQuote.VehicleCollection.Rows[i]["CollPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Coll1000_2500"].ToString()) * float.Parse(taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();
                            //    }
                            //    else
                            //    {
                            //        taskControlQuote.VehicleCollection.Rows[i]["CompPremium"] = dtPhsDam.Rows[0]["Comp1000_2500"].ToString();
                            //        taskControlQuote.VehicleCollection.Rows[i]["CollPremium"] = dtPhsDam.Rows[0]["Coll1000_2500"].ToString();
                            //    }
                            //}
                            //else if (ddlDedComp.SelectedItem.Value.ToString() == "$1,500" && ddlDedColl.SelectedItem.Value.ToString() == "$2,500")
                            //{
                            //    if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                            //    {
                            //        taskControlQuote.VehicleCollection.Rows[i]["CompPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Comp1500_2500"].ToString()) * float.Parse(taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();

                            //        taskControlQuote.VehicleCollection.Rows[i]["CollPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Coll1500_2500"].ToString()) * float.Parse(taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();
                            //    }
                            //    else
                            //    {
                            //        taskControlQuote.VehicleCollection.Rows[i]["CompPremium"] = dtPhsDam.Rows[0]["Comp1500_2500"].ToString();
                            //        taskControlQuote.VehicleCollection.Rows[i]["CollPremium"] = dtPhsDam.Rows[0]["Coll1500_2500"].ToString();
                            //    }
                            //}
                            //else if (ddlDedComp.SelectedItem.Value.ToString() == "$2,500" && ddlDedColl.SelectedItem.Value.ToString() == "$5,000")
                            //{
                            //    if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                            //    {
                            //        taskControlQuote.VehicleCollection.Rows[i]["CompPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Comp2500_5000"].ToString()) * float.Parse(taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();

                            //        taskControlQuote.VehicleCollection.Rows[i]["CollPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Coll2500_5000"].ToString()) * float.Parse(taskControlQuote.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();
                            //    }
                            //    else
                            //    {
                            //        taskControlQuote.VehicleCollection.Rows[i]["CompPremium"] = dtPhsDam.Rows[0]["Comp2500_5000"].ToString();
                            //        taskControlQuote.VehicleCollection.Rows[i]["CollPremium"] = dtPhsDam.Rows[0]["Coll2500_5000"].ToString();
                            //    }
                            //}
                            #endregion
                            taskControlQuote.VehicleCollection.AcceptChanges();
                            Session["TaskControl"] = taskControlQuote;
                        }
                        else
                        {
                            //C	Commercial
                            //O	Private Passenger
                            //P	Private
                            //R	Rental
                            //T	Taxi

                            string Motorcycle = (bool)taskControlQuote.VehicleCollection.Rows[i]["IsMotorcycleScooter"] == true ? "Y" : "N";
                            String[] Rates = new String[3];
                            Rates = CompareRenewalLiabRates(taskControlQuote.VehicleCollection.Rows[i]["BIPremium"].ToString(), taskControlQuote.VehicleCollection.Rows[i]["PDPremium"].ToString(), taskControlQuote.VehicleCollection.Rows[i]["MPPremium"].ToString(), UseCode, Island, "N", Motorcycle, taskControlQuote.VehicleCollection.Rows[i]["PassengersNo"].ToString(), "N");
                            taskControlQuote.VehicleCollection.Rows[i]["BIPremium"] = Rates[0];
                            taskControlQuote.VehicleCollection.Rows[i]["PDPremium"] = Rates[1];
                            taskControlQuote.VehicleCollection.Rows[i]["MPPremium"] = Rates[2];
                        }

                        CompareTotalPremium(CountVehicles == taskControlQuote.VehicleCollection.Rows.Count ? true : false, i, tcID);
                    }
                }
            }

            #region comment
            //taskControlQuote.QuoteAuto = taskControl.QuoteAuto;
            //taskControlQuote.QuoteAuto.Mode = 1;
            //taskControlQuote.QuoteAuto.QuoteId = 0;
            //taskControlQuote.QuoteAuto.IsPolicy = false;
            //taskControlQuote.QuoteAuto.EffectiveDate = (DateTime.Parse(taskControl.EffectiveDate).AddMonths(12)).ToShortDateString();
            //taskControlQuote.QuoteAuto.ExpirationDate = DateTime.Parse(taskControl.ExpirationDate).AddMonths(12).ToShortDateString();

            ////Fill Auto Information from Application Auto or of the Quote.
            //EPolicy.Quotes.AutoCover AC = new EPolicy.Quotes.AutoCover();
            //EPolicy.Quotes.AutoDriver AD = new EPolicy.Quotes.AutoDriver();

            //for (int i = 0; i < taskControlQuote.QuoteAuto.Drivers.Count; i++)
            //{
            //    AD = (EPolicy.Quotes.AutoDriver)taskControlQuote.QuoteAuto.Drivers[i];
            //    AD.Mode = 1;
            //    taskControlQuote.QuoteAuto.Save(userID, null, AD, false);
            //}

            //for (int i = 0; i < taskControlQuote.QuoteAuto.AutoCovers.Count; i++)
            //{
            //    AC = (EPolicy.Quotes.AutoCover)taskControlQuote.QuoteAuto.AutoCovers[i];
            //    AC.Mode = 1;

            //    //Calcular Depreciacion
            //    double cost = double.Parse(AC.ActualValue.ToString());
            //    double totcost = cost * 0.85;

            //    AC.Cost = AC.Cost;  //decimal.Parse(totcost.ToString());
            //    AC.ActualValue = decimal.Parse(totcost.ToString());

            //    taskControlQuote.QuoteAuto.Save(userID, AC, null, false);
            //}
            #endregion

            taskControlQuote.TaskControlID = taskControlQuote.TaskControlID;

            EPolicy.TaskControl.DoubleInterest taskControl2 = (EPolicy.TaskControl.DoubleInterest)EPolicy.TaskControl.TaskControl.GetTaskControlByTaskControlID(tcID, userID);

            string RenewalPremium = String.Empty;
            if (Session["RenewalPremium"] != null)
            {
                RenewalPremium = Session["RenewalPremium"].ToString();
            }
            else
            {
                RenewalPremium = null;
            }

            Session.Clear();
            Session.Add("RenewalPremium", RenewalPremium);
            Session.Add("TaskControl", taskControlQuote);
            Response.Redirect("DoubleInterest.aspx");
        }

        protected void btnCancellation_Click(object sender, EventArgs e)
        {

            RemoveSessionLookUp();
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
            Session.Add("TaskControl", taskControl);
            Session.Add("FromUI", "DoubleInterest.aspx");
            Session.Add("CancFromAutos", "CancFromAutos");
            // Session.Add("CancFromRoadAssistanceExit", "CancFromRoadAssistanceExit");
            Response.Redirect("CancellationPolicy.aspx", false);
        }

        protected void btnReinstallation_Click(object sender, EventArgs e)
        {
            try
            {
                EPolicy.Login.Login cp = HttpContext.Current.User as EPolicy.Login.Login;
                int userID = 0;
                userID = int.Parse(cp.Identity.Name.Split("|".ToCharArray())[1]);

                TaskControl.DoubleInterest taskControl = new TaskControl.DoubleInterest(false);  /**Policy**/
                TaskControl.DoubleInterest Autos = (TaskControl.DoubleInterest)Session["TaskControl"];

                EPolicy.TaskControl.DoubleInterest taskControlEndo = null;

                taskControl = Autos;

                //taskControl.IsPolicy = true;
                taskControl.Mode = 1;
                taskControl.isQuote = false;
                taskControl.TaskControlTypeID = 31; // Autos
                taskControl.TaskControlID = Autos.TaskControlID;
                taskControl.IsEndorsement = false;
                taskControl.CancellationDate = "";
                taskControl.CancellationEntryDate = "";
                taskControl.CancellationUnearnedPercent = 0.00;
                taskControl.CancellationMethod = 0;
                taskControl.CancellationReason = 0;
                taskControl.PaidAmount = taskControl.PaidAmount;
                taskControl.PaidDate = "";
                taskControl.Ren_Rei = "REI";
                taskControl.Rein_Amt = Autos.CancellationAmount;
                taskControl.PaidDate = Autos.PaidDate;
                taskControl.CommissionAgency = 0.00; // taskControl.ReturnCommissionAgency;
                taskControl.CommissionAgent = 0.00; // taskControl.ReturnCommissionAgent;
                taskControl.CommissionAgencyPercent = ""; // taskControl.CommissionAgencyPercent.Trim();
                taskControl.CommissionAgentPercent = "";  //taskControl.CommissionAgentPercent.Trim();
                //taskControl.TaskControlID = 0;
                taskControl.Status = "Reinstatement";

                taskControl.ReturnCharge = 0.00;
                taskControl.ReturnPremium = 0.00;
                taskControl.CancellationAmount = 0.00;
                taskControl.ReturnCommissionAgency = 0.00;
                taskControl.ReturnCommissionAgent = 0.00;

                taskControl.IsDeferred = false;
                taskControl.Agency = Autos.Agency;
                taskControl.Agent = Autos.Agent;
                taskControl.Bank = Autos.Bank;
                taskControl.CompanyDealer = Autos.CompanyDealer;
                taskControl.InsuranceCompany = Autos.InsuranceCompany;

                taskControl.AgentList = Autos.AgentList;
                taskControl.LbxAgentSelected = Autos.LbxAgentSelected;
                taskControl.LbxAgentSelected = Autos.LbxAgentSelected;

                taskControl.Customer = Autos.Customer; // quoteAuto.Customer;
                taskControl.CustomerNo = Autos.Customer.CustomerNo; // quoteAuto.CustomerNo;
                taskControl.Prospect = Autos.Prospect;
                taskControl.ProspectID = Autos.ProspectID;
                taskControl.Term = Autos.Term;
                taskControl.EffectiveDate = DateTime.Now.ToShortDateString();
                taskControl.ExpirationDate = DateTime.Parse(Autos.ExpirationDate).AddYears(int.Parse(taskControl.Terms) / 12).ToShortDateString();
                taskControl.EntryDate = DateTime.Now;

                taskControl.PolicyType = Autos.PolicyType;

                //taskControl.OriginatedAt = int.Parse(ddlLocation.SelectedItem.Value);

                if (Autos.MasterPolicyID.Trim() == "")
                    taskControl.IsMaster = false; // quoteAuto.IsMaster;
                else
                    taskControl.IsMaster = true;

                taskControl.MasterPolicyID = Autos.MasterPolicyID;
                taskControl.FileNumber = Autos.FileNumber;
                taskControl.PolicyType = Autos.PolicyType;
                taskControl.PolicyNo = Autos.PolicyNo;
                taskControl.Certificate = Autos.Certificate;
                taskControl.AutoAssignPolicy = false;

                taskControl.VehicleCollection = Autos.VehicleCollection;
                taskControl.DriversCollection = Autos.DriversCollection;

                //taskControl.XtraVIN = TxtVINNo.Text.ToString().Trim();
                //taskControl.Plate = TxtLicenseNumber.Text.ToString().Trim();
                //taskControl.XtraVehicleMake = ddlVehicleMake.SelectedItem.Text.ToString();
                //taskControl.XtraVehicleModel = ddlVehicleModel.SelectedItem.Text.ToString().Trim();
                //taskControl.XtraVehicleYear = ddlVehicleYear.SelectedItem.Text.ToString().Trim();

                int msufijo;
                int sufijo = int.Parse(Autos.Suffix);
                msufijo = sufijo + 1;
                taskControl.Suffix = "0".ToString() + msufijo.ToString();
                // taskControl.Suffix = GuardianXtra.Suffix;

                taskControl.PolicyCicleEnd = 1; //Para que en la pantalla de auto no entre de modo new.
                taskControl.Agent = Autos.Agent;
                taskControl.Agency = Autos.Agency;
                taskControl.InsuranceCompany = Autos.InsuranceCompany;//"001";  //
                taskControl.PMT1 = 0;
                //taskControl.QuoteId = 0;

                taskControl.Charge = Autos.Charge;
                taskControl.TotalPremium = Autos.TotalPremium;

                //taskControl.PolicyNo = (int.Parse(Autos.PolicyNo) + 1).ToString();//.ToString("0000000");

                // taskControl.TaskControlID = 0;

                Session.Clear();
                Session.Add("TaskControl", taskControl);

                SaveClick();

                taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                UpdatePolicyMode_VI(taskControl.TaskControlID, "3");
                UpdatePolicyTC_VI(taskControl.TaskControlID, Autos.TaskControlID.ToString());
                //UpdatePolicyFromPPSByTaskControlID(taskControl.TaskControlID, (int.Parse(Autos.PolicyNo) + 1).ToString(), "");
                FillTextControl();

                Response.Redirect("DoubleInterest.aspx", false);

            }
            catch (Exception exp)
            {
                lblRecHeader.Text = exp.Message;
                mpeSeleccion.Show();
            }
        }

        protected void btnDelete_Click(object sender, EventArgs e)
        {
            //if (bool.Parse(ConfirmDialogBoxPopUp.Value.Trim()) == true)
            //{
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
            try
            {
                int i = taskControl.TaskControlID;
                EPolicy.TaskControl.DoubleInterest.DeleteAutosByTaskControlID(i, taskControl.isQuote);

                Session.Clear();
                Response.Redirect("Search.aspx");
            }
            catch (Exception exp)
            {
                lblRecHeader.Text = exp.Message;
                mpeSeleccion.Show();
            }
            //}
        }

        protected void btnAdd2_Click(object sender, EventArgs e)
        {
            Session.Clear();
            EPolicy.TaskControl.DoubleInterest taskControl = new EPolicy.TaskControl.DoubleInterest(true);

            taskControl.Mode = 1; //ADD
            taskControl.isQuote = true;
            taskControl.TaskControlTypeID = int.Parse(EPolicy.LookupTables.LookupTables.GetID("TaskControlType", "Double Interest Policy Quote"));

            Session.Add("TaskControl", taskControl);
            Response.Redirect("DoubleInterest.aspx");
        }

        protected void btnPrint_Click(object sender, EventArgs e)
        {
            try
            {
                Button clickedButton = (Button)sender;
                //ScriptManager.RegisterStartupScript(this.Page, this.Page.GetType(), Guid.NewGuid().ToString(), "SetWaitCursor();", true);

                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                if (taskControl.isQuote)
                {
                    PrintQuote();
                }
                else
                {
                    if (clickedButton.Text.ToString() == "PRINT")//"PRINT FULL POLICY")
                    {
                        //string rdlcDoc;
                        if (chkIsBusinessAutoQuote.Checked)
                        {
                            PrintPolicyBusiness(false);
                        }
                        else
                        {
                            PrintPolicyPersonal(false);
                        }
                    }
                    else if (clickedButton.Text.ToString() == "PRINT ID CARDS")
                    {
                        PrintIDCards();
                    }
                    else
                    {
                        if (chkIsBusinessAutoQuote.Checked)
                        {
                            PrintPolicyBusinessDeclaration();
                        }
                        else
                        {
                            PrintPolicyPersonalDeclaration();
                        }
                    }
                }

                //ScriptManager.RegisterStartupScript(this.Page, this.Page.GetType(), Guid.NewGuid().ToString(), "SetDefaultCursor();", true);

            }
            catch (Exception exc)
            {
                lblRecHeader.Text = exc.Message.Trim() + " - " + exc.InnerException.ToString();
                mpeSeleccion.Show();
            }
        }

        protected void BtnPrintInvoice_Click(object sender, EventArgs e)
        {
            try
            {
                List<string> mergePaths = new List<string>();
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                int taskControlID = taskControl.TaskControlID;

                mergePaths = ImprimirDecPageComercialP4(mergePaths, taskControlID);

                string ProcessedPath = System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"];
                //Generar PDF
                OPTIMAIns.CreatePDFBatch mergeFinal = new OPTIMAIns.CreatePDFBatch();
                string FinalFile = "";
                FinalFile = mergeFinal.MergePDFFiles(mergePaths, ProcessedPath, taskControl.TaskControlID.ToString());
                ScriptManager.RegisterStartupScript(this.Page, this.GetType(), "key", "window.open('ExportFiles/" + FinalFile + "','Reports','addressbar=no,status=1,menubar=0,scrollbars=1,resizable=1,copyhistory=no,width=900,height=700');", true);

            }
            catch (Exception exc)
            {
                lblRecHeader.Text = exc.Message.Trim() + " - " + exc.InnerException.ToString();
                mpeSeleccion.Show();
            }
        }

        protected void PrintEndoso(string rdlcDoc, int taskControl1)
        {
            if (rdlcDoc == "DecPage-BAP67077")
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
                ReportViewer viewer = new ReportViewer();
                //string ProcessPath = System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"];

                viewer.LocalReport.DataSources.Clear();
                viewer.ProcessingMode = ProcessingMode.Local;
                viewer.LocalReport.ReportPath = Server.MapPath("Reports/VI/" + rdlcDoc);
                Microsoft.Reporting.WebForms.ReportDataSource rds = null;


                GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter ds = new GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter();
                GetReportAutoGeneralInfods_VI.GetReportAutoGeneralInfo_VIDataTable dt = new GetReportAutoGeneralInfods_VI.GetReportAutoGeneralInfo_VIDataTable();

                ds.Fill(dt, taskControl.TaskControlID);
                rds = new Microsoft.Reporting.WebForms.ReportDataSource("GetReportAutoGeneralInfods_VI", (DataTable)dt);

                string Endosos = "";

                ReportParameter[] parameters = new ReportParameter[1];

                for (int i = 0; taskControl.VehicleCollection.Rows.Count > i; i++)
                {
                    if (taskControl.VehicleCollection.Rows[0]["BIPremium"].ToString() != "0")
                    {
                        Endosos += " A117, GIC3, GIC17, GIC21, GIC30, PP03260886, Under26excl";
                    }

                    if (taskControl.VehicleCollection.Rows[0]["CollPremium"].ToString() != "0" && taskControl.VehicleCollection.Rows[0]["CompPremium"].ToString() != "0")
                    {
                        Endosos += " GIC12, A4555, GIC20, GIC25";
                    }

                    if (taskControl.VehicleCollection.Rows[0]["RentalReim"].ToString() != "0" && taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Private")
                    {
                        Endosos += " GIC22";
                    }

                    if (taskControl.VehicleCollection.Rows[0]["ADDPremium"].ToString() != "0" && (taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Private" || taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Commercial"))
                    {
                        Endosos += " UIP248";
                    }

                    if (taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Rental")
                    {
                        Endosos += " GIC16";
                    }

                    if (taskControl.VehicleCollection.Rows[0]["TaxiLossAmount"].ToString() != "0")
                    {
                        Endosos += " GIC23";
                    }

                }

                parameters[0] = new ReportParameter("Endosos", Endosos.ToString().Trim());

                viewer.LocalReport.SetParameters(parameters);
                viewer.LocalReport.DataSources.Add(rds);
                viewer.LocalReport.Refresh();
            }

            else
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter ds = new GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter();

                ReportDataSource rds = new ReportDataSource();

                int s = taskControl1;

                rds = new ReportDataSource("GetReportAutoVehiclesInfo_VI", (DataTable)ds.GetData(s));

                string Endosos = "";

                ReportParameter[] parameters = new ReportParameter[1];

                for (int i = 0; taskControl.VehicleCollection.Rows.Count > i; i++)
                {
                    if (taskControl.VehicleCollection.Rows[0]["BIPremium"].ToString() != "0")
                    {
                        Endosos += " A117, GIC3, GIC17, GIC21, GIC30, PP03260886, Under26excl";
                    }

                    if (taskControl.VehicleCollection.Rows[0]["CollPremium"].ToString() != "0" && taskControl.VehicleCollection.Rows[0]["CompPremium"].ToString() != "0")
                    {
                        Endosos += " GIC12, A4555, GIC20, GIC25";
                    }

                    if (taskControl.VehicleCollection.Rows[0]["RentalReim"].ToString() != "0" && taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Private")
                    {
                        Endosos += " GIC22";
                    }

                    if (taskControl.VehicleCollection.Rows[0]["ADDPremium"].ToString() != "0" && (taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Private" || taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Commercial"))
                    {
                        Endosos += " UIP248";
                    }

                    if (taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Rental")
                    {
                        Endosos += " GIC16";
                    }

                    if (taskControl.VehicleCollection.Rows[0]["TaxiLossAmount"].ToString() != "0")
                    {
                        Endosos += " GIC23";
                    }

                }

                parameters[0] = new ReportParameter("Endosos", Endosos.ToString().Trim());

                ReportViewer viewer1 = new ReportViewer();
                viewer1.LocalReport.DataSources.Clear();
                viewer1.ProcessingMode = ProcessingMode.Local;
                viewer1.LocalReport.ReportPath = Server.MapPath("Reports/VI/" + rdlcDoc);
                viewer1.LocalReport.SetParameters(parameters);
                viewer1.LocalReport.DataSources.Add(rds);
                viewer1.LocalReport.Refresh();
            }

        }

        protected void PrintQuote()
        {
            try
            {
                List<string> mergePaths = new List<string>();
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
                //EPolicy.TaskControl.QuoteAuto qa = (EPolicy.TaskControl.QuoteAuto)Session["TaskControl"];

                int taskControlID = taskControl.TaskControlID;

                mergePaths = ImprimirAutoQuote(mergePaths, taskControlID);

                string ProcessedPath = System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"];
                //Generar PDF
                OPTIMAIns.CreatePDFBatch mergeFinal = new OPTIMAIns.CreatePDFBatch();
                string FinalFile = "";
                FinalFile = mergeFinal.MergePDFFiles(mergePaths, ProcessedPath, taskControl.TaskControlID.ToString());
                ScriptManager.RegisterStartupScript(this.Page, this.GetType(), "key", "window.open('ExportFiles/" + FinalFile + "','Reports','addressbar=no,status=1,menubar=0,scrollbars=1,resizable=1,copyhistory=no,width=900,height=700');", true);

            }
            catch (Exception exc)
            {
                lblRecHeader.Text = exc.Message.Trim() + " - " + exc.InnerException.ToString();
                mpeSeleccion.Show();
            }
        }

        protected void btnAcceptQuote_Click(object sender, EventArgs e)
        {
            //EPolicy.TaskControl.DoubleInterest taskControl1 = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
            ////Check if any vehicle has does not have
            //foreach (DataRow row in taskControl1.VehicleCollection.Rows)
            //{
            //    if (row["BankDesc"].ToString().Trim() == "")
            //    {
            //        lblRecHeader.Text = "You must select a Loss Payee for every vehicle. (Select \"None Stated\" if none is applicable) ";
            //        mpeSeleccion.Show();
            //        return;
            //    }
            //}
            if (BtnAddVehicle.Text == "Save Vehicle")
            {
                lblRecHeader.Text = "Please Save Vehicle Changes!";
                mpeSeleccion.Show();
                return;
            }
            GetTotalPremium();
            SaveClick();

            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
            taskControl.Mode = (int)EPolicy.TaskControl.TaskControl.TaskControlMode.UPDATE;

            Session.Add("TaskControl", taskControl);

            UpdatePolicyMode_VI(taskControl.TaskControlID, "2");
            EnableControls();
            FillTextControl();

            //Cuando llegue una fecha menor a la de hoy que se quede con ella
            if (RenewalNo != "")
            {
                if (DateTime.Parse(TxtEffBinderDate.Text) < DateTime.Parse(DateTime.Today.ToShortDateString()))
                {
                    TxtEffBinderDate.Text = DateTime.Parse(TxtEffBinderDate.Text).Month.ToString() + "/" + DateTime.Parse(TxtEffBinderDate.Text).Day.ToString() + "/" + System.DateTime.Today.Year.ToString();
                    TxtExpBinderDate.Text = DateTime.Parse(TxtEffBinderDate.Text).Month.ToString() + "/" + DateTime.Parse(TxtEffBinderDate.Text).Day.ToString() + "/" + System.DateTime.Today.AddYears(int.Parse(taskControl.Terms) / 12).Year.ToString();
                }
            }
            else
            {
                if (DateTime.Parse(TxtEffBinderDate.Text) < DateTime.Parse(DateTime.Today.ToShortDateString()))
                {
                    TxtEffBinderDate.Text = System.DateTime.Today.ToShortDateString();
                    TxtExpBinderDate.Text = System.DateTime.Today.AddYears(int.Parse(taskControl.Terms) / 12).ToShortDateString();
                }
            }

            if (lblRecHeader.Text == "")
            {
                lblRecHeader.Text = "Quote accepted succesfully!";
            }
            mpeSeleccion.Show();
            TxtAddress.Focus();

        }

        protected void btnSaveApp_Click(object sender, EventArgs e)
        {
            EPolicy.TaskControl.DoubleInterest taskControl1 = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            if (taskControl1.RenewalNo == "")
            {
                try
                {
                    if (DateTime.Parse(TxtEffBinderDate.Text.ToString().Trim()) < System.DateTime.Today)
                    {
                        lblRecHeader.Text = "Policy Effective Date should be Current Date.";
                        mpeSeleccion.Show();
                        return;
                    }
                }
                catch (Exception ex)
                {
                    throw new Exception("Policy Effective Date should be Current Date.", ex);
                }
            }

            if (BtnAddVehicle.Text == "Save Vehicle")
            {
                lblRecHeader.Text = "Please Save Vehicle Changes!";
                mpeSeleccion.Show();
                return;
            }

            GetTotalPremium();
            SaveClick();

            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            UpdatePolicyMode_VI(taskControl.TaskControlID, "2");
            //txtdumybox.Text ="1";
            lblRecHeader.Text = lblRecHeader.Text == "" ? "Application saved succesfully!" : lblRecHeader.Text;
            string OLDTEXT = lblRecHeader.Text;
            if (lblRecHeader.Text != "Application saved succesfully!")
            {
                return;
            }
            FillTextControl();
            //txtdumybox.Text = "";
            lblRecHeader.Text = OLDTEXT;
            //lblRecHeader.Text = "Application saved succesfully!";
            mpeSeleccion.Show();

            TxtAddress.Focus();
        }

        protected void btnIssuePolicy_Click(object sender, EventArgs e)
        {
            EPolicy.TaskControl.DoubleInterest taskContro1 = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            if (taskContro1.RenewalNo == "")
            {
                try
                {
                    if (DateTime.Parse(TxtEffBinderDate.Text.ToString().Trim()) < System.DateTime.Today)
                    {
                        lblRecHeader.Text = "Policy Effective Date should be Current Date.";
                        mpeSeleccion.Show();
                        return;
                    }
                }
                catch (Exception ex)
                {
                    throw new Exception("Policy Effective Date should be Current Date.", ex);
                }
            }
            try
            {
                EPolicy.Login.Login cp = HttpContext.Current.User as EPolicy.Login.Login;

                if (ddlAgent.Items.Count > 1)
                {
                    //ScriptManager.RegisterClientScriptBlock(this, this.GetType(), "alertMessage", "alert('Número de Póliza o Reclamacion no ha sido encontrado.')", true);
                }

                if (ddlAgent.SelectedItem.Text.Trim() == "")
                {
                    throw new Exception("This User/Customer does not have an assigned Agent.");
                }

                VerifyPolicyExist();

                ModifyClick();

                EPolicy.TaskControl.DoubleInterest taskControlQuote = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                Session.Clear();
                EPolicy.TaskControl.DoubleInterest taskControl = new EPolicy.TaskControl.DoubleInterest(false);

                //taskControl = taskControlQuote;


                taskControl.Mode = 1; //ADD
                taskControl.isQuote = false;
                taskControl.TaskControlTypeID = int.Parse(EPolicy.LookupTables.LookupTables.GetID("TaskControlType", "Double Interest Policy"));
                taskControl.InsuranceCompany = taskControl.InsuranceCompany;
                taskControl.Agency = taskControl.Agency;
                taskControl.Agent = taskControl.Agent;
                taskControl.OriginatedAt = taskControl.OriginatedAt;
                taskControl.DepartmentID = 1;
                taskControl.EffectiveDate = taskControlQuote.EffectiveDateApp;
                taskControl.ExpirationDate = taskControlQuote.ExpirationDateApp;

                taskControl.Customer.CustomerNo = taskControlQuote.Customer.CustomerNo;
                taskControl.Customer.FirstName = taskControlQuote.Customer.FirstName;
                taskControl.Customer.LastName1 = taskControlQuote.Customer.LastName1;
                taskControl.Customer.LastName2 = taskControlQuote.Customer.LastName2;
                taskControl.Customer.Initial = taskControlQuote.Customer.Initial;
                taskControl.Customer.Sex = taskControlQuote.Customer.Sex;
                taskControl.Customer.Address1 = taskControlQuote.Customer.Address1;
                taskControl.Customer.City = taskControlQuote.Customer.City;
                taskControl.Customer.State = taskControlQuote.Customer.State;
                taskControl.Customer.ZipCode = taskControlQuote.Customer.ZipCode;
                taskControl.Customer.Licence = taskControlQuote.Customer.Licence;
                taskControl.Customer.MaritalStatus = taskControlQuote.Customer.MaritalStatus;
                taskControl.Customer.Birthday = taskControlQuote.Customer.Birthday;
                taskControl.Customer.Age = taskControlQuote.Customer.Age;
                taskControl.Customer.JobPhone = taskControlQuote.Customer.JobPhone;
                taskControl.Customer.HomePhone = taskControlQuote.Customer.HomePhone;
                taskControl.Customer.OccupationID = taskControlQuote.Customer.OccupationID;
                taskControl.Customer.Occupation = taskControlQuote.Customer.Occupation;
                taskControl.Customer.EmplName = taskControlQuote.Customer.EmplName;
                taskControl.Customer.Address1 = taskControlQuote.Customer.Address1;
                taskControl.Customer.Address2 = taskControlQuote.Customer.Address2;
                taskControl.Customer.City = taskControlQuote.Customer.City;
                taskControl.Customer.State = taskControlQuote.Customer.State;
                taskControl.Customer.ZipCode = taskControlQuote.Customer.ZipCode;
                taskControl.Customer.AddressPhysical1 = taskControlQuote.Customer.AddressPhysical1;
                taskControl.Customer.AddressPhysical2 = taskControlQuote.Customer.AddressPhysical2;
                taskControl.Customer.CityPhysical = taskControlQuote.Customer.CityPhysical;
                taskControl.Customer.StatePhysical = taskControlQuote.Customer.StatePhysical;
                taskControl.Customer.ZipPhysical = taskControlQuote.Customer.ZipPhysical;
                taskControl.Customer.Description = taskControlQuote.Customer.Description;


                taskControl.isBusinessPolicy = chkIsBusinessAutoQuote.Checked;
                if (chkIsBusinessAutoQuote.Checked)
                {
                    taskControl.PolicyType = "BAP";
                }
                else
                {
                    taskControl.PolicyType = "PAP";
                }


                taskControl.CompanyDealer = taskControlQuote.CompanyDealer;
                taskControl.InsuranceCompany = taskControlQuote.InsuranceCompany;
                taskControl.OriginatedAt = taskControlQuote.OriginatedAt;
                taskControl.Agent = taskControlQuote.Agent;
                taskControl.Agency = taskControlQuote.Agency;
                //taskControl.AgentDesc = taskControlQuote.AgentDesc;

                taskControl.CancellationDate = taskControlQuote.CancellationDate;
                taskControl.CancellationEntryDate = "";
                taskControl.CancellationUnearnedPercent = taskControlQuote.CancellationUnearnedPercent;
                taskControl.CancellationMethod = taskControlQuote.CancellationMethod;
                taskControl.CancellationReason = taskControlQuote.CancellationReason;
                taskControl.PaidAmount = taskControlQuote.PaidAmount;
                taskControl.PaidDate = "";
                taskControl.Ren_Rei = taskControlQuote.Ren_Rei;
                taskControl.CommissionAgency = taskControlQuote.CommissionAgency; // taskControl.ReturnCommissionAgency;
                taskControl.CommissionAgent = taskControlQuote.CommissionAgent; // taskControl.ReturnCommissionAgent;
                taskControl.CommissionAgencyPercent = taskControlQuote.CommissionAgencyPercent; // taskControl.CommissionAgencyPercent.Trim();
                taskControl.CommissionAgentPercent = taskControlQuote.CommissionAgentPercent;  //taskControl.CommissionAgentPercent.Trim();
                taskControl.TaskControlID = taskControlQuote.TaskControlID;
                taskControl.Status = taskControlQuote.Status;
                taskControl.ReturnCharge = taskControlQuote.ReturnCharge;
                taskControl.ReturnPremium = taskControlQuote.ReturnPremium;
                taskControl.CancellationAmount = taskControlQuote.CancellationAmount;
                taskControl.ReturnCommissionAgency = taskControlQuote.ReturnCommissionAgency;
                taskControl.ReturnCommissionAgent = taskControlQuote.ReturnCommissionAgent;

                taskControl.CustomerCollection = taskControlQuote.CustomerCollection;
                taskControl.TotalDiscounts = taskControlQuote.TotalDiscounts;
                taskControl.TotalDiscountsPct = taskControlQuote.TotalDiscountsPct;

                taskControl.AnyAccidentsOrLosses = taskControlQuote.AnyAccidentsOrLosses;
                taskControl.IsNewCustomer = taskControlQuote.IsNewCustomer;
                taskControl.YearsWithNoClaims = taskControlQuote.YearsWithNoClaims;
                taskControl.AnyDriverUnder26 = taskControlQuote.AnyDriverUnder26;

                taskControl.Q1 = taskControlQuote.Q1;
                taskControl.Q2 = taskControlQuote.Q2;
                taskControl.Q3 = taskControlQuote.Q3;



                taskControl.EntryDate = DateTime.Now;
                taskControl.Term = taskControl.Term;

                taskControl.DriversCollection = taskControlQuote.DriversCollection;
                taskControl.VehicleCollection = taskControlQuote.VehicleCollection;
                taskControl.VehicleBreakDownCollection = taskControlQuote.VehicleBreakDownCollection;

                taskControl.TotalPremium = taskControlQuote.TotalPremium;
                taskControl.Charge = taskControlQuote.Charge;
                taskControl.TCIDQuotes = taskControlQuote.TaskControlID;

                taskControl.RenewalNo = taskControlQuote.RenewalNo;

                taskControl.CustomerCollection = taskControlQuote.CustomerCollection;

                taskControl.EmployeeName = taskControlQuote.RenewalNo;
                taskControl.Terms = taskControlQuote.Terms;

                //taskControl.YearsWithClaims = taskControlQuote.YearsWithClaims;


                Session.Add("TaskControl", taskControl);

                SaveClick();
                UpdatePolicyMode_VI(taskControl.TaskControlID, "3");
                UpdatePolicyTC_VI(taskControl.TaskControlID, taskControlQuote.TaskControlID.ToString());

                try
                {
                    //if (!(HttpContext.Current.Request.Url.ToString().Contains("localhost")))
                    //{
                    PolicyXML(taskControl.TaskControlID);
                    Response.Redirect("DoubleInterest.aspx");
                    //}
                }
                catch (Exception xp)
                {
                    LogError(xp);
                    //lblRecHeader.Text = xp.Message;
                    //mpeSeleccion.Show();
                }

            }
            catch (Exception exp)
            {
                lblRecHeader.Text = exp.Message;
                mpeSeleccion.Show();
            }

        }

        private void LogError(Exception exp)
        {
            string message = string.Format("Time: {0}", DateTime.Now.ToString("dd/MM/yyyy hh:mm:ss tt"));
            message += Environment.NewLine;
            message += "-----------------------------------------------------------";
            message += Environment.NewLine;
            message += string.Format("Message: {0}", exp.Message);
            message += Environment.NewLine;
            message += string.Format("StackTrace: {0}", exp.StackTrace);
            message += Environment.NewLine;
            message += string.Format("Source: {0}", exp.Source);
            message += Environment.NewLine;
            message += string.Format("TargetSite: {0}", exp.TargetSite.ToString());
            message += Environment.NewLine;
            message += "-----------------------------------------------------------";
            message += Environment.NewLine;
            string path = Server.MapPath("~/ErrorLog/ErrorLog.txt");
            using (StreamWriter writer = new StreamWriter(path, true))
            {
                writer.WriteLine(message);
                writer.Close();
            }
        }

        protected void btnSavePolicy_Click(object sender, EventArgs e)
        {
            GetTotalPremium();
            SaveClick();

            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            UpdatePolicyMode_VI(taskControl.TaskControlID, "3");
            FillTextControl();

            lblRecHeader.Text = "Policy saved succesfully!";
            mpeSeleccion.Show();

        }

        protected void btnQA_Click(object sender, EventArgs e)
        {
            mpeQuestions.Show();
        }

        private String[] CompareRenewalLiabRates(string BI, string PD, string MP, string UseClass, string Island, string Tons, string Motorcycle, string Passengers, string HeavyTruck)
        {
            DataTable dt = null, dtDiscount = null;
            double Discounts = 0.00;
            String[] Rates = new String[3];
            Rates[0] = BI;
            Rates[1] = PD;
            Rates[2] = MP;

            Passengers = Passengers == "" ? "0" : Passengers;

            DateTime EffectiveDate = DateTime.Now;
            dtDiscount = GetDiscounts("22", true, true, EffectiveDate);

            if (dtDiscount.Rows.Count > 0)
            {
                Discounts = (100.0 - double.Parse(dtDiscount.Rows[0]["Discount"].ToString())) / 100;
            }

            dt = GetLiabilityRates(UseClass, Island, Tons, Motorcycle, int.Parse(Passengers), HeavyTruck);

            if (dt.Rows.Count > 0)
            {
                if (MP != "0.0000" && MP != "0.00" && MP != "0")
                {

                    //3/18/2020 Peticion por Ramon Se elimino la comparacion de Prima con PPS a partir del 6/01/2020
                    if (EffectiveDate >= DateTime.Parse("03/01/2019") && EffectiveDate <= DateTime.Parse("05/31/2020"))
                    {
                        MP = Discounts != 0.00 ? Math.Round(Discounts * double.Parse(dt.Rows[0]["MPRate"].ToString()), 0).ToString() : dt.Rows[0]["MPRate"].ToString();
                        Rates[2] = (double.Parse(Rates[2]) > double.Parse(MP)) ? Rates[2] : MP;
                    }
                    else
                    {
                        MP = Discounts != 0.00 ? Math.Round(Discounts * double.Parse(dt.Rows[0]["MPRate"].ToString()), 0).ToString() : dt.Rows[0]["MPRate"].ToString();
                        Rates[2] = MP;
                    }
                }
                else
                {
                    //if (radGenMedicalPayment.SelectedItem.Text == "Yes")
                    //{
                    //MP = "0.00";//dt.Rows[2]["MPRate"].ToString();
                    Rates[2] = "0.00";
                    //}
                }

                if (PD != "0.0000" && PD != "0.00" && PD != "0")
                {
                    if (EffectiveDate >= DateTime.Parse("03/01/2019") && EffectiveDate <= DateTime.Parse("05/31/2020"))
                    {
                        PD = Discounts != 0.00 ? Math.Round(Discounts * double.Parse(dt.Rows[0]["PDRate"].ToString()), 0).ToString() : dt.Rows[0]["PDRate"].ToString();
                        Rates[1] = (double.Parse(Rates[1]) > double.Parse(PD)) ? Rates[1] : PD;
                    }
                    else
                    {
                        PD = Discounts != 0.00 ? Math.Round(Discounts * double.Parse(dt.Rows[0]["PDRate"].ToString()), 0).ToString() : dt.Rows[0]["PDRate"].ToString();
                        Rates[1] = PD;
                    }
                }
                else
                {
                    //PD = Discounts != 0.00 ? (Discounts * double.Parse(dt.Rows[0]["PDRate"].ToString())).ToString() : dt.Rows[0]["PDRate"].ToString();
                    Rates[1] = "0.00";//= (double.Parse(Rates[1]) >= double.Parse(PD)) ? Rates[1] : PD;
                }

                if (BI != "0.0000" && BI != "0.00" && BI != "0")
                {

                    //if (TxtBILimitpp.SelectedItem.Value == "$10,000/$20,000")
                    //else if (TxtBILimitpp.SelectedItem.Value == "$10,000/$25,000")

                    if (EffectiveDate >= DateTime.Parse("03/01/2019") && EffectiveDate <= DateTime.Parse("05/31/2020"))
                    {
                        if (dt.Rows[0]["BIRates_10_20"].ToString() != "0")
                            BI = Discounts != 0.00 ? Math.Round(Discounts * double.Parse(dt.Rows[0]["BIRates_10_20"].ToString()), 0).ToString() : dt.Rows[0]["BIRates_10_20"].ToString();
                        else if (dt.Rows[0]["BIRates_10_25"].ToString() != "0")
                            BI = Discounts != 0.00 ? Math.Round(Discounts * double.Parse(dt.Rows[0]["BIRates_10_25"].ToString()), 0).ToString() : dt.Rows[0]["BIRates_10_25"].ToString();
                        else if (dt.Rows[0]["BIRates_10_50"].ToString() != "0")
                            BI = Discounts != 0.00 ? Math.Round(Discounts * double.Parse(dt.Rows[0]["BIRates_10_50"].ToString()), 0).ToString() : dt.Rows[0]["BIRates_10_50"].ToString();

                        Rates[0] = (double.Parse(Rates[0]) > double.Parse(BI)) ? Rates[0] : BI;
                        //BI = dt.Rows[0]["BIRates_10_20"].ToString();
                        //BI = dt.Rows[0]["BIRates_10_25"].ToString();
                        //BI = dt.Rows[0]["BIRates_10_50"].ToString();
                    }
                    else
                    {
                        if (dt.Rows[0]["BIRates_10_20"].ToString() != "0")
                            BI = Discounts != 0.00 ? Math.Round(Discounts * double.Parse(dt.Rows[0]["BIRates_10_20"].ToString()), 0).ToString() : dt.Rows[0]["BIRates_10_20"].ToString();
                        else if (dt.Rows[0]["BIRates_10_25"].ToString() != "0")
                            BI = Discounts != 0.00 ? Math.Round(Discounts * double.Parse(dt.Rows[0]["BIRates_10_25"].ToString()), 0).ToString() : dt.Rows[0]["BIRates_10_25"].ToString();
                        else if (dt.Rows[0]["BIRates_10_50"].ToString() != "0")
                            BI = Discounts != 0.00 ? Math.Round(Discounts * double.Parse(dt.Rows[0]["BIRates_10_50"].ToString()), 0).ToString() : dt.Rows[0]["BIRates_10_50"].ToString();

                        Rates[0] = BI;
                    }
                }
                else
                {
                    if (dt.Rows[0]["BIRates_10_20"].ToString() != "0")
                        BI = dt.Rows[0]["BIRates_10_20"].ToString();
                    else if (dt.Rows[0]["BIRates_10_25"].ToString() != "0")
                        BI = dt.Rows[0]["BIRates_10_25"].ToString();
                    else if (dt.Rows[0]["BIRates_10_50"].ToString() != "0")
                        BI = dt.Rows[0]["BIRates_10_50"].ToString();

                    Rates[0] = "0.00";//(double.Parse(Rates[0]) >= double.Parse(BI)) ? Rates[0] : BI;
                }
            }

            return Rates;
        }


        protected void AddRenewalVehicle_Click(string BIPremium, string PDPremium, string MPPremium, string CollPremium, string CompPremium, string MotPremium, string AddPremium, string TotPremium, string RentReimPremium, string TaxiLossPremium, string BILimit, string PDLimit, string CollLimit, string CompLimit, string MPLimit)
        {
            try
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
                EPolicy.Login.Login cp = HttpContext.Current.User as EPolicy.Login.Login;
                int userID = 0;
                userID = int.Parse(cp.Identity.Name.Split("|".ToCharArray())[1]);

                if (!ValidateAutoFieldsBeforeAdd())
                    return;

                string BI = BIPremium;
                string PD = PDPremium;
                string MP = MPPremium;
                string Coll = CollPremium;
                string Comp = CompPremium;
                string Mot = MotPremium;
                string Add = AddPremium;
                string TotPrem = TotPremium;
                string RentReim = RentReimPremium;
                string TaxiLoss = TaxiLossPremium;
                string tempVehicleID = "0";

                //SetCompCollDeductible();
                int MaxVehicleDetailID = 0;
                int VehicleRowNumber = 0;
                //if (CalculateRates(ref BI, ref PD, ref MP, ref Coll, ref Comp, ref Mot, ref Add, ref RentReim, ref TaxiLoss, false))
                //{

                if (TxtVehicleID.Text.Trim() != "")
                {
                    for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                    {
                        if (taskControl.VehicleCollection.Rows[i]["VehicleDetailID"].ToString() == TxtVehicleID.Text.Trim())
                        {
                            tempVehicleID = taskControl.VehicleCollection.Rows[i]["VehicleDetailID"].ToString();
                            taskControl.VehicleCollection.Rows.RemoveAt(i);
                        }
                    }

                    taskControl.VehicleCollection.AcceptChanges();
                }

                if (taskControl.VehicleCollection.Rows.Count > 0)
                {
                    for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                    {
                        if (int.Parse(taskControl.VehicleCollection.Rows[i]["VehicleDetailID"].ToString()) > MaxVehicleDetailID)
                        {
                            MaxVehicleDetailID = int.Parse(taskControl.VehicleCollection.Rows[i]["VehicleDetailID"].ToString());
                        }
                    }
                }

                DataTable dt = null;
                DataRow myRow = taskControl.VehicleCollection.NewRow();

                if (TxtVehicleValue.Text.ToString().Trim() == "")
                {
                    TxtVehicleValue.Text = "0";
                }

                myRow["VehicleDetailID"] = MaxVehicleDetailID + 1;
                myRow["TaskControlID"] = "0";
                myRow["VehicleYear"] = ddlVehicleYear.SelectedItem.Text.Trim();
                myRow["VehicleMake"] = ddlVehicleMake.SelectedItem.Text.Trim().ToUpper();
                myRow["VehicleModel"] = ddlVehicleModel.SelectedItem.Text.Trim().ToUpper();
                myRow["BankDesc"] = ddlBankList.SelectedItem.Text.Trim().ToUpper();
                myRow["BankPPSID"] = ddlBankList.SelectedItem.Value.Trim().ToUpper();
                myRow["VIN"] = TxtVINNo.Text.Trim().ToUpper();
                myRow["LicensePlateNo"] = TxtLicensePlateNo.Text.Trim().ToUpper();

                myRow["Island"] = ddlIsland.SelectedItem.Text.ToString().Trim();
                myRow["Status"] = ddlStatus.SelectedItem.Text.ToString().Trim();
                myRow["VehicleValue"] = double.Parse(TxtVehicleValue.Text.ToString().Trim(), System.Globalization.NumberStyles.Currency);
                myRow["VehicleUse"] = ddlVehicleUse.SelectedItem.Text.ToString().Trim();

                if (BtnAddVehicle.Text != "Save Vehicle") //Session["VehicleRowNumber"] == null && 
                {
                    if (taskControl.VehicleCollection.Rows.Count == 0)
                        myRow["VehicleRowNumber"] = 1;
                    else
                        myRow["VehicleRowNumber"] = taskControl.VehicleCollection.Rows.Count + 1;
                }
                else
                {
                    myRow["VehicleRowNumber"] = Session["VehicleRowNumber"].ToString();
                }

                if (BtnAddVehicle.Text == "Save Vehicle")
                {
                    //Si la el asegurado principal tiene 16 o 17 años la cubierta rental reim. no aplica
                    if (TxtAge.Text.Trim() == "16" || TxtAge.Text.Trim() == "17")
                    {
                        lblPrimGrade.Visible = true;
                        txtPrimGrade.Visible = true;
                        txtPrimGrade.Enabled = true;
                        lblRentalReim.Visible = true;
                        radRentalReimCov.Visible = true;
                        radRentalReimCov.Enabled = false;
                        radRentalReimCov.SelectedIndex = 1;
                    }
                    if (radRentalReimCov.SelectedItem.Text == "Yes")
                    {

                    }
                    else
                    {
                        RentReim = "0.00";
                    }
                }

                if (TxtPassengerNo.Visible == true)
                {
                    myRow["PassengersNo"] = TxtPassengerNo.Text.ToString().Trim();
                }
                else
                {
                    myRow["PassengersNo"] = 0;
                }

                if (radGenTons.SelectedItem.Text == "Yes")
                {
                    myRow["Over2Tons"] = true;
                }
                else
                {
                    myRow["Over2Tons"] = false;
                }

                if (radHeavyTruck.SelectedItem.Text == "Yes")
                {
                    myRow["IsHeavyTruck"] = true;
                }
                else
                {
                    myRow["IsHeavyTruck"] = false;
                }

                if (radGenMedicalPayment.SelectedItem.Text == "Yes" && (MP != "0.00" && MP != "0.0000"))
                {
                    myRow["MedicalPayment"] = true;
                }
                else
                {
                    myRow["MedicalPayment"] = false;
                    radGenMedicalPayment.SelectedIndex = 1;
                    radGenMedicalPayment.SelectedValue = "N";
                }

                if (radGenMotoristCoverage.SelectedItem.Text == "Yes")
                {
                    myRow["MotoristCoverage"] = true;
                }
                else
                {
                    myRow["MotoristCoverage"] = false;
                }

                if (radRentalReimCov.SelectedItem.Text == "Yes")
                {
                    myRow["RentalReimCoverage"] = true;
                }
                else
                {
                    myRow["RentalReimCoverage"] = false;
                }

                if (radADD.SelectedItem.Text == "Yes")
                {
                    myRow["DeathDismembermentCoverage"] = true;
                }
                else
                {
                    myRow["DeathDismembermentCoverage"] = false;
                }

                if (radMotorcycle.SelectedItem.Text == "Yes")
                {
                    myRow["IsMotorcycleScooter"] = true;
                }
                else
                {
                    myRow["IsMotorcycleScooter"] = false;
                }

                if (radTaxiDriverloss.SelectedItem.Text == "Yes")
                {
                    //myRow["TaxiLossAmount"] = true;
                    myRow["TaxiLossAmount"] = Math.Round(double.Parse(TaxiLoss), 0).ToString();
                }
                else
                {
                    // myRow["TaxiLossAmount"] = false;

                    myRow["TaxiLossAmount"] = 0.0;
                }


                myRow["PDLimit"] = PDLimit;//TxtPDLimit.Text.ToString().Trim();
                myRow["ComprehensiveDedu"] = CompLimit;//ddlDedComp.SelectedItem.Value.ToString(); //TxtDeductibleComprehensive.Text.ToString().Trim();
                myRow["CollisionDedu"] = CollLimit;//ddlDedColl.SelectedItem.Value.ToString(); //TxtDeductibleCollision.Text.ToString().Trim();
                myRow["BIPPLimit"] = BILimit;//TxtBILimitpp.Text.ToString().Trim();
                myRow["BIPOLimit"] = null;//TxtBILimitpo.Text.ToString().Trim().Replace("&amp;", "").Replace("amp;", "").Replace("nbsp;", "").Replace("&", "").Replace("&nbsp;", "");
                myRow["MPLimit"] = MPLimit;//txtMPLimit.Text.ToString().Trim();

                myRow["CompPremium"] = Math.Round(double.Parse(Comp), 0).ToString(); //txtComp.Text.ToString().Trim();
                myRow["CollPremium"] = Math.Round(double.Parse(Coll), 0).ToString(); //txtCollision.Text.ToString().Trim();
                myRow["BIPremium"] = Math.Round(double.Parse(BI), 0).ToString();  //txtBIRate.Text.ToString().Trim();
                myRow["PDPremium"] = Math.Round(double.Parse(PD), 0).ToString();  //txtPDRate.Text.ToString().Trim();

                if (radGenMedicalPayment.SelectedItem.Text == "Yes")
                {
                    myRow["MPPremium"] = Math.Round(double.Parse(MP), 0).ToString(); //txtMPRate.Text.ToString().Trim();
                }
                else
                {
                    myRow["MPPremium"] = 0.0; //txtMPRate.Text.ToString().Trim();
                }

                myRow["MotoristPremium"] = Math.Round(double.Parse(Mot), 0).ToString();  //txtMotorist.Text.ToString().Trim();
                myRow["ADDPremium"] = Math.Round(double.Parse(Add), 0).ToString(); //txtADD.Text.ToString().Trim();
                myRow["RentalReim"] = Math.Round(double.Parse(RentReim), 0).ToString();  //txtADD.Text.ToString().Trim();
                myRow["TaxiLossAmount"] = Math.Round(double.Parse(TaxiLoss), 0).ToString();

                TotPrem = (double.Parse(Comp) + double.Parse(Coll) +
                    double.Parse(BI) + double.Parse(PD) +
                    double.Parse(MP) + double.Parse(Mot) +
                    double.Parse(Add) + double.Parse(RentReim) +
                    double.Parse(TaxiLoss)).ToString();

                myRow["ViolationSurcharge"] = 0.0;
                myRow["UnderAgeSurcharge"] = 0.0;

                myRow["TotalPremium"] = Math.Round(double.Parse(TotPrem), 0).ToString();  //txtTotalPremiumVehicle.Text.ToString().Trim();
                myRow["OtherSurchargePct"] = double.Parse(txtOtherSurcharge.Text.ToString());
                myRow["OtherSurcharge"] = (Math.Round((double.Parse(txtOtherSurcharge.Text.ToString().Trim()) / 100) * Math.Round(double.Parse(TotPrem), 0), 0)).ToString();


                taskControl.VehicleCollection.Rows.Add(myRow);
                taskControl.VehicleCollection.AcceptChanges();

                DataView dv = taskControl.VehicleCollection.DefaultView;
                dv.Sort = "VehicleRowNumber";
                taskControl.VehicleCollection = dv.ToTable();
                taskControl.VehicleCollection.AcceptChanges();

                dt = taskControl.VehicleCollection;

                for (int i = 0; i < GridVehicle.Columns.Count; i++)
                {
                    GridVehicle.Columns[i].Visible = true;
                }

                this.GridVehicle.Visible = true;
                this.GridVehicle.DataSource = dt;
                this.GridVehicle.DataBind();
                this.GridVehicle.Visible = true;


                for (int i = 6; i < 40; i++)
                {
                    GridVehicle.Columns[i].Visible = false;
                }
                GridVehicle.Columns[33].Visible = false;
                GridVehicle.Columns[38].Visible = false;
                GridVehicle.Columns[40].Visible = false;
                GridVehicle.Columns[41].Visible = false;
                GridVehicle.Columns[6].Visible = false;
                GridVehicle.Columns[42].Visible = false;
                GridVehicle.Columns[44].Visible = false;
                GridVehicle.Columns[45].Visible = false;

                GridVehicle.Columns[39].Visible = true;
                GridVehicle.Columns[26].Visible = true;
                GridVehicle.Columns[27].Visible = true;
                GridVehicle.Columns[28].Visible = true;
                GridVehicle.Columns[29].Visible = true;
                GridVehicle.Columns[30].Visible = true;
                GridVehicle.Columns[31].Visible = true;
                GridVehicle.Columns[32].Visible = true;
                GridVehicle.Columns[34].Visible = true;



                //CalculatePremium();
                //CalculateRenewalPremium();

                if (txtTotalPremiumVehicle.Text.ToString().Trim() == "")
                    txtTotalPremiumVehicle.Text = "0.00";

                if (BtnAddVehicle.Text == "Save Vehicle")
                {
                    TxtBirthDate_TextChanged(String.Empty, EventArgs.Empty);
                }

                this.BtnAddVehicle.Text = "Add Vehicle";
                lblModifyVehicle.Visible = false;
                GridVehicle.BorderColor = Color.Black;
                GridDrivers.BorderColor = Color.Black;


                // se puso en comentario ya que Maureen no queria que los valores se fueran a su estado "basic", se dejo la informacion que ya estaba entrada (limites, cubiertas, etc)

                //ddlVehicleYear.SelectedIndex = 0;
                //ddlVehicleMake.SelectedIndex = 0;
                //ddlVehicleModel.SelectedIndex = 0;
                //ddlBankList.SelectedIndex = 0;
                //TxtVINNo.Text = "";
                //TxtLicensePlateNo.Text = "";

                //ddlVehicleUse.SelectedIndex = 0;
                //ddlIsland.SelectedIndex = 0;

                //TxtVehicleValue.Text = "";


                //if (TxtPassengerNo.Visible == true || LblPassengersNo.Visible == true)
                //{
                //    TxtPassengerNo.Visible = false;
                //    LblPassengersNo.Visible = false;

                //    if (TxtPassengerNo.Text != "0")
                //        TxtPassengerNo.Text = "0";

                //    lblTaxiDriverloss.Visible = false;
                //    radTaxiDriverloss.Visible = false;

                //}

                //if (radRentalReimCov.Visible == false)
                //{
                //    radRentalReimCov.Visible = true;
                //    lblRentalReim.Visible = true;
                //}

                //if (radMotorcycle.Enabled)
                //{
                //    radMotorcycle.SelectedIndex = 1;
                //    IsBusinessCheckedChanged();
                //}


                //TxtVehicleValue.Enabled = true;

                //TxtVehicleID.Text = "";

                ValidateBI();
                EnableDisableBusinessAuto();

                //}
            }
            catch (Exception exp)
            {
                lblRecHeader.Text = exp.Message;
                mpeSeleccion.Show();
            }
        }

        protected void AddRenewalDriver_Click()
        {
            try
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                if (!ValidateAdditionalDriver())
                    return;

                if (lblModifyDriver.Visible == true)
                {
                    TxtDriverGrade.Visible = false;
                }

                if ((TxtDriverAge.Text == "16" || TxtDriverAge.Text == "17") && double.Parse(TxtDriverGrade.Text.ToString()) <= 0)
                {
                    return;
                }

                if (TxtDriverName.Text == "" || TxtDriverBirthDate.Text == "")
                {
                    return;
                }

                for (int i = 0; i < GridDrivers.Columns.Count - 1; i++)
                {
                    GridDrivers.Columns[i].Visible = true;
                }

                int MaxDriverDetailID = 0;

                if (TxtDriverID.Text.Trim() != "")
                {
                    for (int i = 0; i < taskControl.DriversCollection.Rows.Count; i++)
                    {
                        if (taskControl.DriversCollection.Rows[i]["DriverDetailID"].ToString() == TxtDriverID.Text.Trim())
                        {
                            taskControl.DriversCollection.Rows.RemoveAt(i);
                        }

                    }

                    taskControl.DriversCollection.AcceptChanges();
                }

                if (taskControl.DriversCollection.Rows.Count > 0)
                {
                    for (int i = 0; i < taskControl.DriversCollection.Rows.Count; i++)
                    {
                        if (int.Parse(taskControl.DriversCollection.Rows[i]["DriverDetailID"].ToString()) > MaxDriverDetailID)
                        {
                            MaxDriverDetailID = int.Parse(taskControl.DriversCollection.Rows[i]["DriverDetailID"].ToString());
                        }
                    }
                }

                DataTable dt = null;
                DataRow myRow = taskControl.DriversCollection.NewRow();

                //GetSurchargeAge("BirthDate");

                myRow["DriverDetailID"] = MaxDriverDetailID + 1; //taskControl.DriversCollection.Rows.Count + 1;
                myRow["TaskControlID"] = "0";
                myRow["DriverName"] = TxtDriverName.Text.Trim().ToUpper();
                myRow["DriverLastName"] = TxtDriverLastName.Text.Trim().ToUpper();
                myRow["DriverGender"] = ddlDriverGender.SelectedItem.Text.Trim();
                myRow["DriverMaritalStatus"] = ddlDriverMaritalStatus.SelectedItem.Text.Trim();
                myRow["DriverAge"] = TxtDriverAge.Text.Trim();
                myRow["DriverDateOfBirth"] = TxtDriverBirthDate.Text.Trim();
                myRow["TrafficViolationPoints"] = txtViolationPoints.Text.ToString().Trim();
                myRow["TrafficViolationSurcharge"] = txtViolationSurchargePct.Text.ToString().Trim();
                //myRow["UnderageSurcharge"] = txtUnderageChargesPct.Text.ToString().Trim();
                myRow["SumOfSurcharges"] = (txtViolationSurchargePct.Text.ToString() != "0" && txtUnderageChargesPct.Text.ToString() != "0") ? double.Parse(txtViolationSurchargePct.Text.ToString()) + double.Parse(txtUnderageChargesPct.Text.ToString()) : 0;
                if (int.Parse(TxtDriverAge.Text.ToString()) == 17 || int.Parse(TxtDriverAge.Text.ToString()) == 16)
                {
                    //String.Format(CultureInfo.InvariantCulture,"{0:0.00}", double.Parse(TxtDriverGrade.Text));
                    myRow["GradePointAvg"] = TxtDriverGrade.Text.ToString().Trim();
                }
                else if (TxtAge.Text.ToString() != "")
                {
                    if (int.Parse(TxtAge.Text.ToString()) == 17 || int.Parse(TxtAge.Text.ToString()) == 16)
                    {
                        myRow["GradePointAvg"] = TxtDriverGrade.Text.ToString().Trim();
                    }
                }
                else
                {
                    myRow["GradePointAvg"] = "0";
                }
                myRow["PrimaryDriver"] = false;

                GridDrivers.BorderColor = Color.Black;
                GridVehicle.BorderColor = Color.Black;

                taskControl.DriversCollection.Rows.Add(myRow);
                taskControl.DriversCollection.AcceptChanges();
                dt = taskControl.DriversCollection;

                this.BtnAddDriver.Text = "Add Driver";
                lblModifyDriver.Visible = false;
                TxtDriverName.Text = "";
                TxtDriverLastName.Text = "";
                TxtDriverAge.Text = "";
                ddlDriverGender.SelectedIndex = 0;
                ddlDriverMaritalStatus.SelectedIndex = 0;
                TxtDriverBirthDate.Text = "";
                chkUseClientInfo.Checked = false;
                txtViolationPoints.Text = "0";
                txtViolationSurchargePct.Text = "0";
                txtUnderageChargesPct.Text = "0";

                GetSurchargeAge();


                //this.GridDrivers.CurrentPageIndex = 0;
                this.GridDrivers.Visible = true;
                this.GridDrivers.DataSource = dt;
                this.GridDrivers.DataBind();
                this.GridDrivers.Visible = true;

                GridDrivers.Columns[9].Visible = false; //trafic violation
                GridDrivers.Columns[10].Visible = false; //trafic surcharge
                GridDrivers.Columns[11].Visible = true; //UnderageSurcharge
                GridDrivers.Columns[12].Visible = true;// Sumofcharges
                GridDrivers.Columns[13].Visible = true;//Gradepointavg
                GridDrivers.Columns[14].Visible = true;//delete
                GridDrivers.Columns[15].Visible = false;//TaskControl
                GridDrivers.Columns[2].Visible = false;

                //CalculatePremium();

                lblDriverGrade.Visible = false;
                TxtDriverGrade.Visible = false;

            }
            catch (Exception exp)
            {
                lblRecHeader.Text = exp.Message;
                mpeSeleccion.Show();
            }
        }

        protected void BtnAddVehicle_Click(object sender, EventArgs e)
        {
            try
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
                EPolicy.Login.Login cp = HttpContext.Current.User as EPolicy.Login.Login;
                int userID = 0;
                userID = int.Parse(cp.Identity.Name.Split("|".ToCharArray())[1]);
                DataTable dtCount = taskControl.GetAutosQuoteCount(taskControl.TaskControlID.ToString());
                DataTable dtCount2 = taskControl.GetAutosPolizaCount(taskControl.TaskControlID.ToString());

                int Years = int.Parse(ddlTerms.SelectedItem.Text.ToString().Trim()) / 12;

                #region BreakDown Collection

                if (TxtVehicleID.Text.Trim() != "")
                {
                    int CollectionCount = taskControl.VehicleBreakDownCollection.Rows.Count;
                    for (int i = 0; i < CollectionCount; i++)
                    {
                        taskControl.VehicleBreakDownCollection.Clear();
                    }

                    taskControl.VehicleBreakDownCollection.AcceptChanges();
                }
                var originalVehicleAge = TxtAge.Text;
                //Aqui dentro vas a ir llenando VehicleBreakDownCollection y cuando termine llenas VehicleCollection con la suma del los anteriores.
                for (int x = 0; x < Years; x++)
                {
                    if (taskControl.RenewalNo == "" || taskControl.CustomerCollection != "1")
                    {
                        DataTable originalcollection = new DataTable();

                        if (taskControl.RenewalNo != "" || RenewalNo != "")
                        {
                            if (Session["RenewalCollection"] != null)
                            {
                                originalcollection = ((DataTable)Session["RenewalCollection"]).Copy();
                            }
                            else
                            {
                                originalcollection = taskControl.VehicleBreakDownCollection.Copy();
                            }
                        }

                        //Adds 1 year to the Age of the Driver
                        if (x != 0)
                        {
                            TimeSpan ts = DateTime.Parse(DateTime.Now.ToShortDateString()) - DateTime.Parse(this.TxtBirthDate.Text).AddYears(-x);

                            // Difference in days.
                            double totdays = double.Parse(ts.Days.ToString());
                            double tot = 0;

                            if (totdays < 0)
                            {
                                totdays = 0;
                            }
                            else
                            {
                                tot = Math.Floor(totdays / 365);
                                TxtAge.Text = tot.ToString().Trim();
                            }
                        }

                        if (!ValidateAutoFieldsBeforeAdd())
                            return;

                        string BI = "0.00";
                        string PD = "0.00";
                        string MP = "0.00";
                        string Coll = "0.00";
                        string Comp = "0.00";
                        string Mot = "0.00";
                        string Add = "0.00";
                        string TotPrem = "0.00";
                        string RentReim = "0.00";
                        string TaxiLoss = "0.00";
                        string tempVehicleID = "0";

                        SetCompCollDeductible();
                        ValidatePhysDamageExists(ref Comp, ref Coll);
                        int MaxVehicleDetailID = 0;
                        int VehicleRowNumber = 0;
                        if (CalculateRates(ref BI, ref PD, ref MP, ref Coll, ref Comp, ref Mot, ref Add, ref RentReim, ref TaxiLoss, false))
                        {

                            if (taskControl.VehicleBreakDownCollection.Rows.Count > 0)
                            {
                                for (int i = 0; i < taskControl.VehicleBreakDownCollection.Rows.Count; i++)
                                {
                                    if (int.Parse(taskControl.VehicleBreakDownCollection.Rows[i]["VehicleDetailID"].ToString()) > MaxVehicleDetailID)
                                    {
                                        MaxVehicleDetailID = int.Parse(taskControl.VehicleBreakDownCollection.Rows[i]["VehicleDetailID"].ToString());
                                    }
                                }
                            }

                            DataTable dt = null;
                            DataRow myRow = taskControl.VehicleBreakDownCollection.NewRow();

                            if (TxtVehicleValue.Text.ToString().Trim() == "")
                            {
                                TxtVehicleValue.Text = "0";
                            }

                            myRow["VehicleDetailID"] = MaxVehicleDetailID + 1;
                            myRow["TaskControlID"] = "0";
                            myRow["VehicleYear"] = ddlVehicleYear.SelectedItem.Text.Trim();
                            myRow["VehicleMake"] = ddlVehicleMake.SelectedItem.Text.Trim().ToUpper();
                            myRow["VehicleModel"] = ddlVehicleModel.SelectedItem.Text.Trim().ToUpper();
                            myRow["BankDesc"] = ddlBankList.SelectedItem.Text.Trim().ToUpper();
                            myRow["BankPPSID"] = ddlBankList.SelectedItem.Value.Trim().ToUpper();
                            myRow["VIN"] = TxtVINNo.Text.Trim().ToUpper();
                            myRow["LicensePlateNo"] = TxtLicensePlateNo.Text.Trim().ToUpper();
                            myRow["Island"] = ddlIsland.SelectedItem.Text.ToString().Trim();
                            myRow["Status"] = ddlStatus.SelectedItem.Text.ToString().Trim();
                            myRow["VehicleValue"] = double.Parse(TxtVehicleValue.Text.ToString().Trim(), System.Globalization.NumberStyles.Currency);
                            myRow["VehicleUse"] = ddlVehicleUse.SelectedItem.Text.ToString().Trim();

                            if (BtnAddVehicle.Text != "Save Vehicle") //Session["VehicleRowNumber"] == null && 
                            {
                                if (taskControl.VehicleBreakDownCollection.Rows.Count == 0)
                                    myRow["VehicleRowNumber"] = 1;
                                else
                                    myRow["VehicleRowNumber"] = taskControl.VehicleBreakDownCollection.Rows.Count + 1;
                            }
                            else
                            {
                                myRow["VehicleRowNumber"] = Session["VehicleRowNumber"].ToString();
                            }

                            if (BtnAddVehicle.Text == "Save Vehicle")
                            {
                                //Si la el asegurado principal tiene 16 o 17 años la cubierta rental reim. no aplica
                                if (TxtAge.Text.Trim() == "16" || TxtAge.Text.Trim() == "17")
                                {
                                    lblPrimGrade.Visible = true;
                                    txtPrimGrade.Visible = true;
                                    txtPrimGrade.Enabled = true;
                                    lblRentalReim.Visible = true;
                                    radRentalReimCov.Visible = true;
                                    radRentalReimCov.Enabled = false;
                                    radRentalReimCov.SelectedIndex = 1;
                                }
                                if (radRentalReimCov.SelectedItem.Text == "Yes")
                                {

                                }
                                else
                                {
                                    RentReim = "0.00";
                                }
                            }

                            if (TxtPassengerNo.Visible == true)
                            {
                                myRow["PassengersNo"] = TxtPassengerNo.Text.ToString().Trim();
                            }
                            else
                            {
                                myRow["PassengersNo"] = 0;
                            }

                            if (radGenTons.SelectedItem.Text == "Yes")
                            {
                                myRow["Over2Tons"] = true;
                            }
                            else
                            {
                                myRow["Over2Tons"] = false;
                            }

                            if (radHeavyTruck.SelectedItem.Text == "Yes")
                            {
                                myRow["IsHeavyTruck"] = true;
                            }
                            else
                            {
                                myRow["IsHeavyTruck"] = false;
                            }

                            if (radGenMedicalPayment.SelectedItem.Text == "Yes")
                            {
                                myRow["MedicalPayment"] = true;
                            }
                            else
                            {
                                myRow["MedicalPayment"] = false;
                            }

                            if (radGenMotoristCoverage.SelectedItem.Text == "Yes")
                            {
                                myRow["MotoristCoverage"] = true;
                            }
                            else
                            {
                                myRow["MotoristCoverage"] = false;
                            }

                            if (radRentalReimCov.SelectedItem.Text == "Yes")
                            {
                                myRow["RentalReimCoverage"] = true;
                            }
                            else
                            {
                                myRow["RentalReimCoverage"] = false;
                            }

                            if (radADD.SelectedItem.Text == "Yes")
                            {
                                myRow["DeathDismembermentCoverage"] = true;
                            }
                            else
                            {
                                myRow["DeathDismembermentCoverage"] = false;
                            }

                            if (radMotorcycle.SelectedItem.Text == "Yes")
                            {
                                myRow["IsMotorcycleScooter"] = true;
                            }
                            else
                            {
                                myRow["IsMotorcycleScooter"] = false;
                            }

                            if (radTaxiDriverloss.SelectedItem.Text == "Yes")
                            {
                                myRow["TaxiLossAmount"] = Math.Round(double.Parse(TaxiLoss), 0).ToString();
                            }
                            else
                            {
                                myRow["TaxiLossAmount"] = 0.0;
                            }

                            myRow["PDLimit"] = TxtPDLimit.Text.ToString().Trim();
                            myRow["ComprehensiveDedu"] = ddlDedComp.SelectedItem.Value.ToString(); //TxtDeductibleComprehensive.Text.ToString().Trim();
                            myRow["CollisionDedu"] = ddlDedColl.SelectedItem.Value.ToString(); //TxtDeductibleCollision.Text.ToString().Trim();
                            myRow["BIPPLimit"] = TxtBILimitpp.Text.ToString().Trim();
                            myRow["BIPOLimit"] = TxtBILimitpo.Text.ToString().Trim().Replace("&amp;", "").Replace("amp;", "").Replace("nbsp;", "").Replace("&", "").Replace("&nbsp;", "");
                            myRow["MPLimit"] = txtMPLimit.Text.ToString().Trim();

                            myRow["CompPremium"] = Math.Round(double.Parse(Comp), 0).ToString(); //txtComp.Text.ToString().Trim();
                            myRow["CollPremium"] = Math.Round(double.Parse(Coll), 0).ToString(); //txtCollision.Text.ToString().Trim();
                            myRow["BIPremium"] = Math.Round(double.Parse(BI), 0).ToString();  //txtBIRate.Text.ToString().Trim();
                            myRow["PDPremium"] = Math.Round(double.Parse(PD), 0).ToString();  //txtPDRate.Text.ToString().Trim();

                            if (radGenMedicalPayment.SelectedItem.Text == "Yes")
                            {
                                myRow["MPPremium"] = Math.Round(double.Parse(MP), 0).ToString(); //txtMPRate.Text.ToString().Trim();
                            }
                            else
                            {
                                myRow["MPPremium"] = 0.0; //txtMPRate.Text.ToString().Trim();
                            }

                             //3/18/2020 Peticion por Ramon Se elimino la comparacion de Prima con PPS a partir del 6/01/2020
                            if (DateTime.Parse(taskControl.EffectiveDate) >= DateTime.Parse("03/01/2019") && DateTime.Parse(taskControl.EffectiveDate) <= DateTime.Parse("05/31/2020"))
                            {
                                if (taskControl.RenewalNo != "" || RenewalNo != "")
                                {
                                    if (Session["RenewalCollection"] != null)
                                    {
                                        string RBI = BI, RPD = PD, RMP = MP, Passengers = TxtPassengerNo.Text.ToString().Trim();
                                        if (originalcollection.Rows.Count > 0)
                                        {
                                            for (int i = 0; originalcollection.Rows.Count > i; i++)
                                            {
                                                if ((originalcollection.Rows[i]["VehicleYear"].ToString() == ddlVehicleYear.SelectedItem.Text.Trim() &&
                                    originalcollection.Rows[i]["VehicleMake"].ToString() == ddlVehicleMake.SelectedItem.Text.Trim().ToUpper() &&
                                    originalcollection.Rows[i]["VehicleModel"].ToString() == ddlVehicleModel.SelectedItem.Text.Trim().ToUpper() &&
                                    originalcollection.Rows[i]["VIN"].ToString() == TxtVINNo.Text.Trim().ToUpper()) && (originalcollection.Rows[i]["CompPremium"].ToString().Trim() == "0" && originalcollection.Rows[i]["CollPremium"].ToString().Trim() == "0"))
                                                {

                                                    string UseClass = originalcollection.Rows[i]["VehicleUse"].ToString() == "Private" ? "P" : originalcollection.Rows[i]["VehicleUse"].ToString() == "Commercial" ? "C" : originalcollection.Rows[i]["VehicleUse"].ToString() == "Taxi" ? "T" : "R";
                                                    string Island = originalcollection.Rows[i]["Island"].ToString() == "St. Thomas" ? "1" : originalcollection.Rows[i]["Island"].ToString() == "St. Croix" ? "2" : "3";//ChildsElement["Island"].InnerText == "1" ? "3" : ChildsElement["Island"].InnerText == "2" ? "1" : ChildsElement["Island"].InnerText == "3" ? "2" : "";
                                                    string Motorcycle = bool.Parse(originalcollection.Rows[i]["IsMotorcycleScooter"].ToString()) == true ? "Y" : "N";

                                                    RBI = originalcollection.Rows[i]["BIPremium"].ToString();
                                                    RPD = originalcollection.Rows[i]["PDPremium"].ToString();
                                                    RMP = originalcollection.Rows[i]["MPPremium"].ToString();
                                                    Passengers = originalcollection.Rows[i]["PassengersNo"].ToString();

                                                    String[] Rates = new String[3];
                                                    Rates = CompareRenewalLiabRates(RBI, RPD, RMP, UseClass, Island, "N", Motorcycle, Passengers, "N");
                                                    RBI = Rates[0];
                                                    RPD = Rates[1];
                                                    RMP = Rates[2];
                                                    break;
                                                }
                                            }
                                        }

                                        myRow["BIPremium"] = Math.Round(double.Parse(RBI), 0).ToString();
                                        myRow["PDPremium"] = Math.Round(double.Parse(RPD), 0).ToString();
                                        myRow["MPPremium"] = Math.Round(double.Parse(RMP), 0).ToString();
                                    }
                                    else
                                    {
                                        string RBI = BI, RPD = PD, RMP = MP, Passengers = TxtPassengerNo.Text.ToString().Trim();
                                        if (originalcollection.Rows.Count > 0)
                                        {
                                            for (int i = 0; originalcollection.Rows.Count > i; i++)
                                            {
                                                if ((originalcollection.Rows[i]["VehicleYear"].ToString() == ddlVehicleYear.SelectedItem.Text.Trim() &&
                                    originalcollection.Rows[i]["VehicleMake"].ToString() == ddlVehicleMake.SelectedItem.Text.Trim().ToUpper() &&
                                    originalcollection.Rows[i]["VehicleModel"].ToString() == ddlVehicleModel.SelectedItem.Text.Trim().ToUpper() &&
                                    originalcollection.Rows[i]["VIN"].ToString() == TxtVINNo.Text.Trim().ToUpper()) && (originalcollection.Rows[i]["CompPremium"].ToString().Trim() == "0" && originalcollection.Rows[i]["CollPremium"].ToString().Trim() == "0"))
                                                {

                                                    string UseClass = originalcollection.Rows[i]["VehicleUse"].ToString() == "Private" ? "P" : originalcollection.Rows[i]["VehicleUse"].ToString() == "Commercial" ? "C" : originalcollection.Rows[i]["VehicleUse"].ToString() == "Taxi" ? "T" : "R";
                                                    string Island = originalcollection.Rows[i]["Island"].ToString() == "St. Thomas" ? "1" : originalcollection.Rows[i]["Island"].ToString() == "St. Croix" ? "2" : "3";//ChildsElement["Island"].InnerText == "1" ? "3" : ChildsElement["Island"].InnerText == "2" ? "1" : ChildsElement["Island"].InnerText == "3" ? "2" : "";
                                                    string Motorcycle = bool.Parse(originalcollection.Rows[i]["IsMotorcycleScooter"].ToString()) == true ? "Y" : "N";

                                                    RBI = originalcollection.Rows[i]["BIPremium"].ToString();
                                                    RPD = originalcollection.Rows[i]["PDPremium"].ToString();
                                                    RMP = originalcollection.Rows[i]["MPPremium"].ToString();
                                                    Passengers = originalcollection.Rows[i]["PassengersNo"].ToString();

                                                    String[] Rates = new String[3];
                                                    Rates = CompareRenewalLiabRates(RBI, RPD, RMP, UseClass, Island, "N", Motorcycle, Passengers, "N");
                                                    RBI = Rates[0];
                                                    RPD = Rates[1];
                                                    RMP = Rates[2];
                                                    break;
                                                }
                                            }
                                        }

                                        myRow["BIPremium"] = Math.Round(double.Parse(RBI), 0).ToString();
                                        myRow["PDPremium"] = Math.Round(double.Parse(RPD), 0).ToString();
                                        myRow["MPPremium"] = Math.Round(double.Parse(RMP), 0).ToString();
                                    }
                                }
                            }

                            myRow["MotoristPremium"] = Math.Round(double.Parse(Mot), 0).ToString();  //txtMotorist.Text.ToString().Trim();
                            myRow["ADDPremium"] = Math.Round(double.Parse(Add), 0).ToString(); //txtADD.Text.ToString().Trim();
                            myRow["RentalReim"] = Math.Round(double.Parse(RentReim), 0).ToString();  //txtADD.Text.ToString().Trim();
                            myRow["TaxiLossAmount"] = Math.Round(double.Parse(TaxiLoss), 0).ToString();

                            TotPrem = (double.Parse(Comp) + double.Parse(Coll) +
                                double.Parse(BI) + double.Parse(PD) +
                                double.Parse(MP) + double.Parse(Mot) +
                                double.Parse(Add) + double.Parse(RentReim) +
                                double.Parse(TaxiLoss)).ToString();

                            myRow["ViolationSurcharge"] = 0.0;
                            myRow["UnderAgeSurcharge"] = 0.0;

                            myRow["TotalPremium"] = Math.Round(double.Parse(TotPrem), 0).ToString();  //txtTotalPremiumVehicle.Text.ToString().Trim();
                            myRow["OtherSurchargePct"] = double.Parse(txtOtherSurcharge.Text.ToString());
                            myRow["OtherSurcharge"] = (Math.Round((double.Parse(txtOtherSurcharge.Text.ToString().Trim()) / 100) * Math.Round(double.Parse(TotPrem), 0), 0)).ToString();


                            taskControl.VehicleBreakDownCollection.Rows.Add(myRow);
                            taskControl.VehicleBreakDownCollection.AcceptChanges();

                            DataView dv = taskControl.VehicleBreakDownCollection.DefaultView;
                            dv.Sort = "VehicleRowNumber";
                            taskControl.VehicleBreakDownCollection = dv.ToTable();
                            taskControl.VehicleBreakDownCollection.AcceptChanges();

                            TxtExpBinderDate.Text = TxtEffBinderDate.Text != "" ? DateTime.Parse(TxtEffBinderDate.Text.Trim()).AddYears(Years).ToShortDateString() : "";

                            if (txtTotalPremiumVehicle.Text.ToString().Trim() == "")
                                txtTotalPremiumVehicle.Text = "0.00";

                            if (BtnAddVehicle.Text == "Save Vehicle")
                            {
                                TxtBirthDate_TextChanged(String.Empty, EventArgs.Empty);
                            }

                            this.BtnAddVehicle.Text = "Add Vehicle";
                            lblModifyVehicle.Visible = false;
                            GridVehicle.BorderColor = Color.Black;
                            GridDrivers.BorderColor = Color.Black;

                            // se puso en comentario ya que Maureen no queria que los valores se fueran a su estado "basic", se dejo la informacion que ya estaba entrada (limites, cubiertas, etc)

                            ValidateBI();
                            EnableDisableBusinessAuto();

                        }
                    }
                    else
                    {
                        BtnCancelVehicle_Click(String.Empty, EventArgs.Empty);
                    }
                }

                #endregion BreakDown Collection

                #region VehicleDetail Collection

                try
                {
                    //Reset Vehicle Value
                    TxtAge.Text = originalVehicleAge;

                    int VehicleValue = 0;
                    DataTable dt = null;
                    if (TxtVehicleID.Text.Trim() != "")
                    {
                        for (int a = 0; a < taskControl.VehicleCollection.Rows.Count; a++)
                        {
                            taskControl.VehicleCollection.Rows.RemoveAt(a);
                        }

                        taskControl.VehicleCollection.AcceptChanges();
                    }

                    int MostMinor = 0;
                    double CompPremium = 0;
                    double CollPremium = 0;

                    for (int M = 0; M < taskControl.DriversCollection.Rows.Count; M++)
                    {
                        MostMinor = int.Parse(taskControl.DriversCollection.Rows[0]["DriverAge"].ToString().Trim());
                        if (MostMinor > int.Parse(taskControl.DriversCollection.Rows[M]["DriverAge"].ToString().Trim()))
                        {
                            MostMinor = int.Parse(taskControl.DriversCollection.Rows[M]["DriverAge"].ToString().Trim());
                        }
                        else
                        {
                            MostMinor = int.Parse(taskControl.DriversCollection.Rows[0]["DriverAge"].ToString().Trim());
                        }
                    }

                    for (int i = 0; i < taskControl.VehicleBreakDownCollection.Rows.Count; i++)
                    {
                        string BI = "0.00";
                        string PD = "0.00";
                        string MP = "0.00";
                        string Coll = "0.00";
                        string Comp = "0.00";
                        string Mot = "0.00";
                        string Add = "0.00";
                        string TotPrem = "0.00";
                        string RentReim = "0.00";
                        string TaxiLoss = "0.00";
                        string tempVehicleID = "0";

                        if (i == 0)
                        {
                            #region myrows
                            EPolicy.TaskControl.DoubleInterest taskControl2 = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
                            EPolicy.Login.Login cp2 = HttpContext.Current.User as EPolicy.Login.Login;

                            DataRow myRow = taskControl.VehicleCollection.NewRow();

                            if (taskControl.RenewalNo == "" || taskControl.CustomerCollection != "1")
                            {
                                DataTable originalcollection = new DataTable();

                                if (taskControl.RenewalNo != "" || RenewalNo != "")
                                {
                                    if (Session["RenewalCollection"] != null)
                                    {
                                        originalcollection = ((DataTable)Session["RenewalCollection"]).Copy();
                                    }
                                    else
                                    {
                                        originalcollection = taskControl.VehicleBreakDownCollection.Copy();
                                    }
                                }

                                SetCompCollDeductible();
                                ValidatePhysDamageExists(ref Comp, ref Coll);
                                int MaxVehicleDetailID = 0;
                                int VehicleRowNumber = 0;
                                if (CalculateRates(ref BI, ref PD, ref MP, ref Coll, ref Comp, ref Mot, ref Add, ref RentReim, ref TaxiLoss, false))
                                {
                                    if (taskControl.VehicleCollection.Rows.Count > 0)
                                    {
                                        for (int a = 0; a < taskControl.VehicleCollection.Rows.Count; a++)
                                        {
                                            if (int.Parse(taskControl.VehicleCollection.Rows[a]["VehicleDetailID"].ToString()) > MaxVehicleDetailID)
                                            {
                                                MaxVehicleDetailID = int.Parse(taskControl.VehicleCollection.Rows[a]["VehicleDetailID"].ToString());
                                            }
                                        }
                                    }


                                    if (TxtVehicleValue.Text.ToString().Trim() == "")
                                    {
                                        TxtVehicleValue.Text = "0";
                                    }

                                    myRow["VehicleDetailID"] = MaxVehicleDetailID + 1;
                                    myRow["TaskControlID"] = "0";
                                    myRow["VehicleYear"] = ddlVehicleYear.SelectedItem.Text.Trim();
                                    myRow["VehicleMake"] = ddlVehicleMake.SelectedItem.Text.Trim().ToUpper();
                                    myRow["VehicleModel"] = ddlVehicleModel.SelectedItem.Text.Trim().ToUpper();
                                    myRow["BankDesc"] = ddlBankList.SelectedItem.Text.Trim().ToUpper();
                                    myRow["BankPPSID"] = ddlBankList.SelectedItem.Value.Trim().ToUpper();
                                    myRow["VIN"] = TxtVINNo.Text.Trim().ToUpper();
                                    myRow["LicensePlateNo"] = TxtLicensePlateNo.Text.Trim().ToUpper();

                                    myRow["Island"] = ddlIsland.SelectedItem.Text.ToString().Trim();
                                    myRow["Status"] = ddlStatus.SelectedItem.Text.ToString().Trim();
                                    myRow["VehicleValue"] = double.Parse(TxtVehicleValue.Text.ToString().Trim(), System.Globalization.NumberStyles.Currency);
                                    myRow["VehicleUse"] = ddlVehicleUse.SelectedItem.Text.ToString().Trim();

                                    if (BtnAddVehicle.Text != "Save Vehicle") //Session["VehicleRowNumber"] == null && 
                                    {
                                        if (taskControl.VehicleCollection.Rows.Count == 0)
                                            myRow["VehicleRowNumber"] = 1;
                                        else
                                            myRow["VehicleRowNumber"] = taskControl.VehicleCollection.Rows.Count + 1;
                                    }
                                    else
                                    {
                                        myRow["VehicleRowNumber"] = Session["VehicleRowNumber"].ToString();
                                    }

                                    if (BtnAddVehicle.Text == "Save Vehicle")
                                    {
                                        //Si la el asegurado principal tiene 16 o 17 años la cubierta rental reim. no aplica
                                        if (TxtAge.Text.Trim() == "16" || TxtAge.Text.Trim() == "17")
                                        {
                                            lblPrimGrade.Visible = true;
                                            txtPrimGrade.Visible = true;
                                            txtPrimGrade.Enabled = true;
                                            lblRentalReim.Visible = true;
                                            radRentalReimCov.Visible = true;
                                            radRentalReimCov.Enabled = false;
                                            radRentalReimCov.SelectedIndex = 1;
                                            //txtPrimGrade.Text = "";
                                        }
                                        if (radRentalReimCov.SelectedItem.Text == "Yes")
                                        {

                                        }
                                        else
                                        {
                                            RentReim = "0.00";
                                        }
                                    }

                                    if (TxtPassengerNo.Visible == true)
                                    {
                                        myRow["PassengersNo"] = TxtPassengerNo.Text.ToString().Trim();
                                    }
                                    else
                                    {
                                        myRow["PassengersNo"] = 0;
                                    }

                                    if (radGenTons.SelectedItem.Text == "Yes")
                                    {
                                        myRow["Over2Tons"] = true;
                                    }
                                    else
                                    {
                                        myRow["Over2Tons"] = false;
                                    }

                                    if (radHeavyTruck.SelectedItem.Text == "Yes")
                                    {
                                        myRow["IsHeavyTruck"] = true;
                                    }
                                    else
                                    {
                                        myRow["IsHeavyTruck"] = false;
                                    }

                                    if (radGenMedicalPayment.SelectedItem.Text == "Yes")
                                    {
                                        myRow["MedicalPayment"] = true;
                                    }
                                    else
                                    {
                                        myRow["MedicalPayment"] = false;
                                    }

                                    if (radGenMotoristCoverage.SelectedItem.Text == "Yes")
                                    {
                                        myRow["MotoristCoverage"] = true;
                                    }
                                    else
                                    {
                                        myRow["MotoristCoverage"] = false;
                                    }

                                    if (radRentalReimCov.SelectedItem.Text == "Yes")
                                    {
                                        myRow["RentalReimCoverage"] = true;
                                    }
                                    else
                                    {
                                        myRow["RentalReimCoverage"] = false;
                                    }

                                    if (radADD.SelectedItem.Text == "Yes")
                                    {
                                        myRow["DeathDismembermentCoverage"] = true;
                                    }
                                    else
                                    {
                                        myRow["DeathDismembermentCoverage"] = false;
                                    }

                                    if (radMotorcycle.SelectedItem.Text == "Yes")
                                    {
                                        myRow["IsMotorcycleScooter"] = true;
                                    }
                                    else
                                    {
                                        myRow["IsMotorcycleScooter"] = false;
                                    }

                                    if (radTaxiDriverloss.SelectedItem.Text == "Yes")
                                    {
                                        //myRow["TaxiLossAmount"] = true;
                                        myRow["TaxiLossAmount"] = Math.Round(double.Parse(TaxiLoss), 0).ToString();
                                    }
                                    else
                                    {
                                        // myRow["TaxiLossAmount"] = false;

                                        myRow["TaxiLossAmount"] = 0.0;
                                    }

                                    //myRow["ViolationPoints"] = TxtTrafficViolationPoints.Text.ToString().Trim();
                                    //myRow["ViolationSurcharge"] = TxtTrafficViolationSurcharge.Text.ToString().Trim();
                                    //myRow["UnderAgeSurcharge"] = TxtUnderAgeSurcharge.Text.ToString().Trim();

                                    myRow["PDLimit"] = TxtPDLimit.Text.ToString().Trim();
                                    myRow["ComprehensiveDedu"] = ddlDedComp.SelectedItem.Value.ToString(); //TxtDeductibleComprehensive.Text.ToString().Trim();
                                    myRow["CollisionDedu"] = ddlDedColl.SelectedItem.Value.ToString(); //TxtDeductibleCollision.Text.ToString().Trim();
                                    myRow["BIPPLimit"] = TxtBILimitpp.Text.ToString().Trim();
                                    myRow["BIPOLimit"] = TxtBILimitpo.Text.ToString().Trim().Replace("&amp;", "").Replace("amp;", "").Replace("nbsp;", "").Replace("&", "").Replace("&nbsp;", "");
                                    myRow["MPLimit"] = txtMPLimit.Text.ToString().Trim();

                                    myRow["CompPremium"] = Math.Round(double.Parse(Comp), 0).ToString(); //txtComp.Text.ToString().Trim();
                                    myRow["CollPremium"] = Math.Round(double.Parse(Coll), 0).ToString(); //txtCollision.Text.ToString().Trim();
                                    myRow["BIPremium"] = Math.Round(double.Parse(BI), 0).ToString();  //txtBIRate.Text.ToString().Trim();
                                    myRow["PDPremium"] = Math.Round(double.Parse(PD), 0).ToString();  //txtPDRate.Text.ToString().Trim();

                                    if (radGenMedicalPayment.SelectedItem.Text == "Yes")
                                    {
                                        myRow["MPPremium"] = Math.Round(double.Parse(MP), 0).ToString(); //txtMPRate.Text.ToString().Trim();
                                    }
                                    else
                                    {
                                        myRow["MPPremium"] = 0.0; //txtMPRate.Text.ToString().Trim();
                                    }

                                    if (taskControl.RenewalNo != "" || RenewalNo != "")
                                    {
                                        if (Session["RenewalCollection"] != null)
                                        {
                                            //DataTable originalcollection = new DataTable();
                                            //originalcollection = taskControl.VehicleCollection.Copy();
                                            //taskControl.VehicleCollection

                                            //originalcollection = ((DataTable)Session["RenewalCollection"]).Copy();

                                            string RBI = BI, RPD = PD, RMP = MP, Passengers = TxtPassengerNo.Text.ToString().Trim();
                                            if (originalcollection.Rows.Count > 0)
                                            {
                                                for (int z = 0; originalcollection.Rows.Count > z; z++)
                                                {
                                                    if ((originalcollection.Rows[z]["VehicleYear"].ToString() == ddlVehicleYear.SelectedItem.Text.Trim() &&
                                        originalcollection.Rows[z]["VehicleMake"].ToString() == ddlVehicleMake.SelectedItem.Text.Trim().ToUpper() &&
                                        originalcollection.Rows[z]["VehicleModel"].ToString() == ddlVehicleModel.SelectedItem.Text.Trim().ToUpper() &&
                                        originalcollection.Rows[z]["VIN"].ToString() == TxtVINNo.Text.Trim().ToUpper()) && (originalcollection.Rows[z]["CompPremium"].ToString().Trim() == "0" && originalcollection.Rows[z]["CollPremium"].ToString().Trim() == "0"))
                                                    {

                                                        string UseClass = originalcollection.Rows[z]["VehicleUse"].ToString() == "Private" ? "P" : originalcollection.Rows[z]["VehicleUse"].ToString() == "Commercial" ? "C" : originalcollection.Rows[z]["VehicleUse"].ToString() == "Taxi" ? "T" : "R";
                                                        string Island = originalcollection.Rows[z]["Island"].ToString() == "St. Thomas" ? "1" : originalcollection.Rows[z]["Island"].ToString() == "St. Croix" ? "2" : "3";//ChildsElement["Island"].InnerText == "1" ? "3" : ChildsElement["Island"].InnerText == "2" ? "1" : ChildsElement["Island"].InnerText == "3" ? "2" : "";
                                                        string Motorcycle = bool.Parse(originalcollection.Rows[z]["IsMotorcycleScooter"].ToString()) == true ? "Y" : "N";

                                                        RBI = originalcollection.Rows[z]["BIPremium"].ToString();
                                                        RPD = originalcollection.Rows[z]["PDPremium"].ToString();
                                                        RMP = originalcollection.Rows[z]["MPPremium"].ToString();
                                                        Passengers = originalcollection.Rows[z]["PassengersNo"].ToString();

                                                        String[] Rates = new String[3];
                                                        Rates = CompareRenewalLiabRates(RBI, RPD, RMP, UseClass, Island, "N", Motorcycle, Passengers, "N");
                                                        RBI = Rates[0];
                                                        RPD = Rates[1];
                                                        RMP = Rates[2];
                                                        break;
                                                    }
                                                }
                                            }

                                            myRow["BIPremium"] = Math.Round(double.Parse(RBI), 0).ToString();
                                            myRow["PDPremium"] = Math.Round(double.Parse(RPD), 0).ToString();
                                            myRow["MPPremium"] = Math.Round(double.Parse(RMP), 0).ToString();
                                        }
                                        else
                                        {
                                            //originalcollection = taskControl.VehicleCollection.Copy();

                                            string RBI = BI, RPD = PD, RMP = MP, Passengers = TxtPassengerNo.Text.ToString().Trim();
                                            if (originalcollection.Rows.Count > 0)
                                            {
                                                for (int a = 0; originalcollection.Rows.Count > a; a++)
                                                {
                                                    if ((originalcollection.Rows[a]["VehicleYear"].ToString() == ddlVehicleYear.SelectedItem.Text.Trim() &&
                                        originalcollection.Rows[a]["VehicleMake"].ToString() == ddlVehicleMake.SelectedItem.Text.Trim().ToUpper() &&
                                        originalcollection.Rows[a]["VehicleModel"].ToString() == ddlVehicleModel.SelectedItem.Text.Trim().ToUpper() &&
                                        originalcollection.Rows[a]["VIN"].ToString() == TxtVINNo.Text.Trim().ToUpper()) && (originalcollection.Rows[a]["CompPremium"].ToString().Trim() == "0" && originalcollection.Rows[a]["CollPremium"].ToString().Trim() == "0"))
                                                    {

                                                        string UseClass = originalcollection.Rows[a]["VehicleUse"].ToString() == "Private" ? "P" : originalcollection.Rows[a]["VehicleUse"].ToString() == "Commercial" ? "C" : originalcollection.Rows[a]["VehicleUse"].ToString() == "Taxi" ? "T" : "R";
                                                        string Island = originalcollection.Rows[a]["Island"].ToString() == "St. Thomas" ? "1" : originalcollection.Rows[a]["Island"].ToString() == "St. Croix" ? "2" : "3";//ChildsElement["Island"].InnerText == "1" ? "3" : ChildsElement["Island"].InnerText == "2" ? "1" : ChildsElement["Island"].InnerText == "3" ? "2" : "";
                                                        string Motorcycle = bool.Parse(originalcollection.Rows[a]["IsMotorcycleScooter"].ToString()) == true ? "Y" : "N";

                                                        RBI = originalcollection.Rows[a]["BIPremium"].ToString();
                                                        RPD = originalcollection.Rows[a]["PDPremium"].ToString();
                                                        RMP = originalcollection.Rows[a]["MPPremium"].ToString();
                                                        Passengers = originalcollection.Rows[a]["PassengersNo"].ToString();

                                                        String[] Rates = new String[3];
                                                        Rates = CompareRenewalLiabRates(RBI, RPD, RMP, UseClass, Island, "N", Motorcycle, Passengers, "N");
                                                        RBI = Rates[0];
                                                        RPD = Rates[1];
                                                        RMP = Rates[2];
                                                        break;
                                                    }
                                                }
                                            }

                                            myRow["BIPremium"] = Math.Round(double.Parse(RBI), 0).ToString();
                                            myRow["PDPremium"] = Math.Round(double.Parse(RPD), 0).ToString();
                                            myRow["MPPremium"] = Math.Round(double.Parse(RMP), 0).ToString();
                                        }
                                    }

                                    myRow["MotoristPremium"] = Math.Round(double.Parse(Mot), 0).ToString();  //txtMotorist.Text.ToString().Trim();
                                    myRow["ADDPremium"] = Math.Round(double.Parse(Add), 0).ToString(); //txtADD.Text.ToString().Trim();
                                    myRow["RentalReim"] = Math.Round(double.Parse(RentReim), 0).ToString();  //txtADD.Text.ToString().Trim();
                                    myRow["TaxiLossAmount"] = Math.Round(double.Parse(TaxiLoss), 0).ToString();

                                    TotPrem = (double.Parse(Comp) + double.Parse(Coll) +
                                        double.Parse(BI) + double.Parse(PD) +
                                        double.Parse(MP) + double.Parse(Mot) +
                                        double.Parse(Add) + double.Parse(RentReim) +
                                        double.Parse(TaxiLoss)).ToString();

                                    myRow["ViolationSurcharge"] = 0.0;
                                    myRow["UnderAgeSurcharge"] = 0.0;

                                    myRow["TotalPremium"] = Math.Round(double.Parse(TotPrem), 0).ToString();  //txtTotalPremiumVehicle.Text.ToString().Trim();
                                    myRow["OtherSurchargePct"] = double.Parse(txtOtherSurcharge.Text.ToString());
                                    myRow["OtherSurcharge"] = (Math.Round((double.Parse(txtOtherSurcharge.Text.ToString().Trim()) / 100) * Math.Round(double.Parse(TotPrem), 0), 0)).ToString();


                                    taskControl.VehicleCollection.Rows.Add(myRow);
                                    taskControl.VehicleCollection.AcceptChanges();



                                }
                            }
                            #endregion
                        }
                        else
                        {

                            string Island = taskControl.VehicleCollection.Rows[0]["Island"].ToString().Trim() == "St. Thomas" ? "1" : taskControl.VehicleCollection.Rows[0]["Island"].ToString().Trim() == "St. Croix" ? "2" : "3";
                            string UseCode = taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString().Trim() == "Commercial" ? "C" : taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString().Trim() == "Private Passenger" ? "O" : taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString().Trim() == "Private" ? "P" : taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString().Trim() == "Rental" ? "R" : "T";
                            MostMinor++;

                            //TODO TERMINAR COMPARACION DE EFFDATE y VEHICLEYEAR ENTRE MESES SEPTIEMBRE LLEGAN AUTOS DEL PROX. ANO SEP 2018 salen 2019
                            //Si es el Primer año (1era Renovacion) la depreciación es 7.5% (0.925)
                            double Depreciation = 0;
                            DateTime CarDate = new DateTime(int.Parse(taskControl.VehicleCollection.Rows[0]["VehicleYear"].ToString().Trim()) - 1, 9, 1);

                            int dateMonths = 0;
                            dateMonths = ((DateTime.Parse(taskControl.EffectiveDate.ToString()).Year - CarDate.Year) * 12) + DateTime.Parse(taskControl.EffectiveDate.ToString()).Month - CarDate.Month;

                            //Si es el Primer año (1era Renovacion) la depreciación es 7.5%
                            if (dateMonths >= 12)
                            {
                                //==============================================//
                                //(0.975) = depreciación de 2.5% FULLCOVER ONLY //
                                //==============================================//
                                Depreciation = 0.975;
                            }
                            else
                            {
                                if (i == 1)
                                {
                                    //==============================================//
                                    //(0.925) = depreciación de 7.5% FULLCOVER ONLY //
                                    //==============================================//
                                    Depreciation = 0.925;
                                }
                                else
                                {
                                    //==============================================//
                                    //(0.975) = depreciación de 2.5% FULLCOVER ONLY //
                                    //==============================================//
                                    Depreciation = 0.975;
                                }
                            }

                            if (taskControl.VehicleCollection.Rows[0]["VehicleValue"] != null)
                            {
                                if (taskControl.VehicleCollection.Rows[0]["VehicleValue"].ToString().Trim() != "" && taskControl.VehicleCollection.Rows[0]["VehicleValue"].ToString().Trim() != "0")
                                {
                                    VehicleValue = int.Parse(taskControl.VehicleBreakDownCollection.Rows[i - 1]["VehicleValue"].ToString().Trim());
                                    taskControl.VehicleBreakDownCollection.Rows[i]["VehicleValue"] = (Math.Round(float.Parse(VehicleValue.ToString()) * Depreciation, 0)).ToString();
                                    taskControl.VehicleCollection.Rows[0]["VehicleValue"] = (Math.Round(float.Parse(VehicleValue.ToString()) * Depreciation, 0)).ToString();
                                    DataTable dtPhsDam = GetPhysicalDamageRates(UseCode, Island, int.Parse(taskControl.VehicleCollection.Rows[0]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), "N", int.Parse(taskControl.VehicleCollection.Rows[0]["VehicleYear"].ToString().Trim()), MostMinor, int.Parse(taskControl.VehicleCollection.Rows[0]["PassengersNo"].ToString().Trim()));

                                    #region Ya no se va a retarifar el comp y coll de la renovacion

                                    FillPhysDam(UseCode, Island, int.Parse(taskControl.VehicleCollection.Rows[0]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), "N", int.Parse(taskControl.VehicleCollection.Rows[0]["VehicleYear"].ToString().Trim()), MostMinor, int.Parse(taskControl.VehicleCollection.Rows[0]["PassengersNo"].ToString().Trim()));
                                    ddlCompCollDed.SelectedIndex = 0;
                                    SetCompCollDeductible();

                                    taskControl.VehicleCollection.Rows[0]["ComprehensiveDedu"] = ddlDedComp.SelectedItem.Value.ToString();
                                    taskControl.VehicleCollection.Rows[0]["CollisionDedu"] = ddlDedColl.SelectedItem.Value.ToString();

                                    if (ddlDedComp.SelectedItem.Value.ToString() == "$250" && ddlDedColl.SelectedItem.Value.ToString() == "$500")
                                    {
                                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                                        {
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CompPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Comp250_500"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[0]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();

                                            taskControl.VehicleBreakDownCollection.Rows[i]["CollPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Coll250_500"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[0]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();
                                        }
                                        else
                                        {
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CompPremium"] = dtPhsDam.Rows[0]["Comp250_500"].ToString();
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CollPremium"] = dtPhsDam.Rows[0]["Coll250_500"].ToString();
                                        }
                                    }
                                    else if (ddlDedComp.SelectedItem.Value.ToString() == "$500" && ddlDedColl.SelectedItem.Value.ToString() == "$500")
                                    {
                                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                                        {
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CompPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Comp500_500"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[0]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();

                                            taskControl.VehicleBreakDownCollection.Rows[i]["CollPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Coll500_500"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[0]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();
                                        }
                                        else
                                        {
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CompPremium"] = dtPhsDam.Rows[0]["Comp500_500"].ToString();
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CollPremium"] = dtPhsDam.Rows[0]["Coll500_500"].ToString();
                                        }
                                    }
                                    else if (ddlDedComp.SelectedItem.Value.ToString() == "$500" && ddlDedColl.SelectedItem.Value.ToString() == "$1,000")
                                    {
                                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                                        {
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CompPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Comp500_1000"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[0]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();

                                            taskControl.VehicleBreakDownCollection.Rows[i]["CollPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Coll500_1000"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[0]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();
                                        }
                                        else
                                        {
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CompPremium"] = dtPhsDam.Rows[0]["Comp500_1000"].ToString();
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CollPremium"] = dtPhsDam.Rows[0]["Coll500_1000"].ToString();
                                        }
                                    }
                                    else if (ddlDedComp.SelectedItem.Value.ToString() == "$1,000" && ddlDedColl.SelectedItem.Value.ToString() == "$1,000")
                                    {
                                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                                        {
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CompPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Comp1000_1000"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[0]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();

                                            taskControl.VehicleBreakDownCollection.Rows[i]["CollPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Coll1000_1000"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[0]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();
                                        }
                                        else
                                        {
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CompPremium"] = dtPhsDam.Rows[0]["Comp1000_1000"].ToString();
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CollPremium"] = dtPhsDam.Rows[0]["Coll1000_1000"].ToString();
                                        }
                                    }
                                    else if (ddlDedComp.SelectedItem.Value.ToString() == "$1,000" && ddlDedColl.SelectedItem.Value.ToString() == "$1,500")
                                    {
                                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                                        {
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CompPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Comp1000_1500"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[0]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();

                                            taskControl.VehicleBreakDownCollection.Rows[i]["CollPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Coll1000_1500"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[0]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();
                                        }
                                        else
                                        {
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CompPremium"] = dtPhsDam.Rows[0]["Comp1000_1500"].ToString();
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CollPremium"] = dtPhsDam.Rows[0]["Coll1000_1500"].ToString();
                                        }
                                    }
                                    else if (ddlDedComp.SelectedItem.Value.ToString() == "$1,000" && ddlDedColl.SelectedItem.Value.ToString() == "$2,500")
                                    {
                                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                                        {
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CompPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Comp1000_2500"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[0]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();

                                            taskControl.VehicleBreakDownCollection.Rows[i]["CollPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Coll1000_2500"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[0]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();
                                        }
                                        else
                                        {
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CompPremium"] = dtPhsDam.Rows[0]["Comp1000_2500"].ToString();
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CollPremium"] = dtPhsDam.Rows[0]["Coll1000_2500"].ToString();
                                        }
                                    }
                                    else if (ddlDedComp.SelectedItem.Value.ToString() == "$1,500" && ddlDedColl.SelectedItem.Value.ToString() == "$2,500")
                                    {
                                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                                        {
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CompPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Comp1500_2500"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[0]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();

                                            taskControl.VehicleBreakDownCollection.Rows[i]["CollPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Coll1500_2500"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[0]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();
                                        }
                                        else
                                        {
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CompPremium"] = dtPhsDam.Rows[0]["Comp1500_2500"].ToString();
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CollPremium"] = dtPhsDam.Rows[0]["Coll1500_2500"].ToString();
                                        }
                                    }
                                    else if (ddlDedComp.SelectedItem.Value.ToString() == "$2,500" && ddlDedColl.SelectedItem.Value.ToString() == "$5,000")
                                    {
                                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                                        {
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CompPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Comp2500_5000"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[0]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();

                                            taskControl.VehicleBreakDownCollection.Rows[i]["CollPremium"] = (Math.Round(float.Parse(dtPhsDam.Rows[0]["Coll2500_5000"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[0]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), 0)).ToString();
                                        }
                                        else
                                        {
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CompPremium"] = dtPhsDam.Rows[0]["Comp2500_5000"].ToString();
                                            taskControl.VehicleBreakDownCollection.Rows[i]["CollPremium"] = dtPhsDam.Rows[0]["Coll2500_5000"].ToString();
                                        }
                                    }
                                    #endregion

                                    taskControl.VehicleBreakDownCollection.Rows[i]["TotalPremium"] =
                                            double.Parse(taskControl.VehicleBreakDownCollection.Rows[i]["CompPremium"].ToString()) +
                                            double.Parse(taskControl.VehicleBreakDownCollection.Rows[i]["CollPremium"].ToString()) +
                                            double.Parse(taskControl.VehicleBreakDownCollection.Rows[i]["BIPremium"].ToString()) +
                                            double.Parse(taskControl.VehicleBreakDownCollection.Rows[i]["PDPremium"].ToString()) +
                                            double.Parse(taskControl.VehicleBreakDownCollection.Rows[i]["MPPremium"].ToString()) +
                                            double.Parse(taskControl.VehicleBreakDownCollection.Rows[i]["MotoristPremium"].ToString()) +
                                            double.Parse(taskControl.VehicleBreakDownCollection.Rows[i]["ADDPremium"].ToString()) +
                                            double.Parse(taskControl.VehicleBreakDownCollection.Rows[i]["RentalReim"].ToString()) +
                                            double.Parse(taskControl.VehicleBreakDownCollection.Rows[i]["TaxiLossAmount"].ToString());

                                    taskControl.VehicleBreakDownCollection.Rows[i]["ViolationSurcharge"] = "0.0";
                                    taskControl.VehicleBreakDownCollection.Rows[i]["UnderAgeSurcharge"] = "0.0";
                                    taskControl.VehicleBreakDownCollection.Rows[i]["OtherSurcharge"] = "0.0";
                                    taskControl.VehicleBreakDownCollection.AcceptChanges();
                                }
                            }
                            taskControl.VehicleCollection.Rows[0]["CompPremium"] =
                                double.Parse(taskControl.VehicleCollection.Rows[0]["CompPremium"].ToString()) +
                                double.Parse(taskControl.VehicleBreakDownCollection.Rows[i]["CompPremium"].ToString());
                            taskControl.VehicleCollection.Rows[0]["CollPremium"] =
                                double.Parse(taskControl.VehicleCollection.Rows[0]["CollPremium"].ToString()) +
                                double.Parse(taskControl.VehicleBreakDownCollection.Rows[i]["CollPremium"].ToString());
                            taskControl.VehicleCollection.Rows[0]["BIPremium"] =
                                double.Parse(taskControl.VehicleCollection.Rows[0]["BIPremium"].ToString()) +
                                double.Parse(taskControl.VehicleBreakDownCollection.Rows[i]["BIPremium"].ToString());
                            taskControl.VehicleCollection.Rows[0]["PDPremium"] =
                                double.Parse(taskControl.VehicleCollection.Rows[0]["PDPremium"].ToString()) +
                                double.Parse(taskControl.VehicleBreakDownCollection.Rows[i]["PDPremium"].ToString());
                            taskControl.VehicleCollection.Rows[0]["MPPremium"] =
                                double.Parse(taskControl.VehicleCollection.Rows[0]["MPPremium"].ToString()) +
                                double.Parse(taskControl.VehicleBreakDownCollection.Rows[i]["MPPremium"].ToString());
                            taskControl.VehicleCollection.Rows[0]["MotoristPremium"] =
                                double.Parse(taskControl.VehicleCollection.Rows[0]["MotoristPremium"].ToString()) +
                                double.Parse(taskControl.VehicleBreakDownCollection.Rows[i]["MotoristPremium"].ToString());
                            taskControl.VehicleCollection.Rows[0]["ADDPremium"] =
                                double.Parse(taskControl.VehicleCollection.Rows[0]["ADDPremium"].ToString()) +
                                double.Parse(taskControl.VehicleBreakDownCollection.Rows[i]["ADDPremium"].ToString());
                            taskControl.VehicleCollection.Rows[0]["RentalReim"] =
                                double.Parse(taskControl.VehicleCollection.Rows[0]["RentalReim"].ToString()) +
                                double.Parse(taskControl.VehicleBreakDownCollection.Rows[i]["RentalReim"].ToString());
                        }

                        TotPrem = (double.Parse(Comp) + double.Parse(Coll) +
                            double.Parse(BI) + double.Parse(PD) +
                            double.Parse(MP) + double.Parse(Mot) +
                            double.Parse(Add) + double.Parse(RentReim) +
                            double.Parse(TaxiLoss)).ToString();
                    }

                    //Para el reporte que salga el primer inicial del vehiculo.
                    taskControl.VehicleCollection.Rows[0]["VehicleValue"] = TxtVehicleValue.Text.Replace("$", "").Replace(",", "").Trim();

                    DataView dv = taskControl.VehicleCollection.DefaultView;
                    dv.Sort = "VehicleRowNumber";
                    taskControl.VehicleCollection = dv.ToTable();
                    taskControl.VehicleCollection.AcceptChanges();

                    dt = taskControl.VehicleCollection;
                    FillGridBreakDown();
                    taskControl.CustomerCollection = "0";

                    for (int a = 0; a < GridVehicle.Columns.Count; a++)
                    {
                        GridVehicle.Columns[a].Visible = true;
                    }

                    this.GridVehicle.Visible = true;
                    this.GridBreakDown.Visible = true;
                    this.GridVehicle.DataSource = dt;
                    this.GridVehicle.DataBind();
                    this.GridVehicle.Visible = true;
                    this.GridBreakDown.Visible = true;

                    if (dt.Rows.Count >= 1)
                    {
                        txtValidator.Text = "1"; //PARA VALIDAR QUE HAY UN VEHICULO.
                    }

                    for (int a = 6; a < 40; a++)
                    {
                        GridVehicle.Columns[a].Visible = false;
                    }
                    GridVehicle.Columns[33].Visible = false;
                    GridVehicle.Columns[38].Visible = false;
                    GridVehicle.Columns[40].Visible = false;
                    GridVehicle.Columns[41].Visible = false;
                    GridVehicle.Columns[6].Visible = false;
                    GridVehicle.Columns[42].Visible = false;
                    GridVehicle.Columns[44].Visible = false;
                    GridVehicle.Columns[45].Visible = false;

                    GridVehicle.Columns[39].Visible = true;
                    GridVehicle.Columns[26].Visible = true;
                    GridVehicle.Columns[27].Visible = true;
                    GridVehicle.Columns[28].Visible = true;
                    GridVehicle.Columns[29].Visible = true;
                    GridVehicle.Columns[30].Visible = true;
                    GridVehicle.Columns[31].Visible = true;
                    GridVehicle.Columns[32].Visible = true;
                    GridVehicle.Columns[34].Visible = true;

                    CalculatePremium();

                    if (txtTotalPremiumVehicle.Text.ToString().Trim() == "")
                        txtTotalPremiumVehicle.Text = "0.00";

                    if (BtnAddVehicle.Text == "Save Vehicle")
                    {
                        TxtBirthDate_TextChanged(String.Empty, EventArgs.Empty);
                    }

                    this.BtnAddVehicle.Text = "Add Vehicle";
                    lblModifyVehicle.Visible = false;
                    GridVehicle.BorderColor = Color.Black;
                    GridDrivers.BorderColor = Color.Black;

                    // se puso en comentario ya que Maureen no queria que los valores se fueran a su estado "basic", se dejo la informacion que ya estaba entrada (limites, cubiertas, etc)

                    ddlVehicleYear.SelectedIndex = 0;
                    ddlVehicleMake.SelectedIndex = 0;
                    ddlVehicleModel.SelectedIndex = 0;
                    ddlBankList.SelectedIndex = 0;
                    lblBankListSelected.Text = "";
                    lblBankListSelected2.Text = lblBankListSelected.Text;
                    TxtVINNo.Text = "";
                    TxtLicensePlateNo.Text = "";
                    ddlVehicleUse.SelectedIndex = 0;
                    ddlIsland.SelectedIndex = 0;
                    TxtVehicleValue.Text = "";

                    if (TxtPassengerNo.Visible == true || LblPassengersNo.Visible == true)
                    {
                        TxtPassengerNo.Visible = false;
                        LblPassengersNo.Visible = false;

                        if (TxtPassengerNo.Text != "0")
                            TxtPassengerNo.Text = "0";

                        lblTaxiDriverloss.Visible = false;
                        radTaxiDriverloss.Visible = false;
                    }

                    if (radRentalReimCov.Visible == false)
                    {
                        radRentalReimCov.Visible = true;
                        lblRentalReim.Visible = true;
                    }

                    if (radMotorcycle.Enabled)
                    {
                        radMotorcycle.SelectedIndex = 1;
                        IsBusinessCheckedChanged();
                    }

                    TxtVehicleValue.Enabled = true;

                    TxtVehicleID.Text = "";

                    ValidateBI();
                    EnableDisableBusinessAuto();
                }
                catch (Exception ex)
                {

                }

                #endregion VehicleDetail Collection

                TimeSpan tss = DateTime.Parse(DateTime.Now.ToShortDateString()) - DateTime.Parse(this.TxtBirthDate.Text);

                // Difference in days.
                double totdayss = double.Parse(tss.Days.ToString());
                double tots = 0;

                if (totdayss < 0)
                {
                    totdayss = 0;
                }
                else
                {
                    tots = Math.Floor(totdayss / 365);
                    TxtAge.Text = tots.ToString().Trim();
                }

                CalculatePremium();
            }
            catch (Exception exp)
            {
                lblRecHeader.Text = exp.Message;
                mpeSeleccion.Show();
            }
        }

        private void FillGridBreakDown()
        {
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
            VehicleBreakDownDiv.Visible = true;

            DataTable dt = null;
            dt = taskControl.VehicleBreakDownCollection;

            if (dt.Rows.Count == 0)
            {
                AccordionBreakDown.Visible = false;
                VehicleBreakDownDiv.Visible = false;
            }
            else
            {

                //taskControl.CustomerCollection = "0";

                for (int a = 0; a < GridBreakDown.Columns.Count; a++)
                {
                    GridBreakDown.Columns[a].Visible = true;
                }

                //this.GridDrivers.CurrentPageIndex = 0;
                this.GridBreakDown.Visible = true;
                this.GridBreakDown.DataSource = dt;
                this.GridBreakDown.DataBind();
                this.GridBreakDown.Visible = true;

                //GridVehicle.Columns[33].Visible = false;
                //GridVehicle.Columns[38].Visible = false;
                //GridVehicle.Columns[40].Visible = false;
                //GridVehicle.Columns[41].Visible = false;
                //GridVehicle.Columns[6].Visible = false;
                //GridVehicle.Columns[42].Visible = false;
                //GridVehicle.Columns[44].Visible = false;

                GridVehicle.Columns[39].Visible = true;
                GridVehicle.Columns[26].Visible = true;
                GridVehicle.Columns[27].Visible = true;
                GridVehicle.Columns[28].Visible = true;
                GridVehicle.Columns[29].Visible = true;
                GridVehicle.Columns[30].Visible = true;
                GridVehicle.Columns[31].Visible = true;
                GridVehicle.Columns[32].Visible = true;
                GridVehicle.Columns[34].Visible = true;
                AccordionBreakDown.Visible = true;
                VehicleBreakDownDiv.Visible = true;
            }


        }

        protected void BtnRePrintApp_Click(object sender, EventArgs e)
        {
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            DataTable dtRePrintApplication = GetPolicyRePrintApplication(taskControl.TaskControlID);


            if (dtRePrintApplication.Rows.Count > 0)
            {
                PrintApplication(int.Parse(dtRePrintApplication.Rows[0]["Optional2"].ToString()));
            }
        }

        protected void BtnCancelVehicle_Click(object sender, EventArgs e)
        {
            this.BtnAddVehicle.Text = "Add Vehicle";
            lblModifyVehicle.Visible = false;

            ddlVehicleYear.SelectedIndex = 0;
            ddlVehicleMake.SelectedIndex = 0;
            ddlVehicleModel.SelectedIndex = 0;
            TxtVINNo.Text = "";
            TxtLicensePlateNo.Text = "";

            ddlIsland.SelectedIndex = 0;
            ddlStatus.SelectedIndex = 0;
            TxtVehicleValue.Text = "";
            ddlBankList.SelectedIndex = -1;
            ddlVehicleUse.SelectedIndex = 0;
            TxtPassengerNo.Text = "0";
            radGenTons.SelectedIndex = 1;
            radHeavyTruck.SelectedIndex = 1;
            radGenMedicalPayment.SelectedIndex = 1;
            radGenMotoristCoverage.SelectedIndex = 1;
            radRentalReimCov.SelectedIndex = 1;
            //radGenDeathCoverage.SelectedIndex = 0;
            radADD.SelectedIndex = 1;
            //TxtTrafficViolationPoints.Text = "0";
            //TxtTrafficViolationSurcharge.Text = "0";
            //TxtUnderAgeSurcharge.Text = "0";
            TxtPDLimit.Text = "$10,000";
            txtOtherSurcharge.Text = "0.0";

            LblPassengersNo.Visible = false;
            TxtPassengerNo.Visible = false;
            lblTaxiDriverloss.Visible = false;
            radTaxiDriverloss.Visible = false;
            TxtVehicleValue.Enabled = true;

            if (radRentalReimCov.Visible == false)
            {
                radRentalReimCov.Visible = true;
                lblRentalReim.Visible = true;
            }

            if (radMotorcycle.Enabled)
                radMotorcycle.SelectedIndex = 1;

            IsBusinessCheckedChanged();

            DefaultLimitValues();

            TxtVehicleID.Text = "";

            for (int i = 0; i < GridVehicle.Columns.Count; i++)
            {
                GridVehicle.Columns[i].Visible = true;
            }

            for (int i = 6; i < 40; i++)
            {
                GridVehicle.Columns[i].Visible = false;
            }


            GridVehicle.Columns[33].Visible = false;
            GridVehicle.Columns[38].Visible = false;
            GridVehicle.Columns[40].Visible = false;
            GridVehicle.Columns[41].Visible = false;
            GridVehicle.Columns[6].Visible = false;
            GridVehicle.Columns[42].Visible = false;
            GridVehicle.Columns[44].Visible = false;
            GridVehicle.Columns[45].Visible = false;

            GridVehicle.Columns[39].Visible = true;
            GridVehicle.Columns[26].Visible = true;
            GridVehicle.Columns[27].Visible = true;
            GridVehicle.Columns[28].Visible = true;
            GridVehicle.Columns[29].Visible = true;
            GridVehicle.Columns[30].Visible = true;
            GridVehicle.Columns[31].Visible = true;
            GridVehicle.Columns[32].Visible = true;
            GridVehicle.Columns[34].Visible = true;

            //GridVehicle.Columns[43].Visible = false;

            GridVehicle.BorderColor = Color.Black;

            Session["VehicleRowNumber"] = null;
        }

        protected void btnPrintAppForms_Click(object sender, EventArgs e)
        {
            try
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];


                #region Se utiliza en el Save
                //if (TxtAddress.Text.Trim() == "")
                //{
                //    lblRecHeader.Text = "Please enter Mailing Address #1.";
                //    mpeSeleccion.Show();
                //    return;
                //}

                //if (TxtCity.Text.Trim() == "")
                //{
                //    lblRecHeader.Text = "Please enter Mailing City.";
                //    mpeSeleccion.Show();
                //    return;
                //}

                //if (TxtState.Text.Trim() == "")
                //{
                //    lblRecHeader.Text = "Please enter Mailing State.";
                //    mpeSeleccion.Show();
                //    return;
                //}

                //if (TxtZIPCode.Text.Trim() == "")
                //{
                //    lblRecHeader.Text = "Please enter Mailing Zip Code.";
                //    mpeSeleccion.Show();
                //    return;
                //}

                //if (txtPhyAddress.Text.Trim() == "")
                //{
                //    lblRecHeader.Text = "Please enter Physical Address #1.";
                //    mpeSeleccion.Show();
                //    return;
                //}

                //if (txtPhyState.Text.Trim() == "")
                //{
                //    lblRecHeader.Text = "Please enter Physical State.";
                //    mpeSeleccion.Show();
                //    return;
                //}

                //if (txtPhyZipCode.Text.Trim() == "")
                //{
                //    lblRecHeader.Text = "Please enter Physical Zip Code.";
                //    mpeSeleccion.Show();
                //    return;
                //}

                #endregion Se utiliza en el Save

                if (btnSaveApp.Visible == true)
                {
                    lblRecHeader.Text = "Please save application before printing.";
                    mpeSeleccion.Show();
                    return;
                }


                PrintApplication(taskControl.TaskControlID);
            }
            catch (Exception exp)
            {
                lblRecHeader.Text = exp.Message;
                mpeSeleccion.Show();
            }
        }

        protected void btnQuote_Click(object sender, EventArgs e)
        {
            //Para evitar que de dañe el calculo al no salvar el auto.
            if (BtnAddVehicle.Text == "Save Vehicle")
            {
                lblRecHeader.Text = "Please Save Vehicle Changes!";
                mpeSeleccion.Show();
                return;
            }

            CalculatePremium();
            GetTotalPremium();
            SaveClick();

            if (lblRecHeader.Text.Trim() != "")
            {
                mpeSeleccion.Show();
                return;
            }

            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];


            UpdatePolicyMode_VI(taskControl.TaskControlID, "1");
            FillTextControl();


            BtnEdit.Focus();
            lblRecHeader.Text = "Quote saved succesfully!";
            mpeSeleccion.Show();

        }

        protected void btnCalculate_Click(object sender, EventArgs e)
        {
            CalculatePremium();
            GetTotalPremium();
            txtTotalQuote.Text = double.Parse(txtGrandTotal.Text).ToString("##,###.00");
        }

        private List<string> ImprimirAutoQuote(List<string> mergePaths, int taskControl)
        {
            try
            {
                string ProcessedPath = ConfigurationManager.AppSettings["ExportsFilesPathName"];

                // EPolicy.TaskControl.PersonalPackage taskControl = (EPolicy.TaskControl.PersonalPackage)Session["TaskControl"];

                int s = taskControl;

                //ObjectDataSource ob = new ObjectDataSource("GetReportAutoQuoteDetails.GetReportAutoQuoteDetailsTableAdapter", "GetData");

                //GetReportAutoQuoteDetailsTableAdapters.GetReportAutoQuoteDetailsTableAdapter ds1 = new GetReportAutoQuoteDetailsTableAdapters.GetReportAutoQuoteDetailsTableAdapter();

                //GetReportAutoQuotesDetails_VITableAdapters.GetReportAutoQuoteDetails_VITableAdapter ds1 = new GetReportAutoQuotesDetails_VITableAdapters.GetReportAutoQuoteDetails_VITableAdapter();
                //GetReportAutoVehiclesInfo_VITableAdapter

                GetReportAutoVehiclesInfods_VITableAdapters.GetReportAutoVehiclesInfo_VITableAdapter ds1 = new GetReportAutoVehiclesInfods_VITableAdapters.GetReportAutoVehiclesInfo_VITableAdapter();
                GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter ds2 = new GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter();
                GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter ds3 = new GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter();

                ReportDataSource rds1 = new ReportDataSource();
                ReportDataSource rds2 = new ReportDataSource();
                ReportDataSource rds3 = new ReportDataSource();


                rds1 = new ReportDataSource("GetReportAutoVehiclesInfo_VI", (DataTable)ds1.GetData(s));
                rds2 = new ReportDataSource("GetReportAutoGeneralInfo_VI", (DataTable)ds2.GetData(s));
                rds3 = new ReportDataSource("GetReportAutoDriversInfo_VI", (DataTable)ds3.GetData(s));

                ReportViewer viewer1 = new ReportViewer();
                ReportParameter[] parameters = new ReportParameter[1];
                parameters[0] = new ReportParameter("GrossTax", txtGrossTax.Text.ToString().Trim());

                viewer1.LocalReport.DataSources.Clear();
                viewer1.ProcessingMode = ProcessingMode.Local;
                viewer1.LocalReport.ReportPath = Server.MapPath("Reports/AutoQuote.rdlc");
                viewer1.LocalReport.SetParameters(parameters);
                viewer1.LocalReport.DataSources.Add(rds1);
                viewer1.LocalReport.DataSources.Add(rds2);
                viewer1.LocalReport.DataSources.Add(rds3);
                viewer1.LocalReport.Refresh();

                Warning[] warnings = null;
                string[] streamIds = null;
                string mimeType = string.Empty;
                string encoding = string.Empty;
                string extension = string.Empty;
                string filetype = string.Empty;


                string fileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-2GDN";
                string _FileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-2GDN" + ".pdf";

                if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1))
                    File.Delete(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);

                byte[] bytes1 = viewer1.LocalReport.Render("PDF", null, out mimeType, out encoding, out extension, out streamIds, out warnings);

                using (FileStream fs1 = new FileStream(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1, FileMode.Create))
                {
                    fs1.Write(bytes1, 0, bytes1.Length);
                    fs1.Close();
                }

                mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);
                return mergePaths;
            }
            catch (Exception ecp)
            {
                throw new Exception(ecp.Message.ToString());
            }
        }

        #endregion Buttons

        #region DropDownLists

        protected void ddlOccupation_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (ddlOccupation.SelectedItem.Text == "OTHER")
            {
                TxtOtherOccupation.Visible = true;
                TxtOtherOccupation.Enabled = true;
            }
            else
            {
                TxtOtherOccupation.Visible = false;
                TxtOtherOccupation.Enabled = false;
            }
        }

        protected void ddlAgent_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (ddlAgent.SelectedItem.Text.Trim().Length > 40)//"BEACON INSURANCE AGENCY LLC ".Length)
            {
                ddlAgent.Width = 500;
            }
            else if (ddlAgent.SelectedItem.Text.Trim().Length >= 30 && ddlAgent.SelectedItem.Text.Trim().Length < 50)
            {
                ddlAgent.Width = 400;
            }
            else
            {
                ddlAgent.Width = 300;
            }

            double GrandTotalValue = 0, TotalQuote = 0;

            double.TryParse(txtTotalQuote.Text,
               System.Globalization.NumberStyles.Number | System.Globalization.NumberStyles.AllowCurrencySymbol,
               System.Globalization.CultureInfo.CreateSpecificCulture("en-US"),
               out TotalQuote);

            double.TryParse(txtGrandTotal.Text,
               System.Globalization.NumberStyles.Number | System.Globalization.NumberStyles.AllowCurrencySymbol,
               System.Globalization.CultureInfo.CreateSpecificCulture("en-US"),
               out GrandTotalValue);

            if (TotalQuote > 0)
            {
                txtGrossTax.Text =
                    TotalQuote > 0 ?
                    (Math.Round(CalculateAgentCommision(ddlAgent.SelectedItem.Value, TotalQuote), 2)).ToString()
                    : "0";
            }
            else
            {
                txtGrossTax.Text =
                    GrandTotalValue > 0 ?
                    (Math.Round(CalculateAgentCommision(ddlAgent.SelectedItem.Value, GrandTotalValue), 2)).ToString()
                    : "0";
            }

            btnCalculate_Click(String.Empty, EventArgs.Empty);
        }

        protected void ddlVehicleUse_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (ddlVehicleUse.SelectedItem.Value.ToString() != "T")
            {
                LblPassengersNo.Visible = false;
                TxtPassengerNo.Text = "0";
                TxtPassengerNo.Visible = false;
                radTaxiDriverloss.Visible = false;
                lblTaxiDriverloss.Visible = false;
                radTaxiDriverloss.SelectedIndex = 1;
                lblRentalReim.Visible = true;
                radRentalReimCov.Visible = true;
            }
            else
            {
                LblPassengersNo.Visible = true;
                TxtPassengerNo.Visible = true;
                radTaxiDriverloss.Visible = true;
                lblTaxiDriverloss.Visible = true;
                lblRentalReim.Visible = false;
                radRentalReimCov.Visible = false;
                if (radRentalReimCov.SelectedItem.Value.ToString() == "Y")
                    radRentalReimCov.SelectedIndex = 1;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString() == "C")
            {
                LblPassengersNo.Visible = false;
                TxtPassengerNo.Text = "0";
                TxtPassengerNo.Visible = false;
                radTaxiDriverloss.Visible = false;
                lblTaxiDriverloss.Visible = false;
                radTaxiDriverloss.SelectedIndex = 1;
                lblRentalReim.Visible = false;
                radRentalReimCov.Visible = false;
                if (radRentalReimCov.SelectedItem.Value.ToString() == "Y")
                    radRentalReimCov.SelectedIndex = 1;
            }

            if (ddlVehicleUse.SelectedItem.Value.ToString() == "R")
            {
                txtMPLimit.Text = "$0";//"$1,000/$5,000"
                radGenMedicalPayment.SelectedIndex = 1;
                radGenMedicalPayment.Enabled = false;

                lblRentalReim.Visible = false;
                radRentalReimCov.Visible = false;
                if (radRentalReimCov.SelectedItem.Value.ToString() == "Y")
                    radRentalReimCov.SelectedIndex = 1;

                if (radMotorcycle.SelectedIndex == 0)
                {
                    TxtVehicleValue.Enabled = false;
                    TxtVehicleValue.Text = "";
                    lblRentalReim.Visible = false;
                    radRentalReimCov.Visible = false;
                    if (radRentalReimCov.SelectedItem.Value.ToString() == "Y")
                        radRentalReimCov.SelectedIndex = 1;
                }
                else
                    TxtVehicleValue.Enabled = true;

                //TxtVehicleValue.Text = "0";
                //TxtVehicleValue.Enabled = false;
            }
            else
            {
                txtMPLimit.Text = "$1,000/$5,000";
                radGenMedicalPayment.SelectedIndex = 0;
                radGenMedicalPayment.Enabled = true;

                if (radMotorcycle.SelectedIndex == 0)
                {
                    TxtVehicleValue.Enabled = false;
                    TxtVehicleValue.Text = "";
                    lblRentalReim.Visible = false;
                    radRentalReimCov.Visible = false;
                    if (radRentalReimCov.SelectedItem.Value.ToString() == "Y")
                        radRentalReimCov.SelectedIndex = 1;

                    radGenMedicalPayment.SelectedIndex = 1;
                    txtMPLimit.Text = "";
                    radGenMedicalPayment.Enabled = false;
                }
                else
                    TxtVehicleValue.Enabled = true;

                //TxtVehicleValue.Enabled = true;
                //TxtVehicleValue.Enabled = true;
            }

            ValidarCamposDisponiblesPhysDam();
            ValidarCamposDisponiblesLiab();
            //TxtVehicleValue.Focus();
            //ShowPremiumOnTheFly(false);
        }

        protected void ddlIsland_SelectedIndexChanged(object sender, EventArgs e)
        {
            ValidarCamposDisponiblesPhysDam();
            ValidarCamposDisponiblesLiab();
            //ddlVehicleUse.Focus();
            //ShowPremiumOnTheFly(false);
        }

        protected void ddlVehicleYear_SelectedIndexChanged(object sender, EventArgs e)
        {
            ValidarCamposDisponiblesPhysDam();
            ValidarCamposDisponiblesLiab();
            //ddlVehicleMake.Focus();
            //ShowPremiumOnTheFly(false);
            Page.MaintainScrollPositionOnPostBack = true;
        }

        protected void ddlDiscounts_SelectedIndexChanged(object sender, EventArgs e)
        {
            CalculatePremium();
            //ShowPremiumOnTheFly(false);
        }

        protected void ddlVehicleMake_SelectedIndexChanged(object sender, EventArgs e)
        {
            FillModelDDList();
            //ddlVehicleModel.Focus();
            //ShowPremiumOnTheFly(false);
        }

        protected void ddlGender_SelectedIndexChanged(object sender, EventArgs e)
        {
            //GetSurchargeAge("Gender");
            CalculatePremium();
        }

        protected void ddlMaritalStatus_SelectedIndexChanged(object sender, EventArgs e)
        {
            //GetSurchargeAge("MaritalStatus");
            CalculatePremium();
        }

        protected void ddlMaritalStatus2_SelectedIndexChanged(object sender, EventArgs e)
        {
            ddlMaritalStatus.SelectedIndex = ddlMaritalStatus2.SelectedIndex;
        }

        #endregion DropDownLists

        #region TextBoxes

        protected void TxtBirthDate_TextChanged(object sender, EventArgs e)
        {
            try
            {
                if (TxtAge.Text.Trim() == "16" || TxtAge.Text.Trim() == "17")
                {
                    lblPrimGrade.Visible = true;
                    txtPrimGrade.Visible = true;
                    txtPrimGrade.Enabled = true;
                    lblRentalReim.Visible = true;
                    radRentalReimCov.Visible = true;
                    radRentalReimCov.Enabled = false;
                    radRentalReimCov.SelectedIndex = 1;

                    Session["MINOR"] = TxtAge.Text.Trim();
                    //txtPrimGrade.Text = "";
                }
                else if (TxtAge.Text.Trim() == "19" || TxtAge.Text.Trim() == "20" || TxtAge.Text.Trim() == "21" || TxtAge.Text.Trim() == "22" || TxtAge.Text.Trim() == "23" || TxtAge.Text.Trim() == "24" || TxtAge.Text.Trim() == "25" || TxtAge.Text.Trim() == "26")
                {
                    lblPrimGrade.Visible = false;
                    txtPrimGrade.Visible = false;
                    txtPrimGrade.Enabled = false;
                    txtPrimGrade.Text = "";

                    radRentalReimCov.Visible = true;
                    radRentalReimCov.Enabled = false;
                    radRentalReimCov.SelectedIndex = 1;

                    Session["MINOR"] = TxtAge.Text.Trim();
                }
                else
                {
                    lblPrimGrade.Visible = false;
                    txtPrimGrade.Visible = false;
                    txtPrimGrade.Enabled = false;
                    txtPrimGrade.Text = "";
                    if (radMotorcycle.SelectedIndex == 0)
                    {
                        lblRentalReim.Visible = false;
                        radRentalReimCov.Visible = false;
                        radRentalReimCov.SelectedIndex = 1;
                    }
                    else
                    {
                        lblRentalReim.Visible = true;
                        radRentalReimCov.Visible = true;
                        if (Session["MINOR"] != null)
                        {
                            if (Session["MINOR"].ToString() != "")
                            {
                                radRentalReimCov.Enabled = true;
                                Session.Remove("MINOR");// = null;
                            }
                        }
                        //radRentalReimCov.Enabled = true;
                        radRentalReimCov.SelectedIndex = 1;// radRentalReimCov.SelectedIndex = 0; Quitar el Default de RentalReim -Sus.
                    }
                }

                if (TxtBirthDate.Text != "")
                {
                    TimeSpan ts = DateTime.Parse(DateTime.Now.ToShortDateString()) - DateTime.Parse(this.TxtBirthDate.Text);

                    // Difference in days.
                    double totdays = double.Parse(ts.Days.ToString());
                    double tot = 0;

                    if (totdays < 0)
                    {
                        totdays = 0;
                    }
                    else
                    {
                        tot = Math.Floor(totdays / 365);
                        TxtAge.Text = tot.ToString().Trim();
                    }

                    //txtEmailAddress.Focus();
                    ValidarCamposDisponiblesPhysDam();
                    ValidarCamposDisponiblesLiab();
                    CalculatePremium();

                }

            }
            catch (Exception ecp)
            {
                lblRecHeader.Text = "The date of birth is not correct.";
                mpeSeleccion.Show();
            }

        }

        protected void TxtDriverBirthDate_TextChanged(object sender, EventArgs e)
        {
            try
            {
                if (TxtDriverBirthDate.Text != "")
                {
                    TimeSpan ts = DateTime.Parse(DateTime.Now.ToShortDateString()) - DateTime.Parse(this.TxtDriverBirthDate.Text);

                    // Difference in days.
                    double totdays = int.Parse(ts.Days.ToString());
                    double tot = 0;

                    if (totdays < 0)
                    {
                        totdays = 0;
                    }
                    else
                    {
                        tot = Math.Floor(totdays / 365);
                        TxtDriverAge.Text = tot.ToString().Trim();
                    }
                    if (TxtDriverAge.Text == "16" || TxtDriverAge.Text == "17")
                    {
                        lblDriverGrade.Visible = true;
                        TxtDriverGrade.Visible = true;
                        TxtDriverGrade.Text = "0";
                    }
                    else if (TxtDriverGrade.Text != "16" || TxtDriverGrade.Text != "17")
                    {
                        lblDriverGrade.Visible = false;
                        TxtDriverGrade.Visible = false;
                    }

                    //GetSurchargeAge("BirthDate");
                    CalculatePremium();
                    //TxtDriverAge.Focus();
                }
            }
            catch (Exception ecp)
            {
                lblRecHeader.Text = "Could not calculate Driver's Age.";
                mpeSeleccion.Show();
            }
        }

        protected void TxtVehicleValue_TextChanged(object sender, EventArgs e)
        {
            ValidarCamposDisponiblesPhysDam();
            ValidarCamposDisponiblesLiab();
            TxtVehicleValue.Text = String.Format("{0:c0}", int.Parse(TxtVehicleValue.Text.ToString().Trim(), System.Globalization.NumberStyles.Currency));
            //TxtVINNo.Focus();
            //ShowPremiumOnTheFly(false);
        }

        protected void TxtAge_TextChanged(object sender, EventArgs e)
        {
            ValidarCamposDisponiblesPhysDam();
            ValidarCamposDisponiblesLiab();
            //ShowPremiumOnTheFly(false);
        }

        protected void TxtPassengerNo_TextChanged(object sender, EventArgs e)
        {
            ValidarCamposDisponiblesPhysDam();
            ValidarCamposDisponiblesLiab();
            //ShowPremiumOnTheFly(false);
        }

        protected void txtViolationPoints_TextChanged(object sender, EventArgs e)
        {
            GetTrafficViolationSurcharge();
            CalculatePremium();
        }

        protected void TxtEffBinderDate_TextChanged(object sender, EventArgs e)
        {
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            if (taskControl.RenewalNo == "")
            {
                if (DateTime.Parse(TxtEffBinderDate.Text) < DateTime.Parse(DateTime.Now.ToShortDateString()))
                {
                    //TxtEffBinderDate.Text = DateTime.Now.ToShortDateString();
                    lblRecHeader.Text = "Policy Effective Date should be Current Date.";
                    mpeSeleccion.Show();
                    return;
                }
            }
            TxtExpBinderDate.Text = DateTime.Parse(TxtEffBinderDate.Text).AddYears(int.Parse(taskControl.Terms) / 12).ToShortDateString();
        }

        protected void txtDiscountPct_TextChanged(object sender, EventArgs e)
        {
            CalculatePremium();
        }

        #endregion TextBoxes

        #region DataTables

        private DataTable AddDrivers()
        {
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            DbRequestXmlCookRequestItem[] cookItems = new DbRequestXmlCookRequestItem[5];
            DbRequestXmlCooker.AttachCookItem("DriverName", SqlDbType.Char, 100, TxtDriverName.Text.Trim(), ref cookItems);
            DbRequestXmlCooker.AttachCookItem("DriverGender", SqlDbType.Int, 0, ddlDriverGender.SelectedValue.Trim(), ref cookItems);
            DbRequestXmlCooker.AttachCookItem("DriverBirthOfDate", SqlDbType.SmallDateTime, 10, TxtDriverBirthDate.Text.Trim(), ref cookItems);
            DbRequestXmlCooker.AttachCookItem("DriverAge", SqlDbType.Int, 2, TxtDriverAge.Text.Trim(), ref cookItems);
            DbRequestXmlCooker.AttachCookItem("DriverMaritalStatus", SqlDbType.Int, 0, ddlDriverMaritalStatus.SelectedValue.Trim(), ref cookItems);

            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }

            Baldrich.DBRequest.DBRequest exec = new Baldrich.DBRequest.DBRequest();
            DataTable dtDrivers = exec.GetQuery("GetDrivers", xmlDoc);

            return dtDrivers;
        }

        private static DataTable UpdateComp_Coll_VI(int TaskControl, bool IsQuote, string CompDedu, string CollDedu, int VehicleDetailID)
        {

            DataTable dt = new DataTable();

            DBRequest Executor = new DBRequest();

            try
            {
                DbRequestXmlCookRequestItem[] cookItems = new DbRequestXmlCookRequestItem[5];

                DbRequestXmlCooker.AttachCookItem("TaskControlID",
                    SqlDbType.Int, 0, TaskControl.ToString(),
                    ref cookItems);

                DbRequestXmlCooker.AttachCookItem("IsQuote",
                    SqlDbType.Bit, 0, IsQuote.ToString(),
                    ref cookItems);

                DbRequestXmlCooker.AttachCookItem("CompDedu",
                    SqlDbType.VarChar, 50, CompDedu.ToString(),
                    ref cookItems);

                DbRequestXmlCooker.AttachCookItem("CollDedu",
                    SqlDbType.VarChar, 50, CollDedu.ToString(),
                    ref cookItems);

                DbRequestXmlCooker.AttachCookItem("VehicleDetailID",
                   SqlDbType.Int, 0, VehicleDetailID.ToString(),
                   ref cookItems);

                XmlDocument xmlDoc;

                try
                {
                    xmlDoc = DbRequestXmlCooker.Cook(cookItems);
                }
                catch (Exception ex)
                {
                    throw new Exception("Could not cook items.", ex);
                }

                dt = Executor.GetQuery("UpdateComp_Coll_VI", xmlDoc);
                return dt;

            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }

            return dt;

        }

        private static DataTable UpdateNetPremiumQuote_VI(int TaskControl, bool IsMotorCycle, string RenewalNo, string CustomerCollection)
        {

            DataTable dt = new DataTable();

            DBRequest Executor = new DBRequest();

            try
            {
                DbRequestXmlCookRequestItem[] cookItems = new DbRequestXmlCookRequestItem[4];

                DbRequestXmlCooker.AttachCookItem("TaskControlID",
                    SqlDbType.Int, 0, TaskControl.ToString(),
                    ref cookItems);

                DbRequestXmlCooker.AttachCookItem("IsMotorcycleScooter",
                    SqlDbType.Bit, 0, IsMotorCycle.ToString(),
                    ref cookItems);

                DbRequestXmlCooker.AttachCookItem("RenewalNo",
                    SqlDbType.VarChar, 50, RenewalNo.ToString(),
                    ref cookItems);

                DbRequestXmlCooker.AttachCookItem("CustomerCollection",
                    SqlDbType.VarChar, 50, CustomerCollection.ToString(),
                    ref cookItems);

                XmlDocument xmlDoc;

                try
                {
                    xmlDoc = DbRequestXmlCooker.Cook(cookItems);
                }
                catch (Exception ex)
                {
                    throw new Exception("Could not cook items.", ex);
                }

                dt = Executor.GetQuery("UpdateNetPremiumQuote_VI", xmlDoc);
                return dt;

            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }

            return dt;

        }

        private static DataTable UpdateNetPremiumPoliza_VI(int TaskControl, bool IsMotorCycle, string RenewalNo, string CustomerCollection)
        {

            DataTable dt = new DataTable();

            DBRequest Executor = new DBRequest();

            try
            {
                DbRequestXmlCookRequestItem[] cookItems = new DbRequestXmlCookRequestItem[4];

                DbRequestXmlCooker.AttachCookItem("TaskControlID",
                    SqlDbType.Int, 0, TaskControl.ToString(),
                    ref cookItems);

                DbRequestXmlCooker.AttachCookItem("IsMotorcycleScooter",
                    SqlDbType.Bit, 0, IsMotorCycle.ToString(),
                    ref cookItems);

                DbRequestXmlCooker.AttachCookItem("RenewalNo",
                    SqlDbType.VarChar, 50, RenewalNo.ToString(),
                    ref cookItems);

                DbRequestXmlCooker.AttachCookItem("CustomerCollection",
                    SqlDbType.VarChar, 50, CustomerCollection.ToString(),
                    ref cookItems);

                XmlDocument xmlDoc;

                try
                {
                    xmlDoc = DbRequestXmlCooker.Cook(cookItems);
                }
                catch (Exception ex)
                {
                    throw new Exception("Could not cook items.", ex);
                }

                dt = Executor.GetQuery("UpdateNetPremiumPoliza_VI", xmlDoc);
                return dt;

            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }

            return dt;

        }

        private static DataTable GetDiscounts(string PolicyClassID, bool Renewal, bool IsLiabilityOnly, DateTime EffectiveDate)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[4];

            DbRequestXmlCooker.AttachCookItem("PolicyClassID",
                SqlDbType.VarChar, 10, PolicyClassID.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("Renewal",
               SqlDbType.Bit, 0, Renewal.ToString(),
               ref cookItems);

            DbRequestXmlCooker.AttachCookItem("IsLiabilityOnly",
               SqlDbType.Bit, 0, IsLiabilityOnly.ToString(),
               ref cookItems);

            DbRequestXmlCooker.AttachCookItem("EffectiveDate",
              SqlDbType.DateTime, 0, EffectiveDate.ToString(),
              ref cookItems);

            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                dt = exec.GetQuery("GetVI_Discounts", xmlDoc);
                return dt;
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve the liability rates.", ex);
            }
        }

        private static DataTable GetLiabilityRates(string UseCode, string Territory, string GrossWtOver2, string MotorCycle, int PassengerID, string IsHeavyTruck)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[6];

            DbRequestXmlCooker.AttachCookItem("UseCode",
                SqlDbType.VarChar, 10, UseCode.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("Territory",
               SqlDbType.VarChar, 1, Territory.ToString(),
               ref cookItems);

            DbRequestXmlCooker.AttachCookItem("GrossWtOver2",
                SqlDbType.VarChar, 1, GrossWtOver2.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("MotorCycle",
                SqlDbType.VarChar, 1, MotorCycle.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("Passenger",
                SqlDbType.Int, 0, PassengerID.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("IsHeavyTruck",
                SqlDbType.VarChar, 1, IsHeavyTruck.ToString(),
                ref cookItems);

            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                dt = exec.GetQuery("GetVI_LiabilityRates", xmlDoc);
                return dt;
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve the liability rates.", ex);
            }
        }

        private static DataTable GetPhysicalDamageRates(string UseCode, string Territory, int ACV, string HighPerf, int VehicleYear, int DriverAge, int Passengers)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[7];

            DbRequestXmlCooker.AttachCookItem("UseCode",
                SqlDbType.VarChar, 10, UseCode.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("Territory",
               SqlDbType.VarChar, 1, Territory.ToString(),
               ref cookItems);

            DbRequestXmlCooker.AttachCookItem("ACV",
                SqlDbType.Int, 0, ACV.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("HighPerf",
                SqlDbType.VarChar, 1, HighPerf.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("VehicleYear",
                SqlDbType.Int, 0, VehicleYear.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("DriverAge",
                SqlDbType.Int, 0, DriverAge.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("Passengers",
                SqlDbType.Int, 0, Passengers.ToString(),
                ref cookItems);

            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                dt = exec.GetQuery("GetVI_PhysicalDamageRates", xmlDoc);
                return dt;
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve the liability rates.", ex);
            }
        }

        private static DataTable GetAgentByAgentID(string AgentID)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[1];

            DbRequestXmlCooker.AttachCookItem("AgentID",
                SqlDbType.VarChar, 10, AgentID.ToString(),
                ref cookItems);


            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                dt = exec.GetQuery("GetAgentByAgentID", xmlDoc);
                return dt;
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve the liability rates.", ex);
            }
        }

        private static DataTable GetAgentByUserID(string UserID)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[1];

            DbRequestXmlCooker.AttachCookItem("UserID",
                SqlDbType.VarChar, 10, UserID.ToString(),
                ref cookItems);


            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                dt = exec.GetQuery("GetAgentByUserID_VI", xmlDoc);
                return dt;
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve the liability rates.", ex);
            }
        }

        private static DataTable GetAgentByCarsID(int CarsID)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[1];

            DbRequestXmlCooker.AttachCookItem("CarsID",
                SqlDbType.VarChar, 10, CarsID.ToString(),
                ref cookItems);


            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                dt = exec.GetQuery("GetAgentByCarsID", xmlDoc);
                return dt;
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve the liability rates.", ex);
            }
        }


        private static DataTable GetImageLogoByAgentID(string AgentID)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[1];

            DbRequestXmlCooker.AttachCookItem("AgentID",
                SqlDbType.VarChar, 10, AgentID.ToString(),
                ref cookItems);


            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                dt = exec.GetQuery("GetAgencyLogoByAgentID", xmlDoc);
                return dt;
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve the liability rates.", ex);
            }
        }

        private static DataTable GetCommissionAgentRateByAgentID(string TaskControlID, string PolicyClassID)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[2];

            DbRequestXmlCooker.AttachCookItem("TaskControlID",
                SqlDbType.VarChar, 10, TaskControlID.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("PolicyClassID",
                SqlDbType.VarChar, 10, PolicyClassID.ToString(),
                ref cookItems);


            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                dt = exec.GetQuery("GetCommissionAgentRateByAgentID", xmlDoc);
                return dt;
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve the liability rates.", ex);
            }
        }

        private static DataTable GetTrafficViolationFactor(int Points)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[1];

            DbRequestXmlCooker.AttachCookItem("Points",
                SqlDbType.Int, 0, Points.ToString(),
                ref cookItems);

            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                dt = exec.GetQuery("GetVI_TrafficViolationSurchageFactor", xmlDoc);
                return dt;
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve TrafficViolationSurchageFactor.", ex);
            }
        }

        private static DataTable GetSurchargeAgeFactor(int Age)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[1];

            DbRequestXmlCooker.AttachCookItem("Age",
                SqlDbType.Int, 0, Age.ToString(),
                ref cookItems);

            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                dt = exec.GetQuery("GetVI_SurchargeAge", xmlDoc);
                return dt;
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve SurchargeAge.", ex);
            }
        }

        private static DataTable GetSurchargeUnderAgeFactor(int Age, float GradePointAvg, string Gender)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[3];

            DbRequestXmlCooker.AttachCookItem("Age",
                SqlDbType.Int, 0, Age.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("GradePointAvg",
                SqlDbType.Float, 0, GradePointAvg.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("Gender",
                SqlDbType.VarChar, 1, Gender.ToString(),
                ref cookItems);


            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                dt = exec.GetQuery("GetVI_SurchargeUnderAge", xmlDoc);
                return dt;
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve SurchargeAge.", ex);
            }
        }

        private static DataTable GetPolicyRePrintApplication(int TaskControlID)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[1];

            DbRequestXmlCooker.AttachCookItem("TaskControlID",
                SqlDbType.Int, 0, TaskControlID.ToString(),
                ref cookItems);


            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                dt = exec.GetQuery("GetPolicyRePrintApplication", xmlDoc);
                return dt;
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve the liability rates.", ex);
            }
        }

        private static DataTable GetUsernameByUserID(int UserID)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[1];

            DbRequestXmlCooker.AttachCookItem("UserID",
                SqlDbType.Int, 0, UserID.ToString(),
                ref cookItems);


            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                dt = exec.GetQuery("GetUserNameByID", xmlDoc);
                return dt;
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve the liability rates.", ex);
            }
        }

        private static DataTable GetCoverageDiscount(int TaskControlID, string Coverage, string Island, bool IsNewCustomer)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[4];

            DbRequestXmlCooker.AttachCookItem("TaskControlID",
                SqlDbType.Int, 0, TaskControlID.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("Coverage",
                SqlDbType.VarChar, 50, Coverage.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("Island",
                SqlDbType.VarChar, 50, Island.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("IsNewCustomer",
                SqlDbType.Bit, 0, IsNewCustomer.ToString(),
                ref cookItems);

            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                dt = exec.GetQuery("GetCoverageDiscount", xmlDoc);
                return dt;
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve the liability rates.", ex);
            }
        }

        private static DataTable GetPolicyMode_VI(int TaskControlID)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[1];

            DbRequestXmlCooker.AttachCookItem("TaskControlID",
                SqlDbType.Int, 0, TaskControlID.ToString(),
                ref cookItems);


            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                dt = exec.GetQuery("GetPolicyMode_VI", xmlDoc);
                return dt;
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve the liability rates.", ex);
            }
        }

        private static DataTable GetVerifyPolicyExist_VI(int TaskControlID)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[1];

            DbRequestXmlCooker.AttachCookItem("TaskControlID",
                SqlDbType.Int, 0, TaskControlID.ToString(),
                ref cookItems);


            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                dt = exec.GetQuery("GetVerifyPolicyExist_VI", xmlDoc);
                return dt;
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve data from database.", ex);
            }
        }

        private static DataTable AddVehicleMakeFromPPS(String VehicleMakeDesc, bool IsMotorcycle)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[2];

            DbRequestXmlCooker.AttachCookItem("vehicleMakeDesc",
                SqlDbType.VarChar, 50, VehicleMakeDesc.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("IsMotorcycle",
                SqlDbType.Bit, 0, IsMotorcycle.ToString(),
                ref cookItems);


            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                dt = exec.GetQuery("AddVehicleMakeFromPPS", xmlDoc);
                return dt;
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve data from database.", ex);
            }
        }

        private void AddVehicleModelFromPPS(String VehicleMakeID, String VehicleModelDesc)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[2];

            DbRequestXmlCooker.AttachCookItem("VehicleMakeID",
                SqlDbType.Int, 0, VehicleMakeID.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("VehicleModelDesc",
                SqlDbType.VarChar, 50, VehicleModelDesc.ToString(),
                ref cookItems);

            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }

            Baldrich.DBRequest.DBRequest exec = new Baldrich.DBRequest.DBRequest();
            exec.Insert("AddVehicleModelFromPPS", xmlDoc);
        }

        private static DataTable GetVehicleMakeFromPPS(String VehicleMakeDesc, bool isMotorcycle)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[2];

            DbRequestXmlCooker.AttachCookItem("VehicleMakedesc",
                SqlDbType.VarChar, 50, VehicleMakeDesc.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("isMotorcycle",
                SqlDbType.Bit, 0, isMotorcycle.ToString(),
                ref cookItems);


            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                dt = exec.GetQuery("GetVehicleMakeFromPPS", xmlDoc);
                return dt;
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve data from database.", ex);
            }
        }

        private static DataTable GetVehicleModelByVehicleMakeIDFromPPS(int VehicleMakeID, string VehicleModelDesc)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[2];

            DbRequestXmlCooker.AttachCookItem("VehicleMakeID",
                SqlDbType.Int, 0, VehicleMakeID.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("VehicleModelDesc",
                SqlDbType.VarChar, 50, VehicleModelDesc.ToString(),
                ref cookItems);


            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                dt = exec.GetQuery("GetVehicleModelByVehicleMakeIDFromPPS", xmlDoc);
                return dt;
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve data from database.", ex);
            }
        }

        private static DataTable GetNetTotalPremiumByTaskControlID(int TaskControlID)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[1];

            DbRequestXmlCooker.AttachCookItem("TaskControlID",
                SqlDbType.Int, 0, TaskControlID.ToString(),
                ref cookItems);


            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                dt = exec.GetQuery("GetNetTotalPremiumByTaskControlID", xmlDoc);
                return dt;
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve the liability rates.", ex);
            }
        }

        private static DataTable GetCoverageNetTotalPremiumByTaskControlID(int TaskControlID)
        {
            DbRequestXmlCookRequestItem[] cookItems =
                new DbRequestXmlCookRequestItem[1];

            DbRequestXmlCooker.AttachCookItem("TaskControlID",
                SqlDbType.Int, 0, TaskControlID.ToString(),
                ref cookItems);


            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }
            DataTable dt = null;
            try
            {
                dt = exec.GetQuery("GetCoverageNetTotalPremiumByTaskControlID", xmlDoc);
                return dt;
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve the liability rates.", ex);
            }
        }

        #endregion DataTables

        #region Vehicles


        //No se utiliza
        protected void ShowPremiumOnTheFly(bool isFromLoad)
        {
            //para evitar que calcule incorectamente la prima cuando esta en modo -MODIFY MODE: ON-
            if (lblModifyVehicle.Visible)
            {
                return;
            }
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            string BI = "0.00";
            string PD = "0.00";
            string MP = "0.00";
            string Coll = "0.00";
            string Comp = "0.00";
            string Mot = "0.00";
            string Add = "0.00";
            string TotPrem = "0.00";
            string RentReim = "0.00";
            string TaxiLoss = "0.00";
            double TPremium = 0.0;


            SetCompCollDeductible();

            CalculateRates(ref BI, ref PD, ref MP, ref Coll, ref Comp, ref Mot, ref Add, ref RentReim, ref TaxiLoss, false);

            TotPrem = (double.Parse(Comp) + double.Parse(Coll) + double.Parse(BI) + double.Parse(PD) + double.Parse(MP) + double.Parse(Mot) + double.Parse(Add) + double.Parse(RentReim)).ToString();

            //for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
            //{
            //    taskControl.VehicleCollection.Rows[i]["ViolationSurcharge"] = "0.0";
            //    taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"] = "0.0";
            //    taskControl.VehicleCollection.Rows[i]["OtherSurcharge"] = "0.0";
            //}
            //taskControl.VehicleCollection.AcceptChanges();

            if (isFromLoad)
            {
                CalculateCharges(false, TotPrem);
            }
            else
            {
                CalculateCharges(true, TotPrem);
            }

            for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
            {
                TPremium += double.Parse(taskControl.VehicleCollection.Rows[i]["TotalPremium"].ToString());
            }


            txtTotalQuote.Text = (double.Parse(Math.Round(double.Parse(TotPrem), 0).ToString()) + TPremium).ToString();

            //if (lblModifyVehicle.Visible)
            //{
            //    txtTotalQuote.Text = (double.Parse(Math.Round(double.Parse(TotPrem), 0).ToString())).ToString();
            //}
            //else
            //{
            //    txtTotalQuote.Text = (double.Parse(Math.Round(double.Parse(TotPrem), 0).ToString()) + TPremium).ToString();
            //}

            double TotCoverage = double.Parse(Mot) + double.Parse(Add) + double.Parse(RentReim);

            double GrandTotal = double.Parse(txtTotalQuote.Text);

            if (lblModifyVehicle.Visible == false && TotCoverage == 0)
            {
                for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                {

                    TotCoverage = double.Parse(taskControl.VehicleCollection.Rows[i]["MotoristPremium"].ToString()) +
                                    double.Parse(taskControl.VehicleCollection.Rows[i]["ADDPremium"].ToString()) +
                                    double.Parse(taskControl.VehicleCollection.Rows[i]["RentalReim"].ToString()) +
                                    double.Parse(taskControl.VehicleCollection.Rows[i]["TaxiLossAmount"].ToString());
                }
            }

            if (ddlDiscounts.SelectedItem.Text.ToString() != "N/A")
            {
                //txtTotalDiscount.Text = Math.Round((GrandTotal - TotCoverage) * (double.Parse(ddlDiscounts.SelectedItem.Text.ToString().Replace("%", "")) / 100), 0).ToString();
            }
            else
            {
                txtTotalDiscount.Text = "0.00";
            }

            txtTotalQuote.Text = (GrandTotal - double.Parse(txtTotalDiscount.Text.ToString())).ToString("##,###.00");


        }

        private void EnableDisableBusinessAuto()
        {
            if (GridVehicle.Rows.Count > 0)
            {
                chkIsBusinessAutoQuote.Enabled = false;
            }
            else
            {
                chkIsBusinessAutoQuote.Enabled = true;
            }
        }

        protected void GridVehicle_RowCommand(object sender, GridViewCommandEventArgs e)
        {
            try
            {
                switch (e.CommandName)
                {
                    case "Select": //Edit
                        if (BtnRePrintApp.Visible == false)
                        {
                            //case "Select": //Edit
                            this.BtnAddVehicle.Text = "Save Vehicle";
                            lblModifyVehicle.Visible = true;
                            GridVehicle.BorderColor = Color.Red;

                            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                            if (taskControl.VehicleCollection.Rows[0]["IsMotorcycleScooter"].ToString() == "True")
                                radMotorcycle.SelectedIndex = 0;
                            else
                                radMotorcycle.SelectedIndex = 1;

                            if (chkIsBusinessAutoQuote.Checked)
                                radMotorcycle.Enabled = true;
                            else
                                radMotorcycle.Enabled = false;


                            for (int i = 0; i < GridVehicle.Columns.Count; i++)
                            {
                                GridVehicle.Columns[i].Visible = true;
                            }

                            int index = Int32.Parse(e.CommandArgument.ToString());
                            GridViewRow row = GridVehicle.Rows[index];

                            //cell 6 is delete button

                            IsBusinessCheckedChanged();

                            ddlVehicleYear.SelectedIndex = ddlVehicleYear.Items.IndexOf(ddlVehicleYear.Items.FindByText(row.Cells[1].Text.Trim()));
                            ddlVehicleMake.SelectedIndex = ddlVehicleMake.Items.IndexOf(ddlVehicleMake.Items.FindByText(row.Cells[2].Text.Trim()));
                            FillModelDDList();
                            if (ddlVehicleModel.Items.IndexOf(ddlVehicleModel.Items.FindByText(row.Cells[3].Text.Trim())) == -1)
                            {
                                ddlVehicleModel.SelectedIndex = 1;
                            }
                            else
                                ddlVehicleModel.SelectedIndex = ddlVehicleModel.Items.IndexOf(ddlVehicleModel.Items.FindByText(row.Cells[3].Text.Trim()));
                            ddlBankList.SelectedIndex = ddlBankList.Items.IndexOf(ddlBankList.Items.FindByText(row.Cells[40].Text.Trim()));
                            TxtVINNo.Text = row.Cells[4].Text.Trim().Replace("&nbsp;", "");
                            TxtLicensePlateNo.Text = row.Cells[5].Text.Trim().Replace("&nbsp;", "");

                            TxtVehicleID.Text = row.Cells[6].Text;

                            ddlIsland.SelectedIndex = ddlIsland.Items.IndexOf(ddlIsland.Items.FindByText(row.Cells[8].Text.Trim()));

                            ddlStatus.SelectedIndex = ddlStatus.Items.IndexOf(ddlStatus.Items.FindByText(row.Cells[9].Text.Trim()));
                            string VehicleValue = "";
                            for (int i = 0; i < taskControl.VehicleBreakDownCollection.Rows.Count; i++)
                            {
                                VehicleValue = taskControl.VehicleBreakDownCollection.Rows[0]["VehicleValue"].ToString();
                            }
                            TxtVehicleValue.Text = VehicleValue == "" ? row.Cells[10].Text : VehicleValue;
                            txtOtherSurcharge.Text = row.Cells[38].Text;

                            ddlVehicleUse.SelectedIndex = ddlVehicleUse.Items.IndexOf(ddlVehicleUse.Items.FindByText(row.Cells[11].Text.Trim()));

                            MotorCycleScooterSelectedIndexChanged();
                            ddlVehicleUse_SelectedIndexChanged("", e);

                            TxtPassengerNo.Text = row.Cells[12].Text.Trim();

                            Session["VehicleRowNumber"] = row.Cells[44].Text;

                            if (ddlVehicleUse.SelectedItem.Value.ToString() != "T")
                            {
                                LblPassengersNo.Visible = false;
                                TxtPassengerNo.Text = "0";
                                TxtPassengerNo.Visible = false;
                            }
                            else
                            {
                                LblPassengersNo.Visible = true;
                                TxtPassengerNo.Visible = true;
                                lblTaxiDriverloss.Visible = true;
                                radTaxiDriverloss.Visible = true;

                                if (radRentalReimCov.Visible == true)
                                {
                                    radRentalReimCov.Visible = false;
                                    lblRentalReim.Visible = false;
                                }
                            }
                            if (ddlVehicleUse.SelectedItem.Value.ToString() == "R" && taskControl.VehicleCollection.Rows[0]["IsMotorcycleScooter"].ToString() == "True")
                            {
                                TxtVehicleValue.Enabled = false;
                            }

                            if (row.Cells[13].Text.Trim() == "True")
                            {
                                radGenTons.SelectedValue = "Y";
                            }
                            else
                            {
                                radGenTons.SelectedValue = "N";
                            }

                            if (row.Cells[45].Text.Trim() == "True")
                            {
                                radHeavyTruck.SelectedValue = "Y";
                            }
                            else
                            {
                                radHeavyTruck.SelectedValue = "N";
                            }

                            if (row.Cells[14].Text.Trim() == "True")
                            {
                                radGenMedicalPayment.SelectedValue = "Y";
                            }
                            else
                            {
                                radGenMedicalPayment.SelectedValue = "N";
                            }

                            if (row.Cells[15].Text.Trim() == "True")
                            {
                                radGenMotoristCoverage.SelectedValue = "Y";
                            }
                            else
                            {
                                radGenMotoristCoverage.SelectedValue = "N";
                            }

                            if (row.Cells[16].Text.Trim() == "True")
                            {
                                radADD.SelectedValue = "Y";
                            }
                            else
                            {
                                radADD.SelectedValue = "N";
                            }

                            //TxtTrafficViolationPoints.Text = row.Cells[17].Text.Trim();
                            //TxtTrafficViolationSurcharge.Text = row.Cells[18].Text.Trim();
                            //TxtUnderAgeSurcharge.Text = row.Cells[19].Text.Trim();


                            if (row.Cells[33].Text.Trim() == "True")
                            {
                                radRentalReimCov.SelectedValue = "Y";
                            }
                            else
                            {
                                radRentalReimCov.SelectedValue = "N";
                            }

                            if (row.Cells[41].Text.Trim() == "True")
                            {
                                radMotorcycle.SelectedValue = "Y";
                            }
                            else
                            {
                                radMotorcycle.SelectedValue = "N";
                            }

                            if (row.Cells[42].Text == "$100.00")
                            {
                                radTaxiDriverloss.SelectedIndex = 0;
                            }
                            else
                            {
                                radTaxiDriverloss.SelectedIndex = 1;
                            }



                            ValidarCamposDisponiblesPhysDam();
                            ValidarCamposDisponiblesLiab();

                            TxtPDLimit.Text = row.Cells[20].Text.Trim();
                            //ddlDedComp.SelectedItem.Text = row.Cells[21].Text.Trim();
                            //ddlDedComp.SelectedItem.Value = row.Cells[21].Text.Trim();

                            //ddlDedColl.SelectedItem.Text = row.Cells[22].Text.Trim();
                            //ddlDedColl.SelectedItem.Value = row.Cells[22].Text.Trim();

                            if (ddlDedComp.Items.FindByValue(row.Cells[21].Text.ToString().Trim()) != null)
                            {
                                ddlDedComp.SelectedValue = row.Cells[21].Text.Trim();
                            }

                            if (ddlDedColl.Items.FindByValue(row.Cells[22].Text.ToString().Trim()) != null)
                            {
                                ddlDedColl.SelectedValue = row.Cells[22].Text.Trim();
                            }



                            if (row.Cells[21].Text.Trim() != "0")
                            {
                                if (taskControl.RenewalNo != "" && taskControl.CustomerCollection != "1")// CustomerCollection se utiliza para identificar si hubo un recalculo en prima despues de traerla de Renovacion
                                {
                                    ddlCompCollDed.Items.Add(new ListItem(row.Cells[21].Text.Trim() + "/" + row.Cells[22].Text.Trim(), row.Cells[21].Text.Trim() + "/" + row.Cells[22].Text.Trim()));
                                    ddlCompCollDed.SelectedValue = row.Cells[21].Text.Trim() + "/" + row.Cells[22].Text.Trim();
                                }
                                else
                                {
                                    ddlCompCollDed.SelectedValue = row.Cells[21].Text.Trim() + "/" + row.Cells[22].Text.Trim();
                                }
                            }

                            TxtBILimitpp.Text = row.Cells[23].Text.Trim();
                            TxtBILimitpo.Text = row.Cells[24].Text.Trim();
                            txtMPLimit.Text = row.Cells[25].Text.Trim().Replace("&nbsp;", "").Replace("&amp;", "").Replace("nbsp;", "");

                            if (taskControl.RenewalNo != "")
                            {
                                TxtBILimitpp.Items.Clear();
                                string BILimit = "";

                                BILimit = row.Cells[23].Text.Trim();
                                //if (taskControl.VehicleCollection.Rows.Count > 0)
                                //{
                                //    BILimit = taskControl.VehicleCollection.Rows[0]["BIPPLimit"] != System.DBNull.Value ? taskControl.VehicleCollection.Rows[0]["BIPPLimit"].ToString() : "";
                                //}
                                if (BILimit != "")
                                    TxtBILimitpp.Items.Add(new ListItem(BILimit, BILimit));
                            }

                            for (int i = 6; i < 40; i++)
                            {
                                GridVehicle.Columns[i].Visible = false;
                            }
                            GridVehicle.Columns[33].Visible = false;
                            GridVehicle.Columns[38].Visible = false;
                            GridVehicle.Columns[40].Visible = false;
                            GridVehicle.Columns[41].Visible = false;
                            GridVehicle.Columns[6].Visible = false;
                            GridVehicle.Columns[42].Visible = false;
                            GridVehicle.Columns[44].Visible = false;
                            GridVehicle.Columns[45].Visible = false;

                            GridVehicle.Columns[39].Visible = true;
                            GridVehicle.Columns[26].Visible = true;
                            GridVehicle.Columns[27].Visible = true;
                            GridVehicle.Columns[28].Visible = true;
                            GridVehicle.Columns[29].Visible = true;
                            GridVehicle.Columns[30].Visible = true;
                            GridVehicle.Columns[31].Visible = true;
                            GridVehicle.Columns[32].Visible = true;
                            GridVehicle.Columns[34].Visible = true;

                            GridVehicle.Columns[43].Visible = false;

                            break;
                        }
                        else
                        {
                            //case "Select": //Edit
                            this.BtnAddVehicle.Text = "Cancel View";

                            //lblModifyVehicle.Visible = true;
                            TxtVehicleValue.Enabled = false;
                            BtnAddVehicle.Enabled = true;
                            GridVehicle.BorderColor = Color.Green;

                            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                            if (taskControl.VehicleCollection.Rows[0]["IsMotorcycleScooter"].ToString() == "True")
                                radMotorcycle.SelectedIndex = 0;
                            else
                                radMotorcycle.SelectedIndex = 1;

                            if (chkIsBusinessAutoQuote.Checked)
                                radMotorcycle.Enabled = true;
                            else
                                radMotorcycle.Enabled = false;

                            for (int i = 0; i < GridVehicle.Columns.Count; i++)
                            {
                                GridVehicle.Columns[i].Visible = true;
                            }

                            int index = Int32.Parse(e.CommandArgument.ToString());
                            GridViewRow row = GridVehicle.Rows[index];

                            IsBusinessCheckedChanged();

                            //cell 6 is delete buttons

                            ddlVehicleYear.SelectedIndex = ddlVehicleYear.Items.IndexOf(ddlVehicleYear.Items.FindByText(row.Cells[1].Text.Trim()));
                            ddlVehicleMake.SelectedIndex = ddlVehicleMake.Items.IndexOf(ddlVehicleMake.Items.FindByText(row.Cells[2].Text.Trim()));
                            FillModelDDList();
                            if (ddlVehicleModel.Items.IndexOf(ddlVehicleModel.Items.FindByText(row.Cells[3].Text.Trim())) == -1)
                            {
                                ddlVehicleModel.SelectedIndex = 1;
                            }
                            else
                                ddlVehicleModel.SelectedIndex = ddlVehicleModel.Items.IndexOf(ddlVehicleModel.Items.FindByText(row.Cells[3].Text.Trim()));
                            ddlBankList.SelectedIndex = ddlBankList.Items.IndexOf(ddlBankList.Items.FindByText(row.Cells[40].Text.Trim()));
                            TxtVINNo.Text = row.Cells[4].Text.Trim().Replace("&nbsp;", "");
                            TxtLicensePlateNo.Text = row.Cells[5].Text.Trim().Replace("&nbsp;", "");



                            TxtVehicleID.Text = row.Cells[6].Text;

                            ddlIsland.SelectedIndex = ddlIsland.Items.IndexOf(ddlIsland.Items.FindByText(row.Cells[8].Text.Trim()));

                            ddlStatus.SelectedIndex = ddlStatus.Items.IndexOf(ddlStatus.Items.FindByText(row.Cells[9].Text.Trim()));

                            TxtVehicleValue.Text = row.Cells[10].Text;
                            txtOtherSurcharge.Text = row.Cells[38].Text;

                            ddlVehicleUse.SelectedIndex = ddlVehicleUse.Items.IndexOf(ddlVehicleUse.Items.FindByText(row.Cells[11].Text.Trim()));


                            TxtPassengerNo.Text = row.Cells[12].Text.Trim();

                            if (ddlVehicleUse.SelectedItem.Value.ToString() != "T")
                            {
                                LblPassengersNo.Visible = false;
                                TxtPassengerNo.Text = "0";
                                TxtPassengerNo.Visible = false;
                            }
                            else
                            {
                                LblPassengersNo.Visible = true;
                                TxtPassengerNo.Visible = true;
                            }

                            //if (ddlVehicleUse.SelectedItem.Value.ToString() == "R" && taskControl.VehicleCollection.Rows[0]["IsMotorcycleScooter"].ToString() == "True")
                            //{
                            //    TxtVehicleValue.Enabled = false;
                            //}

                            if (row.Cells[13].Text.Trim() == "True")
                            {
                                radGenTons.SelectedValue = "Y";
                            }
                            else
                            {
                                radGenTons.SelectedValue = "N";
                            }

                            if (row.Cells[45].Text.Trim() == "True")
                            {
                                radHeavyTruck.SelectedValue = "Y";
                            }
                            else
                            {
                                radHeavyTruck.SelectedValue = "N";
                            }

                            if (row.Cells[14].Text.Trim() == "True")
                            {
                                radGenMedicalPayment.SelectedValue = "Y";
                            }
                            else
                            {
                                radGenMedicalPayment.SelectedValue = "N";
                            }

                            if (row.Cells[15].Text.Trim() == "True")
                            {
                                radGenMotoristCoverage.SelectedValue = "Y";
                            }
                            else
                            {
                                radGenMotoristCoverage.SelectedValue = "N";
                            }

                            if (row.Cells[16].Text.Trim() == "True")
                            {
                                radADD.SelectedValue = "Y";
                            }
                            else
                            {
                                radADD.SelectedValue = "N";
                            }

                            //TxtTrafficViolationPoints.Text = row.Cells[17].Text.Trim();
                            //TxtTrafficViolationSurcharge.Text = row.Cells[18].Text.Trim();
                            //TxtUnderAgeSurcharge.Text = row.Cells[19].Text.Trim();

                            MotorCycleScooterSelectedIndexChanged();

                            if (row.Cells[33].Text.Trim() == "True")
                            {
                                radRentalReimCov.SelectedValue = "Y";
                            }
                            else
                            {
                                radRentalReimCov.SelectedValue = "N";
                            }

                            if (row.Cells[41].Text.Trim() == "True")
                            {
                                radMotorcycle.SelectedValue = "Y";
                            }
                            else
                            {
                                radMotorcycle.SelectedValue = "N";
                            }



                            ValidarCamposDisponiblesPhysDam();
                            ValidarCamposDisponiblesLiab();

                            TxtPDLimit.Text = row.Cells[20].Text.Trim();
                            //ddlDedComp.SelectedItem.Text = row.Cells[21].Text.Trim();
                            //ddlDedComp.SelectedItem.Value = row.Cells[21].Text.Trim();

                            //ddlDedColl.SelectedItem.Text = row.Cells[22].Text.Trim();
                            //ddlDedColl.SelectedItem.Value = row.Cells[22].Text.Trim();

                            if (ddlDedComp.Items.FindByValue(row.Cells[21].Text.ToString().Trim()) != null)
                            {
                                ddlDedComp.SelectedValue = row.Cells[21].Text.Trim();
                            }

                            if (ddlDedColl.Items.FindByValue(row.Cells[22].Text.ToString().Trim()) != null)
                            {
                                ddlDedColl.SelectedValue = row.Cells[22].Text.Trim();
                            }



                            if (row.Cells[21].Text.Trim() != "0")
                            {
                                //ddlCompCollDed.SelectedItem.Text = row.Cells[21].Text.Trim() + "/" + row.Cells[22].Text.Trim();
                                ddlCompCollDed.SelectedValue = row.Cells[21].Text.Trim() + "/" + row.Cells[22].Text.Trim();
                            }

                            TxtBILimitpp.Text = row.Cells[23].Text.Trim();
                            TxtBILimitpo.Text = row.Cells[24].Text.Trim();
                            txtMPLimit.Text = row.Cells[25].Text.Trim().Replace("&nbsp;", "").Replace("&amp;", "").Replace("nbsp;", "");

                            for (int i = 6; i < 40; i++)
                            {
                                GridVehicle.Columns[i].Visible = false;
                            }
                            GridVehicle.Columns[33].Visible = false;
                            GridVehicle.Columns[38].Visible = false;
                            GridVehicle.Columns[40].Visible = false;
                            GridVehicle.Columns[41].Visible = false;
                            GridVehicle.Columns[6].Visible = false;
                            GridVehicle.Columns[42].Visible = false;
                            GridVehicle.Columns[44].Visible = false;
                            GridVehicle.Columns[45].Visible = false;

                            GridVehicle.Columns[39].Visible = true;
                            GridVehicle.Columns[26].Visible = true;
                            GridVehicle.Columns[27].Visible = true;
                            GridVehicle.Columns[28].Visible = true;
                            GridVehicle.Columns[29].Visible = true;
                            GridVehicle.Columns[30].Visible = true;
                            GridVehicle.Columns[31].Visible = true;
                            GridVehicle.Columns[32].Visible = true;
                            GridVehicle.Columns[34].Visible = true;


                            break;
                        }
                    case "Delete":

                        if (lblModifyVehicle.Visible == true)
                        {
                            throw new Exception("Please save or cancel selected vehicle first.");
                        }
                        else
                        {
                            if (BtnRePrintApp.Visible != true)
                            {
                                //case "Delete":
                                int indexd = Int32.Parse(e.CommandArgument.ToString());
                                if (GridVehicle.SelectedIndex == -1)
                                {
                                    GridVehicle.SelectedIndex = 0;
                                }

                                DeleteVehicleDetail(indexd);
                                DeleteVehicleBreakDown(indexd);
                                txtValidator.Text = "0";

                                break;
                            }
                            else
                            {
                                if (BtnAddVehicle.Text == "Cancel View") //&& GridVehicle.BorderColor == Color.Green)
                                {

                                    BtnAddVehicle.Enabled = true;
                                    //BtnAddVehicle.Text = "Add Vehicle";
                                    //GridVehicle.BorderColor = Color.Black;
                                }
                                throw new Exception("You cannot delete a policy vehicle!");
                            }
                        }
                    default: //Page
                        break;



                }

                if (GridVehicle.Rows.Count > 0)
                {
                    chkIsBusinessAutoQuote.Enabled = false;
                }
                else
                {
                    chkIsBusinessAutoQuote.Enabled = true;
                }
            }
            catch (Exception exp)
            {
                lblRecHeader.Text = exp.ToString() + " " + exp.Message;
                mpeSeleccion.Show();
            }
        }

        private void CalculatePremiumBreakDown()
        {
            try
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                if (taskControl.RenewalNo == "" || taskControl.CustomerCollection != "1")
                {

                    if (taskControl.CustomerCollection != "1")// || taskControl.CustomerCollection == "")
                    {

                        txtBIRate.Text = "0.00";
                        txtPDRate.Text = "0.00";
                        txtMPRate.Text = "0.00";
                        txtCollision.Text = "0.00";
                        txtComp.Text = "0.00";
                        txtMotorist.Text = "0.00";
                        txtADD.Text = "0.00";
                        txtRentalReimbursment.Text = "0.00";
                        txtTaxiLossIncome.Text = "0.00";
                        txtTotalPremiumVehicle.Text = "0.00";
                        txtTotalCharges.Text = "0.00";
                        txtGrandTotal.Text = "0.00";

                        for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                        {

                            taskControl.VehicleCollection.Rows[i]["TotalPremium"] =
                                double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["MotoristPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["ADDPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["RentalReim"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["TaxiLossAmount"].ToString())
                                ;

                            //double.Parse(taskControl.VehicleCollection.Rows[i]["TotalPremium"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["ViolationSurcharge"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString());
                            taskControl.VehicleCollection.Rows[i]["ViolationSurcharge"] = "0.0";
                            taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"] = "0.0";
                            taskControl.VehicleCollection.Rows[i]["OtherSurcharge"] = "0.0";
                        }
                        taskControl.VehicleCollection.AcceptChanges();



                        for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                        {
                            txtCollision.Text = (double.Parse(txtCollision.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString())).ToString();
                            txtComp.Text = (double.Parse(txtComp.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString())).ToString();
                            txtMPRate.Text = (double.Parse(txtMPRate.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString())).ToString();
                            txtPDRate.Text = (double.Parse(txtPDRate.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString())).ToString();
                            txtBIRate.Text = (double.Parse(txtBIRate.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString())).ToString();
                            txtMotorist.Text = (double.Parse(txtMotorist.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["MotoristPremium"].ToString())).ToString();
                            txtADD.Text = (double.Parse(txtADD.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["ADDPremium"].ToString())).ToString();
                            txtRentalReimbursment.Text = (double.Parse(txtRentalReimbursment.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["RentalReim"].ToString())).ToString();
                            txtTaxiLossIncome.Text = (double.Parse(txtTaxiLossIncome.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["TaxiLossAmount"].ToString())).ToString();

                            txtTotalPremiumVehicle.Text = (double.Parse(txtTotalPremiumVehicle.Text.Replace("$", "")) + double.Parse(taskControl.VehicleCollection.Rows[i]["TotalPremium"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["ViolationSurcharge"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurcharge"].ToString())).ToString();

                        }
                        CalculateChargesBreakDown(false, "");

                        #region OLD CODE THAT DID NOT WORK
                        //SE AÑADIO PARA QUE CALCULE LOS AUTOS POR CADA CAMBIO SIN TENER QUE DARLE --SAVE QUOTE--
                        // ______________________________________________________________
                        //EPolicy.Login.Login cp = HttpContext.Current.User as EPolicy.Login.Login;

                        //int userID = int.Parse(cp.Identity.Name.Split("|".ToCharArray())[1]);


                        //if (taskControl.TaskControlID.ToString() != "0")
                        //{
                        //    //SaveClick();
                        //    //taskControl.save SaveAutosDB();
                        //    int Mode = 0;

                        //    Mode = taskControl.Mode;
                        //    //if (taskControl.Mode == 4)
                        //    //{
                        //    //    Mode = 4;
                        //    //}
                        //    taskControl.SaveDriverDetail(userID,taskControl.TaskControlID);
                        //    taskControl.SaveAutos(userID);

                        //    taskControl.Mode = Mode;


                        //}
                        //________________________________________________________________
                        //Si el calculo se llega a descuadrar trata comentando esta parte.
                        #endregion
                    }
                }

                GetTotalPremium();

            }
            catch (Exception xcp)
            {
                lblRecHeader.Text = xcp.Message.Trim();
                mpeSeleccion.Show();
            }
        } //

        private void CalculateChargesBreakDown(bool OnTheFly, string TotPrem)
        {
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            AddPrimaryDriver();


            int CantidadSurcharges = GetCantidadSurcharges();
            double ACV = 0.0;
            int VehicleID = 0;
            double UnderAgeCharge = 1.0;
            double ViolationCharge = 1.0;
            double Factor = 1.0;
            double TotalCharges = 0.0;
            double TotalCoverage = 0;

            if (TotPrem == "")
            {
                TotPrem = "0";
            }

            //no entra
            for (int x = 0; x < CantidadSurcharges; x++)
            {
                GridDrivers.Columns[10].Visible = true;
                DataView dv = taskControl.DriversCollection.DefaultView;
                dv.Sort = "SumOfSurcharges DESC";
                taskControl.DriversCollection = dv.ToTable();

                for (int i = 0; i < taskControl.DriversCollection.Rows.Count; i++)
                {
                    if (x == i)
                    {
                        UnderAgeCharge = double.Parse(taskControl.DriversCollection.Rows[i]["UnderageSurcharge"].ToString());
                        ViolationCharge = double.Parse(taskControl.DriversCollection.Rows[i]["TrafficViolationSurcharge"].ToString());

                        ACV = GetPremiumFromVehicles(x + 1, ref VehicleID);



                        //if (taskControl.VehicleCollection.Rows.Count != 0)
                        //{
                        //    if (UnderAgeCharge != 0.0 && double.Parse(taskControl.VehicleCollection.Rows[i]["MotoristPremium"].ToString()) != 0.0 || UnderAgeCharge != 0.0 && double.Parse(taskControl.VehicleCollection.Rows[i]["ADDPremium"].ToString()) != 0.0 || UnderAgeCharge != 0.0 && double.Parse(taskControl.VehicleCollection.Rows[i]["RentalReim"].ToString()) != 0.0)
                        //    {
                        //        ACV = ACV -
                        //                double.Parse(taskControl.VehicleCollection.Rows[i]["MotoristPremium"].ToString()) -
                        //                double.Parse(taskControl.VehicleCollection.Rows[i]["ADDPremium"].ToString()) -
                        //                double.Parse(taskControl.VehicleCollection.Rows[i]["RentalReim"].ToString());

                        //        //taskControl.VehicleCollection.Rows[y]["TotalPremium"] = ACV;
                        //    }

                        //    if (ViolationCharge != 0.0 && double.Parse(taskControl.VehicleCollection.Rows[i]["MotoristPremium"].ToString()) != 0.0 || ViolationCharge != 0.0 && double.Parse(taskControl.VehicleCollection.Rows[i]["ADDPremium"].ToString()) != 0.0 || ViolationCharge != 0.0 && double.Parse(taskControl.VehicleCollection.Rows[i]["RentalReim"].ToString()) != 0.0)
                        //    {
                        //        ACV = ACV -
                        //                double.Parse(taskControl.VehicleCollection.Rows[i]["MotoristPremium"].ToString()) -
                        //                double.Parse(taskControl.VehicleCollection.Rows[i]["ADDPremium"].ToString()) -
                        //                double.Parse(taskControl.VehicleCollection.Rows[i]["RentalReim"].ToString());

                        //        //taskControl.VehicleCollection.Rows[y]["TotalPremium"] = ACV;
                        //    }
                        //}

                        if (taskControl.VehicleCollection.Rows.Count == 0)
                        {

                            if (ViolationCharge > 1.0)
                            {
                                ViolationCharge = Math.Round((ViolationCharge - Factor) * ACV, 0);
                            }
                            else
                            {
                                ViolationCharge = 0.0;
                            }

                            if (UnderAgeCharge > 1.0)
                            {
                                UnderAgeCharge = Math.Round((UnderAgeCharge - Factor) * ACV, 0);
                            }
                            else
                            {
                                UnderAgeCharge = 0.0;
                            }

                            TotPrem = (double.Parse(TotPrem) + UnderAgeCharge + ViolationCharge).ToString();

                            TotalCharges = TotalCharges + ViolationCharge + UnderAgeCharge;

                            UnderAgeCharge = 0.0;
                            ViolationCharge = 0.0;

                        }
                        else
                        {

                            for (int y = 0; y < taskControl.VehicleCollection.Rows.Count; y++)
                            {
                                if (VehicleID == int.Parse(taskControl.VehicleCollection.Rows[y]["VehicleDetailID"].ToString()))
                                {
                                    if (ViolationCharge > 1.0)
                                    {
                                        ViolationCharge = Math.Round((ViolationCharge - Factor) * ACV, 0);
                                    }
                                    else
                                    {
                                        ViolationCharge = 0.0;
                                    }

                                    if (UnderAgeCharge > 1.0)
                                    {
                                        UnderAgeCharge = Math.Round((UnderAgeCharge - Factor) * ACV, 0);
                                    }
                                    else
                                    {
                                        UnderAgeCharge = 0.0;
                                    }

                                    // se comento para verificar el calculo del OnTheFly
                                    //taskControl.VehicleCollection.Rows[y]["TotalPremium"] = double.Parse(taskControl.VehicleCollection.Rows[y]["TotalPremium"].ToString()) + UnderAgeCharge + ViolationCharge;

                                    if (OnTheFly)
                                    {
                                        taskControl.VehicleCollection.Rows[y]["TotalPremium"] = double.Parse(TotPrem) + UnderAgeCharge + ViolationCharge;
                                    }
                                    else
                                    {
                                        taskControl.VehicleCollection.Rows[y]["TotalPremium"] = double.Parse(taskControl.VehicleCollection.Rows[y]["TotalPremium"].ToString());// + UnderAgeCharge + ViolationCharge;
                                    }

                                    taskControl.VehicleCollection.Rows[y]["ViolationSurcharge"] = double.Parse(taskControl.VehicleCollection.Rows[y]["ViolationSurcharge"].ToString()) + ViolationCharge;
                                    taskControl.VehicleCollection.Rows[y]["UnderAgeSurcharge"] = double.Parse(taskControl.VehicleCollection.Rows[y]["UnderAgeSurcharge"].ToString()) + UnderAgeCharge;

                                    TotalCharges = TotalCharges + ViolationCharge + UnderAgeCharge;

                                    UnderAgeCharge = 0.0;
                                    ViolationCharge = 0.0;
                                }

                            }
                            taskControl.VehicleCollection.AcceptChanges();
                        }
                    }
                }
            }

            for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
            {
                TotalCharges += double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurcharge"].ToString());
                TotalCoverage += double.Parse(taskControl.VehicleCollection.Rows[i]["MotoristPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["ADDPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["RentalReim"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["TaxiLossAmount"].ToString());
            }


            //if (TotalCharges != 0.0 && TotalCoverage != 0.0)
            //{
            //    txtTotalPremiumVehicle.Text = (double.Parse(txtTotalPremiumVehicle.Text.ToString()) + TotalCoverage).ToString();
            //}

            GridDrivers.Columns[11].Visible = false;

            for (int i = 0; i < GridVehicle.Columns.Count; i++)
            {
                GridVehicle.Columns[i].Visible = true;
            }
            DataTable dt = null;

            txtTotalCharges.Text = Math.Round(TotalCharges, 0).ToString();
            txtGrandTotal.Text = (double.Parse(txtTotalPremiumVehicle.Text.ToString()) + double.Parse(txtTotalCharges.Text.ToString())).ToString();

            double TPremium = 0.0;
            double OthSurcharge = 0.0;
            double OthSurchargePct = 0.0;
            bool IsMotorcycle = false;

            for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
            {
                TPremium = double.Parse(taskControl.VehicleCollection.Rows[i]["TotalPremium"].ToString());
                OthSurcharge = Math.Round(double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurcharge"].ToString()), 0);
                OthSurchargePct = double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurchargePct"].ToString());

                taskControl.VehicleCollection.Rows[i]["OtherSurcharge"] = Math.Round(TPremium * (OthSurchargePct / 100));
                taskControl.VehicleCollection.Rows[i]["TotalPremium"] = double.Parse(taskControl.VehicleCollection.Rows[i]["TotalPremium"].ToString());// + double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurcharge"].ToString());
                txtTotalCharges.Text = (double.Parse(txtTotalCharges.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurcharge"].ToString())).ToString();
                if (taskControl.VehicleCollection.Rows[i]["IsMotorcycleScooter"].ToString() == "True")
                {
                    IsMotorcycle = true;
                }
            }

            double GrandTotal = double.Parse(txtTotalPremiumVehicle.Text.ToString()) + double.Parse(txtTotalCharges.Text.ToString());

            string RentalVehicle = "";
            //CALCULATE DISCOUNTS
            if ((taskControl.PolicyClaim.ToString().Trim() == "No" || radGenPolicyClaimNo.Checked) && (taskControl.RenewalNo == "" || taskControl.CustomerCollection == "0"))
            {
                for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                {
                    GetSurchargeAge();

                    if (1 == 1)//(taskControl.RenewalNo == "")
                    {

                        string CurrentDiscount = "0";
                        DataTable CurrentDiscountdt = GetDiscounts("22",false,false, taskControl.EntryDate);

                        if (CurrentDiscountdt.Rows.Count > 0)
                            CurrentDiscount = CurrentDiscountdt.Rows[0]["Discount"].ToString();

                        txtDiscountPct.Text = CurrentDiscount;
                        double TOTDISCOUNT = 0;
                        double Underagesurcharge = 0;
                        int MostMinor = 0;

                        GetMostMinor(taskControl, ref MostMinor, ref Underagesurcharge);

                        if (Underagesurcharge != 0.0)//(double.Parse(taskControl.DriversCollection.Rows[i]["Underagesurcharge"].ToString()) != 0.0)
                        {
                            TOTDISCOUNT = (
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            );
                        }
                        else
                        {
                            TOTDISCOUNT = (
Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
+
Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
);
                        }
                        txtTotalDiscount.Text = TOTDISCOUNT.ToString();

                    }
                    else if (taskControl.RenewalNo != "" && taskControl.TotalDiscountsPct.ToString() != "0.0")
                    {
                        string CurrentDiscount = taskControl.TotalDiscountsPct.ToString();
                        txtDiscountPct.Text = CurrentDiscount;
                        double TOTDISCOUNT = 0;
                        double Underagesurcharge = 0;
                        int MostMinor = 0;

                        GetMostMinor(taskControl, ref MostMinor, ref Underagesurcharge);

                        if (Underagesurcharge != 0.0)//(double.Parse(taskControl.DriversCollection.Rows[i]["Underagesurcharge"].ToString()) != 0.0)
                        {
                            TOTDISCOUNT = (
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            );
                        }
                        else
                        {
                            TOTDISCOUNT = (
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            );
                        }
                        txtTotalDiscount.Text = TOTDISCOUNT.ToString();
                    }
                    else
                    {
                        txtTotalDiscount.Text = "0";
                        txtDiscountPct.Text = "0";
                    }
                }
            }
            #region COMMENTED
            //else if (taskControl.RenewalNo != "" && taskControl.CustomerCollection == "0")
            //{
            //    for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
            //    {
            //        GetSurchargeAge();

            //        if (taskControl.TotalDiscountsPct.ToString() != "0.0")
            //        {
            //            string CurrentDiscount = taskControl.TotalDiscountsPct.ToString();
            //            txtDiscountPct.Text = CurrentDiscount;
            //            CurrentDiscount = CurrentDiscount == "0" ? "100" : CurrentDiscount;
            //            double TOTDISCOUNT = 0;
            //            double Underagesurcharge = 0;
            //            int MostMinor = 0;

            //            GetMostMinor(taskControl, ref MostMinor, ref Underagesurcharge);

            //            if (Underagesurcharge != 0.0)//(double.Parse(taskControl.DriversCollection.Rows[i]["Underagesurcharge"].ToString()) != 0.0)
            //            {
            //                TOTDISCOUNT = (
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                );
            //            }
            //            else
            //            {
            //                TOTDISCOUNT = (
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                );
            //            }
            //            txtTotalDiscount.Text = TOTDISCOUNT.ToString();
            //        }
            //        else
            //        {
            //            txtTotalDiscount.Text = "0";
            //            txtDiscountPct.Text = "0";
            //        }
            //    }
            //}
            #endregion COMMENTED
            else
            {
                if ((txtTotalDiscount.Text.ToString() == "0.00" || txtTotalDiscount.Text.ToString() == "0"))
                    txtTotalDiscount.Text = "0.00";
                else
                    txtTotalDiscount.Text = txtTotalDiscount.Text.ToString();

                if (txtDiscountPct.Text.ToString() == "0.00" || txtDiscountPct.Text.ToString() == "0")
                    txtDiscountPct.Text = "0.00";
                else
                    txtDiscountPct.Text = txtDiscountPct.Text.ToString();
            }

            if (IsMotorcycle == false)
            {
                if (radMotorcycle.SelectedItem.Value.ToString() == "Y")
                {
                    IsMotorcycle = true;
                }
            }

            for (int i = 0; taskControl.VehicleCollection.Rows.Count > i; i++)
            {
                if (taskControl.VehicleCollection.Rows.Count > 0)
                {
                    if (taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Rental")
                    {
                        RentalVehicle = "Rental";
                        break;
                    }
                    else
                    {
                        RentalVehicle = "";
                    }

                }
            }

            //==============================//
            // Rental NUNCA lleva descuento //
            //==============================//

            if (0 == 1) //if ((ddlDiscounts.SelectedItem.Text.ToString() != "N/A" && IsMotorcycle == false) && RentalVehicle != "Rental") // Temporeramente no va llevar descuento ninguna poliza
            {
                #region EL NUNCA ENTRA POR AQUI
                int HighestDiscount = 0;
                for (int i = 0; taskControl.VehicleCollection.Rows.Count > i; i++)
                {
                    DataTable Discountdt = null;

                    string VehicleValue = taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString();
                    string Island = taskControl.VehicleCollection.Rows[i]["Island"].ToString().Trim();
                    string Coverage = VehicleValue == "0" ? "Liability Only" : "Full Coverage";

                    if (Island == "St. Thomas")
                    {
                        Island = "STT";
                    }
                    else if (Island == "St. John")
                    {
                        Island = "STJ";
                    }
                    else
                    {
                        Island = "STC";
                    }

                    Discountdt = GetCoverageDiscount(taskControl.TaskControlID, Coverage, Island, rdbNewCustomerYes.Checked);

                    if (Discountdt != null)
                    {
                        if (Discountdt.Rows.Count != 0)
                        {
                            //LiabilityOnly
                            if (VehicleValue == "0")
                            {
                                if (rdbNewCustomerNo.Checked)//&& Discountdt.Rows[0]["Discount"].ToString().Trim() == "20")
                                {
                                    ddlDiscounts.SelectedItem.Text = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                    ddlDiscounts.SelectedItem.Value = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                }
                                else
                                {
                                    ddlDiscounts.SelectedItem.Text = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                    ddlDiscounts.SelectedItem.Value = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                }
                            }
                            //FullCoverage
                            else
                            {
                                if (rdbNewCustomerNo.Checked && rdbAnyAccidentsNo.Checked)
                                {
                                    if (rdb1Year.Checked)
                                    {
                                        ddlDiscounts.SelectedItem.Text = "10%";
                                        ddlDiscounts.SelectedItem.Value = "10%";
                                    }
                                    else if (rdb2Year.Checked)
                                    {
                                        ddlDiscounts.SelectedItem.Text = "20%";
                                        ddlDiscounts.SelectedItem.Value = "20%";
                                    }
                                    else
                                    {
                                        ddlDiscounts.SelectedItem.Text = "30%";
                                        ddlDiscounts.SelectedItem.Value = "30%";
                                        break;
                                    }
                                }
                                else
                                {
                                    ddlDiscounts.SelectedItem.Text = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                    ddlDiscounts.SelectedItem.Value = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                }

                            }

                            if (HighestDiscount == 0)
                            {
                                HighestDiscount = int.Parse(Discountdt.Rows[0]["Discount"].ToString().Trim());
                                ddlDiscounts.SelectedItem.Text = HighestDiscount.ToString().Trim() + "%";
                                ddlDiscounts.SelectedItem.Value = HighestDiscount.ToString().Trim() + "%";
                            }
                            else if (HighestDiscount < int.Parse(Discountdt.Rows[0]["Discount"].ToString().Trim()))
                            {
                                HighestDiscount = int.Parse(Discountdt.Rows[0]["Discount"].ToString().Trim());
                                ddlDiscounts.SelectedItem.Text = HighestDiscount.ToString().Trim() + "%";
                                ddlDiscounts.SelectedItem.Value = HighestDiscount.ToString().Trim() + "%";
                            }
                            else if (HighestDiscount == 30)
                            {
                                ddlDiscounts.SelectedItem.Text = HighestDiscount.ToString().Trim() + "%";
                                break;
                            }

                        }
                        else
                        {
                            if (rdbAnyAccidentsNo.Checked)
                            {
                                if (rdb1Year.Checked)
                                {
                                    ddlDiscounts.SelectedItem.Text = "10%";
                                    ddlDiscounts.SelectedItem.Value = "10%";
                                }
                                else if (rdb2Year.Checked)
                                {
                                    ddlDiscounts.SelectedItem.Text = "20%";
                                    ddlDiscounts.SelectedItem.Value = "20%";
                                }
                                else
                                {
                                    ddlDiscounts.SelectedItem.Text = "30%";
                                    ddlDiscounts.SelectedItem.Value = "30%";
                                    break;
                                }
                            }
                        }
                    }
                    else
                    {

                    }
                }

                //stxtTotalPremiumVehicle.Text = "0.00";

                txtTotalDiscount.Text = "0.00";
                for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                {
                    if (1 == 1)//if (taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Taxi")
                    {

                        txtTotalDiscount.Text = (double.Parse(txtTotalDiscount.Text) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString()) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString()) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString()) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString()) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString()) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString())).ToString();

                        txtTotalDiscount.Text = Math.Round((double.Parse(txtTotalDiscount.Text)), 0).ToString();// - TotalCoverage).ToString();
                    }
                    else
                    {
                        txtTotalDiscount.Text = Math.Round((GrandTotal - TotalCoverage) * (double.Parse(ddlDiscounts.SelectedItem.Text.ToString().Replace("%", "")) / 100), 0).ToString();
                    }
                }
                #endregion EL NUNCA ENTRA POR AQUI
            }
            else
            {
                //========================================//
                // APLICA LOS DESCUENTOS A LAS CUEBIERTAS //
                //========================================//

                //JOSHUA AQUI CUANDO SE RENUEVA UNA POLIZA DE EPPS A EPPS DEBE DEJAR LOS DESCUENTOS YA EXISTENTES Y APLICARSELO A TODAS LAS CUBIERTAS DE LA POLIZA JNF FML
                //if ((taskControl.RenewalNo != "" && taskControl.CustomerCollection.ToString() == "0") && (txtDiscountPct.Text.ToString() == "30" || txtDiscountPct.Text.ToString() == "20" || txtDiscountPct.Text.ToString() == "10"))
                //{
                //    txtTotalDiscount.Text = "0.00";
                //    for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                //    {
                //        if (1 == 1)//if (taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Taxi")
                //        {

                //            txtTotalDiscount.Text = (double.Parse(txtTotalDiscount.Text) +
                //            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                //            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                //            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                //            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                //            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                //            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString())).ToString();
                //            txtTotalDiscount.Text = Math.Round((double.Parse(txtTotalDiscount.Text)), 0).ToString();// - TotalCoverage).ToString();
                //        }
                //        else
                //        {
                //            txtTotalDiscount.Text = Math.Round((GrandTotal - TotalCoverage) * (double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString();
                //        }
                //    }
                //}
                if ((taskControl.PolicyClaim.ToString().Trim() == "No" || radGenPolicyClaimNo.Checked || taskControl.RenewalNo != "") && taskControl.CustomerCollection == "0")//else if
                {
                    string OldDiscount = txtTotalDiscount.Text.ToString();
                    txtTotalDiscount.Text = "0.00";
                    for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                    {
                        if (1 == 1)//if (taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Taxi")
                        {

                            txtTotalDiscount.Text = (double.Parse(txtTotalDiscount.Text) +
                            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString())).ToString();
                            txtTotalDiscount.Text = Math.Round((double.Parse(txtTotalDiscount.Text)), 0).ToString();// - TotalCoverage).ToString();
                        }
                        else
                        {
                            txtTotalDiscount.Text = Math.Round((GrandTotal - TotalCoverage) * (double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString();
                        }
                    }

                    if (txtTotalDiscount.Text.ToString() == "0.00" || txtTotalDiscount.Text.ToString() == "0")
                        txtTotalDiscount.Text = OldDiscount;
                }
                else
                {
                    if (txtTotalDiscount.Text.ToString() == "0.00" || txtTotalDiscount.Text.ToString() == "0")
                        txtTotalDiscount.Text = "0.00";
                    else
                        txtTotalDiscount.Text = txtTotalDiscount.Text.ToString();
                }
            }

            txtGrandTotal.Text = (GrandTotal - double.Parse(txtTotalDiscount.Text.ToString())).ToString();

            taskControl.VehicleCollection.AcceptChanges();
            dt = taskControl.VehicleCollection;

            this.GridVehicle.Visible = true;
            this.GridBreakDown.Visible = true;
            this.GridVehicle.DataSource = dt;
            this.GridVehicle.DataBind();
            this.GridVehicle.Visible = true;
            this.GridBreakDown.Visible = true;


            for (int i = 6; i < 40; i++)
            {
                GridVehicle.Columns[i].Visible = false;
            }
            //GridVehicle.Columns[32].Visible = false;
            GridVehicle.Columns[33].Visible = false;
            GridVehicle.Columns[38].Visible = false;
            GridVehicle.Columns[40].Visible = false;
            GridVehicle.Columns[41].Visible = false;
            GridVehicle.Columns[6].Visible = false;
            GridVehicle.Columns[42].Visible = false;
            GridVehicle.Columns[44].Visible = false;
            GridVehicle.Columns[45].Visible = false;

            GridVehicle.Columns[39].Visible = true;
            GridVehicle.Columns[26].Visible = true;
            GridVehicle.Columns[27].Visible = true;
            GridVehicle.Columns[28].Visible = true;
            GridVehicle.Columns[29].Visible = true;
            GridVehicle.Columns[30].Visible = true;
            GridVehicle.Columns[31].Visible = true;
            GridVehicle.Columns[32].Visible = true;
            GridVehicle.Columns[34].Visible = true;
        }



        private void CalculatePremium()
        {
            try
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                if (taskControl.RenewalNo == "" || taskControl.CustomerCollection != "1")
                {

                    if (taskControl.CustomerCollection != "1")// || taskControl.CustomerCollection == "")
                    {

                        txtBIRate.Text = "0.00";
                        txtPDRate.Text = "0.00";
                        txtMPRate.Text = "0.00";
                        txtCollision.Text = "0.00";
                        txtComp.Text = "0.00";
                        txtMotorist.Text = "0.00";
                        txtADD.Text = "0.00";
                        txtRentalReimbursment.Text = "0.00";
                        txtTaxiLossIncome.Text = "0.00";
                        txtTotalPremiumVehicle.Text = "0.00";
                        txtTotalCharges.Text = "0.00";
                        txtGrandTotal.Text = "0.00";

                        for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                        {

                            taskControl.VehicleCollection.Rows[i]["TotalPremium"] =
                                double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["MotoristPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["ADDPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["RentalReim"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["TaxiLossAmount"].ToString())
                                ;

                            //double.Parse(taskControl.VehicleCollection.Rows[i]["TotalPremium"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["ViolationSurcharge"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString());
                            taskControl.VehicleCollection.Rows[i]["ViolationSurcharge"] = "0.0";
                            taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"] = "0.0";
                            taskControl.VehicleCollection.Rows[i]["OtherSurcharge"] = "0.0";
                        }
                        taskControl.VehicleCollection.AcceptChanges();



                        for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                        {
                            txtCollision.Text = (double.Parse(txtCollision.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString())).ToString();
                            txtComp.Text = (double.Parse(txtComp.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString())).ToString();
                            txtMPRate.Text = (double.Parse(txtMPRate.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString())).ToString();
                            txtPDRate.Text = (double.Parse(txtPDRate.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString())).ToString();
                            txtBIRate.Text = (double.Parse(txtBIRate.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString())).ToString();
                            txtMotorist.Text = (double.Parse(txtMotorist.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["MotoristPremium"].ToString())).ToString();
                            txtADD.Text = (double.Parse(txtADD.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["ADDPremium"].ToString())).ToString();
                            txtRentalReimbursment.Text = (double.Parse(txtRentalReimbursment.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["RentalReim"].ToString())).ToString();
                            txtTaxiLossIncome.Text = (double.Parse(txtTaxiLossIncome.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["TaxiLossAmount"].ToString())).ToString();

                            txtTotalPremiumVehicle.Text = (double.Parse(txtTotalPremiumVehicle.Text.Replace("$", "")) + double.Parse(taskControl.VehicleCollection.Rows[i]["TotalPremium"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["ViolationSurcharge"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurcharge"].ToString())).ToString();

                        }
                        CalculateCharges(false, "");

                        #region OLD CODE THAT DID NOT WORK
                        //SE AÑADIO PARA QUE CALCULE LOS AUTOS POR CADA CAMBIO SIN TENER QUE DARLE --SAVE QUOTE--
                        // ______________________________________________________________
                        //EPolicy.Login.Login cp = HttpContext.Current.User as EPolicy.Login.Login;

                        //int userID = int.Parse(cp.Identity.Name.Split("|".ToCharArray())[1]);


                        //if (taskControl.TaskControlID.ToString() != "0")
                        //{
                        //    //SaveClick();
                        //    //taskControl.save SaveAutosDB();
                        //    int Mode = 0;

                        //    Mode = taskControl.Mode;
                        //    //if (taskControl.Mode == 4)
                        //    //{
                        //    //    Mode = 4;
                        //    //}
                        //    taskControl.SaveDriverDetail(userID,taskControl.TaskControlID);
                        //    taskControl.SaveAutos(userID);

                        //    taskControl.Mode = Mode;


                        //}
                        //________________________________________________________________
                        //Si el calculo se llega a descuadrar trata comentando esta parte.
                        #endregion
                    }
                }

                GetTotalPremium();

            }
            catch (Exception xcp)
            {
                lblRecHeader.Text = xcp.Message.Trim();
                mpeSeleccion.Show();
            }
        }

        private void CalculateCharges(bool OnTheFly, string TotPrem)
        {
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            AddPrimaryDriver();


            int CantidadSurcharges = GetCantidadSurcharges();
            double ACV = 0.0;
            int VehicleID = 0;
            double UnderAgeCharge = 1.0;
            double ViolationCharge = 1.0;
            double Factor = 1.0;
            double TotalCharges = 0.0;
            double TotalCoverage = 0;

            if (TotPrem == "")
            {
                TotPrem = "0";
            }

            //no entra
            for (int x = 0; x < CantidadSurcharges; x++)
            {
                GridDrivers.Columns[10].Visible = true;
                DataView dv = taskControl.DriversCollection.DefaultView;
                dv.Sort = "SumOfSurcharges DESC";
                taskControl.DriversCollection = dv.ToTable();

                for (int i = 0; i < taskControl.DriversCollection.Rows.Count; i++)
                {
                    if (x == i)
                    {
                        UnderAgeCharge = double.Parse(taskControl.DriversCollection.Rows[i]["UnderageSurcharge"].ToString());
                        ViolationCharge = double.Parse(taskControl.DriversCollection.Rows[i]["TrafficViolationSurcharge"].ToString());

                        ACV = GetPremiumFromVehicles(x + 1, ref VehicleID);



                        //if (taskControl.VehicleCollection.Rows.Count != 0)
                        //{
                        //    if (UnderAgeCharge != 0.0 && double.Parse(taskControl.VehicleCollection.Rows[i]["MotoristPremium"].ToString()) != 0.0 || UnderAgeCharge != 0.0 && double.Parse(taskControl.VehicleCollection.Rows[i]["ADDPremium"].ToString()) != 0.0 || UnderAgeCharge != 0.0 && double.Parse(taskControl.VehicleCollection.Rows[i]["RentalReim"].ToString()) != 0.0)
                        //    {
                        //        ACV = ACV -
                        //                double.Parse(taskControl.VehicleCollection.Rows[i]["MotoristPremium"].ToString()) -
                        //                double.Parse(taskControl.VehicleCollection.Rows[i]["ADDPremium"].ToString()) -
                        //                double.Parse(taskControl.VehicleCollection.Rows[i]["RentalReim"].ToString());

                        //        //taskControl.VehicleCollection.Rows[y]["TotalPremium"] = ACV;
                        //    }

                        //    if (ViolationCharge != 0.0 && double.Parse(taskControl.VehicleCollection.Rows[i]["MotoristPremium"].ToString()) != 0.0 || ViolationCharge != 0.0 && double.Parse(taskControl.VehicleCollection.Rows[i]["ADDPremium"].ToString()) != 0.0 || ViolationCharge != 0.0 && double.Parse(taskControl.VehicleCollection.Rows[i]["RentalReim"].ToString()) != 0.0)
                        //    {
                        //        ACV = ACV -
                        //                double.Parse(taskControl.VehicleCollection.Rows[i]["MotoristPremium"].ToString()) -
                        //                double.Parse(taskControl.VehicleCollection.Rows[i]["ADDPremium"].ToString()) -
                        //                double.Parse(taskControl.VehicleCollection.Rows[i]["RentalReim"].ToString());

                        //        //taskControl.VehicleCollection.Rows[y]["TotalPremium"] = ACV;
                        //    }
                        //}

                        if (taskControl.VehicleCollection.Rows.Count == 0)
                        {

                            if (ViolationCharge > 1.0)
                            {
                                ViolationCharge = Math.Round((ViolationCharge - Factor) * ACV, 0);
                            }
                            else
                            {
                                ViolationCharge = 0.0;
                            }

                            if (UnderAgeCharge > 1.0)
                            {
                                UnderAgeCharge = Math.Round((UnderAgeCharge - Factor) * ACV, 0);
                            }
                            else
                            {
                                UnderAgeCharge = 0.0;
                            }

                            TotPrem = (double.Parse(TotPrem) + UnderAgeCharge + ViolationCharge).ToString();

                            TotalCharges = TotalCharges + ViolationCharge + UnderAgeCharge;

                            UnderAgeCharge = 0.0;
                            ViolationCharge = 0.0;

                        }
                        else
                        {
                            var Age = TxtAge.Text;


                            for (int y = 0; y < taskControl.VehicleCollection.Rows.Count; y++)
                            {
                                if (VehicleID == int.Parse(taskControl.VehicleCollection.Rows[y]["VehicleDetailID"].ToString()))
                                {
                                    if (ViolationCharge > 1.0)
                                    {
                                        ViolationCharge = Math.Round((ViolationCharge - Factor) * ACV, 0);
                                    }
                                    else
                                    {
                                        ViolationCharge = 0.0;
                                    }

                                    if (UnderAgeCharge > 1.0)
                                    {
                                        UnderAgeCharge = Math.Round((UnderAgeCharge - Factor) * ACV, 0);
                                    }
                                    else
                                    {
                                        UnderAgeCharge = 0.0;
                                    }

                                    // se comento para verificar el calculo del OnTheFly
                                    //taskControl.VehicleCollection.Rows[y]["TotalPremium"] = double.Parse(taskControl.VehicleCollection.Rows[y]["TotalPremium"].ToString()) + UnderAgeCharge + ViolationCharge;

                                    if (OnTheFly)
                                    {
                                        taskControl.VehicleCollection.Rows[y]["TotalPremium"] = double.Parse(TotPrem) + UnderAgeCharge + ViolationCharge;
                                    }
                                    else
                                    {
                                        taskControl.VehicleCollection.Rows[y]["TotalPremium"] = double.Parse(taskControl.VehicleCollection.Rows[y]["TotalPremium"].ToString());// + UnderAgeCharge + ViolationCharge;
                                    }

                                    taskControl.VehicleCollection.Rows[y]["ViolationSurcharge"] = double.Parse(taskControl.VehicleCollection.Rows[y]["ViolationSurcharge"].ToString()) + ViolationCharge;
                                    taskControl.VehicleCollection.Rows[y]["UnderAgeSurcharge"] = double.Parse(taskControl.VehicleCollection.Rows[y]["UnderAgeSurcharge"].ToString()) + UnderAgeCharge;

                                    TotalCharges = TotalCharges + ViolationCharge + UnderAgeCharge;

                                    UnderAgeCharge = 0.0;
                                    ViolationCharge = 0.0;
                                }

                            }
                            taskControl.VehicleCollection.AcceptChanges();
                        }
                    }
                }
            }

            for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
            {
                TotalCharges += double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurcharge"].ToString());
                TotalCoverage += double.Parse(taskControl.VehicleCollection.Rows[i]["MotoristPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["ADDPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["RentalReim"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["TaxiLossAmount"].ToString());
            }


            //if (TotalCharges != 0.0 && TotalCoverage != 0.0)
            //{
            //    txtTotalPremiumVehicle.Text = (double.Parse(txtTotalPremiumVehicle.Text.ToString()) + TotalCoverage).ToString();
            //}

            GridDrivers.Columns[11].Visible = false;

            for (int i = 0; i < GridVehicle.Columns.Count; i++)
            {
                GridVehicle.Columns[i].Visible = true;
            }
            DataTable dt = null;

            txtTotalCharges.Text = Math.Round(TotalCharges, 0).ToString();
            txtGrandTotal.Text = (double.Parse(txtTotalPremiumVehicle.Text.ToString()) + double.Parse(txtTotalCharges.Text.ToString())).ToString();

            double TPremium = 0.0;
            double OthSurcharge = 0.0;
            double OthSurchargePct = 0.0;
            bool IsMotorcycle = false;

            for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
            {
                TPremium = double.Parse(taskControl.VehicleCollection.Rows[i]["TotalPremium"].ToString());
                OthSurcharge = Math.Round(double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurcharge"].ToString()), 0);
                OthSurchargePct = double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurchargePct"].ToString());

                taskControl.VehicleCollection.Rows[i]["OtherSurcharge"] = Math.Round(TPremium * (OthSurchargePct / 100));
                taskControl.VehicleCollection.Rows[i]["TotalPremium"] = double.Parse(taskControl.VehicleCollection.Rows[i]["TotalPremium"].ToString()); //+ double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurcharge"].ToString());
                txtTotalCharges.Text = (double.Parse(txtTotalCharges.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurcharge"].ToString())).ToString();
                if (taskControl.VehicleCollection.Rows[i]["IsMotorcycleScooter"].ToString() == "True")
                {
                    IsMotorcycle = true;
                }
            }

            double GrandTotal = double.Parse(txtTotalPremiumVehicle.Text.ToString()) + double.Parse(txtTotalCharges.Text.ToString());

            string RentalVehicle = "";
            //CALCULATE DISCOUNTS
            if ((taskControl.PolicyClaim.ToString().Trim() == "No" || radGenPolicyClaimNo.Checked) && (taskControl.RenewalNo == "" || taskControl.CustomerCollection == "0"))
            {
                for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                {
                    GetSurchargeAge();

                    if (1 == 1)//(taskControl.RenewalNo == "")
                    {

                        string CurrentDiscount = "0";
                        DataTable CurrentDiscountdt =  GetDiscounts("22",false,false, taskControl.EntryDate);

                        if (CurrentDiscountdt.Rows.Count > 0)
                            CurrentDiscount = CurrentDiscountdt.Rows[0]["Discount"].ToString();

                        txtDiscountPct.Text = CurrentDiscount;
                        double TOTDISCOUNT = 0;
                        double Underagesurcharge = 0;
                        int MostMinor = 0;

                        GetMostMinor(taskControl, ref MostMinor, ref Underagesurcharge);

                        if (Underagesurcharge != 0.0)//(double.Parse(taskControl.DriversCollection.Rows[i]["Underagesurcharge"].ToString()) != 0.0)
                        {
                            TOTDISCOUNT = (
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            );
                        }
                        else
                        {
                            TOTDISCOUNT = (
Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
+
Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
);
                        }
                        txtTotalDiscount.Text = TOTDISCOUNT.ToString();

                    }
                    else if (taskControl.RenewalNo != "" && taskControl.TotalDiscountsPct.ToString() != "0.0")
                    {
                        string CurrentDiscount = taskControl.TotalDiscountsPct.ToString();
                        txtDiscountPct.Text = CurrentDiscount;
                        double TOTDISCOUNT = 0;
                        double Underagesurcharge = 0;
                        int MostMinor = 0;

                        GetMostMinor(taskControl, ref MostMinor, ref Underagesurcharge);

                        if (Underagesurcharge != 0.0)//(double.Parse(taskControl.DriversCollection.Rows[i]["Underagesurcharge"].ToString()) != 0.0)
                        {
                            TOTDISCOUNT = (
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            );
                        }
                        else
                        {
                            TOTDISCOUNT = (
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            );
                        }
                        txtTotalDiscount.Text = TOTDISCOUNT.ToString();
                    }
                    else
                    {
                        txtTotalDiscount.Text = "0";
                        txtDiscountPct.Text = "0";
                    }
                }
            }
            #region COMMENTED
            //else if (taskControl.RenewalNo != "" && taskControl.CustomerCollection == "0")
            //{
            //    for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
            //    {
            //        GetSurchargeAge();

            //        if (taskControl.TotalDiscountsPct.ToString() != "0.0")
            //        {
            //            string CurrentDiscount = taskControl.TotalDiscountsPct.ToString();
            //            txtDiscountPct.Text = CurrentDiscount;
            //            CurrentDiscount = CurrentDiscount == "0" ? "100" : CurrentDiscount;
            //            double TOTDISCOUNT = 0;
            //            double Underagesurcharge = 0;
            //            int MostMinor = 0;

            //            GetMostMinor(taskControl, ref MostMinor, ref Underagesurcharge);

            //            if (Underagesurcharge != 0.0)//(double.Parse(taskControl.DriversCollection.Rows[i]["Underagesurcharge"].ToString()) != 0.0)
            //            {
            //                TOTDISCOUNT = (
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                );
            //            }
            //            else
            //            {
            //                TOTDISCOUNT = (
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                );
            //            }
            //            txtTotalDiscount.Text = TOTDISCOUNT.ToString();
            //        }
            //        else
            //        {
            //            txtTotalDiscount.Text = "0";
            //            txtDiscountPct.Text = "0";
            //        }
            //    }
            //}
            #endregion COMMENTED
            else
            {
                if ((txtTotalDiscount.Text.ToString() == "0.00" || txtTotalDiscount.Text.ToString() == "0"))
                    txtTotalDiscount.Text = "0.00";
                else
                    txtTotalDiscount.Text = txtTotalDiscount.Text.ToString();

                if (txtDiscountPct.Text.ToString() == "0.00" || txtDiscountPct.Text.ToString() == "0")
                    txtDiscountPct.Text = "0.00";
                else
                    txtDiscountPct.Text = txtDiscountPct.Text.ToString();
            }

            if (IsMotorcycle == false)
            {
                if (radMotorcycle.SelectedItem.Value.ToString() == "Y")
                {
                    IsMotorcycle = true;
                }
            }

            for (int i = 0; taskControl.VehicleCollection.Rows.Count > i; i++)
            {
                if (taskControl.VehicleCollection.Rows.Count > 0)
                {
                    if (taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Rental")
                    {
                        RentalVehicle = "Rental";
                        break;
                    }
                    else
                    {
                        RentalVehicle = "";
                    }

                }
            }

            //==============================//
            // Rental NUNCA lleva descuento //
            //==============================//

            if (0 == 1) //if ((ddlDiscounts.SelectedItem.Text.ToString() != "N/A" && IsMotorcycle == false) && RentalVehicle != "Rental") // Temporeramente no va llevar descuento ninguna poliza
            {
                #region EL NUNCA ENTRA POR AQUI
                int HighestDiscount = 0;
                for (int i = 0; taskControl.VehicleCollection.Rows.Count > i; i++)
                {
                    DataTable Discountdt = null;

                    string VehicleValue = taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString();
                    string Island = taskControl.VehicleCollection.Rows[i]["Island"].ToString().Trim();
                    string Coverage = VehicleValue == "0" ? "Liability Only" : "Full Coverage";

                    if (Island == "St. Thomas")
                    {
                        Island = "STT";
                    }
                    else if (Island == "St. John")
                    {
                        Island = "STJ";
                    }
                    else
                    {
                        Island = "STC";
                    }

                    Discountdt = GetCoverageDiscount(taskControl.TaskControlID, Coverage, Island, rdbNewCustomerYes.Checked);

                    if (Discountdt != null)
                    {
                        if (Discountdt.Rows.Count != 0)
                        {
                            //LiabilityOnly
                            if (VehicleValue == "0")
                            {
                                if (rdbNewCustomerNo.Checked)//&& Discountdt.Rows[0]["Discount"].ToString().Trim() == "20")
                                {
                                    ddlDiscounts.SelectedItem.Text = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                    ddlDiscounts.SelectedItem.Value = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                }
                                else
                                {
                                    ddlDiscounts.SelectedItem.Text = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                    ddlDiscounts.SelectedItem.Value = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                }
                            }
                            //FullCoverage
                            else
                            {
                                if (rdbNewCustomerNo.Checked && rdbAnyAccidentsNo.Checked)
                                {
                                    if (rdb1Year.Checked)
                                    {
                                        ddlDiscounts.SelectedItem.Text = "10%";
                                        ddlDiscounts.SelectedItem.Value = "10%";
                                    }
                                    else if (rdb2Year.Checked)
                                    {
                                        ddlDiscounts.SelectedItem.Text = "20%";
                                        ddlDiscounts.SelectedItem.Value = "20%";
                                    }
                                    else
                                    {
                                        ddlDiscounts.SelectedItem.Text = "30%";
                                        ddlDiscounts.SelectedItem.Value = "30%";
                                        break;
                                    }
                                }
                                else
                                {
                                    ddlDiscounts.SelectedItem.Text = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                    ddlDiscounts.SelectedItem.Value = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                }

                            }

                            if (HighestDiscount == 0)
                            {
                                HighestDiscount = int.Parse(Discountdt.Rows[0]["Discount"].ToString().Trim());
                                ddlDiscounts.SelectedItem.Text = HighestDiscount.ToString().Trim() + "%";
                                ddlDiscounts.SelectedItem.Value = HighestDiscount.ToString().Trim() + "%";
                            }
                            else if (HighestDiscount < int.Parse(Discountdt.Rows[0]["Discount"].ToString().Trim()))
                            {
                                HighestDiscount = int.Parse(Discountdt.Rows[0]["Discount"].ToString().Trim());
                                ddlDiscounts.SelectedItem.Text = HighestDiscount.ToString().Trim() + "%";
                                ddlDiscounts.SelectedItem.Value = HighestDiscount.ToString().Trim() + "%";
                            }
                            else if (HighestDiscount == 30)
                            {
                                ddlDiscounts.SelectedItem.Text = HighestDiscount.ToString().Trim() + "%";
                                break;
                            }

                        }
                        else
                        {
                            if (rdbAnyAccidentsNo.Checked)
                            {
                                if (rdb1Year.Checked)
                                {
                                    ddlDiscounts.SelectedItem.Text = "10%";
                                    ddlDiscounts.SelectedItem.Value = "10%";
                                }
                                else if (rdb2Year.Checked)
                                {
                                    ddlDiscounts.SelectedItem.Text = "20%";
                                    ddlDiscounts.SelectedItem.Value = "20%";
                                }
                                else
                                {
                                    ddlDiscounts.SelectedItem.Text = "30%";
                                    ddlDiscounts.SelectedItem.Value = "30%";
                                    break;
                                }
                            }
                        }
                    }
                    else
                    {

                    }
                }

                //stxtTotalPremiumVehicle.Text = "0.00";

                txtTotalDiscount.Text = "0.00";
                for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                {
                    if (1 == 1)//if (taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Taxi")
                    {

                        txtTotalDiscount.Text = (double.Parse(txtTotalDiscount.Text) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString()) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString()) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString()) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString()) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString()) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString())).ToString();

                        txtTotalDiscount.Text = Math.Round((double.Parse(txtTotalDiscount.Text)), 0).ToString();// - TotalCoverage).ToString();
                    }
                    else
                    {
                        txtTotalDiscount.Text = Math.Round((GrandTotal - TotalCoverage) * (double.Parse(ddlDiscounts.SelectedItem.Text.ToString().Replace("%", "")) / 100), 0).ToString();
                    }
                }
                #endregion EL NUNCA ENTRA POR AQUI
            }
            else
            {
                //========================================//
                // APLICA LOS DESCUENTOS A LAS CUEBIERTAS //
                //========================================//

                //JOSHUA AQUI CUANDO SE RENUEVA UNA POLIZA DE EPPS A EPPS DEBE DEJAR LOS DESCUENTOS YA EXISTENTES Y APLICARSELO A TODAS LAS CUBIERTAS DE LA POLIZA JNF FML
                //if ((taskControl.RenewalNo != "" && taskControl.CustomerCollection.ToString() == "0") && (txtDiscountPct.Text.ToString() == "30" || txtDiscountPct.Text.ToString() == "20" || txtDiscountPct.Text.ToString() == "10"))
                //{
                //    txtTotalDiscount.Text = "0.00";
                //    for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                //    {
                //        if (1 == 1)//if (taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Taxi")
                //        {

                //            txtTotalDiscount.Text = (double.Parse(txtTotalDiscount.Text) +
                //            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                //            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                //            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                //            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                //            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                //            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString())).ToString();
                //            txtTotalDiscount.Text = Math.Round((double.Parse(txtTotalDiscount.Text)), 0).ToString();// - TotalCoverage).ToString();
                //        }
                //        else
                //        {
                //            txtTotalDiscount.Text = Math.Round((GrandTotal - TotalCoverage) * (double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString();
                //        }
                //    }
                //}
                if ((taskControl.PolicyClaim.ToString().Trim() == "No" || radGenPolicyClaimNo.Checked || taskControl.RenewalNo != "") && taskControl.CustomerCollection == "0")//else if
                {
                    string OldDiscount = txtTotalDiscount.Text.ToString();
                    txtTotalDiscount.Text = "0.00";
                    for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                    {
                        double Underagesurcharge = 0;
                        int MostMinor = 0;

                        GetMostMinor(taskControl, ref MostMinor, ref Underagesurcharge);

                        if (Underagesurcharge != 0.0)//(double.Parse(taskControl.DriversCollection.Rows[i]["Underagesurcharge"].ToString()) != 0.0)
                        {
                            txtTotalDiscount.Text = (double.Parse(txtTotalDiscount.Text) +
                            double.Parse(Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * Underagesurcharge) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100).ToString())).ToString())
                            +
                            double.Parse(Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * Underagesurcharge) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100).ToString())).ToString())
                            ).ToString();
                            txtTotalDiscount.Text = Math.Round((double.Parse(txtTotalDiscount.Text)), 0).ToString();// - TotalCoverage).ToString();
                        }
                        else if (1 == 1)//if (taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Taxi")
                        {

                            txtTotalDiscount.Text = (double.Parse(txtTotalDiscount.Text) +
                            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString())).ToString();
                            txtTotalDiscount.Text = Math.Round((double.Parse(txtTotalDiscount.Text)), 0).ToString();// - TotalCoverage).ToString();
                        }
                        else
                        {
                            txtTotalDiscount.Text = Math.Round((GrandTotal - TotalCoverage) * (double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString();
                        }
                    }

                    if (txtTotalDiscount.Text.ToString() == "0.00" || txtTotalDiscount.Text.ToString() == "0")
                        txtTotalDiscount.Text = OldDiscount;
                }
                else
                {
                    if (txtTotalDiscount.Text.ToString() == "0.00" || txtTotalDiscount.Text.ToString() == "0")
                        txtTotalDiscount.Text = "0.00";
                    else
                        txtTotalDiscount.Text = txtTotalDiscount.Text.ToString();
                }
            }

            double Underagesurcharges = 0;
            int MostMinors = 0;

            GetMostMinor(taskControl, ref MostMinors, ref Underagesurcharges);

            if (Underagesurcharges != 0 && taskControl.VehicleCollection.Rows.Count > 0 && taskControl.VehicleBreakDownCollection.Rows.Count == int.Parse(ddlTerms.Text.ToString()))
            {
                UnderAgeCalculate();
                GrandTotal = double.Parse(txtTotalPremiumVehicle.Text.ToString()) + double.Parse(txtTotalCharges.Text.ToString());
            }

            txtGrandTotal.Text = (GrandTotal - double.Parse(txtTotalDiscount.Text.ToString())).ToString();

            //CALCULATE AFFINITY DISCOUNT

            if (radAffinityDiscountYes.Checked)
            {
                taskControl.AffinityDiscountPct = 5.0;
                txtAffinityDiscountPct.Text = taskControl.AffinityDiscountPct.ToString();
                txtAffinityDiscount.Text = Math.Round((double.Parse(txtGrandTotal.Text) * (taskControl.AffinityDiscountPct / 100)), 0).ToString();
            }
            else
            {
                txtAffinityDiscountPct.Text = "0";
                txtAffinityDiscount.Text = "0";
            }

            if (double.Parse(txtAffinityDiscount.Text.ToString()) != 0.0)
            {
                //Apply Affinity Discount
                //txtGrandTotal.Text = (GrandTotal - double.Parse(txtAffinityDiscount.Text.ToString())).ToString();
                txtTotalDiscount.Text = (double.Parse(txtTotalDiscount.Text.ToString()) + double.Parse(txtAffinityDiscount.Text.ToString())).ToString();
                txtGrandTotal.Text = (GrandTotal - double.Parse(txtTotalDiscount.Text.ToString())).ToString();
            }

            txtGrossTax.Text =
                txtGrandTotal.Text != "" ?
                double.Parse(txtGrandTotal.Text.Trim()) != 0.0 ?
                (Math.Round(CalculateAgentCommision(ddlAgent.SelectedItem.Value, double.Parse(txtGrandTotal.Text.Trim())), 2)).ToString()
                : "0"
                : "0";

            double GrossTax = 0, GrandTotalValue = 0;
            double.TryParse(txtGrossTax.Text,
                System.Globalization.NumberStyles.Number | System.Globalization.NumberStyles.AllowCurrencySymbol,
                System.Globalization.CultureInfo.CreateSpecificCulture("en-US"),
                out GrossTax);
            double.TryParse(txtGrandTotal.Text,
                System.Globalization.NumberStyles.Number | System.Globalization.NumberStyles.AllowCurrencySymbol,
                System.Globalization.CultureInfo.CreateSpecificCulture("en-US"),
                out GrandTotalValue);

            txtGrandTotal.Text = GrossTax > 0 ? (GrandTotalValue + GrossTax).ToString() : GrandTotalValue.ToString();

            taskControl.VehicleCollection.AcceptChanges();
            dt = taskControl.VehicleCollection;

            this.GridVehicle.Visible = true;
            this.GridVehicle.DataSource = dt;
            this.GridVehicle.DataBind();
            this.GridVehicle.Visible = true;


            for (int i = 6; i < 40; i++)
            {
                GridVehicle.Columns[i].Visible = false;
            }
            //GridVehicle.Columns[32].Visible = false;
            GridVehicle.Columns[33].Visible = false;
            GridVehicle.Columns[38].Visible = false;
            GridVehicle.Columns[40].Visible = false;
            GridVehicle.Columns[41].Visible = false;
            GridVehicle.Columns[6].Visible = false;
            GridVehicle.Columns[42].Visible = false;
            GridVehicle.Columns[44].Visible = false;
            GridVehicle.Columns[45].Visible = false;

            GridVehicle.Columns[39].Visible = true;
            GridVehicle.Columns[26].Visible = true;
            GridVehicle.Columns[27].Visible = true;
            GridVehicle.Columns[28].Visible = true;
            GridVehicle.Columns[29].Visible = true;
            GridVehicle.Columns[30].Visible = true;
            GridVehicle.Columns[31].Visible = true;
            GridVehicle.Columns[32].Visible = true;
            GridVehicle.Columns[34].Visible = true;
        }

        private void CalculateRenewalPremium(bool FromPPS)
        {
            try
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                if (taskControl.RenewalNo == "" || taskControl.CustomerCollection != "1")
                {

                    if (taskControl.CustomerCollection != "1")// || taskControl.CustomerCollection == "")
                    {

                        txtBIRate.Text = "0.00";
                        txtPDRate.Text = "0.00";
                        txtMPRate.Text = "0.00";
                        txtCollision.Text = "0.00";
                        txtComp.Text = "0.00";
                        txtMotorist.Text = "0.00";
                        txtADD.Text = "0.00";
                        txtRentalReimbursment.Text = "0.00";
                        txtTaxiLossIncome.Text = "0.00";
                        txtTotalPremiumVehicle.Text = "0.00";
                        txtTotalCharges.Text = "0.00";
                        txtGrandTotal.Text = "0.00";

                        for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                        {

                            taskControl.VehicleCollection.Rows[i]["TotalPremium"] =
                                double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["MotoristPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["ADDPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["RentalReim"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["TaxiLossAmount"].ToString())
                                ;

                            //double.Parse(taskControl.VehicleCollection.Rows[i]["TotalPremium"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["ViolationSurcharge"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString());
                            taskControl.VehicleCollection.Rows[i]["ViolationSurcharge"] = "0.0";
                            taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"] = "0.0";
                            taskControl.VehicleCollection.Rows[i]["OtherSurcharge"] = "0.0";
                        }
                        taskControl.VehicleCollection.AcceptChanges();



                        for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                        {
                            txtCollision.Text = (double.Parse(txtCollision.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString())).ToString();
                            txtComp.Text = (double.Parse(txtComp.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString())).ToString();
                            txtMPRate.Text = (double.Parse(txtMPRate.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString())).ToString();
                            txtPDRate.Text = (double.Parse(txtPDRate.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString())).ToString();
                            txtBIRate.Text = (double.Parse(txtBIRate.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString())).ToString();
                            txtMotorist.Text = (double.Parse(txtMotorist.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["MotoristPremium"].ToString())).ToString();
                            txtADD.Text = (double.Parse(txtADD.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["ADDPremium"].ToString())).ToString();
                            txtRentalReimbursment.Text = (double.Parse(txtRentalReimbursment.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["RentalReim"].ToString())).ToString();
                            txtTaxiLossIncome.Text = (double.Parse(txtTaxiLossIncome.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["TaxiLossAmount"].ToString())).ToString();

                            txtTotalPremiumVehicle.Text = (double.Parse(txtTotalPremiumVehicle.Text.Replace("$", "")) + double.Parse(taskControl.VehicleCollection.Rows[i]["TotalPremium"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["ViolationSurcharge"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurcharge"].ToString())).ToString();

                        }
                        CalculateCharges(false, "");
                    }
                }
                else
                {
                    txtBIRate.Text = "0.00";
                    txtPDRate.Text = "0.00";
                    txtMPRate.Text = "0.00";
                    txtCollision.Text = "0.00";
                    txtComp.Text = "0.00";
                    txtMotorist.Text = "0.00";
                    txtADD.Text = "0.00";
                    txtRentalReimbursment.Text = "0.00";
                    txtTaxiLossIncome.Text = "0.00";
                    txtTotalPremiumVehicle.Text = "0.00";
                    txtTotalCharges.Text = "0.00";
                    txtGrandTotal.Text = "0.00";

                    for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                    {

                        taskControl.VehicleCollection.Rows[i]["TotalPremium"] =
                            double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) +
                            double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) +
                            double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) +
                            double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) +
                            double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) +
                            double.Parse(taskControl.VehicleCollection.Rows[i]["MotoristPremium"].ToString()) +
                            double.Parse(taskControl.VehicleCollection.Rows[i]["ADDPremium"].ToString()) +
                            double.Parse(taskControl.VehicleCollection.Rows[i]["RentalReim"].ToString()) +
                            double.Parse(taskControl.VehicleCollection.Rows[i]["TaxiLossAmount"].ToString())
                            ;

                        //double.Parse(taskControl.VehicleCollection.Rows[i]["TotalPremium"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["ViolationSurcharge"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString());
                        taskControl.VehicleCollection.Rows[i]["ViolationSurcharge"] = "0.0";
                        taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"] = "0.0";
                        taskControl.VehicleCollection.Rows[i]["OtherSurcharge"] = "0.0";
                    }
                    taskControl.VehicleCollection.AcceptChanges();



                    for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                    {
                        txtCollision.Text = (double.Parse(txtCollision.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString())).ToString();
                        txtComp.Text = (double.Parse(txtComp.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString())).ToString();
                        txtMPRate.Text = (double.Parse(txtMPRate.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString())).ToString();
                        txtPDRate.Text = (double.Parse(txtPDRate.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString())).ToString();
                        txtBIRate.Text = (double.Parse(txtBIRate.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString())).ToString();
                        txtMotorist.Text = (double.Parse(txtMotorist.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["MotoristPremium"].ToString())).ToString();
                        txtADD.Text = (double.Parse(txtADD.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["ADDPremium"].ToString())).ToString();
                        txtRentalReimbursment.Text = (double.Parse(txtRentalReimbursment.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["RentalReim"].ToString())).ToString();
                        txtTaxiLossIncome.Text = (double.Parse(txtTaxiLossIncome.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["TaxiLossAmount"].ToString())).ToString();

                        txtTotalPremiumVehicle.Text = (double.Parse(txtTotalPremiumVehicle.Text.Replace("$", "")) + double.Parse(taskControl.VehicleCollection.Rows[i]["TotalPremium"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["ViolationSurcharge"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurcharge"].ToString())).ToString();

                    }

                    if (FromPPS)
                        CalculateRenewalChargesPPS(false, "");
                    else
                        CalculateRenewalCharges(false, "");
                }
            }
            catch (Exception xcp)
            {
                lblRecHeader.Text = xcp.Message.Trim();
                mpeSeleccion.Show();
            }
        }

        //=====================================================//
        // Finds the youngest age of the collection of drivers //
        //=====================================================//
        //protected void GetMostMinor(EPolicy.TaskControl.DoubleInterest taskControl, ref int MostMinor, ref double Underagesurcharge)
        //{
        //    for (int e = 0; e < taskControl.DriversCollection.Rows.Count; e++)
        //    {
        //        MostMinor = int.Parse(taskControl.DriversCollection.Rows[0]["DriverAge"].ToString().Trim());
        //        if (MostMinor > int.Parse(taskControl.DriversCollection.Rows[e]["DriverAge"].ToString().Trim()))
        //        {
        //            MostMinor = int.Parse(taskControl.DriversCollection.Rows[e]["DriverAge"].ToString().Trim());
        //            Underagesurcharge = double.Parse(taskControl.DriversCollection.Rows[e]["Underagesurcharge"].ToString());
        //        }
        //        else
        //        {
        //            MostMinor = int.Parse(taskControl.DriversCollection.Rows[0]["DriverAge"].ToString().Trim());
        //            Underagesurcharge = double.Parse(taskControl.DriversCollection.Rows[0]["Underagesurcharge"].ToString());
        //        }
        //    }
        //}

        //=====================================================//
        // Finds the youngest age of the collection of drivers //
        //=====================================================//
        protected void GetMostMinor(EPolicy.TaskControl.DoubleInterest taskControl, ref int MostMinor, ref double Underagesurcharge)
        {
            if (taskControl.DriversCollection.Rows.Count > 0)
                MostMinor = int.Parse(taskControl.DriversCollection.Rows[0]["DriverAge"].ToString().Trim());

            for (int e = 0; e < taskControl.DriversCollection.Rows.Count; e++)
            {
                if (MostMinor > int.Parse(taskControl.DriversCollection.Rows[e]["DriverAge"].ToString().Trim()))
                {
                    MostMinor = int.Parse(taskControl.DriversCollection.Rows[e]["DriverAge"].ToString().Trim());
                    Underagesurcharge = double.Parse(taskControl.DriversCollection.Rows[e]["Underagesurcharge"].ToString());
                }
                else
                {
                    DataRow[] Row = taskControl.DriversCollection.Select("DriverAge = '" + MostMinor.ToString() + "'");
                    MostMinor = int.Parse(Row[0]["DriverAge"].ToString().Trim());//int.Parse(taskControl.DriversCollection.Rows[0]["DriverAge"].ToString().Trim());
                    Underagesurcharge = double.Parse(Row[0]["Underagesurcharge"].ToString().Trim());//double.Parse(taskControl.DriversCollection.Rows[0]["Underagesurcharge"].ToString());
                }
            }

            // Cuando es una transacion Comercial "BAP" no aplica el underage surcharge
            if (chkIsBusinessAutoQuote.Checked)
                Underagesurcharge = 0.0;
        }

        protected void GetMostMinorSurcharge(EPolicy.TaskControl.DoubleInterest taskControl, int MostMinor, ref double Underagesurcharge, int Position)
        {
            DataTable dt = new DataTable();
            float GradePointAvg = 0;
            string Gender = "";
            if (MostMinor == 16 || MostMinor == 17)
            {

                for (int e = 0; e < taskControl.DriversCollection.Rows.Count; e++)
                {
                    if (MostMinor == int.Parse(taskControl.DriversCollection.Rows[e]["DriverAge"].ToString().Trim()) || MostMinor - Position == int.Parse(taskControl.DriversCollection.Rows[e]["DriverAge"].ToString().Trim()))
                    {
                        GradePointAvg = float.Parse(taskControl.DriversCollection.Rows[e]["GradePointAvg"].ToString());
                        Gender = taskControl.DriversCollection.Rows[e]["DriverGender"].ToString();
                    }
                }
                dt = GetSurchargeUnderAgeFactor(MostMinor, GradePointAvg, Gender == "Female" ? "F" : "M");
                Underagesurcharge = double.Parse(dt.Rows[0]["Surcharge"].ToString());
            }
            else if (MostMinor == 18 || MostMinor == 19 || MostMinor == 20 || MostMinor == 21 || MostMinor == 22 || MostMinor == 23 || MostMinor == 24 || MostMinor == 25)
            {
                dt = GetSurchargeAgeFactor(MostMinor);
                for (int e = 0; e < taskControl.DriversCollection.Rows.Count; e++)
                {
                    if (MostMinor - Position == int.Parse(taskControl.DriversCollection.Rows[e]["DriverAge"].ToString()))
                    {
                        if (taskControl.DriversCollection.Rows[e]["DriverMaritalStatus"].ToString().Trim() == "Single" && taskControl.DriversCollection.Rows[e]["DriverGender"].ToString().Trim() == "Male")
                        {
                            Underagesurcharge = double.Parse(dt.Rows[0]["UM_U_M"].ToString());
                            break;
                        }
                        else if (taskControl.DriversCollection.Rows[e]["DriverMaritalStatus"].ToString().Trim() == "Single" && taskControl.DriversCollection.Rows[e]["DriverGender"].ToString().Trim() == "Female")
                        {
                            Underagesurcharge = double.Parse(dt.Rows[0]["UF_U_F"].ToString());
                            break;
                        }
                        else if (taskControl.DriversCollection.Rows[e]["DriverMaritalStatus"].ToString().Trim() == "Married" && taskControl.DriversCollection.Rows[e]["DriverGender"].ToString().Trim() == "Male")
                        {
                            Underagesurcharge = double.Parse(dt.Rows[0]["MM_M_M"].ToString());
                            break;
                        }
                        else if (taskControl.DriversCollection.Rows[e]["DriverMaritalStatus"].ToString().Trim() == "Married" && taskControl.DriversCollection.Rows[e]["DriverGender"].ToString().Trim() == "Female")
                        {
                            Underagesurcharge = double.Parse(dt.Rows[0]["MF_M_F"].ToString());
                            break;
                        }
                    }
                }
            }
            else
            {
                Underagesurcharge = 0.0;
            }
        }

        private double GetPremiumFromVehicles(int value, ref int VehicleID)
        {
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            double dValue = 0;

            if (GridVehicle.Rows.Count > 0)
            {
                GridVehicle.Columns[10].Visible = true;
                DataView dv = taskControl.VehicleCollection.DefaultView;
                dv.Sort = "VehicleRowNumber";
                taskControl.VehicleCollection = dv.ToTable();

                if (value > taskControl.VehicleCollection.Rows.Count)
                {
                    value = taskControl.VehicleCollection.Rows.Count;
                }

                for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                {
                    if (i + 1 == value)
                    {
                        dValue = double.Parse(taskControl.VehicleCollection.Rows[i]["TotalPremium"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["ViolationSurcharge"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["MotoristPremium"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["ADDPremium"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["RentalReim"].ToString()) - double.Parse(taskControl.VehicleCollection.Rows[i]["TaxiLossAmount"].ToString());

                        VehicleID = int.Parse(taskControl.VehicleCollection.Rows[i]["VehicleDetailID"].ToString());
                    }
                }

                GridVehicle.Columns[10].Visible = false;
            }


            return dValue;
        }

        private int GetCantidadSurcharges()
        {
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
            int cantidad = 0;

            AddPrimaryDriver();

            if (GridDrivers.Rows.Count > 0)
            {
                for (int i = 0; i < taskControl.DriversCollection.Rows.Count; i++)
                {
                    if (double.Parse(taskControl.DriversCollection.Rows[i]["SumOfSurcharges"].ToString()) != 0.0)
                        cantidad += 1;
                }
            }

            return cantidad;
        }

        private void DeleteVehicleDetail(int index)
        {
            try
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                DataTable dt = null;

                taskControl.VehicleCollection.Rows.RemoveAt(index);
                taskControl.VehicleCollection.AcceptChanges();
                dt = taskControl.VehicleCollection;
                dt.Clear();
                dt = taskControl.VehicleCollection;
                FillVehicleDetailGrid();
            }
            catch (Exception xcp)
            {
                lblRecHeader.Text = xcp.Message.Trim();
                mpeSeleccion.Show();
            }
        }

        private void DeleteVehicleBreakDown(int index)
        {
            try
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                DataTable dt = null;

                taskControl.VehicleBreakDownCollection.Rows.RemoveAt(index);
                taskControl.VehicleBreakDownCollection.AcceptChanges();
                dt = taskControl.VehicleBreakDownCollection;
                dt.Clear();
                dt = taskControl.VehicleBreakDownCollection;

                FillVehicleDetailGrid();
            }
            catch (Exception xcp)
            {
                lblRecHeader.Text = xcp.Message.Trim();
                mpeSeleccion.Show();
            }
        }

        private void FillVehicleDetailGrid()
        {
            try
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                GridVehicle.DataSource = null;
                DataTable dt = null;

                DataView dv = taskControl.VehicleCollection.DefaultView; //VehicleCollection
                dv.Sort = "VehicleRowNumber";
                taskControl.VehicleCollection = dv.ToTable();
                taskControl.VehicleCollection.AcceptChanges();

                dt = taskControl.VehicleCollection;

                for (int i = 0; i < GridVehicle.Columns.Count; i++)
                {
                    GridVehicle.Columns[i].Visible = true;
                }

                if (dt != null)
                {
                    if (dt.Rows.Count != 0)
                    {
                        GridVehicle.DataSource = dt;
                        GridVehicle.DataBind();
                    }
                    else
                    {
                        GridVehicle.DataSource = null;
                        GridVehicle.DataBind();
                    }
                }
                else
                {
                    GridVehicle.DataSource = null;
                    GridVehicle.DataBind();
                }

                for (int i = 6; i < 40; i++)
                {
                    GridVehicle.Columns[i].Visible = false;
                }
                GridVehicle.Columns[33].Visible = false;
                GridVehicle.Columns[38].Visible = false;
                GridVehicle.Columns[40].Visible = false;
                GridVehicle.Columns[41].Visible = false;
                GridVehicle.Columns[6].Visible = false;
                GridVehicle.Columns[42].Visible = false;
                GridVehicle.Columns[44].Visible = false;
                GridVehicle.Columns[45].Visible = false;

                GridVehicle.Columns[39].Visible = true;
                GridVehicle.Columns[26].Visible = true;
                GridVehicle.Columns[27].Visible = true;
                GridVehicle.Columns[28].Visible = true;
                GridVehicle.Columns[29].Visible = true;
                GridVehicle.Columns[30].Visible = true;
                GridVehicle.Columns[31].Visible = true;
                GridVehicle.Columns[32].Visible = true;
                GridVehicle.Columns[34].Visible = true;

            }
            catch (Exception exp)
            {
                lblRecHeader.Text = exp.Message;
                mpeSeleccion.Show();
            }
        }


        private void VehicleReadOnlyModify()
        {
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            GridVehicle.DataSource = null;
            DataTable dt = null;

            dt = taskControl.VehicleCollection;

            if (BtnRePrintApp.Visible == true)
            {
                GridVehicle.Enabled = true;
            }
            else
                GridVehicle.Enabled = false;
        }

        private void FillVehicleDetailGridToConvert(EPolicy.TaskControl.DoubleInterest taskControl)
        {
            try
            {
                AddPrimaryDriver();

                GridVehicle.DataSource = null;
                DataTable dt = null;

                dt = taskControl.VehicleCollection;

                if (dt != null)
                {
                    if (dt.Rows.Count != 0)
                    {
                        GridVehicle.DataSource = dt;
                        GridVehicle.DataBind();
                    }
                    else
                    {
                        GridVehicle.DataSource = null;
                        GridVehicle.DataBind();
                    }
                }
                else
                {
                    GridVehicle.DataSource = null;
                    GridVehicle.DataBind();
                }
            }
            catch (Exception exp)
            {
                lblRecHeader.Text = exp.Message;
                mpeSeleccion.Show();
            }
        }

        protected void GridVehicle_RowDeleting(object sender, GridViewDeleteEventArgs e)
        {
            //CalculatePremium();
            txtTotalQuote.Text = ".00";
        }

        #endregion Vehicles

        #region Drivers

        protected void AddPrimaryDriver()
        {
            try
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                if (!ValidateDriver())
                    return;

                int MaxDriverDetailID = 0;

                for (int i = 0; i < taskControl.DriversCollection.Rows.Count; i++)
                {
                    if (bool.Parse(taskControl.DriversCollection.Rows[i]["PrimaryDriver"].ToString()) == true)
                    {
                        taskControl.DriversCollection.Rows.RemoveAt(i);
                    }
                }

                for (int i = 0; i < taskControl.DriversCollection.Rows.Count; i++)
                {
                    if (taskControl.DriversCollection.Rows.Count > 0)
                    {
                        if (int.Parse(taskControl.DriversCollection.Rows[i]["DriverDetailID"].ToString()) > MaxDriverDetailID)
                        {
                            MaxDriverDetailID = int.Parse(taskControl.DriversCollection.Rows[i]["DriverDetailID"].ToString());
                        }
                    }
                }

                taskControl.DriversCollection.AcceptChanges();

                DataTable dt = null;
                DataRow myRow = taskControl.DriversCollection.NewRow();

                //GetSurchargeAge("BirthDate");

                if (TxtAge.Text.Trim() == "")
                    TxtAge.Text = "0";
                if (TxtDriverGrade.Text.ToString().Trim() == "")
                    TxtDriverGrade.Text = "0";

                myRow["DriverDetailID"] = MaxDriverDetailID + 1; //taskControl.DriversCollection.Rows.Count + 1;
                myRow["TaskControlID"] = "0";
                myRow["DriverName"] = TxtFirstName.Text.Trim().ToUpper();
                myRow["DriverLastName"] = TxtLastName.Text.Trim().ToUpper();
                myRow["Company"] = TxtLastName2.Text.Trim().ToUpper();
                if (ddlGender.SelectedItem.Text.Trim() == "UNDEFINED (BUSINESS ONLY)")
                    myRow["DriverGender"] = "UNDEFINED";
                else
                    myRow["DriverGender"] = ddlGender.SelectedItem.Text.Trim();
                myRow["DriverMaritalStatus"] = ddlMaritalStatus.SelectedItem.Text.Trim();
                myRow["DriverAge"] = TxtAge.Text.Trim();
                myRow["DriverDateOfBirth"] = TxtBirthDate.Text.Trim();
                myRow["TrafficViolationPoints"] = txtViolationPoints.Text.ToString().Trim();
                myRow["TrafficViolationSurcharge"] = txtViolationSurchargePct.Text.ToString().Trim();
                //myRow["UnderageSurcharge"] = txtUnderageChargesPct.Text.ToString().Trim();
                myRow["SumOfSurcharges"] = double.Parse(txtViolationSurchargePct.Text.ToString()) + double.Parse(txtUnderageChargesPct.Text.ToString());



                if (int.Parse(TxtAge.Text.ToString()) == 17 || int.Parse(TxtAge.Text.ToString()) == 16)
                {

                    if (txtPrimGrade.Text.ToString().Trim() == "")
                        txtPrimGrade.Text = "0.0";

                    myRow["GradePointAvg"] = txtPrimGrade.Text.ToString().Trim();

                    if (ddlGender.SelectedItem.Text.Trim() == "Male")
                    {
                        myRow["DriverGender"] = "MALE";
                    }
                    else
                    {
                        myRow["DriverGender"] = "FEMALE";
                    }

                    if (ddlMaritalStatus.SelectedItem.Text.Trim() == "Single")
                    {
                        myRow["DriverMaritalStatus"] = "SINGLE";
                    }
                    else
                    {
                        myRow["DriverMaritalStatus"] = "MARRIED";
                    }


                }

                myRow["PrimaryDriver"] = true;

                taskControl.DriversCollection.Rows.Add(myRow);
                taskControl.DriversCollection.AcceptChanges();
                GetSurchargeAge();

                DataView dv = taskControl.DriversCollection.DefaultView;
                dv.Sort = "PrimaryDriver DESC";
                taskControl.DriversCollection = dv.ToTable();
                taskControl.DriversCollection.AcceptChanges();


                dt = taskControl.DriversCollection;

                this.GridDrivers.Visible = true;
                this.GridDrivers.DataSource = dt;
                this.GridDrivers.DataBind();

                if (GridDrivers.Rows.Count > 1)
                {
                    this.GridDrivers.Visible = true;
                }
                else
                {
                    this.GridDrivers.Visible = false;
                }
            }
            catch (Exception)
            {

            }
        }

        protected void BtnAddDriver_Click(object sender, EventArgs e)
        {
            try
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                if (!ValidateAdditionalDriver())
                    return;

                if (lblModifyDriver.Visible == true)
                {
                    TxtDriverGrade.Visible = false;
                }

                if ((TxtDriverAge.Text == "16" || TxtDriverAge.Text == "17") && double.Parse(TxtDriverGrade.Text.ToString()) <= 0)
                {
                    return;
                }

                if (TxtDriverName.Text == "" || TxtDriverBirthDate.Text == "")
                {
                    return;
                }

                for (int i = 0; i < GridDrivers.Columns.Count - 1; i++)
                {
                    GridDrivers.Columns[i].Visible = true;
                }

                int MaxDriverDetailID = 0;

                if (TxtDriverID.Text.Trim() != "")
                {
                    for (int i = 0; i < taskControl.DriversCollection.Rows.Count; i++)
                    {
                        if (taskControl.DriversCollection.Rows[i]["DriverDetailID"].ToString() == TxtDriverID.Text.Trim())
                        {
                            taskControl.DriversCollection.Rows.RemoveAt(i);
                        }

                    }

                    taskControl.DriversCollection.AcceptChanges();
                }

                if (taskControl.DriversCollection.Rows.Count > 0)
                {
                    for (int i = 0; i < taskControl.DriversCollection.Rows.Count; i++)
                    {
                        if (int.Parse(taskControl.DriversCollection.Rows[i]["DriverDetailID"].ToString()) > MaxDriverDetailID)
                        {
                            MaxDriverDetailID = int.Parse(taskControl.DriversCollection.Rows[i]["DriverDetailID"].ToString());
                        }
                    }
                }

                DataTable dt = null;
                DataRow myRow = taskControl.DriversCollection.NewRow();

                //GetSurchargeAge("BirthDate");

                myRow["DriverDetailID"] = MaxDriverDetailID + 1; //taskControl.DriversCollection.Rows.Count + 1;
                myRow["TaskControlID"] = "0";
                myRow["DriverName"] = TxtDriverName.Text.Trim().ToUpper();
                myRow["DriverLastName"] = TxtDriverLastName.Text.Trim().ToUpper();
                myRow["DriverGender"] = ddlDriverGender.SelectedItem.Text.Trim();
                myRow["DriverMaritalStatus"] = ddlDriverMaritalStatus.SelectedItem.Text.Trim();
                myRow["DriverAge"] = TxtDriverAge.Text.Trim();
                myRow["DriverDateOfBirth"] = TxtDriverBirthDate.Text.Trim();
                myRow["TrafficViolationPoints"] = txtViolationPoints.Text.ToString().Trim();
                myRow["TrafficViolationSurcharge"] = txtViolationSurchargePct.Text.ToString().Trim();
                //myRow["UnderageSurcharge"] = txtUnderageChargesPct.Text.ToString().Trim();
                myRow["SumOfSurcharges"] = double.Parse(txtViolationSurchargePct.Text.ToString()) + double.Parse(txtUnderageChargesPct.Text.ToString());
                if (int.Parse(TxtDriverAge.Text.ToString()) == 17 || int.Parse(TxtDriverAge.Text.ToString()) == 16)
                {
                    //String.Format(CultureInfo.InvariantCulture,"{0:0.00}", double.Parse(TxtDriverGrade.Text));
                    myRow["GradePointAvg"] = TxtDriverGrade.Text.ToString().Trim();
                }
                else if (int.Parse(TxtAge.Text.ToString()) == 17 || int.Parse(TxtAge.Text.ToString()) == 16)
                {
                    myRow["GradePointAvg"] = TxtDriverGrade.Text.ToString().Trim();
                }
                else
                {
                    myRow["GradePointAvg"] = "0";
                }
                myRow["PrimaryDriver"] = false;

                GridDrivers.BorderColor = Color.Black;
                GridVehicle.BorderColor = Color.Black;

                taskControl.DriversCollection.Rows.Add(myRow);
                taskControl.DriversCollection.AcceptChanges();
                dt = taskControl.DriversCollection;

                this.BtnAddDriver.Text = "Add Driver";
                lblModifyDriver.Visible = false;
                TxtDriverName.Text = "";
                TxtDriverLastName.Text = "";
                TxtDriverAge.Text = "";
                ddlDriverGender.SelectedIndex = 0;
                ddlDriverMaritalStatus.SelectedIndex = 0;
                TxtDriverBirthDate.Text = "";
                chkUseClientInfo.Checked = false;
                txtViolationPoints.Text = "0";
                txtViolationSurchargePct.Text = "0";
                txtUnderageChargesPct.Text = "0";

                GetSurchargeAge();

                //bit for recalculate
                //taskControl.CustomerCollection = "1";

                //this.GridDrivers.CurrentPageIndex = 0;
                this.GridDrivers.Visible = true;
                this.GridDrivers.DataSource = dt;
                this.GridDrivers.DataBind();
                this.GridDrivers.Visible = true;

                GridDrivers.Columns[9].Visible = false; //trafic violation
                GridDrivers.Columns[10].Visible = false; //trafic surcharge
                GridDrivers.Columns[11].Visible = true; //UnderageSurcharge
                GridDrivers.Columns[12].Visible = true;// Sumofcharges
                GridDrivers.Columns[13].Visible = true;//Gradepointavg
                GridDrivers.Columns[14].Visible = true;//delete
                GridDrivers.Columns[15].Visible = false;//TaskControl
                GridDrivers.Columns[2].Visible = false;

                CalculatePremium();

                lblDriverGrade.Visible = false;
                TxtDriverGrade.Visible = false;

            }
            catch (Exception exp)
            {
                lblRecHeader.Text = exp.Message;
                mpeSeleccion.Show();
            }
        }

        private bool ValidateAdditionalDriver()
        {
            lblRecHeader.Text = "";

            if (TxtDriverAge.Text == "16" || TxtDriverAge.Text == "17")
            {
                if (TxtDriverGrade.Text.Trim().Any(char.IsLetter))
                {
                    lblRecHeader.Text = "Average Minor Grade Must be a Numeric Value.";
                    mpeSeleccion.Show();

                    //ddlVehicleUse.Focus();
                    return false;
                }
                else
                {
                    EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
                    if (double.Parse(TxtDriverGrade.Text.ToString()) <= 0)
                    {
                        lblRecHeader.Text = "Please add the Average Grade for the Minor.";
                        mpeSeleccion.Show();
                        //ddlVehicleUse.Focus();
                        return false;
                    }
                }
            }
            return true;
        }

        protected void BtnCancelDriver_Click(object sender, EventArgs e)
        {
            if (lblModifyDriver.Visible)
                GridDrivers.Columns[14].Visible = true;//delete
            this.BtnAddDriver.Text = "Add Driver";
            lblModifyDriver.Visible = false;
            TxtDriverName.Text = "";
            TxtDriverLastName.Text = "";
            ddlDriverGender.SelectedIndex = -1;
            ddlDriverMaritalStatus.SelectedIndex = -1;
            TxtDriverAge.Text = "";
            TxtDriverBirthDate.Text = "";
            TxtDriverGrade.Visible = false;
            lblDriverGrade.Visible = false;
            GridDrivers.BorderColor = Color.Black;
            TxtDriverID.Text = "";

        }

        protected void GridDrivers_RowCommand(object sender, GridViewCommandEventArgs e)
        {
            try
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                for (int i = 0; i < GridDrivers.Columns.Count - 1; i++)
                {
                    GridDrivers.Columns[i].Visible = true;
                }

                switch (e.CommandName)
                {
                    case "Select": //Edit
                        int index = Int32.Parse(e.CommandArgument.ToString());
                        GridViewRow row = GridDrivers.Rows[index];
                        GridDrivers.BorderColor = Color.Red;



                        if (row.Cells[3].Text.Trim() == TxtFirstName.Text.Trim().ToUpper() && row.Cells[4].Text.Trim() == TxtLastName.Text.Trim().ToUpper() && row.Cells[8].Text.Trim() == TxtBirthDate.Text)
                        {

                            GridDrivers.BorderColor = Color.Black;
                            lblRecHeader.Text = "Selected driver is the primary driver, to edit go to \"Client Information\" section!";
                            mpeSeleccion.Show();
                            GridDrivers.Columns[9].Visible = false; //trafic violation
                            GridDrivers.Columns[10].Visible = false; //trafic surcharge
                            GridDrivers.Columns[11].Visible = true; //UnderageSurcharge
                            GridDrivers.Columns[12].Visible = true;// Sumofcharges
                            GridDrivers.Columns[13].Visible = true;//Gradepointavg
                            GridDrivers.Columns[14].Visible = true;//delete
                            GridDrivers.Columns[15].Visible = false;//TaskControl
                            GridDrivers.Columns[2].Visible = false;

                            if (lblModifyDriver.Visible == true && TxtDriverName.Text != "")
                            {
                                BtnCancelDriver_Click("", e);
                                //TxtDriverName.Text = "";
                                //TxtDriverLastName.Text = "";
                            }

                            return;

                        }

                        this.BtnAddDriver.Text = "Save Driver";
                        lblModifyDriver.Visible = true;



                        TxtDriverName.Text = row.Cells[3].Text.Trim(); //GridDrivers.SelectedRow.Cells[1].Text.Trim();
                        TxtDriverLastName.Text = row.Cells[4].Text.Trim(); //GridDrivers.SelectedRow.Cells[1].Text.Trim();
                        ddlDriverGender.SelectedIndex = ddlDriverGender.Items.IndexOf(ddlDriverGender.Items.FindByText(row.Cells[5].Text.Trim()));
                        ddlDriverMaritalStatus.SelectedIndex = ddlDriverMaritalStatus.Items.IndexOf(ddlDriverMaritalStatus.Items.FindByText(row.Cells[6].Text.Trim()));

                        TxtDriverAge.Text = row.Cells[7].Text.Trim(); //GridDrivers.SelectedRow.Cells[4].Text.Trim();
                        TxtDriverBirthDate.Text = row.Cells[8].Text.Trim(); //GridDrivers.SelectedRow.Cells[5].Text.Trim();
                        txtViolationPoints.Text = row.Cells[9].Text.Trim();
                        txtViolationSurchargePct.Text = row.Cells[10].Text.Trim();
                        txtUnderageChargesPct.Text = row.Cells[11].Text.Trim();
                        TxtDriverGrade.Text = row.Cells[13].Text.Trim();

                        if (TxtDriverAge.Text == "17" || TxtDriverAge.Text == "16")
                        {
                            TxtDriverGrade.Visible = true;
                        }

                        if (txtViolationPoints.Text == "")
                            txtViolationPoints.Text = "0";

                        if (txtViolationSurchargePct.Text == "")
                            txtViolationSurchargePct.Text = "0";

                        if (txtUnderageChargesPct.Text == "")
                            txtUnderageChargesPct.Text = "0";

                        //TxtDriverID.Text = GridDrivers.SelectedIndex.ToString();

                        TxtDriverID.Text = taskControl.DriversCollection.Rows[index]["DriverDetailID"].ToString();
                        //TxtDriverID.Text = row.Cells[2].Text.Trim(); //GridDrivers.SelectedRow.Cells[7].Text;


                        GridDrivers.Columns[9].Visible = false; //trafic violation
                        GridDrivers.Columns[10].Visible = false; //trafic surcharge
                        GridDrivers.Columns[11].Visible = true; //UnderageSurcharge
                        GridDrivers.Columns[12].Visible = true;// Sumofcharges
                        GridDrivers.Columns[13].Visible = true;//Gradepointavg
                        GridDrivers.Columns[14].Visible = false;//delete
                        GridDrivers.Columns[15].Visible = false;//TaskControl
                        GridDrivers.Columns[2].Visible = false;


                        break;
                    case "Delete":

                        if (lblModifyDriver.Visible == true)
                        {
                            throw new Exception("Please save or cancel selected driver first.");
                        }
                        else
                        {
                            int indexd = Int32.Parse(e.CommandArgument.ToString());
                            if (GridDrivers.SelectedIndex == -1)
                            {
                                GridDrivers.SelectedIndex = 0;
                            }

                            DeleteDriverDetail(indexd);
                            //DeleteDriverDetail(e.CommandName.IndexOf("DriverDetailID"));

                            GridDrivers.Columns[9].Visible = false; //trafic violation
                            GridDrivers.Columns[10].Visible = false; //trafic surcharge
                            GridDrivers.Columns[11].Visible = true; //UnderageSurcharge
                            GridDrivers.Columns[12].Visible = true;// Sumofcharges
                            GridDrivers.Columns[13].Visible = true;//Gradepointavg
                            GridDrivers.Columns[14].Visible = true;//delete
                            GridDrivers.Columns[15].Visible = false;//TaskControl
                            GridDrivers.Columns[2].Visible = false;
                        }
                        break;
                    default: //Page
                        break;
                }

                //GridDrivers.Columns[9].Visible = false; //trafic violation
                //GridDrivers.Columns[10].Visible = false; //trafic surcharge
                //GridDrivers.Columns[11].Visible = true; //UnderageSurcharge
                //GridDrivers.Columns[12].Visible = true;// Sumofcharges
                //GridDrivers.Columns[13].Visible = true;//Gradepointavg
                //GridDrivers.Columns[14].Visible = true;//delete
                //GridDrivers.Columns[15].Visible = false;//TaskControl
                //GridDrivers.Columns[2].Visible = false;

            }
            catch (Exception exp)
            {
                lblRecHeader.Text = exp.Message;
                mpeSeleccion.Show();
            }
        }

        private void DeleteDriverDetail(int index)
        {
            try
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                DataTable dt = null;

                taskControl.DriversCollection.Rows.RemoveAt(index);
                taskControl.DriversCollection.AcceptChanges();
                dt = taskControl.DriversCollection;

                FillDriverDetailGrid();
            }
            catch (Exception xcp)
            {
                throw new Exception("Error deleting row.", xcp);
            }
        }

        private void FillDriverDetailGrid()
        {
            try
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                AddPrimaryDriver();

                GridDrivers.DataSource = null;
                DataTable dt = null;

                dt = taskControl.DriversCollection;

                for (int i = 0; i < GridDrivers.Columns.Count - 1; i++)
                {
                    GridDrivers.Columns[i].Visible = true;
                }

                if (dt != null)
                {
                    if (dt.Rows.Count != 0)
                    {
                        GridDrivers.DataSource = dt;
                        GridDrivers.DataBind();
                    }
                    else
                    {
                        GridDrivers.DataSource = null;
                        GridDrivers.DataBind();
                    }
                }
                else
                {
                    GridDrivers.DataSource = null;
                    GridDrivers.DataBind();
                }

                GridDrivers.Columns[9].Visible = false; //trafic violation
                GridDrivers.Columns[10].Visible = false; //trafic surcharge
                GridDrivers.Columns[11].Visible = true; //UnderageSurcharge
                GridDrivers.Columns[12].Visible = true;// Sumofcharges
                GridDrivers.Columns[13].Visible = true;//Gradepointavg
                GridDrivers.Columns[14].Visible = true;//delete
                GridDrivers.Columns[15].Visible = false;//TaskControl
                GridDrivers.Columns[2].Visible = false;

            }
            catch (Exception exp)
            {
                lblRecHeader.Text = exp.Message;
                mpeSeleccion.Show();
            }
        }

        private void FillDriverDetailGridToConvert(EPolicy.TaskControl.DoubleInterest taskControl)
        {
            try
            {
                AddPrimaryDriver();

                GridDrivers.DataSource = null;
                DataTable dt = null;

                dt = taskControl.DriversCollection;

                if (dt != null)
                {
                    if (dt.Rows.Count != 0)
                    {
                        GridDrivers.DataSource = dt;
                        GridDrivers.DataBind();
                    }
                    else
                    {
                        GridDrivers.DataSource = null;
                        GridDrivers.DataBind();
                    }
                }
                else
                {
                    GridDrivers.DataSource = null;
                    GridDrivers.DataBind();
                }
            }
            catch (Exception exp)
            {
                lblRecHeader.Text = exp.Message;
                mpeSeleccion.Show();
            }
        }

        protected void GridDrivers_RowDeleting(object sender, GridViewDeleteEventArgs e)
        {
            CalculatePremium();
        }

        #endregion

        #region Radio Buttons

        protected void radMotorcycle_SelectedIndexChanged(object sender, EventArgs e)
        {
            MotorCycleScooterSelectedIndexChanged();
            IsBusinessCheckedChanged();


            //ddlVehicleYear.Focus();
        }

        protected void radGenTons_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (radGenTons.SelectedValue == "Y")
            {
                radHeavyTruck.Visible = true;
                lblHeavyTruck.Visible = true;
            }
            else
            {
                radHeavyTruck.Visible = false;
                lblHeavyTruck.Visible = false;
                radHeavyTruck.SelectedIndex = 1;
            }
            ValidarCamposDisponiblesLiab();
            ValidarCamposDisponiblesPhysDam();
            //ShowPremiumOnTheFly(false);
        }

        //protected void radHeavyTruck_SelectedIndexChanged(object sender, EventArgs e)
        //{

        //}

        protected void radGenMedicalPayment_SelectedIndexChanged(object sender, EventArgs e)
        {
            string BI = "0.00";
            string PD = "0.00";
            string MP = "0.00";
            string Coll = "0.00";
            string Comp = "0.00";
            string Mot = "0.00";
            string Add = "0.00";
            string RentReim = "0.00";
            string TaxiLoss = "0.00";

            CalculateRates(ref BI, ref PD, ref MP, ref Coll, ref Comp, ref Mot, ref Add, ref RentReim, ref TaxiLoss, true);

            if (radGenMedicalPayment.SelectedItem.Text == "Yes")
            {
                txtMPLimit.Text = "$1,000/$5,000";


                txtTotalQuote.Text = (double.Parse(txtTotalQuote.Text) + double.Parse(MP)).ToString("##,###.00");
            }
            else
            {
                txtMPLimit.Text = "";

                txtTotalQuote.Text = (double.Parse(txtTotalQuote.Text) - double.Parse(MP)).ToString("##,###.00");
            }
            //ShowPremiumOnTheFly(false);
            //radADD.Focus();
        }

        protected void rdbAnyAccidentsYes_CheckedChanged(object sender, EventArgs e)
        {
            if (rdbAnyAccidentsYes.Checked)
            {
                ddlDiscounts.SelectedItem.Text = "N/A";
                ddlDiscounts.SelectedItem.Value = "N/A";
                //ddlDiscounts.Enabled = false;

                lblHowManyYears.Visible = false;
                rdb1Year.Visible = false;
                rdb2Year.Visible = false;
                rdb3Year.Visible = false;

                CalculatePremium();
            }
            else
            {
                //ddlDiscounts.Enabled = true;

                //JNF VISIBLE TRUE THIS ONLY********

                //lblHowManyYears.Visible = true;
                //rdb1Year.Visible = true;
                //rdb2Year.Visible = true;
                //rdb3Year.Visible = true;
            }
            //ShowPremiumOnTheFly(false);

        }

        protected void rdbAnyAccidentsNo_CheckedChanged(object sender, EventArgs e)
        {
            if (rdbAnyAccidentsNo.Checked)
            {
                //ddlDiscounts.Enabled = true;

                lblHowManyYears.Visible = true;
                rdb1Year.Visible = true;
                rdb2Year.Visible = true;
                rdb3Year.Visible = true;

                if (rdb1Year.Checked)
                {
                    ddlDiscounts.SelectedItem.Text = "10%";
                    ddlDiscounts.SelectedItem.Value = "10%";
                }
                else if (rdb2Year.Checked)
                {
                    ddlDiscounts.SelectedItem.Text = "20%";
                    ddlDiscounts.SelectedItem.Value = "20%";
                }
                else
                {
                    ddlDiscounts.SelectedItem.Text = "30%";
                    ddlDiscounts.SelectedItem.Value = "30%";
                }

                CalculatePremium();

            }
            else
            {
                lblHowManyYears.Visible = false;
                rdb1Year.Visible = false;
                rdb2Year.Visible = false;
                rdb3Year.Visible = false;
            }

        }

        protected void CalculateDiscount(string ACV, string Island)
        {
            bool LiabilityOnly = false;
            bool FullCoverage = false;


            if (ACV == "0" || ACV == "")
                LiabilityOnly = true;
            else
                FullCoverage = true;

            if (ACV == "" && Island == "")
            {
                if (rdbNewCustomerYes.Checked)
                {
                    rdbNewCustomerYes.Checked = true;
                    rdbNewCustomerNo.Checked = false;
                }
                else
                {
                    rdbNewCustomerYes.Checked = false;
                    rdbNewCustomerNo.Checked = true;
                }
            }

            if (LiabilityOnly)
            {
                if (rdbNewCustomerYes.Checked)
                {
                    ddlDiscounts.SelectedItem.Text = "10%";
                    ddlDiscounts.SelectedItem.Value = "10%";

                    CalculatePremium();
                }
                else
                {
                    CalculatePremium();
                }
            }

            if (FullCoverage)
            {
                if (rdbNewCustomerYes.Checked)
                {
                    rdbNewCustomerNo.Checked = false;


                    CalculatePremium();
                }
                else
                {
                    CalculatePremium();
                }
            }



        }

        protected void rdbNewCustomerYes_CheckedChanged(object sender, EventArgs e)
        {
            if (rdbNewCustomerYes.Checked)
            {
                rdbNewCustomerNo.Checked = false;
                //ddlDiscounts.SelectedItem.Text = "N/A";
                //ddlDiscounts.SelectedItem.Value = "N/A";

                //lblHowManyYears.Visible = false;
                //rdb1Year.Visible = false;
                //rdb2Year.Visible = false;
                //rdb3Year.Visible = false;

                CalculatePremium();
            }
            else
            {
                //rdbNewCustomerNo.Checked = false;
                //lblHowManyYears.Visible = true;
                //rdb1Year.Visible = true;
                //rdb2Year.Visible = true;
                //rdb3Year.Visible = true;
            }

        }

        protected void rdbNewCustomerNo_CheckedChanged(object sender, EventArgs e)
        {
            if (rdbNewCustomerNo.Checked)
            {
                rdbNewCustomerYes.Checked = false;
                //lblHowManyYears.Visible = true;
                //rdb1Year.Visible = true;
                //rdb2Year.Visible = true;
                //rdb3Year.Visible = true;

                //if (rdb1Year.Checked)
                //{
                //    ddlDiscounts.SelectedItem.Text = "10%";
                //    ddlDiscounts.SelectedItem.Value = "10%";
                //}
                //else if (rdb2Year.Checked)
                //{
                //    ddlDiscounts.SelectedItem.Text = "20%";
                //    ddlDiscounts.SelectedItem.Value = "20%";
                //}
                //else
                //{
                //    ddlDiscounts.SelectedItem.Text = "30%";
                //    ddlDiscounts.SelectedItem.Value = "30%";
                //}

                CalculatePremium();

            }
            else
            {
                //lblHowManyYears.Visible = false;
                //rdb1Year.Visible = false;
                //rdb2Year.Visible = false;
                //rdb3Year.Visible = false;
            }

        }

        protected void rdb1Year_CheckedChanged(object sender, EventArgs e)
        {
            ddlDiscounts.SelectedItem.Text = "10%";
            ddlDiscounts.SelectedItem.Value = "10%";
            CalculatePremium();
            //ShowPremiumOnTheFly(false);
        }

        protected void rdb2Year_CheckedChanged(object sender, EventArgs e)
        {
            ddlDiscounts.SelectedItem.Text = "20%";
            ddlDiscounts.SelectedItem.Value = "20%";
            CalculatePremium();
            //ShowPremiumOnTheFly(false);
        }

        protected void rdb3Year_CheckedChanged(object sender, EventArgs e)
        {
            ddlDiscounts.SelectedItem.Text = "30%";
            ddlDiscounts.SelectedItem.Value = "30%";
            CalculatePremium();
            //ShowPremiumOnTheFly(false);
        }

        protected void rdbAnyDriverNo_CheckedChanged(object sender, EventArgs e)
        {
            try
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                if (taskControl.DriversCollection.Rows.Count > 1)
                {
                    rdbAnyDriverYes.Checked = true;
                    rdbAnyDriverNo.Checked = false;
                    throw new Exception("Please remove additional drivers.");
                }

                HideDriverSection("false");
                // ("hidden");
                //rdbQ3No.Focus();
            }
            catch (Exception exp)
            {
                lblRecHeader.Text = exp.Message;
                mpeSeleccion.Show();
            }
        }

        protected void rdbAnyDriverYes_CheckedChanged(object sender, EventArgs e)
        {
            HideDriverSection("true");
            //rdbQ3No.Focus();
        }

        #endregion Radio Buttons

        #region CheckBox

        protected void chkUseClientInfo_CheckedChanged(object sender, EventArgs e)
        {
            if (chkUseClientInfo.Checked)
            {
                TxtDriverName.Text = TxtFirstName.Text.Trim() + " " + TxtInitial.Text.Trim() + " " + TxtLastName.Text.Trim();
                TxtDriverBirthDate.Text = TxtBirthDate.Text.Trim();
                TxtDriverAge.Text = TxtAge.Text.Trim();
                ddlDriverGender.SelectedItem.Text = ddlGender.SelectedItem.Text;
                ddlDriverMaritalStatus.SelectedItem.Text = ddlMaritalStatus.SelectedItem.Text;
                //GetSurchargeAge("BirthDate");

            }
            else
            {
                TxtDriverName.Text = "";
                TxtDriverBirthDate.Text = "";
                TxtDriverAge.Text = "";
            }

        }

        protected void chkIsBusinessAutoQuote_CheckedChanged(object sender, EventArgs e)
        {

            IsBusinessCheckedChanged();

            if (chkIsBusinessAutoQuote.Checked == true)
            {
                LblBirthDate.ForeColor = Color.Black;
                lblMarital.ForeColor = Color.Black;
                lblLicense.ForeColor = Color.Black;
                LblGender.ForeColor = Color.Black;
                LblFirstName.ForeColor = Color.Black;
                LblLastName.ForeColor = Color.Black;

                chkNamedInsured.Enabled = true;
                radMotorcycle.Enabled = true;

                //TxtLastName2.Enabled = true;

                if (chkNamedInsured.Checked)
                    chkNamedInsured.Checked = false;

            }
            else
            {
                LblBirthDate.ForeColor = Color.Red;
                lblMarital.ForeColor = Color.Red;
                lblLicense.ForeColor = Color.Red;
                LblGender.ForeColor = Color.Red;
                LblFirstName.ForeColor = Color.Red;
                LblLastName.ForeColor = Color.Red;

                chkNamedInsured.Enabled = false;
                TxtLastName2.Enabled = false;
                radMotorcycle.Enabled = false;

                if (radMotorcycle.SelectedItem.Text == "Yes")
                {
                    radMotorcycle.SelectedIndex = 1;
                }

                if (TxtLastName2.Text.ToString() != "")
                    TxtLastName2.Text = "";

                if (chkNamedInsured.Checked)
                    chkNamedInsured.Checked = false;



                if (radTaxiDriverloss.SelectedIndex == 0)
                    radTaxiDriverloss.SelectedIndex = 1;

                lblTaxiDriverloss.Visible = false;
                radTaxiDriverloss.Visible = false;

                //if (LblPassengersNo.Visible == true)
                LblPassengersNo.Visible = false;
                //if (TxtPassengerNo.Visible == true)
                TxtPassengerNo.Visible = false;

                if (TxtPassengerNo.Text != "0")
                    TxtPassengerNo.Text = "0";
            }
        }

        protected void IsBusinessCheckedChanged()
        {
            DataTable dtVehicleUseC = EPolicy.LookupTables.LookupTables.GetTable("VI_VehicleUseCommercial");
            DataTable dtVehicleUseP = EPolicy.LookupTables.LookupTables.GetTable("VI_VehicleUseNoCommercial");
            DataTable dtVehicleModel = EPolicy.LookupTables.LookupTables.GetTable("VehicleModel");
            DataTable dtVehicleMake = EPolicy.LookupTables.LookupTables.GetTable("VehicleMake");
            DataTable dtVehicleMakeMotorcycle = EPolicy.LookupTables.LookupTables.GetTable("VehicleMakeMotorcycle");

            if (chkIsBusinessAutoQuote.Checked && radMotorcycle.SelectedIndex != 0)
            {
                //VehicleUse
                ddlVehicleUse.DataSource = dtVehicleUseC;
                ddlVehicleUse.DataTextField = "VehicleUseDesc";
                ddlVehicleUse.DataValueField = "Code";
                ddlVehicleUse.DataBind();
                ddlVehicleUse.SelectedIndex = -1;
                ddlVehicleUse.Items.Insert(0, "");

                //VehicleMake
                ddlVehicleMake.DataSource = dtVehicleMake;
                ddlVehicleMake.DataTextField = "vehicleMakeDesc";
                ddlVehicleMake.DataValueField = "vehicleMakeID";
                ddlVehicleMake.DataBind();
                ddlVehicleMake.SelectedIndex = -1;
                ddlVehicleMake.Items.Insert(0, "");

                //VehicleModel
                ddlVehicleModel.DataSource = dtVehicleModel;
                ddlVehicleModel.DataTextField = "VehicleModelDesc";
                ddlVehicleModel.DataValueField = "VehicleModelID";
                ddlVehicleModel.DataBind();
                ddlVehicleModel.SelectedIndex = -1;
                ddlVehicleModel.Items.Insert(0, "");

                radGenTons.Visible = false;
                Label23.Visible = false;
                radHeavyTruck.Visible = false;
                lblHeavyTruck.Visible = false;
                TxtVehicleValue.Enabled = true;

                DefaultLimitValues();
            }
            else if (chkIsBusinessAutoQuote.Checked && radMotorcycle.SelectedIndex == 0)
            {
                //VehicleUse
                ddlVehicleUse.DataSource = dtVehicleUseC;
                ddlVehicleUse.DataTextField = "VehicleUseDesc";
                ddlVehicleUse.DataValueField = "Code";
                ddlVehicleUse.DataBind();
                ddlVehicleUse.SelectedIndex = -1;
                ddlVehicleUse.Items.Insert(0, "");
                ddlVehicleUse.Items.RemoveAt(1);
                ddlVehicleUse.Items.RemoveAt(2);
                ddlVehicleUse.Items.Insert(2, "Private");
                ddlVehicleUse.Items.FindByValue("Private").Value = "P";

                //VehicleMake
                ddlVehicleMake.DataSource = dtVehicleMakeMotorcycle;
                ddlVehicleMake.DataTextField = "vehicleMakeDesc";
                ddlVehicleMake.DataValueField = "vehicleMakeID";
                ddlVehicleMake.DataBind();
                ddlVehicleMake.SelectedIndex = -1;
                ddlVehicleMake.Items.Insert(0, "");

                //VehicleModel
                ddlVehicleModel.DataSource = dtVehicleModel;
                ddlVehicleModel.DataTextField = "VehicleModelDesc";
                ddlVehicleModel.DataValueField = "VehicleModelID";
                ddlVehicleModel.DataBind();
                ddlVehicleModel.SelectedIndex = -1;
                ddlVehicleModel.Items.Insert(0, "");

                radGenTons.Visible = false;
                Label23.Visible = false;
                radHeavyTruck.Visible = false;
                lblHeavyTruck.Visible = false;

                //if (!TxtVehicleValue.Enabled)
                TxtVehicleValue.Enabled = false;

                DefaultLimitValues();
            }
            else
            {
                //VehicleUse
                ddlVehicleUse.DataSource = dtVehicleUseP;
                ddlVehicleUse.DataTextField = "VehicleUseDesc";
                ddlVehicleUse.DataValueField = "Code";
                ddlVehicleUse.DataBind();
                ddlVehicleUse.SelectedIndex = -1;
                ddlVehicleUse.Items.Insert(0, "");
                ddlVehicleUse.SelectedItem.Value = "Private";

                //VehicleMake
                ddlVehicleMake.DataSource = dtVehicleMake;
                ddlVehicleMake.DataTextField = "vehicleMakeDesc";
                ddlVehicleMake.DataValueField = "vehicleMakeID";
                ddlVehicleMake.DataBind();
                ddlVehicleMake.SelectedIndex = -1;
                ddlVehicleMake.Items.Insert(0, "");

                //VehicleModel
                ddlVehicleModel.DataSource = dtVehicleModel;
                ddlVehicleModel.DataTextField = "VehicleModelDesc";
                ddlVehicleModel.DataValueField = "VehicleModelID";
                ddlVehicleModel.DataBind();
                ddlVehicleModel.SelectedIndex = -1;
                ddlVehicleModel.Items.Insert(0, "");

                radGenTons.Visible = false;
                Label23.Visible = false;
                radHeavyTruck.Visible = false;
                lblHeavyTruck.Visible = false;

                DefaultLimitValues();
            }
        }

        protected void chkNamedInsured_CheckedChanged(object sender, EventArgs e)
        {
            if (chkNamedInsured.Checked == true)
                TxtLastName2.Enabled = true;
            else
                TxtLastName2.Enabled = false;

            if (TxtLastName2.Text.ToString() != "")
                TxtLastName2.Text = "";
        }

        #endregion CheckBox

        // Motoras no entra a este calculo
        protected bool CalculateRates(ref string BI, ref string PD, ref string MP, ref string Coll, ref string Comp, ref string Mot, ref string Add, ref string RentReim, ref string TaxiLoss, bool Calc_MP)
        {
            bool rtValue = true;
            DataTable dt = null;
            DataTable dtPhsDam = null;

            try
            {


                if (ValidateBI())
                {

                    dt = GetLiabilityRates(ddlVehicleUse.SelectedItem.Value.ToString(), ddlIsland.SelectedItem.Value.ToString(), radGenTons.SelectedItem.Value.ToString(), radMotorcycle.SelectedItem.Value.ToString(), int.Parse(TxtPassengerNo.Text.ToString()), radHeavyTruck.SelectedItem.Value.ToString());

                    if (dt.Rows.Count > 0)
                    {

                        if (Calc_MP)
                        {
                            MP = dt.Rows[0]["MPRate"].ToString();
                        }
                        else
                        {
                            if (radGenMedicalPayment.SelectedItem.Text == "Yes")
                            {
                                MP = dt.Rows[0]["MPRate"].ToString();
                            }
                        }

                        PD = dt.Rows[0]["PDRate"].ToString();

                        if (TxtBILimitpp.Items.Count > 0)
                        {

                            if (TxtBILimitpp.SelectedItem.Value == "$10,000/$20,000")
                            {
                                BI = dt.Rows[0]["BIRates_10_20"].ToString();
                            }
                            else if (TxtBILimitpp.SelectedItem.Value == "$10,000/$25,000")
                            {
                                BI = dt.Rows[0]["BIRates_10_25"].ToString();

                            }
                            else
                                BI = dt.Rows[0]["BIRates_10_50"].ToString();
                        }
                    }

                    if (BI.ToString() == "")
                    {
                        lblRecHeader.Text = "Invalid BI Limit selected for the selected criteria.";
                        mpeSeleccion.Show();
                        return false;
                    }

                }
                else
                {
                    return false;
                }

                if (TxtVehicleValue.Text.ToString().Trim() == "")
                {
                    TxtVehicleValue.Text = "0";
                }

                if (ddlVehicleYear.SelectedItem.Text == "")
                {
                    ddlVehicleYear.SelectedItem.Text = System.DateTime.Today.Year.ToString();
                }

                dtPhsDam = GetPhysicalDamageRates(ddlVehicleUse.SelectedItem.Value.ToString(), ddlIsland.SelectedItem.Value.ToString(), int.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency), "N", int.Parse(ddlVehicleYear.SelectedItem.Text), int.Parse(TxtAge.Text.ToString()), int.Parse(TxtPassengerNo.Text.ToString()));

                if (dtPhsDam.Rows.Count > 0)
                {
                    if (ddlDedComp.SelectedItem.Value.ToString() == "$250" && ddlDedColl.SelectedItem.Value.ToString() == "$500")
                    {
                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                        {
                            Comp = (float.Parse(dtPhsDam.Rows[0]["Comp250_500"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                            Coll = (float.Parse(dtPhsDam.Rows[0]["Coll250_500"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                        }
                        else
                        {
                            Comp = dtPhsDam.Rows[0]["Comp250_500"].ToString();
                            Coll = dtPhsDam.Rows[0]["Coll250_500"].ToString();
                        }
                    }
                    else if (ddlDedComp.SelectedItem.Value.ToString() == "$500" && ddlDedColl.SelectedItem.Value.ToString() == "$500")
                    {
                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                        {
                            Comp = (float.Parse(dtPhsDam.Rows[0]["Comp500_500"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                            Coll = (float.Parse(dtPhsDam.Rows[0]["Coll500_500"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                        }
                        else
                        {
                            Comp = dtPhsDam.Rows[0]["Comp500_500"].ToString();
                            Coll = dtPhsDam.Rows[0]["Coll500_500"].ToString();
                        }

                    }
                    else if (ddlDedComp.SelectedItem.Value.ToString() == "$500" && ddlDedColl.SelectedItem.Value.ToString() == "$1,000")
                    {
                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                        {
                            Comp = (float.Parse(dtPhsDam.Rows[0]["Comp500_1000"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                            Coll = (float.Parse(dtPhsDam.Rows[0]["Coll500_1000"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                        }
                        else
                        {
                            Comp = dtPhsDam.Rows[0]["Comp500_1000"].ToString();
                            Coll = dtPhsDam.Rows[0]["Coll500_1000"].ToString();
                        }

                    }
                    else if (ddlDedComp.SelectedItem.Value.ToString() == "$1,000" && ddlDedColl.SelectedItem.Value.ToString() == "$1,000")
                    {
                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                        {
                            Comp = (float.Parse(dtPhsDam.Rows[0]["Comp1000_1000"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                            Coll = (float.Parse(dtPhsDam.Rows[0]["Coll1000_1000"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                        }
                        else
                        {
                            Comp = dtPhsDam.Rows[0]["Comp1000_1000"].ToString();
                            Coll = dtPhsDam.Rows[0]["Coll1000_1000"].ToString();
                        }
                    }
                    else if (ddlDedComp.SelectedItem.Value.ToString() == "$1,000" && ddlDedColl.SelectedItem.Value.ToString() == "$1,500")
                    {
                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                        {
                            Comp = (float.Parse(dtPhsDam.Rows[0]["Comp1000_1500"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                            Coll = (float.Parse(dtPhsDam.Rows[0]["Coll1000_1500"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                        }
                        else
                        {
                            Comp = dtPhsDam.Rows[0]["Comp1000_1500"].ToString();
                            Coll = dtPhsDam.Rows[0]["Coll1000_1500"].ToString();
                        }
                    }
                    else if (ddlDedComp.SelectedItem.Value.ToString() == "$1,000" && ddlDedColl.SelectedItem.Value.ToString() == "$2,500")
                    {
                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                        {
                            Comp = (float.Parse(dtPhsDam.Rows[0]["Comp1000_2500"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                            Coll = (float.Parse(dtPhsDam.Rows[0]["Coll1000_2500"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                        }
                        else
                        {
                            Comp = dtPhsDam.Rows[0]["Comp1000_2500"].ToString();
                            Coll = dtPhsDam.Rows[0]["Coll1000_2500"].ToString();
                        }
                    }
                    else if (ddlDedComp.SelectedItem.Value.ToString() == "$1,500" && ddlDedColl.SelectedItem.Value.ToString() == "$2,500")
                    {
                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                        {
                            Comp = (float.Parse(dtPhsDam.Rows[0]["Comp1500_2500"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                            Coll = (float.Parse(dtPhsDam.Rows[0]["Coll1500_2500"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                        }
                        else
                        {
                            Comp = dtPhsDam.Rows[0]["Comp1500_2500"].ToString();
                            Coll = dtPhsDam.Rows[0]["Coll1500_2500"].ToString();
                        }
                    }
                    else if (ddlDedComp.SelectedItem.Value.ToString() == "$2,500" && ddlDedColl.SelectedItem.Value.ToString() == "$5,000")
                    {
                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                        {
                            Comp = (float.Parse(dtPhsDam.Rows[0]["Comp2500_5000"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                            Coll = (float.Parse(dtPhsDam.Rows[0]["Coll2500_5000"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                        }
                        else
                        {
                            Comp = dtPhsDam.Rows[0]["Comp2500_5000"].ToString();
                            Coll = dtPhsDam.Rows[0]["Coll2500_5000"].ToString();
                        }
                    }
                }


                if (dt.Rows.Count > 0 || dtPhsDam.Rows.Count > 0)
                {
                    if (radADD.SelectedItem.Value.ToString() == "Y")
                    {
                        Add = "25";
                        Session["ADD"] = "25";
                    }
                    else
                    {
                        Session["ADD"] = "0";
                    }

                    //UNINSURED MOTORIST
                    if (radGenMotoristCoverage.SelectedItem.Value.ToString() == "Y")
                    {
                        Mot = "80.00";
                        Session["MOT"] = "80";
                    }
                    else
                    {
                        Session["MOT"] = "0";
                    }

                    if (radRentalReimCov.SelectedItem.Value.ToString() == "Y")
                    {
                        RentReim = "75.00";
                        Session["REIM"] = "75";
                    }
                    else
                    {
                        Session["REIM"] = "0";
                    }

                    if (radTaxiDriverloss.SelectedItem.Value.ToString() == "Y")
                    {
                        TaxiLoss = "100.00";
                        Session["TAXILOSS"] = "100";
                    }
                    else
                    {
                        Session["TAXILOSS"] = "0";
                    }
                }



                if (Comp.ToString().Trim() == "")
                    Comp = "0.00";

                if (Coll.ToString().Trim() == "")
                    Coll = "0.00";

                if (BI.ToString().Trim() == "")
                    BI = "0.00";

                if (PD.ToString().Trim() == "")
                    PD = "0.00";

                if (MP.ToString().Trim() == "" || radMotorcycle.SelectedItem.Value.ToString() == "Y")
                    MP = "0.00";

                if (Mot.ToString().Trim() == "")
                    Mot = "0.00";

                if (Add.ToString().Trim() == "")
                    Add = "0.00";

                if (RentReim.ToString().Trim() == "")
                    RentReim = "0.00";

                if (TaxiLoss.ToString().Trim() == "")
                    TaxiLoss = "0.00";

                //txtTotalPremiumVehicle.Text = double.Parse(txtTotalPremiumVehicle.Text.ToString()) + (double.Parse(Comp.ToString()) + double.Parse(Coll.ToString()) + double.Parse(BI.ToString()) + double.Parse(PD.ToString()) + double.Parse(MP.ToString()) + double.Parse(Mot.ToString()) + double.Parse(Add.ToString())).ToString();

                //txtBIRate.Text = double.Parse(txtBIRate.Text.ToString()).ToString() + double.Parse(String.Format("{0:c}", BI).ToString());
                //txtPDRate.Text = double.Parse(txtPDRate.Text.ToString()).ToString() + double.Parse(String.Format("{0:c}", PD).ToString());
                //txtMPRate.Text = double.Parse(txtMPRate.Text.ToString()).ToString() + double.Parse(String.Format("{0:c}", MP).ToString());
                //txtCollision.Text = double.Parse(txtCollision.Text.ToString()).ToString() + double.Parse(String.Format("{0:c}", Coll).ToString());
                //txtComp.Text = double.Parse(txtComp.Text.ToString()).ToString() + double.Parse(String.Format("{0:c}", Comp).ToString());
                //txtMotorist.Text = double.Parse(txtMotorist.Text.ToString()).ToString() + double.Parse(String.Format("{0:c}", Mot).ToString());
                //txtADD.Text = double.Parse(txtADD.Text.ToString()).ToString() + double.Parse(String.Format("{0:c}", Add).ToString());

                //txtTotalPremiumVehicle.Text = String.Format("{0:c}", txtTotalPremiumVehicle.Text);

            }
            catch (Exception exp)
            {
                lblRecHeader.Text = exp.Message;
                mpeSeleccion.Show();
                return false;
            }

            return rtValue;

        }


        private void FillModelDDList()
        {

            if (ddlVehicleMake.Items[ddlVehicleMake.SelectedIndex].Text != "")
            {
                int makeID = Int32.Parse(ddlVehicleMake.SelectedItem.Value.ToString());

                DataTable dtModel;
                dtModel = EPolicy.LookupTables.LookupTables.GetTable("VehicleModel");

                DataTable dt = dtModel.Clone();
                DataRow[] DrModel = dtModel.Select("VehicleMakeID = " + makeID, "VehicleModelDesc");

                for (int i = 0; i <= DrModel.Length - 1; i++)
                {
                    DataRow myRow = dt.NewRow();
                    myRow["VehicleModelID"] = (int)DrModel[i].ItemArray[0];
                    myRow["VehicleMakeID"] = (int)DrModel[i].ItemArray[1];
                    myRow["VehicleModelDesc"] = DrModel[i].ItemArray[2].ToString();

                    dt.Rows.Add(myRow);
                    dt.AcceptChanges();
                }

                ddlVehicleModel.Items.Clear();

                ddlVehicleModel.DataSource = dt;
                ddlVehicleModel.DataTextField = "VehicleModelDesc";
                ddlVehicleModel.DataValueField = "VehicleModelID";
                ddlVehicleModel.DataBind();
                ddlVehicleModel.Items.Insert(0, "");
                ddlVehicleModel.SelectedIndex = -1;
            }
            else
            {
                DataTable dtModel;
                dtModel = EPolicy.LookupTables.LookupTables.GetTable("VehicleModel");

                ddlVehicleModel.DataSource = dtModel;
                ddlVehicleModel.DataTextField = "VehicleModelDesc";
                ddlVehicleModel.DataValueField = "VehicleModelID";
                ddlVehicleModel.DataBind();
                ddlVehicleModel.Items.Insert(0, "");
                ddlVehicleModel.SelectedIndex = -1;
            }
        }

        protected void MotorCycleScooterSelectedIndexChanged()
        {
            if (radMotorcycle.SelectedIndex == 0)
            {
                txtMPLimit.Text = "";
                radGenMedicalPayment.SelectedIndex = 1;
                //TxtVehicleValue.Text = "0"; aqui
                TxtVehicleValue.Enabled = false;
                lblRentalReim.Visible = false;
                radRentalReimCov.Visible = false;
                radRentalReimCov.SelectedIndex = 1;

                radGenMedicalPayment.Enabled = false;
            }
            else
            {
                //txtMPLimit.Text = "$1,000/$5,000";
                //radGenMedicalPayment.SelectedIndex = 0;
                if (!BtnRePrintApp.Visible)
                {
                    TxtVehicleValue.Enabled = true;
                }
                TxtBirthDate_TextChanged(String.Empty, EventArgs.Empty);
                radGenMedicalPayment.Enabled = true;

            }

            ValidarMedicalPaymentsLiab();
            ValidarCamposDisponiblesLiab();
            ValidarCamposDisponiblesPhysDam();
        }

        protected void DefaultLimitValues()
        {
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            string IsMotorcycle = "";

            if (taskControl.VehicleCollection.Rows.Count > 0)
            {
                IsMotorcycle = taskControl.VehicleCollection.Rows[0]["IsMotorcycleScooter"] != System.DBNull.Value ? (string)taskControl.VehicleCollection.Rows[0]["IsMotorcycleScooter"].ToString() : "0";
            }

            ValidarCamposDisponiblesLiab();
            ValidarCamposDisponiblesPhysDam();

            ddlCompCollDed.Items.Add(new ListItem("$250/$500", "$250/$500"));

            if (IsMotorcycle == "True")
            {
                TxtBILimitpp.Items.Add(new ListItem("$10,000/$20,000", "$10,000/$20,000"));
            }
            else if (chkIsBusinessAutoQuote.Checked)
            {
                TxtBILimitpp.Items.Add(new ListItem("$10,000/$25,000", "$10,000/$25,000"));
            }
            else
            {
                TxtBILimitpp.Items.Add(new ListItem("$10,000/$20,000", "$10,000/$20,000"));
            }
        }

        protected void chkSameMailing_CheckedChanged(object sender, EventArgs e)
        {
            if (chkSameMailing.Checked)
            {
                txtPhyAddress.Text = TxtAddress.Text.ToUpper().Trim();
                txtPhyAddress2.Text = TxtAddress2.Text.ToUpper().Trim();
                txtPhyState.Text = TxtState.Text.ToUpper().Trim();
                txtPhyZipCode.Text = TxtZIPCode.Text.ToUpper().Trim();
                txtPhyCity.Text = TxtCity.Text.ToUpper().Trim();
            }
            if (!chkSameMailing.Checked)
            {
                txtPhyAddress.Text = "";
                txtPhyAddress2.Text = "";
                txtPhyZipCode.Text = "";
                //txtPhyState.Text = "";
                //txtPhyCity.Text = "";
            }
        }

        protected void SetCompCollDeductible()
        {
            if (ddlCompCollDed.Items.Count > 0)
            {
                if (ddlCompCollDed.SelectedItem.Value.ToString() == "$250/$500")
                {
                    ddlDedComp.SelectedItem.Value = "$250";
                    ddlDedColl.SelectedItem.Value = "$500";
                }

                if (ddlCompCollDed.SelectedItem.Value.ToString() == "$500/$500")
                {
                    ddlDedComp.SelectedItem.Value = "$500";
                    ddlDedColl.SelectedItem.Value = "$500";
                }

                if (ddlCompCollDed.SelectedItem.Value.ToString() == "$500/$1,000")
                {
                    ddlDedComp.SelectedItem.Value = "$500";
                    ddlDedColl.SelectedItem.Value = "$1,000";
                }

                if (ddlCompCollDed.SelectedItem.Value.ToString() == "$1,000/$1,000")
                {
                    ddlDedComp.SelectedItem.Value = "$1,000";
                    ddlDedColl.SelectedItem.Value = "$1,000";
                }

                if (ddlCompCollDed.SelectedItem.Value.ToString() == "$1,000/$1,500")
                {
                    ddlDedComp.SelectedItem.Value = "$1,000";
                    ddlDedColl.SelectedItem.Value = "$1,500";
                }

                if (ddlCompCollDed.SelectedItem.Value.ToString() == "$1,000/$2,500")
                {
                    ddlDedComp.SelectedItem.Value = "$1,000";
                    ddlDedColl.SelectedItem.Value = "$2,500";
                }

                if (ddlCompCollDed.SelectedItem.Value.ToString() == "$1,500/$2,500")
                {
                    ddlDedComp.SelectedItem.Value = "$1,500";
                    ddlDedColl.SelectedItem.Value = "$2,500";
                }

                if (ddlCompCollDed.SelectedItem.Value.ToString() == "$2,500/$5,000")
                {
                    ddlDedComp.SelectedItem.Value = "$2,500";
                    ddlDedColl.SelectedItem.Value = "$5,000";
                }
            }
            else
            {
                ddlDedComp.SelectedItem.Value = "0";
                ddlDedColl.SelectedItem.Value = "0";
            }

        }

        protected void GetTrafficViolationSurcharge()
        {
            try
            {
                DataTable dt = GetTrafficViolationFactor(int.Parse(txtViolationPoints.Text.ToString()));

                txtViolationSurchargePct.Text = "0";

                if (dt.Rows.Count > 0)
                {
                    txtViolationSurchargePct.Text = (float.Parse(dt.Rows[0]["SurchargeFactor"].ToString())).ToString();
                }

            }
            catch (Exception ex)
            {
                throw new Exception("Could not GetTrafficViolationSurcharge.", ex);
            }

        }

        protected void GetSurchargeAge2(string TextControl)
        {
            try
            {

                txtUnderageChargesPct.Text = "0";
                //EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];


                DataTable dt = null;
                if (TxtDriverAge.Text == "")
                {
                    TxtDriverAge.Text = "0";
                }
                if (TxtDriverGrade.Text == "")
                {
                    TxtDriverGrade.Text = "0";
                }

                if (int.Parse(TxtDriverAge.Text.ToString()) == 16 || int.Parse(TxtDriverAge.Text.ToString()) == 17)
                {
                    int GradePointAvg = 0;
                    string Gender = "M";

                    if (double.Parse(TxtDriverGrade.Text.ToString()) >= 3.0 && double.Parse(TxtDriverGrade.Text.ToString()) <= 3.4)
                    {
                        GradePointAvg = 3;
                    }
                    else if (double.Parse(TxtDriverGrade.Text.ToString()) >= 3.5 && double.Parse(TxtDriverGrade.Text.ToString()) <= 4)
                    {
                        GradePointAvg = 4;
                    }

                    if (ddlDriverGender.Text == "2")
                    {
                        Gender = "F";
                    }

                    else if (ddlDriverGender.Text == "1")
                    {
                        Gender = "M";
                    }


                    dt = GetSurchargeUnderAgeFactor(((int.Parse(TxtDriverAge.Text.ToString()))), GradePointAvg, Gender);

                    if (dt.Rows.Count > 0)
                    {
                        txtUnderageChargesPct.Text = (double.Parse(dt.Rows[0]["Surcharge"].ToString())).ToString();
                    }

                    //if (dt.Rows.Count > 0)
                    //{
                    //    if (GradePointAvg == 3)
                    //    {
                    //        txtUnderageChargesPct.Text = (float.Parse(dt.Rows[0]["UM_U_M"].ToString())).ToString();
                    //    }
                    //    else if (ddlMaritalStatus.SelectedItem.Text.Trim() == "Single" && ddlGender.SelectedItem.Text.Trim() == "Female")
                    //    {
                    //        txtUnderageChargesPct.Text = (float.Parse(dt.Rows[0]["UF_U_F"].ToString())).ToString();
                    //    }
                    //    else if (ddlMaritalStatus.SelectedItem.Text.Trim() == "Married" && ddlGender.SelectedItem.Text.Trim() == "Male")
                    //    {
                    //        txtUnderageChargesPct.Text = (float.Parse(dt.Rows[0]["MM_M_M"].ToString())).ToString();
                    //    }
                    //    else if (ddlMaritalStatus.SelectedItem.Text.Trim() == "Married" && ddlGender.SelectedItem.Text.Trim() == "Female")
                    //    {
                    //        txtUnderageChargesPct.Text = (float.Parse(dt.Rows[0]["MF_M_F"].ToString())).ToString();
                    //    }

                    //}

                }
                else
                {
                    dt = GetSurchargeAgeFactor(int.Parse(TxtDriverAge.Text.ToString()));

                    //for (int i = 0; i < taskControl.DriversCollection.Rows.Count; i++)
                    //{                                            



                    if (dt.Rows.Count > 0)
                    {
                        if (ddlMaritalStatus.SelectedItem.Text.Trim() == "Single" && ddlGender.SelectedItem.Text.Trim() == "Male")
                        {
                            txtUnderageChargesPct.Text = (float.Parse(dt.Rows[0]["UM_U_M"].ToString())).ToString();
                        }
                        else if (ddlMaritalStatus.SelectedItem.Text.Trim() == "Single" && ddlGender.SelectedItem.Text.Trim() == "Female")
                        {
                            txtUnderageChargesPct.Text = (float.Parse(dt.Rows[0]["UF_U_F"].ToString())).ToString();
                        }
                        else if (ddlMaritalStatus.SelectedItem.Text.Trim() == "Married" && ddlGender.SelectedItem.Text.Trim() == "Male")
                        {
                            txtUnderageChargesPct.Text = (float.Parse(dt.Rows[0]["MM_M_M"].ToString())).ToString();
                        }
                        else if (ddlMaritalStatus.SelectedItem.Text.Trim() == "Married" && ddlGender.SelectedItem.Text.Trim() == "Female")
                        {
                            txtUnderageChargesPct.Text = (float.Parse(dt.Rows[0]["MF_M_F"].ToString())).ToString();
                        }

                    }
                }
                //}

                if (TextControl == "Gender")
                {
                    //TxtAddress.Focus();
                }
                else if (TextControl == "Birthdate")
                {
                    //TxtWorkPhone.Focus();
                }
                else if (TextControl == "MaritalStatus")
                {
                    //TxtBirthDate.Focus();
                }
            }
            catch (Exception ex)
            {
                throw new Exception("Could not GetTrafficViolationSurcharge.", ex);
            }

        }

        protected void GetSurchargeAge()
        {
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
            DataTable dt = null;

            for (int i = 0; i < taskControl.DriversCollection.Rows.Count; i++)
            {
                double GradePointAvg = 0;
                int DriverAge = int.Parse(taskControl.DriversCollection.Rows[i]["DriverAge"].ToString());
                if (DriverAge == 17 || DriverAge == 16)
                {
                    GradePointAvg = double.Parse(taskControl.DriversCollection.Rows[i]["GradePointAvg"].ToString());
                }
                string DriverGender = taskControl.DriversCollection.Rows[i]["DriverGender"].ToString();
                string MaritalStatus = taskControl.DriversCollection.Rows[i]["DriverMaritalStatus"].ToString();
                double UnderageSurcharge = 0;
                string DGender = "";

                if (double.Parse(GradePointAvg.ToString().Trim()) >= 3.0 && double.Parse(GradePointAvg.ToString().Trim()) <= 3.4)
                {
                    GradePointAvg = 3;
                }
                else if (double.Parse(GradePointAvg.ToString().Trim()) >= 3.5 && double.Parse(GradePointAvg.ToString().Trim()) <= 4)
                {
                    GradePointAvg = 4;
                }
                else if (double.Parse(GradePointAvg.ToString().Trim()) >= 1.0 && double.Parse(GradePointAvg.ToString().Trim()) < 3.0)
                {
                    GradePointAvg = 3;
                }

                if (DriverGender.ToString().Trim().ToUpper() == "FEMALE")
                {
                    DGender = "F";
                }

                else if (DriverGender.ToString().Trim().ToUpper() == "MALE")
                {
                    DGender = "M";
                }

                if (DriverAge == 16 || DriverAge == 17)
                {
                    dt = GetSurchargeUnderAgeFactor(DriverAge, float.Parse(GradePointAvg.ToString()), DGender);

                    if (dt.Rows.Count > 0)
                    {
                        UnderageSurcharge = double.Parse(dt.Rows[0]["Surcharge"].ToString());
                    }

                }
                else if (DriverAge > 17 && DriverAge < 26)
                {
                    dt = GetSurchargeAgeFactor(DriverAge);

                    if (dt.Rows.Count > 0)
                    {
                        if (MaritalStatus.ToString().Trim() == "Single" && DriverGender.ToString().Trim() == "Male")
                        {
                            UnderageSurcharge = double.Parse(dt.Rows[0]["UM_U_M"].ToString());
                        }
                        else if (MaritalStatus.ToString().Trim() == "Single" && DriverGender.ToString().Trim() == "Female")
                        {
                            UnderageSurcharge = double.Parse(dt.Rows[0]["UF_U_F"].ToString());
                        }
                        else if (MaritalStatus.ToString().Trim() == "Married" && DriverGender.ToString().Trim() == "Male")
                        {
                            UnderageSurcharge = double.Parse(dt.Rows[0]["MM_M_M"].ToString());
                        }
                        else if (MaritalStatus.ToString().Trim() == "Married" && DriverGender.ToString().Trim() == "Female")
                        {
                            UnderageSurcharge = double.Parse(dt.Rows[0]["MF_M_F"].ToString());
                        }

                    }
                }
                taskControl.DriversCollection.Rows[i]["Underagesurcharge"] = UnderageSurcharge.ToString();
                taskControl.DriversCollection.AcceptChanges();
                UnderageSurcharge = 0;
            }


            double MaxUnderageSurcharge = 0;
            int DriverID = 0;

            for (int i = 0; i < taskControl.DriversCollection.Rows.Count; i++)
            {

                if (MaxUnderageSurcharge < double.Parse(taskControl.DriversCollection.Rows[i]["Underagesurcharge"].ToString()))
                {
                    MaxUnderageSurcharge = double.Parse(taskControl.DriversCollection.Rows[i]["Underagesurcharge"].ToString());
                    DriverID = int.Parse(taskControl.DriversCollection.Rows[i]["DriverDetailID"].ToString());
                }

                taskControl.DriversCollection.AcceptChanges();
            }

            for (int i = 0; i < taskControl.DriversCollection.Rows.Count; i++)
            {
                if (DriverID != int.Parse(taskControl.DriversCollection.Rows[i]["DriverDetailID"].ToString()))
                {
                    taskControl.DriversCollection.Rows[i]["Underagesurcharge"] = "0.0";
                    taskControl.DriversCollection.AcceptChanges();
                }
            }

            for (int i = 0; i < taskControl.DriversCollection.Rows.Count; i++)
            {
                taskControl.DriversCollection.Rows[i]["SumOfSurcharges"] = double.Parse(taskControl.DriversCollection.Rows[i]["Underagesurcharge"].ToString()) + double.Parse(taskControl.DriversCollection.Rows[i]["TrafficViolationSurcharge"].ToString());
                taskControl.DriversCollection.AcceptChanges();
            }

            if (ValidarDriverIsUnder26() && 1 == 0)
            {
                if (taskControl.RenewalNo == "")
                {
                    DataTable dtV = new DataTable();
                    if (taskControl.VehicleCollection != null)
                    {
                        dtV = taskControl.VehicleCollection;
                        for (int i = 0; i < dtV.Rows.Count; i++)
                        {
                            bool IsMotorcycle = false;

                            IsMotorcycle = bool.Parse(dtV.Rows[i]["IsMotorcycleScooter"].ToString()) == true ? true : false;

                            if ((dtV.Rows[i]["ComprehensiveDedu"].ToString().Trim().Replace("$", "") == "250" && dtV.Rows[i]["CollisionDedu"].ToString().Trim().Replace("$", "") == "500")
                                || (dtV.Rows[i]["ComprehensiveDedu"].ToString().Trim().Replace("$", "") == "500" && dtV.Rows[i]["CollisionDedu"].ToString().Trim().Replace("$", "") == "500"))
                            {
                                taskControl.VehicleCollection.Rows[i]["ComprehensiveDedu"] = "$500";
                                taskControl.VehicleCollection.Rows[i]["CollisionDedu"] = "$1,000";
                                taskControl.VehicleCollection.AcceptChanges();
                                Calculate_Comp_Coll_MINOR(i);
                                FillVehicleDetailGrid();


                                if (taskControl.isQuote)
                                {
                                    if (taskControl.TaskControlID != null)
                                        if (taskControl.TaskControlID != 0)
                                        {
                                            //UpdateComp_Coll_VI(taskControl.TaskControlID, taskControl.isQuote, "$500", "$1,000", int.Parse(dtV.Rows[i]["VehicleDetailID"].ToString().Trim()));
                                            //UpdateNetPremiumQuote_VI(taskControl.TaskControlID, IsMotorcycle, taskControl.RenewalNo, taskControl.CustomerCollection);
                                        }
                                }
                                else if (!taskControl.isQuote)
                                {
                                    if (taskControl.TaskControlID != null)
                                        if (taskControl.TaskControlID != 0)
                                        {
                                            //UpdateComp_Coll_VI(taskControl.TaskControlID, taskControl.isQuote, "$500", "$1,000", int.Parse(dtV.Rows[i]["VehicleDetailID"].ToString().Trim()));
                                            //UpdateNetPremiumPoliza_VI(taskControl.TaskControlID, IsMotorcycle, taskControl.RenewalNo, taskControl.CustomerCollection);
                                        }
                                }
                            }
                            else
                            {
                                Calculate_Comp_Coll_MINOR(i);
                            }
                        }
                    }
                }
            }

        }

        private void Calculate_Comp_Coll_MINOR(int i)
        {
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
            DataTable dtPhsDam = null;

            string Coll = "0.00", Comp = "0.00";

            if (taskControl.VehicleCollection.Rows.Count > 0)
            {
                string Island = taskControl.VehicleCollection.Rows[i]["Island"].ToString().Trim() == "St. Thomas" ? "1" : taskControl.VehicleCollection.Rows[i]["Island"].ToString().Trim() == "St. Croix" ? "2" : "3";
                string UseCode = taskControl.VehicleCollection.Rows[i]["VehicleUse"].ToString().Trim() == "Commercial" ? "C" : taskControl.VehicleCollection.Rows[i]["VehicleUse"].ToString().Trim() == "Private Passenger" ? "O" : taskControl.VehicleCollection.Rows[i]["VehicleUse"].ToString().Trim() == "Private" ? "P" : taskControl.VehicleCollection.Rows[i]["VehicleUse"].ToString().Trim() == "Rental" ? "R" : "T";

                //C	Commercial
                //O	Private Passenger
                //P	Private
                //R	Rental
                //T	Taxi
                int MostMinor = 0;

                for (int e = 0; e < taskControl.DriversCollection.Rows.Count; e++)
                {
                    MostMinor = int.Parse(taskControl.DriversCollection.Rows[0]["DriverAge"].ToString().Trim());
                    if (MostMinor > int.Parse(taskControl.DriversCollection.Rows[e]["DriverAge"].ToString().Trim()))
                    {
                        MostMinor = int.Parse(taskControl.DriversCollection.Rows[e]["DriverAge"].ToString().Trim());
                    }
                    else
                    {
                        MostMinor = int.Parse(taskControl.DriversCollection.Rows[0]["DriverAge"].ToString().Trim());
                    }
                }

                //dtPhsDam = GetPhysicalDamageRates(UseCode, Island, int.Parse(taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), "N", int.Parse(taskControl.VehicleCollection.Rows[i]["VehicleYear"].ToString().Trim()), int.Parse(taskControl.DriversCollection.Rows[0]["DriverAge"].ToString().Trim()), int.Parse(taskControl.VehicleCollection.Rows[i]["PassengersNo"].ToString().Trim()));

                dtPhsDam = GetPhysicalDamageRates(UseCode, Island, int.Parse(taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency), "N", int.Parse(taskControl.VehicleCollection.Rows[i]["VehicleYear"].ToString().Trim()), MostMinor, int.Parse(taskControl.VehicleCollection.Rows[i]["PassengersNo"].ToString().Trim()));

                if (dtPhsDam.Rows.Count > 0)
                {
                    if (taskControl.VehicleCollection.Rows[i]["ComprehensiveDedu"].ToString().Trim() == "$250" && taskControl.VehicleCollection.Rows[i]["CollisionDedu"].ToString().Trim() == "$500")
                    {
                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                        {
                            Comp = (float.Parse(dtPhsDam.Rows[0]["Comp250_500"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency)).ToString();
                            Coll = (float.Parse(dtPhsDam.Rows[0]["Coll250_500"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency)).ToString();
                        }
                        else
                        {
                            Comp = dtPhsDam.Rows[0]["Comp250_500"].ToString();
                            Coll = dtPhsDam.Rows[0]["Coll250_500"].ToString();
                        }
                    }
                    else if (taskControl.VehicleCollection.Rows[i]["ComprehensiveDedu"].ToString().Trim() == "$500" && taskControl.VehicleCollection.Rows[i]["CollisionDedu"].ToString().Trim() == "$500")
                    {
                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                        {
                            Comp = (float.Parse(dtPhsDam.Rows[0]["Comp500_500"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency)).ToString();
                            Coll = (float.Parse(dtPhsDam.Rows[0]["Coll500_500"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency)).ToString();
                        }
                        else
                        {
                            Comp = dtPhsDam.Rows[0]["Comp500_500"].ToString();
                            Coll = dtPhsDam.Rows[0]["Coll500_500"].ToString();
                        }

                    }
                    else if (taskControl.VehicleCollection.Rows[i]["ComprehensiveDedu"].ToString().Trim() == "$500" && taskControl.VehicleCollection.Rows[i]["CollisionDedu"].ToString().Trim() == "$1,000")
                    {
                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                        {
                            Comp = (float.Parse(dtPhsDam.Rows[0]["Comp500_1000"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency)).ToString();
                            Coll = (float.Parse(dtPhsDam.Rows[0]["Coll500_1000"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency)).ToString();
                        }
                        else
                        {
                            Comp = dtPhsDam.Rows[0]["Comp500_1000"].ToString();
                            Coll = dtPhsDam.Rows[0]["Coll500_1000"].ToString();
                        }

                    }
                    else if (taskControl.VehicleCollection.Rows[i]["ComprehensiveDedu"].ToString().Trim() == "$1,000" && taskControl.VehicleCollection.Rows[i]["CollisionDedu"].ToString().Trim() == "$1,000")
                    {
                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                        {
                            Comp = (float.Parse(dtPhsDam.Rows[0]["Comp1000_1000"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency)).ToString();
                            Coll = (float.Parse(dtPhsDam.Rows[0]["Coll1000_1000"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency)).ToString();
                        }
                        else
                        {
                            Comp = dtPhsDam.Rows[0]["Comp1000_1000"].ToString();
                            Coll = dtPhsDam.Rows[0]["Coll1000_1000"].ToString();
                        }
                    }
                    else if (taskControl.VehicleCollection.Rows[i]["ComprehensiveDedu"].ToString().Trim() == "$1,000" && taskControl.VehicleCollection.Rows[i]["CollisionDedu"].ToString().Trim() == "$1,500")
                    {
                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                        {
                            Comp = (float.Parse(dtPhsDam.Rows[0]["Comp1000_1500"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency)).ToString();
                            Coll = (float.Parse(dtPhsDam.Rows[0]["Coll1000_1500"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency)).ToString();
                        }
                        else
                        {
                            Comp = dtPhsDam.Rows[0]["Comp1000_1500"].ToString();
                            Coll = dtPhsDam.Rows[0]["Coll1000_1500"].ToString();
                        }
                    }
                    else if (taskControl.VehicleCollection.Rows[i]["ComprehensiveDedu"].ToString().Trim() == "$1,000" && taskControl.VehicleCollection.Rows[i]["CollisionDedu"].ToString().Trim() == "$2,500")
                    {
                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                        {
                            Comp = (float.Parse(dtPhsDam.Rows[0]["Comp1000_2500"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency)).ToString();
                            Coll = (float.Parse(dtPhsDam.Rows[0]["Coll1000_2500"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency)).ToString();
                        }
                        else
                        {
                            Comp = dtPhsDam.Rows[0]["Comp1000_2500"].ToString();
                            Coll = dtPhsDam.Rows[0]["Coll1000_2500"].ToString();
                        }
                    }
                    else if (taskControl.VehicleCollection.Rows[i]["ComprehensiveDedu"].ToString().Trim() == "$1,500" && taskControl.VehicleCollection.Rows[i]["CollisionDedu"].ToString().Trim() == "$2,500")
                    {
                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                        {
                            Comp = (float.Parse(dtPhsDam.Rows[0]["Comp1500_2500"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency)).ToString();
                            Coll = (float.Parse(dtPhsDam.Rows[0]["Coll1500_2500"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency)).ToString();
                        }
                        else
                        {
                            Comp = dtPhsDam.Rows[0]["Comp1500_2500"].ToString();
                            Coll = dtPhsDam.Rows[0]["Coll1500_2500"].ToString();
                        }
                    }
                    else if (taskControl.VehicleCollection.Rows[i]["ComprehensiveDedu"].ToString().Trim() == "$2,500" && taskControl.VehicleCollection.Rows[i]["CollisionDedu"].ToString().Trim() == "$5,000")
                    {
                        if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                        {
                            Comp = (float.Parse(dtPhsDam.Rows[0]["Comp2500_5000"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency)).ToString();
                            Coll = (float.Parse(dtPhsDam.Rows[0]["Coll2500_5000"].ToString()) * float.Parse(taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString().Trim(), System.Globalization.NumberStyles.Currency)).ToString();
                        }
                        else
                        {
                            Comp = dtPhsDam.Rows[0]["Comp2500_5000"].ToString();
                            Coll = dtPhsDam.Rows[0]["Coll2500_5000"].ToString();
                        }
                    }
                    taskControl.VehicleCollection.Rows[i]["CompPremium"] = Math.Round(double.Parse(Comp), 0).ToString(); //txtComp.Text.ToString().Trim();
                    taskControl.VehicleCollection.Rows[i]["CollPremium"] = Math.Round(double.Parse(Coll), 0).ToString(); //txtCollision.Text.ToString().Trim();
                    taskControl.VehicleCollection.AcceptChanges();
                }
            }
        }

        protected void GetTotalPremium()
        {
            string NetTotalPremium = "0.0";
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            if (RenewalNo != "" && taskControl.TaskControlID == 0)
            {
                if (RenewalPremium != "")
                {
                    //UpdateNetTotalPremiumRenewal(taskControl.TaskControlID, float.Parse(RenewalPremium));
                }
            }

            if (taskControl.TaskControlID != 0 && taskControl.TaskControlID.ToString() != "")
            {
                DataTable dt = null;

                dt = GetNetTotalPremiumByTaskControlID(taskControl.TaskControlID);
                if (dt.Rows.Count > 0)
                {
                    //When modifing Verifies premium claculated, if the premium is not equal or does not have 1 dollar less or 1 dollar more the total premium shwon will be the one calculated inside the application
                    if (double.Parse(dt.Rows[0]["XML_NetPremium"].ToString()).ToString("##,###.00") != "0")
                    {
                        txtTotalQuote.Text = double.Parse(dt.Rows[0]["XML_NetPremium"].ToString()).ToString("##,###.00");
                        double GrossTax = 0, TotalQuote = 0;

                        double.TryParse(txtTotalQuote.Text,
                           System.Globalization.NumberStyles.Number | System.Globalization.NumberStyles.AllowCurrencySymbol,
                           System.Globalization.CultureInfo.CreateSpecificCulture("en-US"),
                           out TotalQuote);

                        txtGrossTax.Text =
                            TotalQuote > 0.0 ?
                            (Math.Round(CalculateAgentCommision(ddlAgent.SelectedItem.Value, TotalQuote), 2)).ToString()
                            : "0";

                        double.TryParse(txtGrossTax.Text,
                            System.Globalization.NumberStyles.Number | System.Globalization.NumberStyles.AllowCurrencySymbol,
                            System.Globalization.CultureInfo.CreateSpecificCulture("en-US"),
                            out GrossTax);

                        if (taskControl.isQuote)
                            txtTotalQuote.Text = GrossTax > 0 ? (TotalQuote + GrossTax).ToString("##,###.00") : txtTotalQuote.Text;
                    }
                    else
                    {
                        txtTotalQuote.Text = double.Parse(txtGrandTotal.Text).ToString("##,###.00");
                    }
                }
                else
                {
                    txtTotalQuote.Text = double.Parse(txtGrandTotal.Text).ToString("##,###.00");
                }
            }
            else
            {
                txtTotalQuote.Text = double.Parse(txtGrandTotal.Text).ToString("##,###.00");
            }
        }

        #region Print

        protected void PrintPolicyPersonal(bool Attachment)
        {
            try
            {
                List<string> mergePaths = new List<string>();
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
                //EPolicy.TaskControl.QuoteAuto qa = (EPolicy.TaskControl.QuoteAuto)Session["TaskControl"];

                int taskControlID = taskControl.TaskControlID;

                int Copies = 3;
                for (int i = 0; i < Copies; i++)
                {
                    switch (i)
                    {
                        case 0:
                            mergePaths = ImprimirDecPagePersonal(mergePaths, taskControlID, "INSURED COPY");
                            break;
                        case 1:
                            mergePaths = ImprimirDecPagePersonal(mergePaths, taskControlID, "LOSS PAYEE COPY ");
                            break;
                        case 2:
                            mergePaths = ImprimirDecPagePersonal(mergePaths, taskControlID, "AGENT COPY");
                            break;
                    }

                }

                DateTime EffectiveDate = new DateTime(), ExpirationDate = new DateTime();

                EffectiveDate = DateTime.Parse(taskControl.EffectiveDate);
                ExpirationDate = DateTime.Parse(taskControl.EffectiveDate);

                //for (int i = 0; i < int.Parse(taskControl.Terms); i++)//taskControl.VehicleCollection.Rows.Count; i++)
                //{
                //    if (i == 0)
                //    {
                ExpirationDate = ExpirationDate.AddYears(1);
                //}
                //else
                //{
                //    EffectiveDate = EffectiveDate.AddYears(1);
                //    ExpirationDate = ExpirationDate.AddYears(1);
                //}
                mergePaths = ImprimirIDCards(mergePaths, taskControlID, int.Parse(taskControl.VehicleCollection.Rows[0]["VehicleDetailID"].ToString()), EffectiveDate.ToShortDateString(), ExpirationDate.ToShortDateString());
                //}

                //mergePaths = ImprimirDecPageComercialP4(mergePaths, taskControlID);

                #region ORDEN
                //PAPDECPG1
                //PAPDECPG2
                //LiabOnly
                //PAPQREF
                //A117
                //CanProc
                //Under26PG1
                //GIC20PG1
                //ADDPG2
                //E133PG1
                //GIC12-A4555
                //GIC17-GIC30
                //GIC21-GIC3
                //GIC23
                //GIC22
                //GICPrivacyPolicy
                #endregion ORDEN


                //Adding MEGRED PDF POLICY FILES

                if (Session["Endosos"].ToString().Trim() != "")
                {

                    if (Session["Endosos"].ToString().Contains("A117, GIC3, GIC17, GIC21, GIC30, PP03260886, Under26excl"))
                    {
                        #region LiabOnly (LIABILITY ONLY)
                        //if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "LiabOnlyCOPY" + ".pdf"))
                        //    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "LiabOnlyCOPY" + ".pdf");
                        //else
                        //{
                        File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "LiabOnly" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "LiabOnlyCOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "LiabOnlyCOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        //}
                        #endregion

                        #region PAPQREF (PERSONAL AUTO POLICY AGREEMENT)
                        //if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "PAPQREFCOPY" + ".pdf"))
                        //    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "PAPQREFCOPY" + ".pdf");
                        //else
                        //{
                        File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "PAPQREF" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "PAPQREFCOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "PAPQREFCOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        //}
                        #endregion

                        #region A117 (PERSONAL AUTO POLICY)
                        //if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "A117COPY" + ".pdf"))
                        //    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "A117COPY" + ".pdf");
                        //else
                        //{
                        File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "A117" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "A117COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "A117COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        //}
                        #endregion
                    }
                    else
                    {
                        #region PAPQREF (PERSONAL AUTO POLICY AGREEMENT)
                        //if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "PAPQREFCOPY" + ".pdf"))
                        //    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "PAPQREFCOPY" + ".pdf");
                        //else
                        //{
                        File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "PAPQREF" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "PAPQREFCOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "PAPQREFCOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        //}
                        #endregion
                    }

                    #region CanProc (PROCEDURES FOR CANCELLATION)
                    //if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CanProcCOPY" + ".pdf"))
                    //    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CanProcCOPY" + ".pdf");
                    //else
                    //{
                    File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CanProc" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CanProcCOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CanProcCOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                    //}

                    #endregion

                    //Under26
                    if (taskControl.DriversCollection.Rows.Count > 0)//1426
                    {
                        if (taskControl.AnyDriverUnder26 != false)
                        {
                            mergePaths = ImprimirUnder26(mergePaths, taskControlID);
                        }
                        else if (Session["Endosos"].ToString().Contains("Under26excl"))
                        {
                            mergePaths = ImprimirUnder26(mergePaths, taskControlID);
                        }
                    }

                    if (Session["Endosos"].ToString().Contains("GIC12, A4555, GIC20, GIC25"))
                    {

                        mergePaths = ImprimirGIC20(mergePaths, taskControlID);
                    }

                    if (Session["Endosos"].ToString().Contains("UIP248"))
                    {
                        if (taskControl.DriversCollection.Rows.Count > 6)
                        {
                            mergePaths = ImprimirADD(mergePaths, taskControlID, "6");
                        }
                        else
                        {
                            mergePaths = ImprimirADD(mergePaths, taskControlID, "");
                        }
                    }

                    //mergePaths = ImprimirE133(mergePaths, taskControlID);

                    if (Session["Endosos"].ToString().Contains("GIC12, A4555, GIC20, GIC25"))
                    {

                        #region GIC12-A4555 (LIMITS OF LIABILITY)
                        //if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC12-A4555COPY" + ".pdf"))
                        //    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC12-A4555COPY" + ".pdf");
                        //else
                        //{
                        File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC12-A4555" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC12-A4555COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC12-A4555COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        //}
                        #endregion
                    }

                    if (Session["Endosos"].ToString().Contains("CA0001, GIC3, GIC17, GIC21, GIC30, PP03260886, Under26excl"))
                    {
                        #region GIC17-GIC30

                        File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC17-GIC30" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC17-GIC30COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC17-GIC30COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");

                        #endregion

                        #region GIC21-GIC3

                        File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC21-GIC3" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC21-GIC3COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC21-GIC3COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");

                        #endregion
                    }
                    else if (Session["Endosos"].ToString().Contains("A117, GIC3, GIC17, GIC21, GIC30, PP03260886, Under26excl"))
                    {
                        #region GIC17-GIC30

                        File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC17-GIC30" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC17-GIC30COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC17-GIC30COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");

                        #endregion

                        #region GIC21-GIC3

                        File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC21-GIC3" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC21-GIC3COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC21-GIC3COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");

                        #endregion
                    }

                    if (Session["Endosos"].ToString().Contains("GIC16"))
                    {

                    }

                    if (Session["Endosos"].ToString().Contains("GIC23"))
                    {
                        #region GIC23 (Taxi Loss Amount)

                        File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC23" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC23COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC23COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");

                        #endregion GIC23
                    }

                    if (Session["Endosos"].ToString().Contains("GIC22"))
                    {
                        #region GIC22 (Rental Reimbursement Coverage)
                        //if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC22COPY"+ DateTime.Now.ToString() + ".pdf"))
                        //    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC22COPY" + ".pdf");
                        //else
                        //{
                        File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC22" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC22COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC22COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        //}
                        #endregion GIC22
                    }

                    #region GICPrivacyPolicy

                    File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GICPrivacyPolicy" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GICPrivacyPolicyCOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GICPrivacyPolicyCOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");

                    #endregion
                }

                //mergePaths = ImprimirDecPagePersonal(mergePaths, taskControlID, "");//Impresion para el Broker

                string ProcessedPath = System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"];
                //Generar PDF
                OPTIMAIns.CreatePDFBatch mergeFinal = new OPTIMAIns.CreatePDFBatch();
                string FinalFile = "";
                FinalFile = mergeFinal.MergePDFFiles(mergePaths, ProcessedPath, taskControl.TaskControlID.ToString());

                //Process myProcess = new Process();
                //myProcess.StartInfo.FileName = ProcessedPath + FinalFile; //PDF path
                //myProcess.Start();
                if (Attachment)
                    TextBox1.Text = FinalFile;
                else
                    ScriptManager.RegisterStartupScript(this.Page, this.GetType(), "key", "window.open('ExportFiles/" + FinalFile + "','Reports','addressbar=no,status=1,menubar=0,scrollbars=1,resizable=1,copyhistory=no,width=900,height=700');", true);

            }
            catch (Exception exc)
            {
                LogError(exc);
                lblRecHeader.Text = exc.Message.Trim() + " - " + exc.InnerException.ToString();
                mpeSeleccion.Show();
            }

        }

        protected void PrintPolicyPersonalDeclaration()
        {
            try
            {
                List<string> mergePaths = new List<string>();
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                int taskControlID = taskControl.TaskControlID;

                mergePaths = ImprimirDecPagePersonal(mergePaths, taskControlID, "");

                DateTime EffectiveDate = new DateTime(), ExpirationDate = new DateTime();

                EffectiveDate = DateTime.Parse(taskControl.EffectiveDate);
                ExpirationDate = DateTime.Parse(taskControl.EffectiveDate);

                //for (int i = 0; i < int.Parse(taskControl.Terms); i++)//taskControl.VehicleCollection.Rows.Count; i++)
                //{
                //    if (i == 0)
                //    {
                ExpirationDate = ExpirationDate.AddYears(1);
                //}
                //else
                //{
                //    EffectiveDate = EffectiveDate.AddYears(1);
                //    ExpirationDate = ExpirationDate.AddYears(1);
                //}
                mergePaths = ImprimirIDCards(mergePaths, taskControlID, int.Parse(taskControl.VehicleCollection.Rows[0]["VehicleDetailID"].ToString()), EffectiveDate.ToShortDateString(), ExpirationDate.ToShortDateString());
                //}

                string ProcessedPath = System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"];
                //Generar PDF
                OPTIMAIns.CreatePDFBatch mergeFinal = new OPTIMAIns.CreatePDFBatch();
                string FinalFile = "";
                FinalFile = mergeFinal.MergePDFFiles(mergePaths, ProcessedPath, taskControl.TaskControlID.ToString());

                //Process myProcess = new Process();
                //myProcess.StartInfo.FileName = ProcessedPath + FinalFile; //PDF path
                //myProcess.Start();

                ScriptManager.RegisterStartupScript(this.Page, this.GetType(), "key", "window.open('ExportFiles/" + FinalFile + "','Reports','addressbar=no,status=1,menubar=0,scrollbars=1,resizable=1,copyhistory=no,width=900,height=700');", true);

            }
            catch (Exception exc)
            {
                LogError(exc);
                lblRecHeader.Text = exc.Message.Trim() + " - " + exc.InnerException.ToString();
                mpeSeleccion.Show();
            }

        }

        protected void PrintIDCards()
        {
            List<string> mergePaths = new List<string>();
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            int taskControlID = taskControl.TaskControlID;

            DateTime EffectiveDate = new DateTime(), ExpirationDate = new DateTime();

            EffectiveDate = DateTime.Parse(taskControl.EffectiveDate);
            ExpirationDate = DateTime.Parse(taskControl.EffectiveDate);

            for (int i = 0; i < int.Parse(taskControl.Terms); i++)
            {
                if (i == 0)
                {
                    ExpirationDate = ExpirationDate.AddYears(1);
                }
                else
                {
                    EffectiveDate = EffectiveDate.AddYears(1);
                    ExpirationDate = ExpirationDate.AddYears(1);
                }
                mergePaths = ImprimirIDCards(mergePaths, taskControlID, int.Parse(taskControl.VehicleCollection.Rows[0]["VehicleDetailID"].ToString()), EffectiveDate.ToShortDateString(), ExpirationDate.ToShortDateString());
            }

            string ProcessedPath = System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"];
            //Generar PDF
            OPTIMAIns.CreatePDFBatch mergeFinal = new OPTIMAIns.CreatePDFBatch();
            string FinalFile = "";
            FinalFile = mergeFinal.MergePDFFiles(mergePaths, ProcessedPath, taskControl.TaskControlID.ToString());

            //if (Attachment)
            //    TextBox1.Text = FinalFile;
            //else
            ScriptManager.RegisterStartupScript(this.Page, this.GetType(), "key", "window.open('ExportFiles/" + FinalFile + "','Reports','addressbar=no,status=1,menubar=0,scrollbars=1,resizable=1,copyhistory=no,width=900,height=700');", true);

        }

        protected void PrintPolicyBusiness(bool Attachment)
        {
            try
            {
                List<string> mergePaths = new List<string>();
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
                //EPolicy.TaskControl.QuoteAuto qa = (EPolicy.TaskControl.QuoteAuto)Session["TaskControl"];

                int taskControlID = taskControl.TaskControlID;

                //for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                //{
                //    mergePaths = ImprimirDecPageComercial(mergePaths, taskControlID, int.Parse(taskControl.VehicleCollection.Rows[i]["VehicleDetailID"].ToString()));
                //}

                int Copies = 3;
                for (int i = 0; i < Copies; i++)
                {
                    switch (i)
                    {
                        case 0:
                            mergePaths = ImprimirDecPageComercial(mergePaths, taskControlID, "INSURED COPY");
                            break;
                        case 1:
                            mergePaths = ImprimirDecPageComercial(mergePaths, taskControlID, "LOSS PAYEE COPY ");
                            break;
                        case 2:
                            mergePaths = ImprimirDecPageComercial(mergePaths, taskControlID, "AGENT COPY");
                            break;
                    }

                }

                mergePaths = ImprimirDecPageComercialP2(mergePaths, taskControlID);
                mergePaths = ImprimirDecPageComercialP3(mergePaths, taskControlID);
                //mergePaths = ImprimirDecPageComercialP4(mergePaths, taskControlID);

                DateTime EffectiveDate = new DateTime(), ExpirationDate = new DateTime();

                EffectiveDate = DateTime.Parse(taskControl.EffectiveDate);
                ExpirationDate = DateTime.Parse(taskControl.EffectiveDate);

                //for (int i = 0; i < int.Parse(taskControl.Terms); i++)//taskControl.VehicleCollection.Rows.Count; i++)
                //{
                //    if (i == 0)
                //    {
                ExpirationDate = ExpirationDate.AddYears(1);
                //}
                //else
                //{
                //    EffectiveDate = EffectiveDate.AddYears(1);
                //    ExpirationDate = ExpirationDate.AddYears(1);
                //}
                mergePaths = ImprimirIDCards(mergePaths, taskControlID, int.Parse(taskControl.VehicleCollection.Rows[0]["VehicleDetailID"].ToString()), EffectiveDate.ToShortDateString(), ExpirationDate.ToShortDateString());
                //}



                #region ORDEN
                //BAPDECPG1
                //BAPITEMTWO
                //LiabOnly
                //CA0001D3-BAP
                //GIC18-GIC30
                //CanProc
                //Under26PG1
                //GIC20PG1
                //GIC16
                //CA583-AP328A
                //ADDPG2
                //E133PG1
                //E133PG2
                //GIC11-A4555
                //GIC21-GIC3
                //GIC23
                //GIC22
                //PP03260886B
                //CA2117
                //GICPrivacyPolicy
                //PAEPG1
                #endregion ORDEN


                //Adding MEGRED PDF POLICY FILES

                if (Session["Endosos"].ToString().Trim() != "")
                {

                    if (Session["Endosos"].ToString().Contains("CA0001, GIC3, GIC18, GIC21, GIC30, PP03260886"))
                    {
                        #region LiabOnly (LIABILITY ONLY)
                        //if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "LiabOnlyCOPY" + ".pdf"))
                        //    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "LiabOnlyCOPY" + ".pdf");
                        //else
                        //{
                        File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "LiabOnly" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "LiabOnlyCOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "LiabOnlyCOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        //}
                        #endregion

                        #region CA0001D3-BAP (BUSINESS AUTO POLICY AGREEMENT)
                        //if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "PAPQREFCOPY" + ".pdf"))
                        //    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "PAPQREFCOPY" + ".pdf");
                        //else
                        //{
                        File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CA0001D3-BAP" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CA0001D3-BAPCOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CA0001D3-BAPCOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        //}
                        #endregion

                    }
                    else
                    {
                        #region CA0001D3-BAP (BUSINESS AUTO POLICY AGREEMENT)
                        //if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "PAPQREFCOPY" + ".pdf"))
                        //    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "PAPQREFCOPY" + ".pdf");
                        //else
                        //{
                        File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CA0001D3-BAP" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CA0001D3-BAPCOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CA0001D3-BAPCOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        //}
                        #endregion
                    }

                    #region GIC18-GIC30
                    //if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "PAPQREFCOPY" + ".pdf"))
                    //    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "PAPQREFCOPY" + ".pdf");
                    //else
                    //{
                    File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC18-GIC30" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC18-GIC30COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC18-GIC30COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                    //}
                    #endregion

                    #region CanProc (PROCEDURES FOR CANCELLATION)
                    //if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CanProcCOPY" + ".pdf"))
                    //    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CanProcCOPY" + ".pdf");
                    //else
                    //{
                    File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CanProc" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CanProcCOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CanProcCOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                    //}

                    #endregion

                    //Under26
                    if (taskControl.DriversCollection.Rows.Count > 0)//1426
                    {
                        if (Session["VehicleUse"].ToString().Trim() != "Taxi")
                        {
                            if (taskControl.AnyDriverUnder26 != false)
                            {
                                mergePaths = ImprimirUnder26(mergePaths, taskControlID);
                            }
                            else if (Session["Endosos"].ToString().Contains("Under26excl"))
                            {
                                mergePaths = ImprimirUnder26(mergePaths, taskControlID);
                            }
                        }
                    }

                    //GIC20
                    if (Session["Endosos"].ToString().Contains("GIC11, A4555, GIC20, GIC24"))
                    {

                        mergePaths = ImprimirGIC20(mergePaths, taskControlID);
                    }

                    if (Session["Endosos"].ToString().Contains("GIC16"))
                    {
                        #region GIC16
                        //if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CanProcCOPY" + ".pdf"))
                        //    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CanProcCOPY" + ".pdf");
                        //else
                        //{
                        File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC16" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC16COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC16COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        //}

                        #endregion
                    }

                    if (Session["Endosos"].ToString().Contains("AP328A, CA583"))
                    {
                        #region CA583-AP328A
                        //if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CanProcCOPY" + ".pdf"))
                        //    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CanProcCOPY" + ".pdf");
                        //else
                        //{
                        File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CA583-AP328A" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CA583-AP328ACOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CA583-AP328ACOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        //}

                        #endregion
                    }

                    //ADD
                    if (Session["Endosos"].ToString().Contains("UIP248"))
                    {
                        if (taskControl.DriversCollection.Rows.Count > 6)
                        {
                            mergePaths = ImprimirADD(mergePaths, taskControlID, "6");
                        }
                        else
                        {
                            mergePaths = ImprimirADD(mergePaths, taskControlID, "");
                        }
                    }

                    if (Session["Endosos"].ToString().Contains("GIC11, A4555, GIC20, GIC24"))
                    {

                        #region GIC11-A4555 (LIMITS OF LIABILITY)
                        //if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC12-A4555COPY" + ".pdf"))
                        //    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC12-A4555COPY" + ".pdf");
                        //else
                        //{
                        File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC11-A4555" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC11-A4555COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC11-A4555COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        //}
                        #endregion
                    }

                    if (Session["Endosos"].ToString().Contains("CA0001, GIC3, GIC18, GIC21, GIC30, PP03260886"))
                    {
                        #region GIC21-GIC3

                        File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC21-GIC3" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC21-GIC3COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC21-GIC3COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");

                        #endregion
                    }

                    if (Session["Endosos"].ToString().Contains("GIC23"))
                    {
                        #region GIC23 (Taxi Loss Amount)

                        File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC23" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC23COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC23COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");

                        #endregion GIC23
                    }

                    if (Session["Endosos"].ToString().Contains("GIC22"))
                    {
                        #region GIC22 (Rental Reimbursement Coverage)
                        //if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC22COPY"+ DateTime.Now.ToString() + ".pdf"))
                        //    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC22COPY" + ".pdf");
                        //else
                        //{
                        File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC22" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC22COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GIC22COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        //}
                        #endregion GIC22
                    }

                    #region PP03260886B

                    File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "PP03260886B" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "PP03260886BCOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "PP03260886BCOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");

                    #endregion

                    if (Session["MotoristPremium"].ToString().Trim() != "")
                    {
                        #region CA2117

                        File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CA2117" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CA2117COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                        mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "CA2117COPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");

                        #endregion
                    }

                    //PAEPG1
                    if (Session["Island"].ToString().Trim() != "")
                    {
                        mergePaths = ImprimirPAEPG1(mergePaths, taskControlID);

                        //#region PAEPG1

                        //File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyyyPDF"] + "PAEPG1" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "PAEPG1COPY-" + taskControl.TaskControlID.ToString().Trim() + ".pdf");
                        //mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "PAEPG1COPY-" + taskControl.TaskControlID.ToString().Trim() + ".pdf");

                        //#endregion
                    }

                    #region GICPrivacyPolicy

                    File.Copy(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GICPrivacyPolicy" + ".pdf", System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GICPrivacyPolicyCOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");
                    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["PolicyPDF"] + "GICPrivacyPolicyCOPY-" + taskControl.TaskControlID.ToString().Trim() + "_" + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + ".pdf");

                    #endregion
                }

                mergePaths = ImprimirDecPageComercial(mergePaths, taskControlID, ""); //, int.Parse(taskControl.VehicleCollection.Rows[i]["VehicleDetailID"].ToString()));

                mergePaths = ImprimirDecPageComercialP2(mergePaths, taskControlID);
                mergePaths = ImprimirDecPageComercialP3(mergePaths, taskControlID);

                string ProcessedPath = System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"];
                //Generar PDF
                OPTIMAIns.CreatePDFBatch mergeFinal = new OPTIMAIns.CreatePDFBatch();
                string FinalFile = "";
                FinalFile = mergeFinal.MergePDFFiles(mergePaths, ProcessedPath, taskControl.TaskControlID.ToString());

                //Process myProcess = new Process();
                //myProcess.StartInfo.FileName = ProcessedPath + FinalFile; //PDF path
                //myProcess.Start();

                if (Attachment)
                    TextBox1.Text = FinalFile;
                else
                    ScriptManager.RegisterStartupScript(this.Page, this.GetType(), "key", "window.open('ExportFiles/" + FinalFile + "','Reports','addressbar=no,status=1,menubar=0,scrollbars=1,resizable=1,copyhistory=no,width=900,height=700');", true);

            }
            catch (Exception exc)
            {
                LogError(exc);
                lblRecHeader.Text = exc.Message.Trim() + " - " + exc.InnerException.ToString();
                mpeSeleccion.Show();
            }

        }

        protected void PrintPolicyBusinessDeclaration()
        {
            try
            {
                List<string> mergePaths = new List<string>();
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                int taskControlID = taskControl.TaskControlID;

                mergePaths = ImprimirDecPageComercial(mergePaths, taskControlID, "");

                mergePaths = ImprimirDecPageComercialP2(mergePaths, taskControlID);
                mergePaths = ImprimirDecPageComercialP3(mergePaths, taskControlID);

                DateTime EffectiveDate = new DateTime(), ExpirationDate = new DateTime();

                EffectiveDate = DateTime.Parse(taskControl.EffectiveDate);
                ExpirationDate = DateTime.Parse(taskControl.EffectiveDate);

                //for (int i = 0; i < int.Parse(taskControl.Terms); i++)//taskControl.VehicleCollection.Rows.Count; i++)
                //{
                //    if (i == 0)
                //    {
                ExpirationDate = ExpirationDate.AddYears(1);
                //}
                //else
                //{
                //EffectiveDate = EffectiveDate.AddYears(1);
                //ExpirationDate = ExpirationDate.AddYears(1);
                //}
                mergePaths = ImprimirIDCards(mergePaths, taskControlID, int.Parse(taskControl.VehicleCollection.Rows[0]["VehicleDetailID"].ToString()), EffectiveDate.ToShortDateString(), ExpirationDate.ToShortDateString());
                //}

                string ProcessedPath = System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"];
                //Generar PDF
                OPTIMAIns.CreatePDFBatch mergeFinal = new OPTIMAIns.CreatePDFBatch();
                string FinalFile = "";
                FinalFile = mergeFinal.MergePDFFiles(mergePaths, ProcessedPath, taskControl.TaskControlID.ToString());

                //Process myProcess = new Process();
                //myProcess.StartInfo.FileName = ProcessedPath + FinalFile; //PDF path
                //myProcess.Start();

                ScriptManager.RegisterStartupScript(this.Page, this.GetType(), "key", "window.open('ExportFiles/" + FinalFile + "','Reports','addressbar=no,status=1,menubar=0,scrollbars=1,resizable=1,copyhistory=no,width=900,height=700');", true);

            }
            catch (Exception exc)
            {
                LogError(exc);
                lblRecHeader.Text = exc.Message.Trim() + " - " + exc.InnerException.ToString();
                mpeSeleccion.Show();
            }

        }

        protected void PrintApplication(int _TaskControlID)
        {
            try
            {
                ScriptManager.RegisterStartupScript(this.Page, this.Page.GetType(), Guid.NewGuid().ToString(), "SetWaitCursor();", true);

                List<string> mergePaths = new List<string>();
                //EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
                //EPolicy.TaskControl.QuoteAuto qa = (EPolicy.TaskControl.QuoteAuto)Session["TaskControl"];




                mergePaths = ImprimirAppAndFormsP1(mergePaths, _TaskControlID);

                //mergePaths = ImprimirAppAndFormsP2(mergePaths, taskControlID);
                //mergePaths = ImprimirAppAndFormsP3(mergePaths, taskControlID);
                //mergePaths = WaiverOfCoverage(mergePaths, taskControlID);

                string ProcessedPath = System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"];
                //Generar PDF
                OPTIMAIns.CreatePDFBatch mergeFinal = new OPTIMAIns.CreatePDFBatch();
                string FinalFile = "";
                FinalFile = mergeFinal.MergePDFFiles(mergePaths, ProcessedPath, _TaskControlID.ToString());
                ScriptManager.RegisterStartupScript(this.Page, this.GetType(), "key", "window.open('ExportFiles/" + FinalFile + "','Reports','addressbar=no,status=1,menubar=0,scrollbars=1,resizable=1,copyhistory=no,width=900,height=700');", true);

                ScriptManager.RegisterStartupScript(this.Page, this.Page.GetType(), Guid.NewGuid().ToString(), "SetDefaultCursor();", true);


            }
            catch (Exception exc)
            {
                lblRecHeader.Text = exc.Message.Trim() + " - " + exc.InnerException.ToString();
                mpeSeleccion.Show();
            }

        }

        private List<string> ImprimirAppAndFormsP1(List<string> mergePaths, int taskControl)
        {
            try
            {

                string ProcessedPath = ConfigurationManager.AppSettings["ExportsFilesPathName"];

                int s = taskControl;

                GetReportAutoVehiclesInfods_VITableAdapters.GetReportAutoVehiclesInfo_VITableAdapter ds1 = new GetReportAutoVehiclesInfods_VITableAdapters.GetReportAutoVehiclesInfo_VITableAdapter();
                GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter ds2 = new GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter();
                GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter ds3 = new GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter();
                GetReportAutoDriversUnder26ds_VITableAdapters.GetReportAutoDriversInfoUnder26Years_VITableAdapter ds4 = new GetReportAutoDriversUnder26ds_VITableAdapters.GetReportAutoDriversInfoUnder26Years_VITableAdapter();
                GetReportNameInsuredTableAdapters.GetReportNameInsuredTableAdapter ds5 = new
                GetReportNameInsuredTableAdapters.GetReportNameInsuredTableAdapter();

                ReportDataSource rds1 = new ReportDataSource();
                ReportDataSource rds2 = new ReportDataSource();
                ReportDataSource rds3 = new ReportDataSource();
                ReportDataSource rds4 = new ReportDataSource();
                ReportDataSource rds5 = new ReportDataSource();


                rds1 = new ReportDataSource("GetReportAutoVehiclesInfo_VI", (DataTable)ds1.GetData(s));
                rds2 = new ReportDataSource("GetReportAutoGeneralInfo_VI", (DataTable)ds2.GetData(s));
                rds3 = new ReportDataSource("GetReportAutoDriversInfo_VI", (DataTable)ds3.GetData(s));
                rds4 = new ReportDataSource("GetReportAutoDriversUnder26_VI", (DataTable)ds4.GetData(s));
                rds5 = new ReportDataSource("GetReportNameInsured", (DataTable)ds5.GetData(s));


                EPolicy.TaskControl.DoubleInterest cs = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                EPolicy.Login.Login cp = HttpContext.Current.User as EPolicy.Login.Login;
                //int UserName = int.Parse(cp.Identity.Name.Split("|".ToCharArray())[1]);
                //Login.Login login = new Login.Login();


                DataTable dt = GetUsernameByUserID(cp.UserID);
                string dUserName = "";

                if (dt.Rows.Count > 0)
                {
                    dUserName = dt.Rows[0]["UserName"].ToString();
                }

                ReportParameter[] parameters = new ReportParameter[2];

                parameters[0] = new ReportParameter("CustomerName", cs.Customer.FirstName.Trim() + " " + cs.Customer.Initial.Trim() + " " + cs.Customer.LastName1.Trim() + " " + cs.Customer.LastName2.Trim());
                parameters[1] = new ReportParameter("UserName", dUserName.ToLower());

                ReportViewer viewer1 = new ReportViewer();
                viewer1.LocalReport.DataSources.Clear();
                viewer1.ProcessingMode = ProcessingMode.Local;
                viewer1.LocalReport.ReportPath = Server.MapPath("Reports/VI/PersonalAutoAplicationPackage-page1.rdlc");
                viewer1.LocalReport.SetParameters(parameters);
                viewer1.LocalReport.DataSources.Add(rds1);
                viewer1.LocalReport.DataSources.Add(rds2);
                viewer1.LocalReport.DataSources.Add(rds3);
                viewer1.LocalReport.DataSources.Add(rds4);
                viewer1.LocalReport.DataSources.Add(rds5);
                viewer1.LocalReport.Refresh();

                Warning[] warnings = null;
                string[] streamIds = null;
                string mimeType = string.Empty;
                string encoding = string.Empty;
                string extension = string.Empty;
                string filetype = string.Empty;


                string fileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-P1";
                string _FileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-P1" + ".pdf";

                if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1))
                    File.Delete(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);

                byte[] bytes1 = viewer1.LocalReport.Render("PDF", null, out mimeType, out encoding, out extension, out streamIds, out warnings);

                using (FileStream fs1 = new FileStream(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1, FileMode.Create))
                {
                    fs1.Write(bytes1, 0, bytes1.Length);
                    fs1.Close();
                }

                mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);
                return mergePaths;
            }
            catch (Exception ecp)
            {
                throw new Exception(ecp.Message.ToString());
            }
        }

        private List<string> ImprimirAppAndFormsP2(List<string> mergePaths, int taskControl)
        {
            try
            {
                string ProcessedPath = ConfigurationManager.AppSettings["ExportsFilesPathName"];

                int s = taskControl;

                GetReportAutoVehiclesInfods_VITableAdapters.GetReportAutoVehiclesInfo_VITableAdapter ds1 = new GetReportAutoVehiclesInfods_VITableAdapters.GetReportAutoVehiclesInfo_VITableAdapter();
                GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter ds2 = new GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter();
                GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter ds3 = new GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter();

                ReportDataSource rds1 = new ReportDataSource();
                ReportDataSource rds2 = new ReportDataSource();
                ReportDataSource rds3 = new ReportDataSource();


                rds1 = new ReportDataSource("GetReportAutoVehiclesInfo_VI", (DataTable)ds1.GetData(s));
                rds2 = new ReportDataSource("GetReportAutoGeneralInfo_VI", (DataTable)ds2.GetData(s));
                rds3 = new ReportDataSource("GetReportAutoDriversInfo_VI", (DataTable)ds3.GetData(s));

                ReportViewer viewer1 = new ReportViewer();
                viewer1.LocalReport.DataSources.Clear();
                viewer1.ProcessingMode = ProcessingMode.Local;
                viewer1.LocalReport.ReportPath = Server.MapPath("Reports/VI/PersonalAutoAplicationPackage-page2.rdlc");
                viewer1.LocalReport.DataSources.Add(rds1);
                viewer1.LocalReport.DataSources.Add(rds2);
                viewer1.LocalReport.DataSources.Add(rds3);
                viewer1.LocalReport.Refresh();

                Warning[] warnings = null;
                string[] streamIds = null;
                string mimeType = string.Empty;
                string encoding = string.Empty;
                string extension = string.Empty;
                string filetype = string.Empty;


                string fileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-P2";
                string _FileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-P2" + ".pdf";

                if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1))
                    File.Delete(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);

                byte[] bytes1 = viewer1.LocalReport.Render("PDF", null, out mimeType, out encoding, out extension, out streamIds, out warnings);

                using (FileStream fs1 = new FileStream(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1, FileMode.Create))
                {
                    fs1.Write(bytes1, 0, bytes1.Length);
                    fs1.Close();
                }

                mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);
                return mergePaths;
            }
            catch (Exception ecp)
            {
                throw new Exception(ecp.Message.ToString());
            }
        }

        private List<string> ImprimirAppAndFormsP3(List<string> mergePaths, int taskControl)
        {
            try
            {
                string ProcessedPath = ConfigurationManager.AppSettings["ExportsFilesPathName"];

                int s = taskControl;

                GetReportAutoVehiclesInfods_VITableAdapters.GetReportAutoVehiclesInfo_VITableAdapter ds1 = new GetReportAutoVehiclesInfods_VITableAdapters.GetReportAutoVehiclesInfo_VITableAdapter();
                GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter ds2 = new GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter();
                GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter ds3 = new GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter();

                ReportDataSource rds1 = new ReportDataSource();
                ReportDataSource rds2 = new ReportDataSource();
                ReportDataSource rds3 = new ReportDataSource();


                rds1 = new ReportDataSource("GetReportAutoVehiclesInfo_VI", (DataTable)ds1.GetData(s));
                rds2 = new ReportDataSource("GetReportAutoGeneralInfo_VI", (DataTable)ds2.GetData(s));
                rds3 = new ReportDataSource("GetReportAutoDriversInfo_VI", (DataTable)ds3.GetData(s));

                ReportViewer viewer1 = new ReportViewer();
                viewer1.LocalReport.DataSources.Clear();
                viewer1.ProcessingMode = ProcessingMode.Local;
                viewer1.LocalReport.ReportPath = Server.MapPath("Reports/VI/PersonalAutoAplicationPackage-page3.rdlc");
                viewer1.LocalReport.DataSources.Add(rds1);
                viewer1.LocalReport.DataSources.Add(rds2);
                viewer1.LocalReport.DataSources.Add(rds3);
                viewer1.LocalReport.Refresh();

                Warning[] warnings = null;
                string[] streamIds = null;
                string mimeType = string.Empty;
                string encoding = string.Empty;
                string extension = string.Empty;
                string filetype = string.Empty;


                string fileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-P3";
                string _FileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-P3" + ".pdf";

                if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1))
                    File.Delete(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);

                byte[] bytes1 = viewer1.LocalReport.Render("PDF", null, out mimeType, out encoding, out extension, out streamIds, out warnings);

                using (FileStream fs1 = new FileStream(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1, FileMode.Create))
                {
                    fs1.Write(bytes1, 0, bytes1.Length);
                    fs1.Close();
                }

                mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);
                return mergePaths;
            }
            catch (Exception ecp)
            {
                throw new Exception(ecp.Message.ToString());
            }
        }

        private List<string> WaiverOfCoverage(List<string> mergePaths, int taskControl)
        {
            try
            {
                string ProcessedPath = ConfigurationManager.AppSettings["ExportsFilesPathName"];

                int s = taskControl;

                GetReportAutoVehiclesInfods_VITableAdapters.GetReportAutoVehiclesInfo_VITableAdapter ds1 = new GetReportAutoVehiclesInfods_VITableAdapters.GetReportAutoVehiclesInfo_VITableAdapter();
                GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter ds2 = new GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter();
                GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter ds3 = new GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter();

                ReportDataSource rds1 = new ReportDataSource();
                ReportDataSource rds2 = new ReportDataSource();
                ReportDataSource rds3 = new ReportDataSource();


                rds1 = new ReportDataSource("GetReportAutoVehiclesInfo_VI", (DataTable)ds1.GetData(s));
                rds2 = new ReportDataSource("GetReportAutoGeneralInfo_VI", (DataTable)ds2.GetData(s));
                rds3 = new ReportDataSource("GetReportAutoDriversInfo_VI", (DataTable)ds3.GetData(s));

                ReportViewer viewer1 = new ReportViewer();
                viewer1.LocalReport.DataSources.Clear();
                viewer1.ProcessingMode = ProcessingMode.Local;
                viewer1.LocalReport.ReportPath = Server.MapPath("Reports/VI/WaiverOfCoverage.rdlc");
                viewer1.LocalReport.DataSources.Add(rds1);
                viewer1.LocalReport.DataSources.Add(rds2);
                viewer1.LocalReport.DataSources.Add(rds3);
                viewer1.LocalReport.Refresh();

                Warning[] warnings = null;
                string[] streamIds = null;
                string mimeType = string.Empty;
                string encoding = string.Empty;
                string extension = string.Empty;
                string filetype = string.Empty;


                string fileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-WC1";
                string _FileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-WC1" + ".pdf";

                if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1))
                    File.Delete(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);

                byte[] bytes1 = viewer1.LocalReport.Render("PDF", null, out mimeType, out encoding, out extension, out streamIds, out warnings);

                using (FileStream fs1 = new FileStream(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1, FileMode.Create))
                {
                    fs1.Write(bytes1, 0, bytes1.Length);
                    fs1.Close();
                }

                mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);
                return mergePaths;
            }
            catch (Exception ecp)
            {
                throw new Exception(ecp.Message.ToString());
            }
        }

        private List<string> ImprimirDecPagePersonal(List<string> mergePaths, int taskControl, string Copy)
        {
            try
            {
                EPolicy.Login.Login cp = HttpContext.Current.User as EPolicy.Login.Login;

                string ProcessedPath = ConfigurationManager.AppSettings["ExportsFilesPathName"];

                int s = taskControl;

                GetReportAutoVehiclesInfods_VITableAdapters.GetReportAutoVehiclesInfo_VITableAdapter ds1 = new GetReportAutoVehiclesInfods_VITableAdapters.GetReportAutoVehiclesInfo_VITableAdapter();
                GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter ds2 = new GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter();
                GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter ds3 = new GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter();
                GetReportNameInsuredTableAdapters.GetReportNameInsuredTableAdapter ds4 = new
                GetReportNameInsuredTableAdapters.GetReportNameInsuredTableAdapter();

                ReportDataSource rds1 = new ReportDataSource();
                ReportDataSource rds2 = new ReportDataSource();
                ReportDataSource rds3 = new ReportDataSource();
                ReportDataSource rds4 = new ReportDataSource();


                rds1 = new ReportDataSource("GetReportAutoVehiclesInfo_VI", (DataTable)ds1.GetData(s));
                rds2 = new ReportDataSource("GetReportAutoGeneralInfo_VI", (DataTable)ds2.GetData(s));
                rds3 = new ReportDataSource("GetReportAutoDriversInfo_VI", (DataTable)ds3.GetData(s));
                rds4 = new ReportDataSource("GetReportNameInsured", (DataTable)ds4.GetData(s));

                //Nuevo
                string Endosos = "";
                Session["Endosos"] = "";
                Session["MotoristPremium"] = "";

                ReportParameter[] parameters = new ReportParameter[3];

                EPolicy.TaskControl.DoubleInterest taskControl1 = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];


                DataTable dt = GetUsernameByUserID(cp.UserID);
                string dUserName = "";

                if (dt.Rows.Count > 0)
                {
                    dUserName = dt.Rows[0]["UserName"].ToString();
                }

                //Verifies the endorsements for each vehicle to add it in the dec page
                for (int i = 0; taskControl1.VehicleCollection.Rows.Count > i; i++)
                {
                    if (taskControl1.VehicleCollection.Rows[i]["MotoristPremium"].ToString() != "0")
                    {
                        Session["MotoristPremium"] = "80";
                    }

                    if (Endosos.Contains("Endorsements made part of this Policy at this time of issue : \r\n"))
                    {
                        Endosos += "";
                    }
                    else
                    {
                        Endosos += "Endorsements made part of this Policy at this time of issue : \r\n"; //+ Environment.NewLine;
                    }

                    if (taskControl1.VehicleCollection.Rows[i]["BIPremium"].ToString() != "0" && taskControl1.VehicleCollection.Rows[i]["IsMotorcycleScooter"].ToString() == "True")
                    {
                        if (Endosos.Contains("CA0001, GIC3, GIC17, GIC21, GIC30, PP03260886, Under26excl"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "Endorsements made part of this Policy at this time of issue : \r\n")
                                Endosos += ", CA0001, GIC3, GIC17, GIC21, GIC30, PP03260886, Under26excl";
                            else
                                Endosos += " CA0001, GIC3, GIC17, GIC21, GIC30, PP03260886, Under26excl";
                        }
                    }
                    else if (taskControl1.VehicleCollection.Rows[i]["BIPremium"].ToString() != "0") //&& taskControl1.VehicleCollection.Rows[i]["CollPremium"].ToString() == "0" && taskControl1.VehicleCollection.Rows[i]["CompPremium"].ToString() == "0") // liability only
                    {
                        if (Endosos.Contains("A117, GIC3, GIC17, GIC21, GIC30, PP03260886, Under26excl"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "Endorsements made part of this Policy at this time of issue : \r\n")
                                Endosos += ", A117, GIC3, GIC17, GIC21, GIC30, PP03260886, Under26excl";
                            else
                                Endosos += " A117, GIC3, GIC17, GIC21, GIC30, PP03260886, Under26excl";
                        }
                    }

                    if (taskControl1.VehicleCollection.Rows[i]["CollPremium"].ToString() != "0" && taskControl1.VehicleCollection.Rows[i]["CompPremium"].ToString() != "0")
                    {
                        if (Endosos.Contains("GIC12, A4555, GIC20, GIC25"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "Endorsements made part of this Policy at this time of issue : \r\n")
                                Endosos += ", GIC12, A4555, GIC20, GIC25";
                            else
                                Endosos += " GIC12, A4555, GIC20, GIC25";
                        }
                    }

                    if (taskControl1.VehicleCollection.Rows[i]["RentalReim"].ToString() != "0" && taskControl1.VehicleCollection.Rows[i]["VehicleUse"].ToString() == "Private")
                    {
                        if (Endosos.Contains("GIC22"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "Endorsements made part of this Policy at this time of issue : \r\n")
                                Endosos += ", GIC22";
                            else
                                Endosos += " GIC22";
                        }
                    }

                    if (taskControl1.VehicleCollection.Rows[i]["ADDPremium"].ToString() != "0" && (taskControl1.VehicleCollection.Rows[i]["VehicleUse"].ToString() == "Private" || taskControl1.VehicleCollection.Rows[i]["VehicleUse"].ToString() == "Commercial"))
                    {
                        if (Endosos.Contains("UIP248"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "Endorsements made part of this Policy at this time of issue : \r\n")
                                Endosos += ", UIP248";
                            else
                                Endosos += " UIP248";
                        }
                    }

                    if (taskControl1.VehicleCollection.Rows[i]["VehicleUse"].ToString() == "Rental")// && taskControl1.VehicleCollection.Rows[i]["IsMotorcycleScooter"].ToString() != "True")
                    {
                        if (Endosos.Contains("GIC16"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "Endorsements made part of this Policy at this time of issue : \r\n")
                                Endosos += ", GIC16";
                            else
                                Endosos += " GIC16";
                        }
                    }

                    if (taskControl1.VehicleCollection.Rows[i]["TaxiLossAmount"].ToString() != "0")
                    {
                        if (Endosos.Contains("GIC23"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "Endorsements made part of this Policy at this time of issue : \r\n")
                                Endosos += ", GIC23";
                            else
                                Endosos += " GIC23";
                        }

                        if (taskControl1.VehicleCollection.Rows[i]["Island"].ToString() == "St. Croix")
                        {
                            if (Endosos.Contains("VIPA"))
                            {
                                Endosos += "";
                            }
                            else
                            {
                                if (Endosos.ToString() != "FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n")
                                    Endosos += ", VIPA";
                                else
                                    Endosos += " VIPA";
                            }
                        }
                    }
                }

                Session["Endosos"] = Endosos;

                parameters[0] = new ReportParameter("Endosos", Endosos.ToString().Trim());

                parameters[1] = new ReportParameter("Username", dUserName.ToString().Trim());

                parameters[2] = new ReportParameter("Copy", Copy.ToString().Trim());

                //Nuevo

                ReportViewer viewer1 = new ReportViewer();
                viewer1.LocalReport.DataSources.Clear();
                viewer1.ProcessingMode = ProcessingMode.Local;
                viewer1.LocalReport.ReportPath = Server.MapPath("Reports/VI/DecPage-PAP256507.rdlc");
                viewer1.LocalReport.SetParameters(parameters);
                viewer1.LocalReport.DataSources.Add(rds1);
                viewer1.LocalReport.DataSources.Add(rds2);
                viewer1.LocalReport.DataSources.Add(rds3);
                viewer1.LocalReport.DataSources.Add(rds4);
                viewer1.LocalReport.Refresh();

                Warning[] warnings = null;
                string[] streamIds = null;
                string mimeType = string.Empty;
                string encoding = string.Empty;
                string extension = string.Empty;
                string filetype = string.Empty;

                Guid RandomString = Guid.NewGuid();

                string fileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "_" + RandomString.ToString() + "_" + "-PAP";
                string _FileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "_" + RandomString.ToString() + "_" + "-PAP" + ".pdf";

                if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1))
                    File.Delete(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);

                byte[] bytes1 = viewer1.LocalReport.Render("PDF", null, out mimeType, out encoding, out extension, out streamIds, out warnings);

                using (FileStream fs1 = new FileStream(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1, FileMode.Create))
                {
                    fs1.Write(bytes1, 0, bytes1.Length);
                    fs1.Close();
                }

                mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);
                return mergePaths;
            }
            catch (Exception ecp)
            {
                throw new Exception(ecp.Message.ToString());
            }
        }

        private List<string> ImprimirDecPageComercial(List<string> mergePaths, int taskControl, string Copy) //, int VehicleDetailID)
        {
            try
            {
                EPolicy.Login.Login cp = HttpContext.Current.User as EPolicy.Login.Login;

                string ProcessedPath = ConfigurationManager.AppSettings["ExportsFilesPathName"];

                int s = taskControl;

                GetReportAutoVehiclesInfods_VITableAdapters.GetReportAutoVehiclesInfo_VITableAdapter ds1 = new GetReportAutoVehiclesInfods_VITableAdapters.GetReportAutoVehiclesInfo_VITableAdapter();
                GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter ds2 = new GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter();
                GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter ds3 = new GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter();
                GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter ds4 = new GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter();
                GetReportNameInsuredTableAdapters.GetReportNameInsuredTableAdapter ds5 = new
                GetReportNameInsuredTableAdapters.GetReportNameInsuredTableAdapter();

                //ReportDataSource rds1 = new ReportDataSource();
                ReportDataSource rds2 = new ReportDataSource();
                // ReportDataSource rds3 = new ReportDataSource();
                ReportDataSource rds4 = new ReportDataSource();
                ReportDataSource rds5 = new ReportDataSource();

                //rds1 = new ReportDataSource("GetReportAutoVehiclesInfo_VI", (DataTable)ds1.GetData(s));
                rds2 = new ReportDataSource("GetReportAutoGeneralInfo_VI", (DataTable)ds2.GetData(s));
                //rds3 = new ReportDataSource("GetReportAutoDriversInfo_VI", (DataTable)ds3.GetData(s));
                rds4 = new ReportDataSource("GetReportAutoVehicleInfoPolicy_VI", (DataTable)ds4.GetData(s)); //, VehicleDetailID));
                rds5 = new ReportDataSource("GetReportNameInsured", (DataTable)ds5.GetData(s));

                //Nuevo JNF
                string Endosos = "";
                Session["Endosos"] = "";
                Session["Island"] = "";
                Session["VehicleUse"] = "";
                Session["MotoristPremium"] = "";

                ReportParameter[] parameters = new ReportParameter[3];

                EPolicy.TaskControl.DoubleInterest taskControl1 = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                DataTable dt = GetUsernameByUserID(cp.UserID);
                string dUserName = "";

                if (dt.Rows.Count > 0)
                {
                    dUserName = dt.Rows[0]["UserName"].ToString();
                }

                //Verifies the endorsements for each vehicle to add it in the dec page
                for (int i = 0; taskControl1.VehicleCollection.Rows.Count > i; i++)
                {
                    if (taskControl1.VehicleCollection.Rows[i]["Island"].ToString() != "")
                    {
                        if (taskControl1.VehicleCollection.Rows[i]["Island"].ToString().Trim() == "St. Croix")
                        {
                            Session["Island"] = "Croix";
                        }

                    }

                    if (taskControl1.VehicleCollection.Rows[i]["VehicleUse"].ToString() == "Taxi")
                    {
                        Session["VehicleUse"] = "Taxi";
                    }

                    if (taskControl1.VehicleCollection.Rows[i]["MotoristPremium"].ToString() != "0")
                    {
                        Session["MotoristPremium"] = "80";
                    }

                    if (Endosos.Contains("FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n"))
                    {
                        Endosos += "";
                    }
                    else
                    {
                        Endosos += "FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n"; //+ Environment.NewLine;
                    }

                    if (taskControl1.VehicleCollection.Rows[i]["BIPremium"].ToString() != "0" && taskControl1.VehicleCollection.Rows[i]["IsMotorcycleScooter"].ToString() == "True")
                    {
                        if (Endosos.Contains("CA0001, GIC3, GIC18, GIC21, GIC30, PP03260886"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n")
                                Endosos += ", CA0001, GIC3, GIC18, GIC21, GIC30, PP03260886";
                            else
                                Endosos += " CA0001, GIC3, GIC18, GIC21, GIC30, PP03260886";
                        }
                    }
                    else if (taskControl1.VehicleCollection.Rows[i]["BIPremium"].ToString() != "0") //&& taskControl1.VehicleCollection.Rows[i]["CollPremium"].ToString() == "0" && taskControl1.VehicleCollection.Rows[i]["CompPremium"].ToString() == "0") // liability only
                    {
                        if (Endosos.Contains("CA0001, GIC3, GIC18, GIC21, GIC30, PP03260886"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n")
                                Endosos += ", CA0001, GIC3, GIC18, GIC21, GIC30, PP03260886";
                            else
                                Endosos += " CA0001, GIC3, GIC18, GIC21, GIC30, PP03260886";
                        }
                    }

                    if (taskControl1.VehicleCollection.Rows[i]["CollPremium"].ToString() != "0" && taskControl1.VehicleCollection.Rows[i]["CompPremium"].ToString() != "0")
                    {
                        if (Endosos.Contains("GIC11, A4555, GIC20, GIC24"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n")
                                Endosos += ", GIC11, A4555, GIC20, GIC24";
                            else
                                Endosos += " GIC11, A4555, GIC20, GIC24";
                        }
                    }

                    if (taskControl1.VehicleCollection.Rows[i]["RentalReim"].ToString() != "0" && taskControl1.VehicleCollection.Rows[i]["VehicleUse"].ToString() == "Private")
                    {
                        if (Endosos.Contains("GIC22"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n")
                                Endosos += ", GIC22";
                            else
                                Endosos += " GIC22";
                        }
                    }

                    if (taskControl1.VehicleCollection.Rows[i]["ADDPremium"].ToString() != "0" && (taskControl1.VehicleCollection.Rows[i]["VehicleUse"].ToString() == "Private" || taskControl1.VehicleCollection.Rows[i]["VehicleUse"].ToString() == "Commercial"))
                    {
                        if (Endosos.Contains("UIP248"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n")
                                Endosos += ", UIP248";
                            else
                                Endosos += " UIP248";
                        }
                    }

                    if (taskControl1.VehicleCollection.Rows[i]["VehicleUse"].ToString() == "Rental")// && taskControl1.VehicleCollection.Rows[i]["IsMotorcycleScooter"].ToString() != "True")
                    {
                        if (Endosos.Contains("GIC16"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n")
                                Endosos += ", GIC16";
                            else
                                Endosos += " GIC16";
                        }
                    }

                    if (taskControl1.VehicleCollection.Rows[i]["TaxiLossAmount"].ToString() != "0")
                    {
                        if (Endosos.Contains("GIC23"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n")
                                Endosos += ", GIC23";
                            else
                                Endosos += " GIC23";
                        }

                        if (taskControl1.VehicleCollection.Rows[i]["Island"].ToString() == "St. Croix")
                        {
                            if (Endosos.Contains("VIPA"))
                            {
                                Endosos += "";
                            }
                            else
                            {
                                if (Endosos.ToString() != "FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n")
                                    Endosos += ", VIPA";
                                else
                                    Endosos += " VIPA";
                            }
                        }
                    }

                    if (taskControl1.VehicleCollection.Rows[i]["MPPremium"].ToString() != "0")
                    {
                        if (Endosos.Contains("AP328A, CA583"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n")
                                Endosos += ", AP328A, CA583";
                            else
                                Endosos += " AP328A, CA583";
                        }
                    }

                }

                Session["Endosos"] = Endosos;

                parameters[0] = new ReportParameter("Endosos", Endosos.ToString().Trim());

                parameters[1] = new ReportParameter("Username", dUserName.ToString().Trim());

                parameters[2] = new ReportParameter("Copy", Copy.ToString().Trim());

                //Nuevo JNF

                ReportViewer viewer1 = new ReportViewer();
                viewer1.LocalReport.DataSources.Clear();
                viewer1.ProcessingMode = ProcessingMode.Local;
                viewer1.LocalReport.ReportPath = Server.MapPath("Reports/VI/DecPage-BAP67077.rdlc");
                viewer1.LocalReport.SetParameters(parameters);
                //viewer1.LocalReport.DataSources.Add(rds1);
                viewer1.LocalReport.DataSources.Add(rds2);
                //viewer1.LocalReport.DataSources.Add(rds3);
                viewer1.LocalReport.DataSources.Add(rds4);
                viewer1.LocalReport.DataSources.Add(rds5);
                viewer1.LocalReport.Refresh();

                Warning[] warnings = null;
                string[] streamIds = null;
                string mimeType = string.Empty;
                string encoding = string.Empty;
                string extension = string.Empty;
                string filetype = string.Empty;

                Guid RandomString = Guid.NewGuid();

                string fileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "_" + RandomString.ToString() + "_" + "-Com1"; //+ "-" + VehicleDetailID.ToString().Trim() + "-Com1";
                string _FileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "_" + RandomString.ToString() + "_" + "-Com1" + ".pdf"; //+ "-" + VehicleDetailID.ToString().Trim() + "-Com1" + ".pdf";

                if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1))
                    File.Delete(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);

                byte[] bytes1 = viewer1.LocalReport.Render("PDF", null, out mimeType, out encoding, out extension, out streamIds, out warnings);

                using (FileStream fs1 = new FileStream(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1, FileMode.Create))
                {
                    fs1.Write(bytes1, 0, bytes1.Length);
                    fs1.Close();
                }

                mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);
                return mergePaths;
            }
            catch (Exception ecp)
            {
                throw new Exception(ecp.Message.ToString());
            }
        }

        private List<string> ImprimirDecPageComercialP2(List<string> mergePaths, int taskControl)
        {
            try
            {
                string ProcessedPath = ConfigurationManager.AppSettings["ExportsFilesPathName"];

                int s = taskControl;

                //GetReportAutoVehiclesInfods_VITableAdapters.GetReportAutoVehiclesInfo_VITableAdapter ds1 = new GetReportAutoVehiclesInfods_VITableAdapters.GetReportAutoVehiclesInfo_VITableAdapter();
                //GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter ds2 = new GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter();
                //GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter ds3 = new GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter();
                //GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter ds4 = new GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter();

                //ReportDataSource rds1 = new ReportDataSource();
                //ReportDataSource rds2 = new ReportDataSource();
                // ReportDataSource rds3 = new ReportDataSource();
                //ReportDataSource rds4 = new ReportDataSource();


                //rds1 = new ReportDataSource("GetReportAutoVehiclesInfo_VI", (DataTable)ds1.GetData(s));
                //rds2 = new ReportDataSource("GetReportAutoGeneralInfo_VI", (DataTable)ds2.GetData(s));
                //rds3 = new ReportDataSource("GetReportAutoDriversInfo_VI", (DataTable)ds3.GetData(s));
                //rds4 = new ReportDataSource("GetReportAutoVehicleInfoPolicy_VI", (DataTable)ds4.GetData(s, VehicleDetailID));

                ReportViewer viewer1 = new ReportViewer();
                viewer1.LocalReport.DataSources.Clear();
                viewer1.ProcessingMode = ProcessingMode.Local;
                viewer1.LocalReport.ReportPath = Server.MapPath("Reports/VI/DecPage-BAP67077page2.rdlc");
                //viewer1.LocalReport.DataSources.Add(rds1);
                //viewer1.LocalReport.DataSources.Add(rds2);
                //viewer1.LocalReport.DataSources.Add(rds3);
                //viewer1.LocalReport.DataSources.Add(rds4);
                viewer1.LocalReport.Refresh();

                Warning[] warnings = null;
                string[] streamIds = null;
                string mimeType = string.Empty;
                string encoding = string.Empty;
                string extension = string.Empty;
                string filetype = string.Empty;


                string fileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-Com2";
                string _FileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-Com2" + ".pdf";

                if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1))
                    File.Delete(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);

                byte[] bytes1 = viewer1.LocalReport.Render("PDF", null, out mimeType, out encoding, out extension, out streamIds, out warnings);

                using (FileStream fs1 = new FileStream(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1, FileMode.Create))
                {
                    fs1.Write(bytes1, 0, bytes1.Length);
                    fs1.Close();
                }

                mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);
                return mergePaths;
            }
            catch (Exception ecp)
            {
                throw new Exception(ecp.Message.ToString());
            }
        }

        private List<string> ImprimirDecPageComercialP3(List<string> mergePaths, int taskControl)
        {
            try
            {
                string ProcessedPath = ConfigurationManager.AppSettings["ExportsFilesPathName"];

                int s = taskControl;

                GetReportAutoVehiclesInfods_VITableAdapters.GetReportAutoVehiclesInfo_VITableAdapter ds1 = new GetReportAutoVehiclesInfods_VITableAdapters.GetReportAutoVehiclesInfo_VITableAdapter();
                GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter ds2 = new GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter();
                //GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter ds3 = new GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter();
                //GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter ds4 = new GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter();

                ReportDataSource rds1 = new ReportDataSource();
                ReportDataSource rds2 = new ReportDataSource();
                // ReportDataSource rds3 = new ReportDataSource();
                //ReportDataSource rds4 = new ReportDataSource();


                rds1 = new ReportDataSource("GetReportAutoVehiclesInfo_VI", (DataTable)ds1.GetData(s));
                rds2 = new ReportDataSource("GetReportAutoGeneralInfo_VI", (DataTable)ds2.GetData(s));
                //rds3 = new ReportDataSource("GetReportAutoDriversInfo_VI", (DataTable)ds3.GetData(s));
                //rds4 = new ReportDataSource("GetReportAutoVehicleInfoPolicy_VI", (DataTable)ds4.GetData(s, VehicleDetailID));

                //Nuevo JNF

                string Endosos = "";

                ReportParameter[] parameters = new ReportParameter[1];

                EPolicy.TaskControl.DoubleInterest taskControl1 = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];


                //Verifies the endorsements for each vehicle to add it in the dec page
                for (int i = 0; taskControl1.VehicleCollection.Rows.Count > i; i++)
                {
                    if (Endosos.Contains("FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n"))
                    {
                        Endosos += "";
                    }
                    else
                    {
                        Endosos += "FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n"; //+ Environment.NewLine;
                    }

                    if (taskControl1.VehicleCollection.Rows[i]["BIPremium"].ToString() != "0" && taskControl1.VehicleCollection.Rows[i]["IsMotorcycleScooter"].ToString() == "True")
                    {
                        if (Endosos.Contains("CA0001, GIC3, GIC18, GIC21, GIC30, PP03260886"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n")
                                Endosos += ", CA0001, GIC3, GIC18, GIC21, GIC30, PP03260886";
                            else
                                Endosos += " CA0001, GIC3, GIC18, GIC21, GIC30, PP03260886";
                        }
                    }
                    else if (taskControl1.VehicleCollection.Rows[i]["BIPremium"].ToString() != "0") //&& taskControl1.VehicleCollection.Rows[i]["CollPremium"].ToString() == "0" && taskControl1.VehicleCollection.Rows[i]["CompPremium"].ToString() == "0") // liability only
                    {
                        if (Endosos.Contains("CA0001, GIC3, GIC18, GIC21, GIC30, PP03260886"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n")
                                Endosos += ", CA0001, GIC3, GIC18, GIC21, GIC30, PP03260886";
                            else
                                Endosos += " CA0001, GIC3, GIC18, GIC21, GIC30, PP03260886";
                        }
                    }

                    if (taskControl1.VehicleCollection.Rows[i]["CollPremium"].ToString() != "0" && taskControl1.VehicleCollection.Rows[i]["CompPremium"].ToString() != "0")
                    {
                        if (Endosos.Contains("GIC11, A4555, GIC20, GIC24"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n")
                                Endosos += ", GIC11, A4555, GIC20, GIC24";
                            else
                                Endosos += " GIC11, A4555, GIC20, GIC24";
                        }
                    }

                    if (taskControl1.VehicleCollection.Rows[i]["RentalReim"].ToString() != "0" && taskControl1.VehicleCollection.Rows[i]["VehicleUse"].ToString() == "Private")
                    {
                        if (Endosos.Contains("GIC22"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n")
                                Endosos += ", GIC22";
                            else
                                Endosos += " GIC22";
                        }
                    }

                    if (taskControl1.VehicleCollection.Rows[i]["ADDPremium"].ToString() != "0" && (taskControl1.VehicleCollection.Rows[i]["VehicleUse"].ToString() == "Private" || taskControl1.VehicleCollection.Rows[i]["VehicleUse"].ToString() == "Commercial"))
                    {
                        if (Endosos.Contains("UIP248"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n")
                                Endosos += ", UIP248";
                            else
                                Endosos += " UIP248";
                        }
                    }

                    if (taskControl1.VehicleCollection.Rows[i]["VehicleUse"].ToString() == "Rental")// && taskControl1.VehicleCollection.Rows[i]["IsMotorcycleScooter"].ToString() != "True")
                    {
                        if (Endosos.Contains("GIC16"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n")
                                Endosos += ", GIC16";
                            else
                                Endosos += " GIC16";
                        }
                    }

                    if (taskControl1.VehicleCollection.Rows[i]["TaxiLossAmount"].ToString() != "0")
                    {
                        if (Endosos.Contains("GIC23"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n")
                                Endosos += ", GIC23";
                            else
                                Endosos += " GIC23";
                        }

                        if (taskControl1.VehicleCollection.Rows[i]["Island"].ToString() == "St. Croix")
                        {
                            if (Endosos.Contains("VIPA"))
                            {
                                Endosos += "";
                            }
                            else
                            {
                                if (Endosos.ToString() != "FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n")
                                    Endosos += ", VIPA";
                                else
                                    Endosos += " VIPA";
                            }
                        }
                    }

                    if (taskControl1.VehicleCollection.Rows[i]["MPPremium"].ToString() != "0")
                    {
                        if (Endosos.Contains("AP328A, CA583"))
                        {
                            Endosos += "";
                        }
                        else
                        {
                            if (Endosos.ToString() != "FORMS AND ENDORSEMENTS CONTAINED IN THIS POLICY AT ITS INCEPTION: \r\n")
                                Endosos += ", AP328A, CA583";
                            else
                                Endosos += " AP328A, CA583";
                        }
                    }

                }

                parameters[0] = new ReportParameter("Endosos", Endosos.ToString().Trim());

                //Nuevo JNF

                ReportViewer viewer1 = new ReportViewer();
                viewer1.LocalReport.DataSources.Clear();
                viewer1.ProcessingMode = ProcessingMode.Local;
                viewer1.LocalReport.ReportPath = Server.MapPath("Reports/VI/DecPage-BAP67077page3.rdlc");
                viewer1.LocalReport.SetParameters(parameters);
                viewer1.LocalReport.DataSources.Add(rds1);
                viewer1.LocalReport.DataSources.Add(rds2);
                //viewer1.LocalReport.DataSources.Add(rds3);
                //viewer1.LocalReport.DataSources.Add(rds4);
                viewer1.LocalReport.Refresh();

                Warning[] warnings = null;
                string[] streamIds = null;
                string mimeType = string.Empty;
                string encoding = string.Empty;
                string extension = string.Empty;
                string filetype = string.Empty;


                string fileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-Com3";
                string _FileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-Com3" + ".pdf";

                if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1))
                    File.Delete(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);

                byte[] bytes1 = viewer1.LocalReport.Render("PDF", null, out mimeType, out encoding, out extension, out streamIds, out warnings);

                using (FileStream fs1 = new FileStream(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1, FileMode.Create))
                {
                    fs1.Write(bytes1, 0, bytes1.Length);
                    fs1.Close();
                }

                mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);
                return mergePaths;
            }
            catch (Exception ecp)
            {
                throw new Exception(ecp.Message.ToString());
            }
        }

        private List<string> ImprimirDecPageComercialP4(List<string> mergePaths, int taskControl)
        {
            try
            {
                string ProcessedPath = ConfigurationManager.AppSettings["ExportsFilesPathName"];

                int s = taskControl;

                EPolicy.TaskControl.DoubleInterest taskControl1 = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                GetPaymentByTaskControlID_VITableAdapters.GetPaymentByTaskControlID_VITableAdapter ds1 = new GetPaymentByTaskControlID_VITableAdapters.GetPaymentByTaskControlID_VITableAdapter();

                //GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter ds3 = new GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter();
                //GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter ds4 = new GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter();

                ReportDataSource rds1 = new ReportDataSource();
                //ReportDataSource rds2 = new ReportDataSource();
                // ReportDataSource rds3 = new ReportDataSource();
                //ReportDataSource rds4 = new ReportDataSource();


                rds1 = new ReportDataSource("GetPaymentByTaskControlID_VI", (DataTable)ds1.GetData(s));
                //rds2 = new ReportDataSource("GetReportAutoGeneralInfo_VI", (DataTable)ds2.GetData(s));
                //rds3 = new ReportDataSource("GetReportAutoDriversInfo_VI", (DataTable)ds3.GetData(s));
                //rds4 = new ReportDataSource("GetReportAutoVehicleInfoPolicy_VI", (DataTable)ds4.GetData(s, VehicleDetailID));

                //Nuevo

                string ImgPath = "", AgentDesc = "";

                Uri pathAsUri = null;

                DataTable dt = null, dtAgent = null;

                dt = GetImageLogoByAgentID(taskControl1.Agent.ToString().Trim());

                dtAgent = GetAgentByAgentID(taskControl1.Agent.ToString().Trim());

                if (dtAgent.Rows.Count > 0)
                {
                    AgentDesc = dtAgent.Rows[0]["AgentDesc"].ToString().Trim();
                }

                if (dt.Rows.Count > 0)
                {
                    ImgPath = Server.MapPath("Images2\\AgencyLogos\\" + dt.Rows[0]["ImgPath"].ToString().Trim());
                    pathAsUri = new Uri(ImgPath);
                }
                else if (AgentDesc.ToUpper().Contains("GUARDIAN"))
                {
                    ImgPath = Server.MapPath("Images2\\AgencyLogos\\guardianLogo.png");
                    pathAsUri = new Uri(ImgPath);
                }
                else
                {

                }

                ReportParameter[] parameters = new ReportParameter[1];

                parameters[0] = new ReportParameter("ImgPath", pathAsUri != null ? pathAsUri.AbsoluteUri : "");


                ReportViewer viewer1 = new ReportViewer();
                viewer1.LocalReport.DataSources.Clear();
                viewer1.ProcessingMode = ProcessingMode.Local;
                viewer1.LocalReport.ReportPath = Server.MapPath("Reports/VI/AgentInvoice_VI.rdlc");
                viewer1.LocalReport.EnableExternalImages = true;
                viewer1.LocalReport.DataSources.Add(rds1);
                viewer1.LocalReport.SetParameters(parameters);
                //viewer1.LocalReport.DataSources.Add(rds2);
                //viewer1.LocalReport.DataSources.Add(rds3);
                //viewer1.LocalReport.DataSources.Add(rds4);
                viewer1.LocalReport.Refresh();

                Warning[] warnings = null;
                string[] streamIds = null;
                string mimeType = string.Empty;
                string encoding = string.Empty;
                string extension = string.Empty;
                string filetype = string.Empty;


                string fileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-Com4";
                string _FileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-Com4" + ".pdf";

                if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1))
                    File.Delete(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);

                byte[] bytes1 = viewer1.LocalReport.Render("PDF", null, out mimeType, out encoding, out extension, out streamIds, out warnings);

                using (FileStream fs1 = new FileStream(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1, FileMode.Create))
                {
                    fs1.Write(bytes1, 0, bytes1.Length);
                    fs1.Close();
                }

                mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);
                return mergePaths;
            }
            catch (Exception ecp)
            {
                throw new Exception(ecp.Message.ToString());
            }
        }

        private List<string> ImprimirUnder26(List<string> mergePaths, int taskControl)
        {
            try
            {
                string ProcessedPath = ConfigurationManager.AppSettings["ExportsFilesPathName"];

                int s = taskControl;

                GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter ds1 = new GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter();
                GetReportAutoDriversInfoUnder26YearsPolizads_VITableAdapters.GetReportAutoDriversInfoUnder26YearsPoliza_VITableAdapter ds2 = new GetReportAutoDriversInfoUnder26YearsPolizads_VITableAdapters.GetReportAutoDriversInfoUnder26YearsPoliza_VITableAdapter();

                //GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter ds3 = new GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter();
                //GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter ds4 = new GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter();

                ReportDataSource rds1 = new ReportDataSource();
                ReportDataSource rds2 = new ReportDataSource();
                //ReportDataSource rds2 = new ReportDataSource();
                // ReportDataSource rds3 = new ReportDataSource();
                //ReportDataSource rds4 = new ReportDataSource();


                rds1 = new ReportDataSource("GetReportAutoGeneralInfo_VI", (DataTable)ds1.GetData(s));
                rds2 = new ReportDataSource("GetReportAutoDriversUnder26Poliza_VI", (DataTable)ds2.GetData(s));
                //rds3 = new ReportDataSource("GetReportAutoDriversInfo_VI", (DataTable)ds3.GetData(s));
                //rds4 = new ReportDataSource("GetReportAutoVehicleInfoPolicy_VI", (DataTable)ds4.GetData(s, VehicleDetailID));

                //Nuevo

                ReportViewer viewer1 = new ReportViewer();
                viewer1.LocalReport.DataSources.Clear();
                viewer1.ProcessingMode = ProcessingMode.Local;
                viewer1.LocalReport.ReportPath = Server.MapPath("Reports/VI/Under26PG1.rdlc");

                viewer1.LocalReport.DataSources.Add(rds1);
                viewer1.LocalReport.DataSources.Add(rds2);
                //viewer1.LocalReport.DataSources.Add(rds2);
                //viewer1.LocalReport.DataSources.Add(rds3);
                //viewer1.LocalReport.DataSources.Add(rds4);
                viewer1.LocalReport.Refresh();

                Warning[] warnings = null;
                string[] streamIds = null;
                string mimeType = string.Empty;
                string encoding = string.Empty;
                string extension = string.Empty;
                string filetype = string.Empty;


                string fileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-Under26";
                string _FileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-Under26" + ".pdf";

                if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1))
                    File.Delete(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);

                byte[] bytes1 = viewer1.LocalReport.Render("PDF", null, out mimeType, out encoding, out extension, out streamIds, out warnings);

                using (FileStream fs1 = new FileStream(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1, FileMode.Create))
                {
                    fs1.Write(bytes1, 0, bytes1.Length);
                    fs1.Close();
                }

                mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);
                return mergePaths;
            }
            catch (Exception ecp)
            {
                throw new Exception(ecp.Message.ToString());
            }
        }

        private List<string> ImprimirGIC20(List<string> mergePaths, int taskControl)
        {
            try
            {
                string ProcessedPath = ConfigurationManager.AppSettings["ExportsFilesPathName"];

                int s = taskControl;

                GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter ds1 = new GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter();
                //GetReportAutoDriversInfoUnder26YearsPolizads_VITableAdapters.GetReportAutoDriversInfoUnder26YearsPoliza_VITableAdapter ds2 = new GetReportAutoDriversInfoUnder26YearsPolizads_VITableAdapters.GetReportAutoDriversInfoUnder26YearsPoliza_VITableAdapter();

                //GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter ds3 = new GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter();
                //GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter ds4 = new GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter();

                ReportDataSource rds1 = new ReportDataSource();
                // ReportDataSource rds2 = new ReportDataSource();
                //ReportDataSource rds2 = new ReportDataSource();
                // ReportDataSource rds3 = new ReportDataSource();
                //ReportDataSource rds4 = new ReportDataSource();


                rds1 = new ReportDataSource("GetReportAutoGeneralInfo_VI", (DataTable)ds1.GetData(s));
                // rds2 = new ReportDataSource("GetReportAutoDriversUnder26Poliza_VI", (DataTable)ds2.GetData(s));
                //rds3 = new ReportDataSource("GetReportAutoDriversInfo_VI", (DataTable)ds3.GetData(s));
                //rds4 = new ReportDataSource("GetReportAutoVehicleInfoPolicy_VI", (DataTable)ds4.GetData(s, VehicleDetailID));

                //Nuevo

                ReportViewer viewer1 = new ReportViewer();
                viewer1.LocalReport.DataSources.Clear();
                viewer1.ProcessingMode = ProcessingMode.Local;
                viewer1.LocalReport.ReportPath = Server.MapPath("Reports/VI/GIC20PG1.rdlc");

                viewer1.LocalReport.DataSources.Add(rds1);
                // viewer1.LocalReport.DataSources.Add(rds2);
                //viewer1.LocalReport.DataSources.Add(rds2);
                //viewer1.LocalReport.DataSources.Add(rds3);
                //viewer1.LocalReport.DataSources.Add(rds4);
                viewer1.LocalReport.Refresh();

                Warning[] warnings = null;
                string[] streamIds = null;
                string mimeType = string.Empty;
                string encoding = string.Empty;
                string extension = string.Empty;
                string filetype = string.Empty;


                string fileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-GIC20";
                string _FileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-GIC20" + ".pdf";

                if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1))
                    File.Delete(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);

                byte[] bytes1 = viewer1.LocalReport.Render("PDF", null, out mimeType, out encoding, out extension, out streamIds, out warnings);

                using (FileStream fs1 = new FileStream(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1, FileMode.Create))
                {
                    fs1.Write(bytes1, 0, bytes1.Length);
                    fs1.Close();
                }

                mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);
                return mergePaths;
            }
            catch (Exception ecp)
            {
                throw new Exception(ecp.Message.ToString());
            }
        }

        private List<string> ImprimirGIC22(List<string> mergePaths, int taskControl)
        {
            try
            {
                string ProcessedPath = ConfigurationManager.AppSettings["ExportsFilesPathName"];

                int s = taskControl;

                //GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter ds1 = new GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter();
                //GetReportAutoDriversInfoUnder26YearsPolizads_VITableAdapters.GetReportAutoDriversInfoUnder26YearsPoliza_VITableAdapter ds2 = new GetReportAutoDriversInfoUnder26YearsPolizads_VITableAdapters.GetReportAutoDriversInfoUnder26YearsPoliza_VITableAdapter();

                //GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter ds3 = new GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter();
                //GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter ds4 = new GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter();

                // ReportDataSource rds1 = new ReportDataSource();
                // ReportDataSource rds2 = new ReportDataSource();
                //ReportDataSource rds2 = new ReportDataSource();
                // ReportDataSource rds3 = new ReportDataSource();
                //ReportDataSource rds4 = new ReportDataSource();


                // rds1 = new ReportDataSource("GetReportAutoGeneralInfo_VI", (DataTable)ds1.GetData(s));
                // rds2 = new ReportDataSource("GetReportAutoDriversUnder26Poliza_VI", (DataTable)ds2.GetData(s));
                //rds3 = new ReportDataSource("GetReportAutoDriversInfo_VI", (DataTable)ds3.GetData(s));
                //rds4 = new ReportDataSource("GetReportAutoVehicleInfoPolicy_VI", (DataTable)ds4.GetData(s, VehicleDetailID));

                //Nuevo

                ReportViewer viewer1 = new ReportViewer();
                viewer1.LocalReport.DataSources.Clear();
                viewer1.ProcessingMode = ProcessingMode.Local;
                viewer1.LocalReport.ReportPath = Server.MapPath("Reports/VI/GIC22.rdlc");

                // viewer1.LocalReport.DataSources.Add(rds1);
                // viewer1.LocalReport.DataSources.Add(rds2);
                //viewer1.LocalReport.DataSources.Add(rds2);
                //viewer1.LocalReport.DataSources.Add(rds3);
                //viewer1.LocalReport.DataSources.Add(rds4);
                viewer1.LocalReport.Refresh();

                Warning[] warnings = null;
                string[] streamIds = null;
                string mimeType = string.Empty;
                string encoding = string.Empty;
                string extension = string.Empty;
                string filetype = string.Empty;


                string fileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-GIC22";
                string _FileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-GIC22" + ".pdf";

                if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1))
                    File.Delete(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);

                byte[] bytes1 = viewer1.LocalReport.Render("PDF", null, out mimeType, out encoding, out extension, out streamIds, out warnings);

                using (FileStream fs1 = new FileStream(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1, FileMode.Create))
                {
                    fs1.Write(bytes1, 0, bytes1.Length);
                    fs1.Close();
                }

                mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);
                return mergePaths;
            }
            catch (Exception ecp)
            {
                throw new Exception(ecp.Message.ToString());
            }
        }

        private List<string> ImprimirE133(List<string> mergePaths, int taskControl)
        {
            try
            {
                string ProcessedPath = ConfigurationManager.AppSettings["ExportsFilesPathName"];

                int s = taskControl;

                GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter ds1 = new GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter();
                //GetReportAutoDriversInfoUnder26YearsPolizads_VITableAdapters.GetReportAutoDriversInfoUnder26YearsPoliza_VITableAdapter ds2 = new GetReportAutoDriversInfoUnder26YearsPolizads_VITableAdapters.GetReportAutoDriversInfoUnder26YearsPoliza_VITableAdapter();

                //GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter ds3 = new GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter();
                //GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter ds4 = new GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter();

                ReportDataSource rds1 = new ReportDataSource();
                // ReportDataSource rds2 = new ReportDataSource();
                //ReportDataSource rds2 = new ReportDataSource();
                // ReportDataSource rds3 = new ReportDataSource();
                //ReportDataSource rds4 = new ReportDataSource();


                rds1 = new ReportDataSource("GetReportAutoGeneralInfo_VI", (DataTable)ds1.GetData(s));
                // rds2 = new ReportDataSource("GetReportAutoDriversUnder26Poliza_VI", (DataTable)ds2.GetData(s));
                //rds3 = new ReportDataSource("GetReportAutoDriversInfo_VI", (DataTable)ds3.GetData(s));
                //rds4 = new ReportDataSource("GetReportAutoVehicleInfoPolicy_VI", (DataTable)ds4.GetData(s, VehicleDetailID));

                //Nuevo

                ReportViewer viewer1 = new ReportViewer();
                viewer1.LocalReport.DataSources.Clear();
                viewer1.ProcessingMode = ProcessingMode.Local;
                viewer1.LocalReport.ReportPath = Server.MapPath("Reports/VI/E133PG1.rdlc");

                viewer1.LocalReport.DataSources.Add(rds1);
                // viewer1.LocalReport.DataSources.Add(rds2);
                //viewer1.LocalReport.DataSources.Add(rds2);
                //viewer1.LocalReport.DataSources.Add(rds3);
                //viewer1.LocalReport.DataSources.Add(rds4);
                viewer1.LocalReport.Refresh();

                Warning[] warnings = null;
                string[] streamIds = null;
                string mimeType = string.Empty;
                string encoding = string.Empty;
                string extension = string.Empty;
                string filetype = string.Empty;


                string fileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-E133";
                string _FileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-E133" + ".pdf";

                if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1))
                    File.Delete(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);

                byte[] bytes1 = viewer1.LocalReport.Render("PDF", null, out mimeType, out encoding, out extension, out streamIds, out warnings);

                using (FileStream fs1 = new FileStream(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1, FileMode.Create))
                {
                    fs1.Write(bytes1, 0, bytes1.Length);
                    fs1.Close();
                }

                mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);
                return mergePaths;
            }
            catch (Exception ecp)
            {
                throw new Exception(ecp.Message.ToString());
            }
        }

        private List<string> ImprimirADD(List<string> mergePaths, int taskControl, string DriversCount)
        {
            #region ADD PAGE 1
            try
            {
                string ProcessedPath = ConfigurationManager.AppSettings["ExportsFilesPathName"];

                int s = taskControl;

                GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter ds1 = new GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter();
                //GetReportAutoDriversInfoUnder26YearsPolizads_VITableAdapters.GetReportAutoDriversInfoUnder26YearsPoliza_VITableAdapter ds2 = new GetReportAutoDriversInfoUnder26YearsPolizads_VITableAdapters.GetReportAutoDriversInfoUnder26YearsPoliza_VITableAdapter();

                GetReportAutoDriversInfoPolizads_VITableAdapters.GetReportAutoDriversInfoPoliza_VITableAdapter ds3 = new GetReportAutoDriversInfoPolizads_VITableAdapters.GetReportAutoDriversInfoPoliza_VITableAdapter();
                //GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter ds4 = new GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter();

                ReportDataSource rds1 = new ReportDataSource();
                // ReportDataSource rds2 = new ReportDataSource();
                //ReportDataSource rds2 = new ReportDataSource();
                ReportDataSource rds3 = new ReportDataSource();
                //ReportDataSource rds4 = new ReportDataSource();


                rds1 = new ReportDataSource("GetReportAutoGeneralInfo_VI", (DataTable)ds1.GetData(s));
                // rds2 = new ReportDataSource("GetReportAutoDriversUnder26Poliza_VI", (DataTable)ds2.GetData(s));
                rds3 = new ReportDataSource("GetReportAutoDriversInfoPoliza_VI", (DataTable)ds3.GetData(s));
                //rds4 = new ReportDataSource("GetReportAutoVehicleInfoPolicy_VI", (DataTable)ds4.GetData(s, VehicleDetailID));

                //Nuevo

                ReportViewer viewer1 = new ReportViewer();
                viewer1.LocalReport.DataSources.Clear();
                viewer1.ProcessingMode = ProcessingMode.Local;
                viewer1.LocalReport.ReportPath = Server.MapPath("Reports/VI/ADDPG2page1.rdlc");

                viewer1.LocalReport.DataSources.Add(rds1);
                // viewer1.LocalReport.DataSources.Add(rds2);
                //viewer1.LocalReport.DataSources.Add(rds2);
                viewer1.LocalReport.DataSources.Add(rds3);
                //viewer1.LocalReport.DataSources.Add(rds4);
                viewer1.LocalReport.Refresh();

                Warning[] warnings = null;
                string[] streamIds = null;
                string mimeType = string.Empty;
                string encoding = string.Empty;
                string extension = string.Empty;
                string filetype = string.Empty;


                string fileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-ADDPG2P1";
                string _FileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-ADDPG2P1" + ".pdf";

                if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1))
                    File.Delete(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);

                byte[] bytes1 = viewer1.LocalReport.Render("PDF", null, out mimeType, out encoding, out extension, out streamIds, out warnings);

                using (FileStream fs1 = new FileStream(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1, FileMode.Create))
                {
                    fs1.Write(bytes1, 0, bytes1.Length);
                    fs1.Close();
                }

                mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);
                //return mergePaths;
            }
            catch (Exception ecp)
            {
                throw new Exception(ecp.Message.ToString());
            }
            #endregion ADD PAGE 1

            if (DriversCount != "")
            {
                #region OPTIONAL PAGE 2
                try
                {
                    string ProcessedPath = ConfigurationManager.AppSettings["ExportsFilesPathName"];

                    int s = taskControl;

                    GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter ds1 = new GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter();
                    //GetReportAutoDriversInfoUnder26YearsPolizads_VITableAdapters.GetReportAutoDriversInfoUnder26YearsPoliza_VITableAdapter ds2 = new GetReportAutoDriversInfoUnder26YearsPolizads_VITableAdapters.GetReportAutoDriversInfoUnder26YearsPoliza_VITableAdapter();

                    GetReportAutoDriversInfoPolizads_VITableAdapters.GetReportAutoDriversInfoPoliza_VITableAdapter ds3 = new GetReportAutoDriversInfoPolizads_VITableAdapters.GetReportAutoDriversInfoPoliza_VITableAdapter();
                    //GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter ds4 = new GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter();

                    ReportDataSource rds1 = new ReportDataSource();
                    // ReportDataSource rds2 = new ReportDataSource();
                    //ReportDataSource rds2 = new ReportDataSource();
                    ReportDataSource rds3 = new ReportDataSource();
                    //ReportDataSource rds4 = new ReportDataSource();


                    rds1 = new ReportDataSource("GetReportAutoGeneralInfo_VI", (DataTable)ds1.GetData(s));
                    // rds2 = new ReportDataSource("GetReportAutoDriversUnder26Poliza_VI", (DataTable)ds2.GetData(s));
                    rds3 = new ReportDataSource("GetReportAutoDriversInfoPoliza_VI", (DataTable)ds3.GetData(s));
                    //rds4 = new ReportDataSource("GetReportAutoVehicleInfoPolicy_VI", (DataTable)ds4.GetData(s, VehicleDetailID));

                    //Nuevo

                    ReportViewer viewer1 = new ReportViewer();
                    viewer1.LocalReport.DataSources.Clear();
                    viewer1.ProcessingMode = ProcessingMode.Local;
                    viewer1.LocalReport.ReportPath = Server.MapPath("Reports/VI/ADDPG2Schedule.rdlc");

                    viewer1.LocalReport.DataSources.Add(rds1);
                    // viewer1.LocalReport.DataSources.Add(rds2);
                    //viewer1.LocalReport.DataSources.Add(rds2);
                    viewer1.LocalReport.DataSources.Add(rds3);
                    //viewer1.LocalReport.DataSources.Add(rds4);
                    viewer1.LocalReport.Refresh();

                    Warning[] warnings = null;
                    string[] streamIds = null;
                    string mimeType = string.Empty;
                    string encoding = string.Empty;
                    string extension = string.Empty;
                    string filetype = string.Empty;


                    string fileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-ADDPG2SD";
                    string _FileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-ADDPG2SD" + ".pdf";

                    if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1))
                        File.Delete(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);

                    byte[] bytes1 = viewer1.LocalReport.Render("PDF", null, out mimeType, out encoding, out extension, out streamIds, out warnings);

                    using (FileStream fs1 = new FileStream(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1, FileMode.Create))
                    {
                        fs1.Write(bytes1, 0, bytes1.Length);
                        fs1.Close();
                    }

                    mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);
                    //return mergePaths;
                }
                catch (Exception ecp)
                {
                    throw new Exception(ecp.Message.ToString());
                }
                #endregion OPTIONAL ADD PAGE 2
            }

            try
            {
                string ProcessedPath = ConfigurationManager.AppSettings["ExportsFilesPathName"];

                int s = taskControl;

                //GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter ds1 = new GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter();
                //GetReportAutoDriversInfoUnder26YearsPolizads_VITableAdapters.GetReportAutoDriversInfoUnder26YearsPoliza_VITableAdapter ds2 = new GetReportAutoDriversInfoUnder26YearsPolizads_VITableAdapters.GetReportAutoDriversInfoUnder26YearsPoliza_VITableAdapter();

                //GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter ds3 = new GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter();
                //GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter ds4 = new GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter();

                //ReportDataSource rds1 = new ReportDataSource();
                // ReportDataSource rds2 = new ReportDataSource();
                //ReportDataSource rds2 = new ReportDataSource();
                // ReportDataSource rds3 = new ReportDataSource();
                //ReportDataSource rds4 = new ReportDataSource();


                //rds1 = new ReportDataSource("GetReportAutoGeneralInfo_VI", (DataTable)ds1.GetData(s));
                // rds2 = new ReportDataSource("GetReportAutoDriversUnder26Poliza_VI", (DataTable)ds2.GetData(s));
                //rds3 = new ReportDataSource("GetReportAutoDriversInfo_VI", (DataTable)ds3.GetData(s));
                //rds4 = new ReportDataSource("GetReportAutoVehicleInfoPolicy_VI", (DataTable)ds4.GetData(s, VehicleDetailID));

                //Nuevo

                ReportViewer viewer1 = new ReportViewer();
                viewer1.LocalReport.DataSources.Clear();
                viewer1.ProcessingMode = ProcessingMode.Local;
                viewer1.LocalReport.ReportPath = Server.MapPath("Reports/VI/ADDPG2page2.rdlc");

                //viewer1.LocalReport.DataSources.Add(rds1);
                // viewer1.LocalReport.DataSources.Add(rds2);
                //viewer1.LocalReport.DataSources.Add(rds2);
                //viewer1.LocalReport.DataSources.Add(rds3);
                //viewer1.LocalReport.DataSources.Add(rds4);
                viewer1.LocalReport.Refresh();

                Warning[] warnings = null;
                string[] streamIds = null;
                string mimeType = string.Empty;
                string encoding = string.Empty;
                string extension = string.Empty;
                string filetype = string.Empty;


                string fileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-ADDPG2P2";
                string _FileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-ADDPG2P2" + ".pdf";

                if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1))
                    File.Delete(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);

                byte[] bytes1 = viewer1.LocalReport.Render("PDF", null, out mimeType, out encoding, out extension, out streamIds, out warnings);

                using (FileStream fs1 = new FileStream(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1, FileMode.Create))
                {
                    fs1.Write(bytes1, 0, bytes1.Length);
                    fs1.Close();
                }

                mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);
                return mergePaths;
            }
            catch (Exception ecp)
            {
                throw new Exception(ecp.Message.ToString());
            }
        }

        private List<string> ImprimirPAEPG1(List<string> mergePaths, int taskControl)
        {
            try
            {
                string ProcessedPath = ConfigurationManager.AppSettings["ExportsFilesPathName"];

                int s = taskControl;

                GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter ds1 = new GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter();
                //GetReportAutoDriversInfoUnder26YearsPolizads_VITableAdapters.GetReportAutoDriversInfoUnder26YearsPoliza_VITableAdapter ds2 = new GetReportAutoDriversInfoUnder26YearsPolizads_VITableAdapters.GetReportAutoDriversInfoUnder26YearsPoliza_VITableAdapter();

                //GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter ds3 = new GetReportAutoDriversInfods_VITableAdapters.GetReportAutoDriversInfo_VITableAdapter();
                //GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter ds4 = new GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicy_VITableAdapter();

                ReportDataSource rds1 = new ReportDataSource();
                // ReportDataSource rds2 = new ReportDataSource();
                //ReportDataSource rds2 = new ReportDataSource();
                // ReportDataSource rds3 = new ReportDataSource();
                //ReportDataSource rds4 = new ReportDataSource();


                rds1 = new ReportDataSource("GetReportAutoGeneralInfo_VI", (DataTable)ds1.GetData(s));
                // rds2 = new ReportDataSource("GetReportAutoDriversUnder26Poliza_VI", (DataTable)ds2.GetData(s));
                //rds3 = new ReportDataSource("GetReportAutoDriversInfo_VI", (DataTable)ds3.GetData(s));
                //rds4 = new ReportDataSource("GetReportAutoVehicleInfoPolicy_VI", (DataTable)ds4.GetData(s, VehicleDetailID));

                //Nuevo

                ReportViewer viewer1 = new ReportViewer();
                viewer1.LocalReport.DataSources.Clear();
                viewer1.ProcessingMode = ProcessingMode.Local;
                viewer1.LocalReport.ReportPath = Server.MapPath("Reports/VI/PAEPG1.rdlc");

                viewer1.LocalReport.DataSources.Add(rds1);
                // viewer1.LocalReport.DataSources.Add(rds2);
                //viewer1.LocalReport.DataSources.Add(rds2);
                //viewer1.LocalReport.DataSources.Add(rds3);
                //viewer1.LocalReport.DataSources.Add(rds4);
                viewer1.LocalReport.Refresh();

                Warning[] warnings = null;
                string[] streamIds = null;
                string mimeType = string.Empty;
                string encoding = string.Empty;
                string extension = string.Empty;
                string filetype = string.Empty;


                string fileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-PAEPG1";
                string _FileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + taskControl.ToString().Trim() + "-PAEG1" + ".pdf";

                if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1))
                    File.Delete(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);

                byte[] bytes1 = viewer1.LocalReport.Render("PDF", null, out mimeType, out encoding, out extension, out streamIds, out warnings);

                using (FileStream fs1 = new FileStream(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1, FileMode.Create))
                {
                    fs1.Write(bytes1, 0, bytes1.Length);
                    fs1.Close();
                }

                mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);
                return mergePaths;
            }
            catch (Exception ecp)
            {
                throw new Exception(ecp.Message.ToString());
            }
        }

        private List<string> ImprimirIDCards(List<string> mergePaths, int taskControl, int VehicleDetailID, string EffectiveDate, string ExpirationDate)
        {
            try
            {
                string ProcessedPath = ConfigurationManager.AppSettings["ExportsFilesPathName"];

                int s = taskControl;

                GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter ds1 = new GetReportAutoGeneralInfods_VITableAdapters.GetReportAutoGeneralInfo_VITableAdapter();
                GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicyByVehicle_VITableAdapter ds2 = new GetReportAutoVehicleInfoPolicyTableAdapters.GetReportAutoVehiclesInfoPolicyByVehicle_VITableAdapter();
                GetReportNameInsuredTableAdapters.GetReportNameInsuredTableAdapter ds3 = new
                GetReportNameInsuredTableAdapters.GetReportNameInsuredTableAdapter();

                //ReportDataSource rds1 = new ReportDataSource();
                ReportDataSource rds1 = new ReportDataSource();
                // ReportDataSource rds3 = new ReportDataSource();
                ReportDataSource rds2 = new ReportDataSource();
                ReportDataSource rds3 = new ReportDataSource();


                //rds1 = new ReportDataSource("GetReportAutoVehiclesInfo_VI", (DataTable)ds1.GetData(s));
                rds1 = new ReportDataSource("dsAutoGeneralInfo_VI", (DataTable)ds1.GetData(s));
                //rds3 = new ReportDataSource("GetReportAutoDriversInfo_VI", (DataTable)ds3.GetData(s));
                rds2 = new ReportDataSource("dsAutoVehicleInfoPolicy", (DataTable)ds2.GetData(s, VehicleDetailID)); //, VehicleDetailID));
                rds3 = new ReportDataSource("GetReportNameInsured", (DataTable)ds3.GetData(s));


                ReportParameter[] parameters = new ReportParameter[2];

                parameters[0] = new ReportParameter("EffDate", EffectiveDate);
                parameters[1] = new ReportParameter("ExpDate", ExpirationDate);


                ReportViewer viewer1 = new ReportViewer();
                viewer1.LocalReport.DataSources.Clear();
                viewer1.ProcessingMode = ProcessingMode.Local;
                viewer1.LocalReport.ReportPath = Server.MapPath("Reports/VI/IDCardsDI.rdlc");
                //viewer1.LocalReport.DataSources.Add(rds1);
                viewer1.LocalReport.DataSources.Add(rds1);
                //viewer1.LocalReport.DataSources.Add(rds3);
                viewer1.LocalReport.DataSources.Add(rds2);
                viewer1.LocalReport.DataSources.Add(rds3);
                viewer1.LocalReport.SetParameters(parameters);
                viewer1.LocalReport.Refresh();

                Warning[] warnings = null;
                string[] streamIds = null;
                string mimeType = string.Empty;
                string encoding = string.Empty;
                string extension = string.Empty;
                string filetype = string.Empty;

                Guid RandomString = Guid.NewGuid();
                string fileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + VehicleDetailID.ToString().Trim() + RandomString.ToString() + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + "-IDCardsDI";
                string _FileName1 = "PolicyNo- " + taskControl.ToString().Trim() + "-" + VehicleDetailID.ToString().Trim() + RandomString.ToString() + DateTime.Now.Month + "_" + DateTime.Now.Day.ToString() + "_" + DateTime.Now.Hour + "_" + DateTime.Now.Minute + "-IDCardsDI" + ".pdf";

                if (File.Exists(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1))
                    File.Delete(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);

                byte[] bytes1 = viewer1.LocalReport.Render("PDF", null, out mimeType, out encoding, out extension, out streamIds, out warnings);

                using (FileStream fs1 = new FileStream(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1, FileMode.Create))
                {
                    fs1.Write(bytes1, 0, bytes1.Length);
                    fs1.Close();
                }

                mergePaths.Add(System.Configuration.ConfigurationManager.AppSettings["ExportsFilesPathName"] + _FileName1);
                return mergePaths;
            }
            catch (Exception ecp)
            {
                throw new Exception(ecp.Message.ToString());
            }
        }
        #endregion Print

        void UpdatePolicyMode_VI(int TaskControlID, string Mode_VI)
        {
            DbRequestXmlCookRequestItem[] cookItems =
            new DbRequestXmlCookRequestItem[2];

            DbRequestXmlCooker.AttachCookItem("TaskControlID",
                SqlDbType.Int, 0, TaskControlID.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("Mode_VI",
                SqlDbType.VarChar, 1, Mode_VI.ToString(),
                ref cookItems);


            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }

            try
            {
                exec.GetQuery("UpdatePolicyMode_VI", xmlDoc);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve the liability rates.", ex);
            }

        }

        void UpdatePolicyTC_VI(int TaskControlID, string ApplicationTC)
        {
            DbRequestXmlCookRequestItem[] cookItems =
            new DbRequestXmlCookRequestItem[2];

            DbRequestXmlCooker.AttachCookItem("TaskControlID",
                SqlDbType.Int, 0, TaskControlID.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("ApplicationTC",
                SqlDbType.VarChar, 50, ApplicationTC.ToString(),
                ref cookItems);


            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }

            try
            {
                exec.GetQuery("UpdatePolicyApplicationTC", xmlDoc);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve the liability rates.", ex);
            }

        }

        protected void Button1_Click(object sender, EventArgs e)
        {
            AddPrimaryDriver();
        }

        protected void btnSendEmail_Click(object sender, EventArgs e)
        {
            try
            {
                TextBox1.Text = "";
                Button button = (Button)sender;
                string buttonId = button.ID;

                if (buttonId == "btnCloseSend")
                {
                    txtsenderEmail.Text = "";
                    txtsendName.Text = "";
                    txtsendSubject.Text = "";
                    txtsendMessage.Text = "";
                    TextBox1.Text = "";
                    mpeAdjunto.Hide();
                }
                else
                {
                    if (txtsenderEmail.Text == "" && txtsendName.Text == "" && txtsendSubject.Text == "" && txtsendMessage.Text == "")
                    {
                        return;
                    }

                    if (chkIsBusinessAutoQuote.Checked)
                    {
                        PrintPolicyBusiness(true);
                    }
                    else
                    {
                        PrintPolicyPersonal(true);
                    }

                    SendEmail(txtsenderEmail.Text.ToString().Trim(), txtsendName.Text.ToString().Trim(), txtsendSubject.Text.ToString().Trim(), txtsendMessage.Text.ToString().Trim());

                    txtsenderEmail.Text = "";
                    txtsendName.Text = "";
                    txtsendSubject.Text = "";
                    txtsendMessage.Text = "";
                    TextBox1.Text = "";
                    mpeAdjunto.Hide();

                    lblRecHeader.Text = "Email was sent Succesfully.";
                    mpeSeleccion.Show();
                }
            }
            catch (Exception exp)
            {
                LogError(exp);
                txtsenderEmail.Text = "";
                txtsendName.Text = "";
                txtsendSubject.Text = "";
                txtsendMessage.Text = "";
                TextBox1.Text = "";
                mpeAdjunto.Hide();

                lblRecHeader.Text = "ERROR: Email was not sent. Please call Technical Support at (787) 520-6175.";
                mpeSeleccion.Show();
            }
        }

        private void SendEmail(string senderEmail, string sendName, string sendSubject, string sendMessage)
        {
            try
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                //Email (El email que ve el que recibe)
                string emailNoreplay = "guardian.insurance@guardianinsurance.com";//"policyconfirmation@midoceanpr.com";
                string EmailNoReplayPass = "gicSTTGI1";//Conf1rm@tion
                //Email (That sends the message)
                string emailSend = "lsemailservice@gmail.com";
                string msg = "";
                string pdf = TextBox1.Text;
                string ExportFilesPath = ConfigurationManager.AppSettings["ExportsFilesPathName"].ToString().Trim();
                MailMessage SM = new MailMessage();

                string[] lines = sendMessage.Split(
                    new[] { "\r\n", "\r", "\n" },
                    StringSplitOptions.None
                );

                sendMessage = "";
                int count = 0;
                foreach (string line in lines)
                {
                    count++;
                    if (count == 1 && count == lines.Count())
                        sendMessage += "<p>" + line + "</p>";
                    else if (count == 1)
                        sendMessage += "<p>" + line + "<br>";
                    else if (count == lines.Count())
                        sendMessage += line + "</p>";
                    else
                        sendMessage += line + "<br>";
                }
                //sendMessage = lines

                SM.Subject = sendSubject;//"Guardian Insurance - Your payment has been received";
                SM.From = new System.Net.Mail.MailAddress(emailNoreplay, sendName + " - " + senderEmail);
                SM.Body = sendMessage;//"<p>Dear " + CustomerName + " (" + Email + ")</p><p>This email is to inform you that MidOcean Insurance Agency has processed a single " + PaymentMethod + " for the amount of $" + PaymentAmount + " on " + EntryDate + ". The description MidOcean Insurance Agency has provided for this transaction is as follows: " + PolicyNumber + ".</p><p>If this transaction is an error or is a fraudulent transaction, please contact MidOcean Insurance Agency at 787-520-6178 if you have any questions or concerns. Thank you for your payment.</p>";
                SM.IsBodyHtml = true;
                SM.Attachments.Add(new Attachment(ExportFilesPath + pdf));//@"F:\inetpub\wwwroot\EpmsTest\ExportFiles\" + pdf));

                //AlternateView av = AlternateView.CreateAlternateViewFromString(SM.Body, Encoding.UTF8, "text/html");
                //av.TransferEncoding = System.Net.Mime.TransferEncoding.Base64;
                //LinkedResource logo2 = new LinkedResource(ConfigurationManager.AppSettings["ImagePath"].ToString().Trim() + "blank.png", MediaTypeNames.Image.Jpeg);
                //logo2.ContentId = "BtnPagarEmail";
                //av.LinkedResources.Add(logo2);

                SM.To.Add(taskControl.Customer.Email.ToString());
                SM.CC.Add(senderEmail);
                //SM.Bcc.Add("ydejesus@lanzasoftware.com");

                try
                {
                    SmtpClient client = new SmtpClient();
                    client.EnableSsl = true;
                    client.UseDefaultCredentials = false;
                    client.Credentials = new NetworkCredential(emailNoreplay, EmailNoReplayPass);
                    client.Host = ConfigurationManager.AppSettings["IPMail"].ToString().Trim();
                    client.Port = 587;// 25;
                    client.DeliveryMethod = SmtpDeliveryMethod.Network;

                    client.Send(SM);
                    msg = "0001";
                }
                catch (Exception exc)
                {
                    throw new Exception("SMTPClient", exc);
                    msg = exc.InnerException.ToString() + " " + exc.Message;
                }
            }
            catch (Exception exc)
            {
                throw new Exception("SMTPClient", exc);
            }
        }

        protected void HideDriverSection(string ClassName)
        {
            try
            {
                //StringWriter sw = new StringWriter();
                //HtmlTextWriter h = new HtmlTextWriter(sw);
                //DriverSectionDiv.RenderControl(h);
                //string str = sw.GetStringBuilder().ToString();

                //AccordionDrivers.Visible = false;
                DriverSectionDiv.Visible = bool.Parse(ClassName);
                //DriverLine1.Attributes["class"] = ClassName;
                //DriverLine2.Attributes["class"] = ClassName;
                //DriverLine3.Attributes["class"] = ClassName;
                //DriverLine4.Attributes["class"] = ClassName;
                //DriverLine5.Attributes["class"] = ClassName;
                //DriverLine6.Attributes["class"] = ClassName;
                //DriverLine7.Attributes["class"] = ClassName;
            }
            catch (Exception)
            {

            }
        }

        #region Additional Covarage

        #region Accidental Death

        protected void radADD_SelectedIndexChanged(object sender, EventArgs e)
        {
            double Add = 25;// - (25.0 * (double.Parse(ddlDiscounts.SelectedItem.Text.ToString().Replace("%", "")) / 100));

            if (radADD.SelectedItem.Text == "Yes" && Session["ADD"] == "0")
            {
                //txtTotalQuote.Text = (double.Parse(txtTotalQuote.Text) + Math.Round(Add)).ToString("##,###.00");
                Session["ADD"] = "25";
            }
            else if (lblModifyVehicle.Visible && radADD.SelectedIndex == 0)
            {
                //txtTotalQuote.Text = (double.Parse(txtTotalQuote.Text) + Math.Round(Add)).ToString("##,###.00");
            }
            else
            {
                if (lblModifyVehicle.Visible && radADD.SelectedIndex == 1)
                {
                    //txtTotalQuote.Text = (double.Parse(txtTotalQuote.Text) - Math.Round(Add)).ToString("##,###.00");
                }
            }

            //radGenMotoristCoverage.Focus();

        }

        #endregion Accidental Death

        #region Motorist
        protected void radGenMotoristCoverage_SelectedIndexChanged(object sender, EventArgs e)
        {
            double Mot = 80;// - (80.0 * (double.Parse(ddlDiscounts.SelectedItem.Text.ToString().Replace("%", "")) / 100));

            if (radGenMotoristCoverage.SelectedItem.Text == "Yes" && Session["MOT"] == "0")
            {
                //txtTotalQuote.Text = (double.Parse(txtTotalQuote.Text) + Math.Round(Mot)).ToString("##,###.00");
                Session["MOT"] = "80";
            }
            else if (lblModifyVehicle.Visible && radGenMotoristCoverage.SelectedIndex == 0)
            {
                //txtTotalQuote.Text = (double.Parse(txtTotalQuote.Text) + Math.Round(Mot)).ToString("##,###.00");
            }
            else
            {
                if (lblModifyVehicle.Visible && radGenMotoristCoverage.SelectedIndex == 1)
                {
                    //txtTotalQuote.Text = (double.Parse(txtTotalQuote.Text) - Math.Round(Mot)).ToString("##,###.00");
                }
            }
            //radRentalReimCov.Focus();
        }
        #endregion Motorist

        #region Rental
        protected void radRentalReimCov_SelectedIndexChanged(object sender, EventArgs e)
        {
            double RR = 75; //- (75.0 * (double.Parse(ddlDiscounts.SelectedItem.Text.ToString().Replace("%", "")) / 100));

            if (radRentalReimCov.SelectedItem.Text == "Yes" && Session["REIM"] == "0")
            {
                //txtTotalQuote.Text = (double.Parse(txtTotalQuote.Text) + Math.Round(RR)).ToString("##,###.00");
                Session["REIM"] = "75";
            }
            else if (lblModifyVehicle.Visible && radRentalReimCov.SelectedIndex == 0)
            {
                ///txtTotalQuote.Text = (double.Parse(txtTotalQuote.Text) + Math.Round(RR)).ToString("##,###.00");
            }
            else
            {
                if (lblModifyVehicle.Visible && radRentalReimCov.SelectedIndex == 1)
                {
                    //txtTotalQuote.Text = (double.Parse(txtTotalQuote.Text) - Math.Round(RR)).ToString("##,###.00");
                }
            }

        }
        #endregion Rental

        #region Taxi Loss Income
        protected void radTaxiDriverloss_SelectedIndexChanged(object sender, EventArgs e)
        {
            double Taxi = 100;// - (25.0 * (double.Parse(ddlDiscounts.SelectedItem.Text.ToString().Replace("%", "")) / 100));

            if (radTaxiDriverloss.SelectedItem.Text == "Yes" && Session["TAXILOSS"] == "0")
            {
                //txtTotalQuote.Text = (double.Parse(txtTotalQuote.Text) + Math.Round(Add)).ToString("##,###.00");
                Session["TAXILOSS"] = "100";
            }
            else if (lblModifyVehicle.Visible && radTaxiDriverloss.SelectedIndex == 0)
            {
                //txtTotalQuote.Text = (double.Parse(txtTotalQuote.Text) + Math.Round(Add)).ToString("##,###.00");
            }
            else
            {
                if (lblModifyVehicle.Visible && radTaxiDriverloss.SelectedIndex == 1)
                {
                    //txtTotalQuote.Text = (double.Parse(txtTotalQuote.Text) - Math.Round(Add)).ToString("##,###.00");
                }
            }

            //radGenMotoristCoverage.Focus();



        }
        #endregion Taxi Loss Income

        #endregion Additional Covarage

        #region No se utiliza
        private void ValidateVehicle()
        {

        }
        private bool ValidateDriver()
        {

            lblRecHeader.Text = "";

            if (TxtAge.Text == "16" || TxtAge.Text == "17")
            {
                if (txtPrimGrade.Text.Trim().Any(char.IsLetter))
                {
                    lblRecHeader.Text = "Primary Average Minor Grade Must be a Numeric Value.";
                    mpeSeleccion.Show();

                    //ddlVehicleUse.Focus();
                    return false;
                }
                else
                {
                    EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];
                    if (double.Parse(txtPrimGrade.Text.ToString()) <= 0)
                    {
                        lblRecHeader.Text = "Please add the Average Grade for the Minor.";
                        mpeSeleccion.Show();
                        //ddlVehicleUse.Focus();
                        return false;
                    }
                }
            }
            return true;

        }
        protected void btnCalculatePrem_Click(object sender, EventArgs e)
        {
            //txtTotalPremium.Text = "0.00";

            //if (txtCharges.Text.ToString().Trim() == "")
            //    txtCharges.Text = "0.00";

            //if (txtTotalPremiumPolicy.Text.ToString().Trim() == "")
            //    txtTotalPremiumPolicy.Text = "0.00";

            //for (int i = 0; i < GridVehicle.Rows.Count; i++)
            //{
            //    txtTotalPremium.Text = (double.Parse(txtTotalPremium.Text.ToString().Trim()) + double.Parse(GridVehicle.Rows[i].Cells[6].Text.ToString().Trim())).ToString();
            //}

            //txtTotalPremiumPolicy.Text = (double.Parse(txtTotalPremium.Text.ToString().Trim()) + double.Parse(txtCharges.Text.ToString().Trim())).ToString();



        }
        protected void btnAcceptAnswers_Click(object sender, EventArgs e)
        {

        }
        protected void ddlCompCollDed_SelectedIndexChanged(object sender, EventArgs e)
        {
            //ShowPremiumOnTheFly(false);
        }
        protected void rdbQ3No_CheckedChanged(object sender, EventArgs e)
        {

        }
        protected void ddlVehicleYear_TextChanged(object sender, EventArgs e)
        {

        }
        protected void TxtBILimitpp_SelectedIndexChanged(object sender, EventArgs e)
        {
            //ShowPremiumOnTheFly(false);
        }
        protected void txtOtherSurcharge_TextChanged(object sender, EventArgs e)
        {
            //ShowPremiumOnTheFly(false);
        }
        protected void ddlVehicleModel_SelectedIndexChanged(object sender, EventArgs e)
        {
            try
            {

                if (!chkIsBusinessAutoQuote.Checked && ddlVehicleMake.SelectedItem.Text == "MOTORCYCLE" && ddlVehicleModel.SelectedItem.Text != "")
                {
                    chkIsBusinessAutoQuote.Checked = true;
                    radMotorcycle.Enabled = true;
                    ddlVehicleModel.SelectedIndex = 0;
                    throw new Exception("Please specify if it is Motorcycle.");
                }
                else if (chkIsBusinessAutoQuote.Checked && ddlVehicleMake.SelectedItem.Text == "MOTORCYCLE" && ddlVehicleModel.SelectedItem.Text != "" && radMotorcycle.SelectedIndex != 0)
                {
                    ddlVehicleModel.SelectedIndex = 0;
                    throw new Exception("Please specify if it is Motorcycle.");
                }

            }

            catch (Exception exp)
            {
                lblRecHeader.Text = exp.Message;
                mpeSeleccion.Show();
            }
            //ddlIsland.Focus();
        }
        protected void ddlBankList_SelectedIndexChanged(object sender, EventArgs e)
        {
            lblBankListSelected.Text = GetBankListInfo(ddlBankList.SelectedItem.Value);
            lblBankListSelected2.Text = lblBankListSelected.Text;
            mpeBankList.Show();
        }
        protected void TxtDriverAge_TextChanged(object sender, EventArgs e)
        {

        }
        protected void TxtDriverGrade_TextChanged(object sender, EventArgs e)
        {

        }
        #endregion No se utiliza

        #region Refresh
        protected void Refresh_Page()
        {
            Session.Clear();
            TaskControl.DoubleInterest taskControl = new TaskControl.DoubleInterest(true);
            taskControl.Mode = 1; //ADD
            taskControl.isQuote = true;
            taskControl.TaskControlTypeID = int.Parse(LookupTables.LookupTables.GetID("TaskControlType", "Double Interest Policy Quote"));
            Session.Add("TaskControl", taskControl);
            //Response.Redirect("DoubleInterest.aspx");
        }

        protected void ValidateRefresh()
        {
            try
            {

                bool IsPageRefresh = false;

                //this section of code checks if the page postback is due to genuine submit by user or by pressing "refresh"

                //If the page was refreshed by the user (F5, Ctrl + R, Browser Refresh Button)
                if (!IsPostBack && Session["SessionId"] != null)
                {
                    Refresh_Page();

                }
                //Page was selected from the dropdown Top Banner or The page was opened for the first time
                else if (!IsPostBack)
                {

                    ViewState["ViewStateId"] = System.Guid.NewGuid().ToString();

                    Session["SessionId"] = ViewState["ViewStateId"].ToString();

                }
                //Page was selected from Top Banner while in the page itself  //Or a Postback happend within the page
                else
                {
                    if (ViewState["ViewStateId"] != null && Session["SessionId"] != null)
                    {
                        if (ViewState["ViewStateId"].ToString() != Session["SessionId"].ToString())
                        {

                            Session["SessionId"] = System.Guid.NewGuid().ToString();

                            ViewState["ViewStateId"] = Session["SessionId"].ToString();
                        }
                    }
                    else
                    {
                        Session["SessionId"] = System.Guid.NewGuid().ToString();

                        ViewState["ViewStateId"] = Session["SessionId"].ToString();
                    }
                }
            }
            catch (Exception exp)
            {
                throw new Exception("", exp);
            }
        }

        #endregion Refresh

        #region XML
        public void PolicyXML(int TaskControlID)
        {
            try
            {

                EPolicy.Login.Login cp = HttpContext.Current.User as EPolicy.Login.Login;

                SqlConnection conn4 = null;
                SqlDataReader rdr4 = null;
                XmlDocument xmlDoc = new XmlDocument();
                SqlConnection conn = null;
                SqlConnection conn0 = null;
                SqlConnection conn1 = null;
                SqlConnection conn5 = null;
                SqlConnection conn6 = null;


                string ConnectionString = ConfigurationManager.ConnectionStrings["GuardianConnectionString"].ConnectionString;
                string Encoding = "";

                conn = new SqlConnection(ConnectionString);
                conn0 = new SqlConnection(ConnectionString);
                conn1 = new SqlConnection(ConnectionString);
                conn4 = new SqlConnection(ConnectionString);
                conn5 = new SqlConnection(ConnectionString);
                conn6 = new SqlConnection(ConnectionString);

                conn4.Open();

                SqlCommand cmd4 = new SqlCommand("GetTaskControlByTaskControlID", conn4);

                cmd4.CommandType = System.Data.CommandType.StoredProcedure;

                cmd4.Parameters.AddWithValue("@TaskControlID", TaskControlID);
                cmd4.CommandTimeout = 0;
                rdr4 = cmd4.ExecuteReader();

                NAMECONVENTION = DateTime.Now.ToString("MM.dd.yyyy_hhmmss");

                rdr4.Read();

                SqlDataReader rdr6 = null;


                conn6.Open();

                SqlCommand cmd6 = new SqlCommand("GetReportAutoVehiclesInfoPolicy_VI", conn6);

                cmd6.CommandType = System.Data.CommandType.StoredProcedure;

                cmd6.Parameters.AddWithValue("@TaskControlID", TaskControlID);
                cmd6.CommandTimeout = 0;


                rdr6 = cmd6.ExecuteReader();

                int HasMotorcycle = 0;
                string ADDPREMIUM1 = "0";

                while (rdr6.Read())
                {
                    if (rdr6["IsMotorcycleScooter"].ToString().Trim() == "True")
                    {
                        HasMotorcycle = HasMotorcycle + 1;
                    }

                    if (rdr6["ADDPremium"].ToString().Trim() != "0")
                    {
                        ADDPREMIUM1 = "1";
                    }

                }
                rdr6.Read();

                SqlDataReader rdr5 = null;

                conn5.Open();

                SqlCommand cmd5 = new SqlCommand("GetReportAdditionalAutoDriversInfoPoliza_VI", conn5);

                cmd5.CommandType = System.Data.CommandType.StoredProcedure;

                cmd5.Parameters.AddWithValue("@TaskControlID", rdr4["TaskControlID"].ToString().Trim());
                cmd5.CommandTimeout = 0;
                rdr5 = cmd5.ExecuteReader();


                //if (rdr5.HasRows && rdr6["PolicyType"].ToString().Trim() != "BAP")
                //{
                //    Encoding = "UTF-16";
                //}
                //else if (rdr6["PolicyType"].ToString().Trim() == "BAP")
                //{
                //    Encoding = "UTF-16";
                //}
                //else
                //{
                Encoding = "UTF-16";
                //}


                #region XML Policy Info

                XmlNode docNode = xmlDoc.CreateXmlDeclaration("1.0", Encoding, null);
                xmlDoc.AppendChild(docNode);


                XmlElement xmlPolicy = xmlDoc.CreateElement("Policies");
                xmlDoc.AppendChild(xmlPolicy);

                XmlAttribute nsAttribute = xmlDoc.CreateAttribute("xmlns", "xsi",
                    "http://www.w3.org/2000/xmlns/");
                nsAttribute.Value = "http://www.w3.org/2001/XMLSchema-instance";
                xmlPolicy.Attributes.Append(nsAttribute);

                XmlAttribute nsAttribute2 = xmlDoc.CreateAttribute("xmlns",
                    "http://www.w3.org/2000/xmlns/");
                nsAttribute2.Value = "pps-simple-auto-policy";
                xmlPolicy.Attributes.Append(nsAttribute2);




                SqlDataReader rdr = null;


                conn.Open();

                SqlCommand cmd = new SqlCommand("GetReportAutoGeneralInfo_VI", conn);

                cmd.CommandType = System.Data.CommandType.StoredProcedure;

                cmd.Parameters.AddWithValue("@TaskControlID", rdr4["TaskControlID"].ToString().Trim());
                cmd.CommandTimeout = 0;


                rdr = cmd.ExecuteReader();


                SqlDataReader rdr1 = null;

                conn1.Open();

                SqlCommand cmd1 = new SqlCommand("GetReportAutoVehiclesInfoPolicy_VI", conn1);

                cmd1.CommandType = System.Data.CommandType.StoredProcedure;

                cmd1.Parameters.AddWithValue("@TaskControlID", rdr4["TaskControlID"].ToString().Trim());
                cmd1.CommandTimeout = 0;

                rdr1 = cmd1.ExecuteReader();


                SqlDataReader rdr0 = null;



                conn0.Open();

                SqlCommand cmd0 = new SqlCommand("GetReportAdditionalAutoDriversInfoPoliza_VI", conn0);

                cmd0.CommandType = System.Data.CommandType.StoredProcedure;

                cmd0.Parameters.AddWithValue("@TaskControlID", rdr4["TaskControlID"].ToString().Trim());
                cmd0.CommandTimeout = 0;


                rdr0 = cmd0.ExecuteReader();



                while (rdr.Read())
                {



                    XmlElement xmlPolicy1 = xmlDoc.CreateElement("Policy");  // Creacion del elemento
                    xmlPolicy.AppendChild(xmlPolicy1);  // Abajo de donde vas a "append" el elemento


                    XmlElement xmlPolicyID = xmlDoc.CreateElement("PolicyID");
                    xmlPolicy1.AppendChild(xmlPolicyID);

                    if (rdr["PRenewalNo"].ToString().Trim() != "")
                    {
                        try
                        {
                            if (rdr["Suffix"].ToString().Trim() != "")
                                xmlPolicyID.InnerText = rdr["PRenewalNo"].ToString().Contains("-") ? rdr["PRenewalNo"].ToString().Substring(0, rdr["PRenewalNo"].ToString().Trim().IndexOf("-")).Replace("-", "").Trim() + "-" + (int.Parse(rdr["Suffix"].ToString().Trim())).ToString() : rdr["PRenewalNo"].ToString() + "-" + rdr["Suffix"].ToString().Trim();
                            //rdr["PRenewalNo"].ToString();
                            //.Substring(0, rdr["PRenewalNo"].ToString().Trim().IndexOf("-")).Replace("-", "").Trim() + "-" + (int.Parse(rdr["Suffix"].ToString().Trim())).ToString();
                            else
                                xmlPolicyID.InnerText = rdr["PRenewalNo"].ToString().Contains("-") ? rdr["PRenewalNo"].ToString().Substring(0, rdr["PRenewalNo"].ToString().Trim().IndexOf("-")).Replace("-", "").Trim() + "-" + (int.Parse(rdr["Suffix"].ToString().Trim()) - 1).ToString() : rdr["PRenewalNo"].ToString() + "-" + rdr["Suffix"].ToString().Trim();
                            //xmlPolicyID.InnerText = rdr["PolicyType"].ToString().Trim();
                        }
                        catch (Exception ex)
                        { }
                    }
                    else
                    {
                        xmlPolicyID.InnerText = rdr["PolicyType"].ToString().Trim();
                    }

                    string PolicyType = "";
                    string PolSubType = "0";

                    if (rdr["PolicyType"].ToString().Trim() == "BAP")
                    {
                        //PolicyType = "BAP";
                        PolSubType = "Cml";
                    }
                    else
                    {
                        //PolicyType = "PAP";
                        PolSubType = "Pvt";
                    }


                    XmlElement xmlIncept = xmlDoc.CreateElement("Incept");
                    xmlPolicy1.AppendChild(xmlIncept);
                    xmlIncept.InnerText = DateTime.Parse(rdr["EffectiveDate"].ToString().Trim()).ToString("yyyy-MM-dd") + "T00:00:00";    // A donde y que columna de que reader vas a insertar en el texto

                    XmlElement xmlExpire = xmlDoc.CreateElement("Expire");
                    xmlPolicy1.AppendChild(xmlExpire);
                    xmlExpire.InnerText = DateTime.Parse(rdr["ExpirationDate"].ToString().Trim()).ToString("yyyy-MM-dd") + "T00:00:00";

                    if (RenewalNo == "")
                    {
                        XmlElement xmlRenewalOf = xmlDoc.CreateElement("RenewalOf");
                        //xmlPolicy1.AppendChild(xmlRenewalOf);
                        //xmlRenewalOf.InnerText = "";

                        XmlAttribute attribute1R = xmlDoc.CreateAttribute("xsi", "nil", "http://www.w3.org/2001/XMLSchema-instance"); // creacion de un atributo
                        if (RenewalNo != "")
                            attribute1R.Value = "true";  // atributo = a "true"
                        else
                            attribute1R.Value = "false";

                        xmlRenewalOf.Attributes.Append(attribute1R); // "appending el atributo"
                        xmlPolicy1.AppendChild(xmlRenewalOf);
                    }
                    else
                    {
                        XmlElement xmlRenewalOf = xmlDoc.CreateElement("RenewalOf");
                        xmlPolicy1.AppendChild(xmlRenewalOf);
                        xmlRenewalOf.InnerText = rdr["PRenewalNo"].ToString().Contains("-") ? rdr["PRenewalNo"].ToString().Substring(0, rdr["PRenewalNo"].ToString().Trim().IndexOf("-")).Replace("-", "").Trim() + "-" + (int.Parse(rdr["Suffix"].ToString().Trim()) - 1).ToString() : rdr["PRenewalNo"].ToString();// -1 porque es una renovacion del ano pasado
                    }

                    //if (rdr["Suffix"].ToString().Trim() != "")
                    //  xmlPolicyID.InnerText = rdr["PRenewalNo"].ToString().Substring(0, rdr["PRenewalNo"].ToString().Trim().IndexOf("-")).Replace("-", "").Trim() + "-" + (int.Parse(rdr["Suffix"].ToString().Trim()) - 1).ToString();


                    //int userID = int.Parse(cp.Identity.Name.Split("|".ToCharArray())[1]);

                    string AgentID = "000";
                    string ComRate = "0.0000000e+000";
                    string CompanyDealer = "000";

                    if (cp.IsInRole("ADMINISTRATOR") || cp.IsInRole("AUTO VI ADMINISTRATOR"))
                    {
                        AgentID = ddlAgent.SelectedItem.Value;
                        CompanyDealer = ddlCompanyDealer.SelectedItem.Value;

                    }
                    else
                    {
                        AgentID = ddlAgent.SelectedItem.Value;
                        CompanyDealer = ddlCompanyDealer.SelectedItem.Value;
                    }


                    DataTable DtCommision = GetCommissionAgentRateByAgentID(TaskControlID.ToString(), "22"); //GetCommissionAgentRateByAgentID(AgentID.ToString().Trim(), "22");

                    if (DtCommision.Rows.Count > 0)
                    {
                        ComRate = DtCommision.Rows[0]["CommissionRate"].ToString();

                        ComRate = (double.Parse(ComRate) / 100).ToString();
                    }
                    else
                    {
                        ComRate = "0.0000000e+000";
                    }

                    XmlElement xmlBrokerID = xmlDoc.CreateElement("BrokerID");
                    xmlPolicy1.AppendChild(xmlBrokerID);
                    xmlBrokerID.InnerText = rdr["AgentID"].ToString().Trim();//rdr["AgentID"].ToString().Trim(); = produccion; "9" = prueba

                    XmlElement xmlCanDate = xmlDoc.CreateElement("CanDate");
                    XmlAttribute attribute1 = xmlDoc.CreateAttribute("xsi", "nil", "http://www.w3.org/2001/XMLSchema-instance"); // creacion de un atributo
                    attribute1.Value = "true";  // atributo = a "true"
                    xmlCanDate.Attributes.Append(attribute1); // "appending el atributo"
                    xmlPolicy1.AppendChild(xmlCanDate);

                    XmlElement xmlTmpTime = xmlDoc.CreateElement("TmpTime");
                    XmlAttribute attribute2 = xmlDoc.CreateAttribute("xsi", "nil", "http://www.w3.org/2001/XMLSchema-instance");
                    attribute2.Value = "true";
                    xmlTmpTime.Attributes.Append(attribute2);
                    xmlPolicy1.AppendChild(xmlTmpTime);
                    //xmlTmpTime.InnerText = "0";

                    XmlElement xmlBinderID = xmlDoc.CreateElement("BinderID");
                    XmlAttribute attribute3 = xmlDoc.CreateAttribute("xsi", "nil", "http://www.w3.org/2001/XMLSchema-instance");
                    attribute3.Value = "true";
                    xmlBinderID.Attributes.Append(attribute3);
                    xmlPolicy1.AppendChild(xmlBinderID);
                    //xmlBinderID.InnerText = "";

                    XmlElement xmlComRate = xmlDoc.CreateElement("ComRate");
                    xmlPolicy1.AppendChild(xmlComRate);
                    xmlComRate.InnerText = ComRate;

                    XmlElement xmlClient = xmlDoc.CreateElement("Client");//Cuando viene de una renovacion envio el ClientID que me trajo anteriormente
                    xmlPolicy1.AppendChild(xmlClient);
                    xmlClient.InnerText = rdr["ClientIDPPS"].ToString().Trim() == "" ? "0" : rdr["ClientIDPPS"].ToString().Trim();

                    XmlElement xmlTag = xmlDoc.CreateElement("Tag");
                    XmlAttribute attribute4 = xmlDoc.CreateAttribute("xsi", "nil", "http://www.w3.org/2001/XMLSchema-instance");
                    attribute4.Value = "true";
                    xmlTag.Attributes.Append(attribute4);
                    xmlPolicy1.AppendChild(xmlTag);

                    XmlElement xmlPremium = xmlDoc.CreateElement("Premium");
                    xmlPolicy1.AppendChild(xmlPremium);
                    xmlPremium.InnerText = rdr["XML_NetPremiumP"].ToString().Trim();

                    XmlElement xmlDispImage = xmlDoc.CreateElement("DispImage");
                    xmlPolicy1.AppendChild(xmlDispImage);
                    xmlDispImage.InnerText = "Policy";

                    XmlElement xmlSpecEndorse = xmlDoc.CreateElement("SpecEndorse");
                    XmlAttribute attribute5 = xmlDoc.CreateAttribute("xsi", "nil", "http://www.w3.org/2001/XMLSchema-instance");
                    attribute5.Value = "true";
                    xmlSpecEndorse.Attributes.Append(attribute5);
                    xmlPolicy1.AppendChild(xmlSpecEndorse);

                    XmlElement xmlSID = xmlDoc.CreateElement("SID");
                    xmlPolicy1.AppendChild(xmlSID);
                    xmlSID.InnerText = "0";


                    XmlElement xmlUDPolicyID = xmlDoc.CreateElement("UDPolicyID");
                    //XmlAttribute attribute6 = xmlDoc.CreateAttribute("xsi", "nil", "http://www.w3.org/2001/XMLSchema-instance");
                    //attribute6.Value = "true";
                    //xmlUDPolicyID.Attributes.Append(attribute6);
                    xmlPolicy1.AppendChild(xmlUDPolicyID);
                    xmlUDPolicyID.InnerText = "0";

                    XmlElement xmlPreparedBy = xmlDoc.CreateElement("PreparedBy");
                    xmlPolicy1.AppendChild(xmlPreparedBy);
                    xmlPreparedBy.InnerText = rdr["EnteredBy"].ToString().Trim();

                    XmlElement xmlExcessLink = xmlDoc.CreateElement("ExcessLink");
                    xmlPolicy1.AppendChild(xmlExcessLink);
                    xmlExcessLink.InnerText = "0";

                    XmlElement xmlPolSubType = xmlDoc.CreateElement("PolSubType");
                    xmlPolicy1.AppendChild(xmlPolSubType);
                    xmlPolSubType.InnerText = PolSubType.ToString();//PolSubType.ToString() Pvt personal Cml comercial; "0" = Prueba

                    XmlElement xmlReinsPcnt = xmlDoc.CreateElement("ReinsPcnt");
                    xmlPolicy1.AppendChild(xmlReinsPcnt);
                    xmlReinsPcnt.InnerText = "0.0000000e+000";

                    XmlElement xmlAssessment = xmlDoc.CreateElement("Assessment");
                    xmlPolicy1.AppendChild(xmlAssessment);
                    xmlAssessment.InnerText = "0.0000";

                    XmlElement xmlPayDate = xmlDoc.CreateElement("PayDate");
                    XmlAttribute attribute7 = xmlDoc.CreateAttribute("xsi", "nil", "http://www.w3.org/2001/XMLSchema-instance");
                    attribute7.Value = "true";
                    xmlPayDate.Attributes.Append(attribute7);
                    xmlPolicy1.AppendChild(xmlPayDate);
                    //xmlPayDate.InnerText = "0";

                    XmlElement xmlPolRelTable = xmlDoc.CreateElement("PolRelTable");
                    xmlPolicy1.AppendChild(xmlPolRelTable);



                    XmlElement xmlPolRel = xmlDoc.CreateElement("PolRel");
                    xmlPolRelTable.AppendChild(xmlPolRel);

                    XmlElement xmlPolicy1ID1 = xmlDoc.CreateElement("PolicyID");
                    xmlPolRel.AppendChild(xmlPolicy1ID1);
                    xmlPolicy1ID1.InnerText = rdr["PolicyType"].ToString().Trim();

                    XmlElement xmlUpid = xmlDoc.CreateElement("Upid");
                    xmlPolRel.AppendChild(xmlUpid);
                    xmlUpid.InnerText = "0";

                    XmlElement xmlPolRelat = xmlDoc.CreateElement("Polrelat");
                    xmlPolRel.AppendChild(xmlPolRelat);
                    xmlPolRelat.InnerText = "NI";

                    XmlElement xmlEntNamesTable = xmlDoc.CreateElement("EntNamesTable");
                    xmlPolRel.AppendChild(xmlEntNamesTable);

                    #region DRIVERS

                    //Primary Driver

                    XmlElement xmlEntNames = xmlDoc.CreateElement("EntNames");
                    xmlEntNamesTable.AppendChild(xmlEntNames);

                    string Bflag;
                    string FirstName = "";
                    string Nsbyt = "0";

                    if (rdr["PolicyType"].ToString().Trim() == "BAP")
                    {
                        Bflag = "1";
                    }
                    else
                    {
                        Bflag = "0";
                    }

                    if (rdr["CompanyName"].ToString().Trim() == "" && rdr["LastNa1"].ToString().Trim() != "") //Bflag != "0" && 
                    {
                        XmlElement xmlLastName = xmlDoc.CreateElement("LastName");
                        xmlEntNames.AppendChild(xmlLastName);
                        xmlLastName.InnerText = rdr["LastNa1"].ToString().Trim();
                    }
                    else if (rdr["LastNa1"].ToString().Trim() == "" && rdr["CompanyName"].ToString().Trim() == "")
                    {
                        XmlElement xmlLastName = xmlDoc.CreateElement("LastName");
                        xmlEntNames.AppendChild(xmlLastName);
                        xmlLastName.InnerText = rdr["FirstNa"].ToString().Trim();
                    }
                    else
                    {
                        XmlElement xmlLastName = xmlDoc.CreateElement("LastName");
                        xmlEntNames.AppendChild(xmlLastName);
                        xmlLastName.InnerText = rdr["CompanyName"].ToString().Trim();
                    }

                    if (Bflag == "1" && rdr["CompanyName"].ToString().Trim() != "")
                        FirstName = "";
                    else
                        FirstName = rdr["FirstNa"].ToString().Trim();

                    XmlElement xmlFirstName = xmlDoc.CreateElement("FirstName");
                    xmlEntNames.AppendChild(xmlFirstName);
                    xmlFirstName.InnerText = FirstName;

                    XmlElement xmlMiddle = xmlDoc.CreateElement("Middle");
                    xmlEntNames.AppendChild(xmlMiddle);

                    XmlElement xmlUpid1 = xmlDoc.CreateElement("Upid");
                    xmlEntNames.AppendChild(xmlUpid1);
                    xmlUpid1.InnerText = "0";

                    //string DDB = rdr["Birthday"] != System.DBNull.Value ? (string)rdr["Birthday"] : "1900-01-01"; ;

                    XmlElement xmlDob = xmlDoc.CreateElement("Dob");
                    xmlEntNames.AppendChild(xmlDob);
                    xmlDob.InnerText = DateTime.Parse(rdr["Birthday"].ToString().Trim()).ToString("yyyy-MM-dd") + "T00:00:00";
                    //GXAuto.Rows[0]["IsPersonalAuto"] != System.DBNull.Value ? (bool)GXAuto.Rows[0]["IsPersonalAuto"] : false;

                    XmlElement xmlSex = xmlDoc.CreateElement("Sex");
                    xmlEntNames.AppendChild(xmlSex);
                    xmlSex.InnerText = rdr["Sex"].ToString().Trim();

                    XmlElement xmlMarital = xmlDoc.CreateElement("Marital");
                    xmlEntNames.AppendChild(xmlMarital);
                    xmlMarital.InnerText = rdr["MaritalStatus"].ToString().Trim();

                    XmlElement xmlYrsexp = xmlDoc.CreateElement("Yrsexp");
                    xmlEntNames.AppendChild(xmlYrsexp);
                    xmlYrsexp.InnerText = "0";

                    XmlElement xmlLicence = xmlDoc.CreateElement("License");
                    XmlAttribute attribute9 = xmlDoc.CreateAttribute("xsi", "nil", "http://www.w3.org/2001/XMLSchema-instance");
                    attribute9.Value = "true";
                    xmlLicence.Attributes.Append(attribute9);
                    xmlEntNames.AppendChild(xmlLicence);

                    XmlElement xmlState = xmlDoc.CreateElement("State");
                    xmlEntNames.AppendChild(xmlState);
                    xmlState.InnerText = rdr["State"].ToString().Trim();


                    XmlElement xmlSsn = xmlDoc.CreateElement("Ssn");
                    xmlEntNames.AppendChild(xmlSsn);
                    xmlSsn.InnerText = "SSn";

                    string BusFlag;
                    if (rdr["PolicyType"].ToString().Trim() == "BAP" && HasMotorcycle == 0)
                    {
                        XmlElement xmlBusFlag = xmlDoc.CreateElement("BusFlag");
                        xmlEntNames.AppendChild(xmlBusFlag);
                        xmlBusFlag.InnerText = "1";
                        BusFlag = xmlBusFlag.InnerText.ToString();
                    }
                    else
                    {
                        XmlElement xmlBusFlag = xmlDoc.CreateElement("BusFlag");
                        xmlEntNames.AppendChild(xmlBusFlag);
                        xmlBusFlag.InnerText = "0";
                        BusFlag = xmlBusFlag.InnerText.ToString();
                    }

                    if (ADDPREMIUM1 != "0")
                        Nsbyt = "8";
                    else
                        Nsbyt = "0";


                    XmlElement xmlNsbyt = xmlDoc.CreateElement("Nsbyt");
                    xmlEntNames.AppendChild(xmlNsbyt);
                    xmlNsbyt.InnerText = Nsbyt;

                    XmlElement xmlBusOther = xmlDoc.CreateElement("BusOther");
                    XmlAttribute attribute10 = xmlDoc.CreateAttribute("xsi", "nil", "http://www.w3.org/2001/XMLSchema-instance");
                    attribute10.Value = "true";
                    xmlBusOther.Attributes.Append(attribute10);
                    xmlEntNames.AppendChild(xmlBusOther);

                    XmlElement xmlBusType = xmlDoc.CreateElement("BusType");
                    if (BusFlag != "1" && HasMotorcycle == 0)
                    {
                        XmlAttribute attribute11 = xmlDoc.CreateAttribute("xsi", "nil", "http://www.w3.org/2001/XMLSchema-instance");
                        attribute11.Value = "true";
                        xmlBusType.Attributes.Append(attribute11);
                        xmlEntNames.AppendChild(xmlBusType);
                    }
                    xmlEntNames.AppendChild(xmlBusType);
                    if (BusFlag == "1" && rdr["PolicyType"].ToString().Trim() == "PAP" || BusFlag == "0" && rdr["PolicyType"].ToString().Trim() == "BAP" && HasMotorcycle > 0)
                        xmlBusType.InnerText = "256";
                    else if (BusFlag == "1" && rdr["PolicyType"].ToString().Trim() == "BAP" && HasMotorcycle == 0)
                        xmlBusType.InnerText = "32";
                    //else if (HasMotorcycle > 0)
                    //    xmlBusType.InnerText = "256";

                    XmlElement xmlClient1 = xmlDoc.CreateElement("Client");
                    XmlAttribute attribute12 = xmlDoc.CreateAttribute("xsi", "nil", "http://www.w3.org/2001/XMLSchema-instance");
                    attribute12.Value = "true";
                    xmlClient1.Attributes.Append(attribute12);
                    xmlEntNames.AppendChild(xmlClient1);
                    //xmlClient1.InnerText = rdr0["CustomerNo"].ToString().Trim();

                    XmlElement xmlPolRelat1 = xmlDoc.CreateElement("PolRelat");
                    XmlAttribute attribute13 = xmlDoc.CreateAttribute("xsi", "nil", "http://www.w3.org/2001/XMLSchema-instance");
                    attribute13.Value = "true";
                    xmlPolRelat1.Attributes.Append(attribute13);
                    xmlEntNames.AppendChild(xmlPolRelat1);

                    XmlElement xmlDispImage1 = xmlDoc.CreateElement("DispImage");
                    xmlEntNames.AppendChild(xmlDispImage1);
                    xmlDispImage1.InnerText = "Person";


                    #region Aditional Drivers
                    while (rdr0.Read()) // loop Drivers // Todos los additional driver se le cambio el busflag = "0" a peticion de Adam
                    {
                        string Gender = "";
                        string MaritalStatus = "";

                        XmlElement xmlPolRelDRV = xmlDoc.CreateElement("PolRel");
                        xmlPolRelTable.AppendChild(xmlPolRelDRV);

                        XmlElement xmlPolicy1ID1DRV = xmlDoc.CreateElement("PolicyID");
                        xmlPolRelDRV.AppendChild(xmlPolicy1ID1DRV);
                        xmlPolicy1ID1DRV.InnerText = rdr["PolicyType"].ToString().Trim();

                        XmlElement xmlUpidDRV = xmlDoc.CreateElement("Upid");
                        xmlPolRelDRV.AppendChild(xmlUpidDRV);
                        xmlUpidDRV.InnerText = "0";

                        XmlElement xmlPolRelatDRV = xmlDoc.CreateElement("Polrelat");
                        xmlPolRelDRV.AppendChild(xmlPolRelatDRV);
                        xmlPolRelatDRV.InnerText = "AD";

                        XmlElement xmlEntNamesTableDRV = xmlDoc.CreateElement("EntNamesTable");
                        xmlPolRelDRV.AppendChild(xmlEntNamesTableDRV);

                        XmlElement xmlEntNamesDRV = xmlDoc.CreateElement("EntNames");
                        xmlEntNamesTableDRV.AppendChild(xmlEntNamesDRV);

                        string BflagDRV;

                        if (rdr["PolicyType"].ToString().Trim() == "BAP")
                        {
                            BflagDRV = "0";
                        }
                        else
                        {
                            BflagDRV = "0";
                        }

                        //if (BflagDRV == "0") // rdr["CompanyName"].ToString().Trim() == "")
                        //{
                        XmlElement xmlLastName = xmlDoc.CreateElement("LastName");
                        xmlEntNamesDRV.AppendChild(xmlLastName);
                        xmlLastName.InnerText = rdr0["DriverLastName"].ToString().Trim();
                        //}
                        //else
                        //{
                        //    XmlElement xmlLastName = xmlDoc.CreateElement("LastName");
                        //    xmlEntNamesDRV.AppendChild(xmlLastName);
                        //    xmlLastName.InnerText = rdr["CompanyName"].ToString().Trim();
                        //}

                        XmlElement xmlFirstNameDRV = xmlDoc.CreateElement("FirstName");
                        xmlEntNamesDRV.AppendChild(xmlFirstNameDRV);
                        xmlFirstNameDRV.InnerText = rdr0["DriverName"].ToString().Trim();

                        XmlElement xmlMiddleDRV = xmlDoc.CreateElement("Middle");
                        xmlEntNamesDRV.AppendChild(xmlMiddleDRV);

                        XmlElement xmlUpid1DRV = xmlDoc.CreateElement("Upid");
                        xmlEntNamesDRV.AppendChild(xmlUpid1DRV);
                        xmlUpid1DRV.InnerText = "0";

                        //string DDB = rdr["Birthday"] != System.DBNull.Value ? (string)rdr["Birthday"] : "1900-01-01"; ;

                        XmlElement xmlDobDRV = xmlDoc.CreateElement("Dob");
                        xmlEntNamesDRV.AppendChild(xmlDobDRV);
                        xmlDobDRV.InnerText = DateTime.Parse(rdr0["DriverDateOfBirth"].ToString().Trim()).ToString("yyyy-MM-dd") + "T00:00:00";
                        //GXAuto.Rows[0]["IsPersonalAuto"] != System.DBNull.Value ? (bool)GXAuto.Rows[0]["IsPersonalAuto"] : false;

                        if (rdr0["DriverGender"].ToString().Trim() == "Male")
                        {
                            Gender = "M";
                        }
                        else if (rdr0["DriverGender"].ToString().Trim() == "Female")
                        {
                            Gender = "F";
                        }
                        else
                        {
                            Gender = "U";
                        }

                        XmlElement xmlSexDRV = xmlDoc.CreateElement("Sex");
                        xmlEntNamesDRV.AppendChild(xmlSexDRV);
                        xmlSexDRV.InnerText = Gender;

                        if (rdr0["DriverMaritalStatus"].ToString().Trim() == "Single")
                        {
                            MaritalStatus = "S";
                        }
                        else
                        {
                            MaritalStatus = "M";
                        }


                        XmlElement xmlMaritalDRV = xmlDoc.CreateElement("Marital");
                        xmlEntNamesDRV.AppendChild(xmlMaritalDRV);
                        xmlMaritalDRV.InnerText = MaritalStatus;

                        XmlElement xmlYrsexpDRV = xmlDoc.CreateElement("Yrsexp");
                        xmlEntNamesDRV.AppendChild(xmlYrsexpDRV);
                        xmlYrsexpDRV.InnerText = "0";

                        XmlElement xmlLicenceDRV = xmlDoc.CreateElement("License");
                        XmlAttribute attribute9DRV = xmlDoc.CreateAttribute("xsi", "nil", "http://www.w3.org/2001/XMLSchema-instance");
                        attribute9DRV.Value = "true";
                        xmlLicenceDRV.Attributes.Append(attribute9DRV);
                        xmlEntNamesDRV.AppendChild(xmlLicenceDRV);

                        XmlElement xmlStateDRV = xmlDoc.CreateElement("State");
                        xmlEntNamesDRV.AppendChild(xmlStateDRV);
                        xmlStateDRV.InnerText = rdr["State"].ToString().Trim();


                        XmlElement xmlSsnDRV = xmlDoc.CreateElement("Ssn");
                        xmlEntNamesDRV.AppendChild(xmlSsnDRV);
                        xmlSsnDRV.InnerText = "SSn";

                        string BusFlagDRV = "0";
                        if (rdr["PolicyType"].ToString().Trim() == "BAP")
                        {
                            XmlElement xmlBusFlagDRV = xmlDoc.CreateElement("BusFlag");
                            xmlEntNamesDRV.AppendChild(xmlBusFlagDRV);
                            xmlBusFlagDRV.InnerText = "0";
                            BusFlagDRV = xmlBusFlagDRV.InnerText.ToString();
                        }
                        else
                        {
                            XmlElement xmlBusFlagDRV = xmlDoc.CreateElement("BusFlag");
                            xmlEntNamesDRV.AppendChild(xmlBusFlagDRV);
                            xmlBusFlagDRV.InnerText = "0";
                            BusFlagDRV = xmlBusFlagDRV.InnerText.ToString();
                        }

                        XmlElement xmlNsbytDRV = xmlDoc.CreateElement("Nsbyt");
                        xmlEntNamesDRV.AppendChild(xmlNsbytDRV);
                        xmlNsbytDRV.InnerText = "0";

                        XmlElement xmlBusOtherDRV = xmlDoc.CreateElement("BusOther");
                        XmlAttribute attribute10DRV = xmlDoc.CreateAttribute("xsi", "nil", "http://www.w3.org/2001/XMLSchema-instance");
                        attribute10DRV.Value = "true";
                        xmlBusOtherDRV.Attributes.Append(attribute10DRV);
                        xmlEntNamesDRV.AppendChild(xmlBusOtherDRV);

                        XmlElement xmlBusTypeDRV = xmlDoc.CreateElement("BusType");
                        if (BusFlagDRV != "0")
                        {
                            XmlAttribute attribute11 = xmlDoc.CreateAttribute("xsi", "nil", "http://www.w3.org/2001/XMLSchema-instance");
                            attribute11.Value = "true";
                            xmlBusTypeDRV.Attributes.Append(attribute11);
                            xmlEntNamesDRV.AppendChild(xmlBusTypeDRV);
                        }
                        xmlEntNamesDRV.AppendChild(xmlBusTypeDRV);
                        if (rdr["PolicyType"].ToString().Trim() == "PAP")//BusFlagDRV == "1" &&
                            xmlBusTypeDRV.InnerText = "256";
                        else if (rdr["PolicyType"].ToString().Trim() == "BAP")//BusFlagDRV == "1" && 
                            xmlBusTypeDRV.InnerText = "32";

                        XmlElement xmlClient1DRV = xmlDoc.CreateElement("Client");
                        XmlAttribute attribute12DRV = xmlDoc.CreateAttribute("xsi", "nil", "http://www.w3.org/2001/XMLSchema-instance");
                        attribute12DRV.Value = "true";
                        xmlClient1DRV.Attributes.Append(attribute12DRV);
                        xmlEntNamesDRV.AppendChild(xmlClient1DRV);
                        //xmlClient1.InnerText = rdr0["CustomerNo"].ToString().Trim();

                        XmlElement xmlPolRelat1DRV = xmlDoc.CreateElement("PolRelat");
                        XmlAttribute attribute13DRV = xmlDoc.CreateAttribute("xsi", "nil", "http://www.w3.org/2001/XMLSchema-instance");
                        attribute13DRV.Value = "true";
                        xmlPolRelat1DRV.Attributes.Append(attribute13DRV);
                        xmlEntNamesDRV.AppendChild(xmlPolRelat1DRV);

                        XmlElement xmlDispImage1DRV = xmlDoc.CreateElement("DispImage");
                        xmlEntNamesDRV.AppendChild(xmlDispImage1DRV);
                        xmlDispImage1DRV.InnerText = "Person";
                    }
                    #endregion Aditional Drivers

                    #endregion Drivers


                    XmlElement xmlVehicleTable = xmlDoc.CreateElement("VehicleTable");
                    xmlPolicy1.AppendChild(xmlVehicleTable);

                    string Payee = "";

                    while (rdr1.Read())
                    {
                        string End22 = "0";
                        string End23 = "0";
                        string InsVal = "0";
                        string LicensePlateNo = "0";


                        XmlElement xmlVehicle = xmlDoc.CreateElement("Vehicle");
                        xmlVehicleTable.AppendChild(xmlVehicle);

                        XmlElement xmlVin = xmlDoc.CreateElement("Vin");
                        xmlVehicle.AppendChild(xmlVin);
                        xmlVin.InnerText = rdr1["VIN"].ToString().Trim();

                        XmlElement xmlPolicy1Id = xmlDoc.CreateElement("PolicyID");
                        xmlVehicle.AppendChild(xmlPolicy1Id);
                        xmlPolicy1Id.InnerText = rdr["PolicyType"].ToString().Trim();

                        if (rdr["HasCommercial"].ToString().Trim() == "1")
                        {
                            XmlElement xmlUseClass = xmlDoc.CreateElement("UseClass");
                            xmlVehicle.AppendChild(xmlUseClass);
                            xmlUseClass.InnerText = "CML";
                        }
                        else if (rdr["HasPrivatePassenger"].ToString().Trim() == "1")
                        {
                            XmlElement xmlUseClass = xmlDoc.CreateElement("UseClass");
                            xmlVehicle.AppendChild(xmlUseClass);
                            xmlUseClass.InnerText = "OTH";
                        }
                        else if (rdr["HasPrivate"].ToString().Trim() == "1")
                        {
                            XmlElement xmlUseClass = xmlDoc.CreateElement("UseClass");
                            xmlVehicle.AppendChild(xmlUseClass);
                            xmlUseClass.InnerText = "PVT";
                        }
                        else if (rdr["HasRental"].ToString().Trim() == "1")
                        {
                            XmlElement xmlUseClass = xmlDoc.CreateElement("UseClass");
                            xmlVehicle.AppendChild(xmlUseClass);
                            xmlUseClass.InnerText = "RNTL";
                        }
                        else if (rdr["HasTaxi"].ToString().Trim() == "1")
                        {
                            XmlElement xmlUseClass = xmlDoc.CreateElement("UseClass");
                            xmlVehicle.AppendChild(xmlUseClass);
                            xmlUseClass.InnerText = "TAXI";
                        }
                        else
                        {
                            XmlElement xmlUseClass = xmlDoc.CreateElement("UseClass");
                            xmlVehicle.AppendChild(xmlUseClass);
                            xmlUseClass.InnerText = "0";
                        }

                        if (rdr1["LicensePlateNo"].ToString().Trim() != "")
                        {
                            LicensePlateNo = rdr1["LicensePlateNo"].ToString().Trim();
                        }
                        else
                        {
                            LicensePlateNo = "0";
                        }

                        XmlElement xmlLicPlate = xmlDoc.CreateElement("LicPlate");
                        //XmlAttribute attribute14 = xmlDoc.CreateAttribute("xsi", "nil", "http://www.w3.org/2001/XMLSchema-instance");
                        //attribute14.Value = "true";
                        //xmlLicPlate.Attributes.Append(attribute14);
                        xmlVehicle.AppendChild(xmlLicPlate);
                        xmlLicPlate.InnerText = LicensePlateNo;


                        XmlElement xmlPurchDate = xmlDoc.CreateElement("PurchDate");
                        xmlVehicle.AppendChild(xmlPurchDate);
                        xmlPurchDate.InnerText = "1753-01-01T00:00:00";

                        XmlElement xmlActCost = xmlDoc.CreateElement("ActCost");
                        xmlVehicle.AppendChild(xmlActCost);
                        xmlActCost.InnerText = rdr1["VehicleValue"].ToString().Trim();

                        if (rdr1["PDPremium"].ToString() != "0")
                            InsVal = rdr1["VehicleValue"].ToString().Trim();
                        else
                            InsVal = "0.0000";

                        XmlElement xmlInsVal = xmlDoc.CreateElement("InsVal");
                        xmlVehicle.AppendChild(xmlInsVal);
                        xmlInsVal.InnerText = InsVal;

                        XmlElement xmlInsValFlag = xmlDoc.CreateElement("InsValFlag");
                        xmlVehicle.AppendChild(xmlInsValFlag);
                        //XmlAttribute attribute14 = xmlDoc.CreateAttribute("xsi", "nil", "http://www.w3.org/2001/XMLSchema-instance");
                        //attribute14.Value = "true";
                        //xmlInsValFlag.Attributes.Append(attribute14);
                        xmlInsValFlag.InnerText = "Actual Cash Value";

                        //if (rdr1["BankDesc"].ToString().Trim() != "")
                        //{
                        Payee = rdr1["BankDesc"].ToString().Trim();
                        //}

                        XmlElement xmlPayee = xmlDoc.CreateElement("Payee");
                        xmlVehicle.AppendChild(xmlPayee);
                        //XmlAttribute attribute15 = xmlDoc.CreateAttribute("xsi", "nil", "http://www.w3.org/2001/XMLSchema-instance");
                        //attribute15.Value = "true";
                        //xmlPayee.Attributes.Append(attribute15);
                        xmlPayee.InnerText = Payee;


                        XmlElement xmlIsland = xmlDoc.CreateElement("Island");
                        xmlVehicle.AppendChild(xmlIsland);
                        string Island = rdr1["Island"].ToString().Trim();
                        if (rdr1["Island"].ToString().Trim() != "")
                        {
                            if (Island == "St. Croix")
                                Island = "2";

                            if (Island == "St. John")
                                Island = "3";

                            if (Island == "St. Thomas")
                                Island = "1";
                        }
                        xmlIsland.InnerText = Island;

                        XmlElement xmlLeased = xmlDoc.CreateElement("Leased");
                        xmlVehicle.AppendChild(xmlLeased);
                        xmlLeased.InnerText = "0";

                        XmlElement xmlRegExp = xmlDoc.CreateElement("RegExp");
                        xmlVehicle.AppendChild(xmlRegExp);
                        xmlRegExp.InnerText = "0";

                        XmlElement xmlPAE = xmlDoc.CreateElement("PAE");
                        xmlVehicle.AppendChild(xmlPAE);
                        xmlPAE.InnerText = "0";

                        if (rdr1["RentalReim"].ToString() != "0")
                            End22 = "1";
                        else
                            End22 = "0";

                        XmlElement xmlEnd22 = xmlDoc.CreateElement("End22");
                        xmlVehicle.AppendChild(xmlEnd22);
                        xmlEnd22.InnerText = End22;

                        if (rdr["HasTaxi"].ToString().Trim() == "1" && rdr1["TaxiLossAmount"].ToString() != "0")
                            End23 = "1";
                        else
                            End23 = "0";

                        XmlElement xmlEnd23 = xmlDoc.CreateElement("End23");
                        xmlVehicle.AppendChild(xmlEnd23);
                        xmlEnd23.InnerText = End23;

                        XmlElement xmlPayeeID = xmlDoc.CreateElement("PayeeID");
                        xmlVehicle.AppendChild(xmlPayeeID);
                        xmlPayeeID.InnerText = rdr1["BankPPSID"].ToString().Trim();//"274";


                        XmlElement xmlTagNumber = xmlDoc.CreateElement("TagNumber");
                        XmlAttribute attribute16 = xmlDoc.CreateAttribute("xsi", "nil", "http://www.w3.org/2001/XMLSchema-instance");
                        attribute16.Value = "true";
                        xmlTagNumber.Attributes.Append(attribute16);
                        xmlVehicle.AppendChild(xmlTagNumber);

                        XmlElement xmlPhysVehicleTable = xmlDoc.CreateElement("PhysVehicleTable");
                        xmlVehicle.AppendChild(xmlPhysVehicleTable);

                        XmlElement xmlPhysVehicle = xmlDoc.CreateElement("PhysVehicle");
                        xmlPhysVehicleTable.AppendChild(xmlPhysVehicle);

                        XmlElement xmlVin1 = xmlDoc.CreateElement("Vin");
                        xmlPhysVehicle.AppendChild(xmlVin1);
                        xmlVin1.InnerText = rdr1["VIN"].ToString().Trim();

                        XmlElement xmlMYear = xmlDoc.CreateElement("MYear");
                        xmlPhysVehicle.AppendChild(xmlMYear);
                        xmlMYear.InnerText = rdr1["VehicleYear"].ToString().Trim();

                        XmlElement xmlMake = xmlDoc.CreateElement("Make");
                        xmlPhysVehicle.AppendChild(xmlMake);
                        xmlMake.InnerText = rdr1["VehicleMake"].ToString().Trim();


                        XmlElement xmlModel = xmlDoc.CreateElement("Model");
                        xmlPhysVehicle.AppendChild(xmlModel);
                        xmlModel.InnerText = rdr1["VehicleModel"].ToString().Trim();


                        XmlElement xmlBodyType = xmlDoc.CreateElement("BodyType");
                        xmlPhysVehicle.AppendChild(xmlBodyType);
                        xmlBodyType.InnerText = HasMotorcycle == 0 ? "PU" : "MC";//PU = Vehicle MC = Motorcycle

                        XmlElement xmlCylinder = xmlDoc.CreateElement("Cylinder");
                        xmlPhysVehicle.AppendChild(xmlCylinder);
                        xmlCylinder.InnerText = "0";

                        XmlElement xmlPassengers = xmlDoc.CreateElement("Passengers");
                        xmlPhysVehicle.AppendChild(xmlPassengers);
                        xmlPassengers.InnerText = rdr1["PassengersNo"].ToString().Trim();

                        XmlElement xmlTwoTon = xmlDoc.CreateElement("TwoTon");
                        string TwoTon = rdr1["Over2Tons"].ToString().Trim();
                        xmlPhysVehicle.AppendChild(xmlTwoTon);
                        if (rdr1["Over2Tons"].ToString().Trim() != "")
                        {
                            if (TwoTon == "True")
                                TwoTon = "1";

                            if (TwoTon == "False")
                                TwoTon = "0";
                        }
                        xmlTwoTon.InnerText = TwoTon;

                        XmlElement xmlSalvaged = xmlDoc.CreateElement("Salvaged");
                        xmlPhysVehicle.AppendChild(xmlSalvaged);
                        xmlSalvaged.InnerText = "0";

                        XmlElement xmlVehicleCvrgTable = xmlDoc.CreateElement("VehicleCvrgTable");
                        xmlVehicle.AppendChild(xmlVehicleCvrgTable);



                        SqlConnection conn2 = null;
                        SqlDataReader rdr2 = null;

                        conn2 = new SqlConnection(ConnectionString);

                        conn2.Open();

                        SqlCommand cmd2 = new SqlCommand("GetReportAutoVehiclesInfoPolicy_VI", conn2);

                        cmd2.CommandType = System.Data.CommandType.StoredProcedure;

                        cmd2.Parameters.AddWithValue("@TaskControlID", rdr4["TaskControlID"].ToString().Trim());
                        cmd2.CommandTimeout = 0;

                        rdr2 = cmd2.ExecuteReader();

                        #region All Coverages

                        //while (rdr2.Read())
                        //{
                        //rdr2.Read();

                        double TotalAgeSurcharge = 0;
                        double RentalReim = 0;
                        double TaxiLossIncome = 0;
                        double ADDPremium = 0;

                        if (rdr1["UnderAgeSurcharge"].ToString().Trim() != "NULL")
                        {
                            if (double.Parse(rdr1["UnderAgeSurcharge"].ToString().Trim()) != 0.0)
                            {
                                int CoverageCount = 0;

                                double UnderAgeSurcharge = 0; //CompPremium = 0, CollPremium = 0, BIPremium = 0, PDPremium = 0, MPPremium = 0 ;



                                if (rdr1["CompPremium"].ToString() != "0")
                                {
                                    CoverageCount++;
                                }

                                if (rdr1["CollPremium"].ToString() != "0")
                                {
                                    CoverageCount++;
                                }

                                if (rdr1["BIPremium"].ToString() != "0")
                                {
                                    CoverageCount++;
                                }

                                if (rdr1["PDPremium"].ToString() != "0")
                                {
                                    CoverageCount++;
                                }

                                if (rdr1["MPPremium"].ToString() != "0")
                                {
                                    CoverageCount++;
                                }

                                if (CoverageCount > 0)
                                {
                                    UnderAgeSurcharge = double.Parse(rdr1["UnderAgeSurcharge"].ToString().Trim()) / CoverageCount;

                                    TotalAgeSurcharge = Math.Round(UnderAgeSurcharge, 0);
                                }


                            }
                        }

                        if (rdr1["TaxiLossAmount"].ToString() != "NULL")
                        {
                            if (rdr1["TaxiLossAmount"].ToString() == "0")
                            {
                                if (rdr1["RentalReim"].ToString() != "0")
                                {
                                    RentalReim = double.Parse(rdr1["RentalReim"].ToString());

                                }
                            }

                            if (rdr1["TaxiLossAmount"].ToString() != "0")
                            {
                                TaxiLossIncome = double.Parse(rdr1["TaxiLossAmount"].ToString());
                            }
                        }
                        if (rdr1["ADDPremium"].ToString() != "0")
                        {
                            ADDPremium = double.Parse(rdr1["ADDPremium"].ToString());
                        }

                        string hello = rdr1["CompPremium"].ToString();
                        if (rdr1["CompPremium"].ToString() != "0")
                        {
                            //35%
                            if (rdr1["PolicyType"].ToString().Trim() == "BAP")
                            {
                                XmlElement xmlVehicleCvrg = xmlDoc.CreateElement("VehicleCvrg");
                                xmlVehicleCvrgTable.AppendChild(xmlVehicleCvrg);

                                XmlElement xmlVin2 = xmlDoc.CreateElement("Vin");
                                xmlVehicleCvrg.AppendChild(xmlVin2);
                                xmlVin2.InnerText = rdr1["VIN"].ToString().Trim();

                                XmlElement xmlReinsAsl = xmlDoc.CreateElement("ReinsAsl");
                                xmlVehicleCvrg.AppendChild(xmlReinsAsl);
                                xmlReinsAsl.InnerText = "12212";

                                XmlElement xmlPolicy1ID2 = xmlDoc.CreateElement("PolicyID");
                                xmlVehicleCvrg.AppendChild(xmlPolicy1ID2);
                                xmlPolicy1ID2.InnerText = rdr["PolicyType"].ToString().Trim();

                                XmlElement xmlLim1 = xmlDoc.CreateElement("Lim1");
                                xmlVehicleCvrg.AppendChild(xmlLim1);
                                xmlLim1.InnerText = decimal.Parse(rdr1["ComprehensiveDedu"].ToString().Trim().Replace("$", "")).ToString();

                                XmlElement xmlLim2 = xmlDoc.CreateElement("Lim2");
                                xmlVehicleCvrg.AppendChild(xmlLim2);
                                xmlLim2.InnerText = "0.0000";

                                XmlElement xmlPremium1 = xmlDoc.CreateElement("Premium");
                                xmlVehicleCvrg.AppendChild(xmlPremium1);
                                xmlPremium1.InnerText = Math.Round((double.Parse(rdr1["NetCompPremium"].ToString().Trim()) * 0.35), 0).ToString();

                                //Math.Round((double.Parse(rdr1["NetCompPremium"].ToString().Trim()) * (1 - (35 / 100))), 0).ToString();
                                //Math.Round(((double.Parse(rdr1["CompPremium"].ToString().Trim()) + TotalAgeSurcharge) * (1 - (double.Parse(rdr1["TotalDiscountPct"].ToString().Trim()) / 100))), 0).ToString();
                            }
                            else //PAP
                            {
                                XmlElement xmlVehicleCvrg = xmlDoc.CreateElement("VehicleCvrg");
                                xmlVehicleCvrgTable.AppendChild(xmlVehicleCvrg);

                                XmlElement xmlVin2 = xmlDoc.CreateElement("Vin");
                                xmlVehicleCvrg.AppendChild(xmlVin2);
                                xmlVin2.InnerText = rdr1["VIN"].ToString().Trim();

                                XmlElement xmlReinsAsl = xmlDoc.CreateElement("ReinsAsl");
                                xmlVehicleCvrg.AppendChild(xmlReinsAsl);
                                xmlReinsAsl.InnerText = "05211";

                                XmlElement xmlPolicy1ID2 = xmlDoc.CreateElement("PolicyID");
                                xmlVehicleCvrg.AppendChild(xmlPolicy1ID2);
                                xmlPolicy1ID2.InnerText = rdr["PolicyType"].ToString().Trim();

                                XmlElement xmlLim1 = xmlDoc.CreateElement("Lim1");
                                xmlVehicleCvrg.AppendChild(xmlLim1);
                                xmlLim1.InnerText = decimal.Parse(rdr1["ComprehensiveDedu"].ToString().Trim().Replace("$", "")).ToString();

                                XmlElement xmlLim2 = xmlDoc.CreateElement("Lim2");
                                xmlVehicleCvrg.AppendChild(xmlLim2);
                                xmlLim2.InnerText = "0.0000";

                                XmlElement xmlPremium1 = xmlDoc.CreateElement("Premium");
                                xmlVehicleCvrg.AppendChild(xmlPremium1);
                                xmlPremium1.InnerText = Math.Round((double.Parse(rdr1["NetCompPremium"].ToString().Trim()) * 0.35), 0).ToString();
                                //Math.Round(((double.Parse(rdr1["CompPremium"].ToString().Trim()) + TotalAgeSurcharge) * (1-(double.Parse(rdr1["TotalDiscountPct"].ToString().Trim()) / 100))),0).ToString();
                            }

                            //65%
                            if (rdr1["PolicyType"].ToString().Trim() == "BAP")
                            {
                                XmlElement xmlVehicleCvrg = xmlDoc.CreateElement("VehicleCvrg");
                                xmlVehicleCvrgTable.AppendChild(xmlVehicleCvrg);

                                XmlElement xmlVin2 = xmlDoc.CreateElement("Vin");
                                xmlVehicleCvrg.AppendChild(xmlVin2);
                                xmlVin2.InnerText = rdr1["VIN"].ToString().Trim();

                                XmlElement xmlReinsAsl = xmlDoc.CreateElement("ReinsAsl");
                                xmlVehicleCvrg.AppendChild(xmlReinsAsl);
                                xmlReinsAsl.InnerText = "11212";

                                XmlElement xmlPolicy1ID2 = xmlDoc.CreateElement("PolicyID");
                                xmlVehicleCvrg.AppendChild(xmlPolicy1ID2);
                                xmlPolicy1ID2.InnerText = rdr["PolicyType"].ToString().Trim();

                                XmlElement xmlLim1 = xmlDoc.CreateElement("Lim1");
                                xmlVehicleCvrg.AppendChild(xmlLim1);
                                xmlLim1.InnerText = decimal.Parse(rdr1["ComprehensiveDedu"].ToString().Trim().Replace("$", "")).ToString();

                                XmlElement xmlLim2 = xmlDoc.CreateElement("Lim2");
                                xmlVehicleCvrg.AppendChild(xmlLim2);
                                xmlLim2.InnerText = "0.0000";

                                XmlElement xmlPremium1 = xmlDoc.CreateElement("Premium");
                                xmlVehicleCvrg.AppendChild(xmlPremium1);
                                xmlPremium1.InnerText = Math.Round((double.Parse(rdr1["NetCompPremium"].ToString().Trim()) * 0.65), 0).ToString();

                                //Math.Round((double.Parse(rdr1["NetCompPremium"].ToString().Trim()) * (1 - (35 / 100))), 0).ToString();
                                //Math.Round(((double.Parse(rdr1["CompPremium"].ToString().Trim()) + TotalAgeSurcharge) * (1 - (double.Parse(rdr1["TotalDiscountPct"].ToString().Trim()) / 100))), 0).ToString();
                            }
                            else //PAP
                            {
                                XmlElement xmlVehicleCvrg = xmlDoc.CreateElement("VehicleCvrg");
                                xmlVehicleCvrgTable.AppendChild(xmlVehicleCvrg);

                                XmlElement xmlVin2 = xmlDoc.CreateElement("Vin");
                                xmlVehicleCvrg.AppendChild(xmlVin2);
                                xmlVin2.InnerText = rdr1["VIN"].ToString().Trim();

                                XmlElement xmlReinsAsl = xmlDoc.CreateElement("ReinsAsl");
                                xmlVehicleCvrg.AppendChild(xmlReinsAsl);
                                xmlReinsAsl.InnerText = "04211";

                                XmlElement xmlPolicy1ID2 = xmlDoc.CreateElement("PolicyID");
                                xmlVehicleCvrg.AppendChild(xmlPolicy1ID2);
                                xmlPolicy1ID2.InnerText = rdr["PolicyType"].ToString().Trim();

                                XmlElement xmlLim1 = xmlDoc.CreateElement("Lim1");
                                xmlVehicleCvrg.AppendChild(xmlLim1);
                                xmlLim1.InnerText = decimal.Parse(rdr1["ComprehensiveDedu"].ToString().Trim().Replace("$", "")).ToString();

                                XmlElement xmlLim2 = xmlDoc.CreateElement("Lim2");
                                xmlVehicleCvrg.AppendChild(xmlLim2);
                                xmlLim2.InnerText = "0.0000";

                                XmlElement xmlPremium1 = xmlDoc.CreateElement("Premium");
                                xmlVehicleCvrg.AppendChild(xmlPremium1);
                                xmlPremium1.InnerText = Math.Round((double.Parse(rdr1["NetCompPremium"].ToString().Trim()) * 0.65), 0).ToString();
                                //Math.Round(((double.Parse(rdr1["CompPremium"].ToString().Trim()) + TotalAgeSurcharge) * (1-(double.Parse(rdr1["TotalDiscountPct"].ToString().Trim()) / 100))),0).ToString();
                            }
                        }

                        if (rdr1["CollPremium"].ToString() != "0")
                        {
                            if (rdr1["PolicyType"].ToString().Trim() == "BAP")
                            {
                                XmlElement xmlVehicleCvrg = xmlDoc.CreateElement("VehicleCvrg");
                                xmlVehicleCvrgTable.AppendChild(xmlVehicleCvrg);

                                XmlElement xmlVin2 = xmlDoc.CreateElement("Vin");
                                xmlVehicleCvrg.AppendChild(xmlVin2);
                                xmlVin2.InnerText = rdr1["VIN"].ToString().Trim();

                                XmlElement xmlReinsAsl = xmlDoc.CreateElement("ReinsAsl");
                                xmlVehicleCvrg.AppendChild(xmlReinsAsl);
                                xmlReinsAsl.InnerText = "13212";

                                XmlElement xmlPolicy1ID2 = xmlDoc.CreateElement("PolicyID");
                                xmlVehicleCvrg.AppendChild(xmlPolicy1ID2);
                                xmlPolicy1ID2.InnerText = rdr["PolicyType"].ToString().Trim();

                                XmlElement xmlLim1 = xmlDoc.CreateElement("Lim1");
                                xmlVehicleCvrg.AppendChild(xmlLim1);
                                xmlLim1.InnerText = decimal.Parse(rdr1["CollisionDedu"].ToString().Trim().Replace("$", "")).ToString();

                                XmlElement xmlLim2 = xmlDoc.CreateElement("Lim2");
                                xmlVehicleCvrg.AppendChild(xmlLim2);
                                xmlLim2.InnerText = "0.0000";

                                XmlElement xmlPremium1 = xmlDoc.CreateElement("Premium");
                                xmlVehicleCvrg.AppendChild(xmlPremium1);
                                xmlPremium1.InnerText = rdr1["NetCollPremium"].ToString().Trim();
                                //Math.Round(((double.Parse(rdr1["CollPremium"].ToString().Trim()) + TotalAgeSurcharge) * (1-(double.Parse(rdr1["TotalDiscountPct"].ToString().Trim()) / 100))),0).ToString();
                                xmlPremium1.InnerText = Math.Round((double.Parse(rdr1["NetCollPremium"].ToString().Trim()) + RentalReim + TaxiLossIncome + ADDPremium), 0).ToString();
                            }
                            else //PAP
                            {
                                XmlElement xmlVehicleCvrg = xmlDoc.CreateElement("VehicleCvrg");
                                xmlVehicleCvrgTable.AppendChild(xmlVehicleCvrg);

                                XmlElement xmlVin2 = xmlDoc.CreateElement("Vin");
                                xmlVehicleCvrg.AppendChild(xmlVin2);
                                xmlVin2.InnerText = rdr1["VIN"].ToString().Trim();

                                XmlElement xmlReinsAsl = xmlDoc.CreateElement("ReinsAsl");
                                xmlVehicleCvrg.AppendChild(xmlReinsAsl);
                                xmlReinsAsl.InnerText = "06211";

                                XmlElement xmlPolicy1ID2 = xmlDoc.CreateElement("PolicyID");
                                xmlVehicleCvrg.AppendChild(xmlPolicy1ID2);
                                xmlPolicy1ID2.InnerText = rdr["PolicyType"].ToString().Trim();

                                XmlElement xmlLim1 = xmlDoc.CreateElement("Lim1");
                                xmlVehicleCvrg.AppendChild(xmlLim1);
                                xmlLim1.InnerText = decimal.Parse(rdr1["CollisionDedu"].ToString().Trim().Replace("$", "")).ToString();

                                XmlElement xmlLim2 = xmlDoc.CreateElement("Lim2");
                                xmlVehicleCvrg.AppendChild(xmlLim2);
                                xmlLim2.InnerText = "0.0000";

                                XmlElement xmlPremium1 = xmlDoc.CreateElement("Premium");
                                xmlVehicleCvrg.AppendChild(xmlPremium1);
                                xmlPremium1.InnerText = rdr1["NetCollPremium"].ToString().Trim();
                                //Math.Round(((double.Parse(rdr1["CollPremium"].ToString().Trim()) + TotalAgeSurcharge) * (1-(double.Parse(rdr1["TotalDiscountPct"].ToString().Trim()) / 100))),0).ToString();
                                xmlPremium1.InnerText = Math.Round((double.Parse(rdr1["NetCollPremium"].ToString().Trim()) + RentalReim + TaxiLossIncome + ADDPremium), 0).ToString();
                            }
                        }

                        if (rdr1["BIPremium"].ToString() != "0")
                        {
                            if (rdr1["PolicyType"].ToString().Trim() == "BAP")
                            {
                                XmlElement xmlVehicleCvrg = xmlDoc.CreateElement("VehicleCvrg");
                                xmlVehicleCvrgTable.AppendChild(xmlVehicleCvrg);

                                XmlElement xmlVin2 = xmlDoc.CreateElement("Vin");
                                xmlVehicleCvrg.AppendChild(xmlVin2);
                                xmlVin2.InnerText = rdr1["VIN"].ToString().Trim();

                                XmlElement xmlReinsAsl = xmlDoc.CreateElement("ReinsAsl");
                                xmlVehicleCvrg.AppendChild(xmlReinsAsl);
                                xmlReinsAsl.InnerText = "08194";

                                XmlElement xmlPolicy1ID2 = xmlDoc.CreateElement("PolicyID");
                                xmlVehicleCvrg.AppendChild(xmlPolicy1ID2);
                                xmlPolicy1ID2.InnerText = rdr["PolicyType"].ToString().Trim();

                                string coll = rdr1["BIPPLimit"].ToString();
                                if (rdr1["BIPPLimit"].ToString() == "$10,000/$20,000")
                                {
                                    XmlElement xmlLim1 = xmlDoc.CreateElement("Lim1");
                                    xmlVehicleCvrg.AppendChild(xmlLim1);
                                    xmlLim1.InnerText = "10000.0000";

                                    XmlElement xmlLim2 = xmlDoc.CreateElement("Lim2");
                                    xmlVehicleCvrg.AppendChild(xmlLim2);
                                    xmlLim2.InnerText = "20000.0000";
                                }
                                else if (rdr1["BIPPLimit"].ToString() == "$10,000/$25,000")
                                {
                                    XmlElement xmlLim1 = xmlDoc.CreateElement("Lim1");
                                    xmlVehicleCvrg.AppendChild(xmlLim1);
                                    xmlLim1.InnerText = "10000.0000";

                                    XmlElement xmlLim2 = xmlDoc.CreateElement("Lim2");
                                    xmlVehicleCvrg.AppendChild(xmlLim2);
                                    xmlLim2.InnerText = "25000.0000";
                                }
                                else if (rdr1["BIPPLimit"].ToString() == "$10,000/$50,000")
                                {
                                    XmlElement xmlLim1 = xmlDoc.CreateElement("Lim1");
                                    xmlVehicleCvrg.AppendChild(xmlLim1);
                                    xmlLim1.InnerText = "10000.0000";

                                    XmlElement xmlLim2 = xmlDoc.CreateElement("Lim2");
                                    xmlVehicleCvrg.AppendChild(xmlLim2);
                                    xmlLim2.InnerText = "50000.0000";
                                }
                                else if (rdr1["BIPPLimit"].ToString() == "0")
                                {
                                    XmlElement xmlLim1 = xmlDoc.CreateElement("Lim1");
                                    xmlVehicleCvrg.AppendChild(xmlLim1);
                                    xmlLim1.InnerText = "0.0000";

                                    XmlElement xmlLim2 = xmlDoc.CreateElement("Lim2");
                                    xmlVehicleCvrg.AppendChild(xmlLim2);
                                    xmlLim2.InnerText = "0.0000";
                                }
                                XmlElement xmlPremium1 = xmlDoc.CreateElement("Premium");
                                xmlVehicleCvrg.AppendChild(xmlPremium1);
                                xmlPremium1.InnerText = Math.Round(double.Parse(rdr1["NetBIPremium"].ToString().Trim()), 0).ToString();
                                //rdr1["NetBIPremium"].ToString().Trim();

                                //Math.Round(((double.Parse(rdr1["BIPremium"].ToString().Trim()) + TotalAgeSurcharge) * (1-(double.Parse(rdr1["TotalDiscountPct"].ToString().Trim()) / 100))),0).ToString();
                            }
                            else //PAP
                            {
                                XmlElement xmlVehicleCvrg = xmlDoc.CreateElement("VehicleCvrg");
                                xmlVehicleCvrgTable.AppendChild(xmlVehicleCvrg);

                                XmlElement xmlVin2 = xmlDoc.CreateElement("Vin");
                                xmlVehicleCvrg.AppendChild(xmlVin2);
                                xmlVin2.InnerText = rdr1["VIN"].ToString().Trim();

                                XmlElement xmlReinsAsl = xmlDoc.CreateElement("ReinsAsl");
                                xmlVehicleCvrg.AppendChild(xmlReinsAsl);
                                xmlReinsAsl.InnerText = "01192";

                                XmlElement xmlPolicy1ID2 = xmlDoc.CreateElement("PolicyID");
                                xmlVehicleCvrg.AppendChild(xmlPolicy1ID2);
                                xmlPolicy1ID2.InnerText = rdr["PolicyType"].ToString().Trim();

                                if (rdr1["BIPPLimit"].ToString() == "$10,000/$20,000")
                                {
                                    XmlElement xmlLim1 = xmlDoc.CreateElement("Lim1");
                                    xmlVehicleCvrg.AppendChild(xmlLim1);
                                    xmlLim1.InnerText = "10000.0000";

                                    XmlElement xmlLim2 = xmlDoc.CreateElement("Lim2");
                                    xmlVehicleCvrg.AppendChild(xmlLim2);
                                    xmlLim2.InnerText = "20000.0000";
                                }
                                else if (rdr1["BIPPLimit"].ToString() == "$10,000/$25,000")
                                {
                                    XmlElement xmlLim1 = xmlDoc.CreateElement("Lim1");
                                    xmlVehicleCvrg.AppendChild(xmlLim1);
                                    xmlLim1.InnerText = "10000.0000";

                                    XmlElement xmlLim2 = xmlDoc.CreateElement("Lim2");
                                    xmlVehicleCvrg.AppendChild(xmlLim2);
                                    xmlLim2.InnerText = "25000.0000";
                                }
                                else if (rdr1["BIPPLimit"].ToString() == "$10,000/$50,000")
                                {
                                    XmlElement xmlLim1 = xmlDoc.CreateElement("Lim1");
                                    xmlVehicleCvrg.AppendChild(xmlLim1);
                                    xmlLim1.InnerText = "10000.0000";

                                    XmlElement xmlLim2 = xmlDoc.CreateElement("Lim2");
                                    xmlVehicleCvrg.AppendChild(xmlLim2);
                                    xmlLim2.InnerText = "50000.0000";
                                }
                                else if (rdr1["BIPPLimit"].ToString() == "0")
                                {
                                    XmlElement xmlLim1 = xmlDoc.CreateElement("Lim1");
                                    xmlVehicleCvrg.AppendChild(xmlLim1);
                                    xmlLim1.InnerText = "0.0000";

                                    XmlElement xmlLim2 = xmlDoc.CreateElement("Lim2");
                                    xmlVehicleCvrg.AppendChild(xmlLim2);
                                    xmlLim2.InnerText = "0.0000";
                                }

                                XmlElement xmlPremium1 = xmlDoc.CreateElement("Premium");
                                xmlVehicleCvrg.AppendChild(xmlPremium1);
                                xmlPremium1.InnerText = Math.Round(double.Parse(rdr1["NetBIPremium"].ToString().Trim()), 0).ToString();
                                //rdr1["NetBIPremium"].ToString().Trim();
                                //Math.Round(((double.Parse(rdr1["BIPremium"].ToString().Trim()) + TotalAgeSurcharge) * (1 - (double.Parse(rdr1["TotalDiscountPct"].ToString().Trim()) / 100))), 0).ToString();
                            }
                        }

                        if (rdr1["PDPremium"].ToString() != "0")
                        {
                            if (rdr1["PolicyType"].ToString().Trim() == "BAP")
                            {
                                XmlElement xmlVehicleCvrg = xmlDoc.CreateElement("VehicleCvrg");
                                xmlVehicleCvrgTable.AppendChild(xmlVehicleCvrg);

                                XmlElement xmlVin2 = xmlDoc.CreateElement("Vin");
                                xmlVehicleCvrg.AppendChild(xmlVin2);
                                xmlVin2.InnerText = rdr1["VIN"].ToString().Trim();

                                XmlElement xmlReinsAsl = xmlDoc.CreateElement("ReinsAsl");
                                xmlVehicleCvrg.AppendChild(xmlReinsAsl);
                                xmlReinsAsl.InnerText = "09194";

                                XmlElement xmlPolicy1ID2 = xmlDoc.CreateElement("PolicyID");
                                xmlVehicleCvrg.AppendChild(xmlPolicy1ID2);
                                xmlPolicy1ID2.InnerText = rdr["PolicyType"].ToString().Trim();

                                XmlElement xmlLim1 = xmlDoc.CreateElement("Lim1");
                                xmlVehicleCvrg.AppendChild(xmlLim1);
                                xmlLim1.InnerText = decimal.Parse(rdr1["PDLimit"].ToString().Trim().Replace("$", "")).ToString();

                                XmlElement xmlLim2 = xmlDoc.CreateElement("Lim2");
                                xmlVehicleCvrg.AppendChild(xmlLim2);
                                xmlLim2.InnerText = "0.0000";

                                XmlElement xmlPremium1 = xmlDoc.CreateElement("Premium");
                                xmlVehicleCvrg.AppendChild(xmlPremium1);
                                xmlPremium1.InnerText = Math.Round(double.Parse(rdr1["NetPDPremium"].ToString().Trim()), 0).ToString();
                                //rdr1["NetPDPremium"].ToString().Trim();
                                //Math.Round(((double.Parse(rdr1["PDPremium"].ToString().Trim()) + TotalAgeSurcharge) * (1 - (double.Parse(rdr1["TotalDiscountPct"].ToString().Trim()) / 100))), 0).ToString();
                            }
                            else //PAP
                            {
                                XmlElement xmlVehicleCvrg = xmlDoc.CreateElement("VehicleCvrg");
                                xmlVehicleCvrgTable.AppendChild(xmlVehicleCvrg);

                                XmlElement xmlVin2 = xmlDoc.CreateElement("Vin");
                                xmlVehicleCvrg.AppendChild(xmlVin2);
                                xmlVin2.InnerText = rdr1["VIN"].ToString().Trim();

                                XmlElement xmlReinsAsl = xmlDoc.CreateElement("ReinsAsl");
                                xmlVehicleCvrg.AppendChild(xmlReinsAsl);
                                xmlReinsAsl.InnerText = "02192";

                                XmlElement xmlPolicy1ID2 = xmlDoc.CreateElement("PolicyID");
                                xmlVehicleCvrg.AppendChild(xmlPolicy1ID2);
                                xmlPolicy1ID2.InnerText = rdr["PolicyType"].ToString().Trim();

                                XmlElement xmlLim1 = xmlDoc.CreateElement("Lim1");
                                xmlVehicleCvrg.AppendChild(xmlLim1);
                                xmlLim1.InnerText = decimal.Parse(rdr1["PDLimit"].ToString().Trim().Replace("$", "")).ToString();

                                XmlElement xmlLim2 = xmlDoc.CreateElement("Lim2");
                                xmlVehicleCvrg.AppendChild(xmlLim2);
                                xmlLim2.InnerText = "0.0000";

                                XmlElement xmlPremium1 = xmlDoc.CreateElement("Premium");
                                xmlVehicleCvrg.AppendChild(xmlPremium1);
                                xmlPremium1.InnerText = Math.Round(double.Parse(rdr1["NetPDPremium"].ToString().Trim()), 0).ToString();
                                //rdr1["NetPDPremium"].ToString().Trim();
                                //Math.Round(((double.Parse(rdr1["PDPremium"].ToString().Trim()) + TotalAgeSurcharge) * (1 - (double.Parse(rdr1["TotalDiscountPct"].ToString().Trim()) / 100))), 0).ToString();
                            }
                        }

                        if (rdr1["MPPremium"].ToString() != "0")
                        {
                            if (rdr1["PolicyType"].ToString().Trim() == "BAP")
                            {
                                XmlElement xmlVehicleCvrg = xmlDoc.CreateElement("VehicleCvrg");
                                xmlVehicleCvrgTable.AppendChild(xmlVehicleCvrg);

                                XmlElement xmlVin2 = xmlDoc.CreateElement("Vin");
                                xmlVehicleCvrg.AppendChild(xmlVin2);
                                xmlVin2.InnerText = rdr1["VIN"].ToString().Trim();

                                XmlElement xmlReinsAsl = xmlDoc.CreateElement("ReinsAsl");
                                xmlVehicleCvrg.AppendChild(xmlReinsAsl);
                                xmlReinsAsl.InnerText = "10194";

                                XmlElement xmlPolicy1ID2 = xmlDoc.CreateElement("PolicyID");
                                xmlVehicleCvrg.AppendChild(xmlPolicy1ID2);
                                xmlPolicy1ID2.InnerText = rdr["PolicyType"].ToString().Trim();

                                XmlElement xmlLim1 = xmlDoc.CreateElement("Lim1");
                                xmlVehicleCvrg.AppendChild(xmlLim1);
                                xmlLim1.InnerText = "1000.0000";

                                XmlElement xmlLim2 = xmlDoc.CreateElement("Lim2");
                                xmlVehicleCvrg.AppendChild(xmlLim2);
                                xmlLim2.InnerText = "5000.0000";

                                XmlElement xmlPremium1 = xmlDoc.CreateElement("Premium");
                                xmlVehicleCvrg.AppendChild(xmlPremium1);
                                xmlPremium1.InnerText = Math.Round(double.Parse(rdr1["NetMPPremium"].ToString().Trim()), 0).ToString();
                                //rdr1["NetMPPremium"].ToString().Trim();
                                //Math.Round(((double.Parse(rdr1["MPPremium"].ToString().Trim()) + TotalAgeSurcharge) * (1 - (double.Parse(rdr1["TotalDiscountPct"].ToString().Trim()) / 100))), 0).ToString();
                            }
                            else //PAP
                            {
                                XmlElement xmlVehicleCvrg = xmlDoc.CreateElement("VehicleCvrg");
                                xmlVehicleCvrgTable.AppendChild(xmlVehicleCvrg);

                                XmlElement xmlVin2 = xmlDoc.CreateElement("Vin");
                                xmlVehicleCvrg.AppendChild(xmlVin2);
                                xmlVin2.InnerText = rdr1["VIN"].ToString().Trim();

                                XmlElement xmlReinsAsl = xmlDoc.CreateElement("ReinsAsl");
                                xmlVehicleCvrg.AppendChild(xmlReinsAsl);
                                xmlReinsAsl.InnerText = "03192";

                                XmlElement xmlPolicy1ID2 = xmlDoc.CreateElement("PolicyID");
                                xmlVehicleCvrg.AppendChild(xmlPolicy1ID2);
                                xmlPolicy1ID2.InnerText = rdr["PolicyType"].ToString().Trim();

                                XmlElement xmlLim1 = xmlDoc.CreateElement("Lim1");
                                xmlVehicleCvrg.AppendChild(xmlLim1);
                                xmlLim1.InnerText = "1000.0000";

                                XmlElement xmlLim2 = xmlDoc.CreateElement("Lim2");
                                xmlVehicleCvrg.AppendChild(xmlLim2);
                                xmlLim2.InnerText = "5000.0000";

                                XmlElement xmlPremium1 = xmlDoc.CreateElement("Premium");
                                xmlVehicleCvrg.AppendChild(xmlPremium1);
                                xmlPremium1.InnerText = Math.Round(double.Parse(rdr1["NetMPPremium"].ToString().Trim()), 0).ToString();
                                //rdr1["NetMPPremium"].ToString().Trim();
                                //Math.Round(((double.Parse(rdr1["MPPremium"].ToString().Trim()) + TotalAgeSurcharge) * (1 - (double.Parse(rdr1["TotalDiscountPct"].ToString().Trim()) / 100))), 0).ToString();
                            }
                        }

                        if (rdr1["MotoristPremium"].ToString() != "0")
                        {
                            if (rdr1["PolicyType"].ToString().Trim() == "BAP")
                            {
                                XmlElement xmlVehicleCvrg = xmlDoc.CreateElement("VehicleCvrg");
                                xmlVehicleCvrgTable.AppendChild(xmlVehicleCvrg);

                                XmlElement xmlVin2 = xmlDoc.CreateElement("Vin");
                                xmlVehicleCvrg.AppendChild(xmlVin2);
                                xmlVin2.InnerText = rdr1["VIN"].ToString().Trim();

                                XmlElement xmlReinsAsl = xmlDoc.CreateElement("ReinsAsl");
                                xmlVehicleCvrg.AppendChild(xmlReinsAsl);
                                xmlReinsAsl.InnerText = "81194";

                                XmlElement xmlPolicy1ID2 = xmlDoc.CreateElement("PolicyID");
                                xmlVehicleCvrg.AppendChild(xmlPolicy1ID2);
                                xmlPolicy1ID2.InnerText = rdr["PolicyType"].ToString().Trim();

                                XmlElement xmlLim1 = xmlDoc.CreateElement("Lim1");
                                xmlVehicleCvrg.AppendChild(xmlLim1);
                                xmlLim1.InnerText = "0.0000";

                                XmlElement xmlLim2 = xmlDoc.CreateElement("Lim2");
                                xmlVehicleCvrg.AppendChild(xmlLim2);
                                xmlLim2.InnerText = "0.0000";

                                XmlElement xmlPremium1 = xmlDoc.CreateElement("Premium");
                                xmlVehicleCvrg.AppendChild(xmlPremium1);
                                xmlPremium1.InnerText = rdr1["MotoristPremium"].ToString().Trim();
                            }
                            else //PAP
                            {
                                XmlElement xmlVehicleCvrg = xmlDoc.CreateElement("VehicleCvrg");
                                xmlVehicleCvrgTable.AppendChild(xmlVehicleCvrg);

                                XmlElement xmlVin2 = xmlDoc.CreateElement("Vin");
                                xmlVehicleCvrg.AppendChild(xmlVin2);
                                xmlVin2.InnerText = rdr1["VIN"].ToString().Trim();

                                XmlElement xmlReinsAsl = xmlDoc.CreateElement("ReinsAsl");
                                xmlVehicleCvrg.AppendChild(xmlReinsAsl);
                                xmlReinsAsl.InnerText = "78192";

                                XmlElement xmlPolicy1ID2 = xmlDoc.CreateElement("PolicyID");
                                xmlVehicleCvrg.AppendChild(xmlPolicy1ID2);
                                xmlPolicy1ID2.InnerText = rdr["PolicyType"].ToString().Trim();

                                XmlElement xmlLim1 = xmlDoc.CreateElement("Lim1");
                                xmlVehicleCvrg.AppendChild(xmlLim1);
                                xmlLim1.InnerText = "0.0000";

                                XmlElement xmlLim2 = xmlDoc.CreateElement("Lim2");
                                xmlVehicleCvrg.AppendChild(xmlLim2);
                                xmlLim2.InnerText = "0.0000";

                                XmlElement xmlPremium1 = xmlDoc.CreateElement("Premium");
                                xmlVehicleCvrg.AppendChild(xmlPremium1);
                                xmlPremium1.InnerText = rdr1["MotoristPremium"].ToString().Trim();
                            }
                        }
                        else
                        {
                            if (rdr1["PolicyType"].ToString().Trim() == "BAP")
                            {
                                XmlElement xmlVehicleCvrg = xmlDoc.CreateElement("VehicleCvrg");
                                xmlVehicleCvrgTable.AppendChild(xmlVehicleCvrg);

                                XmlElement xmlVin2 = xmlDoc.CreateElement("Vin");
                                xmlVehicleCvrg.AppendChild(xmlVin2);
                                xmlVin2.InnerText = rdr1["VIN"].ToString().Trim();

                                XmlElement xmlReinsAsl = xmlDoc.CreateElement("ReinsAsl");
                                xmlVehicleCvrg.AppendChild(xmlReinsAsl);
                                xmlReinsAsl.InnerText = "81194";

                                XmlElement xmlPolicy1ID2 = xmlDoc.CreateElement("PolicyID");
                                xmlVehicleCvrg.AppendChild(xmlPolicy1ID2);
                                xmlPolicy1ID2.InnerText = rdr["PolicyType"].ToString().Trim();

                                XmlElement xmlLim1 = xmlDoc.CreateElement("Lim1");
                                xmlVehicleCvrg.AppendChild(xmlLim1);
                                xmlLim1.InnerText = "0.0000";

                                XmlElement xmlLim2 = xmlDoc.CreateElement("Lim2");
                                xmlVehicleCvrg.AppendChild(xmlLim2);
                                xmlLim2.InnerText = "0.0000";

                                XmlElement xmlPremium1 = xmlDoc.CreateElement("Premium");
                                xmlVehicleCvrg.AppendChild(xmlPremium1);
                                xmlPremium1.InnerText = "0";
                            }
                            else //PAP
                            {
                                XmlElement xmlVehicleCvrg = xmlDoc.CreateElement("VehicleCvrg");
                                xmlVehicleCvrgTable.AppendChild(xmlVehicleCvrg);

                                XmlElement xmlVin2 = xmlDoc.CreateElement("Vin");
                                xmlVehicleCvrg.AppendChild(xmlVin2);
                                xmlVin2.InnerText = rdr1["VIN"].ToString().Trim();

                                XmlElement xmlReinsAsl = xmlDoc.CreateElement("ReinsAsl");
                                xmlVehicleCvrg.AppendChild(xmlReinsAsl);
                                xmlReinsAsl.InnerText = "78192";

                                XmlElement xmlPolicy1ID2 = xmlDoc.CreateElement("PolicyID");
                                xmlVehicleCvrg.AppendChild(xmlPolicy1ID2);
                                xmlPolicy1ID2.InnerText = rdr["PolicyType"].ToString().Trim();

                                XmlElement xmlLim1 = xmlDoc.CreateElement("Lim1");
                                xmlVehicleCvrg.AppendChild(xmlLim1);
                                xmlLim1.InnerText = "0.0000";

                                XmlElement xmlLim2 = xmlDoc.CreateElement("Lim2");
                                xmlVehicleCvrg.AppendChild(xmlLim2);
                                xmlLim2.InnerText = "0.0000";

                                XmlElement xmlPremium1 = xmlDoc.CreateElement("Premium");
                                xmlVehicleCvrg.AppendChild(xmlPremium1);
                                xmlPremium1.InnerText = "0";
                            }
                        }


                        #endregion

                        conn2.Close();
                    }

                    XmlElement xmlClientTable = xmlDoc.CreateElement("ClientTable");
                    xmlPolicy1.AppendChild(xmlClientTable);

                    XmlElement xmlClient0 = xmlDoc.CreateElement("Client");
                    xmlClientTable.AppendChild(xmlClient0);

                    XmlElement xmlClient2 = xmlDoc.CreateElement("Client");
                    xmlClient0.AppendChild(xmlClient2);
                    xmlClient2.InnerText = "0";//rdr["CustomerNo"].ToString().Trim();


                    XmlElement xmlMaddr1 = xmlDoc.CreateElement("Maddr1");
                    xmlClient0.AppendChild(xmlMaddr1);
                    xmlMaddr1.InnerText = rdr["Adds1"].ToString().Trim();

                    XmlElement xmlMaddr2 = xmlDoc.CreateElement("Maddr2");
                    xmlClient0.AppendChild(xmlMaddr2);
                    xmlMaddr2.InnerText = rdr["Adds2"].ToString().Trim();

                    XmlElement xmlMaddr3 = xmlDoc.CreateElement("Maddr3");
                    xmlClient0.AppendChild(xmlMaddr3);
                    xmlMaddr3.InnerText = "";

                    XmlElement xmlMcity = xmlDoc.CreateElement("Mcity");
                    xmlClient0.AppendChild(xmlMcity);
                    xmlMcity.InnerText = rdr["City"].ToString().Trim();

                    XmlElement xmlMstate = xmlDoc.CreateElement("Mstate");
                    xmlClient0.AppendChild(xmlMstate);
                    xmlMstate.InnerText = rdr["State"].ToString().Trim();

                    XmlElement xmlMnation = xmlDoc.CreateElement("Mnation");
                    xmlClient0.AppendChild(xmlMnation);
                    xmlMnation.InnerText = "";

                    XmlElement xmlMzip = xmlDoc.CreateElement("Mzip");
                    xmlClient0.AppendChild(xmlMzip);
                    xmlMzip.InnerText = rdr["Zip"].ToString().Trim();

                    XmlElement xmlRaddr1 = xmlDoc.CreateElement("Raddr1");
                    xmlClient0.AppendChild(xmlRaddr1);
                    xmlRaddr1.InnerText = rdr["Adds1PH"].ToString().Trim();

                    XmlElement xmlRaddr2 = xmlDoc.CreateElement("Raddr2");
                    xmlClient0.AppendChild(xmlRaddr2);
                    xmlRaddr2.InnerText = rdr["Adds2PH"].ToString().Trim();

                    XmlElement xmlRaddr3 = xmlDoc.CreateElement("Raddr3");
                    xmlClient0.AppendChild(xmlRaddr3);
                    xmlRaddr3.InnerText = "";

                    XmlElement xmlRcity = xmlDoc.CreateElement("Rcity");
                    xmlClient0.AppendChild(xmlRcity);
                    xmlRcity.InnerText = rdr["CityPH"].ToString().Trim();

                    XmlElement xmlRstate = xmlDoc.CreateElement("Rstate");
                    xmlClient0.AppendChild(xmlRstate);
                    xmlRstate.InnerText = rdr["StatePH"].ToString().Trim();

                    XmlElement xmlRnation = xmlDoc.CreateElement("Rnation");
                    xmlClient0.AppendChild(xmlRnation);
                    xmlRnation.InnerText = "";

                    XmlElement xmlRzip = xmlDoc.CreateElement("Rzip");
                    xmlClient0.AppendChild(xmlRzip);
                    xmlRzip.InnerText = rdr["ZipPH"].ToString().Trim();

                    XmlElement xmlWphone = xmlDoc.CreateElement("Wphone");
                    xmlClient0.AppendChild(xmlWphone);
                    xmlWphone.InnerText = rdr["JobPhone"].ToString().Trim();

                    XmlElement xmlRphone = xmlDoc.CreateElement("Rphone");
                    xmlClient0.AppendChild(xmlRphone);
                    xmlRphone.InnerText = rdr["Cellular"].ToString().Trim();

                    XmlElement xmlCsbyt = xmlDoc.CreateElement("Csbyt");
                    xmlClient0.AppendChild(xmlCsbyt);
                    xmlCsbyt.InnerText = "0";

                    XmlElement xmlCphone = xmlDoc.CreateElement("Cphone");
                    xmlClient0.AppendChild(xmlCphone);
                    xmlCphone.InnerText = rdr["Cellular"].ToString().Trim();

                    XmlElement xmlEaddr = xmlDoc.CreateElement("Eaddr");
                    xmlClient0.AppendChild(xmlEaddr);
                    xmlEaddr.InnerText = rdr["Email"].ToString().Trim();



                }
                #endregion

                conn.Close();
                conn0.Close(); // cierra las conecciones

                conn1.Close();



                xmlDoc.Save(System.Configuration.ConfigurationManager.AppSettings["XMLPathName"] + NAMECONVENTION + ".xml"); // save

                string XMLFile = NAMECONVENTION + ".xml";

                string fileName = "XMLFile11.xsd";

                string fileName1 = NAMECONVENTION + ".XSD";
                string sourcePath = System.Configuration.ConfigurationManager.AppSettings["XMLPathName"];
                string targetPath = System.Configuration.ConfigurationManager.AppSettings["XMLPathName"];

                // Use Path class to manipulate file and directory paths.
                string sourceFile = System.IO.Path.Combine(sourcePath, fileName);
                string destFile = System.IO.Path.Combine(targetPath, fileName1);

                // To copy a file to another location and 
                // overwrite the destination file if it already exists.
                System.IO.File.Copy(sourceFile, destFile, true);

                string XMLdestFile = System.IO.Path.Combine(targetPath, XMLFile);

                System.IO.StreamReader XML = new System.IO.StreamReader(XMLdestFile);
                string xmlString = XML.ReadToEnd();
                xmlString = xmlString.Replace("\r\n", "");
                //string xmlString = System.IO.File.ReadAllText(XMLdestFile);

                conn5.Close();
                conn6.Close();

                conn4.Close();

                if (!(HttpContext.Current.Request.Url.ToString().Contains("localhost")))
                {
                    XMLInsert(xmlString, TaskControlID);
                }
                //XMLUpdate();
            }

            catch (Exception ecp)
            {
                throw new Exception(ecp.Message.ToString());
            }
        }

        public void XMLInsert(string xmlString, int TaskControlID)
        {
            try
            {
                EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

                //if (taskControl.RenewalNo != "")
                //{
                //UpdatePolicyFromPPSByTaskControlID(TaskControlID, taskControl.RenewalNo.ToString().Substring(0, taskControl.RenewalNo.ToString().Trim().IndexOf("-")) , "");
                //string RenewalPolicyNumber = "";
                //RenewalPolicyNumber = taskControl.RenewalNo.ToString().Substring(0, taskControl.RenewalNo.ToString().Trim().IndexOf("-")).Replace("-", "").Replace("BAP", "").Replace("PAP", "").Trim();
                //taskControl.PolicyNo = int.Parse(RenewalPolicyNumber).ToString("0000000");
                //return;
                //}

                XmlDocument XmlDoc = new XmlDocument();

                System.Data.SqlClient.SqlConnection cn = new System.Data.SqlClient.SqlConnection();

                //cn.ConnectionString = @"Data Source=GIC-MSQL\PPSSQLSERVER;Initial Catalog=GICPPSDATA;User ID=URClaims;password=3G@TD@t!1";
                //Producción
                // cn.ConnectionString = @"Data Source=GIC-MSQL\PPSSQLSERVER;Initial Catalog=GICPPSDATA;User ID=URClaims;password=3G@TD@t!1";
                //Prueba

                cn.ConnectionString = System.Configuration.ConfigurationManager.AppSettings["ConnStrPPS"].ToString();
                //@"Data Source=GIC-MSQL\PPSSQLSERVER;Initial Catalog=AgentTestData;User ID=URClaims;password=3G@TD@t!1";

                cn.Open();

                //XmlDocument xmlDoc = new XmlDocument();
                //xmlDoc.LoadXml(xmlString);

                SqlCommand cmd = new SqlCommand();
                cmd.Connection = cn;
                //cmd.CommandType = CommandType.StoredProcedure;
                cmd.CommandType = CommandType.Text;
                cmd.CommandText = "exec sproc_ConsumeXMLePPS @xmlIn, @xmlOut = @x output, @PremiumEndorAmount = 0";
                cmd.Parameters.Clear();
                cmd.Parameters.Add("@x", SqlDbType.Xml).Direction = ParameterDirection.Output;
                cmd.Parameters.AddWithValue("@xmlIN", xmlString);
                //cmd.Parameters.AddWithValue("@PremiumEndorAmount", "0");
                cmd.CommandTimeout = 0;

                int c = cmd.ExecuteNonQuery();
                string f = cmd.Parameters[0].Value.ToString();

                if (f.Trim() == "")
                {
                    cn.Close();
                    throw new Exception("Policy not found in PPS");
                }

                XmlDoc.LoadXml(f);
                cn.Close();

                bool FilledName = false, FilledAddress = false, FilledAsl = false;

                #region Xml

                XmlNodeList XmlBase = XmlDoc.GetElementsByTagName("Policy");

                foreach (XmlNode XmlPolicyBase in XmlBase)
                {

                    PolicyNumber = XmlPolicyBase["PolicyID"].InnerText;
                    ClientID = XmlPolicyBase["Client"].InnerText;


                    UpdatePolicyFromPPSByTaskControlID(TaskControlID, PolicyNumber.Replace("PAP", "").Replace("BAP", ""), ClientID);

                    //taskControl.CustomerNo = ClientID.ToString();
                    //taskControl.Customer.CustomerNo = ClientID.ToString();

                    taskControl.Customer.Description = ClientID;// ClientID de PPS se guarda en Description del Customer

                    PolicyNumber = PolicyNumber.ToString().Replace("PAP", "").Replace("BAP", "");
                    taskControl.PolicyNo = PolicyNumber.Contains("-") ? int.Parse(PolicyNumber.ToString().Substring(0, PolicyNumber.ToString().Trim().IndexOf("-"))).ToString("0000000") : int.Parse(PolicyNumber).ToString("0000000");
                    Session["TaskControl"] = taskControl;

                    XmlDoc.Save(System.Configuration.ConfigurationManager.AppSettings["XMLPathName"] + NAMECONVENTION + "PPS" + ".xml");
                    //if (XmlPolicyBase.HasChildNodes)
                    //{
                    //    //XmlNode Child = XmlPolicyBase.FirstChild;
                    //    foreach (XmlNode Childs in XmlPolicyBase.ChildNodes)
                    //    {
                    //        if (Childs.Name == "PolRelTable")
                    //        {
                    //            foreach (XmlElement ChildsElement in Childs)
                    //            {
                    //                if (ChildsElement.HasChildNodes)
                    //                {
                    //                    foreach (XmlElement GrandChildElements in ChildsElement)
                    //                    {
                    //                        if (GrandChildElements.Name == "EntNamesTable")
                    //                        {
                    //                            foreach (XmlElement GreatGrandElements in GrandChildElements)
                    //                            {
                    //                                if (!(FilledName))  //Solo leerá los campos una vez, tomando los primeros que lea
                    //                                {
                    //                                    //txtName.Text = GreatGrandElements["FirstName"].InnerText +
                    //                                    //    ((GreatGrandElements["Middle"].InnerText != "") ? " " + GreatGrandElements["Middle"].InnerText : "") + " " +
                    //                                    //    GreatGrandElements["LastName"].InnerText;

                    //                                    //txtInsuredDOB.Text = DateTime.Parse(GreatGrandElements["Dob"].InnerText).ToShortDateString();
                    //                                    //txtInsuredLicense.Text = GreatGrandElements["License"].InnerText;
                    //                                    //txtState.Text = GreatGrandElements["State"].InnerText;

                    //                                    //InsuredName = txtName.Text;
                    //                                    //InsuredState = txtState.Text;
                    //                                    FilledName = true;
                    //                                }
                    //                            }
                    //                        }
                    //                    }
                    //                }
                    //            }
                    //        }

                    //        else if (Childs.Name == "VehicleTable")
                    //        {
                    //            foreach (XmlElement ChildsElement in Childs)
                    //            {
                    //                //Para validar
                    //                //if ((ChildsElement["LicPlate"].InnerText == txtPlateVerification.Text.Trim().ToUpper()) ||
                    //                //    (ChildsElement["Vin"].InnerText == txtVINVerification.Text.Trim().ToUpper()))
                    //                {
                    //                    InsuredVin = ChildsElement["Vin"].InnerText;
                    //                    InsuredPlate = ChildsElement["LicPlate"].InnerText;

                    //                    //txtVIN.Text = txtVINVerification.Text.Trim();
                    //                    //txtPlate.Text = txtPlateVerification.Text.Trim().ToUpper();

                    //                    //InsuredVin = txtVINVerification.Text;
                    //                    //InsuredPlate = txtPlateVerification.Text;

                    //                    if (ChildsElement.HasChildNodes)
                    //                    {
                    //                        foreach (XmlElement GrandChilds in ChildsElement)
                    //                        {
                    //                            if (GrandChilds.Name == "PhysVehicleTable")
                    //                            {
                    //                                foreach (XmlElement GrandChildsElements in GrandChilds)
                    //                                {
                    //                                    ddlVehicleMake.SelectedIndex = ddlVehicleMake.Items.IndexOf(ddlVehicleMake.Items.FindByText((GrandChildsElements["Make"].InnerText.Trim()).ToString()));

                    //                                    if (int.Parse(ddlVehicleMake.SelectedItem.Value) > 0)
                    //                                        //FillModelDDListByPPS(ddlVehicleMake.SelectedItem.Value.ToString());

                    //                                    ddlVehicleModel.SelectedIndex = ddlVehicleModel.Items.IndexOf(ddlVehicleModel.Items.FindByText((GrandChildsElements["Model"].InnerText.TrimEnd()).ToString()));
                    //                                    ddlVehicleYear.SelectedIndex = ddlVehicleYear.Items.IndexOf(ddlVehicleYear.Items.FindByText((GrandChildsElements["MYear"].InnerText.TrimEnd()).ToString())); //GrandChildsElements["MYear"].InnerText;
                    //                                    ///ddlBroker.Items.IndexOf(ddlBroker.Items.FindByValue(int.Parse(XmlPolicyBase["BrokerID"].InnerText).ToString()));                                                                
                    //                                }
                    //                            }
                    //                            else if (GrandChilds.Name == "VehicleCvrgTable")
                    //                            {
                    //                                foreach (XmlElement GrandChildsElements in GrandChilds)
                    //                                {
                    //                                    if (!(FilledAsl))  //Solo leerá los campos una vez, tomando los primeros que lea
                    //                                    {
                    //                                        ReinsAsl = GrandChildsElements["ReinsAsl"].InnerText.ToString();

                    //                                        //GetCoverage();

                    //                                        //FilledAsl = true;
                    //                                    }
                    //                                }
                    //                            }
                    //                        }
                    //                    }
                    //                }
                    //            }
                    //        }

                    //        else if (Childs.Name == "ClientTable")
                    //        {
                    //            foreach (XmlElement ChildsElement in Childs)
                    //            {
                    //                if (!(FilledAddress))   //Solo leerá los campos una vez, tomando los primeros que lea
                    //                {
                    //                    //txtInsuredAddrs1.Text = ChildsElement["Maddr1"].InnerText;
                    //                    //txtAddrs2.Text = ChildsElement["Maddr2"].InnerText;
                    //                    ////ddlCityFullInfo.Text = ChildsElement["Mcity"].InnerText; //txtInsuredCity.Text =
                    //                    ////txtInsuredState.Text = ChildsElement["Mstate"].InnerText;
                    //                    //txtZipCode.Text = ChildsElement["Mzip"].InnerText;
                    //                    //txtWorkPhone.Text = ChildsElement["Wphone"].InnerText;
                    //                    //txtCellular.Text = ChildsElement["Cphone"].InnerText;

                    //                    //InsuredAddress1 = txtInsuredAddrs1.Text;
                    //                    //InsuredAddress2 = txtAddrs2.Text;
                    //                    //InsuredZip = txtZipCode.Text;
                    //                    //InsuredWorkPhone = txtWorkPhone.Text;
                    //                    //InsuredCellular = txtCellular.Text;

                    //                    //FilledAddress = true;
                    //                }
                    //            }
                    //        }
                    //    }
                    //}
                    ///Todas las variables Insured mencionadas existen así para la ocasión en que llame el reclamante
                    ///La información del asegurado no se pierda, si no que siga hacia adelante en el proceso. 
                }

                #endregion


            }

            catch (Exception exc)
            {
                lblRecHeader.Text = exc.Message + " " + exc;
                UpdatePolicyPPSError(TaskControlID);
                Session["SupplierID"] = "999";
                LogError(exc);
                mpeSeleccion.Show();
            }

        }

        void UpdatePolicyPPSError(int TaskControlID)
        {

            DbRequestXmlCookRequestItem[] cookItems =
            new DbRequestXmlCookRequestItem[1];

            DbRequestXmlCooker.AttachCookItem("TaskControlID",
                SqlDbType.Int, 0, TaskControlID.ToString(),
                ref cookItems);

            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }

            try
            {
                exec.GetQuery("UpdatePolicyPPSError", xmlDoc);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve the liability rates.", ex);
            }

        }

        void UpdateNetTotalPremiumRenewal(int TaskControlID, float RenewalPremium)
        {

            DbRequestXmlCookRequestItem[] cookItems =
            new DbRequestXmlCookRequestItem[2];

            DbRequestXmlCooker.AttachCookItem("TaskControlID",
                SqlDbType.Int, 0, TaskControlID.ToString(),
                ref cookItems);

            DbRequestXmlCooker.AttachCookItem("RenewalPremium",
                SqlDbType.Float, 0, RenewalPremium.ToString(),
                ref cookItems);

            DBRequest exec = new DBRequest();
            XmlDocument xmlDoc;

            try
            {
                xmlDoc = DbRequestXmlCooker.Cook(cookItems);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }

            try
            {
                exec.GetQuery("UpdateNetTotalPremiumRenewal", xmlDoc);
            }
            catch (Exception ex)
            {
                throw new Exception("Could not retrieve the liability rates.", ex);
            }

        }

        private static DataTable UpdatePolicyFromPPSByTaskControlID(int TaskControl, string PolicyNo, string ClientID)
        {

            DataTable dt = new DataTable();

            DBRequest Executor = new DBRequest();

            try
            {
                DbRequestXmlCookRequestItem[] cookItems = new DbRequestXmlCookRequestItem[3];

                DbRequestXmlCooker.AttachCookItem("TaskControlID", SqlDbType.Int, 0, TaskControl.ToString(), ref cookItems);
                DbRequestXmlCooker.AttachCookItem("PolicyNo", SqlDbType.VarChar, 50, PolicyNo.ToString(), ref cookItems);
                DbRequestXmlCooker.AttachCookItem("ClientID", SqlDbType.VarChar, 50, ClientID.ToString(), ref cookItems);

                XmlDocument xmlDoc;

                try
                {
                    xmlDoc = DbRequestXmlCooker.Cook(cookItems);
                }
                catch (Exception ex)
                {
                    throw new Exception("Could not cook items.", ex);
                }

                dt = Executor.GetQuery("UpdatePolicyFromPPSByTaskControlID", xmlDoc);
                return dt;

            }
            catch (Exception ex)
            {
                throw new Exception("Could not cook items.", ex);
            }

            return dt;

        }

        public void XMLUpdate()
        {
            //// http://stackoverflow.com/questions/16514067/update-xml-stored-in-a-xml-column-in-sql-server
            //XmlDocument xmlDoc = new XmlDocument();

            //xmlDoc.Load(System.Configuration.ConfigurationManager.AppSettings["XMLPathName"] + NAMECONVENTION + ".xml");

            //XmlElement xmlPolicy = xmlDoc.CreateElement("Policies");
            //xmlDoc.AppendChild(xmlPolicy);

            //XmlElement xmlPolicy1 = xmlDoc.CreateElement("Policy");  // Creacion del elemento
            //xmlPolicy.AppendChild(xmlPolicy1);  // Abajo de donde vas a "append" el elemento

            //XmlElement xmlPolicyID = xmlDoc.CreateElement("PolicyID");
            //xmlPolicy1.AppendChild(xmlPolicyID);
            //xmlPolicyID.InnerText = PolicyNumber;

            //XmlElement xmlClient = xmlDoc.CreateElement("Client");
            //xmlPolicy1.AppendChild(xmlClient);
            //xmlClient.InnerText = ClientID;

            //xmlDoc.Save(System.Configuration.ConfigurationManager.AppSettings["XMLPathName"] + NAMECONVENTION + ".xml");
        }
        #endregion XML

        //protected void ddlPrintOption_SelectedIndexChanged(object sender, EventArgs e)
        //{
        //    ddlPrintOption2.SelectedIndex = ddlPrintOption.SelectedIndex;
        //}
        //protected void ddlPrintOption2_SelectedIndexChanged(object sender, EventArgs e)
        //{
        //    ddlPrintOption.SelectedIndex = ddlPrintOption2.SelectedIndex;
        //}

        private void CompareTotalPremiumPPS(bool lastvehicle)
        {
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            //EPolicy.TaskControl.DoubleInteresttaskControl2 = new EPolicy.TaskControl.Autos(true);

            //taskControl2 = taskControl;

            DataTable eppscollection = new DataTable();

            if (Session["EppsCollection"] != null)
                eppscollection = ((DataTable)Session["EppsCollection"]).Copy();


            DataTable renewalcollection = new DataTable();

            renewalcollection = taskControl.VehicleCollection.Copy();
            Session["RenewalCollection"] = taskControl.VehicleCollection.Copy();
            taskControl.CustomerCollection = "0";
            taskControl.VehicleCollection.Rows.Clear();
            if (eppscollection.Rows.Count > 0)
            {
                taskControl.VehicleCollection = eppscollection.Copy();
            }
            Session["TaskControl"] = taskControl;
            BtnAddVehicle_Click(String.Empty, EventArgs.Empty);
            ResetVehicleControls();
            eppscollection = taskControl.VehicleCollection.Copy();
            //CalculatePremium();

            if (!lastvehicle)
            {
                taskControl.CustomerCollection = "1";
                taskControl.VehicleCollection = renewalcollection.Copy();
                Session["TaskControl"] = taskControl;
                Session["EppsCollection"] = eppscollection.Copy();
            }
            else
            {
                if (renewalcollection.Rows.Count > 0 && eppscollection.Rows.Count > 0)
                {
                    bool Compare = false;
                    bool Liability = false;

                    for (int i = 0; i < renewalcollection.Rows.Count; i++)
                    {
                        if (0 < double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()))
                        {
                            Compare = true;
                            //break;
                        }
                        else
                        {
                            Liability = true;
                        }
                    }

                    if (Liability && (Compare && renewalcollection.Rows.Count == eppscollection.Rows.Count))
                    {

                        for (int i = 0; i < renewalcollection.Rows.Count; i++)
                        {
                            if (0 < double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()))
                            {

                            }
                            else
                            {
                                string BI = "", PD = "", MP = "", Passengers = "";
                                string UseClass = renewalcollection.Rows[i]["VehicleUse"].ToString() == "Private" ? "P" : renewalcollection.Rows[i]["VehicleUse"].ToString() == "Commercial" ? "C" : renewalcollection.Rows[i]["VehicleUse"].ToString() == "Taxi" ? "T" : "R";
                                string Island = renewalcollection.Rows[i]["Island"].ToString() == "St. Thomas" ? "1" : renewalcollection.Rows[i]["Island"].ToString() == "St. Croix" ? "2" : "3";//ChildsElement["Island"].InnerText == "1" ? "3" : ChildsElement["Island"].InnerText == "2" ? "1" : ChildsElement["Island"].InnerText == "3" ? "2" : "";
                                string Motorcycle = bool.Parse(renewalcollection.Rows[i]["IsMotorcycleScooter"].ToString()) == true ? "Y" : "N";

                                BI = renewalcollection.Rows[i]["BIPremium"].ToString();
                                PD = renewalcollection.Rows[i]["PDPremium"].ToString();
                                MP = renewalcollection.Rows[i]["MPPremium"].ToString();
                                Passengers = renewalcollection.Rows[i]["PassengersNo"].ToString();

                                String[] Rates = new String[3];
                                Rates = CompareRenewalLiabRates(BI, PD, MP, UseClass, Island, "N", Motorcycle, Passengers, "N");
                                BI = Rates[0];
                                PD = Rates[1];
                                MP = Rates[2];
                            }
                        }

                        Session["EppsCollection"] = null;
                        Session["TaskControl"] = taskControl;
                    }
                    else if (Compare && renewalcollection.Rows.Count == eppscollection.Rows.Count)
                    {
                        int PPSTotalPremium = 0;
                        int EPPSTotalPremium = 0;

                        taskControl.VehicleCollection = renewalcollection.Copy();
                        taskControl.CustomerCollection = "1";
                        Session["TaskControl"] = taskControl;
                        CalculateRenewalPremium(true);
                        PPSTotalPremium = int.TryParse(txtGrandTotal.Text.ToString(), out PPSTotalPremium) ? int.Parse(txtGrandTotal.Text.ToString()) : 0;

                        taskControl.VehicleCollection = eppscollection.Copy();
                        taskControl.CustomerCollection = "0";
                        Session["TaskControl"] = taskControl;
                        CalculateRenewalPremium(true);
                        EPPSTotalPremium = int.TryParse(txtGrandTotal.Text.ToString(), out EPPSTotalPremium) ? int.Parse(txtGrandTotal.Text.ToString()) : 0;

                         //3/18/2020 Peticion por Ramon Se elimino la comparacion de Prima con PPS

                        //if (PPSTotalPremium < EPPSTotalPremium)
                        //{
                        //    taskControl.VehicleCollection = renewalcollection.Copy();
                        //    taskControl.CustomerCollection = "1";
                        //}
                        //else
                        //{
                            taskControl.VehicleCollection = eppscollection.Copy();
                            taskControl.CustomerCollection = "0";
                        //}

                        CalculateRenewalPremium(true);
                        GetTotalPremium();
                        Session["EppsCollection"] = null;
                        Session["TaskControl"] = taskControl;
                    }
                    else if (Liability)
                    {

                        Session["EppsCollection"] = null;
                        Session["TaskControl"] = taskControl;
                    }
                    else
                    {
                        taskControl.VehicleCollection = renewalcollection.Copy();
                        taskControl.CustomerCollection = "1";
                        CalculateRenewalPremium(true);
                        GetTotalPremium();
                        Session["EppsCollection"] = null;
                        Session["TaskControl"] = taskControl;
                    }
                }
            }

        }

        private void CompareTotalPremium(bool lastvehicle, int Position, int TaskControlID)
        {
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            DataTable eppscollection = new DataTable();

            if (Session["EppsCollection"] != null)
                eppscollection = ((DataTable)Session["EppsCollection"]).Copy();

            DataTable renewalcollection = new DataTable();

            renewalcollection = taskControl.VehicleCollection.Copy();

            if (Position == 0)
            {
                Session["RenewalDiscount"] = taskControl.TotalDiscounts.ToString();
                Session["RenewalDiscountPct"] = taskControl.TotalDiscountsPct.ToString();
            }
            FillVehicleControls(taskControl, Position);
            taskControl.CustomerCollection = "0";
            taskControl.VehicleCollection.Rows.Clear();
            if (eppscollection.Rows.Count > 0)
            {
                taskControl.VehicleCollection = eppscollection.Copy();
            }
            Session["TaskControl"] = taskControl;
            BtnAddVehicle_Click(String.Empty, EventArgs.Empty);
            ResetVehicleControls();
            eppscollection = taskControl.VehicleCollection.Copy();

            if (!lastvehicle)
            {
                taskControl.CustomerCollection = "1";
                taskControl.VehicleCollection = renewalcollection.Copy();
                Session["TaskControl"] = taskControl;
                Session["EppsCollection"] = eppscollection.Copy();
            }
            else
            {
                if (renewalcollection.Rows.Count > 0 && eppscollection.Rows.Count > 0)
                {
                    bool Compare = false;
                    for (int i = 0; i < renewalcollection.Rows.Count; i++)
                    {
                        if (0 < double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()))
                        {
                            Compare = true;
                            break;
                        }
                    }

                    if (Compare && renewalcollection.Rows.Count == eppscollection.Rows.Count)
                    {
                        int PPSTotalPremium = 0;
                        int EPPSTotalPremium = 0;

                        taskControl.VehicleCollection = renewalcollection.Copy();
                        taskControl.CustomerCollection = "1";

                        Session["EPPSDiscount"] = txtTotalDiscount.Text.ToString();
                        Session["EPPSDiscountPct"] = txtDiscountPct.Text.ToString();

                        taskControl.TotalDiscounts = Session["RenewalDiscount"] != null ? double.Parse(Session["RenewalDiscount"].ToString()) : 0.0;
                        taskControl.TotalDiscountsPct = Session["RenewalDiscountPct"] != null ? double.Parse(Session["RenewalDiscountPct"].ToString()) : 0.0;
                        txtTotalDiscount.Text = Session["RenewalDiscount"] != null ? Session["RenewalDiscount"].ToString() : "0.0";
                        txtDiscountPct.Text = Session["RenewalDiscountPct"] != null ? Session["RenewalDiscountPct"].ToString() : "0.0";
                        taskControl.TaskControlID = TaskControlID;
                        Session["TaskControl"] = taskControl;
                        //CalculateRenewalPremium(false);
                        GetTotalPremium();
                        taskControl.TaskControlID = 0;
                        PPSTotalPremium = int.TryParse(txtGrandTotal.Text.ToString(), out PPSTotalPremium) ? int.Parse(txtGrandTotal.Text.ToString()) : 0;

                        if (PPSTotalPremium != (int.TryParse(txtTotalQuote.Text.ToString().Replace(".00", "").Replace(",", ""), out PPSTotalPremium) ? int.Parse(txtTotalQuote.Text.ToString().Replace(".00", "").Replace(",", "")) : 0))
                        {
                            PPSTotalPremium = int.TryParse(txtTotalQuote.Text.ToString().Replace(".00", "").Replace(",", ""), out PPSTotalPremium) ? int.Parse(txtTotalQuote.Text.ToString().Replace(".00", "").Replace(",", "")) : 0;
                        }

                        taskControl.TotalDiscounts = Session["EPPSDiscount"] != null ? double.Parse(Session["EPPSDiscount"].ToString()) : 0.0;
                        taskControl.TotalDiscountsPct = Session["EPPSDiscountPct"] != null ? double.Parse(Session["EPPSDiscountPct"].ToString()) : 0.0;
                        txtTotalDiscount.Text = Session["EPPSDiscount"] != null ? Session["EPPSDiscount"].ToString() : "0.0";
                        txtDiscountPct.Text = Session["EPPSDiscountPct"] != null ? Session["EPPSDiscountPct"].ToString() : "0.0";

                        taskControl.VehicleCollection = eppscollection.Copy();
                        taskControl.CustomerCollection = "0";
                        Session["TaskControl"] = taskControl;
                        CalculateRenewalPremium(false);
                        EPPSTotalPremium = int.TryParse(txtGrandTotal.Text.ToString(), out EPPSTotalPremium) ? int.Parse(txtGrandTotal.Text.ToString()) : 0;

                        if (PPSTotalPremium < EPPSTotalPremium)
                        {
                            taskControl.TotalDiscounts = (double.Parse(EPPSTotalPremium.ToString()) - double.Parse(PPSTotalPremium.ToString()));
                            taskControl.TotalDiscountsPct = Math.Round((Math.Round((((double.Parse(PPSTotalPremium.ToString()) / double.Parse(EPPSTotalPremium.ToString())) - 1.0) * (-1.0)), 2)) * (100), 0);
                            DataTable NetTotalPremiumdt = GetCoverageNetTotalPremiumByTaskControlID(TaskControlID);

                            if (NetTotalPremiumdt.Rows.Count > 0)
                            {
                                for (int i = 0; i < NetTotalPremiumdt.Rows.Count; i++)
                                {

                                    renewalcollection.Rows[i]["CompPremium"] = NetTotalPremiumdt.Rows[i]["NetCompPremium"];
                                    renewalcollection.Rows[i]["CollPremium"] = NetTotalPremiumdt.Rows[i]["NetCollPremium"];
                                    renewalcollection.Rows[i]["BIPremium"] = NetTotalPremiumdt.Rows[i]["NetBIPremium"];
                                    renewalcollection.Rows[i]["PDPremium"] = NetTotalPremiumdt.Rows[i]["NetPDPremium"];
                                    renewalcollection.Rows[i]["MPPremium"] = NetTotalPremiumdt.Rows[i]["NetMPPremium"];
                                    renewalcollection.Rows[i]["TotalPremium"] = NetTotalPremiumdt.Rows[i]["NetTotalPremium"];
                                }
                            }

                            Session["RenewalPremium"] = PPSTotalPremium;

                            taskControl.VehicleCollection = renewalcollection.Copy();
                            taskControl.CustomerCollection = "1";
                        }
                        else
                        {
                            taskControl.TotalDiscounts = Session["EPPSDiscount"] != null ? double.Parse(Session["EPPSDiscount"].ToString()) : 0.0;
                            taskControl.TotalDiscountsPct = Session["EPPSDiscountPct"] != null ? double.Parse(Session["EPPSDiscountPct"].ToString()) : 0.0;
                            txtTotalDiscount.Text = Session["EPPSDiscount"] != null ? Session["EPPSDiscount"].ToString() : "0.0";
                            txtDiscountPct.Text = Session["EPPSDiscountPct"] != null ? Session["EPPSDiscountPct"].ToString() : "0.0";

                            taskControl.VehicleCollection = eppscollection.Copy();
                            taskControl.CustomerCollection = "0";
                        }
                        Session["TaskControl"] = taskControl;
                        Session["EppsCollection"] = null;
                        //CalculateRenewalPremium(false);
                        //GetTotalPremium();
                        Session["TaskControl"] = taskControl;
                    }
                    else
                    {
                        taskControl.VehicleCollection = renewalcollection.Copy();
                        taskControl.CustomerCollection = "0";
                        CalculateRenewalPremium(false);
                        GetTotalPremium();
                        Session["EppsCollection"] = null;
                        Session["TaskControl"] = taskControl;
                    }

                    Session["RenewalDiscount"] = null;
                    Session["RenewalDiscountPct"] = null;
                    Session["EPPSDiscount"] = null;
                    Session["EPPSDiscountPct"] = null;
                }
            }

        }

        private void ResetVehicleControls()
        {
            ddlVehicleYear.SelectedIndex = 0;
            ddlVehicleMake.SelectedIndex = 0;
            ddlVehicleModel.SelectedIndex = 0;
            ddlBankList.SelectedIndex = 0;
            lblBankListSelected.Text = "";
            lblBankListSelected2.Text = lblBankListSelected.Text;
            TxtVINNo.Text = "";
            TxtLicensePlateNo.Text = "";

            ddlVehicleUse.SelectedIndex = 0;
            ddlIsland.SelectedIndex = 0;
            ddlCompanyDealer.SelectedIndex = 0;
            TxtVehicleValue.Text = "";


            if (TxtPassengerNo.Visible == true || LblPassengersNo.Visible == true)
            {
                TxtPassengerNo.Visible = false;
                LblPassengersNo.Visible = false;

                if (TxtPassengerNo.Text != "0")
                    TxtPassengerNo.Text = "0";

                lblTaxiDriverloss.Visible = false;
                radTaxiDriverloss.Visible = false;

            }

            if (radRentalReimCov.Visible == false)
            {
                radRentalReimCov.Visible = true;
                lblRentalReim.Visible = true;
            }

            if (radMotorcycle.Enabled)
            {
                radMotorcycle.SelectedIndex = 1;
                IsBusinessCheckedChanged();
            }


            TxtVehicleValue.Enabled = true;

            TxtVehicleID.Text = "";
        }

        private void FillVehicleControls(EPolicy.TaskControl.DoubleInterest taskControl, int i)
        {

            if (taskControl.VehicleCollection.Rows[0]["IsMotorcycleScooter"].ToString() == "True")
                radMotorcycle.SelectedIndex = 0;
            else
                radMotorcycle.SelectedIndex = 1;

            if (chkIsBusinessAutoQuote.Checked)
                radMotorcycle.Enabled = true;
            else
                radMotorcycle.Enabled = false;

            IsBusinessCheckedChanged();

            ddlVehicleYear.SelectedIndex = ddlVehicleYear.Items.IndexOf(ddlVehicleYear.Items.FindByText(taskControl.VehicleCollection.Rows[i]["VehicleYear"].ToString()));
            ddlVehicleMake.SelectedIndex = ddlVehicleMake.Items.IndexOf(ddlVehicleMake.Items.FindByText(taskControl.VehicleCollection.Rows[i]["VehicleMake"].ToString()));
            FillModelDDList();
            if (ddlVehicleModel.Items.IndexOf(ddlVehicleModel.Items.FindByText(taskControl.VehicleCollection.Rows[i]["VehicleModel"].ToString())) == -1)
            {
                ddlVehicleModel.SelectedIndex = 1;
            }
            else
                ddlVehicleModel.SelectedIndex = ddlVehicleModel.Items.IndexOf(ddlVehicleModel.Items.FindByText(taskControl.VehicleCollection.Rows[i]["VehicleModel"].ToString()));
            //ddlBankList.SelectedIndex = ddlBankList.Items.IndexOf(ddlBankList.Items.FindByText(row.Cells[40].Text.Trim()));
            TxtVINNo.Text = taskControl.VehicleCollection.Rows[i]["VIN"].ToString();
            TxtLicensePlateNo.Text = taskControl.VehicleCollection.Rows[i]["LicensePlateNo"].ToString();

            TxtVehicleID.Text = taskControl.VehicleCollection.Rows[i]["VehicleDetailID"].ToString();

            ddlIsland.SelectedIndex = ddlIsland.Items.IndexOf(ddlIsland.Items.FindByText(taskControl.VehicleCollection.Rows[i]["Island"].ToString()));

            ddlStatus.SelectedIndex = ddlStatus.Items.IndexOf(ddlStatus.Items.FindByText(taskControl.VehicleCollection.Rows[i]["Status"].ToString()));

            TxtVehicleValue.Text = taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString();
            txtOtherSurcharge.Text = taskControl.VehicleCollection.Rows[i]["OtherSurcharge"].ToString();

            ddlVehicleUse.SelectedIndex = ddlVehicleUse.Items.IndexOf(ddlVehicleUse.Items.FindByText(taskControl.VehicleCollection.Rows[i]["VehicleUse"].ToString()));

            MotorCycleScooterSelectedIndexChanged();
            ddlVehicleUse_SelectedIndexChanged("", EventArgs.Empty);

            TxtPassengerNo.Text = taskControl.VehicleCollection.Rows[i]["PassengersNo"].ToString();

            Session["VehicleRowNumber"] = taskControl.VehicleCollection.Rows[i]["VehicleRowNumber"].ToString();

            if (ddlVehicleUse.SelectedItem.Value.ToString() != "T")
            {
                LblPassengersNo.Visible = false;
                TxtPassengerNo.Text = "0";
                TxtPassengerNo.Visible = false;
            }
            else
            {
                LblPassengersNo.Visible = true;
                TxtPassengerNo.Visible = true;
                lblTaxiDriverloss.Visible = true;
                radTaxiDriverloss.Visible = true;

                if (radRentalReimCov.Visible == true)
                {
                    radRentalReimCov.Visible = false;
                    lblRentalReim.Visible = false;
                }
            }
            if (ddlVehicleUse.SelectedItem.Value.ToString() == "R" && taskControl.VehicleCollection.Rows[0]["IsMotorcycleScooter"].ToString() == "True")
            {
                TxtVehicleValue.Enabled = false;
            }

            if (taskControl.VehicleCollection.Rows[i]["Over2Tons"].ToString() == "True")
            {
                radGenTons.SelectedValue = "Y";
            }
            else
            {
                radGenTons.SelectedValue = "N";
            }

            if (taskControl.VehicleCollection.Rows[i]["MedicalPayment"].ToString() == "True")
            {
                radGenMedicalPayment.SelectedValue = "Y";
            }
            else
            {
                radGenMedicalPayment.SelectedValue = "N";
            }

            if (taskControl.VehicleCollection.Rows[i]["MotoristCoverage"].ToString() == "True")
            {
                radGenMotoristCoverage.SelectedValue = "Y";
            }
            else
            {
                radGenMotoristCoverage.SelectedValue = "N";
            }

            if (taskControl.VehicleCollection.Rows[i]["DeathDismembermentCoverage"].ToString() == "True")
            {
                radADD.SelectedValue = "Y";
            }
            else
            {
                radADD.SelectedValue = "N";
            }

            if (taskControl.VehicleCollection.Rows[i]["RentalReimCoverage"].ToString() == "True")
            {
                radRentalReimCov.SelectedValue = "Y";
            }
            else
            {
                radRentalReimCov.SelectedValue = "N";
            }

            if (taskControl.VehicleCollection.Rows[i]["IsMotorcycleScooter"].ToString() == "True")
            {
                radMotorcycle.SelectedValue = "Y";
            }
            else
            {
                radMotorcycle.SelectedValue = "N";
            }

            if (taskControl.VehicleCollection.Rows[i]["TaxiLossAmount"].ToString() == "$100.00")
            {
                radTaxiDriverloss.SelectedIndex = 0;
            }
            else
            {
                radTaxiDriverloss.SelectedIndex = 1;
            }



            ValidarCamposDisponiblesPhysDam();
            ValidarCamposDisponiblesLiab();

            TxtPDLimit.Text = taskControl.VehicleCollection.Rows[i]["PDLimit"].ToString();

            if (ddlDedComp.Items.FindByValue(taskControl.VehicleCollection.Rows[i]["ComprehensiveDedu"].ToString()) != null)
            {
                ddlDedComp.SelectedValue = taskControl.VehicleCollection.Rows[i]["ComprehensiveDedu"].ToString();
            }

            if (ddlDedColl.Items.FindByValue(taskControl.VehicleCollection.Rows[i]["CollisionDedu"].ToString()) != null)
            {
                ddlDedColl.SelectedValue = taskControl.VehicleCollection.Rows[i]["CollisionDedu"].ToString();
            }



            if (taskControl.VehicleCollection.Rows[i]["ComprehensiveDedu"].ToString() != "0")
            {
                if (taskControl.RenewalNo != "" && taskControl.CustomerCollection != "1")// CustomerCollection se utiliza para identificar si hubo un recalculo en prima despues de traerla de Renovacion
                {
                    ddlCompCollDed.Items.Add(new ListItem(taskControl.VehicleCollection.Rows[i]["ComprehensiveDedu"].ToString() + "/" + taskControl.VehicleCollection.Rows[i]["CollisionDedu"].ToString(), taskControl.VehicleCollection.Rows[i]["ComprehensiveDedu"].ToString() + "/" + taskControl.VehicleCollection.Rows[i]["CollisionDedu"].ToString()));
                    ddlCompCollDed.SelectedValue = taskControl.VehicleCollection.Rows[i]["ComprehensiveDedu"].ToString() + "/" + taskControl.VehicleCollection.Rows[i]["CollisionDedu"].ToString();
                }
                else
                {
                    ddlCompCollDed.SelectedValue = taskControl.VehicleCollection.Rows[i]["ComprehensiveDedu"].ToString() + "/" + taskControl.VehicleCollection.Rows[i]["CollisionDedu"].ToString();
                }
            }

            //txtComp.Text = taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString();
            //txtCollision.Text = taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString();

            TxtBILimitpp.Text = taskControl.VehicleCollection.Rows[i]["BIPPLimit"].ToString();
            TxtBILimitpo.Text = taskControl.VehicleCollection.Rows[i]["BIPOLimit"].ToString();
            txtMPLimit.Text = taskControl.VehicleCollection.Rows[i]["MPLimit"].ToString();

            if (taskControl.RenewalNo != "")
            {
                TxtBILimitpp.Items.Clear();
                string BILimit = "";

                BILimit = taskControl.VehicleCollection.Rows[i]["BIPPLimit"].ToString();
                //if (taskControl.VehicleCollection.Rows.Count > 0)
                //{
                //    BILimit = taskControl.VehicleCollection.Rows[0]["BIPPLimit"] != System.DBNull.Value ? taskControl.VehicleCollection.Rows[0]["BIPPLimit"].ToString() : "";
                //}
                if (BILimit != "")
                    TxtBILimitpp.Items.Add(new ListItem(BILimit, BILimit));
            }
        }

        private void CalculateRenewalCharges(bool OnTheFly, string TotPrem)
        {
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            AddPrimaryDriver();


            int CantidadSurcharges = GetCantidadSurcharges();
            double ACV = 0.0;
            int VehicleID = 0;
            double UnderAgeCharge = 1.0;
            double ViolationCharge = 1.0;
            double Factor = 1.0;
            double TotalCharges = 0.0;
            double TotalCoverage = 0;

            if (TotPrem == "")
            {
                TotPrem = "0";
            }

            //no entra
            for (int x = 0; x < CantidadSurcharges; x++)
            {
                GridDrivers.Columns[10].Visible = true;
                DataView dv = taskControl.DriversCollection.DefaultView;
                dv.Sort = "SumOfSurcharges DESC";
                taskControl.DriversCollection = dv.ToTable();

                for (int i = 0; i < taskControl.DriversCollection.Rows.Count; i++)
                {
                    if (x == i)
                    {
                        UnderAgeCharge = double.Parse(taskControl.DriversCollection.Rows[i]["UnderageSurcharge"].ToString());
                        ViolationCharge = double.Parse(taskControl.DriversCollection.Rows[i]["TrafficViolationSurcharge"].ToString());

                        ACV = GetPremiumFromVehicles(x + 1, ref VehicleID);

                        if (taskControl.VehicleCollection.Rows.Count == 0)
                        {

                            if (ViolationCharge > 1.0)
                            {
                                ViolationCharge = Math.Round((ViolationCharge - Factor) * ACV, 0);
                            }
                            else
                            {
                                ViolationCharge = 0.0;
                            }

                            if (UnderAgeCharge > 1.0)
                            {
                                UnderAgeCharge = Math.Round((UnderAgeCharge - Factor) * ACV, 0);
                            }
                            else
                            {
                                UnderAgeCharge = 0.0;
                            }

                            TotPrem = (double.Parse(TotPrem) + UnderAgeCharge + ViolationCharge).ToString();

                            TotalCharges = TotalCharges + ViolationCharge + UnderAgeCharge;

                            UnderAgeCharge = 0.0;
                            ViolationCharge = 0.0;

                        }
                        else
                        {

                            for (int y = 0; y < taskControl.VehicleCollection.Rows.Count; y++)
                            {
                                if (VehicleID == int.Parse(taskControl.VehicleCollection.Rows[y]["VehicleDetailID"].ToString()))
                                {
                                    if (ViolationCharge > 1.0)
                                    {
                                        ViolationCharge = Math.Round((ViolationCharge - Factor) * ACV, 0);
                                    }
                                    else
                                    {
                                        ViolationCharge = 0.0;
                                    }

                                    if (UnderAgeCharge > 1.0)
                                    {
                                        UnderAgeCharge = Math.Round((UnderAgeCharge - Factor) * ACV, 0);
                                    }
                                    else
                                    {
                                        UnderAgeCharge = 0.0;
                                    }

                                    // se comento para verificar el calculo del OnTheFly
                                    //taskControl.VehicleCollection.Rows[y]["TotalPremium"] = double.Parse(taskControl.VehicleCollection.Rows[y]["TotalPremium"].ToString()) + UnderAgeCharge + ViolationCharge;

                                    if (OnTheFly)
                                    {
                                        taskControl.VehicleCollection.Rows[y]["TotalPremium"] = double.Parse(TotPrem) + UnderAgeCharge + ViolationCharge;
                                    }
                                    else
                                    {
                                        taskControl.VehicleCollection.Rows[y]["TotalPremium"] = double.Parse(taskControl.VehicleCollection.Rows[y]["TotalPremium"].ToString()) + UnderAgeCharge + ViolationCharge;
                                    }

                                    taskControl.VehicleCollection.Rows[y]["ViolationSurcharge"] = double.Parse(taskControl.VehicleCollection.Rows[y]["ViolationSurcharge"].ToString()) + ViolationCharge;
                                    taskControl.VehicleCollection.Rows[y]["UnderAgeSurcharge"] = double.Parse(taskControl.VehicleCollection.Rows[y]["UnderAgeSurcharge"].ToString()) + UnderAgeCharge;

                                    TotalCharges = TotalCharges + ViolationCharge + UnderAgeCharge;

                                    UnderAgeCharge = 0.0;
                                    ViolationCharge = 0.0;
                                }

                            }
                            taskControl.VehicleCollection.AcceptChanges();
                        }
                    }
                }
            }

            for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
            {
                TotalCharges += double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurcharge"].ToString());
                TotalCoverage += double.Parse(taskControl.VehicleCollection.Rows[i]["MotoristPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["ADDPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["RentalReim"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["TaxiLossAmount"].ToString());
            }


            //if (TotalCharges != 0.0 && TotalCoverage != 0.0)
            //{
            //    txtTotalPremiumVehicle.Text = (double.Parse(txtTotalPremiumVehicle.Text.ToString()) + TotalCoverage).ToString();
            //}

            GridDrivers.Columns[11].Visible = false;

            for (int i = 0; i < GridVehicle.Columns.Count; i++)
            {
                GridVehicle.Columns[i].Visible = true;
            }
            DataTable dt = null;

            txtTotalCharges.Text = Math.Round(TotalCharges, 0).ToString();
            txtGrandTotal.Text = (double.Parse(txtTotalPremiumVehicle.Text.ToString()) + double.Parse(txtTotalCharges.Text.ToString())).ToString();

            double TPremium = 0.0;
            double OthSurcharge = 0.0;
            double OthSurchargePct = 0.0;
            bool IsMotorcycle = false;

            for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
            {
                TPremium = double.Parse(taskControl.VehicleCollection.Rows[i]["TotalPremium"].ToString());
                OthSurcharge = Math.Round(double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurcharge"].ToString()), 0);
                OthSurchargePct = double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurchargePct"].ToString());

                taskControl.VehicleCollection.Rows[i]["OtherSurcharge"] = Math.Round(TPremium * (OthSurchargePct / 100));
                taskControl.VehicleCollection.Rows[i]["TotalPremium"] = double.Parse(taskControl.VehicleCollection.Rows[i]["TotalPremium"].ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurcharge"].ToString());
                txtTotalCharges.Text = (double.Parse(txtTotalCharges.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurcharge"].ToString())).ToString();
                if (taskControl.VehicleCollection.Rows[i]["IsMotorcycleScooter"].ToString() == "True")
                {
                    IsMotorcycle = true;
                }
            }

            double GrandTotal = double.Parse(txtTotalPremiumVehicle.Text.ToString()) + double.Parse(txtTotalCharges.Text.ToString());

            string RentalVehicle = "";
            //CALCULATE DISCOUNTS
            if ((taskControl.PolicyClaim.ToString().Trim() == "No" || radGenPolicyClaimNo.Checked) && (taskControl.RenewalNo == "" && taskControl.CustomerCollection == "0"))
            {
                for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                {
                    GetSurchargeAge();

                    if (1 == 1)//(taskControl.RenewalNo == "")
                    {

                        string CurrentDiscount = "0";
                        DataTable CurrentDiscountdt =   GetDiscounts("22", true,false, taskControl.EntryDate);

                        if (CurrentDiscountdt.Rows.Count > 0)
                            CurrentDiscount = CurrentDiscountdt.Rows[0]["Discount"].ToString();

                        txtDiscountPct.Text = CurrentDiscount;
                        double TOTDISCOUNT = 0;
                        double Underagesurcharge = 0;
                        int MostMinor = 0;

                        GetMostMinor(taskControl, ref MostMinor, ref Underagesurcharge);

                        if (Underagesurcharge != 0.0)//(double.Parse(taskControl.DriversCollection.Rows[i]["Underagesurcharge"].ToString()) != 0.0)
                        {
                            TOTDISCOUNT = (
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            );
                        }
                        else
                        {
                            TOTDISCOUNT = (
Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
+
Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
);
                        }
                        if (CurrentDiscount == "100")
                            txtTotalDiscount.Text = "0";
                        else
                            txtTotalDiscount.Text = TOTDISCOUNT.ToString();

                    }
                    else if (taskControl.RenewalNo != "" && taskControl.TotalDiscountsPct.ToString() != "0.0")
                    {
                        string CurrentDiscount = taskControl.TotalDiscountsPct.ToString();
                        txtDiscountPct.Text = CurrentDiscount;
                        double TOTDISCOUNT = 0;
                        double Underagesurcharge = 0;
                        int MostMinor = 0;

                        GetMostMinor(taskControl, ref MostMinor, ref Underagesurcharge);

                        if (Underagesurcharge != 0.0)//(double.Parse(taskControl.DriversCollection.Rows[i]["Underagesurcharge"].ToString()) != 0.0)
                        {
                            TOTDISCOUNT = (
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            );
                        }
                        else
                        {
                            TOTDISCOUNT = (
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            );
                        }
                        txtTotalDiscount.Text = TOTDISCOUNT.ToString();
                    }
                    else
                    {
                        txtTotalDiscount.Text = "0";
                        txtDiscountPct.Text = "0";
                    }
                }
            }
            #region COMMENTED
            //else if (taskControl.RenewalNo != "" && taskControl.CustomerCollection != "1")
            //{
            //    for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
            //    {
            //        GetSurchargeAge();

            //        if (taskControl.TotalDiscountsPct.ToString() != "0.0")
            //        {
            //            string CurrentDiscount = taskControl.TotalDiscountsPct.ToString();
            //            txtDiscountPct.Text = CurrentDiscount;
            //            CurrentDiscount = CurrentDiscount == "0" ? "100" : CurrentDiscount;
            //            double TOTDISCOUNT = 0;
            //            double Underagesurcharge = 0;
            //            int MostMinor = 0;

            //            GetMostMinor(taskControl, ref MostMinor, ref Underagesurcharge);

            //            if (Underagesurcharge != 0.0)//(double.Parse(taskControl.DriversCollection.Rows[i]["Underagesurcharge"].ToString()) != 0.0)
            //            {
            //                TOTDISCOUNT = (
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                );
            //            }
            //            else
            //            {
            //                TOTDISCOUNT = (
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                );
            //            }
            //            txtTotalDiscount.Text = TOTDISCOUNT.ToString();
            //        }
            //        else
            //        {
            //            txtTotalDiscount.Text = "0";
            //            txtDiscountPct.Text = "0";
            //        }
            //    }
            //}
            #endregion COMMENTED
            else
            {
                if ((txtTotalDiscount.Text.ToString() == "0.00" || txtTotalDiscount.Text.ToString() == "0"))
                    txtTotalDiscount.Text = "0.00";
                else
                    txtTotalDiscount.Text = txtTotalDiscount.Text.ToString();

                if (txtDiscountPct.Text.ToString() == "0.00" || txtDiscountPct.Text.ToString() == "0")
                    txtDiscountPct.Text = "0.00";
                else
                    txtDiscountPct.Text = txtDiscountPct.Text.ToString();
            }

            if (IsMotorcycle == false)
            {
                if (radMotorcycle.SelectedItem.Value.ToString() == "Y")
                {
                    IsMotorcycle = true;
                }
            }

            for (int i = 0; taskControl.VehicleCollection.Rows.Count > i; i++)
            {
                if (taskControl.VehicleCollection.Rows.Count > 0)
                {
                    if (taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Rental")
                    {
                        RentalVehicle = "Rental";
                        break;
                    }
                    else
                    {
                        RentalVehicle = "";
                    }

                }
            }

            //==============================//
            // Rental NUNCA lleva descuento //
            //==============================//

            if (0 == 1) //if ((ddlDiscounts.SelectedItem.Text.ToString() != "N/A" && IsMotorcycle == false) && RentalVehicle != "Rental") // Temporeramente no va llevar descuento ninguna poliza
            {
                #region EL NUNCA ENTRA POR AQUI
                int HighestDiscount = 0;
                for (int i = 0; taskControl.VehicleCollection.Rows.Count > i; i++)
                {
                    DataTable Discountdt = null;

                    string VehicleValue = taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString();
                    string Island = taskControl.VehicleCollection.Rows[i]["Island"].ToString().Trim();
                    string Coverage = VehicleValue == "0" ? "Liability Only" : "Full Coverage";

                    if (Island == "St. Thomas")
                    {
                        Island = "STT";
                    }
                    else if (Island == "St. John")
                    {
                        Island = "STJ";
                    }
                    else
                    {
                        Island = "STC";
                    }

                    Discountdt = GetCoverageDiscount(taskControl.TaskControlID, Coverage, Island, rdbNewCustomerYes.Checked);

                    if (Discountdt != null)
                    {
                        if (Discountdt.Rows.Count != 0)
                        {
                            //LiabilityOnly
                            if (VehicleValue == "0")
                            {
                                if (rdbNewCustomerNo.Checked)//&& Discountdt.Rows[0]["Discount"].ToString().Trim() == "20")
                                {
                                    ddlDiscounts.SelectedItem.Text = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                    ddlDiscounts.SelectedItem.Value = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                }
                                else
                                {
                                    ddlDiscounts.SelectedItem.Text = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                    ddlDiscounts.SelectedItem.Value = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                }
                            }
                            //FullCoverage
                            else
                            {
                                if (rdbNewCustomerNo.Checked && rdbAnyAccidentsNo.Checked)
                                {
                                    if (rdb1Year.Checked)
                                    {
                                        ddlDiscounts.SelectedItem.Text = "10%";
                                        ddlDiscounts.SelectedItem.Value = "10%";
                                    }
                                    else if (rdb2Year.Checked)
                                    {
                                        ddlDiscounts.SelectedItem.Text = "20%";
                                        ddlDiscounts.SelectedItem.Value = "20%";
                                    }
                                    else
                                    {
                                        ddlDiscounts.SelectedItem.Text = "30%";
                                        ddlDiscounts.SelectedItem.Value = "30%";
                                        break;
                                    }
                                }
                                else
                                {
                                    ddlDiscounts.SelectedItem.Text = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                    ddlDiscounts.SelectedItem.Value = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                }

                            }

                            if (HighestDiscount == 0)
                            {
                                HighestDiscount = int.Parse(Discountdt.Rows[0]["Discount"].ToString().Trim());
                                ddlDiscounts.SelectedItem.Text = HighestDiscount.ToString().Trim() + "%";
                                ddlDiscounts.SelectedItem.Value = HighestDiscount.ToString().Trim() + "%";
                            }
                            else if (HighestDiscount < int.Parse(Discountdt.Rows[0]["Discount"].ToString().Trim()))
                            {
                                HighestDiscount = int.Parse(Discountdt.Rows[0]["Discount"].ToString().Trim());
                                ddlDiscounts.SelectedItem.Text = HighestDiscount.ToString().Trim() + "%";
                                ddlDiscounts.SelectedItem.Value = HighestDiscount.ToString().Trim() + "%";
                            }
                            else if (HighestDiscount == 30)
                            {
                                ddlDiscounts.SelectedItem.Text = HighestDiscount.ToString().Trim() + "%";
                                break;
                            }

                        }
                        else
                        {
                            if (rdbAnyAccidentsNo.Checked)
                            {
                                if (rdb1Year.Checked)
                                {
                                    ddlDiscounts.SelectedItem.Text = "10%";
                                    ddlDiscounts.SelectedItem.Value = "10%";
                                }
                                else if (rdb2Year.Checked)
                                {
                                    ddlDiscounts.SelectedItem.Text = "20%";
                                    ddlDiscounts.SelectedItem.Value = "20%";
                                }
                                else
                                {
                                    ddlDiscounts.SelectedItem.Text = "30%";
                                    ddlDiscounts.SelectedItem.Value = "30%";
                                    break;
                                }
                            }
                        }
                    }
                    else
                    {

                    }
                }

                //stxtTotalPremiumVehicle.Text = "0.00";

                txtTotalDiscount.Text = "0.00";
                for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                {
                    if (1 == 1)//if (taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Taxi")
                    {

                        txtTotalDiscount.Text = (double.Parse(txtTotalDiscount.Text) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString()) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString()) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString()) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString()) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString()) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString())).ToString();

                        txtTotalDiscount.Text = Math.Round((double.Parse(txtTotalDiscount.Text)), 0).ToString();// - TotalCoverage).ToString();
                    }
                    else
                    {
                        txtTotalDiscount.Text = Math.Round((GrandTotal - TotalCoverage) * (double.Parse(ddlDiscounts.SelectedItem.Text.ToString().Replace("%", "")) / 100), 0).ToString();
                    }
                }
                #endregion EL NUNCA ENTRA POR AQUI
            }
            else
            {
                //========================================//
                // APLICA LOS DESCUENTOS A LAS CUEBIERTAS //
                //========================================//

                //JOSHUA AQUI CUANDO SE RENUEVA UNA POLIZA DE EPPS A EPPS DEBE DEJAR LOS DESCUENTOS YA EXISTENTES Y APLICARSELO A TODAS LAS CUBIERTAS DE LA POLIZA JNF FML
                //if ((taskControl.RenewalNo != "" && taskControl.CustomerCollection.ToString() == "0") && (txtDiscountPct.Text.ToString() == "30" || txtDiscountPct.Text.ToString() == "20" || txtDiscountPct.Text.ToString() == "10"))
                //{
                //    txtTotalDiscount.Text = "0.00";
                //    for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                //    {
                //        if (1 == 1)//if (taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Taxi")
                //        {

                //            txtTotalDiscount.Text = (double.Parse(txtTotalDiscount.Text) +
                //            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                //            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                //            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                //            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                //            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                //            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString())).ToString();
                //            txtTotalDiscount.Text = Math.Round((double.Parse(txtTotalDiscount.Text)), 0).ToString();// - TotalCoverage).ToString();
                //        }
                //        else
                //        {
                //            txtTotalDiscount.Text = Math.Round((GrandTotal - TotalCoverage) * (double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString();
                //        }
                //    }
                //}

                if ((taskControl.PolicyClaim.ToString().Trim() == "No" || radGenPolicyClaimNo.Checked || taskControl.RenewalNo != "") && taskControl.CustomerCollection == "0")//else if
                {
                    string OldDiscount = txtTotalDiscount.Text.ToString();
                    txtTotalDiscount.Text = "0.00";
                    for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                    {
                        if (1 == 1)//if (taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Taxi")
                        {

                            txtTotalDiscount.Text = (double.Parse(txtTotalDiscount.Text) +
                            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString())).ToString();
                            txtTotalDiscount.Text = Math.Round((double.Parse(txtTotalDiscount.Text)), 0).ToString();// - TotalCoverage).ToString();
                        }
                        else
                        {
                            txtTotalDiscount.Text = Math.Round((GrandTotal - TotalCoverage) * (double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString();
                        }
                    }

                    if (txtTotalDiscount.Text.ToString() == "0.00" || txtTotalDiscount.Text.ToString() == "0")
                        txtTotalDiscount.Text = OldDiscount;
                }
                else
                {
                    if (txtTotalDiscount.Text.ToString() == "0.00" || txtTotalDiscount.Text.ToString() == "0")
                        txtTotalDiscount.Text = "0.00";
                    else
                        txtTotalDiscount.Text = txtTotalDiscount.Text.ToString();
                }
            }

            txtGrandTotal.Text = (GrandTotal - double.Parse(txtTotalDiscount.Text.ToString())).ToString();

            taskControl.VehicleCollection.AcceptChanges();
            dt = taskControl.VehicleCollection;

            this.GridVehicle.Visible = true;
            this.GridVehicle.DataSource = dt;
            this.GridVehicle.DataBind();
            this.GridVehicle.Visible = true;


            for (int i = 6; i < 40; i++)
            {
                GridVehicle.Columns[i].Visible = false;
            }
            //GridVehicle.Columns[32].Visible = false;
            GridVehicle.Columns[33].Visible = false;
            GridVehicle.Columns[38].Visible = false;
            GridVehicle.Columns[40].Visible = false;
            GridVehicle.Columns[41].Visible = false;
            GridVehicle.Columns[6].Visible = false;
            GridVehicle.Columns[42].Visible = false;
            GridVehicle.Columns[44].Visible = false;
            GridVehicle.Columns[45].Visible = false;

            GridVehicle.Columns[39].Visible = true;
            GridVehicle.Columns[26].Visible = true;
            GridVehicle.Columns[27].Visible = true;
            GridVehicle.Columns[28].Visible = true;
            GridVehicle.Columns[29].Visible = true;
            GridVehicle.Columns[30].Visible = true;
            GridVehicle.Columns[31].Visible = true;
            GridVehicle.Columns[32].Visible = true;
            GridVehicle.Columns[34].Visible = true;
        }

        private void CalculateRenewalChargesPPS(bool OnTheFly, string TotPrem)
        {
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            AddPrimaryDriver();


            int CantidadSurcharges = GetCantidadSurcharges();
            double ACV = 0.0;
            int VehicleID = 0;
            double UnderAgeCharge = 1.0;
            double ViolationCharge = 1.0;
            double Factor = 1.0;
            double TotalCharges = 0.0;
            double TotalCoverage = 0;

            if (TotPrem == "")
            {
                TotPrem = "0";
            }

            //no entra
            for (int x = 0; x < CantidadSurcharges; x++)
            {
                GridDrivers.Columns[10].Visible = true;
                DataView dv = taskControl.DriversCollection.DefaultView;
                dv.Sort = "SumOfSurcharges DESC";
                taskControl.DriversCollection = dv.ToTable();

                for (int i = 0; i < taskControl.DriversCollection.Rows.Count; i++)
                {
                    if (x == i)
                    {
                        UnderAgeCharge = double.Parse(taskControl.DriversCollection.Rows[i]["UnderageSurcharge"].ToString());
                        ViolationCharge = double.Parse(taskControl.DriversCollection.Rows[i]["TrafficViolationSurcharge"].ToString());

                        ACV = GetPremiumFromVehicles(x + 1, ref VehicleID);

                        if (taskControl.VehicleCollection.Rows.Count == 0)
                        {

                            if (ViolationCharge > 1.0)
                            {
                                ViolationCharge = Math.Round((ViolationCharge - Factor) * ACV, 0);
                            }
                            else
                            {
                                ViolationCharge = 0.0;
                            }

                            if (UnderAgeCharge > 1.0)
                            {
                                UnderAgeCharge = Math.Round((UnderAgeCharge - Factor) * ACV, 0);
                            }
                            else
                            {
                                UnderAgeCharge = 0.0;
                            }

                            TotPrem = (double.Parse(TotPrem) + UnderAgeCharge + ViolationCharge).ToString();

                            TotalCharges = TotalCharges + ViolationCharge + UnderAgeCharge;

                            UnderAgeCharge = 0.0;
                            ViolationCharge = 0.0;

                        }
                        else
                        {

                            for (int y = 0; y < taskControl.VehicleCollection.Rows.Count; y++)
                            {
                                if (VehicleID == int.Parse(taskControl.VehicleCollection.Rows[y]["VehicleDetailID"].ToString()))
                                {
                                    if (ViolationCharge > 1.0)
                                    {
                                        ViolationCharge = Math.Round((ViolationCharge - Factor) * ACV, 0);
                                    }
                                    else
                                    {
                                        ViolationCharge = 0.0;
                                    }

                                    if (UnderAgeCharge > 1.0)
                                    {
                                        UnderAgeCharge = Math.Round((UnderAgeCharge - Factor) * ACV, 0);
                                    }
                                    else
                                    {
                                        UnderAgeCharge = 0.0;
                                    }

                                    // se comento para verificar el calculo del OnTheFly
                                    //taskControl.VehicleCollection.Rows[y]["TotalPremium"] = double.Parse(taskControl.VehicleCollection.Rows[y]["TotalPremium"].ToString()) + UnderAgeCharge + ViolationCharge;

                                    if (OnTheFly)
                                    {
                                        taskControl.VehicleCollection.Rows[y]["TotalPremium"] = double.Parse(TotPrem) + UnderAgeCharge + ViolationCharge;
                                    }
                                    else
                                    {
                                        taskControl.VehicleCollection.Rows[y]["TotalPremium"] = double.Parse(taskControl.VehicleCollection.Rows[y]["TotalPremium"].ToString());// + UnderAgeCharge + ViolationCharge;
                                    }

                                    taskControl.VehicleCollection.Rows[y]["ViolationSurcharge"] = double.Parse(taskControl.VehicleCollection.Rows[y]["ViolationSurcharge"].ToString()) + ViolationCharge;
                                    taskControl.VehicleCollection.Rows[y]["UnderAgeSurcharge"] = double.Parse(taskControl.VehicleCollection.Rows[y]["UnderAgeSurcharge"].ToString()) + UnderAgeCharge;

                                    TotalCharges = TotalCharges + ViolationCharge + UnderAgeCharge;

                                    UnderAgeCharge = 0.0;
                                    ViolationCharge = 0.0;
                                }

                            }
                            taskControl.VehicleCollection.AcceptChanges();
                        }
                    }
                }
            }

            for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
            {
                TotalCharges += double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurcharge"].ToString());
                TotalCoverage += double.Parse(taskControl.VehicleCollection.Rows[i]["MotoristPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["ADDPremium"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["RentalReim"].ToString()) +
                                double.Parse(taskControl.VehicleCollection.Rows[i]["TaxiLossAmount"].ToString());
            }


            //if (TotalCharges != 0.0 && TotalCoverage != 0.0)
            //{
            //    txtTotalPremiumVehicle.Text = (double.Parse(txtTotalPremiumVehicle.Text.ToString()) + TotalCoverage).ToString();
            //}

            GridDrivers.Columns[11].Visible = false;

            for (int i = 0; i < GridVehicle.Columns.Count; i++)
            {
                GridVehicle.Columns[i].Visible = true;
            }
            DataTable dt = null;

            txtTotalCharges.Text = Math.Round(TotalCharges, 0).ToString();
            txtGrandTotal.Text = (double.Parse(txtTotalPremiumVehicle.Text.ToString()) + double.Parse(txtTotalCharges.Text.ToString())).ToString();

            double TPremium = 0.0;
            double OthSurcharge = 0.0;
            double OthSurchargePct = 0.0;
            bool IsMotorcycle = false;

            for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
            {
                TPremium = double.Parse(taskControl.VehicleCollection.Rows[i]["TotalPremium"].ToString());
                OthSurcharge = Math.Round(double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurcharge"].ToString()), 0);
                OthSurchargePct = double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurchargePct"].ToString());

                taskControl.VehicleCollection.Rows[i]["OtherSurcharge"] = Math.Round(TPremium * (OthSurchargePct / 100));
                taskControl.VehicleCollection.Rows[i]["TotalPremium"] = double.Parse(taskControl.VehicleCollection.Rows[i]["TotalPremium"].ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurcharge"].ToString());
                txtTotalCharges.Text = (double.Parse(txtTotalCharges.Text.ToString()) + double.Parse(taskControl.VehicleCollection.Rows[i]["OtherSurcharge"].ToString())).ToString();
                if (taskControl.VehicleCollection.Rows[i]["IsMotorcycleScooter"].ToString() == "True")
                {
                    IsMotorcycle = true;
                }
            }

            double GrandTotal = double.Parse(txtTotalPremiumVehicle.Text.ToString()) + double.Parse(txtTotalCharges.Text.ToString());

            string RentalVehicle = "";
            //CALCULATE DISCOUNTS
            if ((taskControl.PolicyClaim.ToString().Trim() == "No" || radGenPolicyClaimNo.Checked) || (taskControl.RenewalNo != "" && taskControl.CustomerCollection == "0"))
            {
                for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                {
                    GetSurchargeAge();

                    if (1 == 1)//(taskControl.RenewalNo == "")
                    {

                        string CurrentDiscount = "0";
                        DataTable CurrentDiscountdt =  GetDiscounts("22",true,false, taskControl.EntryDate);

                        if (CurrentDiscountdt.Rows.Count > 0)
                            CurrentDiscount = "100";//CurrentDiscountdt.Rows[0]["Discount"].ToString();

                        txtDiscountPct.Text = "0";//CurrentDiscount;
                        double TOTDISCOUNT = 0;
                        double Underagesurcharge = 0;
                        int MostMinor = 0;

                        GetMostMinor(taskControl, ref MostMinor, ref Underagesurcharge);

                        if (Underagesurcharge != 0.0)//(double.Parse(taskControl.DriversCollection.Rows[i]["Underagesurcharge"].ToString()) != 0.0)
                        {
                            TOTDISCOUNT = (
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            );
                        }
                        else
                        {
                            TOTDISCOUNT = (
Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
+
Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
);
                        }
                        if (CurrentDiscount == "100")
                            txtTotalDiscount.Text = "0";
                        else
                            txtTotalDiscount.Text = TOTDISCOUNT.ToString();

                    }
                    else if (taskControl.RenewalNo != "" && taskControl.TotalDiscountsPct.ToString() != "0.0")
                    {
                        string CurrentDiscount = taskControl.TotalDiscountsPct.ToString();
                        txtDiscountPct.Text = CurrentDiscount;
                        double TOTDISCOUNT = 0;
                        double Underagesurcharge = 0;
                        int MostMinor = 0;

                        GetMostMinor(taskControl, ref MostMinor, ref Underagesurcharge);

                        if (Underagesurcharge != 0.0)//(double.Parse(taskControl.DriversCollection.Rows[i]["Underagesurcharge"].ToString()) != 0.0)
                        {
                            TOTDISCOUNT = (
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
                            );
                        }
                        else
                        {
                            TOTDISCOUNT = (
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            +
                            Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
                            );
                        }
                        txtTotalDiscount.Text = TOTDISCOUNT.ToString();
                    }
                    else
                    {
                        txtTotalDiscount.Text = "0";
                        txtDiscountPct.Text = "0";
                    }
                }
            }
            #region COMMENTED
            //else if (taskControl.RenewalNo != "" && taskControl.CustomerCollection == "0")
            //{
            //    for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
            //    {
            //        GetSurchargeAge();

            //        if (taskControl.TotalDiscountsPct.ToString() != "0.0")
            //        {
            //            string CurrentDiscount = taskControl.TotalDiscountsPct.ToString();
            //            txtDiscountPct.Text = CurrentDiscount;
            //            double TOTDISCOUNT = 0;
            //            double Underagesurcharge = 0;
            //            int MostMinor = 0;

            //            GetMostMinor(taskControl, ref MostMinor, ref Underagesurcharge);

            //            if (Underagesurcharge != 0.0)//(double.Parse(taskControl.DriversCollection.Rows[i]["Underagesurcharge"].ToString()) != 0.0)
            //            {
            //                TOTDISCOUNT = (
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse(((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * Underagesurcharge) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                );
            //            }
            //            else
            //            {
            //                TOTDISCOUNT = (
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                +
            //                Math.Truncate(double.Parse((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * double.Parse(CurrentDiscount) / 100).ToString()))
            //                );
            //            }
            //            txtTotalDiscount.Text = TOTDISCOUNT.ToString();
            //        }
            //        else
            //        {
            //            txtTotalDiscount.Text = "0";
            //            txtDiscountPct.Text = "0";
            //        }
            //    }
            //}
            #endregion COMMENTED
            else
            {
                txtTotalDiscount.Text = "0";
                txtDiscountPct.Text = "0";
            }

            if (IsMotorcycle == false)
            {
                if (radMotorcycle.SelectedItem.Value.ToString() == "Y")
                {
                    IsMotorcycle = true;
                }
            }

            for (int i = 0; taskControl.VehicleCollection.Rows.Count > i; i++)
            {
                if (taskControl.VehicleCollection.Rows.Count > 0)
                {
                    if (taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Rental")
                    {
                        RentalVehicle = "Rental";
                        break;
                    }
                    else
                    {
                        RentalVehicle = "";
                    }

                }
            }

            //==============================//
            // Rental NUNCA lleva descuento //
            //==============================//

            if (0 == 1) //if ((ddlDiscounts.SelectedItem.Text.ToString() != "N/A" && IsMotorcycle == false) && RentalVehicle != "Rental") // Temporeramente no va llevar descuento ninguna poliza
            {
                #region EL NUNCA ENTRA POR AQUI
                int HighestDiscount = 0;
                for (int i = 0; taskControl.VehicleCollection.Rows.Count > i; i++)
                {
                    DataTable Discountdt = null;

                    string VehicleValue = taskControl.VehicleCollection.Rows[i]["VehicleValue"].ToString();
                    string Island = taskControl.VehicleCollection.Rows[i]["Island"].ToString().Trim();
                    string Coverage = VehicleValue == "0" ? "Liability Only" : "Full Coverage";

                    if (Island == "St. Thomas")
                    {
                        Island = "STT";
                    }
                    else if (Island == "St. John")
                    {
                        Island = "STJ";
                    }
                    else
                    {
                        Island = "STC";
                    }

                    Discountdt = GetCoverageDiscount(taskControl.TaskControlID, Coverage, Island, rdbNewCustomerYes.Checked);

                    if (Discountdt != null)
                    {
                        if (Discountdt.Rows.Count != 0)
                        {
                            //LiabilityOnly
                            if (VehicleValue == "0")
                            {
                                if (rdbNewCustomerNo.Checked)//&& Discountdt.Rows[0]["Discount"].ToString().Trim() == "20")
                                {
                                    ddlDiscounts.SelectedItem.Text = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                    ddlDiscounts.SelectedItem.Value = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                }
                                else
                                {
                                    ddlDiscounts.SelectedItem.Text = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                    ddlDiscounts.SelectedItem.Value = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                }
                            }
                            //FullCoverage
                            else
                            {
                                if (rdbNewCustomerNo.Checked && rdbAnyAccidentsNo.Checked)
                                {
                                    if (rdb1Year.Checked)
                                    {
                                        ddlDiscounts.SelectedItem.Text = "10%";
                                        ddlDiscounts.SelectedItem.Value = "10%";
                                    }
                                    else if (rdb2Year.Checked)
                                    {
                                        ddlDiscounts.SelectedItem.Text = "20%";
                                        ddlDiscounts.SelectedItem.Value = "20%";
                                    }
                                    else
                                    {
                                        ddlDiscounts.SelectedItem.Text = "30%";
                                        ddlDiscounts.SelectedItem.Value = "30%";
                                        break;
                                    }
                                }
                                else
                                {
                                    ddlDiscounts.SelectedItem.Text = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                    ddlDiscounts.SelectedItem.Value = Discountdt.Rows[0]["Discount"].ToString().Trim() + "%";
                                }

                            }

                            if (HighestDiscount == 0)
                            {
                                HighestDiscount = int.Parse(Discountdt.Rows[0]["Discount"].ToString().Trim());
                                ddlDiscounts.SelectedItem.Text = HighestDiscount.ToString().Trim() + "%";
                                ddlDiscounts.SelectedItem.Value = HighestDiscount.ToString().Trim() + "%";
                            }
                            else if (HighestDiscount < int.Parse(Discountdt.Rows[0]["Discount"].ToString().Trim()))
                            {
                                HighestDiscount = int.Parse(Discountdt.Rows[0]["Discount"].ToString().Trim());
                                ddlDiscounts.SelectedItem.Text = HighestDiscount.ToString().Trim() + "%";
                                ddlDiscounts.SelectedItem.Value = HighestDiscount.ToString().Trim() + "%";
                            }
                            else if (HighestDiscount == 30)
                            {
                                ddlDiscounts.SelectedItem.Text = HighestDiscount.ToString().Trim() + "%";
                                break;
                            }

                        }
                        else
                        {
                            if (rdbAnyAccidentsNo.Checked)
                            {
                                if (rdb1Year.Checked)
                                {
                                    ddlDiscounts.SelectedItem.Text = "10%";
                                    ddlDiscounts.SelectedItem.Value = "10%";
                                }
                                else if (rdb2Year.Checked)
                                {
                                    ddlDiscounts.SelectedItem.Text = "20%";
                                    ddlDiscounts.SelectedItem.Value = "20%";
                                }
                                else
                                {
                                    ddlDiscounts.SelectedItem.Text = "30%";
                                    ddlDiscounts.SelectedItem.Value = "30%";
                                    break;
                                }
                            }
                        }
                    }
                    else
                    {

                    }
                }

                //stxtTotalPremiumVehicle.Text = "0.00";

                txtTotalDiscount.Text = "0.00";
                for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                {
                    if (1 == 1)//if (taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Taxi")
                    {

                        txtTotalDiscount.Text = (double.Parse(txtTotalDiscount.Text) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString()) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString()) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString()) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString()) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString()) +
            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * double.Parse(txtDiscountPct.ToString().Replace("%", "")) / 100), 0).ToString())).ToString();

                        txtTotalDiscount.Text = Math.Round((double.Parse(txtTotalDiscount.Text)), 0).ToString();// - TotalCoverage).ToString();
                    }
                    else
                    {
                        txtTotalDiscount.Text = Math.Round((GrandTotal - TotalCoverage) * (double.Parse(ddlDiscounts.SelectedItem.Text.ToString().Replace("%", "")) / 100), 0).ToString();
                    }
                }
                #endregion EL NUNCA ENTRA POR AQUI
            }
            else
            {
                //========================================//
                // APLICA LOS DESCUENTOS A LAS CUEBIERTAS //
                //========================================//

                //JOSHUA AQUI CUANDO SE RENUEVA UNA POLIZA DE EPPS A EPPS DEBE DEJAR LOS DESCUENTOS YA EXISTENTES Y APLICARSELO A TODAS LAS CUBIERTAS DE LA POLIZA JNF FML
                //if (taskControl.RenewalNo != "" && taskControl.CustomerCollection.ToString() == "0") 
                //{
                //        txtTotalDiscount.Text = "0.00";
                //        for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                //        {
                //            if (1 == 1)//if (taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Taxi")
                //            {

                //                txtTotalDiscount.Text = (double.Parse(txtTotalDiscount.Text) +
                //                double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                //                double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                //                double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["BIPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                //                double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["PDPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                //                double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["MPPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                //                double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["UnderAgeSurcharge"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString())).ToString();
                //                txtTotalDiscount.Text = Math.Round((double.Parse(txtTotalDiscount.Text)), 0).ToString();// - TotalCoverage).ToString();
                //            }
                //            else
                //            {
                //                txtTotalDiscount.Text = Math.Round((GrandTotal - TotalCoverage) * (double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString();
                //            }
                //        }
                //}
                if ((taskControl.PolicyClaim.ToString().Trim() == "No" || radGenPolicyClaimNo.Checked || taskControl.RenewalNo != "") && taskControl.CustomerCollection == "0")//else if
                {
                    string OldDiscount = txtTotalDiscount.Text.ToString();
                    txtTotalDiscount.Text = "0.00";
                    for (int i = 0; i < taskControl.VehicleCollection.Rows.Count; i++)
                    {
                        if (1 == 1)//if (taskControl.VehicleCollection.Rows[0]["VehicleUse"].ToString() == "Taxi")
                        {

                            txtTotalDiscount.Text = (double.Parse(txtTotalDiscount.Text) +
                            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CompPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString()) +
                            double.Parse(Math.Round((double.Parse(taskControl.VehicleCollection.Rows[i]["CollPremium"].ToString()) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString())).ToString();
                            txtTotalDiscount.Text = Math.Round((double.Parse(txtTotalDiscount.Text)), 0).ToString();// - TotalCoverage).ToString();
                        }
                        else
                        {
                            txtTotalDiscount.Text = Math.Round((GrandTotal - TotalCoverage) * (double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100), 0).ToString();
                        }
                    }

                    if (txtTotalDiscount.Text.ToString() == "0.00" || txtTotalDiscount.Text.ToString() == "0")
                        txtTotalDiscount.Text = OldDiscount;
                }
                else
                {
                    txtTotalDiscount.Text = "0.00";
                }
            }

            txtGrandTotal.Text = (GrandTotal - double.Parse(txtTotalDiscount.Text.ToString())).ToString();

            taskControl.VehicleCollection.AcceptChanges();
            dt = taskControl.VehicleCollection;

            this.GridVehicle.Visible = true;
            this.GridVehicle.DataSource = dt;
            this.GridVehicle.DataBind();
            this.GridVehicle.Visible = true;


            for (int i = 6; i < 40; i++)
            {
                GridVehicle.Columns[i].Visible = false;
            }
            //GridVehicle.Columns[32].Visible = false;
            GridVehicle.Columns[33].Visible = false;
            GridVehicle.Columns[38].Visible = false;
            GridVehicle.Columns[40].Visible = false;
            GridVehicle.Columns[41].Visible = false;
            GridVehicle.Columns[6].Visible = false;
            GridVehicle.Columns[42].Visible = false;
            GridVehicle.Columns[44].Visible = false;
            GridVehicle.Columns[45].Visible = false;

            GridVehicle.Columns[39].Visible = true;
            GridVehicle.Columns[26].Visible = true;
            GridVehicle.Columns[27].Visible = true;
            GridVehicle.Columns[28].Visible = true;
            GridVehicle.Columns[29].Visible = true;
            GridVehicle.Columns[30].Visible = true;
            GridVehicle.Columns[31].Visible = true;
            GridVehicle.Columns[32].Visible = true;
            GridVehicle.Columns[34].Visible = true;
        }

        private void ValidatePhysDamageExists(ref string Comp, ref string Coll)
        {
            DataTable dtPhsDam = GetPhysicalDamageRates(ddlVehicleUse.SelectedItem.Value.ToString(), ddlIsland.SelectedItem.Value.ToString(), int.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency), "N", int.Parse(ddlVehicleYear.SelectedItem.Text), int.Parse(TxtAge.Text.ToString()), int.Parse(TxtPassengerNo.Text.ToString()));

            if (dtPhsDam.Rows.Count > 0)
            {
                bool Validated = false;
                bool First = true;
                do
                {
                    if (ReturnPhysDamValue(dtPhsDam, ref Comp, ref Coll))
                    {
                        int ddlCount = ddlCompCollDed.Items.Count;

                        if (First && (ddlCount > 0))
                        {
                            ddlCompCollDed.SelectedIndex = 0;
                            First = false;
                        }
                        else if (ddlCompCollDed.SelectedIndex == 0 && (ddlCount > 1))
                            ddlCompCollDed.SelectedIndex = 1;
                        else if (ddlCompCollDed.SelectedIndex == 1 && (ddlCount > 2))
                            ddlCompCollDed.SelectedIndex = 2;
                        else if (ddlCompCollDed.SelectedIndex == 2 && (ddlCount > 3))
                            ddlCompCollDed.SelectedIndex = 3;
                        else if (ddlCompCollDed.SelectedIndex == 3 && (ddlCount > 4))
                            ddlCompCollDed.SelectedIndex = 4;
                        else if (ddlCompCollDed.SelectedIndex == 4 && (ddlCount > 5))
                            ddlCompCollDed.SelectedIndex = 5;
                        else if (ddlCompCollDed.SelectedIndex == 5 && (ddlCount > 6))
                            ddlCompCollDed.SelectedIndex = 6;
                        else
                        {
                            Validated = true;
                        }

                        SetCompCollDeductible();
                    }
                    else
                    {
                        Validated = true;
                    }
                }
                while (Validated == false);
            }
        }

        private bool ReturnPhysDamValue(DataTable dtPhsDam, ref string Comp, ref string Coll)
        {
            if (ddlDedComp.SelectedItem.Value.ToString() == "$250" && ddlDedColl.SelectedItem.Value.ToString() == "$500")
            {
                if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                {
                    Comp = (float.Parse(dtPhsDam.Rows[0]["Comp250_500"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                    Coll = (float.Parse(dtPhsDam.Rows[0]["Coll250_500"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                }
                else
                {
                    Comp = dtPhsDam.Rows[0]["Comp250_500"].ToString();
                    Coll = dtPhsDam.Rows[0]["Coll250_500"].ToString();
                }
            }
            else if (ddlDedComp.SelectedItem.Value.ToString() == "$500" && ddlDedColl.SelectedItem.Value.ToString() == "$500")
            {
                if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                {
                    Comp = (float.Parse(dtPhsDam.Rows[0]["Comp500_500"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                    Coll = (float.Parse(dtPhsDam.Rows[0]["Coll500_500"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                }
                else
                {
                    Comp = dtPhsDam.Rows[0]["Comp500_500"].ToString();
                    Coll = dtPhsDam.Rows[0]["Coll500_500"].ToString();
                }

            }
            else if (ddlDedComp.SelectedItem.Value.ToString() == "$500" && ddlDedColl.SelectedItem.Value.ToString() == "$1,000")
            {
                if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                {
                    Comp = (float.Parse(dtPhsDam.Rows[0]["Comp500_1000"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                    Coll = (float.Parse(dtPhsDam.Rows[0]["Coll500_1000"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                }
                else
                {
                    Comp = dtPhsDam.Rows[0]["Comp500_1000"].ToString();
                    Coll = dtPhsDam.Rows[0]["Coll500_1000"].ToString();
                }

            }
            else if (ddlDedComp.SelectedItem.Value.ToString() == "$1,000" && ddlDedColl.SelectedItem.Value.ToString() == "$1,000")
            {
                if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                {
                    Comp = (float.Parse(dtPhsDam.Rows[0]["Comp1000_1000"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                    Coll = (float.Parse(dtPhsDam.Rows[0]["Coll1000_1000"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                }
                else
                {
                    Comp = dtPhsDam.Rows[0]["Comp1000_1000"].ToString();
                    Coll = dtPhsDam.Rows[0]["Coll1000_1000"].ToString();
                }
            }
            else if (ddlDedComp.SelectedItem.Value.ToString() == "$1,000" && ddlDedColl.SelectedItem.Value.ToString() == "$1,500")
            {
                if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                {
                    Comp = (float.Parse(dtPhsDam.Rows[0]["Comp1000_1500"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                    Coll = (float.Parse(dtPhsDam.Rows[0]["Coll1000_1500"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                }
                else
                {
                    Comp = dtPhsDam.Rows[0]["Comp1000_1500"].ToString();
                    Coll = dtPhsDam.Rows[0]["Coll1000_1500"].ToString();
                }
            }
            else if (ddlDedComp.SelectedItem.Value.ToString() == "$1,000" && ddlDedColl.SelectedItem.Value.ToString() == "$2,500")
            {
                if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                {
                    Comp = (float.Parse(dtPhsDam.Rows[0]["Comp1000_2500"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                    Coll = (float.Parse(dtPhsDam.Rows[0]["Coll1000_2500"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                }
                else
                {
                    Comp = dtPhsDam.Rows[0]["Comp1000_2500"].ToString();
                    Coll = dtPhsDam.Rows[0]["Coll1000_2500"].ToString();
                }
            }
            else if (ddlDedComp.SelectedItem.Value.ToString() == "$1,500" && ddlDedColl.SelectedItem.Value.ToString() == "$2,500")
            {
                if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                {
                    Comp = (float.Parse(dtPhsDam.Rows[0]["Comp1500_2500"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                    Coll = (float.Parse(dtPhsDam.Rows[0]["Coll1500_2500"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                }
                else
                {
                    Comp = dtPhsDam.Rows[0]["Comp1500_2500"].ToString();
                    Coll = dtPhsDam.Rows[0]["Coll1500_2500"].ToString();
                }
            }
            else if (ddlDedComp.SelectedItem.Value.ToString() == "$2,500" && ddlDedColl.SelectedItem.Value.ToString() == "$5,000")
            {
                if (dtPhsDam.Rows[0]["isPercentValue"].ToString() == "True")
                {
                    Comp = (float.Parse(dtPhsDam.Rows[0]["Comp2500_5000"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                    Coll = (float.Parse(dtPhsDam.Rows[0]["Coll2500_5000"].ToString()) * float.Parse(TxtVehicleValue.Text.ToString(), System.Globalization.NumberStyles.Currency)).ToString();
                }
                else
                {
                    Comp = dtPhsDam.Rows[0]["Comp2500_5000"].ToString();
                    Coll = dtPhsDam.Rows[0]["Coll2500_5000"].ToString();
                }
            }

            if ((Comp != "0" && Coll != "0") && (Comp != "$0" && Coll != "$0"))
            {
                return false;
            }
            else
            {
                return true;
            }

        }
        protected void btnSendPolicy_Click(object sender, EventArgs e)
        {
            mpeAdjunto.Show();
        }

        private void GetFlagFromClaimNext(string PolicyNo)
        {
            try
            {
                EPolicy.TaskControl.TaskControl taskControl = (EPolicy.TaskControl.TaskControl)Session["TaskControl"];

                string connection = @"Data Source=GICPR-SERVER2\GuardianDB;Initial Catalog=GuardianEpmsProd;User ID=sa;password=SQL2008123$;";
                DataTable dt;
                SqlConnection con = new SqlConnection(connection);
                con.Open();
                using (SqlCommand cmd = new SqlCommand("GetFlagFromClaimNext", con))
                {
                    cmd.CommandType = CommandType.StoredProcedure;
                    cmd.CommandTimeout = 0;
                    cmd.Parameters.Add("@PolicyNumber_Plate", SqlDbType.VarChar).Value =
                    PolicyNo.ToString().Trim() == "" ? PolicyNo.ToString().Trim() : PolicyNo.ToString().Trim();

                    SqlDataAdapter da = new SqlDataAdapter(cmd);
                    dt = new DataTable();
                    da.Fill(dt);

                    if (dt.Rows.Count > 0)
                    {
                        dt.Rows[0]["Flag"].ToString();
                    }

                    con.Close();
                }
            }
            catch (Exception exp)
            {

            }
        }

        private void QuickQuoteControls()
        {
            EPolicy.Login.Login cp = HttpContext.Current.User as EPolicy.Login.Login;

            if (cp == null)
            {
                Response.Redirect("Default.aspx?001");
            }
            else
            {
                if (cp.IsInRole("DEALERS"))
                {
                    lblQuoteType.Text = "QUICK QUOTE";
                    btnQuote.Visible = false;
                    btnQuote2.Visible = false;
                    LblFirstName.Visible = false;
                    TxtFirstName.Visible = false;
                    LblInitial.Visible = false;
                    TxtInitial.Visible = false;
                    LblLastName.Visible = false;
                    TxtLastName.Visible = false;
                    lblMarital.Visible = false;
                    ddlMaritalStatus.Visible = false;
                    lblMarital2.Visible = true;
                    ddlMaritalStatus2.Visible = true;
                    lblLicense.Visible = false;
                    TxtLicenseNumber.Visible = false;
                    Label81.Visible = false;
                    txtEmailAddress.Visible = false;
                    Label12.Visible = false;
                    TxtCellPhone.Visible = false;
                    Label111.Visible = false;
                    TxtWorkPhone.Visible = false;
                    Label105.Visible = false;
                    lblStatus.Visible = false;
                    chkNamedInsured.Visible = false;
                    LblLastName2.Visible = false;
                    TxtLastName2.Visible = false;
                    lblAnyDriverUnder26.Visible = false;
                    rdbAnyDriverYes.Visible = false;
                    rdbAnyDriverNo.Visible = false;
                    Label108.Visible = false;
                    rdbQ3Yes.Visible = false;
                    rdbQ3No.Visible = false;
                    Label109.Visible = false;
                    rdbQ1Yes.Visible = false;
                    rdbQ1No.Visible = false;
                    Label33.Visible = false;
                    radGenPolicyClaimYes.Visible = false;
                    radGenPolicyClaimNo.Visible = false;
                }
            }
        }

        private void UnderAgeCalculate()
        {
            EPolicy.TaskControl.DoubleInterest taskControl = (EPolicy.TaskControl.DoubleInterest)Session["TaskControl"];

            double UnderageTotal = 0, TotalDiscount = 0;
            double Underagesurcharge = 0;
            int MostMinor = 0;
            txtTotalDiscount.Text = "0.00";

            for (int josh = 0; taskControl.VehicleBreakDownCollection.Rows.Count > josh; josh++)
            {
                if (josh == 0)
                    GetMostMinor(taskControl, ref MostMinor, ref Underagesurcharge);
                else
                    GetMostMinorSurcharge(taskControl, MostMinor, ref Underagesurcharge, josh);

                if (Underagesurcharge != 0.0)
                {
                    UnderageTotal += (Math.Round((double.Parse(taskControl.VehicleBreakDownCollection.Rows[josh]["CompPremium"].ToString()) * Underagesurcharge) - double.Parse(taskControl.VehicleBreakDownCollection.Rows[josh]["CompPremium"].ToString()), 0) +
                                    Math.Round((double.Parse(taskControl.VehicleBreakDownCollection.Rows[josh]["CollPremium"].ToString()) * Underagesurcharge) - double.Parse(taskControl.VehicleBreakDownCollection.Rows[josh]["CollPremium"].ToString()), 0) +
                                    Math.Round((double.Parse(taskControl.VehicleBreakDownCollection.Rows[josh]["BIPremium"].ToString()) * Underagesurcharge) - double.Parse(taskControl.VehicleBreakDownCollection.Rows[josh]["BIPremium"].ToString()), 0) +
                                    Math.Round((double.Parse(taskControl.VehicleBreakDownCollection.Rows[josh]["PDPremium"].ToString()) * Underagesurcharge) - double.Parse(taskControl.VehicleBreakDownCollection.Rows[josh]["PDPremium"].ToString()), 0) +
                                    Math.Round((double.Parse(taskControl.VehicleBreakDownCollection.Rows[josh]["MPPremium"].ToString()) * Underagesurcharge) - double.Parse(taskControl.VehicleBreakDownCollection.Rows[josh]["MPPremium"].ToString()), 0));

                    TotalDiscount += ((double.Parse(Math.Round(double.Parse(((double.Parse(taskControl.VehicleBreakDownCollection.Rows[josh]["CompPremium"].ToString()) * Underagesurcharge) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100).ToString()), 0).ToString())
                    +
                    double.Parse(Math.Round(double.Parse(((double.Parse(taskControl.VehicleBreakDownCollection.Rows[josh]["CollPremium"].ToString()) * Underagesurcharge) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100).ToString()), 0).ToString())));
                }
                else
                {
                    TotalDiscount += ((double.Parse(Math.Round(double.Parse(((double.Parse(taskControl.VehicleBreakDownCollection.Rows[josh]["CompPremium"].ToString())) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100).ToString()), 0).ToString())
                    +
                    double.Parse(Math.Round(double.Parse(((double.Parse(taskControl.VehicleBreakDownCollection.Rows[josh]["CollPremium"].ToString())) * double.Parse(txtDiscountPct.Text.ToString().Replace("%", "")) / 100).ToString()), 0).ToString())));
                }

                MostMinor++;
            }

            taskControl.VehicleCollection.Rows[0]["UnderAgeSurcharge"] = UnderageTotal.ToString();
            taskControl.VehicleCollection.AcceptChanges();
            txtTotalCharges.Text = UnderageTotal.ToString();
            txtTotalDiscount.Text = TotalDiscount.ToString();
        }

        protected void RADAFFINITYDICOUNT_CheckedChanged(Object sender, EventArgs e)
        {
            CalculatePremium();
            FillGridBreakDown();
        }

        protected void btnBankList_Click(object sender, EventArgs e)
        {
            mpeBankList.Show();
        }

        private string GetBankListInfo(string bankid)
        {
            if (bankid == String.Empty)
                return "";
            string Info = "";
            string conString = System.Configuration.ConfigurationManager.AppSettings["ConnectionString"].ToString();
            using (SqlConnection connection = new SqlConnection(conString))
            {
                connection.Open();
                //
                // SqlCommand should be created inside using.
                // ... It receives the SQL statement.
                // ... It receives the connection object.
                // ... The SQL text works with a specific database.
                //
                using (SqlCommand command = new SqlCommand(
                    String.Format("SELECT * FROM BANK_VI WHERE PPSID = {0}", bankid),
                    connection))
                {
                    //
                    // Instance methods can be used on the SqlCommand.
                    // ... These read data.
                    //
                    using (SqlDataReader reader = command.ExecuteReader())
                    {

                        var tb = new DataTable();
                        tb.Load(reader);
                        if (tb != null)
                        {
                            if (tb.Rows.Count > 0)
                            {
                                var sb = new StringBuilder();
                                sb.AppendLine(String.Format("<b>{0}</b>", "ADDRESS:"));
                                if (tb.Rows[0]["BankDesc"].ToString().Trim() != "")
                                    sb.AppendLine(String.Format("{0}", tb.Rows[0]["BankDesc"].ToString().Trim()));
                                if (tb.Rows[0]["Address1"].ToString().Trim() != "")
                                    sb.AppendLine(String.Format("{0}", tb.Rows[0]["Address1"].ToString().Trim()));
                                if (tb.Rows[0]["Address2"].ToString().Trim() != "")
                                    sb.AppendLine(String.Format("{0}", tb.Rows[0]["Address2"].ToString().Trim()));
                                if ((tb.Rows[0]["City"].ToString().Trim() + tb.Rows[0]["State"].ToString().Trim() + tb.Rows[0]["ZipCode"].ToString().Trim()) != String.Empty)
                                    sb.AppendLine(String.Format("{0} {1}, {2}", tb.Rows[0]["City"].ToString().Trim(), tb.Rows[0]["State"].ToString().Trim(), tb.Rows[0]["ZipCode"].ToString().Trim()));
                                Info = sb.ToString().Replace(Environment.NewLine, "<br />");
                            }
                        }

                        //while (reader.Read())
                        //{
                        //    for (int i = 0; i < reader.FieldCount; i++)
                        //    {
                        //        Console.WriteLine(reader.GetValue(i));
                        //    }
                        //    Console.WriteLine();
                        //}
                    }
                }
            }

            return Info;
        }

        private double CalculateAgentCommision(string AgentID, double TotalPremium)
        {
            try
            {
                double Result = TotalPremium;
                string conString = System.Configuration.ConfigurationManager.AppSettings["ConnectionString"].ToString();
                using (SqlConnection connection = new SqlConnection(conString))
                {
                    connection.Open();
                    //
                    // SqlCommand should be created inside using.
                    // ... It receives the SQL statement.
                    // ... It receives the connection object.
                    // ... The SQL text works with a specific database.
                    //
                    using (SqlCommand command = new SqlCommand(
                        String.Format(@"SELECT top 1 * FROM CommissionAgent 
                                        WHERE RTRIM(LTRIM(AgentID)) = RTRIM(LTRIM({0})) 
                                        and RTRIM(LTRIM(PolicyClassID)) = RTRIM(LTRIM({1})) 
                                        AND PolicyType = {2}
                                        order by EffectiveDate desc", "'" + AgentID + "'", "'24'", "'PAP'"), connection))
                    {
                        //
                        // Instance methods can be used on the SqlCommand.
                        // ... These read data.
                        //
                        using (SqlDataReader reader = command.ExecuteReader())
                        {

                            var tb = new DataTable();
                            tb.Load(reader);
                            if (tb != null)
                            {
                                if (tb.Rows.Count > 0)
                                {
                                    var ComRate = (double.Parse(tb.Rows[0]["CommissionRate"].ToString()) / 100.0);

                                    Result = ((TotalPremium * ComRate) * 0.05);
                                }
                                else
                                {
                                    Result = 0;
                                }
                            }
                        }
                    }
                }

                return Result;
            }
            catch (Exception)
            {
                return TotalPremium;
            }
        }
    }
}
